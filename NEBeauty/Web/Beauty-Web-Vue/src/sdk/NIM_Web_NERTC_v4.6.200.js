/*! NeRTC 4.6.200|BUILD stab/v4.6.0-6-gaa8de5c production */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.NERTC=t():e.NERTC=t()}(window,(function(){return function(e){var t={};function i(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(r,s,function(t){return e[t]}.bind(null,s));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=135)}([function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default={INVALID_PARAMETER:41e3,NOT_SUPPORT:41001,NO_SERVER_ADDRESS:41002,SOCKET_ERROR:41003,NO_SIGNALLING:41004,NO_STATS:41005,NO_MEDIASERVER:41006,NO_MEETINGS:41007,NO_LOCALSTREAM:41008,INVALID_OPERATION:41009,REPEAT_JOIN:41010,USER_NOT_IN_CHANNEL:41011,NOT_SUPPORTED_YET:41012,UNKNOWN_TYPE:41013,NOT_ALLOWED:41014,STATE_ERROR:41015,NO_FILE:41016,DECODE_FAILED:41017,ADD_TASK_FAILED:41018,DELETE_TASK_FAILED:41019,UPDATE_TASKS_FAILED:41020,RECORD_API_ERROR:41021,NO_RECORDER_FOUND:41022,NOT_DEFINED:41023,NOT_AVALIABLE:41024,NO_MEDIAHELPER:41025,NO_PLAY:41026,NO_RECORD:41027,NOT_FOUND:41028,APPDATA_ERROR:41029,AUTO_PLAY_NOT_ALLOWED:41030,NO_MEDIA:41031,MEDIA_OPEN_BANNED_BY_SERVER:41032,UNKNOWN:99999}},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=r(i(0));class o extends Error{constructor(e){let t=e.url?e.url:"https://dev.yunxin.163.com/docs/interface/NERTC_SDK/Latest/Web/api/index.html#errorCode";super(e.message+` <${function(e){for(let t in s.default)if(s.default[t]===e)return t;return"UNKNOWN"}(e.code)} ${e.code.toString()}> `+t),this.code_=e.code,this.message_=e.message,this.extraCode_=e.extraCode}getCode(){return this.code_}getExtraCode(){return this.extraCode_}}t.default=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getParameters=void 0;let r={tracks:{audio:[],video:[]},shimVideoOrientation:"never",shimCanvas:"ios151",clients:[],localStreams:[],videoLowDefaultConstraints:{width:{max:320},height:{max:180}},screenLowDefaultConstraints:{width:{max:320},height:{max:180}},contentHint:{video:"motion",screen:"detail"},controlOnPaused:!0,hideControlOnResume:!0,maxTransportRebuildCnt:50,logLevel:i(24).loglevels.INFO,forceListenDeviceChange:!0,codecOptions:{audio:{opusStereo:!0,opusDtx:!0},video:{high:{videoGoogleStartBitrate:1e3},low:{videoGoogleStartBitrate:500}},screen:{high:{videoGoogleStartBitrate:2e3},low:{videoGoogleStartBitrate:500}}},screenFocus:!1,allowEmptyMedia:!1,keepLocalstreamOnLeave:!1,joinFirstTimeout:2e3,joinMaxRetry:3,reconnectionFirstTimeout:2e3,reconnectionMaxRetry:3,leaveOnUnload:!0,trustOnOnline:!1,h264Wait:1e3};t.getParameters=()=>r},function(e,t,i){"use strict";var r=Object.prototype.hasOwnProperty,s="~";function o(){}function n(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function a(){this._events=new o,this._eventsCount=0}Object.create&&(o.prototype=Object.create(null),(new o).__proto__||(s=!1)),a.prototype.eventNames=function(){var e,t,i=[];if(0===this._eventsCount)return i;for(t in e=this._events)r.call(e,t)&&i.push(s?t.slice(1):t);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},a.prototype.listeners=function(e,t){var i=s?s+e:e,r=this._events[i];if(t)return!!r;if(!r)return[];if(r.fn)return[r.fn];for(var o=0,n=r.length,a=new Array(n);o<n;o++)a[o]=r[o].fn;return a},a.prototype.emit=function(e,t,i,r,o,n){var a=s?s+e:e;if(!this._events[a])return!1;var d,c,l=this._events[a],u=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),u){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,i),!0;case 4:return l.fn.call(l.context,t,i,r),!0;case 5:return l.fn.call(l.context,t,i,r,o),!0;case 6:return l.fn.call(l.context,t,i,r,o,n),!0}for(c=1,d=new Array(u-1);c<u;c++)d[c-1]=arguments[c];l.fn.apply(l.context,d)}else{var p,h=l.length;for(c=0;c<h;c++)switch(l[c].once&&this.removeListener(e,l[c].fn,void 0,!0),u){case 1:l[c].fn.call(l[c].context);break;case 2:l[c].fn.call(l[c].context,t);break;case 3:l[c].fn.call(l[c].context,t,i);break;case 4:l[c].fn.call(l[c].context,t,i,r);break;default:if(!d)for(p=1,d=new Array(u-1);p<u;p++)d[p-1]=arguments[p];l[c].fn.apply(l[c].context,d)}}return!0},a.prototype.on=function(e,t,i){var r=new n(t,i||this),o=s?s+e:e;return this._events[o]?this._events[o].fn?this._events[o]=[this._events[o],r]:this._events[o].push(r):(this._events[o]=r,this._eventsCount++),this},a.prototype.once=function(e,t,i){var r=new n(t,i||this,!0),o=s?s+e:e;return this._events[o]?this._events[o].fn?this._events[o]=[this._events[o],r]:this._events[o].push(r):(this._events[o]=r,this._eventsCount++),this},a.prototype.removeListener=function(e,t,i,r){var n=s?s+e:e;if(!this._events[n])return this;if(!t)return 0==--this._eventsCount?this._events=new o:delete this._events[n],this;var a=this._events[n];if(a.fn)a.fn!==t||r&&!a.once||i&&a.context!==i||(0==--this._eventsCount?this._events=new o:delete this._events[n]);else{for(var d=0,c=[],l=a.length;d<l;d++)(a[d].fn!==t||r&&!a[d].once||i&&a[d].context!==i)&&c.push(a[d]);c.length?this._events[n]=1===c.length?c[0]:c:0==--this._eventsCount?this._events=new o:delete this._events[n]}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=s?s+e:e,this._events[t]&&(0==--this._eventsCount?this._events=new o:delete this._events[t])):(this._events=new o,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prototype.setMaxListeners=function(){return this},a.prefixed=s,a.EventEmitter=a,e.exports=a},function(e,t,i){"use strict";var r,s,o=e.exports=i(10),n=i(128);o.codegen=i(238),o.fetch=i(239),o.path=i(240),o.fs=o.inquire("fs"),o.toArray=function(e){if(e){for(var t=Object.keys(e),i=new Array(t.length),r=0;r<t.length;)i[r]=e[t[r++]];return i}return[]},o.toObject=function(e){for(var t={},i=0;i<e.length;){var r=e[i++],s=e[i++];void 0!==s&&(t[r]=s)}return t};var a=/\\/g,d=/"/g;o.isReserved=function(e){return/^(?:do|if|in|for|let|new|try|var|case|else|enum|eval|false|null|this|true|void|with|break|catch|class|const|super|throw|while|yield|delete|export|import|public|return|static|switch|typeof|default|extends|finally|package|private|continue|debugger|function|arguments|interface|protected|implements|instanceof)$/.test(e)},o.safeProp=function(e){return!/^[$\w_]+$/.test(e)||o.isReserved(e)?'["'+e.replace(a,"\\\\").replace(d,'\\"')+'"]':"."+e},o.ucFirst=function(e){return e.charAt(0).toUpperCase()+e.substring(1)};var c=/_([a-z])/g;o.camelCase=function(e){return e.substring(0,1)+e.substring(1).replace(c,(function(e,t){return t.toUpperCase()}))},o.compareFieldsById=function(e,t){return e.id-t.id},o.decorateType=function(e,t){if(e.$type)return t&&e.$type.name!==t&&(o.decorateRoot.remove(e.$type),e.$type.name=t,o.decorateRoot.add(e.$type)),e.$type;r||(r=i(79));var s=new r(t||e.name);return o.decorateRoot.add(s),s.ctor=e,Object.defineProperty(e,"$type",{value:s,enumerable:!1}),Object.defineProperty(e.prototype,"$type",{value:s,enumerable:!1}),s};var l=0;o.decorateEnum=function(e){if(e.$type)return e.$type;s||(s=i(8));var t=new s("Enum"+l++,e);return o.decorateRoot.add(t),Object.defineProperty(e,"$type",{value:t,enumerable:!1}),t},o.setProperty=function(e,t,i){if("object"!=typeof e)throw TypeError("dst must be an object");if(!t)throw TypeError("path must be specified");return function e(t,i,r){var s=i.shift();if(i.length>0)t[s]=e(t[s]||{},i,r);else{var o=t[s];o&&(r=[].concat(o).concat(r)),t[s]=r}return t}(e,t=t.split("."),i)},Object.defineProperty(o,"decorateRoot",{get:function(){return n.decorated||(n.decorated=new(i(84)))}})},function(e,t){var i=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=i)},function(e,t,i){var r=i(68)("wks"),s=i(49),o=i(5).Symbol,n="function"==typeof o;(e.exports=function(e){return r[e]||(r[e]=n&&o[e]||(n?o:s)("Symbol."+e))}).store=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Logger=void 0;const r=i(2),s=i(24),o=i(31),n=i(43),a="mediasoup-client";t.Logger={debug(e,...t){const i=e?`${a}:${e}`:""+a;t=Array.prototype.slice.call(arguments);this.formatArgs("DEBUG",t,i),r.getParameters().logLevel<=s.loglevels.DEBUG&&console.debug.apply(console,t),window.logUpload&&window.wsTransport.sendLog(t)},warn(e,...t){const i=e?`${a}:${e}`:""+a;t=Array.prototype.slice.call(arguments);this.formatArgs("WARN",t,i),r.getParameters().logLevel<=s.loglevels.WARNING&&console.warn.apply(console,t),window.logUpload&&window.wsTransport.sendLog(t)},error(e,...t){const i=e?`${a}:${e}`:""+a;t=Array.prototype.slice.call(arguments);this.formatArgs("ERROR",t,i),r.getParameters().logLevel<=s.loglevels.ERROR&&console.error.apply(console,t),window.logUpload&&window.wsTransport.sendLog(t)},formatArgs(e,t,i){let r=new Date,s=this.formatTimeUnit(""+(r.getMonth()+1))+"-"+this.formatTimeUnit(""+r.getDate())+" "+this.formatTimeUnit(""+r.getHours())+":"+this.formatTimeUnit(""+r.getMinutes())+":"+this.formatTimeUnit(""+r.getSeconds())+":"+this.formatTimeUnit(""+r.getMilliseconds(),3),a=`[NERTC:${e}:${o.updateLogIndex()} ${s} ${i.toUpperCase()}]  `;for(let e=t.length-1;e>=0;e--)t[e]=n.formatSingleArg(t[e]);return t.unshift(a),t},formatTimeUnit(e,t){t=t||2;for(var i=""+e;i.length<t;)i="0"+i;return i}}},function(e,t,i){"use strict";e.exports=n;var r=i(29);((n.prototype=Object.create(r.prototype)).constructor=n).className="Enum";var s=i(40),o=i(4);function n(e,t,i,s,o){if(r.call(this,e,i),t&&"object"!=typeof t)throw TypeError("values must be an object");if(this.valuesById={},this.values=Object.create(this.valuesById),this.comment=s,this.comments=o||{},this.reserved=void 0,t)for(var n=Object.keys(t),a=0;a<n.length;++a)"number"==typeof t[n[a]]&&(this.valuesById[this.values[n[a]]=t[n[a]]]=n[a])}n.fromJSON=function(e,t){var i=new n(e,t.values,t.options,t.comment,t.comments);return i.reserved=t.reserved,i},n.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return o.toObject(["options",this.options,"values",this.values,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"comment",t?this.comment:void 0,"comments",t?this.comments:void 0])},n.prototype.add=function(e,t,i){if(!o.isString(e))throw TypeError("name must be a string");if(!o.isInteger(t))throw TypeError("id must be an integer");if(void 0!==this.values[e])throw Error("duplicate name '"+e+"' in "+this);if(this.isReservedId(t))throw Error("id "+t+" is reserved in "+this);if(this.isReservedName(e))throw Error("name '"+e+"' is reserved in "+this);if(void 0!==this.valuesById[t]){if(!this.options||!this.options.allow_alias)throw Error("duplicate id "+t+" in "+this);this.values[e]=t}else this.valuesById[this.values[e]=t]=e;return this.comments[e]=i||null,this},n.prototype.remove=function(e){if(!o.isString(e))throw TypeError("name must be a string");var t=this.values[e];if(null==t)throw Error("name '"+e+"' does not exist in "+this);return delete this.valuesById[t],delete this.values[e],delete this.comments[e],this},n.prototype.isReservedId=function(e){return s.isReservedId(this.reserved,e)},n.prototype.isReservedName=function(e){return s.isReservedName(this.reserved,e)}},function(e,t){var i=e.exports={version:"2.6.12"};"number"==typeof __e&&(__e=i)},function(e,t,i){"use strict";(function(e){var r=t;function s(e,t,i){for(var r=Object.keys(t),s=0;s<r.length;++s)void 0!==e[r[s]]&&i||(e[r[s]]=t[r[s]]);return e}function o(e){function t(e,i){if(!(this instanceof t))return new t(e,i);Object.defineProperty(this,"message",{get:function(){return e}}),Error.captureStackTrace?Error.captureStackTrace(this,t):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),i&&s(this,i)}return(t.prototype=Object.create(Error.prototype)).constructor=t,Object.defineProperty(t.prototype,"name",{get:function(){return e}}),t.prototype.toString=function(){return this.name+": "+this.message},t}r.asPromise=i(125),r.base64=i(229),r.EventEmitter=i(230),r.float=i(231),r.inquire=i(126),r.utf8=i(232),r.pool=i(233),r.LongBits=i(234),r.isNode=Boolean(void 0!==e&&e&&e.process&&e.process.versions&&e.process.versions.node),r.global=r.isNode&&e||"undefined"!=typeof window&&window||"undefined"!=typeof self&&self||this,r.emptyArray=Object.freeze?Object.freeze([]):[],r.emptyObject=Object.freeze?Object.freeze({}):{},r.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},r.isString=function(e){return"string"==typeof e||e instanceof String},r.isObject=function(e){return e&&"object"==typeof e},r.isset=r.isSet=function(e,t){var i=e[t];return!(null==i||!e.hasOwnProperty(t))&&("object"!=typeof i||(Array.isArray(i)?i.length:Object.keys(i).length)>0)},r.Buffer=function(){try{var e=r.inquire("buffer").Buffer;return e.prototype.utf8Write?e:null}catch(e){return null}}(),r._Buffer_from=null,r._Buffer_allocUnsafe=null,r.newBuffer=function(e){return"number"==typeof e?r.Buffer?r._Buffer_allocUnsafe(e):new r.Array(e):r.Buffer?r._Buffer_from(e):"undefined"==typeof Uint8Array?e:new Uint8Array(e)},r.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,r.Long=r.global.dcodeIO&&r.global.dcodeIO.Long||r.global.Long||r.inquire("long"),r.key2Re=/^true|false|0|1$/,r.key32Re=/^-?(?:0|[1-9][0-9]*)$/,r.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,r.longToHash=function(e){return e?r.LongBits.from(e).toHash():r.LongBits.zeroHash},r.longFromHash=function(e,t){var i=r.LongBits.fromHash(e);return r.Long?r.Long.fromBits(i.lo,i.hi,t):i.toNumber(Boolean(t))},r.merge=s,r.lcFirst=function(e){return e.charAt(0).toLowerCase()+e.substring(1)},r.newError=o,r.ProtocolError=o("ProtocolError"),r.oneOfGetter=function(e){for(var t={},i=0;i<e.length;++i)t[e[i]]=1;return function(){for(var e=Object.keys(this),i=e.length-1;i>-1;--i)if(1===t[e[i]]&&void 0!==this[e[i]]&&null!==this[e[i]])return e[i]}},r.oneOfSetter=function(e){return function(t){for(var i=0;i<e.length;++i)e[i]!==t&&delete this[e[i]]}},r.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},r._configure=function(){var e=r.Buffer;e?(r._Buffer_from=e.from!==Uint8Array.from&&e.from||function(t,i){return new e(t,i)},r._Buffer_allocUnsafe=e.allocUnsafe||function(t){return new e(t)}):r._Buffer_from=r._Buffer_allocUnsafe=null}}).call(this,i(56))},function(e,t,i){var r;!function(s){"use strict";var o,n=/^-?(?:\d+(?:\.\d*)?|\.\d+)(?:e[+-]?\d+)?$/i,a=Math.ceil,d=Math.floor,c="[BigNumber Error] ",l=c+"Number primitive has more than 15 significant digits: ",u=1e14,p=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9,1e10,1e11,1e12,1e13],h=1e9;function f(e){var t=0|e;return e>0||e===t?t:t-1}function m(e){for(var t,i,r=1,s=e.length,o=e[0]+"";r<s;){for(i=14-(t=e[r++]+"").length;i--;t="0"+t);o+=t}for(s=o.length;48===o.charCodeAt(--s););return o.slice(0,s+1||1)}function g(e,t){var i,r,s=e.c,o=t.c,n=e.s,a=t.s,d=e.e,c=t.e;if(!n||!a)return null;if(i=s&&!s[0],r=o&&!o[0],i||r)return i?r?0:-a:n;if(n!=a)return n;if(i=n<0,r=d==c,!s||!o)return r?0:!s^i?1:-1;if(!r)return d>c^i?1:-1;for(a=(d=s.length)<(c=o.length)?d:c,n=0;n<a;n++)if(s[n]!=o[n])return s[n]>o[n]^i?1:-1;return d==c?0:d>c^i?1:-1}function v(e,t,i,r){if(e<t||e>i||e!==d(e))throw Error(c+(r||"Argument")+("number"==typeof e?e<t||e>i?" out of range: ":" not an integer: ":" not a primitive number: ")+String(e))}function y(e){var t=e.c.length-1;return f(e.e/14)==t&&e.c[t]%2!=0}function _(e,t){return(e.length>1?e.charAt(0)+"."+e.slice(1):e)+(t<0?"e":"e+")+t}function S(e,t,i){var r,s;if(t<0){for(s=i+".";++t;s+=i);e=s+e}else if(++t>(r=e.length)){for(s=i,t-=r;--t;s+=i);e+=s}else t<r&&(e=e.slice(0,t)+"."+e.slice(t));return e}(o=function e(t){var i,r,s,o,b,R,w,T,A,E=V.prototype={constructor:V,toString:null,valueOf:null},I=new V(1),O=20,C=4,P=-7,k=21,x=-1e7,D=1e7,N=!1,M=1,L=0,F={prefix:"",groupSize:3,secondaryGroupSize:0,groupSeparator:",",decimalSeparator:".",fractionGroupSize:0,fractionGroupSeparator:" ",suffix:""},j="0123456789abcdefghijklmnopqrstuvwxyz";function V(e,t){var i,o,a,c,u,p,h,f,m=this;if(!(m instanceof V))return new V(e,t);if(null==t){if(e&&!0===e._isBigNumber)return m.s=e.s,void(!e.c||e.e>D?m.c=m.e=null:e.e<x?m.c=[m.e=0]:(m.e=e.e,m.c=e.c.slice()));if((p="number"==typeof e)&&0*e==0){if(m.s=1/e<0?(e=-e,-1):1,e===~~e){for(c=0,u=e;u>=10;u/=10,c++);return void(c>D?m.c=m.e=null:(m.e=c,m.c=[e]))}f=String(e)}else{if(!n.test(f=String(e)))return s(m,f,p);m.s=45==f.charCodeAt(0)?(f=f.slice(1),-1):1}(c=f.indexOf("."))>-1&&(f=f.replace(".","")),(u=f.search(/e/i))>0?(c<0&&(c=u),c+=+f.slice(u+1),f=f.substring(0,u)):c<0&&(c=f.length)}else{if(v(t,2,j.length,"Base"),10==t)return H(m=new V(e),O+m.e+1,C);if(f=String(e),p="number"==typeof e){if(0*e!=0)return s(m,f,p,t);if(m.s=1/e<0?(f=f.slice(1),-1):1,V.DEBUG&&f.replace(/^0\.0*|\./,"").length>15)throw Error(l+e)}else m.s=45===f.charCodeAt(0)?(f=f.slice(1),-1):1;for(i=j.slice(0,t),c=u=0,h=f.length;u<h;u++)if(i.indexOf(o=f.charAt(u))<0){if("."==o){if(u>c){c=h;continue}}else if(!a&&(f==f.toUpperCase()&&(f=f.toLowerCase())||f==f.toLowerCase()&&(f=f.toUpperCase()))){a=!0,u=-1,c=0;continue}return s(m,String(e),p,t)}p=!1,(c=(f=r(f,t,10,m.s)).indexOf("."))>-1?f=f.replace(".",""):c=f.length}for(u=0;48===f.charCodeAt(u);u++);for(h=f.length;48===f.charCodeAt(--h););if(f=f.slice(u,++h)){if(h-=u,p&&V.DEBUG&&h>15&&(e>9007199254740991||e!==d(e)))throw Error(l+m.s*e);if((c=c-u-1)>D)m.c=m.e=null;else if(c<x)m.c=[m.e=0];else{if(m.e=c,m.c=[],u=(c+1)%14,c<0&&(u+=14),u<h){for(u&&m.c.push(+f.slice(0,u)),h-=14;u<h;)m.c.push(+f.slice(u,u+=14));u=14-(f=f.slice(u)).length}else u-=h;for(;u--;f+="0");m.c.push(+f)}}else m.c=[m.e=0]}function U(e,t,i,r){var s,o,n,a,d;if(null==i?i=C:v(i,0,8),!e.c)return e.toString();if(s=e.c[0],n=e.e,null==t)d=m(e.c),d=1==r||2==r&&(n<=P||n>=k)?_(d,n):S(d,n,"0");else if(o=(e=H(new V(e),t,i)).e,a=(d=m(e.c)).length,1==r||2==r&&(t<=o||o<=P)){for(;a<t;d+="0",a++);d=_(d,o)}else if(t-=n,d=S(d,o,"0"),o+1>a){if(--t>0)for(d+=".";t--;d+="0");}else if((t+=o-a)>0)for(o+1==a&&(d+=".");t--;d+="0");return e.s<0&&s?"-"+d:d}function B(e,t){for(var i,r=1,s=new V(e[0]);r<e.length;r++){if(!(i=new V(e[r])).s){s=i;break}t.call(s,i)&&(s=i)}return s}function $(e,t,i){for(var r=1,s=t.length;!t[--s];t.pop());for(s=t[0];s>=10;s/=10,r++);return(i=r+14*i-1)>D?e.c=e.e=null:i<x?e.c=[e.e=0]:(e.e=i,e.c=t),e}function H(e,t,i,r){var s,o,n,c,l,h,f,m=e.c,g=p;if(m){e:{for(s=1,c=m[0];c>=10;c/=10,s++);if((o=t-s)<0)o+=14,n=t,f=(l=m[h=0])/g[s-n-1]%10|0;else if((h=a((o+1)/14))>=m.length){if(!r)break e;for(;m.length<=h;m.push(0));l=f=0,s=1,n=(o%=14)-14+1}else{for(l=c=m[h],s=1;c>=10;c/=10,s++);f=(n=(o%=14)-14+s)<0?0:l/g[s-n-1]%10|0}if(r=r||t<0||null!=m[h+1]||(n<0?l:l%g[s-n-1]),r=i<4?(f||r)&&(0==i||i==(e.s<0?3:2)):f>5||5==f&&(4==i||r||6==i&&(o>0?n>0?l/g[s-n]:0:m[h-1])%10&1||i==(e.s<0?8:7)),t<1||!m[0])return m.length=0,r?(t-=e.e+1,m[0]=g[(14-t%14)%14],e.e=-t||0):m[0]=e.e=0,e;if(0==o?(m.length=h,c=1,h--):(m.length=h+1,c=g[14-o],m[h]=n>0?d(l/g[s-n]%g[n])*c:0),r)for(;;){if(0==h){for(o=1,n=m[0];n>=10;n/=10,o++);for(n=m[0]+=c,c=1;n>=10;n/=10,c++);o!=c&&(e.e++,m[0]==u&&(m[0]=1));break}if(m[h]+=c,m[h]!=u)break;m[h--]=0,c=1}for(o=m.length;0===m[--o];m.pop());}e.e>D?e.c=e.e=null:e.e<x&&(e.c=[e.e=0])}return e}function W(e){var t,i=e.e;return null===i?e.toString():(t=m(e.c),t=i<=P||i>=k?_(t,i):S(t,i,"0"),e.s<0?"-"+t:t)}return V.clone=e,V.ROUND_UP=0,V.ROUND_DOWN=1,V.ROUND_CEIL=2,V.ROUND_FLOOR=3,V.ROUND_HALF_UP=4,V.ROUND_HALF_DOWN=5,V.ROUND_HALF_EVEN=6,V.ROUND_HALF_CEIL=7,V.ROUND_HALF_FLOOR=8,V.EUCLID=9,V.config=V.set=function(e){var t,i;if(null!=e){if("object"!=typeof e)throw Error(c+"Object expected: "+e);if(e.hasOwnProperty(t="DECIMAL_PLACES")&&(v(i=e[t],0,h,t),O=i),e.hasOwnProperty(t="ROUNDING_MODE")&&(v(i=e[t],0,8,t),C=i),e.hasOwnProperty(t="EXPONENTIAL_AT")&&((i=e[t])&&i.pop?(v(i[0],-h,0,t),v(i[1],0,h,t),P=i[0],k=i[1]):(v(i,-h,h,t),P=-(k=i<0?-i:i))),e.hasOwnProperty(t="RANGE"))if((i=e[t])&&i.pop)v(i[0],-h,-1,t),v(i[1],1,h,t),x=i[0],D=i[1];else{if(v(i,-h,h,t),!i)throw Error(c+t+" cannot be zero: "+i);x=-(D=i<0?-i:i)}if(e.hasOwnProperty(t="CRYPTO")){if((i=e[t])!==!!i)throw Error(c+t+" not true or false: "+i);if(i){if("undefined"==typeof crypto||!crypto||!crypto.getRandomValues&&!crypto.randomBytes)throw N=!i,Error(c+"crypto unavailable");N=i}else N=i}if(e.hasOwnProperty(t="MODULO_MODE")&&(v(i=e[t],0,9,t),M=i),e.hasOwnProperty(t="POW_PRECISION")&&(v(i=e[t],0,h,t),L=i),e.hasOwnProperty(t="FORMAT")){if("object"!=typeof(i=e[t]))throw Error(c+t+" not an object: "+i);F=i}if(e.hasOwnProperty(t="ALPHABET")){if("string"!=typeof(i=e[t])||/^.?$|[+\-.\s]|(.).*\1/.test(i))throw Error(c+t+" invalid: "+i);j=i}}return{DECIMAL_PLACES:O,ROUNDING_MODE:C,EXPONENTIAL_AT:[P,k],RANGE:[x,D],CRYPTO:N,MODULO_MODE:M,POW_PRECISION:L,FORMAT:F,ALPHABET:j}},V.isBigNumber=function(e){if(!e||!0!==e._isBigNumber)return!1;if(!V.DEBUG)return!0;var t,i,r=e.c,s=e.e,o=e.s;e:if("[object Array]"=={}.toString.call(r)){if((1===o||-1===o)&&s>=-h&&s<=h&&s===d(s)){if(0===r[0]){if(0===s&&1===r.length)return!0;break e}if((t=(s+1)%14)<1&&(t+=14),String(r[0]).length==t){for(t=0;t<r.length;t++)if((i=r[t])<0||i>=u||i!==d(i))break e;if(0!==i)return!0}}}else if(null===r&&null===s&&(null===o||1===o||-1===o))return!0;throw Error(c+"Invalid BigNumber: "+e)},V.maximum=V.max=function(){return B(arguments,E.lt)},V.minimum=V.min=function(){return B(arguments,E.gt)},V.random=(o=9007199254740992*Math.random()&2097151?function(){return d(9007199254740992*Math.random())}:function(){return 8388608*(1073741824*Math.random()|0)+(8388608*Math.random()|0)},function(e){var t,i,r,s,n,l=0,u=[],f=new V(I);if(null==e?e=O:v(e,0,h),s=a(e/14),N)if(crypto.getRandomValues){for(t=crypto.getRandomValues(new Uint32Array(s*=2));l<s;)(n=131072*t[l]+(t[l+1]>>>11))>=9e15?(i=crypto.getRandomValues(new Uint32Array(2)),t[l]=i[0],t[l+1]=i[1]):(u.push(n%1e14),l+=2);l=s/2}else{if(!crypto.randomBytes)throw N=!1,Error(c+"crypto unavailable");for(t=crypto.randomBytes(s*=7);l<s;)(n=281474976710656*(31&t[l])+1099511627776*t[l+1]+4294967296*t[l+2]+16777216*t[l+3]+(t[l+4]<<16)+(t[l+5]<<8)+t[l+6])>=9e15?crypto.randomBytes(7).copy(t,l):(u.push(n%1e14),l+=7);l=s/7}if(!N)for(;l<s;)(n=o())<9e15&&(u[l++]=n%1e14);for(e%=14,(s=u[--l])&&e&&(n=p[14-e],u[l]=d(s/n)*n);0===u[l];u.pop(),l--);if(l<0)u=[r=0];else{for(r=-1;0===u[0];u.splice(0,1),r-=14);for(l=1,n=u[0];n>=10;n/=10,l++);l<14&&(r-=14-l)}return f.e=r,f.c=u,f}),V.sum=function(){for(var e=1,t=arguments,i=new V(t[0]);e<t.length;)i=i.plus(t[e++]);return i},r=function(){function e(e,t,i,r){for(var s,o,n=[0],a=0,d=e.length;a<d;){for(o=n.length;o--;n[o]*=t);for(n[0]+=r.indexOf(e.charAt(a++)),s=0;s<n.length;s++)n[s]>i-1&&(null==n[s+1]&&(n[s+1]=0),n[s+1]+=n[s]/i|0,n[s]%=i)}return n.reverse()}return function(t,r,s,o,n){var a,d,c,l,u,p,h,f,g=t.indexOf("."),v=O,y=C;for(g>=0&&(l=L,L=0,t=t.replace(".",""),p=(f=new V(r)).pow(t.length-g),L=l,f.c=e(S(m(p.c),p.e,"0"),10,s,"0123456789"),f.e=f.c.length),c=l=(h=e(t,r,s,n?(a=j,"0123456789"):(a="0123456789",j))).length;0==h[--l];h.pop());if(!h[0])return a.charAt(0);if(g<0?--c:(p.c=h,p.e=c,p.s=o,h=(p=i(p,f,v,y,s)).c,u=p.r,c=p.e),g=h[d=c+v+1],l=s/2,u=u||d<0||null!=h[d+1],u=y<4?(null!=g||u)&&(0==y||y==(p.s<0?3:2)):g>l||g==l&&(4==y||u||6==y&&1&h[d-1]||y==(p.s<0?8:7)),d<1||!h[0])t=u?S(a.charAt(1),-v,a.charAt(0)):a.charAt(0);else{if(h.length=d,u)for(--s;++h[--d]>s;)h[d]=0,d||(++c,h=[1].concat(h));for(l=h.length;!h[--l];);for(g=0,t="";g<=l;t+=a.charAt(h[g++]));t=S(t,c,a.charAt(0))}return t}}(),i=function(){function e(e,t,i){var r,s,o,n,a=0,d=e.length,c=t%1e7,l=t/1e7|0;for(e=e.slice();d--;)a=((s=c*(o=e[d]%1e7)+(r=l*o+(n=e[d]/1e7|0)*c)%1e7*1e7+a)/i|0)+(r/1e7|0)+l*n,e[d]=s%i;return a&&(e=[a].concat(e)),e}function t(e,t,i,r){var s,o;if(i!=r)o=i>r?1:-1;else for(s=o=0;s<i;s++)if(e[s]!=t[s]){o=e[s]>t[s]?1:-1;break}return o}function i(e,t,i,r){for(var s=0;i--;)e[i]-=s,s=e[i]<t[i]?1:0,e[i]=s*r+e[i]-t[i];for(;!e[0]&&e.length>1;e.splice(0,1));}return function(r,s,o,n,a){var c,l,p,h,m,g,v,y,_,S,b,R,w,T,A,E,I,O=r.s==s.s?1:-1,C=r.c,P=s.c;if(!(C&&C[0]&&P&&P[0]))return new V(r.s&&s.s&&(C?!P||C[0]!=P[0]:P)?C&&0==C[0]||!P?0*O:O/0:NaN);for(_=(y=new V(O)).c=[],O=o+(l=r.e-s.e)+1,a||(a=u,l=f(r.e/14)-f(s.e/14),O=O/14|0),p=0;P[p]==(C[p]||0);p++);if(P[p]>(C[p]||0)&&l--,O<0)_.push(1),h=!0;else{for(T=C.length,E=P.length,p=0,O+=2,(m=d(a/(P[0]+1)))>1&&(P=e(P,m,a),C=e(C,m,a),E=P.length,T=C.length),w=E,b=(S=C.slice(0,E)).length;b<E;S[b++]=0);I=P.slice(),I=[0].concat(I),A=P[0],P[1]>=a/2&&A++;do{if(m=0,(c=t(P,S,E,b))<0){if(R=S[0],E!=b&&(R=R*a+(S[1]||0)),(m=d(R/A))>1)for(m>=a&&(m=a-1),v=(g=e(P,m,a)).length,b=S.length;1==t(g,S,v,b);)m--,i(g,E<v?I:P,v,a),v=g.length,c=1;else 0==m&&(c=m=1),v=(g=P.slice()).length;if(v<b&&(g=[0].concat(g)),i(S,g,b,a),b=S.length,-1==c)for(;t(P,S,E,b)<1;)m++,i(S,E<b?I:P,b,a),b=S.length}else 0===c&&(m++,S=[0]);_[p++]=m,S[0]?S[b++]=C[w]||0:(S=[C[w]],b=1)}while((w++<T||null!=S[0])&&O--);h=null!=S[0],_[0]||_.splice(0,1)}if(a==u){for(p=1,O=_[0];O>=10;O/=10,p++);H(y,o+(y.e=p+14*l-1)+1,n,h)}else y.e=l,y.r=+h;return y}}(),b=/^(-?)0([xbo])(?=\w[\w.]*$)/i,R=/^([^.]+)\.$/,w=/^\.([^.]+)$/,T=/^-?(Infinity|NaN)$/,A=/^\s*\+(?=[\w.])|^\s+|\s+$/g,s=function(e,t,i,r){var s,o=i?t:t.replace(A,"");if(T.test(o))e.s=isNaN(o)?null:o<0?-1:1;else{if(!i&&(o=o.replace(b,(function(e,t,i){return s="x"==(i=i.toLowerCase())?16:"b"==i?2:8,r&&r!=s?e:t})),r&&(s=r,o=o.replace(R,"$1").replace(w,"0.$1")),t!=o))return new V(o,s);if(V.DEBUG)throw Error(c+"Not a"+(r?" base "+r:"")+" number: "+t);e.s=null}e.c=e.e=null},E.absoluteValue=E.abs=function(){var e=new V(this);return e.s<0&&(e.s=1),e},E.comparedTo=function(e,t){return g(this,new V(e,t))},E.decimalPlaces=E.dp=function(e,t){var i,r,s,o=this;if(null!=e)return v(e,0,h),null==t?t=C:v(t,0,8),H(new V(o),e+o.e+1,t);if(!(i=o.c))return null;if(r=14*((s=i.length-1)-f(this.e/14)),s=i[s])for(;s%10==0;s/=10,r--);return r<0&&(r=0),r},E.dividedBy=E.div=function(e,t){return i(this,new V(e,t),O,C)},E.dividedToIntegerBy=E.idiv=function(e,t){return i(this,new V(e,t),0,1)},E.exponentiatedBy=E.pow=function(e,t){var i,r,s,o,n,l,u,p,h=this;if((e=new V(e)).c&&!e.isInteger())throw Error(c+"Exponent not an integer: "+W(e));if(null!=t&&(t=new V(t)),n=e.e>14,!h.c||!h.c[0]||1==h.c[0]&&!h.e&&1==h.c.length||!e.c||!e.c[0])return p=new V(Math.pow(+W(h),n?2-y(e):+W(e))),t?p.mod(t):p;if(l=e.s<0,t){if(t.c?!t.c[0]:!t.s)return new V(NaN);(r=!l&&h.isInteger()&&t.isInteger())&&(h=h.mod(t))}else{if(e.e>9&&(h.e>0||h.e<-1||(0==h.e?h.c[0]>1||n&&h.c[1]>=24e7:h.c[0]<8e13||n&&h.c[0]<=9999975e7)))return o=h.s<0&&y(e)?-0:0,h.e>-1&&(o=1/o),new V(l?1/o:o);L&&(o=a(L/14+2))}for(n?(i=new V(.5),l&&(e.s=1),u=y(e)):u=(s=Math.abs(+W(e)))%2,p=new V(I);;){if(u){if(!(p=p.times(h)).c)break;o?p.c.length>o&&(p.c.length=o):r&&(p=p.mod(t))}if(s){if(0===(s=d(s/2)))break;u=s%2}else if(H(e=e.times(i),e.e+1,1),e.e>14)u=y(e);else{if(0===(s=+W(e)))break;u=s%2}h=h.times(h),o?h.c&&h.c.length>o&&(h.c.length=o):r&&(h=h.mod(t))}return r?p:(l&&(p=I.div(p)),t?p.mod(t):o?H(p,L,C,void 0):p)},E.integerValue=function(e){var t=new V(this);return null==e?e=C:v(e,0,8),H(t,t.e+1,e)},E.isEqualTo=E.eq=function(e,t){return 0===g(this,new V(e,t))},E.isFinite=function(){return!!this.c},E.isGreaterThan=E.gt=function(e,t){return g(this,new V(e,t))>0},E.isGreaterThanOrEqualTo=E.gte=function(e,t){return 1===(t=g(this,new V(e,t)))||0===t},E.isInteger=function(){return!!this.c&&f(this.e/14)>this.c.length-2},E.isLessThan=E.lt=function(e,t){return g(this,new V(e,t))<0},E.isLessThanOrEqualTo=E.lte=function(e,t){return-1===(t=g(this,new V(e,t)))||0===t},E.isNaN=function(){return!this.s},E.isNegative=function(){return this.s<0},E.isPositive=function(){return this.s>0},E.isZero=function(){return!!this.c&&0==this.c[0]},E.minus=function(e,t){var i,r,s,o,n=this,a=n.s;if(t=(e=new V(e,t)).s,!a||!t)return new V(NaN);if(a!=t)return e.s=-t,n.plus(e);var d=n.e/14,c=e.e/14,l=n.c,p=e.c;if(!d||!c){if(!l||!p)return l?(e.s=-t,e):new V(p?n:NaN);if(!l[0]||!p[0])return p[0]?(e.s=-t,e):new V(l[0]?n:3==C?-0:0)}if(d=f(d),c=f(c),l=l.slice(),a=d-c){for((o=a<0)?(a=-a,s=l):(c=d,s=p),s.reverse(),t=a;t--;s.push(0));s.reverse()}else for(r=(o=(a=l.length)<(t=p.length))?a:t,a=t=0;t<r;t++)if(l[t]!=p[t]){o=l[t]<p[t];break}if(o&&(s=l,l=p,p=s,e.s=-e.s),(t=(r=p.length)-(i=l.length))>0)for(;t--;l[i++]=0);for(t=u-1;r>a;){if(l[--r]<p[r]){for(i=r;i&&!l[--i];l[i]=t);--l[i],l[r]+=u}l[r]-=p[r]}for(;0==l[0];l.splice(0,1),--c);return l[0]?$(e,l,c):(e.s=3==C?-1:1,e.c=[e.e=0],e)},E.modulo=E.mod=function(e,t){var r,s,o=this;return e=new V(e,t),!o.c||!e.s||e.c&&!e.c[0]?new V(NaN):!e.c||o.c&&!o.c[0]?new V(o):(9==M?(s=e.s,e.s=1,r=i(o,e,0,3),e.s=s,r.s*=s):r=i(o,e,0,M),(e=o.minus(r.times(e))).c[0]||1!=M||(e.s=o.s),e)},E.multipliedBy=E.times=function(e,t){var i,r,s,o,n,a,d,c,l,p,h,m,g,v,y=this,_=y.c,S=(e=new V(e,t)).c;if(!(_&&S&&_[0]&&S[0]))return!y.s||!e.s||_&&!_[0]&&!S||S&&!S[0]&&!_?e.c=e.e=e.s=null:(e.s*=y.s,_&&S?(e.c=[0],e.e=0):e.c=e.e=null),e;for(r=f(y.e/14)+f(e.e/14),e.s*=y.s,(d=_.length)<(p=S.length)&&(g=_,_=S,S=g,s=d,d=p,p=s),s=d+p,g=[];s--;g.push(0));for(v=u,1e7,s=p;--s>=0;){for(i=0,h=S[s]%1e7,m=S[s]/1e7|0,o=s+(n=d);o>s;)i=((c=h*(c=_[--n]%1e7)+(a=m*c+(l=_[n]/1e7|0)*h)%1e7*1e7+g[o]+i)/v|0)+(a/1e7|0)+m*l,g[o--]=c%v;g[o]=i}return i?++r:g.splice(0,1),$(e,g,r)},E.negated=function(){var e=new V(this);return e.s=-e.s||null,e},E.plus=function(e,t){var i,r=this,s=r.s;if(t=(e=new V(e,t)).s,!s||!t)return new V(NaN);if(s!=t)return e.s=-t,r.minus(e);var o=r.e/14,n=e.e/14,a=r.c,d=e.c;if(!o||!n){if(!a||!d)return new V(s/0);if(!a[0]||!d[0])return d[0]?e:new V(a[0]?r:0*s)}if(o=f(o),n=f(n),a=a.slice(),s=o-n){for(s>0?(n=o,i=d):(s=-s,i=a),i.reverse();s--;i.push(0));i.reverse()}for((s=a.length)-(t=d.length)<0&&(i=d,d=a,a=i,t=s),s=0;t;)s=(a[--t]=a[t]+d[t]+s)/u|0,a[t]=u===a[t]?0:a[t]%u;return s&&(a=[s].concat(a),++n),$(e,a,n)},E.precision=E.sd=function(e,t){var i,r,s,o=this;if(null!=e&&e!==!!e)return v(e,1,h),null==t?t=C:v(t,0,8),H(new V(o),e,t);if(!(i=o.c))return null;if(r=14*(s=i.length-1)+1,s=i[s]){for(;s%10==0;s/=10,r--);for(s=i[0];s>=10;s/=10,r++);}return e&&o.e+1>r&&(r=o.e+1),r},E.shiftedBy=function(e){return v(e,-9007199254740991,9007199254740991),this.times("1e"+e)},E.squareRoot=E.sqrt=function(){var e,t,r,s,o,n=this,a=n.c,d=n.s,c=n.e,l=O+4,u=new V("0.5");if(1!==d||!a||!a[0])return new V(!d||d<0&&(!a||a[0])?NaN:a?n:1/0);if(0==(d=Math.sqrt(+W(n)))||d==1/0?(((t=m(a)).length+c)%2==0&&(t+="0"),d=Math.sqrt(+t),c=f((c+1)/2)-(c<0||c%2),r=new V(t=d==1/0?"5e"+c:(t=d.toExponential()).slice(0,t.indexOf("e")+1)+c)):r=new V(d+""),r.c[0])for((d=(c=r.e)+l)<3&&(d=0);;)if(o=r,r=u.times(o.plus(i(n,o,l,1))),m(o.c).slice(0,d)===(t=m(r.c)).slice(0,d)){if(r.e<c&&--d,"9999"!=(t=t.slice(d-3,d+1))&&(s||"4999"!=t)){+t&&(+t.slice(1)||"5"!=t.charAt(0))||(H(r,r.e+O+2,1),e=!r.times(r).eq(n));break}if(!s&&(H(o,o.e+O+2,0),o.times(o).eq(n))){r=o;break}l+=4,d+=4,s=1}return H(r,r.e+O+1,C,e)},E.toExponential=function(e,t){return null!=e&&(v(e,0,h),e++),U(this,e,t,1)},E.toFixed=function(e,t){return null!=e&&(v(e,0,h),e=e+this.e+1),U(this,e,t)},E.toFormat=function(e,t,i){var r,s=this;if(null==i)null!=e&&t&&"object"==typeof t?(i=t,t=null):e&&"object"==typeof e?(i=e,e=t=null):i=F;else if("object"!=typeof i)throw Error(c+"Argument not an object: "+i);if(r=s.toFixed(e,t),s.c){var o,n=r.split("."),a=+i.groupSize,d=+i.secondaryGroupSize,l=i.groupSeparator||"",u=n[0],p=n[1],h=s.s<0,f=h?u.slice(1):u,m=f.length;if(d&&(o=a,a=d,d=o,m-=o),a>0&&m>0){for(o=m%a||a,u=f.substr(0,o);o<m;o+=a)u+=l+f.substr(o,a);d>0&&(u+=l+f.slice(o)),h&&(u="-"+u)}r=p?u+(i.decimalSeparator||"")+((d=+i.fractionGroupSize)?p.replace(new RegExp("\\d{"+d+"}\\B","g"),"$&"+(i.fractionGroupSeparator||"")):p):u}return(i.prefix||"")+r+(i.suffix||"")},E.toFraction=function(e){var t,r,s,o,n,a,d,l,u,h,f,g,v=this,y=v.c;if(null!=e&&(!(d=new V(e)).isInteger()&&(d.c||1!==d.s)||d.lt(I)))throw Error(c+"Argument "+(d.isInteger()?"out of range: ":"not an integer: ")+W(d));if(!y)return new V(v);for(t=new V(I),u=r=new V(I),s=l=new V(I),g=m(y),n=t.e=g.length-v.e-1,t.c[0]=p[(a=n%14)<0?14+a:a],e=!e||d.comparedTo(t)>0?n>0?t:u:d,a=D,D=1/0,d=new V(g),l.c[0]=0;h=i(d,t,0,1),1!=(o=r.plus(h.times(s))).comparedTo(e);)r=s,s=o,u=l.plus(h.times(o=u)),l=o,t=d.minus(h.times(o=t)),d=o;return o=i(e.minus(r),s,0,1),l=l.plus(o.times(u)),r=r.plus(o.times(s)),l.s=u.s=v.s,f=i(u,s,n*=2,C).minus(v).abs().comparedTo(i(l,r,n,C).minus(v).abs())<1?[u,s]:[l,r],D=a,f},E.toNumber=function(){return+W(this)},E.toPrecision=function(e,t){return null!=e&&v(e,1,h),U(this,e,t,2)},E.toString=function(e){var t,i=this,s=i.s,o=i.e;return null===o?s?(t="Infinity",s<0&&(t="-"+t)):t="NaN":(null==e?t=o<=P||o>=k?_(m(i.c),o):S(m(i.c),o,"0"):10===e?t=S(m((i=H(new V(i),O+o+1,C)).c),i.e,"0"):(v(e,2,j.length,"Base"),t=r(S(m(i.c),o,"0"),10,e,s,!0)),s<0&&i.c[0]&&(t="-"+t)),t},E.valueOf=E.toJSON=function(){return W(this)},E._isBigNumber=!0,null!=t&&V.set(t),V}()).default=o.BigNumber=o,void 0===(r=function(){return o}.call(t,i,t,e))||(e.exports=r)}()},function(e,t,i){var r=i(17);e.exports=function(e){if(!r(e))throw TypeError(e+" is not an object!");return e}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IS_OPPOBROWSER=t.SAMSUNG_VERSION=t.IS_SAMSUNGBROWSER=t.HUAWEI_VERSION=t.IS_HUAWEIBROWSER=t.MI_VERSION=t.IS_MIBROWSER=t.IS_ELECTRON=t.IS_UCBROWSER=t.IS_WX=t.IS_LINUX=t.IS_MAC=t.IS_WIN=t.IPADQQB_VERSION=t.IS_IPADQQB=t.MACQQB_VERSION=t.IS_MACQQB=t.WQQB_VERSION=t.IS_WQQB=t.MQQB_VERSION=t.IS_MQQB=t.IS_X5MQQB=t.WECHAT_VERSION=t.IS_WECHAT=t.IE_VERSION=t.IS_IE=t.IS_IE8=t.XWEB_VERSION=t.IS_XWEB=t.TBS_VERSION=t.IS_TBS=t.SOGOU_VERSION=t.IS_SOGOU=t.SOGOUM_VERSION=t.IS_SOGOUM=t.EDG_VERSION=t.EDG_MAJOR_VERSION=t.IS_EDG=t.EDGE_VERSION=t.IS_EDGE=t.FIREFOX_MAJOR_VERSION=t.IS_FIREFOX=t.ANDROID_VERSION=t.IS_ANDROID=t.IOS_VERSION=t.IS_IOS=t.IS_IPOD=t.IS_IPHONE=t.IS_IPAD=t.USER_AGENT=void 0,t.IS_LOCAL=t.IS_IOS_SAFARI=t.IS_MAC_SAFARI=t.SAFARI_VERSION=t.SAFARI_MAJOR_VERSION=t.IS_ANY_SAFARI=t.IS_SAFARI=t.CHROME_VERSION=t.CHROME_MAJOR_VERSION=t.IS_CHROME=t.IS_CHROME_ONLY=t.VIVO_VERSION=t.IS_VIVOBROWSER=t.OPPO_VERSION=void 0,t.USER_AGENT=window.navigator&&window.navigator.userAgent||"",t.IS_IPAD=/iPad/i.test(t.USER_AGENT),t.IS_IPHONE=/iPhone/i.test(t.USER_AGENT)&&!t.IS_IPAD,t.IS_IPOD=/iPod/i.test(t.USER_AGENT),t.IS_IOS=t.IS_IPHONE||t.IS_IPAD||t.IS_IPOD,t.IOS_VERSION=t.IS_IOS&&function(){const e=t.USER_AGENT.match(/\b[0-9]+_[0-9]+(?:_[0-9]+)?\b/)||[""];return e&&e[0]?parseFloat(e[0].replace(/_/g,".")):null}(),t.IS_ANDROID=/Android/i.test(t.USER_AGENT),t.ANDROID_VERSION=t.IS_ANDROID&&function(){const e=t.USER_AGENT.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);if(!e)return null;const i=e[1]&&parseFloat(e[1]),r=e[2]&&parseFloat(e[2]);return i&&r?parseFloat(e[1]+"."+e[2]):i||null}(),t.IS_FIREFOX=/Firefox/i.test(t.USER_AGENT),t.FIREFOX_MAJOR_VERSION=t.IS_FIREFOX&&function(){const e=t.USER_AGENT.match(/Firefox\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.IS_EDGE=/Edge\//i.test(t.USER_AGENT),t.EDGE_VERSION=t.IS_EDGE&&function(){var e=t.USER_AGENT.match(/Edge\/(\d+)/i);if(e&&e[1])return e[1]}(),t.IS_EDG=/Edg\//i.test(t.USER_AGENT),t.EDG_MAJOR_VERSION=t.IS_EDG&&function(){const e=t.USER_AGENT.match(/Edg\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.EDG_VERSION=t.IS_EDG&&function(){const e=t.USER_AGENT.match(/Edg\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_SOGOUM=/SogouMobileBrowser\//i.test(t.USER_AGENT),t.SOGOUM_VERSION=t.IS_SOGOUM&&function(){const e=t.USER_AGENT.match(/SogouMobileBrowser\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.IS_SOGOU=/MetaSr\s/i.test(t.USER_AGENT),t.SOGOU_VERSION=t.IS_SOGOU&&function(){const e=t.USER_AGENT.match(/MetaSr(\s\d+(\.\d+)+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.IS_TBS=/TBS\/\d+/i.test(t.USER_AGENT),t.TBS_VERSION=t.IS_TBS&&function(){var e=t.USER_AGENT.match(/TBS\/(\d+)/i);if(e&&e[1])return e[1]}(),t.IS_XWEB=/XWEB\/\d+/i.test(t.USER_AGENT),t.XWEB_VERSION=t.IS_XWEB&&function(){var e=t.USER_AGENT.match(/XWEB\/(\d+)/i);if(e&&e[1])return e[1]}(),t.IS_IE8=/MSIE\s8\.0/.test(t.USER_AGENT),t.IS_IE=/MSIE\/\d+/i.test(t.USER_AGENT),t.IE_VERSION=t.IS_IE&&function(){const e=/MSIE\s(\d+)\.\d/.exec(t.USER_AGENT);let i=e&&parseFloat(e[1]);return!i&&/Trident\/7.0/i.test(t.USER_AGENT)&&/rv:11.0/.test(t.USER_AGENT)&&(i=11),i}(),t.IS_WECHAT=/(micromessenger|webbrowser)/i.test(t.USER_AGENT),t.WECHAT_VERSION=t.IS_WECHAT&&function(){var e=t.USER_AGENT.match(/MicroMessenger\/(\d+)/i);if(e&&e[1])return parseFloat(e[1])}(),t.IS_X5MQQB=!t.IS_TBS&&/MQQBrowser\/\d+/i.test(t.USER_AGENT)&&/COVC\/\d+/i.test(t.USER_AGENT),t.IS_MQQB=!t.IS_TBS&&/MQQBrowser\/\d+/i.test(t.USER_AGENT)&&!/COVC\/\d+/i.test(t.USER_AGENT),t.MQQB_VERSION=(t.IS_MQQB||t.IS_X5MQQB)&&function(){const e=t.USER_AGENT.match(/ MQQBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_WQQB=!t.IS_TBS&&/ QQBrowser\/\d+/i.test(t.USER_AGENT),t.WQQB_VERSION=t.IS_WQQB&&function(){const e=t.USER_AGENT.match(/ QQBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_MACQQB=!t.IS_TBS&&/QQBrowserLite\/\d+/i.test(t.USER_AGENT),t.MACQQB_VERSION=t.IS_MACQQB&&function(){const e=t.USER_AGENT.match(/QQBrowserLite\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_IPADQQB=!t.IS_TBS&&/MQBHD\/\d+/i.test(t.USER_AGENT),t.IPADQQB_VERSION=t.IS_IPADQQB&&function(){const e=t.USER_AGENT.match(/MQBHD\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_WIN=/Windows/i.test(t.USER_AGENT),t.IS_MAC=!t.IS_IOS&&/MAC OS X/i.test(t.USER_AGENT),t.IS_LINUX=!t.IS_ANDROID&&/Linux/i.test(t.USER_AGENT),t.IS_WX=/MicroMessenger/i.test(t.USER_AGENT),t.IS_UCBROWSER=/UCBrowser/i.test(t.USER_AGENT),t.IS_ELECTRON=/Electron/i.test(t.USER_AGENT),t.IS_MIBROWSER=/MiuiBrowser/i.test(t.USER_AGENT),t.MI_VERSION=t.IS_MIBROWSER&&function(){const e=t.USER_AGENT.match(/MiuiBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_HUAWEIBROWSER=/HuaweiBrowser/i.test(t.USER_AGENT),t.HUAWEI_VERSION=t.IS_HUAWEIBROWSER&&function(){const e=t.USER_AGENT.match(/HuaweiBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_SAMSUNGBROWSER=/SamsungBrowser/i.test(t.USER_AGENT),t.SAMSUNG_VERSION=t.IS_SAMSUNGBROWSER&&function(){const e=t.USER_AGENT.match(/SamsungBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_OPPOBROWSER=/HeyTapBrowser/i.test(t.USER_AGENT),t.OPPO_VERSION=t.IS_OPPOBROWSER&&function(){const e=t.USER_AGENT.match(/HeyTapBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_VIVOBROWSER=/VivoBrowser/i.test(t.USER_AGENT),t.VIVO_VERSION=t.IS_VIVOBROWSER&&function(){const e=t.USER_AGENT.match(/VivoBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_CHROME_ONLY=/Chrome/i.test(t.USER_AGENT),t.IS_CHROME=!t.IS_EDGE&&!t.IS_SOGOU&&!t.IS_SOGOUM&&!t.IS_TBS&&!t.IS_XWEB&&!t.IS_EDG&&!t.IS_WQQB&&!t.IS_MIBROWSER&&!t.IS_HUAWEIBROWSER&&!t.IS_SAMSUNGBROWSER&&!t.IS_OPPOBROWSER&&!t.IS_VIVOBROWSER&&/Chrome/i.test(t.USER_AGENT),t.CHROME_MAJOR_VERSION=t.IS_CHROME&&function(){const e=t.USER_AGENT.match(/Chrome\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.CHROME_VERSION=t.IS_CHROME&&function(){const e=t.USER_AGENT.match(/Chrome\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_SAFARI=!t.IS_CHROME_ONLY&&!t.IS_MQQB&&!t.IS_X5MQQB&&!t.IS_MACQQB&&!t.IS_IPADQQB&&/Safari/i.test(t.USER_AGENT),t.IS_ANY_SAFARI=t.IS_SAFARI||t.IS_IOS,t.SAFARI_MAJOR_VERSION=t.IS_SAFARI&&function(){const e=t.USER_AGENT.match(/Version\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.SAFARI_VERSION=t.IS_SAFARI&&function(){const e=t.USER_AGENT.match(/Version\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_MAC_SAFARI=t.IS_SAFARI&&t.IS_MAC,t.IS_IOS_SAFARI=t.IS_SAFARI&&t.IS_IOS,t.IS_LOCAL="file:"===window.location.protocol||"localhost"===window.location.hostname||/^\d+\.\d+\.\d+\.\d+$/.test(window.location.hostname)},function(e,t,i){"use strict";function r(e){const t={video:[],audio:[]};return e.match(/ H264/i)&&t.video.push("H264"),e.match(/ VP8/i)&&t.video.push("VP8"),e.match(/ opus/i)&&t.audio.push("OPUS"),t}function s(e,t,i){const r={video:[],audio:[]};if(t&&t.codecs&&t.codecs.length)for(let i=0;i<t.codecs.length;i++){const s=t.codecs[i];"video/H264"==s.mimeType&&-1===r.video.indexOf("H264")&&("recv"===e&&s.sdpFmtpLine&&s.sdpFmtpLine.indexOf("profile-level-id")>-1?s.sdpFmtpLine.indexOf("profile-level-id=64")>-1&&r.video.push("H264"):-1===r.video.indexOf("H264")&&r.video.push("H264")),"video/VP8"==s.mimeType&&-1===r.video.indexOf("VP8")&&r.video.push("VP8")}if(i&&i.codecs&&i.codecs.length)for(let e=0;e<i.codecs.length;e++){"audio/opus"==i.codecs[e].mimeType&&r.audio.push("OPUS")}return r}Object.defineProperty(t,"__esModule",{value:!0}),t.reduceCodecs=t.getSupportedCodecs=t.VideoCodecList=void 0,t.VideoCodecList=["H264","VP8"],t.getSupportedCodecs=async function(e="recv",t=RTCPeerConnection){if("recv"===e){if("undefined"!=typeof RTCRtpReceiver&&RTCRtpReceiver.getCapabilities){return s(e,RTCRtpReceiver.getCapabilities("video"),RTCRtpReceiver.getCapabilities("audio"))}{const e=new t({});e.addTransceiver("audio",{direction:"recvonly"}),e.addTransceiver("video",{direction:"recvonly"});const i=await e.createOffer({});if(e.close(),!i.sdp)return!1;return r(i.sdp)}}if("undefined"!=typeof RTCRtpSender&&RTCRtpSender.getCapabilities){return s(e,RTCRtpSender.getCapabilities("video"),RTCRtpSender.getCapabilities("audio"))}{const e=new t({});let i=document.createElement("canvas");i.getContext("2d");const s=i.captureStream(0);e.addTrack(s.getVideoTracks()[0],s);const o=await e.createOffer({});if(e.close(),!o.sdp)return!1;return r(o.sdp)}},t.reduceCodecs=function(e,i){const r=[];for(let s=0;s<e.length;s++)e[s].mimeType&&i&&t.VideoCodecList.indexOf(e[s].mimeType.split("/")[1])>-1&&e[s].mimeType!==i.mimeType?s++:r.push(e[s]);return r}},function(e,t,i){var r=i(16),s=i(48);e.exports=i(18)?function(e,t,i){return r.f(e,t,s(1,i))}:function(e,t,i){return e[t]=i,e}},function(e,t,i){var r=i(12),s=i(95),o=i(65),n=Object.defineProperty;t.f=i(18)?Object.defineProperty:function(e,t,i){if(r(e),t=o(t,!0),r(i),s)try{return n(e,t,i)}catch(e){}if("get"in i||"set"in i)throw TypeError("Accessors not supported!");return"value"in i&&(e[t]=i.value),e}},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t,i){e.exports=!i(47)((function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}))},function(e,t){var i={}.hasOwnProperty;e.exports=function(e,t){return i.call(e,t)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.generateRandomNumber=t.clone=void 0,t.clone=function(e,t={}){return void 0===e?t:JSON.parse(JSON.stringify(e))},t.generateRandomNumber=function(){return Math.round(1e7*Math.random())}},function(e,t,i){"use strict";e.exports=c;var r=i(29);((c.prototype=Object.create(r.prototype)).constructor=c).className="Field";var s,o=i(8),n=i(30),a=i(4),d=/^required|optional|repeated$/;function c(e,t,i,s,o,c,l){if(a.isObject(s)?(l=o,c=s,s=o=void 0):a.isObject(o)&&(l=c,c=o,o=void 0),r.call(this,e,c),!a.isInteger(t)||t<0)throw TypeError("id must be a non-negative integer");if(!a.isString(i))throw TypeError("type must be a string");if(void 0!==s&&!d.test(s=s.toString().toLowerCase()))throw TypeError("rule must be a string rule");if(void 0!==o&&!a.isString(o))throw TypeError("extend must be a string");"proto3_optional"===s&&(s="optional"),this.rule=s&&"optional"!==s?s:void 0,this.type=i,this.id=t,this.extend=o||void 0,this.required="required"===s,this.optional=!this.required,this.repeated="repeated"===s,this.map=!1,this.message=null,this.partOf=null,this.typeDefault=null,this.defaultValue=null,this.long=!!a.Long&&void 0!==n.long[i],this.bytes="bytes"===i,this.resolvedType=null,this.extensionField=null,this.declaringField=null,this._packed=null,this.comment=l}c.fromJSON=function(e,t){return new c(e,t.id,t.type,t.rule,t.extend,t.options,t.comment)},Object.defineProperty(c.prototype,"packed",{get:function(){return null===this._packed&&(this._packed=!1!==this.getOption("packed")),this._packed}}),c.prototype.setOption=function(e,t,i){return"packed"===e&&(this._packed=null),r.prototype.setOption.call(this,e,t,i)},c.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return a.toObject(["rule","optional"!==this.rule&&this.rule||void 0,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",t?this.comment:void 0])},c.prototype.resolve=function(){if(this.resolved)return this;if(void 0===(this.typeDefault=n.defaults[this.type])&&(this.resolvedType=(this.declaringField?this.declaringField.parent:this.parent).lookupTypeOrEnum(this.type),this.resolvedType instanceof s?this.typeDefault=null:this.typeDefault=this.resolvedType.values[Object.keys(this.resolvedType.values)[0]]),this.options&&null!=this.options.default&&(this.typeDefault=this.options.default,this.resolvedType instanceof o&&"string"==typeof this.typeDefault&&(this.typeDefault=this.resolvedType.values[this.typeDefault])),this.options&&(!0!==this.options.packed&&(void 0===this.options.packed||!this.resolvedType||this.resolvedType instanceof o)||delete this.options.packed,Object.keys(this.options).length||(this.options=void 0)),this.long)this.typeDefault=a.Long.fromNumber(this.typeDefault,"u"===this.type.charAt(0)),Object.freeze&&Object.freeze(this.typeDefault);else if(this.bytes&&"string"==typeof this.typeDefault){var e;a.base64.test(this.typeDefault)?a.base64.decode(this.typeDefault,e=a.newBuffer(a.base64.length(this.typeDefault)),0):a.utf8.write(this.typeDefault,e=a.newBuffer(a.utf8.length(this.typeDefault)),0),this.typeDefault=e}return this.map?this.defaultValue=a.emptyObject:this.repeated?this.defaultValue=a.emptyArray:this.defaultValue=this.typeDefault,this.parent instanceof s&&(this.parent.ctor.prototype[this.name]=this.defaultValue),r.prototype.resolve.call(this)},c.d=function(e,t,i,r){return"function"==typeof t?t=a.decorateType(t).name:t&&"object"==typeof t&&(t=a.decorateEnum(t).name),function(s,o){a.decorateType(s.constructor).add(new c(o,e,t,i,{default:r}))}},c._configure=function(e){s=e}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getCloudProxyInfoUrl=t.roomsTaskUrl=t.getChannelInfoUrl=t.createChannelUrl=t.checkSumUrl=t.ENV=t.BUILD=t.ENGINE_VERSION=t.SDK_VERSION=void 0;t.SDK_VERSION="4.6.200";t.ENGINE_VERSION="4.6.0.0";t.BUILD="stab/v4.6.0-6-gaa8de5c";const r=i(141);Object.defineProperty(t,"ENV",{enumerable:!0,get:function(){return r.ENV}});const s=r.Config.checkSumUrl;t.checkSumUrl=s;const o=r.Config.createChannelUrl;t.createChannelUrl=o;const n=r.Config.getChannelInfoUrl;t.getChannelInfoUrl=n;const a=r.Config.roomsTaskUrl;t.roomsTaskUrl=a;const d=r.Config.getCloudProxyInfoUrl;t.getCloudProxyInfoUrl=d},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.checkExists=t.isExistOptions=t.checkValidBoolean=t.checkValidString=t.checkValidFloat=t.checkValidInteger=void 0;const s=r(i(1)),o=r(i(0));t.checkValidInteger=e=>{const t=(e=>Number.isInteger(e.value)?"number"==typeof e.min&&e.value<e.min?{result:!1,msg:"参数小于最小值"+e.min}:"number"==typeof e.max&&e.value>e.max?{result:!1,msg:"参数大于最大值"+e.max}:{result:!0}:{result:!1,msg:"参数不是整数"})(e);if(!t.result)throw new s.default({code:o.default.INVALID_PARAMETER,message:`参数错误 ${e.tag}:${t.msg}`})};t.checkValidBoolean=e=>{const t=(e=>"boolean"!=typeof e.value?{result:!1,msg:"参数不是布尔类型"}:{result:!0})(e);if(!t.result)throw new s.default({code:o.default.INVALID_PARAMETER,message:`参数错误 ${e.tag}:${t.msg}`})};t.checkValidString=e=>{const t=(e=>"string"!=typeof e.value?{result:!1,msg:"参数不是字符串"}:"number"==typeof e.min&&e.value.length<e.min?{result:!1,msg:"参数长度最小值"+e.min}:"number"==typeof e.max&&e.value.length>e.max?{result:!1,msg:"参数长度大于最大值"+e.max}:{result:!0})(e);if(!t.result)throw new s.default({code:o.default.INVALID_PARAMETER,message:`参数错误 ${e.tag}:${t.msg}`})};t.checkValidFloat=e=>{const t=(e=>Number.isFinite(e.value)?"number"==typeof e.min&&e.value<e.min?{result:!1,msg:"参数小于最小值"+e.min}:"number"==typeof e.max&&e.value>e.max?{result:!1,msg:"参数大于最大值"+e.max}:{result:!0}:{result:!1,msg:"参数不是float类型"})(e);if(!t.result)throw new s.default({code:o.default.INVALID_PARAMETER,message:`参数错误 ${e.tag}:${t.msg}`})};const n=e=>void 0===e.value||null===e.value?{result:!1,msg:"未填必选参数"}:{result:!0};t.isExistOptions=n;t.checkExists=e=>{const t=n(e);if(!t.result)throw new s.default({code:o.default.INVALID_PARAMETER,message:`参数错误：${e.tag} ${t.msg}`})}},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.loglevelMap=t.loglevels=void 0;const n=o(i(148)),a=i(2);!function(e){e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARNING=2]="WARNING",e[e.ERROR=3]="ERROR",e[e.NONE=4]="NONE"}(t.loglevels||(t.loglevels={})),t.loglevelMap={0:"DEBUG",1:"INFO",2:"WARNING",3:"ERROR",4:"NONE"};const d={setLogLevel(e){a.getParameters().logLevel!==e&&(n.info(`NERTC LogLevel was changed: ${t.loglevelMap[a.getParameters().logLevel]} => ${t.loglevelMap[e]}`),a.getParameters().logLevel=e)},enableLogUpload(){window.logUpload=!0},disableLogUpload(){window.logUpload=!1}};d.disableLogUpload(),n.setLevel("INFO"),t.default=d},function(e,t,i){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.platform=void 0;const i=function(){var t="object"==typeof e?e:window,i=Math.pow(2,53)-1,r=/\bOpera/,s=Object.prototype,o=s.hasOwnProperty,n=s.toString;function a(e){return(e=String(e)).charAt(0).toUpperCase()+e.slice(1)}function d(e){return e=h(e),/^(?:webOS|i(?:OS|P))/.test(e)?e:a(e)}function c(e,t){for(var i in e)o.call(e,i)&&t(e[i],i,e)}function l(e){return null==e?a(e):n.call(e).slice(8,-1)}function u(e){return String(e).replace(/([ -])(?!$)/g,"$1?")}function p(e,t){var r=null;return function(e,t){var r=-1,s=e?e.length:0;if("number"==typeof s&&s>-1&&s<=i)for(;++r<s;)t(e[r],r,e);else c(e,t)}(e,(function(i,s){r=t(r,i,s,e)})),r}function h(e){return String(e).replace(/^ +| +$/g,"")}return function e(i){var s=t,o=i&&"object"==typeof i&&"String"!=l(i);o&&(s=i,i="");var a=s.navigator||{},f=a.userAgent||"";i||(i=f);var m,g,v,y,_,S=o?!!a.likeChrome:/\bChrome\b/.test(i)&&!/internal|\n/i.test(n.toString()),b=o?"Object":"ScriptBridgingProxyObject",R=o?"Object":"Environment",w=o&&s.java?"JavaPackage":l(s.java),T=o?"Object":"RuntimeObject",A=/\bJava/.test(w)&&s.java,E=A&&l(s.environment)==R,I=A?"a":"α",O=A?"b":"β",C=s.document||{},P=s.operamini||s.opera,k=r.test(k=o&&P?P["[[Class]]"]:l(P))?k:P=null,x=i,D=[],N=null,M=i==f,L=M&&P&&"function"==typeof P.version&&P.version(),F=p([{label:"EdgeHTML",pattern:"Edge"},"Trident",{label:"WebKit",pattern:"AppleWebKit"},"iCab","Presto","NetFront","Tasman","KHTML","Gecko"],(function(e,t){return e||RegExp("\\b"+(t.pattern||u(t))+"\\b","i").exec(i)&&(t.label||t)})),j=function(e){return p(e,(function(e,t){return e||RegExp("\\b"+(t.pattern||u(t))+"\\b","i").exec(i)&&(t.label||t)}))}(["Adobe AIR","Arora","Avant Browser","Breach","Camino","Electron","Epiphany","Fennec","Flock","Galeon","GreenBrowser","iCab","Iceweasel","K-Meleon","Konqueror","Lunascape","Maxthon",{label:"Microsoft Edge",pattern:"Edge"},"Midori","Nook Browser","PaleMoon","PhantomJS","Raven","Rekonq","RockMelt",{label:"Samsung Internet",pattern:"SamsungBrowser"},"SeaMonkey",{label:"Silk",pattern:"(?:Cloud9|Silk-Accelerated)"},"Sleipnir","SlimBrowser",{label:"SRWare Iron",pattern:"Iron"},"Sunrise","Swiftfox","Waterfox","WebPositive","Opera Mini",{label:"Opera Mini",pattern:"OPiOS"},"Opera",{label:"Opera",pattern:"OPR"},"Chrome",{label:"Chrome Mobile",pattern:"(?:CriOS|CrMo)"},{label:"Firefox",pattern:"(?:Firefox|Minefield)"},{label:"Firefox for iOS",pattern:"FxiOS"},{label:"IE",pattern:"IEMobile"},{label:"IE",pattern:"MSIE"},"Safari"]),V=$([{label:"BlackBerry",pattern:"BB10"},"BlackBerry",{label:"Galaxy S",pattern:"GT-I9000"},{label:"Galaxy S2",pattern:"GT-I9100"},{label:"Galaxy S3",pattern:"GT-I9300"},{label:"Galaxy S4",pattern:"GT-I9500"},{label:"Galaxy S5",pattern:"SM-G900"},{label:"Galaxy S6",pattern:"SM-G920"},{label:"Galaxy S6 Edge",pattern:"SM-G925"},{label:"Galaxy S7",pattern:"SM-G930"},{label:"Galaxy S7 Edge",pattern:"SM-G935"},"Google TV","Lumia","iPad","iPod","iPhone","Kindle",{label:"Kindle Fire",pattern:"(?:Cloud9|Silk-Accelerated)"},"Nexus","Nook","PlayBook","PlayStation Vita","PlayStation","TouchPad","Transformer",{label:"Wii U",pattern:"WiiU"},"Wii","Xbox One",{label:"Xbox 360",pattern:"Xbox"},"Xoom"]),U=function(e){return p(e,(function(e,t,r){return e||(t[V]||t[/^[a-z]+(?: +[a-z]+\b)*/i.exec(V)]||RegExp("\\b"+u(r)+"(?:\\b|\\w*\\d)","i").exec(i))&&r}))}({Apple:{iPad:1,iPhone:1,iPod:1},Archos:{},Amazon:{Kindle:1,"Kindle Fire":1},Asus:{Transformer:1},"Barnes & Noble":{Nook:1},BlackBerry:{PlayBook:1},Google:{"Google TV":1,Nexus:1},HP:{TouchPad:1},HTC:{},LG:{},Microsoft:{Xbox:1,"Xbox One":1},Motorola:{Xoom:1},Nintendo:{"Wii U":1,Wii:1},Nokia:{Lumia:1},Samsung:{"Galaxy S":1,"Galaxy S2":1,"Galaxy S3":1,"Galaxy S4":1},Sony:{PlayStation:1,"PlayStation Vita":1}}),B=function(e){return p(e,(function(e,t){var r=t.pattern||u(t);return!e&&(e=RegExp("\\b"+r+"(?:/[\\d.]+|[ \\w.]*)","i").exec(i))&&(e=function(e,t,i){var r={"10.0":"10",6.4:"10 Technical Preview",6.3:"8.1",6.2:"8",6.1:"Server 2008 R2 / 7","6.0":"Server 2008 / Vista",5.2:"Server 2003 / XP 64-bit",5.1:"XP",5.01:"2000 SP1","5.0":"2000","4.0":"NT","4.90":"ME"};return t&&i&&/^Win/i.test(e)&&!/^Windows Phone /i.test(e)&&(r=r[/[\d.]+$/.exec(e)])&&(e="Windows "+r),e=String(e),t&&i&&(e=e.replace(RegExp(t,"i"),i)),e=d(e.replace(/ ce$/i," CE").replace(/\bhpw/i,"web").replace(/\bMacintosh\b/,"Mac OS").replace(/_PowerPC\b/i," OS").replace(/\b(OS X) [^ \d]+/i,"$1").replace(/\bMac (OS X)\b/,"$1").replace(/\/(\d)/," $1").replace(/_/g,".").replace(/(?: BePC|[ .]*fc[ \d.]+)$/i,"").replace(/\bx86\.64\b/gi,"x86_64").replace(/\b(Windows Phone) OS\b/,"$1").replace(/\b(Chrome OS \w+) [\d.]+\b/,"$1").split(" on ")[0])}(e,r,t.label||t)),e}))}(["Windows Phone","Android","CentOS",{label:"Chrome OS",pattern:"CrOS"},"Debian","Fedora","FreeBSD","Gentoo","Haiku","Kubuntu","Linux Mint","OpenBSD","Red Hat","SuSE","Ubuntu","Xubuntu","Cygwin","Symbian OS","hpwOS","webOS ","webOS","Tablet OS","Tizen","Linux","Mac OS X","Macintosh","Mac","Windows 98;","Windows "]);function $(e){return p(e,(function(e,t){var r=t.pattern||u(t);return!e&&(e=RegExp("\\b"+r+" *\\d+[.\\w_]*","i").exec(i)||RegExp("\\b"+r+" *\\w+-[\\w]*","i").exec(i)||RegExp("\\b"+r+"(?:; *(?:[a-z]+[_-])?[a-z]+\\d+|[^ ();-]*)","i").exec(i))&&((e=String(t.label&&!RegExp(r,"i").test(t.label)?t.label:e).split("/"))[1]&&!/[\d.]+/.test(e[0])&&(e[0]+=" "+e[1]),t=t.label||t,e=d(e[0].replace(RegExp(r,"i"),t).replace(RegExp("; *(?:"+t+"[_-])?","i")," ").replace(RegExp("("+t+")[-_.]?(\\w)","i"),"$1 $2"))),e}))}if(F&&(F=[F]),U&&!V&&(V=$([U])),(m=/\bGoogle TV\b/.exec(V))&&(V=m[0]),/\bSimulator\b/i.test(i)&&(V=(V?V+" ":"")+"Simulator"),"Opera Mini"==j&&/\bOPiOS\b/.test(i)&&D.push("running in Turbo/Uncompressed mode"),"IE"==j&&/\blike iPhone OS\b/.test(i)?(U=(m=e(i.replace(/like iPhone OS/,""))).manufacturer,V=m.product):/^iP/.test(V)?(j||(j="Safari"),B="iOS"+((m=/ OS ([\d_]+)/i.exec(i))?" "+m[1].replace(/_/g,"."):"")):"Konqueror"!=j||/buntu/i.test(B)?U&&"Google"!=U&&(/Chrome/.test(j)&&!/\bMobile Safari\b/i.test(i)||/\bVita\b/.test(V))||/\bAndroid\b/.test(B)&&/^Chrome/.test(j)&&/\bVersion\//i.test(i)?(j="Android Browser",B=/\bAndroid\b/.test(B)?B:"Android"):"Silk"==j?(/\bMobi/i.test(i)||(B="Android",D.unshift("desktop mode")),/Accelerated *= *true/i.test(i)&&D.unshift("accelerated")):"PaleMoon"==j&&(m=/\bFirefox\/([\d.]+)\b/.exec(i))?D.push("identifying as Firefox "+m[1]):"Firefox"==j&&(m=/\b(Mobile|Tablet|TV)\b/i.exec(i))?(B||(B="Firefox OS"),V||(V=m[1])):!j||(m=!/\bMinefield\b/i.test(i)&&/\b(?:Firefox|Safari)\b/.exec(j))?(j&&!V&&/[\/,]|^[^(]+?\)/.test(i.slice(i.indexOf(m+"/")+8))&&(j=null),(m=V||U||B)&&(V||U||/\b(?:Android|Symbian OS|Tablet OS|webOS)\b/.test(B))&&(j=/[a-z]+(?: Hat)?/i.exec(/\bAndroid\b/.test(B)?B:m)+" Browser")):"Electron"==j&&(m=(/\bChrome\/([\d.]+)\b/.exec(i)||0)[1])&&D.push("Chromium "+m):B="Kubuntu",L||(L=p(["(?:Cloud9|CriOS|CrMo|Edge|FxiOS|IEMobile|Iron|Opera ?Mini|OPiOS|OPR|Raven|SamsungBrowser|Silk(?!/[\\d.]+$))","Version",u(j),"(?:Firefox|Minefield|NetFront)"],(function(e,t){return e||(RegExp(t+"(?:-[\\d.]+/|(?: for [\\w-]+)?[ /-])([\\d.]+[^ ();/_-]*)","i").exec(i)||0)[1]||null}))),(m=("iCab"==F&&parseFloat(L)>3?"WebKit":/\bOpera\b/.test(j)&&(/\bOPR\b/.test(i)?"Blink":"Presto"))||/\b(?:Midori|Nook|Safari)\b/i.test(i)&&!/^(?:Trident|EdgeHTML)$/.test(F)&&"WebKit"||!F&&/\bMSIE\b/i.test(i)&&("Mac OS"==B?"Tasman":"Trident")||"WebKit"==F&&/\bPlayStation\b(?! Vita\b)/i.test(j)&&"NetFront")&&(F=[m]),"IE"==j&&(m=(/; *(?:XBLWP|ZuneWP)(\d+)/i.exec(i)||0)[1])?(j+=" Mobile",B="Windows Phone "+(/\+$/.test(m)?m:m+".x"),D.unshift("desktop mode")):/\bWPDesktop\b/i.test(i)?(j="IE Mobile",B="Windows Phone 8.x",D.unshift("desktop mode"),L||(L=(/\brv:([\d.]+)/.exec(i)||0)[1])):"IE"!=j&&"Trident"==F&&(m=/\brv:([\d.]+)/.exec(i))&&(j&&D.push("identifying as "+j+(L?" "+L:"")),j="IE",L=m[1]),M){if(y="global",_=null!=(v=s)?typeof v[y]:"number",/^(?:boolean|number|string|undefined)$/.test(_)||"object"==_&&!v[y])l(m=s.runtime)==b?(j="Adobe AIR",B=m.flash.system.Capabilities.os):l(m=s.phantom)==T?(j="PhantomJS",L=(m=m.version||null)&&m.major+"."+m.minor+"."+m.patch):"number"==typeof C.documentMode&&(m=/\bTrident\/(\d+)/i.exec(i))?(L=[L,C.documentMode],(m=+m[1]+4)!=L[1]&&(D.push("IE "+L[1]+" mode"),F&&(F[1]=""),L[1]=m),L="IE"==j?String(L[1].toFixed(1)):L[0]):"number"==typeof C.documentMode&&/^(?:Chrome|Firefox)\b/.test(j)&&(D.push("masking as "+j+" "+L),j="IE",L="11.0",F=["Trident"],B="Windows");else if(A&&(x=(m=A.lang.System).getProperty("os.arch"),B=B||m.getProperty("os.name")+" "+m.getProperty("os.version")),E){try{L=s.require("ringo/engine").version.join("."),j="RingoJS"}catch(e){(m=s.system)&&m.global.system==s.system&&(j="Narwhal",B||(B=m[0].os||null))}j||(j="Rhino")}else"object"==typeof s.process&&!s.process.browser&&(m=s.process)&&("object"==typeof m.versions&&("string"==typeof m.versions.electron?(D.push("Node "+m.versions.node),j="Electron",L=m.versions.electron):"string"==typeof m.versions.nw&&(D.push("Chromium "+L,"Node "+m.versions.node),j="NW.js",L=m.versions.nw)),j||(j="Node.js",x=m.arch,B=m.platform,L=(L=/[\d.]+/.exec(m.version))?L[0]:null));B=B&&d(B)}if(L&&(m=/(?:[ab]|dp|pre|[ab]\d+pre)(?:\d+\+?)?$/i.exec(L)||/(?:alpha|beta)(?: ?\d)?/i.exec(i+";"+(M&&a.appMinorVersion))||/\bMinefield\b/i.test(i)&&"a")&&(N=/b/i.test(m)?"beta":"alpha",L=L.replace(RegExp(m+"\\+?$"),"")+("beta"==N?O:I)+(/\d+\+?/.exec(m)||"")),"Fennec"==j||"Firefox"==j&&/\b(?:Android|Firefox OS)\b/.test(B))j="Firefox Mobile";else if("Maxthon"==j&&L)L=L.replace(/\.[\d.]+/,".x");else if(/\bXbox\b/i.test(V))"Xbox 360"==V&&(B=null),"Xbox 360"==V&&/\bIEMobile\b/.test(i)&&D.unshift("mobile mode");else if(!/^(?:Chrome|IE|Opera)$/.test(j)&&(!j||V||/Browser|Mobi/.test(j))||"Windows CE"!=B&&!/Mobi/i.test(i))if("IE"==j&&M)try{null===s.external&&D.unshift("platform preview")}catch(e){D.unshift("embedded")}else(/\bBlackBerry\b/.test(V)||/\bBB10\b/.test(i))&&(m=(RegExp(V.replace(/ +/g," *")+"/([.\\d]+)","i").exec(i)||0)[1]||L)?(B=((m=[m,/BB10/.test(i)])[1]?(V=null,U="BlackBerry"):"Device Software")+" "+m[0],L=null):this!=c&&"Wii"!=V&&(M&&P||/Opera/.test(j)&&/\b(?:MSIE|Firefox)\b/i.test(i)||"Firefox"==j&&/\bOS X (?:\d+\.){2,}/.test(B)||"IE"==j&&(B&&!/^Win/.test(B)&&L>5.5||/\bWindows XP\b/.test(B)&&L>8||8==L&&!/\bTrident\b/.test(i)))&&!r.test(m=e.call(c,i.replace(r,"")+";"))&&m.name&&(m="ing as "+m.name+((m=m.version)?" "+m:""),r.test(j)?(/\bIE\b/.test(m)&&"Mac OS"==B&&(B=null),m="identify"+m):(m="mask"+m,j=k?d(k.replace(/([a-z])([A-Z])/g,"$1 $2")):"Opera",/\bIE\b/.test(m)&&(B=null),M||(L=null)),F=["Presto"],D.push(m));else j+=" Mobile";(m=(/\bAppleWebKit\/([\d.]+\+?)/i.exec(i)||0)[1])&&(m=[parseFloat(m.replace(/\.(\d)$/,".0$1")),m],"Safari"==j&&"+"==m[1].slice(-1)?(j="WebKit Nightly",N="alpha",L=m[1].slice(0,-1)):L!=m[1]&&L!=(m[2]=(/\bSafari\/([\d.]+\+?)/i.exec(i)||0)[1])||(L=null),m[1]=(/\bChrome\/([\d.]+)/i.exec(i)||0)[1],537.36==m[0]&&537.36==m[2]&&parseFloat(m[1])>=28&&"WebKit"==F&&(F=["Blink"]),M&&(S||m[1])?(F&&(F[1]="like Chrome"),m=m[1]||((m=m[0])<530?1:m<532?2:m<532.05?3:m<533?4:m<534.03?5:m<534.07?6:m<534.1?7:m<534.13?8:m<534.16?9:m<534.24?10:m<534.3?11:m<535.01?12:m<535.02?"13+":m<535.07?15:m<535.11?16:m<535.19?17:m<536.05?18:m<536.1?19:m<537.01?20:m<537.11?"21+":m<537.13?23:m<537.18?24:m<537.24?25:m<537.36?26:"Blink"!=F?"27":"28")):(F&&(F[1]="like Safari"),m=(m=m[0])<400?1:m<500?2:m<526?3:m<533?4:m<534?"4+":m<535?5:m<537?6:m<538?7:m<601?8:"8"),F&&(F[1]+=" "+(m+="number"==typeof m?".x":/[.+]/.test(m)?"":"+")),"Safari"==j&&(!L||parseInt(L)>45)&&(L=m)),"Opera"==j&&(m=/\bzbov|zvav$/.exec(B))?(j+=" ",D.unshift("desktop mode"),"zvav"==m?(j+="Mini",L=null):j+="Mobile",B=B.replace(RegExp(" *"+m+"$"),"")):"Safari"==j&&/\bChrome\b/.exec(F&&F[1])&&(D.unshift("desktop mode"),j="Chrome Mobile",L=null,/\bOS X\b/.test(B)?(U="Apple",B="iOS 4.3+"):B=null),L&&0==L.indexOf(m=/[\d.]+$/.exec(B))&&i.indexOf("/"+m+"-")>-1&&(B=h(B.replace(m,""))),F&&!/\b(?:Avant|Nook)\b/.test(j)&&(/Browser|Lunascape|Maxthon/.test(j)||"Safari"!=j&&/^iOS/.test(B)&&/\bSafari\b/.test(F[1])||/^(?:Adobe|Arora|Breach|Midori|Opera|Phantom|Rekonq|Rock|Samsung Internet|Sleipnir|Web)/.test(j)&&F[1])&&(m=F[F.length-1])&&D.push(m),D.length&&(D=["("+D.join("; ")+")"]),U&&V&&V.indexOf(U)<0&&D.push("on "+U),V&&D.push((/^on /.test(D[D.length-1])?"":"on ")+V),B&&(m=/ ([\d.+]+)$/.exec(B),g=m&&"/"==B.charAt(B.length-m[0].length-1),B={architecture:32,family:m&&!g?B.replace(m[0],""):B,version:m?m[1]:null,toString:function(){var e=this.version;return this.family+(e&&!g?" "+e:"")+(64==this.architecture?" 64-bit":"")}}),(m=/\b(?:AMD|IA|Win|WOW|x86_|x)64\b/i.exec(x))&&!/\bi686\b/i.test(x)?(B&&(B.architecture=64,B.family=B.family.replace(RegExp(" *"+m),"")),j&&(/\bWOW64\b/i.test(i)||M&&/\w(?:86|32)$/.test(a.cpuClass||a.platform)&&!/\bWin64; x64\b/i.test(i))&&D.unshift("32-bit")):B&&/^OS X/.test(B.family)&&"Chrome"==j&&parseFloat(L)>=39&&(B.architecture=64),i||(i="");var H={};return H.description=i,H.layout=F&&F[0],H.manufacturer=U,H.name=j,H.prerelease=N,H.product=V,H.ua=i,H.version=j&&L,H.os=B||{architecture:null,family:null,version:null,toString:function(){return"null"}},H.parse=e,H.toString=function(){return this.description||""},H.version&&D.unshift(L),H.name&&D.unshift(j),B&&j&&(B!=String(B).split(" ")[0]||B!=j.split(" ")[0]&&!V)&&D.push(V?"("+B+")":"on "+B),D.length&&(H.description=D.join(" ")),H}()}();t.platform=i}).call(this,i(56))},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Device=void 0;const s=i(3),o=r(i(1)),n=r(i(0)),a=i(31),d=i(2);class c extends s.EventEmitter{constructor(){super(),this.deviceChangeDetectionTimer=null,this.deviceInited=!1,this.hasPerm={audioIn:!1,video:!1,audioOut:!1},this.deviceHistory={audioIn:[],video:[],audioOut:[]},this.userGestureUI=null,this.onUserGestureNeeded=null,this.logger=new a.Logger({tagGen:()=>`Device m${this.deviceHistory.audioIn.length}c${this.deviceHistory.video.length}s${this.deviceHistory.audioOut.length}`}),this.handleDeviceChange=this.detectDeviceChange.bind(this),this.onUserGestureNeeded=this.defaultHandleUserGestureNeeded.bind(this)}async getDevices(e){if(!navigator.mediaDevices)throw this.logger.error("navigator.mediaDevices is "+navigator.mediaDevices),new o.default({code:n.default.NOT_SUPPORT,message:"mediaDevices is not support in your browser",url:"https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/enumerateDevices"});if(!navigator.mediaDevices.enumerateDevices)throw this.logger.error("navigator.mediaDevices is "+navigator.mediaDevices.enumerateDevices),new o.default({code:n.default.NOT_SUPPORT,message:"enumerateDevices is not support in your browser",url:"https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/enumerateDevices"});let t={video:[],audioIn:[],audioOut:[]},i=await navigator.mediaDevices.enumerateDevices(),r=null;if(e.requestPerm){const t=i.find(t=>e.audioinput&&"audioinput"==t.kind&&!t.label),s=i.find(t=>e.videoinput&&"videoinput"==t.kind&&!t.label);if(t||s)try{r=await navigator.mediaDevices.getUserMedia({audio:t,video:s})}catch(e){this.logger.error(e.name,e.message,e.stack)}}return i=await navigator.mediaDevices.enumerateDevices(),i.forEach((function(i){if(e.videoinput&&"videoinput"===i.kind){let r={deviceId:i.deviceId,label:i.label||(e.noFillLabel?i.label:"camera "+(t.video.length+1))};e.groupId&&(r.groupId=i.groupId),t.video.push(r)}else if(e.audioinput&&"audioinput"===i.kind){let r={deviceId:i.deviceId,label:i.label||(e.noFillLabel?i.label:"microphone "+(t.audioIn.length+1))};e.groupId&&(r.groupId=i.groupId),t.audioIn.push(r)}else if(e.audiooutput&&"audiooutput"===i.kind){let r={deviceId:i.deviceId,label:i.label||(e.noFillLabel?i.label:"speaker "+(t.audioOut.length+1))};e.groupId&&(r.groupId=i.groupId),t.audioOut.push(r)}r&&r.getTracks().forEach(e=>{e.stop()})})),t}async getCameras(e){const t=await this.getDevices({videoinput:!0,requestPerm:e});return t?t.video:[]}async getMicrophones(e){const t=await this.getDevices({audioinput:!0,requestPerm:e});return t?t.audioIn:[]}async getSpeakers(e){const t=await this.getDevices({audioinput:!0,audiooutput:!0,requestPerm:e});return t?t.audioOut:[]}async detectDeviceChange(){let e={audioIn:{added:[],changed:[],removed:[]},video:{added:[],changed:[],removed:[]},audioOut:{added:[],changed:[],removed:[]}};const t=await this.getDevices({audioinput:!0,audiooutput:!0,videoinput:!0,requestPerm:!1,groupId:!0,noFillLabel:!0});["audioIn","video","audioOut"].forEach(i=>{if(this.deviceInited){const r=t[i].find(e=>e.deviceId&&e.label);r?this.hasPerm[i]?(t[i].forEach(t=>{const r=this.deviceHistory[i].find(e=>e.deviceId===t.deviceId||""===e.deviceId&&"default"===t.deviceId);if(r){if(r.label!==t.label||r.groupId!==t.groupId){let s=`检测到设备改变：${i}: deviceId ${t.deviceId}`;r.label!==t.label?s+=`【Label ${r.label} => ${t.label}】`:s+=" Label "+t.label,r.groupId!==t.groupId&&(s+="【groupId changed】"),this.logger.log(s),e[i].changed.push(t)}}else this.logger.log(`检测到设备新增：${i}: deviceId ${t.deviceId} 【${t.label}】`),e[i].added.push(t)}),this.deviceHistory[i].forEach(r=>{t[i].find(e=>r.deviceId===e.deviceId||""===r.deviceId&&"default"===e.deviceId)||(this.logger.log(`检测到设备拔出：${i}: deviceId ${r.deviceId} 【${r.label}】`),e[i].removed.push(r))}),this.deviceHistory[i]=t[i],e[i].added.forEach(e=>{"audioIn"===i?this.emit("recording-device-changed",{device:e,state:"ACTIVE"}):"video"===i?this.emit("camera-changed",{device:e,state:"ACTIVE"}):"audioOut"===i&&this.emit("playout-device-changed",{device:e,state:"ACTIVE"})}),e[i].changed.forEach(e=>{"audioIn"===i?this.emit("recording-device-changed",{device:e,state:"CHANGED"}):"video"===i?this.emit("camera-changed",{device:e,state:"CHANGED"}):"audioOut"===i&&this.emit("playout-device-changed",{device:e,state:"CHANGED"})}),e[i].removed.forEach(e=>{"audioIn"===i?this.emit("recording-device-changed",{device:e,state:"INACTIVE"}):"video"===i?this.emit("camera-changed",{device:e,state:"INACTIVE"}):"audioOut"===i&&this.emit("playout-device-changed",{device:e,state:"INACTIVE"})})):(this.hasPerm[i]=!0,this.deviceHistory[i]=t[i],"audioIn"===i?(this.logger.log(`麦克风设备：${r.deviceId}【${r.label}】`),this.emit("recording-device-init")):"video"===i?(this.logger.log(`摄像头设备：【${t[i].map(e=>e.label).join("】【")}】`),this.emit("camera-init")):"audioOut"===i&&(this.logger.log(`扬声器设备：${r.deviceId}【${r.label}】`),this.emit("playout-device-init"))):this.deviceHistory[i]=t[i]}else this.deviceHistory[i]=t[i]}),this.deviceInited||(this.deviceInited=!0,t.audioIn.length||this.logger.error("未侦测到可用麦克风"),t.video.length||this.logger.error("未侦测到可用摄像头"))}async startDeviceChangeDetection(){navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?(this.deviceChangeDetectionTimer&&clearInterval(this.deviceChangeDetectionTimer),await this.handleDeviceChange(),navigator.mediaDevices.ondevicechange?navigator.mediaDevices.ondevicechange===this.handleDeviceChange||(d.getParameters().forceListenDeviceChange?navigator.mediaDevices.ondevicechange=this.handleDeviceChange:this.logger.warn("系统设备枚举回调已被占用，设备枚举实效性将受到影响")):navigator.mediaDevices.ondevicechange=this.handleDeviceChange,this.deviceChangeDetectionTimer=setInterval(this.handleDeviceChange,1e3)):this.logger.warn("当前环境不支持设备枚举")}stopDeviceChangeDetection(){this.logger.log("停止监听浏览器设备变化"),this.deviceChangeDetectionTimer&&(clearInterval(this.deviceChangeDetectionTimer),this.deviceChangeDetectionTimer=null),navigator.mediaDevices&&navigator.mediaDevices.ondevicechange&&(navigator.mediaDevices.ondevicechange=null),this.deviceInited=!1,this.deviceHistory.audioIn=[],this.deviceHistory.audioOut=[],this.deviceHistory.video=[],this.hasPerm.audioIn=!1,this.hasPerm.video=!1,this.hasPerm.audioOut=!1}defaultHandleUserGestureNeeded(e){this.userGestureUI||(this.userGestureUI=document.createElement("div"),this.userGestureUI.style.fontSize="20px",this.userGestureUI.style.position="fixed",this.userGestureUI.style.background="yellow",this.userGestureUI.style.margin="auto",this.userGestureUI.style.width="100%",this.userGestureUI.style.zIndex="9999",this.userGestureUI.style.top="0",this.userGestureUI.onclick=()=>{var e;this.userGestureUI&&(null===(e=this.userGestureUI.parentNode)||void 0===e||e.removeChild(this.userGestureUI)),this.emit("user-gesture-fired")}),this.userGestureUI.style.display="block",this.userGestureUI.innerHTML=`由于浏览器限制，该操作需手势触发。<br/>点击此处以继续<br/>详细信息：${e.name}<br/>${e.message}`,document.body.appendChild(this.userGestureUI)}clean(){}}const l=new c;t.Device=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RtcSystem=void 0;const r={},s=(window.document.documentElement,window.navigator.userAgent.toLowerCase()),o=["googletv","viera","smarttv","internet.tv","netcast","nettv","appletv","boxee","kylo","roku","dlnadoc","pov_tv","hbbtv","ce-html"];function n(e,t){return-1!==e.indexOf(t)}function a(e){return n(s,e)}function d(e){for(let t=0;t<e.length;t++)if(r[e[t]]())return e[t];return"unknown"}function c(e,t,i){var r=e.match(t);return r&&r.length>=i&&parseInt(r[i],10)}r.macos=function(){return a("mac")},r.ios=function(){return r.iphone()||r.ipod()||r.ipad()},r.iphone=function(){return!r.windows()&&a("iphone")},r.ipod=function(){return a("ipod")},r.ipad=function(){return a("ipad")},r.android=function(){return!r.windows()&&a("android")},r.androidPhone=function(){return r.android()&&a("mobile")},r.androidTablet=function(){return r.android()&&!a("mobile")},r.blackberry=function(){return a("blackberry")||a("bb10")||a("rim")},r.blackberryPhone=function(){return r.blackberry()&&!a("tablet")},r.blackberryTablet=function(){return r.blackberry()&&a("tablet")},r.windows=function(){return a("windows")},r.windowsPhone=function(){return r.windows()&&a("phone")},r.windowsTablet=function(){return r.windows()&&a("touch")&&!r.windowsPhone()},r.fxos=function(){return(a("(mobile")||a("(tablet"))&&a(" rv:")},r.fxosPhone=function(){return r.fxos()&&a("mobile")},r.fxosTablet=function(){return r.fxos()&&a("tablet")},r.meego=function(){return a("meego")},r.cordova=function(){return window.cordova&&"file:"===location.protocol},r.nodeWebkit=function(){return"object"==typeof window.process},r.mobile=function(){return r.androidPhone()||r.iphone()||r.ipod()||r.windowsPhone()||r.blackberryPhone()||r.fxosPhone()||r.meego()},r.tablet=function(){return r.ipad()||r.androidTablet()||r.blackberryTablet()||r.windowsTablet()||r.fxosTablet()},r.weixin=function(){return a("micromessenger")},r.h5=function(){return r.tablet()||r.mobile()||r.weixin()},r.desktop=function(){return!r.tablet()&&!r.mobile()},r.television=function(){let e=0;for(;e<o.length;){if(a(o[e]))return!0;e++}return!1},r.portrait=function(){return screen.orientation&&Object.prototype.hasOwnProperty.call(window,"onorientationchange")?n(screen.orientation.type,"portrait"):window.innerHeight/window.innerWidth>1},r.landscape=function(){return screen.orientation&&Object.prototype.hasOwnProperty.call(window,"onorientationchange")?n(screen.orientation.type,"landscape"):window.innerHeight/window.innerWidth<1},r.type=d(["mobile","tablet","desktop"]),r.os=d(["ios","iphone","ipad","ipod","android","blackberry","macos","windows","fxos","meego","television"]),r.browser=function(){var e=window&&window.navigator,t={ua:null,version:null,UIVersion:null};if("undefined"==typeof window||!window.navigator)return t.ua="Not a browser.",t;if(e.mediaDevices&&e.userAgent.match(/Edge\/(\d+).(\d+)$/))t.ua="edge",t.version=c(e.userAgent,/Edge\/(\d+).(\d+)$/,2),t.UIVersion=e.userAgent.match(/Edge\/([\d.]+)/)[1];else if(e.mozGetUserMedia)t.ua="firefox",t.version=c(e.userAgent,/Firefox\/(\d+)\./,1),t.UIVersion=e.userAgent.match(/Firefox\/([\d.]+)/)[1];else if(e.webkitGetUserMedia&&window.webkitRTCPeerConnection)if(/micromessenger/.test(s))t.ua="weixin",t.version=c(e.userAgent,/Chrom(e|ium)\/(\d+)\./,2),t.UIVersion=e.userAgent.match(/Chrom(e|ium)\/([\d.]+)/)&&e.userAgent.match(/Chrom(e|ium)\/([\d.]+)/).length>1&&e.userAgent.match(/Chrom(e|ium)\/([\d.]+)/)[2];else if(e.userAgent.match(/(OPR|Opera).([\d.]+)/))t.ua="opera",t.version=c(e.userAgent,/O(PR|pera)\/(\d+)\./,2),t.UIVersion=e.userAgent.match(/O(PR|pera)\/([\d.]+)/)[2];else{if(!/Chrome/gi.test(e.userAgent))return t.ua="unknown",t;t.ua="chrome",t.version=c(e.userAgent,/Chrom(e|ium)\/(\d+)\./,2),t.UIVersion=e.userAgent.match(/Chrom(e|ium)\/([\d.]+)/)&&e.userAgent.match(/Chrom(e|ium)\/([\d.]+)/).length>1&&e.userAgent.match(/Chrom(e|ium)\/([\d.]+)/)[2]}else{if(!(!e.webkitGetUserMedia&&e.userAgent.match(/AppleWebKit\/([0-9]+)\./)||e.webkitGetUserMedia&&!e.webkitRTCPeerConnection))return t.ua="unknown",t;if(/micromessenger/.test(s))t.ua="weixin",t.version=c(s,/micromessenger\/(\d+)\./,2),t.UIVersion=7;else{if(!e.userAgent.match(/Version\/(\d+).(\d+)/))return t.ua="unknown",t;t.ua="safari",t.version=e.userAgent.match(/Version\/([\d]+)/)[1],t.UIVersion=e.userAgent.match(/Version\/([\d.]+)/)[1]}}return t}(),r.browser.greaterThanOrEqualToSafari_12_1_1=function(){if("safari"!==r.browser.ua||!r.browser.UIVersion)return!1;const e=r.browser.UIVersion.split(".");return 1===e.length?!(e[0]<12):2===e.length?e[0]>12||!(e[0]<12)&&!(e[1]<1):e[0]>12||(e[0]<12||!(e[1]<1)&&!(e[2]<1))},r.browser.lessThanSafari_13=function(){if("safari"!==r.browser.ua||!r.browser.UIVersion)return!0;const e=r.browser.UIVersion.split(".");return!(e.length<1)&&!(e[0]<13)},r.browser.lessThanSafari_12_1_1=function(){return!("safari"!==r.browser.ua||!r.browser.UIVersion)&&!r.browser.greaterThanOrEqualToSafari_12_1_1()},r.browser.safari_12_1=function(){if("safari"!==r.browser.ua||!r.browser.UIVersion)return!1;const e=r.browser.UIVersion.split(".");return 2==e.length&&(12==e[0]&&1==e[1])},r.browser.safari_12_0_1=function(){if("safari"!==r.browser.ua||!r.browser.UIVersion)return!1;const e=r.browser.UIVersion.split(".");return!(e.length<3)&&(12===e[0]&&(0===e[1]&&1===e[2]))},r.orientation=d(["portrait","landscape"]);const l=r;t.RtcSystem=l},function(e,t,i){var r=i(164),s=i(63);e.exports=function(e){return r(s(e))}},function(e,t,i){"use strict";e.exports=o,o.className="ReflectionObject";var r,s=i(4);function o(e,t){if(!s.isString(e))throw TypeError("name must be a string");if(t&&!s.isObject(t))throw TypeError("options must be an object");this.options=t,this.parsedOptions=null,this.name=e,this.parent=null,this.resolved=!1,this.comment=null,this.filename=null}Object.defineProperties(o.prototype,{root:{get:function(){for(var e=this;null!==e.parent;)e=e.parent;return e}},fullName:{get:function(){for(var e=[this.name],t=this.parent;t;)e.unshift(t.name),t=t.parent;return e.join(".")}}}),o.prototype.toJSON=function(){throw Error()},o.prototype.onAdd=function(e){this.parent&&this.parent!==e&&this.parent.remove(this),this.parent=e,this.resolved=!1;var t=e.root;t instanceof r&&t._handleAdd(this)},o.prototype.onRemove=function(e){var t=e.root;t instanceof r&&t._handleRemove(this),this.parent=null,this.resolved=!1},o.prototype.resolve=function(){return this.resolved||this.root instanceof r&&(this.resolved=!0),this},o.prototype.getOption=function(e){if(this.options)return this.options[e]},o.prototype.setOption=function(e,t,i){return i&&this.options&&void 0!==this.options[e]||((this.options||(this.options={}))[e]=t),this},o.prototype.setParsedOption=function(e,t,i){this.parsedOptions||(this.parsedOptions=[]);var r=this.parsedOptions;if(i){var o=r.find((function(t){return Object.prototype.hasOwnProperty.call(t,e)}));if(o){var n=o[e];s.setProperty(n,i,t)}else(o={})[e]=s.setProperty({},i,t),r.push(o)}else{var a={};a[e]=t,r.push(a)}return this},o.prototype.setOptions=function(e,t){if(e)for(var i=Object.keys(e),r=0;r<i.length;++r)this.setOption(i[r],e[i[r]],t);return this},o.prototype.toString=function(){var e=this.constructor.className,t=this.fullName;return t.length?e+" "+t:e},o._configure=function(e){r=e}},function(e,t,i){"use strict";var r=t,s=i(4),o=["double","float","int32","uint32","sint32","fixed32","sfixed32","int64","uint64","sint64","fixed64","sfixed64","bool","string","bytes"];function n(e,t){var i=0,r={};for(t|=0;i<e.length;)r[o[i+t]]=e[i++];return r}r.basic=n([1,5,0,0,0,5,5,0,0,0,1,1,0,2,2]),r.defaults=n([0,0,0,0,0,0,0,0,0,0,0,0,!1,"",s.emptyArray,null]),r.long=n([0,0,0,1,1],7),r.mapKey=n([0,0,0,5,5,0,0,0,1,1,0,2],2),r.packed=n([1,5,0,0,0,5,5,0,0,0,1,1,0])},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Logger=t.updateLogIndex=void 0;const r=i(25),s=i(149),o=i(2),n=i(24),a=i(43);let d=0;function c(){return d++,(""+d).padStart(4,"0")}t.updateLogIndex=c;class l{constructor(e){this.style="color:#1cb977;",this.options=e,this.api="log",this.tagGen=e.tagGen,e.isSavedLogs&&(this.logHelper=new s.logHelper(e)),this.supportedBrowsers=["Chrome","Safari","Firefox","Chrome Mobile","Electron"],this.cs=console}getChild(e){const t=Object.assign({},this.options),i=new l(t);return i.tagGen=e,i.parent=this,i}debug(){this.logHelper&&this.logHelper.log(arguments);var e=this.formatArgs("DEBUG",[].slice.call(arguments,0));o.getParameters().logLevel<=n.loglevels.DEBUG&&this._log("debug",e),window.logUpload&&window.wsTransport.sendLog(e)}log(){this.logHelper&&this.logHelper.log(arguments);var e=this.formatArgs("LOG",[].slice.call(arguments,0));if(-1!==this.supportedBrowsers.indexOf(r.platform.name)&&"string"==typeof e[0]){e[0]="%c"+e[0],e.splice(1,0,this.style);for(let t=2;t<e.length&&"string"==typeof e[t];t++)e[0]+="%c"+e[t],e[t]=""}o.getParameters().logLevel<=n.loglevels.INFO&&this._log("log",e),window.logUpload&&window.wsTransport.sendLog(e)}info(){this.logHelper&&this.logHelper.log(arguments);var e=this.formatArgs("INFO",[].slice.call(arguments,0));-1!==this.supportedBrowsers.indexOf(r.platform.name)&&"string"==typeof e[0]&&(e[0]="%c"+e[0],e.splice(1,0,this.style)),o.getParameters().logLevel<=n.loglevels.INFO&&this._log("info",e),window.logUpload&&window.wsTransport.sendLog(e)}warn(){this.logHelper&&this.logHelper.log(arguments);var e=this.formatArgs("WARN",[].slice.call(arguments,0));-1!==this.supportedBrowsers.indexOf(r.platform.name)&&"string"==typeof e[0]&&(e[0]="%c"+e[0],e.splice(1,0,this.style)),o.getParameters().logLevel<=n.loglevels.WARNING&&this._log("warn",e),window.logUpload&&window.wsTransport.sendLog(e)}error(){this.logHelper&&this.logHelper.log(arguments);var e=this.formatArgs("ERROR",[].slice.call(arguments,0));-1!==this.supportedBrowsers.indexOf(r.platform.name)&&"string"==typeof e[0]&&(e[0]="%c"+e[0],e.splice(1,0,this.style)),o.getParameters().logLevel<=n.loglevels.ERROR&&this._log("error",e),window.logUpload&&window.wsTransport.sendLog(e)}_log(e,t){let i=this.options.logFunc,r=null;if(i&&(i[e]&&(r=i[e]),"function"==typeof r))r.apply(i,t);else if(this.cs[e])try{this.cs[e].apply?this.chrome(e,t):this.ie(e,t)}catch(e){}}chrome(e,t){r.platform.name;this.cs[e]?this.cs[e].apply(this.cs,t):this.cs.log?this.cs.log.apply(this.cs,t):this.ie(e,t)}ie(e,t){var i=this;t.forEach((function(t){i.cs[e](JSON.stringify(t,null,4))}))}formatArgs(e,t){var i=new Date,r=u(""+(i.getMonth()+1))+"-"+u(""+i.getDate())+" "+u(""+i.getHours())+":"+u(""+i.getMinutes())+":"+u(""+i.getSeconds())+":"+u(""+i.getMilliseconds(),3);let s=this,o="";for(let e=0;e<3&&(s.tagGen&&(o=`[${s.tagGen()}]`+o),s.parent);e++)s=s.parent;return o=`[NERTC:${e}:${c()} ${r}]${o}`,t.splice(0,0,o),t.forEach((function(e,i){e=a.formatSingleArg(e),t[i]="object"==typeof e?function e(t,i=[]){if(!(t=a.formatSingleArg(t))||"object"!=typeof t)return t;let r={};for(let s in t)t.hasOwnProperty&&!t.hasOwnProperty(s)||(t[s]&&"object"==typeof t[s]?-1!==i.indexOf(t[s])?r[s]="[Circular obj]":(i.push(t[s]),r[s]=e(t[s],i)):r[s]=t[s]);return r}(e):e})),t}}t.Logger=l;var u=function(e,t){t=t||2;for(var i=""+e;i.length<t;)i="0"+i;return i}},function(e,t){e.exports=!0},function(e,t,i){var r=i(5),s=i(9),o=i(45),n=i(15),a=i(19),d=function(e,t,i){var c,l,u,p=e&d.F,h=e&d.G,f=e&d.S,m=e&d.P,g=e&d.B,v=e&d.W,y=h?s:s[t]||(s[t]={}),_=y.prototype,S=h?r:f?r[t]:(r[t]||{}).prototype;for(c in h&&(i=t),i)(l=!p&&S&&void 0!==S[c])&&a(y,c)||(u=l?S[c]:i[c],y[c]=h&&"function"!=typeof S[c]?i[c]:g&&l?o(u,r):v&&S[c]==u?function(e){var t=function(t,i,r){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,i)}return new e(t,i,r)}return e.apply(this,arguments)};return t.prototype=e.prototype,t}(u):m&&"function"==typeof u?o(Function.call,u):u,m&&((y.virtual||(y.virtual={}))[c]=u,e&d.R&&_&&!_[c]&&n(_,c,u)))};d.F=1,d.G=2,d.S=4,d.P=8,d.B=16,d.W=32,d.U=64,d.R=128,e.exports=d},function(e,t){e.exports={}},function(e,t){var i={}.toString;e.exports=function(e){return i.call(e).slice(8,-1)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EnhancedEventEmitter=void 0;const r=i(111),s=i(7),o="EnhancedEventEmitter";class n extends r.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}safeEmit(e,...t){const i=this.listenerCount(e);try{return this.emit(e,...t)}catch(t){return s.Logger.error(o,"safeEmit() | event listener threw an error [event:%s]:%o",e,t),Boolean(i)}}async safeEmitAsPromise(e,...t){return new Promise((i,r)=>{try{this.emit(e,...t,i,r)}catch(t){s.Logger.error(o,"safeEmitAsPromise() | event listener threw an error [event:%s]:%o",e,t),r(t)}})}}t.EnhancedEventEmitter=n},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidStateError=t.UnsupportedError=void 0;class r extends Error{constructor(e){super(e),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,r):this.stack=new Error(e).stack}}t.UnsupportedError=r;class s extends Error{constructor(e){super(e),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,s):this.stack=new Error(e).stack}}t.InvalidStateError=s},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.canReceive=t.canSend=t.generateProbatorRtpParameters=t.reduceCodecs=t.getSendingRemoteRtpParameters=t.getSendingRtpParameters=t.getRecvRtpCapabilities=t.getExtendedRtpCapabilities=t.validateSctpStreamParameters=t.validateSctpParameters=t.validateNumSctpStreams=t.validateSctpCapabilities=t.validateRtcpParameters=t.validateRtpEncodingParameters=t.validateRtpHeaderExtensionParameters=t.validateRtpCodecParameters=t.validateRtpParameters=t.validateRtpHeaderExtension=t.validateRtcpFeedback=t.validateRtpCodecCapability=t.validateRtpCapabilities=void 0;const n=o(i(206)),a=o(i(20));function d(e){const t=new RegExp("^(audio|video)/(.+)","i");if("object"!=typeof e)throw new TypeError("codec is not an object");if(!e.mimeType||"string"!=typeof e.mimeType)throw new TypeError("missing codec.mimeType");const i=t.exec(e.mimeType);if(!i)throw new TypeError("invalid codec.mimeType");if(e.kind=i[1].toLowerCase(),e.preferredPayloadType&&"number"!=typeof e.preferredPayloadType)throw new TypeError("invalid codec.preferredPayloadType");if("number"!=typeof e.clockRate)throw new TypeError("missing codec.clockRate");"audio"===e.kind?"number"!=typeof e.channels&&(e.channels=1):delete e.channels,e.parameters&&"object"==typeof e.parameters||(e.parameters={});for(const t of Object.keys(e.parameters)){let i=e.parameters[t];if(void 0===i&&(e.parameters[t]="",i=""),"string"!=typeof i&&"number"!=typeof i)throw new TypeError(`invalid codec parameter [key:${t}s, value:${i}]`);if("apt"===t&&"number"!=typeof i)throw new TypeError("invalid codec apt parameter")}e.rtcpFeedback&&Array.isArray(e.rtcpFeedback)||(e.rtcpFeedback=[]);for(const t of e.rtcpFeedback)c(t)}function c(e){if("object"!=typeof e)throw new TypeError("fb is not an object");if(!e.type||"string"!=typeof e.type)throw new TypeError("missing fb.type");e.parameter&&"string"==typeof e.parameter||(e.parameter="")}function l(e){if("object"!=typeof e)throw new TypeError("ext is not an object");if(e.kind&&"string"==typeof e.kind||(e.kind=""),""!==e.kind&&"audio"!==e.kind&&"video"!==e.kind)throw new TypeError("invalid ext.kind");if(!e.uri||"string"!=typeof e.uri)throw new TypeError("missing ext.uri");if("number"!=typeof e.preferredId)throw new TypeError("missing ext.preferredId");if(e.preferredEncrypt&&"boolean"!=typeof e.preferredEncrypt)throw new TypeError("invalid ext.preferredEncrypt");if(e.preferredEncrypt||(e.preferredEncrypt=!1),e.direction&&"string"!=typeof e.direction)throw new TypeError("invalid ext.direction");e.direction||(e.direction="sendrecv")}function u(e){if("object"!=typeof e)throw new TypeError("params is not an object");if(e.mid&&"string"!=typeof e.mid)throw new TypeError("params.mid is not a string");if(!Array.isArray(e.codecs))throw new TypeError("missing params.codecs");for(const t of e.codecs)p(t);if(e.headerExtensions&&!Array.isArray(e.headerExtensions))throw new TypeError("params.headerExtensions is not an array");e.headerExtensions||(e.headerExtensions=[]);for(const t of e.headerExtensions)h(t);if(e.encodings&&!Array.isArray(e.encodings))throw new TypeError("params.encodings is not an array");e.encodings||(e.encodings=[]);for(const t of e.encodings)f(t);if(e.rtcp&&"object"!=typeof e.rtcp)throw new TypeError("params.rtcp is not an object");e.rtcp||(e.rtcp={}),m(e.rtcp)}function p(e){const t=new RegExp("^(audio|video)/(.+)","i");if("object"!=typeof e)throw new TypeError("codec is not an object");if(!e.mimeType||"string"!=typeof e.mimeType)throw new TypeError("missing codec.mimeType");const i=t.exec(e.mimeType);if(!i)throw new TypeError("invalid codec.mimeType");if("number"!=typeof e.payloadType)throw new TypeError("missing codec.payloadType");if("number"!=typeof e.clockRate)throw new TypeError("missing codec.clockRate");"audio"===i[1].toLowerCase()?"number"!=typeof e.channels&&(e.channels=1):delete e.channels,e.parameters&&"object"==typeof e.parameters||(e.parameters={});for(const t of Object.keys(e.parameters)){let i=e.parameters[t];if(void 0===i&&(e.parameters[t]="",i=""),"string"!=typeof i&&"number"!=typeof i)throw new TypeError(`invalid codec parameter [key:${t}s, value:${i}]`);if("apt"===t&&"number"!=typeof i)throw new TypeError("invalid codec apt parameter")}e.rtcpFeedback&&Array.isArray(e.rtcpFeedback)||(e.rtcpFeedback=[]);for(const t of e.rtcpFeedback)c(t)}function h(e){if("object"!=typeof e)throw new TypeError("ext is not an object");if(!e.uri||"string"!=typeof e.uri)throw new TypeError("missing ext.uri");if("number"!=typeof e.id)throw new TypeError("missing ext.id");if(e.encrypt&&"boolean"!=typeof e.encrypt)throw new TypeError("invalid ext.encrypt");e.encrypt||(e.encrypt=!1),e.parameters&&"object"==typeof e.parameters||(e.parameters={});for(const t of Object.keys(e.parameters)){let i=e.parameters[t];if(void 0===i&&(e.parameters[t]="",i=""),"string"!=typeof i&&"number"!=typeof i)throw new TypeError("invalid header extension parameter")}}function f(e){if("object"!=typeof e)throw new TypeError("encoding is not an object");if(e.ssrc&&"number"!=typeof e.ssrc)throw new TypeError("invalid encoding.ssrc");if(e.rid&&"string"!=typeof e.rid)throw new TypeError("invalid encoding.rid");if(e.rtx&&"object"!=typeof e.rtx)throw new TypeError("invalid encoding.rtx");if(e.rtx&&"number"!=typeof e.rtx.ssrc)throw new TypeError("missing encoding.rtx.ssrc");if(e.dtx&&"boolean"==typeof e.dtx||(e.dtx=!1),e.scalabilityMode&&"string"!=typeof e.scalabilityMode)throw new TypeError("invalid encoding.scalabilityMode")}function m(e){if("object"!=typeof e)throw new TypeError("rtcp is not an object");if(e.cname&&"string"!=typeof e.cname)throw new TypeError("invalid rtcp.cname");e.reducedSize&&"boolean"==typeof e.reducedSize||(e.reducedSize=!0)}function g(e){if("object"!=typeof e)throw new TypeError("numStreams is not an object");if("number"!=typeof e.OS)throw new TypeError("missing numStreams.OS");if("number"!=typeof e.MIS)throw new TypeError("missing numStreams.MIS")}function v(e){return!!e&&/.+\/rtx$/i.test(e.mimeType)}function y(e,t,{strict:i=!1,modify:r=!1}={}){const s=e.mimeType.toLowerCase();if(s!==t.mimeType.toLowerCase())return!1;if(e.clockRate!==t.clockRate)return!1;if(e.channels!==t.channels)return!1;switch(s){case"video/h264":if((e.parameters["packetization-mode"]||0)!==(t.parameters["packetization-mode"]||0))return!1;if(i){if(!n.isSameProfile(e.parameters,t.parameters))return!1;let i;try{i=n.generateProfileLevelIdForAnswer(e.parameters,t.parameters)}catch(e){return!1}r&&(i?e.parameters["profile-level-id"]=i:delete e.parameters["profile-level-id"])}break;case"video/vp9":if(i){if((e.parameters["profile-id"]||0)!==(t.parameters["profile-id"]||0))return!1}}return!0}function _(e,t){return(!e.kind||!t.kind||e.kind===t.kind)&&e.uri===t.uri}function S(e,t){const i=[];for(const r of e.rtcpFeedback||[]){const e=(t.rtcpFeedback||[]).find(e=>e.type===r.type&&(e.parameter===r.parameter||!e.parameter&&!r.parameter));e&&i.push(e)}return i}t.validateRtpCapabilities=function(e){if("object"!=typeof e)throw new TypeError("caps is not an object");if(e.codecs&&!Array.isArray(e.codecs))throw new TypeError("caps.codecs is not an array");e.codecs||(e.codecs=[]);for(const t of e.codecs)d(t);if(e.headerExtensions&&!Array.isArray(e.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");e.headerExtensions||(e.headerExtensions=[]);for(const t of e.headerExtensions)l(t)},t.validateRtpCodecCapability=d,t.validateRtcpFeedback=c,t.validateRtpHeaderExtension=l,t.validateRtpParameters=u,t.validateRtpCodecParameters=p,t.validateRtpHeaderExtensionParameters=h,t.validateRtpEncodingParameters=f,t.validateRtcpParameters=m,t.validateSctpCapabilities=function(e){if("object"!=typeof e)throw new TypeError("caps is not an object");if(!e.numStreams||"object"!=typeof e.numStreams)throw new TypeError("missing caps.numStreams");g(e.numStreams)},t.validateNumSctpStreams=g,t.validateSctpParameters=function(e){if("object"!=typeof e)throw new TypeError("params is not an object");if("number"!=typeof e.port)throw new TypeError("missing params.port");if("number"!=typeof e.OS)throw new TypeError("missing params.OS");if("number"!=typeof e.MIS)throw new TypeError("missing params.MIS");if("number"!=typeof e.maxMessageSize)throw new TypeError("missing params.maxMessageSize")},t.validateSctpStreamParameters=function(e){if("object"!=typeof e)throw new TypeError("params is not an object");if("number"!=typeof e.streamId)throw new TypeError("missing params.streamId");let t=!1;if("boolean"==typeof e.ordered?t=!0:e.ordered=!0,e.maxPacketLifeTime&&"number"!=typeof e.maxPacketLifeTime)throw new TypeError("invalid params.maxPacketLifeTime");if(e.maxRetransmits&&"number"!=typeof e.maxRetransmits)throw new TypeError("invalid params.maxRetransmits");if(e.maxPacketLifeTime&&e.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(t&&e.ordered&&(e.maxPacketLifeTime||e.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(t||!e.maxPacketLifeTime&&!e.maxRetransmits||(e.ordered=!1),e.label&&"string"!=typeof e.label)throw new TypeError("invalid params.label");if(e.protocol&&"string"!=typeof e.protocol)throw new TypeError("invalid params.protocol")},t.getExtendedRtpCapabilities=function(e,t){const i={codecs:[],headerExtensions:[]};for(const r of t.codecs||[]){if(v(r))continue;const t=(e.codecs||[]).find(e=>y(e,r,{strict:!0,modify:!0}));if(!t)continue;const s={mimeType:t.mimeType,kind:t.kind,clockRate:t.clockRate,channels:t.channels,localPayloadType:t.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:r.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:t.parameters,remoteParameters:r.parameters,rtcpFeedback:S(t,r)};i.codecs.push(s)}for(const r of i.codecs){const i=e.codecs.find(e=>v(e)&&e.parameters.apt===r.localPayloadType),s=t.codecs.find(e=>v(e)&&e.parameters.apt===r.remotePayloadType);i&&s&&(r.localRtxPayloadType=i.preferredPayloadType,r.remoteRtxPayloadType=s.preferredPayloadType)}for(const r of t.headerExtensions){const t=e.headerExtensions.find(e=>_(e,r));if(!t)continue;const s={kind:r.kind,uri:r.uri,sendId:t.preferredId,recvId:r.preferredId,encrypt:t.preferredEncrypt,direction:"sendrecv"};switch(r.direction){case"sendrecv":s.direction="sendrecv";break;case"recvonly":s.direction="sendonly";break;case"sendonly":s.direction="recvonly";break;case"inactive":s.direction="inactive"}i.headerExtensions.push(s)}return i},t.getRecvRtpCapabilities=function(e){const t={codecs:[],headerExtensions:[]};for(const i of e.codecs){const e={mimeType:i.mimeType,kind:i.kind,preferredPayloadType:i.localPayloadType,clockRate:i.clockRate,channels:i.channels,parameters:i.localParameters,rtcpFeedback:i.rtcpFeedback};if(t.codecs.push(e),!i.localRtxPayloadType)continue;const r={mimeType:i.kind+"/rtx",kind:i.kind,preferredPayloadType:i.localRtxPayloadType,clockRate:i.clockRate,parameters:{apt:i.localPayloadType},rtcpFeedback:[]};t.codecs.push(r)}for(const i of e.headerExtensions){if("sendrecv"!==i.direction&&"recvonly"!==i.direction)continue;const e={kind:i.kind,uri:i.uri,preferredId:i.sendId,preferredEncrypt:i.encrypt,direction:i.direction};t.headerExtensions.push(e)}return t},t.getSendingRtpParameters=function(e,t){const i={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const r of t.codecs){if(r.kind!==e)continue;const t={mimeType:r.mimeType,payloadType:r.localPayloadType,clockRate:r.clockRate,channels:r.channels,parameters:r.localParameters,rtcpFeedback:r.rtcpFeedback};if(i.codecs.push(t),r.localRtxPayloadType){const e={mimeType:r.kind+"/rtx",payloadType:r.localRtxPayloadType,clockRate:r.clockRate,parameters:{apt:r.localPayloadType},rtcpFeedback:[]};i.codecs.push(e)}}for(const r of t.headerExtensions){if(r.kind&&r.kind!==e||"sendrecv"!==r.direction&&"sendonly"!==r.direction)continue;const t={uri:r.uri,id:r.sendId,encrypt:r.encrypt,parameters:{}};i.headerExtensions.push(t)}return i},t.getSendingRemoteRtpParameters=function(e,t){const i={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const r of t.codecs){if(r.kind!==e)continue;const t={mimeType:r.mimeType,payloadType:r.localPayloadType,clockRate:r.clockRate,channels:r.channels,parameters:r.remoteParameters,rtcpFeedback:r.rtcpFeedback};if(i.codecs.push(t),r.localRtxPayloadType){const e={mimeType:r.kind+"/rtx",payloadType:r.localRtxPayloadType,clockRate:r.clockRate,parameters:{apt:r.localPayloadType},rtcpFeedback:[]};i.codecs.push(e)}}for(const r of t.headerExtensions){if(r.kind&&r.kind!==e||"sendrecv"!==r.direction&&"sendonly"!==r.direction)continue;const t={uri:r.uri,id:r.sendId,encrypt:r.encrypt,parameters:{}};i.headerExtensions.push(t)}if(i.headerExtensions.some(e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.uri))for(const e of i.codecs)e.rtcpFeedback=(e.rtcpFeedback||[]).filter(e=>"goog-remb"!==e.type);else if(i.headerExtensions.some(e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.uri))for(const e of i.codecs)e.rtcpFeedback=(e.rtcpFeedback||[]).filter(e=>"transport-cc"!==e.type);else for(const e of i.codecs)e.rtcpFeedback=(e.rtcpFeedback||[]).filter(e=>"transport-cc"!==e.type&&"goog-remb"!==e.type);return i},t.reduceCodecs=function(e,t){const i=[];if(t){for(let r=0;r<e.length;++r)if(y(e[r],t)){i.push(e[r]),v(e[r+1])&&i.push(e[r+1]);break}if(0===i.length)throw new TypeError("no matching codec found")}else i.push(e[0]),v(e[1])&&i.push(e[1]);return i},t.generateProbatorRtpParameters=function(e,t){u(e=a.clone(e,{}));const i={mid:"probator",codecs:[],headerExtensions:[],encodings:[{ssrc:t}],rtcp:{cname:"probator"}};return i.codecs.push(e.codecs[0]),i.codecs[0].payloadType=127,i.headerExtensions=e.headerExtensions,i},t.canSend=function(e,t){return t.codecs.some(t=>t.kind===e)},t.canReceive=function(e,t){if(u(e),0===e.codecs.length)return!1;for(let i in e.codecs)if("video/rtx"!==e.codecs[i].mimeType)for(let r in t.codecs)if(t.codecs[r].localPayloadType===e.codecs[i].payloadType)return!0;return!1}},function(e,t,i){var r=i(209),s=i(210);t.write=s,t.parse=r.parse,t.parseParams=r.parseParams,t.parseFmtpConfig=r.parseFmtpConfig,t.parsePayloads=r.parsePayloads,t.parseRemoteCandidates=r.parseRemoteCandidates,t.parseImageAttributes=r.parseImageAttributes,t.parseSimulcastStreamList=r.parseSimulcastStreamList},function(e,t,i){"use strict";e.exports=u;var r=i(29);((u.prototype=Object.create(r.prototype)).constructor=u).className="Namespace";var s,o,n,a=i(21),d=i(41),c=i(4);function l(e,t){if(e&&e.length){for(var i={},r=0;r<e.length;++r)i[e[r].name]=e[r].toJSON(t);return i}}function u(e,t){r.call(this,e,t),this.nested=void 0,this._nestedArray=null}function p(e){return e._nestedArray=null,e}u.fromJSON=function(e,t){return new u(e,t.options).addJSON(t.nested)},u.arrayToJSON=l,u.isReservedId=function(e,t){if(e)for(var i=0;i<e.length;++i)if("string"!=typeof e[i]&&e[i][0]<=t&&e[i][1]>t)return!0;return!1},u.isReservedName=function(e,t){if(e)for(var i=0;i<e.length;++i)if(e[i]===t)return!0;return!1},Object.defineProperty(u.prototype,"nestedArray",{get:function(){return this._nestedArray||(this._nestedArray=c.toArray(this.nested))}}),u.prototype.toJSON=function(e){return c.toObject(["options",this.options,"nested",l(this.nestedArray,e)])},u.prototype.addJSON=function(e){if(e)for(var t,i=Object.keys(e),r=0;r<i.length;++r)t=e[i[r]],this.add((void 0!==t.fields?s.fromJSON:void 0!==t.values?n.fromJSON:void 0!==t.methods?o.fromJSON:void 0!==t.id?a.fromJSON:u.fromJSON)(i[r],t));return this},u.prototype.get=function(e){return this.nested&&this.nested[e]||null},u.prototype.getEnum=function(e){if(this.nested&&this.nested[e]instanceof n)return this.nested[e].values;throw Error("no such enum: "+e)},u.prototype.add=function(e){if(!(e instanceof a&&void 0!==e.extend||e instanceof s||e instanceof n||e instanceof o||e instanceof u||e instanceof d))throw TypeError("object must be a valid nested object");if(this.nested){var t=this.get(e.name);if(t){if(!(t instanceof u&&e instanceof u)||t instanceof s||t instanceof o)throw Error("duplicate name '"+e.name+"' in "+this);for(var i=t.nestedArray,r=0;r<i.length;++r)e.add(i[r]);this.remove(t),this.nested||(this.nested={}),e.setOptions(t.options,!0)}}else this.nested={};return this.nested[e.name]=e,e.onAdd(this),p(this)},u.prototype.remove=function(e){if(!(e instanceof r))throw TypeError("object must be a ReflectionObject");if(e.parent!==this)throw Error(e+" is not a member of "+this);return delete this.nested[e.name],Object.keys(this.nested).length||(this.nested=void 0),e.onRemove(this),p(this)},u.prototype.define=function(e,t){if(c.isString(e))e=e.split(".");else if(!Array.isArray(e))throw TypeError("illegal path");if(e&&e.length&&""===e[0])throw Error("path must be relative");for(var i=this;e.length>0;){var r=e.shift();if(i.nested&&i.nested[r]){if(!((i=i.nested[r])instanceof u))throw Error("path conflicts with non-namespace objects")}else i.add(i=new u(r))}return t&&i.addJSON(t),i},u.prototype.resolveAll=function(){for(var e=this.nestedArray,t=0;t<e.length;)e[t]instanceof u?e[t++].resolveAll():e[t++].resolve();return this.resolve()},u.prototype.lookup=function(e,t,i){if("boolean"==typeof t?(i=t,t=void 0):t&&!Array.isArray(t)&&(t=[t]),c.isString(e)&&e.length){if("."===e)return this.root;e=e.split(".")}else if(!e.length)return this;if(""===e[0])return this.root.lookup(e.slice(1),t);var r=this.get(e[0]);if(r){if(1===e.length){if(!t||t.indexOf(r.constructor)>-1)return r}else if(r instanceof u&&(r=r.lookup(e.slice(1),t,!0)))return r}else for(var s=0;s<this.nestedArray.length;++s)if(this._nestedArray[s]instanceof u&&(r=this._nestedArray[s].lookup(e,t,!0)))return r;return null===this.parent||i?null:this.parent.lookup(e,t)},u.prototype.lookupType=function(e){var t=this.lookup(e,[s]);if(!t)throw Error("no such type: "+e);return t},u.prototype.lookupEnum=function(e){var t=this.lookup(e,[n]);if(!t)throw Error("no such Enum '"+e+"' in "+this);return t},u.prototype.lookupTypeOrEnum=function(e){var t=this.lookup(e,[s,n]);if(!t)throw Error("no such Type or Enum '"+e+"' in "+this);return t},u.prototype.lookupService=function(e){var t=this.lookup(e,[o]);if(!t)throw Error("no such Service '"+e+"' in "+this);return t},u._configure=function(e,t,i){s=e,o=t,n=i}},function(e,t,i){"use strict";e.exports=n;var r=i(29);((n.prototype=Object.create(r.prototype)).constructor=n).className="OneOf";var s=i(21),o=i(4);function n(e,t,i,s){if(Array.isArray(t)||(i=t,t=void 0),r.call(this,e,i),void 0!==t&&!Array.isArray(t))throw TypeError("fieldNames must be an Array");this.oneof=t||[],this.fieldsArray=[],this.comment=s}function a(e){if(e.parent)for(var t=0;t<e.fieldsArray.length;++t)e.fieldsArray[t].parent||e.parent.add(e.fieldsArray[t])}n.fromJSON=function(e,t){return new n(e,t.oneof,t.options,t.comment)},n.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return o.toObject(["options",this.options,"oneof",this.oneof,"comment",t?this.comment:void 0])},n.prototype.add=function(e){if(!(e instanceof s))throw TypeError("field must be a Field");return e.parent&&e.parent!==this.parent&&e.parent.remove(e),this.oneof.push(e.name),this.fieldsArray.push(e),e.partOf=this,a(this),this},n.prototype.remove=function(e){if(!(e instanceof s))throw TypeError("field must be a Field");var t=this.fieldsArray.indexOf(e);if(t<0)throw Error(e+" is not a member of "+this);return this.fieldsArray.splice(t,1),(t=this.oneof.indexOf(e.name))>-1&&this.oneof.splice(t,1),e.partOf=null,this},n.prototype.onAdd=function(e){r.prototype.onAdd.call(this,e);for(var t=0;t<this.oneof.length;++t){var i=e.get(this.oneof[t]);i&&!i.partOf&&(i.partOf=this,this.fieldsArray.push(i))}a(this)},n.prototype.onRemove=function(e){for(var t,i=0;i<this.fieldsArray.length;++i)(t=this.fieldsArray[i]).parent&&t.parent.remove(t);r.prototype.onRemove.call(this,e)},n.d=function(){for(var e=new Array(arguments.length),t=0;t<arguments.length;)e[t]=arguments[t++];return function(t,i){o.decorateType(t.constructor).add(new n(i,e)),Object.defineProperty(t,i,{get:o.oneOfGetter(e),set:o.oneOfSetter(e)})}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.STREAM_TYPE=t.NERTC_VIDEO_QUALITY_REV=t.NERTC_VIDEO_QUALITY=t.VIDEO_FRAME_RATE=void 0,t.VIDEO_FRAME_RATE={CHAT_VIDEO_FRAME_RATE_NORMAL:0,CHAT_VIDEO_FRAME_RATE_5:1,CHAT_VIDEO_FRAME_RATE_10:2,CHAT_VIDEO_FRAME_RATE_15:3,CHAT_VIDEO_FRAME_RATE_20:4,CHAT_VIDEO_FRAME_RATE_25:5},t.NERTC_VIDEO_QUALITY={VIDEO_QUALITY_180p:2,VIDEO_QUALITY_480p:4,VIDEO_QUALITY_720p:8,VIDEO_QUALITY_1080p:16},t.NERTC_VIDEO_QUALITY_REV={[t.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_180p]:"320x180",[t.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p]:"640x480",[t.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_720p]:"1280x720",[t.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p]:"1920x1080"},t.STREAM_TYPE={HIGH:0,LOW:1}},function(e,t,i){"use strict";function r(e){if(e instanceof RTCRtpSender){return`[RTCRtpSender track: ${r(e.track)}]`}if(e instanceof MediaStreamTrack){const t=e;return`[MediaStreamTrack kind:${t.kind} label:${t.label} readyState:${t.readyState} id: ${t.id} enabled:${t.enabled} muted: ${t.muted}]`}if(e instanceof HTMLElement){const t=e;return`[${t.tagName}.${t.className} ${t.clientWidth}x${t.clientHeight}]`}if(e instanceof MediaStream){const t=e;return`[MediaStream active:${t.active} a:${t.getAudioTracks().length} v:${t.getVideoTracks().length}]`}return e}Object.defineProperty(t,"__esModule",{value:!0}),t.getDomInfo=t.makePrintable=t.formatSingleArg=t.deepCopy=void 0,t.deepCopy=function e(t){var i=Array.isArray(t)?[]:{};for(var r in t)t.hasOwnProperty(r)&&("object"==typeof t[r]&&null!==t[r]?i[r]=e(t[r]):i[r]=t[r]);return i},t.formatSingleArg=r,t.makePrintable=function e(t,i,s=[]){if("object"!=typeof t||!(null==t?void 0:t.hasOwnProperty))return t;var o=Array.isArray(t)?[]:{};for(var n in t)if(t.hasOwnProperty(n)){const a=r(t[n]);a&&("client"===n&&a.adapterRef||["adapterRef","sdkRef","logger","_events"].indexOf(n)>-1||(a&&"object"==typeof a?s.indexOf(a)>-1?o[n]="[Circular obj]":(s.push(o[n]),i>=1?o[n]=e(a,i-1,s):(null==a?void 0:a.toString)?o[n]=a.toString():o[n]=typeof a):o[n]=a))}return o},t.getDomInfo=function(e){if(!e)return""+e;let t=e.tagName;return e.id&&(t+="#"+e.id),e.className&&(t+="."+e.className),(e.offsetWidth||e.offsetHeight)&&(t+=` ${e.offsetWidth}x${e.offsetHeight}`),t}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getScreenStream=t.getStream=t.emptyStreamWith=t.watchTrack=void 0;const r=i(2),s=i(31),o=i(26),n=i(150),a=i(57),d=new s.Logger({tagGen:()=>"GUM"});function c(e){if(e)if("ended"===e.readyState&&d.error("注意：输入的track已经停止：",e),"audio"===e.kind){const t=r.getParameters().tracks.audio;d.log("获取到的设备类型: AUDIOTRACK#"+t.length,e.kind,e.label,e.id,JSON.stringify(e.getSettings()));const i=t.findIndex(t=>e===t);i>-1?(d.warn(`注意：AUDIOTRACK#${t.length} 与 AUDIOTRACK#${i} 相同`),t.push(null)):t.push(e)}else{const t=r.getParameters().tracks.video;d.log("获取到的设备类型: VIDEOTRACK#"+t.length,e.kind,e.label,e.id,JSON.stringify(e.getSettings()));const i=t.findIndex(t=>e===t);i>-1?(d.warn(`注意：AUDIOTRACK#${t.length} 与 VIDEOTRACK#${i} 相同`),t.push(null)):t.push(e)}}t.getStream=async function(e,t){t.log("getLocalStream constraint:",JSON.stringify(e));try{const i=await navigator.mediaDevices.getUserMedia(e);t.log("获取到媒体流: ",i.id);return i.getTracks().forEach(e=>{if(c(e),"video"===e.kind){if(e.contentHint=r.getParameters().contentHint.video,n.canShimCanvas()){t.warn("使用canvas track取代videoTrack",e.label);const r=n.shimCanvas(e);c(r),i.removeTrack(e),i.addTrack(r)}if("boolean"==typeof window.setEffect&&window.setEffect){let t=a.transformTrack(e);i.removeTrack(e),i.addTrack(t)}}}),i}catch(e){return t.error("媒体设备获取失败: ",e.name,e.message),Promise.reject(e)}},t.getScreenStream=async function(e,t){var i;let s;t.log("getScreenStream constraint:",JSON.stringify(e,null," ")),navigator.getDisplayMedia||navigator.mediaDevices.getDisplayMedia;try{s=await navigator.mediaDevices.getDisplayMedia(e)}catch(r){if(!((null===(i=null==r?void 0:r.message)||void 0===i?void 0:i.indexOf("user gesture"))>-1&&o.Device.onUserGestureNeeded))throw t.error("屏幕共享获取失败: ",r.name,r.message),r;t.warn("荧幕共享获取中断，需要手势触发。"),o.Device.onUserGestureNeeded(r);try{s=await new Promise((t,i)=>{o.Device.once("user-gesture-fired",()=>{navigator.mediaDevices.getDisplayMedia(e).then(t).catch(i)})})}catch(e){throw t.error("第二次屏幕共享获取失败: ",e.name,e.message),e}}return(e=>{t.log("获取到屏幕共享流: ",e.id);e.getTracks().forEach(e=>{c(e),"video"===e.kind&&(e.contentHint=r.getParameters().contentHint.screen,r.getParameters().screenFocus&&(e.focus?(t.log("屏幕共享不跳转到被共享页面"),e.focus("no-focus-change")):t.warn("当前浏览器不支持屏幕共享跳转控制")))}),Promise.resolve(e)})(s),s},t.watchTrack=c,t.emptyStreamWith=function(e,t){let i=!1;e.getTracks().forEach(r=>{r!==t?e.removeTrack(r):i=!0}),!i&&t&&e.addTrack(t)}},function(e,t,i){var r=i(46);e.exports=function(e,t,i){if(r(e),void 0===t)return e;switch(i){case 1:return function(i){return e.call(t,i)};case 2:return function(i,r){return e.call(t,i,r)};case 3:return function(i,r,s){return e.call(t,i,r,s)}}return function(){return e.apply(t,arguments)}}},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t){e.exports=function(e){try{return!!e()}catch(e){return!0}}},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t){var i=0,r=Math.random();e.exports=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++i+r).toString(36))}},function(e,t,i){var r=i(16).f,s=i(19),o=i(6)("toStringTag");e.exports=function(e,t,i){e&&!s(e=i?e:e.prototype,o)&&r(e,o,{configurable:!0,value:t})}},function(e,t,i){"use strict";var r=i(2),s=i(24),o=i(31);i(108);e.exports=class{constructor(e){this.formatTimeUnit=function(e,t){t=t||2;for(var i=""+e;i.length<t;)i="0"+i;return i},this.prefix=e?"protoo-client:"+e:"protoo-client"}debug(){var e=Array.prototype.slice.call(arguments);this.formatArgs(e),(0,r.getParameters)().logLevel<=s.loglevels.DEBUG&&console.debug.apply(console,e),window.logUpload&&window.wsTransport&&window.wsTransport.sendLog(e)}warn(){var e=Array.prototype.slice.call(arguments);this.formatArgs(e),(0,r.getParameters)().logLevel<=s.loglevels.WARNING&&console.warn.apply(console,e),window.logUpload&&window.wsTransport&&window.wsTransport.sendLog(e)}error(){var e=Array.prototype.slice.call(arguments);this.formatArgs(e),(0,r.getParameters)().logLevel<=s.loglevels.ERROR&&console.error.apply(console,e),window.logUpload&&window.wsTransport&&window.wsTransport.sendLog(e)}formatArgs(e){var t=new Date,i=this.formatTimeUnit(""+(t.getMonth()+1))+"-"+this.formatTimeUnit(""+t.getDate())+" "+this.formatTimeUnit(""+t.getHours())+":"+this.formatTimeUnit(""+t.getMinutes())+":"+this.formatTimeUnit(""+t.getSeconds())+":"+this.formatTimeUnit(""+t.getMilliseconds(),3),r="[NERTC:LOG:"+(0,o.updateLogIndex)()+" "+i+" "+this.prefix.toUpperCase()+"]";return e.unshift(r),e}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HandlerInterface=void 0;const r=i(36);class s extends r.EnhancedEventEmitter{constructor(){super()}}t.HandlerInterface=s},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ajax=void 0;const s=r(i(1)),o=r(i(0));var n=i(54);t.ajax=function(e){if(!e||!e.url)return Promise.reject(new s.default({code:o.default.INVALID_PARAMETER,message:"could not send request due to invalid parameter"}));e.dataType=e.dataType||"json";var t=new XMLHttpRequest;t.open(e.type||"GET",e.url,!0),t.responseType=""+e.dataType;const i=e.contentType||"application/json;charset=UTF-8";return t.setRequestHeader("Content-type",i),e.header&&Object.keys(e.header).map(i=>{e.header&&e.header[i]&&t.setRequestHeader(i,e.header[i])}),new Promise((r,a)=>{var d;t.onload=function(){if(t.status>400)return Promise.reject(new s.default({code:o.default.INVALID_PARAMETER,message:"could not send request due to invalid parameter"}));var e=t.response;r(e)},t.onerror=function(e){a(e)},i.indexOf("x-www-form-urlencoded")>=0?e.data?t.send((d=e.data,Object.keys(d).map(e=>encodeURIComponent(e)+"="+encodeURIComponent(/Object/i.test(d[e])?JSON.stringify(d[e]):d[e])).join("&"))):t.send():e.data?e.header&&"gzip"===e.header["Content-Encoding"]?t.send(e.data):t.send(n.stringify(e.data)):t.send()})}},function(e,t,i){var r=i(139).stringify,s=i(140);e.exports=function(e){return{parse:s(e),stringify:r}},e.exports.parse=s(),e.exports.stringify=r},function(e,t,i){var r,s,o,n,a;r=i(142),s=i(85).utf8,o=i(143),n=i(85).bin,(a=function(e,t){e.constructor==String?e=t&&"binary"===t.encoding?n.stringToBytes(e):s.stringToBytes(e):o(e)?e=Array.prototype.slice.call(e,0):Array.isArray(e)||e.constructor===Uint8Array||(e=e.toString());for(var i=r.bytesToWords(e),d=8*e.length,c=1732584193,l=-271733879,u=-1732584194,p=271733878,h=0;h<i.length;h++)i[h]=16711935&(i[h]<<8|i[h]>>>24)|4278255360&(i[h]<<24|i[h]>>>8);i[d>>>5]|=128<<d%32,i[14+(d+64>>>9<<4)]=d;var f=a._ff,m=a._gg,g=a._hh,v=a._ii;for(h=0;h<i.length;h+=16){var y=c,_=l,S=u,b=p;c=f(c,l,u,p,i[h+0],7,-680876936),p=f(p,c,l,u,i[h+1],12,-389564586),u=f(u,p,c,l,i[h+2],17,606105819),l=f(l,u,p,c,i[h+3],22,-1044525330),c=f(c,l,u,p,i[h+4],7,-176418897),p=f(p,c,l,u,i[h+5],12,1200080426),u=f(u,p,c,l,i[h+6],17,-1473231341),l=f(l,u,p,c,i[h+7],22,-45705983),c=f(c,l,u,p,i[h+8],7,1770035416),p=f(p,c,l,u,i[h+9],12,-1958414417),u=f(u,p,c,l,i[h+10],17,-42063),l=f(l,u,p,c,i[h+11],22,-1990404162),c=f(c,l,u,p,i[h+12],7,1804603682),p=f(p,c,l,u,i[h+13],12,-40341101),u=f(u,p,c,l,i[h+14],17,-1502002290),c=m(c,l=f(l,u,p,c,i[h+15],22,1236535329),u,p,i[h+1],5,-165796510),p=m(p,c,l,u,i[h+6],9,-1069501632),u=m(u,p,c,l,i[h+11],14,643717713),l=m(l,u,p,c,i[h+0],20,-373897302),c=m(c,l,u,p,i[h+5],5,-701558691),p=m(p,c,l,u,i[h+10],9,38016083),u=m(u,p,c,l,i[h+15],14,-660478335),l=m(l,u,p,c,i[h+4],20,-405537848),c=m(c,l,u,p,i[h+9],5,568446438),p=m(p,c,l,u,i[h+14],9,-1019803690),u=m(u,p,c,l,i[h+3],14,-187363961),l=m(l,u,p,c,i[h+8],20,1163531501),c=m(c,l,u,p,i[h+13],5,-1444681467),p=m(p,c,l,u,i[h+2],9,-51403784),u=m(u,p,c,l,i[h+7],14,1735328473),c=g(c,l=m(l,u,p,c,i[h+12],20,-1926607734),u,p,i[h+5],4,-378558),p=g(p,c,l,u,i[h+8],11,-2022574463),u=g(u,p,c,l,i[h+11],16,1839030562),l=g(l,u,p,c,i[h+14],23,-35309556),c=g(c,l,u,p,i[h+1],4,-1530992060),p=g(p,c,l,u,i[h+4],11,1272893353),u=g(u,p,c,l,i[h+7],16,-155497632),l=g(l,u,p,c,i[h+10],23,-1094730640),c=g(c,l,u,p,i[h+13],4,681279174),p=g(p,c,l,u,i[h+0],11,-358537222),u=g(u,p,c,l,i[h+3],16,-722521979),l=g(l,u,p,c,i[h+6],23,76029189),c=g(c,l,u,p,i[h+9],4,-640364487),p=g(p,c,l,u,i[h+12],11,-421815835),u=g(u,p,c,l,i[h+15],16,530742520),c=v(c,l=g(l,u,p,c,i[h+2],23,-995338651),u,p,i[h+0],6,-198630844),p=v(p,c,l,u,i[h+7],10,1126891415),u=v(u,p,c,l,i[h+14],15,-1416354905),l=v(l,u,p,c,i[h+5],21,-57434055),c=v(c,l,u,p,i[h+12],6,1700485571),p=v(p,c,l,u,i[h+3],10,-1894986606),u=v(u,p,c,l,i[h+10],15,-1051523),l=v(l,u,p,c,i[h+1],21,-2054922799),c=v(c,l,u,p,i[h+8],6,1873313359),p=v(p,c,l,u,i[h+15],10,-30611744),u=v(u,p,c,l,i[h+6],15,-1560198380),l=v(l,u,p,c,i[h+13],21,1309151649),c=v(c,l,u,p,i[h+4],6,-145523070),p=v(p,c,l,u,i[h+11],10,-1120210379),u=v(u,p,c,l,i[h+2],15,718787259),l=v(l,u,p,c,i[h+9],21,-343485551),c=c+y>>>0,l=l+_>>>0,u=u+S>>>0,p=p+b>>>0}return r.endian([c,l,u,p])})._ff=function(e,t,i,r,s,o,n){var a=e+(t&i|~t&r)+(s>>>0)+n;return(a<<o|a>>>32-o)+t},a._gg=function(e,t,i,r,s,o,n){var a=e+(t&r|i&~r)+(s>>>0)+n;return(a<<o|a>>>32-o)+t},a._hh=function(e,t,i,r,s,o,n){var a=e+(t^i^r)+(s>>>0)+n;return(a<<o|a>>>32-o)+t},a._ii=function(e,t,i,r,s,o,n){var a=e+(i^(t|~r))+(s>>>0)+n;return(a<<o|a>>>32-o)+t},a._blocksize=16,a._digestsize=16,e.exports=function(e,t){if(null==e)throw new Error("Illegal argument "+e);var i=r.wordsToBytes(a(e,t));return t&&t.asBytes?i:t&&t.asString?n.bytesToString(i):r.bytesToHex(i)}},function(e,t){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(e){"object"==typeof window&&(i=window)}e.exports=i},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.destroyBeauty=t.ani=t.transformTrack=t.startBeauty=void 0;const n=o(i(13)),a=[1,1,1,-1,-1,1,-1,-1];let d,c,l,u,p,h,f;function m(e,t,i){const r=e.createShader(t);if(e.shaderSource(r,i),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS))return r;console.log(e.getShaderInfoLog(r)),e.deleteShader(r)}function g(e,t){d=t,c=e;const i=m(d,d.VERTEX_SHADER,"\n    precision mediump float;\n    attribute vec4 position;\n    attribute vec4 inputTextureCoordinate;\n    varying vec2 textureCoordinate;\n\n    void main() {\n        gl_Position = position;\n        textureCoordinate = vec2((position.x+1.0)/2.0, 1.0-(position.y+1.0)/2.0);\n    }\n"),r=m(d,d.FRAGMENT_SHADER,"\nprecision mediump float;\nuniform sampler2D inputImageTexture;\nuniform float smoothVal;\nuniform float softVal;\nuniform float satVal;\nuniform float brightVal;\nuniform float contrastVal; \nvarying vec2 textureCoordinate;\n\n    const vec3 W = vec3(0.299, 0.587, 0.114); \nconst mat3 saturateMatrix = mat3( \n    1.1102, -0.0598, -0.061, \n    -0.0774, 1.0826, -0.1186, \n    -0.0228, -0.0228, 1.1772); \nvec2 blurCoordinates[24]; \n\nfloat hardLight(float color) { \n    if (color <= 0.5) \n        color = color * color * 2.0; \n    else \n        color = 1.0 - ((1.0 - color)*(1.0 - color) * 2.0); \n    return color; \n} \nvoid main() {\nvec4 previousPassColor = texture2D(inputImageTexture, textureCoordinate);\nvec3 centralColor = previousPassColor.rgb; \nvec2 singleStepOffset=vec2(1, 1);\n\nblurCoordinates[0] = textureCoordinate.xy + singleStepOffset * vec2(0.0, -10.0); \nblurCoordinates[1] = textureCoordinate.xy + singleStepOffset * vec2(0.0, 10.0); \nblurCoordinates[2] = textureCoordinate.xy + singleStepOffset * vec2(-10.0, 0.0); \nblurCoordinates[3] = textureCoordinate.xy + singleStepOffset * vec2(10.0, 0.0); \nblurCoordinates[4] = textureCoordinate.xy + singleStepOffset * vec2(5.0, -8.0); \nblurCoordinates[5] = textureCoordinate.xy + singleStepOffset * vec2(5.0, 8.0); \nblurCoordinates[6] = textureCoordinate.xy + singleStepOffset * vec2(-5.0, 8.0); \nblurCoordinates[7] = textureCoordinate.xy + singleStepOffset * vec2(-5.0, -8.0); \nblurCoordinates[8] = textureCoordinate.xy + singleStepOffset * vec2(8.0, -5.0); \nblurCoordinates[9] = textureCoordinate.xy + singleStepOffset * vec2(8.0, 5.0); \nblurCoordinates[10] = textureCoordinate.xy + singleStepOffset * vec2(-8.0, 5.0); \nblurCoordinates[11] = textureCoordinate.xy + singleStepOffset * vec2(-8.0, -5.0); \nblurCoordinates[12] = textureCoordinate.xy + singleStepOffset * vec2(0.0, -6.0); \nblurCoordinates[13] = textureCoordinate.xy + singleStepOffset * vec2(0.0, 6.0); \nblurCoordinates[14] = textureCoordinate.xy + singleStepOffset * vec2(6.0, 0.0); \nblurCoordinates[15] = textureCoordinate.xy + singleStepOffset * vec2(-6.0, 0.0); \nblurCoordinates[16] = textureCoordinate.xy + singleStepOffset * vec2(-4.0, -4.0); \nblurCoordinates[17] = textureCoordinate.xy + singleStepOffset * vec2(-4.0, 4.0); \nblurCoordinates[18] = textureCoordinate.xy + singleStepOffset * vec2(4.0, -4.0); \nblurCoordinates[19] = textureCoordinate.xy + singleStepOffset * vec2(4.0, 4.0); \nblurCoordinates[20] = textureCoordinate.xy + singleStepOffset * vec2(-2.0, -2.0); \nblurCoordinates[21] = textureCoordinate.xy + singleStepOffset * vec2(-2.0, 2.0); \nblurCoordinates[22] = textureCoordinate.xy + singleStepOffset * vec2(2.0, -2.0); \nblurCoordinates[23] = textureCoordinate.xy + singleStepOffset * vec2(2.0, 2.0); \n\nfloat sampleColor = centralColor.g * 22.0; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[0]).g; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[1]).g; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[2]).g; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[3]).g; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[4]).g; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[5]).g; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[6]).g; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[7]).g; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[8]).g; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[9]).g; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[10]).g; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[11]).g; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[12]).g * 2.0; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[13]).g * 2.0; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[14]).g * 2.0; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[15]).g * 2.0; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[16]).g * 2.0; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[17]).g * 2.0; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[18]).g * 2.0; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[19]).g * 2.0; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[20]).g * 3.0; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[21]).g * 3.0; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[22]).g * 3.0; \nsampleColor += texture2D(inputImageTexture, blurCoordinates[23]).g * 3.0; \n\nsampleColor = sampleColor / 62.0; \n\nfloat highPass = centralColor.g - sampleColor + 0.5; \n\nfor (int i = 0; i < 5; i++) { \n    highPass = hardLight(highPass); \n} \nfloat lumance = dot(centralColor, W); \n\nfloat alpha = pow(lumance, 1.0); \n\nvec3 smoothColor = centralColor + (centralColor-vec3(highPass))*alpha*0.1; \n\n// 平滑\nsmoothColor.r = clamp(pow(smoothColor.r, 1.0 - smoothVal), 0.0, 1.0); \nsmoothColor.g = clamp(pow(smoothColor.g, 1.0 - smoothVal), 0.0, 1.0); \nsmoothColor.b = clamp(pow(smoothColor.b, 1.0 - smoothVal), 0.0, 1.0); \n\nvec3 lvse = vec3(1.0)-(vec3(1.0)-smoothColor)*(vec3(1.0)-centralColor); \nvec3 lightening = max(smoothColor, centralColor); \nvec3 softlight = 2.0*centralColor*smoothColor + centralColor*centralColor - 2.0*centralColor*centralColor*smoothColor;\n\ngl_FragColor = vec4(mix(centralColor, lvse, alpha), 1.0); \ngl_FragColor.rgb = mix(gl_FragColor.rgb, lightening, alpha); \ngl_FragColor.rgb = mix(gl_FragColor.rgb, softlight, 0.5 - softVal); \n\nvec3 satcolor = gl_FragColor.rgb * saturateMatrix; \ngl_FragColor.rgb = mix(gl_FragColor.rgb, satcolor, satVal);\ngl_FragColor.rgb = vec3(gl_FragColor.rgb + vec3(brightVal));\n\nfloat contrast = contrastVal - 0.6;\nif (contrast > 0.0) {\n    gl_FragColor.rgb = (gl_FragColor.rgb - 0.5) / (1.0 - contrast) + 0.5;\n} else {\n    gl_FragColor.rgb = (gl_FragColor.rgb - 0.5) * (1.0 + contrast) + 0.5;\n}\n    }\n    ");l=function(e,t,i){const r=e.createProgram();if(e.attachShader(r,t),e.attachShader(r,i),e.linkProgram(r),e.getProgramParameter(r,e.LINK_STATUS))return d.useProgram(r),r;console.error(e.getProgramInfoLog(r)),e.deleteProgram(r)}(d,i,r);const s=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,s),d.bufferData(d.ARRAY_BUFFER,new Float32Array(a),d.STATIC_DRAW);let o=d.getAttribLocation(l,"position");d.enableVertexAttribArray(o),d.vertexAttribPointer(o,2,d.FLOAT,!1,0,0)}let v,y,_=null;function S(){u=d.getUniformLocation(l,"contrastVal"),p=d.getUniformLocation(l,"brightVal"),h=d.getUniformLocation(l,"satVal"),f=d.getUniformLocation(l,"smoothVal");const e=d.getUniformLocation(l,"inputImageTexture");d.uniform1i(e,0),function(e,t){if((void 0===t.readyState||0!==t.readyState)&&4===t.readyState){e.activeTexture(e.TEXTURE0);const i=e.createTexture();e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGB,e.RGB,e.UNSIGNED_BYTE,t),e.clear(e.COLOR_BUFFER_BIT),e.drawArrays(e.TRIANGLE_STRIP,0,4)}}(d,c),_=setTimeout(S,1e3/y)}function b(e,t){g(e,t),S(),d.uniform1f(u,.5)}t.startBeauty=function(e){let t=0,i=0,r=0,s=0;t=e.lighteningContrastLevel,i=e.brightnessLevel,r=e.rednessLevel,s=e.smoothnessLevel,"number"==typeof t&&(d.uniform1f(u,t),d.drawArrays(d.TRIANGLE_STRIP,0,4)),"number"==typeof i&&(d.uniform1f(p,i/5),d.drawArrays(d.TRIANGLE_STRIP,0,4)),"number"==typeof r&&(d.uniform1f(h,r),d.drawArrays(d.TRIANGLE_STRIP,0,4)),"number"==typeof s&&(d.uniform1f(f,s),d.drawArrays(d.TRIANGLE_STRIP,0,4))},t.transformTrack=function(e){v=document.createElement("canvas"),window.videoElem=document.createElement("video"),d=v.getContext("webgl");let t=e.getSettings();y=t.frameRate||15;const i=new MediaStream([e]);return window.videoElem.srcObject=i,window.videoElem.setAttribute("playsinline","playsinline"),window.videoElem.setAttribute("muted","muted"),window.videoElem.setAttribute("autoplay","autoplay"),window.videoElem.className="nertc-webgl-shim",window.videoElem.style.display="none",n.IS_ANY_SAFARI&&(window.videoElem.play(),v.height=0,v.width=0,document.body.appendChild(v)),b(window.videoElem,d),window.videoElem.onresize=()=>{window.videoElem.videoWidth&&window.videoElem.videoHeight&&(v.width=window.videoElem.videoWidth,v.height=window.videoElem.videoHeight,d.viewport(0,0,v.width,v.height))},v.captureStream(y).getVideoTracks()[0]},t.ani=b,t.destroyBeauty=function(){null!==_&&(clearTimeout(_),_=null),v.remove(),window.videoElem.remove()}},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.isHttpProtocol=t.checkRTCCompatibility=t.isBrowserSupported=t.isScreenShareSupport=t.isMediaDevicesSupported=t.isWebRTCSupported=t.RtcSupport=void 0;const n=i(26),a=i(27),d=i(25),c=o(i(13)),l=i(14);let u={result:!1,detail:{isBrowserSupported:!1,isWebRTCSupported:!1,isMediaDevicesSupported:!1,isH264EncodeSupported:!1,isVp8EncodeSupported:!1,isH264DecodeSupported:!1,isVp8DecodeSupported:!1}};var p=null;a.RtcSystem.ios()&&"weixin"===a.RtcSystem.browser.ua||(p=navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia);var h=window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext,f=window.RTCPeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,m=window.MediaStream=window.MediaStream||window.webkitMediaStream;function g(e){let t;return t||(t=document.createElement("video")),!!t.canPlayType({ogg:'video/ogg; codecs="theora"',h264:'video/mp4; codecs="avc1.42E01E"',webm:'video/webm; codecs="vp8, vorbis"',vp9:'video/webm; codecs="vp9"',hls:'application/x-mpegURL; codecs="avc1.42E01E"'}[e]||e)}const v={WebRTC:!!f&&!!m,RTCPeerConnection:!!f,Vp8:g("webm"),Vp9:g("vp9"),H264:g("h264"),GetUserMedia:!!p&&!!navigator.mediaDevices,DataChannel:!!(f&&RTCDataChannel&&f.prototype&&f.prototype.createDataChannel),WebAudio:!(!h||!h.prototype.createMediaStreamSource),MediaStream:!!m};function y(){let e=d.platform&&d.platform.name,t=d.platform&&d.platform.version;return t=t&&t.match(/\d+/)[0],{prefix:e,version:t}}const _={checkWebRtc:()=>v,checkWebAudio:()=>({WebAudio:v.WebAudio,MediaStream:v.MediaStream}),checkCompatibility(){let e=Object.assign(y(),{system:d.platform&&d.platform.os.family+" "+d.platform.os.version,browser:d.platform&&d.platform.name,version:d.platform&&d.platform.version});return new Promise((function(t,i){(async()=>{const i=Object.assign(e,v,{ScreenSharing:!1}),r=await n.Device.getDevices({audiooutput:!0,audioinput:!0,videoinput:!0,requestPerm:!0}).catch(e=>t(i));i.MicrophoneList=r&&r.audioIn||[],i.CameraList=r&&r.video||[],i.Microphone=r&&r.audioIn&&r.audioIn.length>0||!1,i.Camera=r&&r.video&&r.video.length>0||!1,t(i)})()}))},checkVersion:()=>y()};t.RtcSupport=_;t.isWebRTCSupported=function(){return["RTCPeerConnection","webkitRTCPeerConnection","RTCIceGatherer"].filter(e=>e in window).length>0};t.isMediaDevicesSupported=function(){if(!navigator.mediaDevices)return!1;const e=["getUserMedia","enumerateDevices"];return e.filter(e=>e in navigator.mediaDevices).length===e.length};t.isScreenShareSupport=function(){if(c.IS_ELECTRON)return!0;{let e=navigator.mediaDevices;return!(!e||!e.getDisplayMedia)}};t.isBrowserSupported=function(){return!!(c.IS_CHROME&&c.CHROME_MAJOR_VERSION>=72)||(!!(c.IS_MAC_SAFARI&&c.SAFARI_MAJOR_VERSION>=12)||(!(!(c.IS_IOS_SAFARI&&c.SAFARI_MAJOR_VERSION>=13)||c.IS_WECHAT)||(!!(c.IS_EDG&&c.EDG_MAJOR_VERSION>=80)||(!!(c.IS_FIREFOX&&c.FIREFOX_MAJOR_VERSION>=66)||(!(!c.IS_IOS||!c.IS_MQQB)||(!!(c.IS_IOS&&c.IOS_VERSION>=14.3&&c.IS_WECHAT&&c.WECHAT_VERSION>=6.5)||!(!c.IS_ANDROID||!c.IS_TBS&&!c.IS_XWEB)))))))};t.checkRTCCompatibility=async function(){if(u.result)return u;const e=t.isBrowserSupported(),i=t.isWebRTCSupported(),r=t.isMediaDevicesSupported(),s=await l.getSupportedCodecs("send"),o=await l.getSupportedCodecs("recv");return u.detail.isBrowserSupported=e,u.detail.isWebRTCSupported=i,u.detail.isMediaDevicesSupported=r,u.detail.isH264EncodeSupported=s.video.indexOf("H264")>-1,u.detail.isVp8EncodeSupported=s.video.indexOf("VP8")>-1,u.detail.isH264DecodeSupported=o.video.indexOf("H264")>-1,u.detail.isVp8DecodeSupported=o.video.indexOf("VP8")>-1,u.result=e&&i&&r&&(u.detail.isH264EncodeSupported||u.detail.isVp8EncodeSupported)&&(u.detail.isH264EncodeSupported||u.detail.isVp8EncodeSupported),u};const S="file:"===location.protocol||"localhost"===location.hostname||/^\d+\.\d+\.\d+\.\d+$/.test(location.hostname);t.isHttpProtocol=function(){return"http:"===location.protocol&&!S}},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.encryptionModeToInt=t.EncryptionModes=t.Encryption=void 0;const s=i(3),o=r(i(55)),n=i(151),a=r(i(1)),d=r(i(0)),c={none:-1,"sm4-128-ecb":0};t.EncryptionModes=c,t.encryptionModeToInt=function(e){return"none"===e||"sm4-128-ecb"===e?c[e]:void 0};class l extends s.EventEmitter{constructor(e){super(),this.encryptionMode="none",this.encryptionSecret="",this.encodedInsertableStreams=!1,this.adapterRef=e,this.encCtx=new n.SM4Ctx,this.decCtx=new n.SM4Ctx}setEncryptionMode(e){this.encryptionMode=e,this.encodedInsertableStreams="encoded-transform-sm4-128-ecb"===e}setEncryptionSecret(e){this.encryptionSecret=o.default(e),"encoded-transform-sm4-128-ecb"===this.encryptionMode&&this.initSm4()}initSm4(){if(!this.encryptionSecret)throw new a.default({code:d.default.NOT_FOUND,message:"No encryptionSecret"});{const e=(new TextEncoder).encode(this.encryptionSecret);n.sm4_setkey_enc(this.encCtx,e),n.sm4_setkey_dec(this.decCtx,e)}}findCryptIndexH264(e){for(let t=3;t<e.length;t++)if(97===e[t]||101===e[t]&&1===e[t-1]&&0===e[t-2]&&0===e[t-3])return t+1;return-1}encodeFunctionH264(e,t){const i=new Uint8Array(e.data),r=this.findCryptIndexH264(i);if(r>0){const t=n.sm4_crypt_ecb(this.encCtx,i.subarray(r),{shiftStart:r});for(let e=0;e<r;e++)t[e]=i[e];e.data=t.buffer}t.enqueue(e)}decodeFunctionH264(e,t){const i=new Uint8Array(e.data),r=this.findCryptIndexH264(i);if(r>0){if((i.buffer.byteLength-r)%16!=0)return this.adapterRef.logger.warn("解密前的包无法被16整除",r,i),void t.enqueue(e);const s=n.sm4_crypt_ecb(this.decCtx,i,{shiftStart:r}),o=new Uint8Array(r+s.length);for(let e=0;e<o.length;e++)o[e]=e<r?i[e]:s[e-r];e.data=o.buffer}t.enqueue(e)}}t.Encryption=l},function(e,t,i){e.exports=i(157)},function(e,t,i){"use strict";t.__esModule=!0;var r,s=i(159),o=(r=s)&&r.__esModule?r:{default:r};t.default=function(e){return function(){var t=e.apply(this,arguments);return new o.default((function(e,i){return function r(s,n){try{var a=t[s](n),d=a.value}catch(e){return void i(e)}if(!a.done)return o.default.resolve(d).then((function(e){r("next",e)}),(function(e){r("throw",e)}));e(d)}("next")}))}}},function(e,t){var i=Math.ceil,r=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(e>0?r:i)(e)}},function(e,t){e.exports=function(e){if(null==e)throw TypeError("Can't call method on  "+e);return e}},function(e,t,i){var r=i(17),s=i(5).document,o=r(s)&&r(s.createElement);e.exports=function(e){return o?s.createElement(e):{}}},function(e,t,i){var r=i(17);e.exports=function(e,t){if(!r(e))return e;var i,s;if(t&&"function"==typeof(i=e.toString)&&!r(s=i.call(e)))return s;if("function"==typeof(i=e.valueOf)&&!r(s=i.call(e)))return s;if(!t&&"function"==typeof(i=e.toString)&&!r(s=i.call(e)))return s;throw TypeError("Can't convert object to primitive value")}},function(e,t,i){var r=i(98),s=i(69);e.exports=Object.keys||function(e){return r(e,s)}},function(e,t,i){var r=i(68)("keys"),s=i(49);e.exports=function(e){return r[e]||(r[e]=s(e))}},function(e,t,i){var r=i(9),s=i(5),o=s["__core-js_shared__"]||(s["__core-js_shared__"]={});(e.exports=function(e,t){return o[e]||(o[e]=void 0!==t?t:{})})("versions",[]).push({version:r.version,mode:i(32)?"pure":"global",copyright:"© 2020 Denis Pushkarev (zloirock.ru)"})},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(e,t,i){"use strict";var r=i(46);function s(e){var t,i;this.promise=new e((function(e,r){if(void 0!==t||void 0!==i)throw TypeError("Bad Promise constructor");t=e,i=r})),this.resolve=r(t),this.reject=r(i)}e.exports.f=function(e){return new s(e)}},function(e,t,i){t.f=i(6)},function(e,t,i){var r=i(5),s=i(9),o=i(32),n=i(71),a=i(16).f;e.exports=function(e){var t=s.Symbol||(s.Symbol=o?{}:r.Symbol||{});"_"==e.charAt(0)||e in t||a(t,e,{value:n.f(e)})}},function(e,t){t.f={}.propertyIsEnumerable},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.applyCodecParameters=t.getCname=t.extractDtlsParameters=t.extractRtpCapabilities=void 0;const a=o(i(39)),d=n(i(1)),c=n(i(0));t.extractRtpCapabilities=function({sdpObject:e}){const t=new Map,i=[];let r=!1,s=!1;for(const o of e.media){const e=o.type;switch(e){case"audio":if(r)continue;r=!0;break;case"video":if(s)continue;s=!0;break;default:continue}for(const i of o.rtp){const r={kind:e,mimeType:`${e}/${i.codec}`,preferredPayloadType:i.payload,clockRate:i.rate,channels:i.encoding,parameters:{},rtcpFeedback:[]};t.set(r.preferredPayloadType,r)}for(const e of o.fmtp||[]){const i=a.parseParams(e.config),r=t.get(e.payload);r&&(i&&i.hasOwnProperty("profile-level-id")&&(i["profile-level-id"]=String(i["profile-level-id"])),r.parameters=i)}for(const e of o.rtcpFb||[]){const i=t.get(e.payload);if(!i)continue;const r={type:e.type,parameter:e.subtype};r.parameter||delete r.parameter,i.rtcpFeedback.push(r)}for(const t of o.ext||[]){if(t["encrypt-uri"])continue;const r={kind:e,uri:t.uri,preferredId:t.value};i.push(r)}}return{codecs:Array.from(t.values()),headerExtensions:i}},t.extractDtlsParameters=function({sdpObject:e}){const t=(e.media||[]).find(e=>e.iceUfrag&&0!==e.port);if(!t)throw new d.default({code:c.default.NOT_FOUND,message:"no active media section found"});const i=t.fingerprint||e.fingerprint;let r;switch(t.setup){case"active":r="client";break;case"passive":r="server";break;case"actpass":r="auto"}return{role:r,fingerprints:[{algorithm:i.type,value:i.hash}]}},t.getCname=function({offerMediaObject:e}){const t=(e.ssrcs||[]).find(e=>"cname"===e.attribute);return t?t.value:""},t.applyCodecParameters=function({offerRtpParameters:e,answerMediaObject:t}){for(const i of e.codecs){const e=i.mimeType.toLowerCase();if("audio/opus"!==e)continue;if(!(t.rtp||[]).find(e=>e.payload===i.payloadType))continue;t.fmtp=t.fmtp||[];let r=t.fmtp.find(e=>e.payload===i.payloadType);r||(r={payload:i.payloadType,config:""},t.fmtp.push(r));const s=a.parseParams(r.config);switch(e){case"audio/opus":{const e=i.parameters["sprop-stereo"];void 0!==e&&(s.stereo=e?1:0);break}}r.config="";for(const e of Object.keys(s))r.config&&(r.config+=";"),r.config+=`${e}=${s[e]}`}}},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.addLegacySimulcast=t.getRtpEncodings=void 0;const s=r(i(1)),o=r(i(0));t.getRtpEncodings=function({offerMediaObject:e}){const t=new Set;for(const i of e.ssrcs||[]){const e=i.id;t.add(e)}if(0===t.size)throw new s.default({code:o.default.NOT_FOUND,message:"no a=ssrc lines found"});const i=new Map;for(const r of e.ssrcGroups||[]){if("FID"!==r.semantics)continue;let[e,s]=r.ssrcs.split(/\s+/);e=Number(e),s=Number(s),t.has(e)&&(t.delete(e),t.delete(s),i.set(e,s))}for(const e of t)i.set(e,null);const r=[];for(const[e,t]of i){const i={ssrc:e};t&&(i.rtx={ssrc:t}),r.push(i)}return r},t.addLegacySimulcast=function({offerMediaObject:e,numStreams:t}){if(t<=1)throw new TypeError("numStreams must be greater than 1");const i=(e.ssrcs||[]).find(e=>"msid"===e.attribute);if(!i)throw new s.default({code:o.default.NOT_FOUND,message:"a=ssrc line with msid information not found"});const[r,n]=i.value.split(" "),a=i.id;let d;(e.ssrcGroups||[]).some(e=>{if("FID"!==e.semantics)return!1;const t=e.ssrcs.split(/\s+/);return Number(t[0])===a&&(d=Number(t[1]),!0)});const c=e.ssrcs.find(e=>"cname"===e.attribute);if(!c)throw new s.default({code:o.default.NOT_FOUND,message:"a=ssrc line with cname information not found"});const l=c.value,u=[],p=[];for(let e=0;e<t;++e)u.push(a+e),d&&p.push(d+e);e.ssrcGroups=[],e.ssrcs=[],e.ssrcGroups.push({semantics:"SIM",ssrcs:u.join(" ")});for(let t=0;t<u.length;++t){const i=u[t];e.ssrcs.push({id:i,attribute:"cname",value:l}),e.ssrcs.push({id:i,attribute:"msid",value:`${r} ${n}`})}for(let t=0;t<p.length;++t){const i=u[t],s=p[t];e.ssrcs.push({id:s,attribute:"cname",value:l}),e.ssrcs.push({id:s,attribute:"msid",value:`${r} ${n}`}),e.ssrcGroups.push({semantics:"FID",ssrcs:`${i} ${s}`})}}},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RemoteSdp=void 0;const a=o(i(39)),d=i(7),c=i(211),l=n(i(1)),u=n(i(0));t.RemoteSdp=class{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,plainRtpParameters:s,planB:o=!1}){if(this._mediaSections=[],this._midToIndex=new Map,this._iceParameters=e,this._iceCandidates=t,this._dtlsParameters=i,this._sctpParameters=r,this._plainRtpParameters=s,this._planB=o,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:1e4,sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},e&&e.iceLite&&(this._sdpObject.icelite="ice-lite"),i){this._sdpObject.msidSemantic={semantic:"WMS",token:"*"};const e=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:i.fingerprints[e-1].algorithm,hash:i.fingerprints[e-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}]}s&&(this._sdpObject.origin.address=s.ip,this._sdpObject.origin.ipVer=s.ipVersion)}updateIceParameters(e){d.Logger.debug("RemoteSdp","updateIceParameters() [iceParameters:%o]",e),this._iceParameters=e,this._sdpObject.icelite=e.iceLite?"ice-lite":void 0;for(const t of this._mediaSections)t.setIceParameters(e)}updateDtlsRole(e){d.Logger.debug("RemoteSdp","updateDtlsRole() [role:%s]",e),this._dtlsParameters.role=e;for(const t of this._mediaSections)t.setDtlsRole(e)}getNextMediaSectionIdx(){for(let e=0;e<this._mediaSections.length;++e){const t=this._mediaSections[e];if(t.closed)return{idx:e,reuseMid:t.mid}}return{idx:this._mediaSections.length}}send({offerMediaObjectArr:e,reuseMid:t,offerRtpParameters:i,answerRtpParameters:r,codecOptions:s,extmapAllowMixed:o=!1}){e.length&&e.forEach((e,n)=>{if(!e)return;const a=new c.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,offerMediaObject:e,offerRtpParameters:i,answerRtpParameters:r,codecOptions:s?s[n]:void 0,extmapAllowMixed:o});t?this._replaceMediaSection(a,t):this._addMediaSection(a)})}receive({mid:e,kind:t,offerRtpParameters:i,streamId:r,trackId:s,reuseMid:o=null}){const n=this._midToIndex.get(e);let a;void 0!==n&&(a=this._mediaSections[n]),a?(a=new c.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:e,kind:t,offerRtpParameters:i,streamId:r,trackId:s}),this._replaceMediaSection(a,e)):(a=new c.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:e,kind:t,offerRtpParameters:i,streamId:r,trackId:s}),null===o?this._addMediaSection(a):this._replaceMediaSection(a,o))}disableMediaSection(e){const t=this._midToIndex.get(e);if(void 0===t)throw new l.default({code:u.default.NOT_FOUND,message:`no media section found with mid '${e}'`});this._mediaSections[t].disable()}closeMediaSection(e){const t=this._midToIndex.get(e);if(void 0===t)throw new l.default({code:u.default.NOT_FOUND,message:`no media section found with mid '${e}'`});const i=this._mediaSections[t];e===this._firstMid&&d.Logger.debug("RemoteSdp","closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",e),i.close()}planBStopReceiving({mid:e,offerRtpParameters:t}){const i=this._midToIndex.get(e);if(void 0===i)throw new l.default({code:u.default.NOT_FOUND,message:`no media section found with mid '${e}'`});const r=this._mediaSections[i];r.planBStopReceiving({offerRtpParameters:t}),this._replaceMediaSection(r)}sendSctpAssociation({offerMediaObject:e}){const t=new c.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:e});this._addMediaSection(t)}receiveSctpAssociation({oldDataChannelSpec:e=!1}={}){const t=new c.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application",oldDataChannelSpec:e});this._addMediaSection(t)}getSdp(){return this._sdpObject.origin.sessionVersion++,this._sdpObject.media.sort((function(e,t){return e.mid-t.mid})),a.write(this._sdpObject)}_addMediaSection(e){this._firstMid||(this._firstMid=e.mid),this._mediaSections.push(e),this._midToIndex.set(e.mid,this._mediaSections.length-1),this._sdpObject.media.push(e.getObject()),this._regenerateBundleMids()}_replaceMediaSection(e,t){if("string"==typeof t){const i=this._midToIndex.get(t);if(void 0===i)throw new l.default({code:u.default.NOT_FOUND,message:`no media section found for reuseMid '${t}'`});const r=this._mediaSections[i];this._mediaSections[i]=e,this._midToIndex.delete(r.mid),this._midToIndex.set(e.mid,i),this._sdpObject.media[i]=e.getObject(),this._regenerateBundleMids()}else{const t=this._midToIndex.get(e.mid);if(void 0===t)throw new l.default({code:u.default.NOT_FOUND,message:`no media section found with mid '${e.mid}'`});this._mediaSections[t]=e,this._sdpObject.media[t]=e.getObject()}}_regenerateBundleMids(){this._dtlsParameters&&(this._sdpObject.groups[0].mids=this._mediaSections.filter(e=>!e.closed).map(e=>e.mid).join(" "))}}},function(e,t,i){"use strict";e.exports=u;var r,s=i(10),o=s.LongBits,n=s.base64,a=s.utf8;function d(e,t,i){this.fn=e,this.len=t,this.next=void 0,this.val=i}function c(){}function l(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}function u(){this.len=0,this.head=new d(c,0,0),this.tail=this.head,this.states=null}var p=function(){return s.Buffer?function(){return(u.create=function(){return new r})()}:function(){return new u}};function h(e,t,i){t[i]=255&e}function f(e,t){this.len=e,this.next=void 0,this.val=t}function m(e,t,i){for(;e.hi;)t[i++]=127&e.lo|128,e.lo=(e.lo>>>7|e.hi<<25)>>>0,e.hi>>>=7;for(;e.lo>127;)t[i++]=127&e.lo|128,e.lo=e.lo>>>7;t[i++]=e.lo}function g(e,t,i){t[i]=255&e,t[i+1]=e>>>8&255,t[i+2]=e>>>16&255,t[i+3]=e>>>24}u.create=p(),u.alloc=function(e){return new s.Array(e)},s.Array!==Array&&(u.alloc=s.pool(u.alloc,s.Array.prototype.subarray)),u.prototype._push=function(e,t,i){return this.tail=this.tail.next=new d(e,t,i),this.len+=t,this},f.prototype=Object.create(d.prototype),f.prototype.fn=function(e,t,i){for(;e>127;)t[i++]=127&e|128,e>>>=7;t[i]=e},u.prototype.uint32=function(e){return this.len+=(this.tail=this.tail.next=new f((e>>>=0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this},u.prototype.int32=function(e){return e<0?this._push(m,10,o.fromNumber(e)):this.uint32(e)},u.prototype.sint32=function(e){return this.uint32((e<<1^e>>31)>>>0)},u.prototype.uint64=function(e){var t=o.from(e);return this._push(m,t.length(),t)},u.prototype.int64=u.prototype.uint64,u.prototype.sint64=function(e){var t=o.from(e).zzEncode();return this._push(m,t.length(),t)},u.prototype.bool=function(e){return this._push(h,1,e?1:0)},u.prototype.fixed32=function(e){return this._push(g,4,e>>>0)},u.prototype.sfixed32=u.prototype.fixed32,u.prototype.fixed64=function(e){var t=o.from(e);return this._push(g,4,t.lo)._push(g,4,t.hi)},u.prototype.sfixed64=u.prototype.fixed64,u.prototype.float=function(e){return this._push(s.float.writeFloatLE,4,e)},u.prototype.double=function(e){return this._push(s.float.writeDoubleLE,8,e)};var v=s.Array.prototype.set?function(e,t,i){t.set(e,i)}:function(e,t,i){for(var r=0;r<e.length;++r)t[i+r]=e[r]};u.prototype.bytes=function(e){var t=e.length>>>0;if(!t)return this._push(h,1,0);if(s.isString(e)){var i=u.alloc(t=n.length(e));n.decode(e,i,0),e=i}return this.uint32(t)._push(v,t,e)},u.prototype.string=function(e){var t=a.length(e);return t?this.uint32(t)._push(a.write,t,e):this._push(h,1,0)},u.prototype.fork=function(){return this.states=new l(this),this.head=this.tail=new d(c,0,0),this.len=0,this},u.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new d(c,0,0),this.len=0),this},u.prototype.ldelim=function(){var e=this.head,t=this.tail,i=this.len;return this.reset().uint32(i),i&&(this.tail.next=e.next,this.tail=t,this.len+=i),this},u.prototype.finish=function(){for(var e=this.head.next,t=this.constructor.alloc(this.len),i=0;e;)e.fn(e.val,t,i),i+=e.len,e=e.next;return t},u._configure=function(e){r=e,u.create=p(),r._configure()}},function(e,t,i){"use strict";e.exports=d;var r,s=i(10),o=s.LongBits,n=s.utf8;function a(e,t){return RangeError("index out of range: "+e.pos+" + "+(t||1)+" > "+e.len)}function d(e){this.buf=e,this.pos=0,this.len=e.length}var c,l="undefined"!=typeof Uint8Array?function(e){if(e instanceof Uint8Array||Array.isArray(e))return new d(e);throw Error("illegal buffer")}:function(e){if(Array.isArray(e))return new d(e);throw Error("illegal buffer")},u=function(){return s.Buffer?function(e){return(d.create=function(e){return s.Buffer.isBuffer(e)?new r(e):l(e)})(e)}:l};function p(){var e=new o(0,0),t=0;if(!(this.len-this.pos>4)){for(;t<3;++t){if(this.pos>=this.len)throw a(this);if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(127&this.buf[this.pos++])<<7*t)>>>0,e}for(;t<4;++t)if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(127&this.buf[this.pos])<<28)>>>0,e.hi=(e.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return e;if(t=0,this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw a(this);if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}function h(e,t){return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0}function f(){if(this.pos+8>this.len)throw a(this,8);return new o(h(this.buf,this.pos+=4),h(this.buf,this.pos+=4))}d.create=u(),d.prototype._slice=s.Array.prototype.subarray||s.Array.prototype.slice,d.prototype.uint32=(c=4294967295,function(){if(c=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return c;if(c=(c|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return c;if(c=(c|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return c;if(c=(c|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return c;if(c=(c|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return c;if((this.pos+=5)>this.len)throw this.pos=this.len,a(this,10);return c}),d.prototype.int32=function(){return 0|this.uint32()},d.prototype.sint32=function(){var e=this.uint32();return e>>>1^-(1&e)|0},d.prototype.bool=function(){return 0!==this.uint32()},d.prototype.fixed32=function(){if(this.pos+4>this.len)throw a(this,4);return h(this.buf,this.pos+=4)},d.prototype.sfixed32=function(){if(this.pos+4>this.len)throw a(this,4);return 0|h(this.buf,this.pos+=4)},d.prototype.float=function(){if(this.pos+4>this.len)throw a(this,4);var e=s.float.readFloatLE(this.buf,this.pos);return this.pos+=4,e},d.prototype.double=function(){if(this.pos+8>this.len)throw a(this,4);var e=s.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,e},d.prototype.bytes=function(){var e=this.uint32(),t=this.pos,i=this.pos+e;if(i>this.len)throw a(this,e);return this.pos+=e,Array.isArray(this.buf)?this.buf.slice(t,i):t===i?new this.buf.constructor(0):this._slice.call(this.buf,t,i)},d.prototype.string=function(){var e=this.bytes();return n.read(e,0,e.length)},d.prototype.skip=function(e){if("number"==typeof e){if(this.pos+e>this.len)throw a(this,e);this.pos+=e}else do{if(this.pos>=this.len)throw a(this)}while(128&this.buf[this.pos++]);return this},d.prototype.skipType=function(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(e=7&this.uint32());)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+e+" at offset "+this.pos)}return this},d._configure=function(e){r=e,d.create=u(),r._configure();var t=s.Long?"toLong":"toNumber";s.merge(d.prototype,{int64:function(){return p.call(this)[t](!1)},uint64:function(){return p.call(this)[t](!0)},sint64:function(){return p.call(this).zzDecode()[t](!1)},fixed64:function(){return f.call(this)[t](!0)},sfixed64:function(){return f.call(this)[t](!1)}})}},function(e,t,i){"use strict";e.exports=y;var r=i(40);((y.prototype=Object.create(r.prototype)).constructor=y).className="Type";var s=i(8),o=i(41),n=i(21),a=i(80),d=i(81),c=i(83),l=i(78),u=i(77),p=i(4),h=i(129),f=i(130),m=i(131),g=i(132),v=i(133);function y(e,t){r.call(this,e,t),this.fields={},this.oneofs=void 0,this.extensions=void 0,this.reserved=void 0,this.group=void 0,this._fieldsById=null,this._fieldsArray=null,this._oneofsArray=null,this._ctor=null}function _(e){return e._fieldsById=e._fieldsArray=e._oneofsArray=null,delete e.encode,delete e.decode,delete e.verify,e}Object.defineProperties(y.prototype,{fieldsById:{get:function(){if(this._fieldsById)return this._fieldsById;this._fieldsById={};for(var e=Object.keys(this.fields),t=0;t<e.length;++t){var i=this.fields[e[t]],r=i.id;if(this._fieldsById[r])throw Error("duplicate id "+r+" in "+this);this._fieldsById[r]=i}return this._fieldsById}},fieldsArray:{get:function(){return this._fieldsArray||(this._fieldsArray=p.toArray(this.fields))}},oneofsArray:{get:function(){return this._oneofsArray||(this._oneofsArray=p.toArray(this.oneofs))}},ctor:{get:function(){return this._ctor||(this.ctor=y.generateConstructor(this)())},set:function(e){var t=e.prototype;t instanceof c||((e.prototype=new c).constructor=e,p.merge(e.prototype,t)),e.$type=e.prototype.$type=this,p.merge(e,c,!0),this._ctor=e;for(var i=0;i<this.fieldsArray.length;++i)this._fieldsArray[i].resolve();var r={};for(i=0;i<this.oneofsArray.length;++i)r[this._oneofsArray[i].resolve().name]={get:p.oneOfGetter(this._oneofsArray[i].oneof),set:p.oneOfSetter(this._oneofsArray[i].oneof)};i&&Object.defineProperties(e.prototype,r)}}}),y.generateConstructor=function(e){for(var t,i=p.codegen(["p"],e.name),r=0;r<e.fieldsArray.length;++r)(t=e._fieldsArray[r]).map?i("this%s={}",p.safeProp(t.name)):t.repeated&&i("this%s=[]",p.safeProp(t.name));return i("if(p)for(var ks=Object.keys(p),i=0;i<ks.length;++i)if(p[ks[i]]!=null)")("this[ks[i]]=p[ks[i]]")},y.fromJSON=function(e,t){var i=new y(e,t.options);i.extensions=t.extensions,i.reserved=t.reserved;for(var c=Object.keys(t.fields),l=0;l<c.length;++l)i.add((void 0!==t.fields[c[l]].keyType?a.fromJSON:n.fromJSON)(c[l],t.fields[c[l]]));if(t.oneofs)for(c=Object.keys(t.oneofs),l=0;l<c.length;++l)i.add(o.fromJSON(c[l],t.oneofs[c[l]]));if(t.nested)for(c=Object.keys(t.nested),l=0;l<c.length;++l){var u=t.nested[c[l]];i.add((void 0!==u.id?n.fromJSON:void 0!==u.fields?y.fromJSON:void 0!==u.values?s.fromJSON:void 0!==u.methods?d.fromJSON:r.fromJSON)(c[l],u))}return t.extensions&&t.extensions.length&&(i.extensions=t.extensions),t.reserved&&t.reserved.length&&(i.reserved=t.reserved),t.group&&(i.group=!0),t.comment&&(i.comment=t.comment),i},y.prototype.toJSON=function(e){var t=r.prototype.toJSON.call(this,e),i=!!e&&Boolean(e.keepComments);return p.toObject(["options",t&&t.options||void 0,"oneofs",r.arrayToJSON(this.oneofsArray,e),"fields",r.arrayToJSON(this.fieldsArray.filter((function(e){return!e.declaringField})),e)||{},"extensions",this.extensions&&this.extensions.length?this.extensions:void 0,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"group",this.group||void 0,"nested",t&&t.nested||void 0,"comment",i?this.comment:void 0])},y.prototype.resolveAll=function(){for(var e=this.fieldsArray,t=0;t<e.length;)e[t++].resolve();var i=this.oneofsArray;for(t=0;t<i.length;)i[t++].resolve();return r.prototype.resolveAll.call(this)},y.prototype.get=function(e){return this.fields[e]||this.oneofs&&this.oneofs[e]||this.nested&&this.nested[e]||null},y.prototype.add=function(e){if(this.get(e.name))throw Error("duplicate name '"+e.name+"' in "+this);if(e instanceof n&&void 0===e.extend){if(this._fieldsById?this._fieldsById[e.id]:this.fieldsById[e.id])throw Error("duplicate id "+e.id+" in "+this);if(this.isReservedId(e.id))throw Error("id "+e.id+" is reserved in "+this);if(this.isReservedName(e.name))throw Error("name '"+e.name+"' is reserved in "+this);return e.parent&&e.parent.remove(e),this.fields[e.name]=e,e.message=this,e.onAdd(this),_(this)}return e instanceof o?(this.oneofs||(this.oneofs={}),this.oneofs[e.name]=e,e.onAdd(this),_(this)):r.prototype.add.call(this,e)},y.prototype.remove=function(e){if(e instanceof n&&void 0===e.extend){if(!this.fields||this.fields[e.name]!==e)throw Error(e+" is not a member of "+this);return delete this.fields[e.name],e.parent=null,e.onRemove(this),_(this)}if(e instanceof o){if(!this.oneofs||this.oneofs[e.name]!==e)throw Error(e+" is not a member of "+this);return delete this.oneofs[e.name],e.parent=null,e.onRemove(this),_(this)}return r.prototype.remove.call(this,e)},y.prototype.isReservedId=function(e){return r.isReservedId(this.reserved,e)},y.prototype.isReservedName=function(e){return r.isReservedName(this.reserved,e)},y.prototype.create=function(e){return new this.ctor(e)},y.prototype.setup=function(){for(var e=this.fullName,t=[],i=0;i<this.fieldsArray.length;++i)t.push(this._fieldsArray[i].resolve().resolvedType);this.encode=h(this)({Writer:u,types:t,util:p}),this.decode=f(this)({Reader:l,types:t,util:p}),this.verify=m(this)({types:t,util:p}),this.fromObject=g.fromObject(this)({types:t,util:p}),this.toObject=g.toObject(this)({types:t,util:p});var r=v[e];if(r){var s=Object.create(this);s.fromObject=this.fromObject,this.fromObject=r.fromObject.bind(s),s.toObject=this.toObject,this.toObject=r.toObject.bind(s)}return this},y.prototype.encode=function(e,t){return this.setup().encode(e,t)},y.prototype.encodeDelimited=function(e,t){return this.encode(e,t&&t.len?t.fork():t).ldelim()},y.prototype.decode=function(e,t){return this.setup().decode(e,t)},y.prototype.decodeDelimited=function(e){return e instanceof l||(e=l.create(e)),this.decode(e,e.uint32())},y.prototype.verify=function(e){return this.setup().verify(e)},y.prototype.fromObject=function(e){return this.setup().fromObject(e)},y.prototype.toObject=function(e,t){return this.setup().toObject(e,t)},y.d=function(e){return function(t){p.decorateType(t,e)}}},function(e,t,i){"use strict";e.exports=n;var r=i(21);((n.prototype=Object.create(r.prototype)).constructor=n).className="MapField";var s=i(30),o=i(4);function n(e,t,i,s,n,a){if(r.call(this,e,t,s,void 0,void 0,n,a),!o.isString(i))throw TypeError("keyType must be a string");this.keyType=i,this.resolvedKeyType=null,this.map=!0}n.fromJSON=function(e,t){return new n(e,t.id,t.keyType,t.type,t.options,t.comment)},n.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return o.toObject(["keyType",this.keyType,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",t?this.comment:void 0])},n.prototype.resolve=function(){if(this.resolved)return this;if(void 0===s.mapKey[this.keyType])throw Error("invalid key type: "+this.keyType);return r.prototype.resolve.call(this)},n.d=function(e,t,i){return"function"==typeof i?i=o.decorateType(i).name:i&&"object"==typeof i&&(i=o.decorateEnum(i).name),function(r,s){o.decorateType(r.constructor).add(new n(s,e,t,i))}}},function(e,t,i){"use strict";e.exports=a;var r=i(40);((a.prototype=Object.create(r.prototype)).constructor=a).className="Service";var s=i(82),o=i(4),n=i(127);function a(e,t){r.call(this,e,t),this.methods={},this._methodsArray=null}function d(e){return e._methodsArray=null,e}a.fromJSON=function(e,t){var i=new a(e,t.options);if(t.methods)for(var r=Object.keys(t.methods),o=0;o<r.length;++o)i.add(s.fromJSON(r[o],t.methods[r[o]]));return t.nested&&i.addJSON(t.nested),i.comment=t.comment,i},a.prototype.toJSON=function(e){var t=r.prototype.toJSON.call(this,e),i=!!e&&Boolean(e.keepComments);return o.toObject(["options",t&&t.options||void 0,"methods",r.arrayToJSON(this.methodsArray,e)||{},"nested",t&&t.nested||void 0,"comment",i?this.comment:void 0])},Object.defineProperty(a.prototype,"methodsArray",{get:function(){return this._methodsArray||(this._methodsArray=o.toArray(this.methods))}}),a.prototype.get=function(e){return this.methods[e]||r.prototype.get.call(this,e)},a.prototype.resolveAll=function(){for(var e=this.methodsArray,t=0;t<e.length;++t)e[t].resolve();return r.prototype.resolve.call(this)},a.prototype.add=function(e){if(this.get(e.name))throw Error("duplicate name '"+e.name+"' in "+this);return e instanceof s?(this.methods[e.name]=e,e.parent=this,d(this)):r.prototype.add.call(this,e)},a.prototype.remove=function(e){if(e instanceof s){if(this.methods[e.name]!==e)throw Error(e+" is not a member of "+this);return delete this.methods[e.name],e.parent=null,d(this)}return r.prototype.remove.call(this,e)},a.prototype.create=function(e,t,i){for(var r,s=new n.Service(e,t,i),a=0;a<this.methodsArray.length;++a){var d=o.lcFirst((r=this._methodsArray[a]).resolve().name).replace(/[^$\w_]/g,"");s[d]=o.codegen(["r","c"],o.isReserved(d)?d+"_":d)("return this.rpcCall(m,q,s,r,c)")({m:r,q:r.resolvedRequestType.ctor,s:r.resolvedResponseType.ctor})}return s}},function(e,t,i){"use strict";e.exports=o;var r=i(29);((o.prototype=Object.create(r.prototype)).constructor=o).className="Method";var s=i(4);function o(e,t,i,o,n,a,d,c,l){if(s.isObject(n)?(d=n,n=a=void 0):s.isObject(a)&&(d=a,a=void 0),void 0!==t&&!s.isString(t))throw TypeError("type must be a string");if(!s.isString(i))throw TypeError("requestType must be a string");if(!s.isString(o))throw TypeError("responseType must be a string");r.call(this,e,d),this.type=t||"rpc",this.requestType=i,this.requestStream=!!n||void 0,this.responseType=o,this.responseStream=!!a||void 0,this.resolvedRequestType=null,this.resolvedResponseType=null,this.comment=c,this.parsedOptions=l}o.fromJSON=function(e,t){return new o(e,t.type,t.requestType,t.responseType,t.requestStream,t.responseStream,t.options,t.comment,t.parsedOptions)},o.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return s.toObject(["type","rpc"!==this.type&&this.type||void 0,"requestType",this.requestType,"requestStream",this.requestStream,"responseType",this.responseType,"responseStream",this.responseStream,"options",this.options,"comment",t?this.comment:void 0,"parsedOptions",this.parsedOptions])},o.prototype.resolve=function(){return this.resolved?this:(this.resolvedRequestType=this.parent.lookupType(this.requestType),this.resolvedResponseType=this.parent.lookupType(this.responseType),r.prototype.resolve.call(this))}},function(e,t,i){"use strict";e.exports=s;var r=i(10);function s(e){if(e)for(var t=Object.keys(e),i=0;i<t.length;++i)this[t[i]]=e[t[i]]}s.create=function(e){return this.$type.create(e)},s.encode=function(e,t){return this.$type.encode(e,t)},s.encodeDelimited=function(e,t){return this.$type.encodeDelimited(e,t)},s.decode=function(e){return this.$type.decode(e)},s.decodeDelimited=function(e){return this.$type.decodeDelimited(e)},s.verify=function(e){return this.$type.verify(e)},s.fromObject=function(e){return this.$type.fromObject(e)},s.toObject=function(e,t){return this.$type.toObject(e,t)},s.prototype.toJSON=function(){return this.$type.toObject(this,r.toJSONOptions)}},function(e,t,i){"use strict";e.exports=u;var r=i(40);((u.prototype=Object.create(r.prototype)).constructor=u).className="Root";var s,o,n,a=i(21),d=i(8),c=i(41),l=i(4);function u(e){r.call(this,"",e),this.deferred=[],this.files=[]}function p(){}u.fromJSON=function(e,t){return t||(t=new u),e.options&&t.setOptions(e.options),t.addJSON(e.nested)},u.prototype.resolvePath=l.path.resolve,u.prototype.fetch=l.fetch,u.prototype.load=function e(t,i,r){"function"==typeof i&&(r=i,i=void 0);var s=this;if(!r)return l.asPromise(e,s,t,i);var a=r===p;function d(e,t){if(r){var i=r;if(r=null,a)throw e;i(e,t)}}function c(e){var t=e.lastIndexOf("google/protobuf/");if(t>-1){var i=e.substring(t);if(i in n)return i}return null}function u(e,t){try{if(l.isString(t)&&"{"===t.charAt(0)&&(t=JSON.parse(t)),l.isString(t)){o.filename=e;var r,n=o(t,s,i),u=0;if(n.imports)for(;u<n.imports.length;++u)(r=c(n.imports[u])||s.resolvePath(e,n.imports[u]))&&h(r);if(n.weakImports)for(u=0;u<n.weakImports.length;++u)(r=c(n.weakImports[u])||s.resolvePath(e,n.weakImports[u]))&&h(r,!0)}else s.setOptions(t.options).addJSON(t.nested)}catch(e){d(e)}a||f||d(null,s)}function h(e,t){if(!(s.files.indexOf(e)>-1))if(s.files.push(e),e in n)a?u(e,n[e]):(++f,setTimeout((function(){--f,u(e,n[e])})));else if(a){var i;try{i=l.fs.readFileSync(e).toString("utf8")}catch(e){return void(t||d(e))}u(e,i)}else++f,s.fetch(e,(function(i,o){--f,r&&(i?t?f||d(null,s):d(i):u(e,o))}))}var f=0;l.isString(t)&&(t=[t]);for(var m,g=0;g<t.length;++g)(m=s.resolvePath("",t[g]))&&h(m);if(a)return s;f||d(null,s)},u.prototype.loadSync=function(e,t){if(!l.isNode)throw Error("not supported");return this.load(e,t,p)},u.prototype.resolveAll=function(){if(this.deferred.length)throw Error("unresolvable extensions: "+this.deferred.map((function(e){return"'extend "+e.extend+"' in "+e.parent.fullName})).join(", "));return r.prototype.resolveAll.call(this)};var h=/^[A-Z]/;function f(e,t){var i=t.parent.lookup(t.extend);if(i){var r=new a(t.fullName,t.id,t.type,t.rule,void 0,t.options);return r.declaringField=t,t.extensionField=r,i.add(r),!0}return!1}u.prototype._handleAdd=function(e){if(e instanceof a)void 0===e.extend||e.extensionField||f(0,e)||this.deferred.push(e);else if(e instanceof d)h.test(e.name)&&(e.parent[e.name]=e.values);else if(!(e instanceof c)){if(e instanceof s)for(var t=0;t<this.deferred.length;)f(0,this.deferred[t])?this.deferred.splice(t,1):++t;for(var i=0;i<e.nestedArray.length;++i)this._handleAdd(e._nestedArray[i]);h.test(e.name)&&(e.parent[e.name]=e)}},u.prototype._handleRemove=function(e){if(e instanceof a){if(void 0!==e.extend)if(e.extensionField)e.extensionField.parent.remove(e.extensionField),e.extensionField=null;else{var t=this.deferred.indexOf(e);t>-1&&this.deferred.splice(t,1)}}else if(e instanceof d)h.test(e.name)&&delete e.parent[e.name];else if(e instanceof r){for(var i=0;i<e.nestedArray.length;++i)this._handleRemove(e._nestedArray[i]);h.test(e.name)&&delete e.parent[e.name]}},u._configure=function(e,t,i){s=e,o=t,n=i}},function(e,t){var i={utf8:{stringToBytes:function(e){return i.bin.stringToBytes(unescape(encodeURIComponent(e)))},bytesToString:function(e){return decodeURIComponent(escape(i.bin.bytesToString(e)))}},bin:{stringToBytes:function(e){for(var t=[],i=0;i<e.length;i++)t.push(255&e.charCodeAt(i));return t},bytesToString:function(e){for(var t=[],i=0;i<e.length;i++)t.push(String.fromCharCode(e[i]));return t.join("")}}};e.exports=i},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Play=void 0;const s=i(3),o=i(146),n=r(i(1)),a=r(i(0)),d=i(2),c=i(43);class l extends s.EventEmitter{constructor(e){super(),this.videoSize={width:0,height:0},this.screenSize={width:0,height:0},this._reset(),this.stream=e.stream,this.logger=e.stream.logger.getChild(()=>{var e;let t="player";return(null===(e=this.audioDom)||void 0===e?void 0:e.paused)&&(t+=" audio_paused"),this.stream._play!==this&&(t+=" DETACHED"),t}),this.videoDom=null,this.screenDom=null,this.audioDom=null,this.videoContainerDom=null,this.screenContainerDom=null,this.videoView=null,this.screenView=null,this.volume=null,this.index=0,this.videoRenderMode={width:0,height:0,cut:!1},this.screenRenderMode={width:0,height:0,cut:!1},this.audioSinkId="",this._watermarkControl=o.createWatermarkControl(this.logger),this._watermarkControlScreen=o.createWatermarkControl(this.logger),this.autoPlayType=0}_reset(){this.videoDom=null,this.screenDom=null,this.videoContainerDom=null,this.screenContainerDom=null,this.videoView=null,this.screenView=null,this.audioDom=null,this.volume=null,this.index=0,this.videoRenderMode={width:0,height:0,cut:!1},this.screenRenderMode={width:0,height:0,cut:!1}}_initNodeVideo(){if(this._initVideoContainer(),this._initVideo(),this.videoDom&&this.videoContainerDom){if(this.videoContainerDom==this.videoDom.parentNode)return void this.logger.log("Play: _initVideoNode: 节点已挂载，请勿重复挂载");this.videoContainerDom.appendChild(this.videoDom),this.logger.log("Play: _initVideoNode, videoContainerDom: ",this.videoContainerDom.outerHTML)}}_initNodeScreen(){if(this._initScreenContainer(),this._initScreen(),this.screenDom&&this.screenContainerDom){if(this.screenContainerDom==this.screenDom.parentNode)return void this.logger.log("Play: _initscreenNode: 节点已挂载，请勿重复挂载");this.screenContainerDom.appendChild(this.screenDom),this.logger.log("Play: _initscreenNode, screenContainerDom: ",this.screenContainerDom.outerHTML)}}_initVideoContainer(){this.videoView&&(this.videoContainerDom||(this.videoContainerDom=document.createElement("div"),this.videoContainerDom.className="nertc-video-container",this.videoContainerDom.style.overflow="hidden",this.videoContainerDom.style.position="relative",this.videoContainerDom.style.width=this.videoView.clientWidth+"px",this.videoContainerDom.style.height=this.videoView.clientHeight+"px",this.videoContainerDom.style.display="inline-block"))}_initScreenContainer(){this.screenContainerDom||(this.screenContainerDom=document.createElement("div"),this.screenContainerDom.className="nertc-screen-container",this.screenContainerDom.style.overflow="hidden",this.screenContainerDom.style.position="relative",this.screenContainerDom.style.width=this.screenRenderMode.width+"px",this.screenContainerDom.style.height=this.screenRenderMode.height+"px",this.screenContainerDom.style.display="inline-block")}_initVideo(){this.videoDom||(this.videoDom=document.createElement("video"),this.videoDom.style.position="absolute",this.videoDom.style.left="50%",this.videoDom.style.top="50%",this.videoDom.style.transform="translate(-50%,-50%)",this.videoDom.setAttribute("x-webkit-airplay","x-webkit-airplay"),this.videoDom.setAttribute("playsinline","playsinline"),this.videoDom.setAttribute("webkit-playsinline","webkit-playsinline"),this.videoDom.preload="auto",this.videoDom.dataset.uid=""+this.stream.getId(),this.videoDom.autoplay=!0,this.videoDom.muted=!0,this.videoSize.width=0,this.videoSize.height=0,this.videoDom.addEventListener("resize",e=>{if(!this.videoDom||this.videoDom!==e.target)return;const t=this.videoDom.videoWidth,i=this.videoDom.videoHeight;t===this.videoSize.width&&i===this.videoSize.height||(this.logger.log(`主流视频分辨率发生变化：${this.videoSize.width}x${this.videoSize.height} => ${t}x${i}。当前父节点：${c.getDomInfo(this.videoView)}`),t>i&&this.videoSize.width>this.videoSize.height||t<i&&this.videoSize.width<this.videoSize.height||this.setVideoRender(),this.videoSize.width=t,this.videoSize.height=i)}),d.getParameters().controlOnPaused&&(this.videoDom.addEventListener("pause",this.showControlIfVideoPause.bind(this)),this.videoDom.addEventListener("play",this.handleVideoScreenPlay.bind(this)),this.videoDom.addEventListener("click",this.handleVideoScreenClick.bind(this))))}showControlIfVideoPause(){this.videoDom&&this.videoDom.paused&&(this.logger.log("可能遇到了自动播放问题，展示默认控件:","video"),this.videoDom.setAttribute("controls","controls")),this.screenDom&&this.screenDom.paused&&(this.logger.log("可能遇到了自动播放问题，展示默认控件:","screen"),this.screenDom.setAttribute("controls","controls"))}handleVideoScreenClick(){this.audioDom&&this.audioDom.paused&&(this.logger.log("侦测到视频点击，尝试恢复音频播放"),this.audioDom.play())}handleVideoScreenPlay(){this.videoDom&&!this.videoDom.paused&&this.videoDom.hasAttribute("controls")&&(this.logger.log("侦测到视频播放，隐藏默认控件:"),this.videoDom.removeAttribute("controls")),this.screenDom&&!this.screenDom.paused&&this.screenDom.hasAttribute("controls")&&(this.logger.log("侦测到辅流播放，隐藏默认控件:"),this.screenDom.removeAttribute("controls"))}_initScreen(){this.screenDom||(this.screenDom=document.createElement("video"),this.screenDom.style.position="absolute",this.screenDom.style.left="50%",this.screenDom.style.top="50%",this.screenDom.style.transform="translate(-50%,-50%)",this.screenDom.setAttribute("x-webkit-airplay","x-webkit-airplay"),this.screenDom.setAttribute("playsinline","playsinline"),this.screenDom.setAttribute("webkit-playsinline","webkit-playsinline"),this.screenDom.preload="auto",this.screenDom.dataset.uid=""+this.stream.getId(),this.screenDom.autoplay=!0,this.screenDom.muted=!0,this.screenSize.width=0,this.screenSize.height=0,this.screenDom.addEventListener("resize",e=>{if(!this.screenDom||this.screenDom!==e.target)return;const t=this.screenDom.videoWidth,i=this.screenDom.videoHeight;t===this.screenSize.width&&i===this.screenSize.height||(this.logger.log(`辅流视频分辨率发生变化：${this.screenSize.width}x${this.screenSize.height} => ${t}x${i}`),t>i&&this.screenSize.width>this.screenSize.height||t<i&&this.screenSize.width<this.screenSize.height||this.setScreenRender(),this.screenSize.width=t,this.screenSize.height=i)}),d.getParameters().controlOnPaused&&(this.screenDom.addEventListener("pause",this.showControlIfVideoPause.bind(this)),this.screenDom.addEventListener("play",this.handleVideoScreenPlay.bind(this)),this.screenDom.addEventListener("click",this.handleVideoScreenClick.bind(this))))}_removeUselessDom(){if(!this.videoView)return;for(var e=this.videoView.children.length-1;e>=0;e--)this.videoView.children[e].outerHTML.indexOf("data-uid=")&&(this.logger.log("删除多余的节点: ",this.videoView.children[e].outerHTML),this.videoView.removeChild(this.videoView.children[e]))}_mountVideoToDom(){if(this.videoContainerDom){if(this.videoView==this.videoContainerDom.parentNode)return void this.logger.log("Play: _mountVideoToDom: 节点已挂载，请勿重复挂载");this.logger.log("Play: _mountVideoToDom: videoContainerDom: ",this.videoContainerDom.outerHTML),this.videoView&&(this.videoView.appendChild(this.videoContainerDom),this.logger.log("视频主流dom节点挂载成功。父节点："+c.getDomInfo(this.videoView)),this._watermarkControl.start(this.videoContainerDom))}}_mountScreenToDom(){if(this.screenContainerDom){if(this.screenView==this.screenContainerDom.parentNode)return void this.logger.log("Play: _mountScreenToDom: 节点已挂载，请勿重复挂载");this.logger.log("Play: _mountScreenToDom: screenContainerDom: ",this.screenContainerDom.outerHTML),this.screenView&&(this.screenView.appendChild(this.screenContainerDom),this.logger.log("视频辅流dom节点挂载成功。父节点："+c.getDomInfo(this.screenView)),this._watermarkControlScreen.start(this.screenContainerDom))}}async resume(){const e=this.audioDom&&this.audioDom.paused,t=this.videoDom&&this.videoDom.paused,i=this.screenDom&&this.screenDom.paused,r=[];this.audioDom&&this.audioDom.paused&&r.push(this.audioDom.play()),this.videoDom&&this.videoDom.paused&&r.push(this.videoDom.play()),this.screenDom&&this.screenDom.paused&&r.push(this.screenDom.play());try{await Promise.all(r)}catch(e){if(this.logger.error("恢复播放 出现问题:",e.name,e.message),"notAllowedError"===e.name||"NotAllowedError"===e.name)throw new n.default({code:a.default.AUTO_PLAY_NOT_ALLOWED,message:e.message})}e&&this.logger.log("恢复播放音频"+(this.audioDom&&!this.audioDom.paused?"成功":"失败")),t&&this.logger.log("恢复播放视频"+(this.videoDom&&!this.videoDom.paused?"成功":"失败")),i&&this.logger.log("恢复播放辅流"+(this.screenDom&&!this.screenDom.paused?"成功":"失败"))}async playAudioStream(e,t){if(!e)return;if(this.audioDom||(this.audioDom=document.createElement("audio")),this.audioDom.muted=!!t,this.audioDom.srcObject=e,this.audioSinkId&&e.getAudioTracks().length)try{this.logger.log("音频尝试使用输出设备",this.audioSinkId),await this.audioDom.setSinkId(this.audioSinkId),this.logger.log("音频使用输出设备成功",this.audioSinkId)}catch(e){this.logger.error("音频输出设备切换失败",e.name,e.message,e)}if(!e.active)return;await this.isPlayAudioStream()&&this.logger.log("音频播放正常");try{this.audioDom.muted=!1,await this.audioDom.play(),this.logger.log("播放音频完成，当前播放状态:",this.audioDom&&this.audioDom.played&&this.audioDom.played.length)}catch(e){if(this.logger.warn("播放音频出现问题: ",e.name,e.message,e),"notAllowedError"===e.name||"NotAllowedError"===e.name)throw this.autoPlayType=1,new n.default({code:a.default.AUTO_PLAY_NOT_ALLOWED,message:e.toString(),url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082"})}}async stopPlayAudioStream(){this.audioDom&&(this.audioDom.muted=!0)}setPlayVolume(e){this.volume=e,this.audioDom&&(this.audioDom.volume=e/255)}async isPlayAudioStream(e=!0){const t=async e=>{if(e&&await new Promise(t=>{setTimeout(t,e)}),this.audioDom){let e=this.audioDom.played.length;return e>=1?this.audioDom.played.end(e-1):0}return 0};if(!this.audioDom||!this.audioDom.srcObject)return!e;const i=await t(0);if(!i)return!1;this.logger.log("firstTimeRanges: ",i);const r=await t(500);return!!r&&(this.logger.log("secondTimeRanges: ",r),r>i)}async isPlayVideoStream(e=!0){const t=async e=>(e&&await new Promise(t=>{setTimeout(t,e)}),this.videoDom&&this.videoDom.srcObject&&this.videoDom.getVideoPlaybackQuality()?this.videoDom.getVideoPlaybackQuality().totalVideoFrames:0);if(!this.videoDom||!this.videoDom.srcObject)return!e;const i=await t(0);return await t(100)>i}async isPlayScreenStream(e=!0){const t=async e=>(e&&await new Promise(t=>{setTimeout(t,e)}),this.screenDom&&this.screenDom.srcObject&&this.screenDom.getVideoPlaybackQuality()?this.screenDom.getVideoPlaybackQuality().totalVideoFrames:0);if(!this.screenDom||!this.screenDom.srcObject)return!e;const i=await t(0);return await t(100)>i}async isPlayStreamError(e){switch(e){case"audio":return this.isPlayAudioStream(!0);case"video":return this.isPlayVideoStream(!0);case"screen":return this.isPlayScreenStream(!0);default:return!0}}async playVideoStream(e,t){var i;if(e&&t)if((null===(i=this.videoDom)||void 0===i?void 0:i.srcObject)!==e)if(this.videoView=t,this._initNodeVideo(),this._mountVideoToDom(),this.videoDom)try{const t=e.getVideoTracks()[0];t?this.logger.log(`开始加载主流播放视频源：视频参数 "${t.label}",enabled ${t.enabled} , ${JSON.stringify(t.getSettings())}`):this.logger.error("加载主流播放视频源失败：没有视频源"),this.videoDom.srcObject=e,this.videoDom.play().then(()=>{var e,t,i,r,s;this.logger.log(`成功加载主流播放视频源：当前视频实际分辨率${null===(e=this.videoDom)||void 0===e?void 0:e.videoWidth}x${null===(t=this.videoDom)||void 0===t?void 0:t.videoHeight}，显示宽高${null===(i=this.videoDom)||void 0===i?void 0:i.offsetWidth}x${null===(r=this.videoDom)||void 0===r?void 0:r.offsetHeight}`),(null===(s=this.videoDom)||void 0===s?void 0:s.paused)&&d.getParameters().controlOnPaused&&this.showControlIfVideoPause()}).catch(e=>{"AbortError"===e.name||console.error(e)})}catch(e){if(this.logger.warn("播放视频出现问题:",e.name,e.message,e),"notAllowedError"===e.name||"NotAllowedError"===e.name)throw this.autoPlayType=2,new n.default({code:a.default.AUTO_PLAY_NOT_ALLOWED,message:e.toString(),url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082"})}else this.logger.error("没有视频源");else this.logger.log("playVideoStream：跳过重复的播放请求")}async playScreenStream(e,t){var i;if(e&&t)if((null===(i=this.screenDom)||void 0===i?void 0:i.srcObject)!==e)if(this.logger.log(`播放辅流视频, id: ${e.id}, active state: ${e.active}`),this.screenView=t,this._initNodeScreen(),this._mountScreenToDom(),this.screenDom)try{const t=e.getVideoTracks()[0];t?this.logger.log(`开始加载辅流播放视频源：视频参数 "${t.label}",enabled ${t.enabled} , ${JSON.stringify(t.getSettings())}`):this.logger.error("加载主流播放视频源失败：没有视频源"),this.screenDom.srcObject=e,this.screenDom.play().then(()=>{var e,t,i,r,s;this.logger.log(`成功加载辅流播放视频源：当前视频实际分辨率${null===(e=this.screenDom)||void 0===e?void 0:e.videoWidth}x${null===(t=this.screenDom)||void 0===t?void 0:t.videoHeight}，显示宽高${null===(i=this.screenDom)||void 0===i?void 0:i.offsetWidth}x${null===(r=this.screenDom)||void 0===r?void 0:r.offsetHeight}`),(null===(s=this.screenDom)||void 0===s?void 0:s.paused)&&d.getParameters().controlOnPaused&&this.showControlIfVideoPause()})}catch(e){this.logger.warn("播放辅流出现问题: ",e.name,e.message,e)}else this.logger.error("辅流没有视频源");else this.logger.log("playScreenStream：跳过重复的播放请求")}async stopPlayVideoStream(){if(this.logger.log("stopPlayVideoStream 停止播发视频"),this.videoContainerDom&&this.videoDom){this.videoContainerDom==this.videoDom.parentNode?(this.logger.log("清除 videoDom"),this.videoContainerDom.removeChild(this.videoDom)):this.videoContainerDom.lastChild&&(this.logger.log("videoContainerDom 删除子节点"),this.videoContainerDom.removeChild(this.videoContainerDom.lastChild));try{this.videoDom.remove(),this.videoDom.srcObject=null,this.videoDom=null}catch(e){this.logger.log("stopPlayVideoStream e: ",e)}}this.videoView&&this.videoContainerDom&&(this.videoView==this.videoContainerDom.parentNode?(this.logger.log("清除 videoContainerDom"),this.videoView.removeChild(this.videoContainerDom)):this.videoView.lastChild&&(this.logger.log("videoView 删除子节点"),this.videoView.removeChild(this.videoView.lastChild),this.videoView.innerHTML=""),this.videoContainerDom=null,this.videoView=null)}async stopPlayScreenStream(){if(this.logger.log("stopPlayScreenStream: 停止播发屏幕共享"),this.screenContainerDom&&this.screenDom){this.screenContainerDom.removeChild(this.screenDom);try{this.screenDom.remove(),this.screenDom.srcObject=null,this.screenDom=null}catch(e){this.logger.log("stopPlayScreenStream: 停止播发屏幕共享",e.name,e.message)}}this.screenView&&this.screenContainerDom&&(this.screenView.removeChild(this.screenContainerDom),this.screenContainerDom=null,this.screenView=null)}setVideoRender(e){if(!this.videoDom)return;if(e?(this.logger.log("setVideoRender options: "+JSON.stringify(e)),this.videoRenderMode=Object.assign({},e)):(e=this.videoRenderMode,this.logger.log("setVideoRender: existing videoRenderMode: "+JSON.stringify(e))),this.videoContainerDom?(this.videoContainerDom.style.width=e.width+"px",this.videoContainerDom.style.height=e.height+"px"):this.logger.error("未找到videoContainerDom"),!e.cut)return this.videoDom.style.height="100%",void(this.videoDom.style.width="100%");this.videoDom.videoWidth/this.videoDom.videoHeight>e.width/e.height?(this.videoDom.style.width="auto",this.videoDom.style.height="100%"):(this.videoDom.style.width="100%",this.videoDom.style.height="auto")}setScreenRender(e){if(!this.screenDom)return;if(e?(this.logger.log("setScreenRender: options: ",JSON.stringify(e,null," ")),this.screenRenderMode=Object.assign({},e)):(e=this.screenRenderMode,this.logger.log("setScreenRender, existing screenRenderMode: "+JSON.stringify(e))),this.screenRenderMode=e,this.screenContainerDom?(this.screenContainerDom.style.width=e.width+"px",this.screenContainerDom.style.height=e.height+"px"):this.logger.error("未找到screenContainerDom"),!e.cut)return this.screenDom.style.height="100%",void(this.screenDom.style.width="100%");this.screenDom.videoWidth/this.screenDom.videoHeight>e.width/e.height?(this.screenDom.style.width="auto",this.screenDom.style.height="100%"):(this.screenDom.style.width="100%",this.screenDom.style.height="auto")}async setAudioOutput(e){var t,i;this.audioSinkId=e,(null===(t=this.audioDom)||void 0===t?void 0:t.srcObject)&&(null===(i=this.audioDom)||void 0===i?void 0:i.srcObject).getAudioTracks().length&&(await this.audioDom.setSinkId(e),this.logger.log("设置通话音频输出设备成功"))}async takeSnapshot(e,t){let i=!e.mediaType&&this.videoDom||"video"===e.mediaType,r=!e.mediaType&&this.screenDom||"screen"===e.mediaType,s=document.createElement("canvas"),o=s.getContext("2d");if(!o)throw new n.default({code:a.default.NOT_FOUND,message:"no context of canvas"});if(i){const i=e.name||(t||this.stream.getId())+"-"+this.index++;if(o.fillStyle="#ffffff",!this.videoDom)throw new n.default({code:a.default.NOT_FOUND,message:"no videoDom"});o.fillRect(0,0,this.videoDom.videoWidth,this.videoDom.videoHeight),s.width=this.videoDom.videoWidth,s.height=this.videoDom.videoHeight,o.drawImage(this.videoDom,0,0,this.videoDom.videoWidth,this.videoDom.videoHeight,0,0,this.videoDom.videoWidth,this.videoDom.videoHeight);const d=await new Promise((e,t)=>{s.toBlob(t=>{this.logger.log("takeSnapshot, 获取到截图的blob: ",t);let r=URL.createObjectURL(t);this.logger.log("截图的url: ",r);let s=document.createElement("a");document.body.appendChild(s),s.style.display="none",s.href=r,s.download=i+".png",s.click(),window.URL.revokeObjectURL(r),e(i+".png")})});if(!r)return d}if(r){const i=e.name||(t||this.stream.getId())+"-"+this.index++;if(o.fillStyle="#ffffff",!this.screenDom)throw new n.default({code:a.default.NOT_FOUND,message:"no screenDom"});o.fillRect(0,0,this.screenDom.videoWidth,this.screenDom.videoHeight),s.width=this.screenDom.videoWidth,s.height=this.screenDom.videoHeight,o.drawImage(this.screenDom,0,0,this.screenDom.videoWidth,this.screenDom.videoHeight,0,0,this.screenDom.videoWidth,this.screenDom.videoHeight);return await new Promise((e,t)=>{s.toBlob(t=>{this.logger.log("takeSnapshot, 获取到截图的blob: ",t);let r=URL.createObjectURL(t);this.logger.log("截图的url: ",r);let s=document.createElement("a");document.body.appendChild(s),s.style.display="none",s.href=r,s.download=i+".png",s.click(),window.URL.revokeObjectURL(r),e(i+".png")})})}}destroy(){this.stopPlayAudioStream(),this.stopPlayVideoStream(),this.stopPlayScreenStream(),this._reset()}}t.Play=l},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Record=void 0;const s=i(3),o=r(i(1)),n=r(i(0));class a extends s.EventEmitter{constructor(e){super(),this._status={recordedChunks:[],isRecording:!1,stream:null,option:null,contentTypes:[],mimeType:"",audioController:null,opStream:null,state:"init",timer:null,fileName:null,recordId:0,recordStatus:"init",recordUrl:null,startTime:null,endTime:null},this._recorder=null,this.logger=e.logger.getChild(()=>"recorder "+this._status.recordStatus),this._reset(),this.stream=e.stream}async start(e){const{stream:t=null,uid:i="0",type:r="video",reset:s=!1}=e;this.logger.log("开始本地录制: ",JSON.stringify(e,null,""));let a=null;if(window.MediaRecorder&&MediaRecorder.isTypeSupported||(this.logger.log("浏览器不支持本地录制"),a="RecordBrowserNotSupport"),this._status.isRecording&&(this.logger.log("当前正在录制中"),a="RecordInRecording"),this._status.recordUrl&&"downloaded"!==this._status.recordStatus&&(e.reset?(this.logger.warn("MediaRecordHelper: start: 存在未下载视频，强制清除..."),await this.clean()):(this.logger.log("MediaRecordHelper: start : 请先下载或重置上一段录制文件"),a="RecordFileExsit")),a)return this.stream.client.apiFrequencyControl({name:"startMediaRecording",code:-1,param:JSON.stringify({reason:a,uid:i,mediaType:r,recordName:""},null," ")}),a;this._status.stream=t,this._status.option=e,this._status.fileName=`${this._status.option.uid}--${this._getTimeStamp()}--${this._status.option.type||"video"}`,this._status.startTime=this._getTimeStamp();let d=["video/mp4;codecs=opus","video/webm","video/webm;codecs=h264","video/x-matroska;codecs=opus","video/invalid"];if("audio"===e.type&&(d=["audio/wav","audio/ogg","audio/pcm","audio/webm"]),!(this._status.mimeType=this._validation(d)[0]))return"RecordBrowserNotSupport";try{await this._format(),await this._start(),this.stream.client.apiFrequencyControl({name:"startMediaRecording",code:0,param:JSON.stringify({uid:i,mediaType:r,recordName:""},null," ")})}catch(e){return this.logger.error("录制start error： ",e.name,e.message,e),this.stream.client.apiFrequencyControl({name:"startMediaRecording",code:-1,param:JSON.stringify({reason:"录制接口 error",uid:i,mediaType:r,recordName:""},null," ")}),Promise.reject(new o.default({code:n.default.RECORD_API_ERROR,message:"record api error"}))}}stop(e){let t=null;return this._status.isRecording&&this._recorder||(this.logger.log("当前没有进行录制"),t="RecordNotExist"),this._recorder&&"started"!==this._status.state&&(this.logger.warn("MediaRecordHelper: record stopping when "+this._recorder.state),t="RecordStateError"),t?(e&&!1===e.isUser||this.stream.client.apiFrequencyControl({name:"stopMediaRecording",code:-1,param:""}),Promise.resolve()):(this._status.state="stopped",this._status.recordStatus="stopping",new Promise((t,i)=>{if(!this._recorder)return i(new o.default({code:n.default.NO_RECORDER_FOUND,message:"no record found"}));this._status.fileName=this._status.fileName,this._recorder.onstop=()=>{this._onStop(t)},this._recorder.stop(),this.stream.client.apiFrequencyControl({name:"stopMediaRecording",code:0,param:""}),e&&e.isUser&&this.stream.client.apiFrequencyControl({name:"stopMediaRecording",code:-1,param:""})}))}play(e){return"stopped"!==this._status.state?(this.stream.client.apiFrequencyControl({name:"playMediaRecording",code:-1,param:JSON.stringify({reason:"RecordStateError"},null," ")}),this.logger.warn("MediaRecordHelper: record stopping when "+(this._recorder&&this._recorder.state)),Promise.resolve()):(this.stream.client.apiFrequencyControl({name:"playMediaRecording",code:0,param:JSON.stringify({recordId:""},null," ")}),this._play(e))}download(e=!0){return Promise.resolve().then(()=>this._status.isRecording?(this.logger.log("MediaRecordHelper: download: 正在录制中，立即停止..."),this.stop({isUser:!1})):Promise.resolve()).then(()=>{if(this._status.recordUrl){const e=document.createElement("a");document.body.appendChild(e),e.style.display="none",e.href=this._status.recordUrl,e.download=(this._status.fileName||this._getTimeStamp())+".webm",e.click(),this._status.recordStatus="downloaded"}else this.logger.log("MediaRecordHelper: download: cannot download media without url ...");return e&&this.stream.client.apiFrequencyControl({name:"downloadMediaRecording",code:0,param:""}),Promise.resolve(this._status)})}async clean(){this.stream.client.apiFrequencyControl({name:"cleanMediaRecording",code:0,param:""}),this._status.isRecording&&this._recorder&&await this.stop(),this._status.recordUrl&&(window.URL.revokeObjectURL(this._status.recordUrl),this._status.recordUrl=null),this._destroy(),this._status.recordStatus="init"}leave(e={uid:0}){if(!this._status.isRecording||!this._recorder)return Promise.resolve();const{uid:t}=e;return t&&this._status.option?t===+this._status.option.uid?this.stop():void 0:Promise.resolve()}pause(){this._recorder&&this._recorder.pause()}resume(){this._recorder&&this._recorder.resume()}_reset(){this._recorder=null,Object.assign(this._status,{recordedChunks:[],isRecording:!1,stream:null,option:null,contentTypes:[],mimeType:"",audioController:null,opStream:null,state:"init",timer:null,fileName:null,recordId:0,recordStatus:"init",recordUrl:null,startTime:null,endTime:null})}_getTimeStamp(){return Math.floor(Date.now()/1e3)}_validation(e){return e.filter(e=>MediaRecorder.isTypeSupported(e))}_format(){let e=this._status.stream;this._status.option;return new Promise((t,i)=>{let r=new MediaStream;if(!e)return i(new o.default({code:n.default.NOT_DEFINED,message:"stream not defined"}));if(this._matchLocalStreamConstructor(e.constructor.toString())&&(e=[e]),Array.isArray(e)){if(e.forEach(e=>{e&&this._matchLocalStreamConstructor(e.constructor.toString())&&e.getTracks().forEach(e=>{r.addTrack(e)})}),0===r.getTracks().length)return this.logger.error("_format: No tracks available"),t(r);this._status.opStream=r,t(r)}})}_matchLocalStreamConstructor(e){return/(LocalMediaStream|MediaStream)/.test(e)}_start(){let e={audioBitsPerSecond:128e3,videoBitsPerSecond:25e5,mimeType:this._status.mimeType};if(!this._status.opStream)return Promise.reject(new o.default({code:n.default.NOT_AVALIABLE,message:"no stream avaliable"}));const t=this._status.opStream.getAudioTracks();let i;i=t.length>1?new MediaStream([t[0]]):this._status.opStream;let r=this._recorder=new MediaRecorder(i,e);return r.ondataavailable=this._onDataAvailable.bind(this),r.onstop=()=>{this.logger.log("MediaRecordHelper: _start: record stop automatically ..."),this._onStop()},this._status.recordUrl&&(window.URL.revokeObjectURL(this._status.recordUrl),this._status.recordUrl=null),this._status.recordedChunks=[],this._status.isRecording=!0,this._status.state="started",this._status.recordId+=1,this._status.recordStatus="starting",this._recorder.start(),this._clearTimer(),this._startTimer(),Promise.resolve(this._status.option)}_startTimer(){this._status.timer||(this._status.timer=setInterval(()=>{this.logger.log(`MediaRecordHelper: startTimer: ${(new Date).toLocaleString()} --\x3e MediaRecorder status: ${this._recorder&&this._recorder.state}`)},5e3))}_onStop(e){this.logger.log("MediaRecordHelper: _onStop: record stoped !!!"),this._clearTimer(),this._status.recordStatus="stopped",this._status.isRecording=!1,this._status.endTime=this._getTimeStamp();let t=new Blob(this._status.recordedChunks,{type:this._status.mimeType});this._status.recordUrl=URL.createObjectURL(t),this.emit("stop",this.getRecordStatus()),e&&e(this._status.recordUrl)}_play(e){let t=null;if(-1!=this._status.mimeType.indexOf("audio"))t=document.createElement("audio");else{if(-1==this._status.mimeType.indexOf("video"))return Promise.reject(new o.default({code:n.default.NOT_SUPPORT,message:"Unsupported MIME type "+this._status.mimeType}));t=document.createElement("video"),t.autoplay=!0}return this._status.recordUrl?(e.appendChild(t),t.srcObject=null,t.src=this._status.recordUrl,t.controls=!1,t.play(),Promise.resolve(this._status.option)):Promise.reject(new o.default({code:n.default.NOT_DEFINED,message:"record url is unfefined"}))}async _destroy(){this._status.audioController&&this._status.audioController.destroy(),this._status.isRecording&&await this.stop({isUser:!1}),this._clearTimer(),this._recorder=null,Object.assign(this._status,{stream:null,recordedChunks:[],isRecording:!1,audioController:null,status:"init"})}_clearTimer(){this._status.timer&&(clearInterval(this._status.timer),this._status.timer=null)}_onDataAvailable(e){if(this._status.recordStatus="recording",this.logger.log("MediaRecordHelper: ondataavailable: data received"),!(e.data.size>0))return this.logger.warn("MediaRecordHelper: ondataavailable: no data"),void this.stop();this._status.recordedChunks.push(e.data)}checkIsRecording(){return this._status.isRecording}getRecordStatus(){const e=Object.assign({id:this._status.recordId,type:this._status.mimeType,name:this._status.fileName,status:this._status.recordStatus,isRecording:this._status.isRecording,startTime:this._status.startTime,endTime:this._status.endTime},this._status.option);return this.stream.client.apiFrequencyControl({name:"listMediaRecording",code:0,param:""}),e}destroy(){this._destroy()}}t.Record=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlatformType=t.PlatformTypeMap=void 0,t.PlatformTypeMap={"-1":"unknown",1:"aos",2:"ios",4:"pc",8:"winphone",9:"mac",16:"web"},function(e){e[e.unknown=-1]="unknown",e[e.aos=1]="aos",e[e.ios=2]="ios",e[e.pc=4]="pc",e[e.winphone=8]="winphone",e[e.mac=9]="mac",e[e.web=16]="web"}(t.PlatformType||(t.PlatformType={}))},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MediaHelper=void 0;const a=i(3),d=o(i(44)),c=i(90),l=i(27),u=i(91),p=i(53),h=i(23),f=i(44),m=n(i(1)),g=n(i(0)),v=i(2),y=i(26),_=i(7),S=i(25);class b extends a.EventEmitter{constructor(e){super(),this.audio={audioStream:new MediaStream,audioSourceStream:new MediaStream,musicStream:new MediaStream,micStream:new MediaStream,audioSource:null,micTrack:null,deviceInfo:{mic:{label:""}},webAudio:null,micConstraint:null,mixAudioConf:{index:0,audioBuffer:{},sounds:{}},audioRoutingEnabled:!1},this.video={videoStream:new MediaStream,videoTrackLow:null,cameraTrack:null,cameraConstraint:{video:{}},videoSource:null,captureConfig:{high:{width:640,height:480,frameRate:15}},encoderConfig:{high:{maxBitrate:3e5},low:{maxBitrate:1e5}}},this.screen={screenVideoStream:new MediaStream,screenVideoTrackLow:null,screenVideoTrack:null,screenVideoSource:null,captureConfig:{high:{width:640,height:480,frameRate:15}},encoderConfig:{high:{maxBitrate:4e5},low:{maxBitrate:2e5}}},this.screenAudio={screenAudioStream:new MediaStream,screenAudioTrack:null,screenAudioSource:null},this.listenToTrackEnded=e=>{e&&e.addEventListener("ended",()=>{this.logger.log("Track ended",e.label,e.id),this.stream===this.stream.client.adapterRef.localStream&&(e!==this.audio.micTrack&&e!==this.audio.audioSource||(this.logger.warn("音频轨道已停止"),this.stream.client.safeEmit("audioTrackEnded")),e!==this.video.cameraTrack&&e!==this.video.videoSource||(this.logger.warn("视频轨道已停止"),this.stream.client.safeEmit("videoTrackEnded")),(e===this.screen.screenVideoTrack||e===this.screen.screenVideoSource||e.label.indexOf("screen")>-1||e.label.indexOf("window")>-1||e.label.indexOf("web-")>-1)&&(this.logger.warn("屏幕共享已停止"),this.stream.client.safeEmit("stopScreenSharing")),e===this.screenAudio.screenAudioTrack&&(this.logger.warn("屏幕共享音频已停止"),this.stream.client.safeEmit("stopScreenAudio")))})},this.stream=e.stream,this.logger=e.stream.logger.getChild(()=>{var e;let t="mediaHelper";return this.audio.audioRoutingEnabled&&(t+=" WebAudio"),this.audio.webAudio&&(this.audio.webAudio.context&&"running"!==this.audio.webAudio.context.state&&(t+=" "+this.audio.webAudio.context.state),this.audio.webAudio.mixAudioConf.state!==u.AuidoMixingState.UNSTART&&(t+=" "+(null===(e=this.audio.webAudio)||void 0===e?void 0:e.mixAudioConf.state))),this.stream.mediaHelper!==this&&(t+="DETACHED"),t}),y.Device.on("recording-device-changed",e=>{if(this.audio.micTrack&&this.audio.deviceInfo.mic.deviceId===e.device.deviceId)if("INACTIVE"===e.state)this.logger.error("当前使用的麦克风设备被移除，需重新启用设备",e.device),this.stream.emit("recording-device-changed",e);else{y.Device.deviceHistory.audioIn.find(e=>{e.groupId,this.audio.deviceInfo.mic.groupId})||(this.logger.error(`当前麦克风已由【${this.audio.deviceInfo.mic.label}】切换至【${e.device.label}】，可能会影响通话质量`),this.audio.deviceInfo.mic.label=e.device.label,this.audio.deviceInfo.mic.groupId=e.device.groupId,this.stream.emit("recording-device-changed",e))}})}assertLive(){if(!this.stream.isRemote&&this.stream.destroyed){throw this._reset(),new m.default({code:g.default.INVALID_OPERATION,message:"本地流已经被销毁"})}}_reset(){this.stopAllEffects(),this.stream.isRemote||(this.audio.webAudio&&(this.audio.webAudio.off("audioFilePlaybackCompleted"),this.audio.webAudio.destroy()),this.audio.webAudio=null,this.audio.micConstraint=null,this.audio.audioRoutingEnabled=!1,this.audio.micTrack&&(this.audio.micTrack.stop(),this.audio.micTrack=null),this.video.videoTrackLow&&(this.video.videoTrackLow.stop(),this.video.videoTrackLow=null),this.video.videoSource=null,this.video.cameraTrack&&(this.video.cameraTrack.stop(),this.video.cameraTrack=null),this.screen.screenVideoTrack&&(this.screen.screenVideoTrack.stop(),this.screen.screenVideoTrack=null),this.screen.screenVideoTrackLow&&(this.screen.screenVideoTrackLow.stop(),this.screen.screenVideoTrackLow=null),this.video.cameraConstraint={video:{}},this.screenAudio.screenAudioTrack&&(this.screenAudio.screenAudioTrack.stop(),this.screenAudio.screenAudioTrack=null),this.audio.mixAudioConf={index:0,audioBuffer:{},sounds:{}}),f.emptyStreamWith(this.audio.audioStream,null),f.emptyStreamWith(this.audio.musicStream,null),f.emptyStreamWith(this.audio.micStream,null),f.emptyStreamWith(this.screenAudio.screenAudioStream,null),f.emptyStreamWith(this.video.videoStream,null),f.emptyStreamWith(this.screen.screenVideoStream,null),f.emptyStreamWith(this.screenAudio.screenAudioStream,null)}updateWebAudio(){var e,t;if(!this.audio.webAudio){this.audio.webAudio=new c.WebAudio({logger:this.logger}),this.audio.webAudio.on("audioFilePlaybackCompleted",this._audioFilePlaybackCompletedEvent.bind(this));const i=null===(t=null===(e=this.audio.webAudio)||void 0===e?void 0:e.musicDestination)||void 0===t?void 0:t.stream.getAudioTracks()[0];i&&f.emptyStreamWith(this.audio.musicStream,i)}this.audio.webAudio.updateTracks([{track:this.audio.micTrack||this.audio.audioSource,type:"microphone"},{track:this.screenAudio.screenAudioTrack||this.screenAudio.screenAudioSource,type:"screenAudio"}])}async getScreenSource(e){const{width:t,height:i,frameRate:r}=this.convert(this.screen.captureConfig.high);return await d.getScreenStream({video:{width:{ideal:t},height:{ideal:i},frameRate:{ideal:r,max:r}}},this.logger)}async getStream(e){let{audio:t=!1,audioDeviceId:i="",video:r=!1,videoDeviceId:s="",screen:o=!1,sourceId:n="",screenAudio:a=!1,facingMode:c="",audioSource:l=null,videoSource:u=null,screenAudioSource:p=null,screenVideoSource:h=null,deviceId:m=""}=e;if(l&&(t=!0),u&&(r=!0),h&&(o=!0),p&&(a=!0),t||r||o||a){if(l){if("ended"===l.readyState)return void this.logger.error("不应输入已经停止的轨道:",l.kind,l.label);f.watchTrack(l),this.audio.audioSource=l,f.emptyStreamWith(this.audio.audioSourceStream,l),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(f.emptyStreamWith(this.audio.audioStream,l),this.updateAudioSender(l))),t=!1}if(u){if("ended"===u.readyState)return void this.logger.error("不应输入已经停止的轨道:",u.kind,u.label);f.watchTrack(u),this.video.videoSource=u,f.emptyStreamWith(this.video.videoStream,u),r=!1}if(p){if("ended"===p.readyState)return void this.logger.error("不应输入已经停止的轨道:",p.kind,p.label);f.watchTrack(p),this.screenAudio.screenAudioSource=p,f.emptyStreamWith(this.screenAudio.screenAudioStream,p),this.listenToTrackEnded(this.screenAudio.screenAudioSource),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(f.emptyStreamWith(this.audio.audioStream,p),this.updateAudioSender(p))),a=!1}if(h){if("ended"===h.readyState)return void this.logger.error("不应输入已经停止的轨道:",h.kind,h.label);f.watchTrack(h),this.screen.screenVideoSource=h,f.emptyStreamWith(this.screen.screenVideoStream,h),o=!1}try{if(o){if(this.stream.isRemote)return void this.logger.error("getStream: 远端流不能够调用getStream");const{width:e,height:i,frameRate:r}=this.screen.captureConfig.high;if(n){const t=(await d.getStream({video:{mandatory:{maxWidth:e,maxHeight:i,maxFrameRate:r,minFrameRate:5,chromeMediaSource:"desktop",chromeMediaSourceId:n}}},this.logger)).getTracks()[0];this.video.cameraTrack=t,f.emptyStreamWith(this.video.videoStream,t)}else{let t=await d.getScreenStream({video:{width:{ideal:e},height:{ideal:i},frameRate:{ideal:r,max:r}},audio:a&&this.getAudioConstraints()?this.getAudioConstraints():a},this.logger);if(this.screen.screenVideoTrack=t.getVideoTracks()[0],this.listenToTrackEnded(this.screen.screenVideoTrack),f.emptyStreamWith(this.screen.screenVideoStream,this.screen.screenVideoTrack),a){const e=t.getAudioTracks()[0];e?(this.screenAudio.screenAudioTrack=e,f.emptyStreamWith(this.screenAudio.screenAudioStream,e),this.listenToTrackEnded(e),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(f.emptyStreamWith(this.audio.audioStream,e),this.updateAudioSender(e)))):(this.logger.warn("getStream screenAudio: 未获取到屏幕共享音频"),this.stream.screenAudio=!1,this.stream.client.emit("error","screenAudioNotAllowed"))}}if(this.stream.client.apiEventReport("setFunction",{name:"set_screen",oper:"1",value:"success"}),t){let e=await d.getStream({audio:!this.getAudioConstraints()||this.getAudioConstraints()},this.logger);this.audio.micTrack=e.getAudioTracks()[0],f.emptyStreamWith(this.audio.micStream,this.audio.micTrack),this.listenToTrackEnded(this.audio.micTrack),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(f.emptyStreamWith(this.audio.audioStream,this.audio.micTrack),this.updateAudioSender(this.audio.micTrack)));const t=this.audio.micTrack.getSettings();this.audio.deviceInfo.mic.label=this.audio.micTrack.label,this.audio.deviceInfo.mic.deviceId=t.deviceId,this.audio.deviceInfo.mic.groupId=t.groupId,this.stream.client.apiEventReport("setFunction",{name:"set_mic",oper:"1",value:"success"})}}else if(a)this.logger.error("无法单独获取屏幕共享音频");else if(t||r){if(this.stream.isRemote)return void this.logger.error("MediaHelper.getStream:远端流不能调用getStream");const{height:e,width:o,frameRate:n}=this.video.captureConfig.high;let a={audio:t&&this.getAudioConstraints()?this.getAudioConstraints():t,video:!!r&&{width:{ideal:o},height:{ideal:e},frameRate:{ideal:n||15}}};i&&t&&(!0===a.audio&&(a.audio={}),a.audio.deviceId={exact:i}),r&&(c?a.video.facingMode={exact:c}:s&&(a.video.deviceId={exact:s}));const l=await d.getStream(a,this.logger),u=l.getVideoTracks()[0],p=l.getAudioTracks()[0];if(p){this.audio.micTrack=p,this.listenToTrackEnded(this.audio.micTrack),f.emptyStreamWith(this.audio.micStream,this.audio.micTrack),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(f.emptyStreamWith(this.audio.audioStream,this.audio.micTrack),this.updateAudioSender(this.audio.micTrack)));const e=p.getSettings();this.audio.deviceInfo.mic.label=this.audio.micTrack.label,this.audio.deviceInfo.mic.deviceId=e.deviceId,this.audio.deviceInfo.mic.groupId=e.groupId,this.stream.client.apiEventReport("setFunction",{name:"set_mic",oper:"1",value:"success"}),"object"==typeof a.audio&&(this.audio.micConstraint={audio:a.audio})}u&&(this.video.cameraTrack=u,f.emptyStreamWith(this.video.videoStream,u),this.listenToTrackEnded(this.video.cameraTrack),this.stream.client.apiEventReport("setFunction",{name:"set_camera",oper:"1",value:"success"}),"object"==typeof a.video&&(this.video.cameraConstraint={video:a.video}))}this.assertLive()}catch(e){return this.logger.error("getStream error:",e.name,e.message),t&&this.stream.client.apiEventReport("setFunction",{name:"set_mic",oper:"1",value:e.message}),r&&this.stream.client.apiEventReport("setFunction",{name:"set_camera",oper:"1",value:e.message}),o&&this.stream.client.apiEventReport("setFunction",{name:"set_screen",oper:"1",value:e.message}),Promise.reject(e)}}else this.logger.error("getStream: 必须指定媒体类型")}async getSecondStream(e){var t,i;let{audio:r=!1,video:s=!1}=e;if(!r&&!s)return this.logger.error("getSecondStream:必须指定一个参数"),Promise.reject(new m.default({code:g.default.INVALID_OPERATION,message:"getSecondStream: audio/video is invalid"}));if(this.stream.isRemote)throw new Error("getSecondStream:远端用户不能调用getSecondStream");try{const r=await d.getStream(e,this.logger),s=r.getAudioTracks()[0],o=r.getVideoTracks()[0];if(this.logger.log(`getSecondStream: ${s?s.label:""} ${o?o.label:""}`),s){"object"==typeof e.audio&&(this.audio.micConstraint={audio:e.audio}),this.audio.micTrack=s,this._stopTrack(this.audio.micStream),f.emptyStreamWith(this.audio.micStream,this.audio.micTrack),this.listenToTrackEnded(this.audio.micTrack),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(f.emptyStreamWith(this.audio.audioStream,this.audio.micTrack),this.updateAudioSender(this.audio.micTrack)));const t=s.getSettings();this.audio.deviceInfo.mic.label=this.audio.micTrack.label,this.audio.deviceInfo.mic.deviceId=t.deviceId,this.audio.deviceInfo.mic.groupId=t.groupId,this.stream.client.apiEventReport("setFunction",{name:"set_mic",oper:"1",value:"success"})}if(o){"object"==typeof e.video&&(this.video.cameraConstraint={video:e.video}),this.video.cameraTrack=o,this._stopTrack(this.video.videoStream),f.emptyStreamWith(this.video.videoStream,this.video.cameraTrack),this.stream.client.apiEventReport("setFunction",{name:"set_camera",oper:"1",value:"success"});const r=null===(t=this.stream.Play)||void 0===t?void 0:t.videoView;r&&(await this.stream.play(r),"width"in this.stream.renderMode.local.video&&this.stream.setLocalRenderMode(this.stream.renderMode.local.video,"video"));const s=this.stream.getSender("video","high");(null==s?void 0:s.track)?s.replaceTrack(o):this.logger.warn("getSecondStream video: 此时未发布流");const n=this.stream.getSender("video","low"),a=this.video.videoTrackLow;null===(i=this.video.videoTrackLow)||void 0===i||i.stop(),this.video.videoTrackLow=null,(null==n?void 0:n.track)===a&&(await this.createTrackLow("video"),this.logger.log("getSecondStream 切换小流",this.video.videoTrackLow),n.replaceTrack(this.video.videoTrackLow))}}catch(e){this.logger.error("getStream error",e.message);const t=r?"set_mic":"set_camera";return this.stream.client.apiEventReport("setFunction",{name:t,oper:"1",value:e.message}),Promise.reject(e)}}async createTrackLow(e){let t,i;if("video"===e?(t=JSON.parse(JSON.stringify(v.getParameters().videoLowDefaultConstraints)),i=this.video.videoStream.getVideoTracks()[0]):(t=JSON.parse(JSON.stringify(v.getParameters().screenLowDefaultConstraints)),i=this.screen.screenVideoStream.getVideoTracks()[0]),"live"!==(null==i?void 0:i.readyState))return this.logger.error("创建小流失败：大流已在停止状态",null==i?void 0:i.label),this.stream.client.safeEmit("track-low-init-fail",{mediaType:e}),null;this.logger.log("创建小流",e,i.label,t);const r=i.clone(),s=i.getSettings();if("screen"===e&&"Safari"===S.platform.name)this.logger.log(`创建小流：${e} + ${S.platform.name} 使用与大流一样的分辨率 ${s.width}x${s.height}`);else if(s.width&&s.height){try{t.aspectRatio=s.width/s.height,await r.applyConstraints(t)}catch(e){this.logger.warn(`创建小流：无法应用配置。小流与大流使用一样的分辨率。${s.width}x${s.height}。${JSON.stringify(t)} ${e.name} ${e.message}`)}const e=i.getSettings();if(e.width!==s.width||e.height!==s.height)this.logger.warn(`创建小流：applyConstraints影响了大流宽高。${s.width}x${s.height} => ${e.width}x${e.height}。回滚大流配置，小流与大流使用一样的分辨率。`),await i.applyConstraints(s),await r.applyConstraints(s);else{const e=r.getSettings();this.logger.log(`创建小流成功。大流宽高：${s.width}x${s.height} 小流宽高：${e.width}x${e.height}`)}}else this.logger.warn("创建小流：无法获取原始视频宽高。大流和小流使用同样的分辨率。"+JSON.stringify(s));return f.watchTrack(r),"video"===e?this.video.videoTrackLow=r:this.screen.screenVideoTrackLow=r,this.stream.client.safeEmit("track-low-init-success",{mediaType:e}),r}convert({resolution:e=4,frameRate:t=0}){let i={width:640,height:480,frameRate:15};return 2===e?(i.width=320,i.height=180):4===e?(i.width=640,i.height=480):8===e||l.RtcSystem.ios()?(i.width=1280,i.height=720):16===e&&(i.width=1920,i.height=1080),0===t?i.frameRate=15:1===t?i.frameRate=5:2===t?i.frameRate=10:3===t?i.frameRate=15:4===t?i.frameRate=20:5===t&&(i.frameRate=25),i}getAudioConstraints(){if(this.stream.isRemote)return void this.logger.error("Remote Stream dont have audio constraints");const e=this.stream.audioProcessing;let t={};switch(e&&(void 0!==e.AEC&&(t.echoCancellation=e.AEC,t.googEchoCancellation=e.AEC,t.googEchoCancellation2=e.AEC),void 0!==e.ANS&&(t.noiseSuppression=e.ANS,t.googNoiseSuppression=e.ANS,t.googNoiseSuppression2=e.ANS),void 0!==e.AGC&&(t.autoGainControl=e.AGC,t.googAutoGainControl=e.AGC,t.googAutoGainControl2=e.AGC)),this.stream.audioProfile){case"standard_stereo":case"high_quality_stereo":t.channelCount=2}return"{}"===JSON.stringify(t)?null:t}updateStream(e,t){var i,r,s;"audio"===e?(this.audio.micTrack=t,f.emptyStreamWith(this.audio.audioStream,t),(null===(i=this.stream._play)||void 0===i?void 0:i.audioDom)&&(this.stream._play.audioDom.srcObject=this.audio.audioStream)):"video"===e?(this.video.cameraTrack=t,f.emptyStreamWith(this.video.videoStream,t),(null===(r=this.stream._play)||void 0===r?void 0:r.videoDom)&&(this.stream._play.videoDom.srcObject=this.video.videoStream)):"screen"===e&&(this.screen.screenVideoTrack=t,f.emptyStreamWith(this.screen.screenVideoStream,t),(null===(s=this.stream._play)||void 0===s?void 0:s.screenDom)&&(this.stream._play.screenDom.srcObject=this.screen.screenVideoStream))}stopStream(e){var t,i,r,s;let o="set_mic";"audio"===e?(null===(t=this.audio.micTrack)||void 0===t||t.stop(),this.audio.micTrack=null,f.emptyStreamWith(this.audio.micStream,null),this.audio.audioSource=null,f.emptyStreamWith(this.audio.audioSourceStream,null),this.updateWebAudio(),this.canDisableAudioRouting()&&this.disableAudioRouting()):"screenAudio"===e?(null===(i=this.screenAudio.screenAudioTrack)||void 0===i||i.stop(),this.screenAudio.screenAudioTrack=null,this.screenAudio.screenAudioSource=null,f.emptyStreamWith(this.screenAudio.screenAudioStream,null),this.updateWebAudio(),this.canDisableAudioRouting()&&this.disableAudioRouting()):"video"===e?(o="set_camera",null===(r=this.video.cameraTrack)||void 0===r||r.stop(),this.video.cameraTrack=null,f.emptyStreamWith(this.video.videoStream,null)):"screen"===e&&(o="set_screen",null===(s=this.screen.screenVideoTrack)||void 0===s||s.stop(),this.screen.screenVideoTrack=null,f.emptyStreamWith(this.screen.screenVideoStream,null)),this.stream.client.apiEventReport("setFunction",{name:o,oper:"0",value:"success"})}_stopTrack(e){if(!e)return;if(this.stream.isRemote)return;this.logger.log("清除stream: ",e);const t=e.getTracks();this.logger.log("清除stream: ",...t),t&&0!==t.length&&t.forEach(t=>{if("audio"===t.kind){const e=v.getParameters().tracks.audio.findIndex(e=>t===e);_.Logger.warn(`Stopping AUDIOTRACK#${e} ${t.id}, ${t.label}, ${t.readyState}`)}else{const e=v.getParameters().tracks.video.findIndex(e=>t===e);_.Logger.warn(`Stopping VIDEOTRACK#${e} ${t.id}, ${t.label}, ${t.readyState}`)}t.stop(),e.removeTrack(t),this.audio.micTrack===t&&(this.audio.micTrack=null,this.audio.deviceInfo.mic={label:""},this.updateWebAudio()),this.screenAudio.screenAudioTrack===t&&(this.screenAudio.screenAudioTrack=null,this.updateWebAudio()),this.video.cameraTrack===t&&(this.video.cameraTrack=null,this.video.videoTrackLow&&(this.logger.log("停止视频小流:",this.video.videoTrackLow),this.video.videoTrackLow.stop(),this.video.videoTrackLow=null)),this.screen.screenVideoTrack===t&&(this.screen.screenVideoTrack=null,this.screen.screenVideoTrackLow&&(this.logger.log("停止辅流小流:",this.screen.screenVideoTrackLow),this.screen.screenVideoTrackLow.stop(),this.screen.screenVideoTrackLow=null))})}getAudioTrack(){var e;return null===(e=this.audio)||void 0===e?void 0:e.audioStream.getAudioTracks()[0]}getVideoTrack(){var e;return null===(e=this.video)||void 0===e?void 0:e.videoStream.getVideoTracks()[0]}setGain(e,t){this.audio.webAudio?(this.logger.log("setGain",e),this.audio.webAudio.setGain(e,t),this.canDisableAudioRouting()&&this.disableAudioRouting()):this.logger.log("setGain: 缺失本地音频")}getGain(){var e;return(null===(e=this.audio.webAudio)||void 0===e?void 0:e.getVolumeData())||"0.0"}canDisableAudioRouting(){let e=!0;if(!this.audio.webAudio)return!1;this.audio.webAudio.mixAudioConf.state!==u.AuidoMixingState.PLAYED&&this.audio.webAudio.mixAudioConf.state!==u.AuidoMixingState.PAUSED||(e=!1),Object.values(this.audio.mixAudioConf.sounds).forEach(t=>{"STARTING"!==t.state&&"PLAYED"!==t.state&&"PAUSED"!==t.state||(e=!1)});const t=this.audio.webAudio.getGainMin();return e&&1===t&&this.audio.webAudio.audioInArr.length<=1}_audioFilePlaybackCompletedEvent(){this.canDisableAudioRouting()&&this.disableAudioRouting()}startAudioMixing(e){this.logger.log("开始伴音:",JSON.stringify(e,null," ")),Object.assign(this.audio.mixAudioConf,e);let t=null;if(this.audio.mixAudioConf.audioFilePath?0!==this.getAudioInputTracks().length&&this.stream.pubStatus.audio.audio?this.audio.webAudio&&this.audio.webAudio.context||(this.logger.log("开始伴音: 不支持伴音功能"),t="BROWSER_NOT_SUPPORT"):(this.logger.log("开始伴音: 当前没有publish音频"),t="NOT_PUBLIST_AUDIO_YET"):(this.logger.log("开始伴音: 没有找到云端文件路径"),t="INVALID_ARGUMENTS"),t){if(this.stream.client.apiFrequencyControl({name:"startAudioMixing",code:-1,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:t}),null," ")}),"INVALID_ARGUMENTS"===t)return Promise.reject(new m.default({code:g.default.INVALID_OPERATION,message:"file path not found"}));if("NOT_PUBLIST_AUDIO_YET"===t)return Promise.reject(new m.default({code:g.default.INVALID_OPERATION,message:"audio source is not published"}));if("BROWSER_NOT_SUPPORT"===t)return Promise.reject(new m.default({code:g.default.NOT_SUPPORT,message:"audio mixing is not supported in this browser"}))}return this.stream.client.apiFrequencyControl({name:"startAudioMixing",code:0,param:JSON.stringify(this.audio.mixAudioConf,null," ")}),this.audio.webAudio&&(this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource&&this.audio.webAudio.mixAudioConf.state===u.AuidoMixingState.PLAYED&&(this.logger.log("startAudioMixing: 当前已经开启伴音，先关闭之前的伴音"),this.stopAudioMixing()),this.audio.webAudio.mixAudioConf.state,u.AuidoMixingState.STARTING),this.audio.mixAudioConf.audioFilePath&&this.audio.mixAudioConf.audioBuffer[this.audio.mixAudioConf.audioFilePath]?(this.logger.log("开始伴音, 已经加载过云端音乐"),this.startMix(this.audio.mixAudioConf.index)):(this.logger.log("开始伴音, 先加载云端音乐"),this.loadRemoteAudioFile(this.audio.mixAudioConf.index))}loadRemoteAudioFile(e){if(this.audio.mixAudioConf.audioFilePath)return p.ajax({url:this.audio.mixAudioConf.audioFilePath,type:"GET",dataType:"arraybuffer"}).then(t=>(this.logger.log("loadRemoteAudioFile 加载云端音乐成功"),new Promise((i,r)=>{this.audio.webAudio&&this.audio.webAudio.context?this.audio.webAudio.context.decodeAudioData(t,t=>{this.logger.log("loadRemoteAudioFile 云端音乐解码成功"),this.audio.mixAudioConf.audioFilePath?(this.audio.mixAudioConf.audioBuffer[this.audio.mixAudioConf.audioFilePath]=t,this.startMix(e).then(e=>{i(e)})):r(new m.default({code:g.default.STATE_ERROR,message:"state error"}))},e=>{this.logger.log("loadRemoteAudioFile 云端音乐解码失败：",e),r(new m.default({code:g.default.STATE_ERROR,message:"create buffersource failed"}))}):r(new m.default({code:g.default.NOT_SUPPORT,message:"webAudio lost"}))}))).catch(e=>(this.logger.log("loadRemoteAudioFile 加载云端音乐失败: ",e.name,e.message,e),Promise.reject(new m.default({code:g.default.STATE_ERROR,message:"load audio failed"}))));this.logger.error("audioFilePath未设置")}startMix(e){if(!this.audio.webAudio)return this.logger.error("startMix:参数错误"),Promise.reject(new m.default({code:g.default.INVALID_PARAMETER,message:"startMix parameter error"}));if(this.logger.log("startMix 开始混音:",JSON.stringify(this.audio.mixAudioConf)),e!==this.audio.mixAudioConf.index)return this.logger.log("startMix: 该次伴音已经取消"),Promise.resolve();this.audio.audioRoutingEnabled||this.enableAudioRouting();const{audioFilePath:t="",loopback:i=!1,replace:r=!1,cycle:s=0,playStartTime:o=0,volume:n=255,auidoMixingEnd:a=null}=this.audio.mixAudioConf;return this.audio.webAudio.startMix({buffer:this.audio.mixAudioConf.audioBuffer[t],loopback:i,replace:r,cycle:s,playStartTime:o,volume:n,auidoMixingEnd:a})}pauseAudioMixing(){let e=null;if(this.audio.webAudio&&this.audio.webAudio.context?this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource&&this.audio.webAudio.mixAudioConf.state!==u.AuidoMixingState.PAUSED?this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource&&this.audio.webAudio.mixAudioConf.state===u.AuidoMixingState.PLAYED||(this.logger.log("pauseAudioMixing: 当前没有开启伴音"),e="NOT_PLAY"):(this.logger.log("pauseAudioMixing: 已经暂停"),e="PAUSED"):(this.logger.log("pauseAudioMixing: 不支持伴音功能"),e="BROWSER_NOT_SUPPORT"),e){if(this.stream.client.apiFrequencyControl({name:"pauseAudioMixing",code:-1,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:e}),null," ")}),"BROWSER_NOT_SUPPORT"===e)return Promise.reject(new m.default({code:g.default.NOT_SUPPORT,message:"pauseAudioMixing: audio mixing is not supported in this browser"}));if("PAUSED"===e)return Promise.reject(new m.default({code:g.default.INVALID_OPERATION,message:"pauseAudioMixing: has already been paused"}));if("NOT_PLAY"===e)return Promise.reject(new m.default({code:g.default.INVALID_OPERATION,message:"pauseAudioMixing: audio mixing is not open"}))}return this.stream.client.apiFrequencyControl({name:"pauseAudioMixing",code:0,param:JSON.stringify(this.audio.mixAudioConf,null," ")}),this.audio.webAudio&&this.audio.webAudio.pauseAudioMixing()}resumeAudioMixing(){let e=null;if(this.audio.webAudio&&this.audio.webAudio.context?this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource?this.audio.webAudio.mixAudioConf.state!==u.AuidoMixingState.PAUSED&&(this.logger.log("resumeAudioMixing: 当前没有暂停伴音"),e="NOT_PAUSED"):(this.logger.log("resumeAudioMixing: 当前没有开启伴音"),e="NOT_OPEN"):(this.logger.log("resumeAudioMixing: 不支持伴音功能"),e="BROWSER_NOT_SUPPORT"),e){if(this.stream.client.apiFrequencyControl({name:"resumeAudioMixing",code:-1,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:e}),null," ")}),"BROWSER_NOT_SUPPORT"===e)return Promise.reject(new m.default({code:g.default.NOT_SUPPORT,message:"resumeAudioMixing: audio mixing is not supported in this browser"}));if("NOT_OPEN"===e)return Promise.reject(new m.default({code:g.default.INVALID_OPERATION,message:"resumeAudioMixing: audio mixing is not open"}));if("NOT_PAUSED"===e)return Promise.reject(new m.default({code:g.default.INVALID_OPERATION,message:"resumeAudioMixing: audio mixing is not paused"}))}if(this.stream.client.apiFrequencyControl({name:"resumeAudioMixing",code:0,param:JSON.stringify(this.audio.mixAudioConf,null," ")}),!this.audio.webAudio)return;let{audioFilePath:t="",loopback:i=!1,replace:r=!1,cycle:s=0,playStartTime:o=0,auidoMixingEnd:n=null}=this.audio.mixAudioConf,a=(this.audio.webAudio.mixAudioConf.pauseTime-this.audio.webAudio.mixAudioConf.startTime)/1e3+this.audio.webAudio.mixAudioConf.playStartTime;return a>this.audio.webAudio.mixAudioConf.totalTime&&(this.logger.log("播发过的圈数 playedCycle: ",Math.floor(a/this.audio.webAudio.mixAudioConf.totalTime)),s-=Math.floor(a/this.audio.webAudio.mixAudioConf.totalTime),this.audio.mixAudioConf.cycle=s),this.audio.webAudio.mixAudioConf.setPlayStartTime?(this.logger.log("暂停期间，用户设置混音播发时间: ",this.audio.webAudio.mixAudioConf.setPlayStartTime),o=this.audio.webAudio.mixAudioConf.setPlayStartTime,this.audio.webAudio.mixAudioConf.setPlayStartTime=0):(this.logger.log("恢复混音:",JSON.stringify(this.audio.webAudio.mixAudioConf)),this.logger.log("已经播放的时间: ",a),a>this.audio.webAudio.mixAudioConf.totalTime&&(a%=this.audio.webAudio.mixAudioConf.totalTime),o=a),this.logger.log("回复重置的时间点：",o),this.audio.webAudio.resumeAudioMixing({buffer:this.audio.mixAudioConf.audioBuffer[t],loopback:i,replace:r,cycle:s,playStartTime:o,auidoMixingEnd:n})}stopAudioMixing(e=!0){let t=null;if(this.audio.webAudio&&this.audio.webAudio.context?this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource||(this.logger.log("stopAudioMixing: 当前没有开启伴音"),t="NOT_OPEN"):(this.logger.log("stopAudioMixing: 不支持伴音功能"),t="BROWSER_NOT_SUPPORT"),t){if(this.stream.client.apiFrequencyControl({name:"stopAudioMixing",code:-1,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:t}),null," ")}),"BROWSER_NOT_SUPPORT"===t)return Promise.reject(new m.default({code:g.default.NOT_SUPPORT,message:"stopAudioMixing: audio mixing is not supported in this browser"}));if("NOT_OPEN"===t)return Promise.reject(new m.default({code:g.default.INVALID_OPERATION,message:"stopAudioMixing: audio mixing is not open"}))}return this.stream.client.apiFrequencyControl({name:"stopAudioMixing",code:0,param:JSON.stringify(this.audio.mixAudioConf,null," ")}),this.audio.webAudio?this.audio.webAudio.stopAudioMixing(e):Promise.reject(new m.default({code:g.default.NOT_SUPPORT,message:"webAudio is not supported in this browser"}))}setAudioMixingVolume(e){let t=null;if(this.audio.webAudio&&this.audio.webAudio.context?this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource?Number.isInteger(e)?(e<0||e>255)&&(this.logger.log("setAudioMixingVolume: volume范围（0 - 255）"),t="INVALID_ARGUMENTS"):(this.logger.log("setAudioMixingVolume: volume不是整数"),t="INVALID_ARGUMENTS"):(this.logger.log("setAudioMixingVolume: 当前没有开启伴音"),t="NOT_OPEN"):(this.logger.log("setAudioMixingVolume: 不支持伴音功能"),t="BROWSER_NOT_SUPPORT"),t){if(this.stream.client.apiFrequencyControl({name:"adjustAudioMixingVolume",code:-1,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:t,volume:e}),null," ")}),"BROWSER_NOT_SUPPORT"===t)return Promise.reject(new m.default({code:g.default.NOT_SUPPORT,message:"setAudioMixingVolume: audio mixing is not supported in this browser"}));if("NOT_OPEN"===t)return Promise.reject(new m.default({code:g.default.INVALID_OPERATION,message:"setAudioMixingVolume: audio mixing is not open"}));if("INVALID_ARGUMENTS"===t)return Promise.reject(new m.default({code:g.default.INVALID_PARAMETER,message:"setAudioMixingVolume: volume must be an integer with scope (0 - 255)"}))}return this.stream.client.apiFrequencyControl({name:"adjustAudioMixingVolume",code:0,param:JSON.stringify({volume:e},null," ")}),this.audio.webAudio&&this.audio.webAudio.setAudioMixingVolume(e)}setAudioMixingPlayTime(e){let t=null;if(this.audio.webAudio&&this.audio.webAudio.context)if(this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource){if(e<0)this.logger.log("setAudioMixingPlayTime: playStartTime小于0"),t="INVALID_ARGUMENTS";else if(e>=this.audio.webAudio.mixAudioConf.totalTime)this.logger.log("setAudioMixingPlayTime: playStartTime大于音频文件总时长了"),t="INVALID_ARGUMENTS";else if(this.audio.webAudio.mixAudioConf.state===u.AuidoMixingState.PAUSED)return this.audio.webAudio.mixAudioConf.setPlayStartTime=e,this.logger.log("setAudioMixingPlayTime: 当前正在暂停，记录设置的播发位置，在恢复伴音时，跳转到此次设置的播放位置"),Promise.resolve()}else this.logger.log("setAudioMixingPlayTime: 当前没有开启伴音"),t="INVALID_ARGUMENTS";else this.logger.log("setAudioMixingPlayTime: 不支持伴音功能"),t="BROWSER_NOT_SUPPORT";if(t){if(this.stream.client.apiFrequencyControl({name:"setAudioMixingPosition",code:-1,param:JSON.stringify({playTime:e,reason:t},null," ")}),"BROWSER_NOT_SUPPORT"===t)return Promise.reject(new m.default({code:g.default.NOT_SUPPORT,message:"setAudioMixingPlayTime: audio mixing is not supported in this browser"}));if("NOT_OPEN"===t)return Promise.reject(new m.default({code:g.default.INVALID_OPERATION,message:"setAudioMixingPlayTime: audio mixing is not open"}));if("INVALID_ARGUMENTS"===t)return Promise.reject(new m.default({code:g.default.INVALID_PARAMETER,message:"setAudioMixingPlayTime: playStartTime is invalid"}))}return new Promise((t,i)=>{this.stopAudioMixing(!1).then(r=>{if(!this.audio.webAudio){return i("webAudio not supported"),Promise.reject(new m.default({code:g.default.NOT_SUPPORT,message:"webAudio is not supported in this browser"}))}this.audio.mixAudioConf.playStartTime=e;let{audioFilePath:s="",loopback:o=!1,replace:n=!1,cycle:a=0,playStartTime:d=0,auidoMixingEnd:c=null}=this.audio.mixAudioConf;this.logger.log("设置混音的播放位置:",this.audio.webAudio.mixAudioConf);let l=(Date.now()-this.audio.webAudio.mixAudioConf.startTime)/1e3+this.audio.webAudio.mixAudioConf.playStartTime;this.logger.log("已经播放的时间: ",l),l>this.audio.webAudio.mixAudioConf.totalTime&&(this.logger.log("播发过的圈数 playedCycle: ",Math.floor(l/this.audio.webAudio.mixAudioConf.totalTime)),a-=Math.floor(l/this.audio.webAudio.mixAudioConf.totalTime),this.audio.mixAudioConf.cycle=a),this.logger.log(`setAudioMixingPlayTime, playTime: ${e}, cycle: ${a}`),this.audio.webAudio.setAudioMixingPlayTime({buffer:this.audio.mixAudioConf.audioBuffer[s],loopback:o,replace:n,cycle:a,playStartTime:d,auidoMixingEnd:c}).then(i=>{this.stream.client.apiFrequencyControl({name:"setAudioMixingPosition",code:0,param:JSON.stringify({playTime:e},null," ")}),t(i)}).catch(t=>{this.stream.client.apiFrequencyControl({name:"setAudioMixingPosition",code:-1,param:JSON.stringify({playTime:e,reason:"重新播放伴音失败"},null," ")}),i(t)})}).catch(t=>(this.stream.client.apiFrequencyControl({name:"setAudioMixingPosition",code:-1,param:JSON.stringify({playTime:e,reason:"暂停当前播放失败"},null," ")}),Promise.reject(t)))})}getAudioMixingPlayedTime(){var e;return this.audio.webAudio&&this.audio.webAudio.context?this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource?(this.stream.client.apiFrequencyControl({name:"getAudioMixingPlayedTime",code:0,param:JSON.stringify({playTime:null===(e=this.audio.webAudio.getAudioMixingPlayedTime())||void 0===e?void 0:e.playedTime},null," ")}),this.audio.webAudio.getAudioMixingPlayedTime()):(this.logger.log("getAudioMixingPlayedTime: 当前没有开启伴音"),Promise.resolve()):(this.logger.log("getAudioMixingPlayedTime: 不支持伴音功能"),Promise.resolve())}getAudioMixingTotalTime(){var e;return this.audio.webAudio&&this.audio.webAudio.context?this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource?(this.stream.client.apiFrequencyControl({name:"getAudioMixingTotalTime",code:0,param:JSON.stringify({totalTime:null===(e=this.audio.webAudio.getAudioMixingTotalTime())||void 0===e?void 0:e.totalTime},null," ")}),this.audio.webAudio.getAudioMixingTotalTime()):(this.logger.log("getAudioMixingTotalTime: 当前没有开启伴音"),Promise.resolve()):(this.logger.log("startAudioMixing: 不支持伴音功能"),Promise.resolve())}isMixAuido(){return!!(this.audio.webAudio&&this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource)}_initSoundIfNotExists(e,t){this.audio.mixAudioConf.sounds[e]||(this.audio.mixAudioConf.sounds[e]={soundId:e,state:"UNSTART",filePath:t||"",volume:100,sourceNode:null,gainNode:null,cycle:1,playStartTime:0,playOverTime:0,pauseTime:0,startTime:0,totalTime:0,options:{}}),t&&(this.audio.mixAudioConf.sounds[e].filePath=t)}async playEffect(e,t){const{soundId:i,filePath:r,cycle:s=1}=e,o={tag:"Stream.playEffect:filePath",value:r};h.checkExists(o);const n={tag:"Stream.playEffect:soundId",value:i,min:1,max:1e4};h.isExistOptions(n).result&&h.checkValidInteger(n);const a={tag:"Stream.playEffect:cycle",value:s,min:1,max:1e4};if(h.isExistOptions(a).result&&h.checkValidInteger(a),this._initSoundIfNotExists(i,r),this.audio.audioRoutingEnabled||this.enableAudioRouting(),!this.audio.webAudio||!this.audio.webAudio.context)return this.logger.log("playEffect: 浏览器不支持"),Promise.reject(new m.default({code:g.default.NOT_SUPPORT,message:"playEffect: not supported in this browser"}));if(this.audio.mixAudioConf.sounds[i]&&("STARTING"===this.audio.mixAudioConf.sounds[i].state||"PLAYED"===this.audio.mixAudioConf.sounds[i].state||"PAUSED"===this.audio.mixAudioConf.sounds[i].state)&&(this.logger.log(`pauseEffect: 该音效文件正处于: ${this.audio.mixAudioConf.sounds[i].state} 状态`),void 0===t))return Promise.reject(new m.default({code:g.default.INVALID_PARAMETER,message:"playEffect: parameter is invalid"}));this.audio.mixAudioConf.sounds[i].state="STARTING",this.audio.mixAudioConf.audioBuffer[r]?this.logger.log("playEffect: 已经 load 音效文件"):(this.logger.log("playEffect, 先 load 音效文件"),await this.preloadEffect(i,r));try{const o=this.audio.webAudio.createAudioBufferSource(this.audio.mixAudioConf.audioBuffer[r]);this.audio.mixAudioConf.sounds[i].sourceNode=o.sourceNode,o&&o.sourceNode&&(o.sourceNode.onended=e=>{this.stopEffect(i)}),this.audio.mixAudioConf.sounds[i].gainNode=o.gainNode,this.audio.mixAudioConf.sounds[i].totalTime=this.audio.mixAudioConf.audioBuffer[r]&&this.audio.mixAudioConf.audioBuffer[r].duration,this.audio.mixAudioConf.sounds[i].cycle=s;const n=this.audio.mixAudioConf.audioBuffer[r]&&this.audio.mixAudioConf.audioBuffer[r].duration;this.audio.mixAudioConf.sounds[i].playOverTime=n,s>1&&(this.audio.mixAudioConf.sounds[i].playOverTime=s*n-this.audio.mixAudioConf.sounds[i].playStartTime),this.audio.mixAudioConf.sounds[i].playStartTime=t||0,this.audio.webAudio.startAudioEffectMix(this.audio.mixAudioConf.sounds[i]),this.audio.mixAudioConf.sounds[i].state="PLAYED",this.audio.mixAudioConf.sounds[i].startTime=Date.now(),this.stream.client.apiFrequencyControl({name:"playEffect",code:0,param:JSON.stringify(e,null," ")})}catch(e){}}async stopEffect(e){const t={tag:"Stream.stopEffect:soundId",value:e};h.isExistOptions(t).result&&h.checkValidInteger(t);if(!this.audio.webAudio||!this.audio.webAudio.context)return this.logger.log("stopEffect: 浏览器不支持"),Promise.reject(new m.default({code:g.default.NOT_SUPPORT,message:"stopEffect: not supported in this browser"}));this.audio.webAudio.stopAudioEffectMix(this.audio.mixAudioConf.sounds[e]),this.audio.mixAudioConf.sounds[e].state="STOPED",this._audioFilePlaybackCompletedEvent(),this.stream.client.apiFrequencyControl({name:"stopEffect",code:0,param:JSON.stringify(e,null," ")})}async pauseEffect(e){const t={tag:"Stream.pauseEffect:soundId",value:e};h.isExistOptions(t).result&&h.checkValidInteger(t);let i=null;if(this.audio.mixAudioConf.sounds[e]||(this.logger.log("pauseEffect: 没有该音效文件"),i="SOUND_NOT_EXISTS"),this.audio.webAudio&&this.audio.webAudio.context?"PAUSED"===this.audio.mixAudioConf.sounds[e].state?(this.logger.log("pauseEffect: 已经暂停"),i="PAUSED"):"PLAYED"!==this.audio.mixAudioConf.sounds[e].state&&(this.logger.log("pauseEffect: 当前没有开启该音效"),i="NOT_PLAYED"):(this.logger.log("pauseEffect: 不支持音效功能"),i="BROWSER_NOT_SUPPORT"),i){if("BROWSER_NOT_SUPPORT"===i)return Promise.reject(new m.default({code:g.default.NOT_SUPPORT,message:"pauseEffect: audio effect is not supported in this browser"}));if("NOT_PLAYED"===i)return Promise.reject(new m.default({code:g.default.INVALID_OPERATION,message:"pauseEffect: audio effect is not open"}));if("PAUSED"===i)return Promise.reject(new m.default({code:g.default.INVALID_OPERATION,message:"pauseEffect: audio effect is not played"}));if("SOUND_NOT_EXISTS"===i)return Promise.reject(new m.default({code:g.default.NO_FILE,message:"pauseEffect: audio effect file is not found"}))}if(!this.audio.webAudio)return;this.audio.webAudio.stopAudioEffectMix(this.audio.mixAudioConf.sounds[e]),this.audio.mixAudioConf.sounds[e].pauseTime=Date.now(),this.audio.mixAudioConf.sounds[e].state="PAUSED";let r=(this.audio.mixAudioConf.sounds[e].pauseTime-this.audio.mixAudioConf.sounds[e].startTime)/1e3+this.audio.mixAudioConf.sounds[e].playStartTime;this.logger.log("pauseEffect 已经播放的时间: ",r),r>this.audio.mixAudioConf.sounds[e].totalTime&&(r%=this.audio.mixAudioConf.sounds[e].totalTime),this.logger.log("pauseEffect 暂停位置: ",r),this.stream.client.apiFrequencyControl({name:"pauseEffect",code:0,param:JSON.stringify(e,null," ")})}async resumeEffect(e){const t={tag:"Stream.resumeEffect:soundId",value:e};h.isExistOptions(t).result&&h.checkValidInteger(t);let i=null;if(this.audio.mixAudioConf.sounds[e]||(this.logger.log("resumeEffect: 没有该音效文件"),i="SOUND_NOT_EXISTS"),this.audio.webAudio&&this.audio.webAudio.context?"PAUSED"!==this.audio.mixAudioConf.sounds[e].state&&(this.logger.log("resumeEffect: 当前没有暂停该音效文件"),i="NOT_PAUSED"):(this.logger.log("resumeEffect: 不支持音效功能"),i="BROWSER_NOT_SUPPORT"),i){if("BROWSER_NOT_SUPPORT"===i)return Promise.reject(new m.default({code:g.default.NOT_SUPPORT,message:"resumeEffect: audio effect is not supported in this browser"}));if("NOT_PAUSED"===i)return Promise.reject(new m.default({code:g.default.INVALID_OPERATION,message:"resumeEffect: audio mixing is not paused"}));if("SOUND_NOT_EXISTS"===i)return Promise.reject(new m.default({code:g.default.NO_FILE,message:"resumeEffect: audio effect file is not found"}))}if(!this.audio.webAudio)return;let r=(this.audio.mixAudioConf.sounds[e].pauseTime-this.audio.mixAudioConf.sounds[e].startTime)/1e3+this.audio.mixAudioConf.sounds[e].playStartTime;if(this.logger.log("resumeEffect 已经播放的时间: ",r),r>this.audio.mixAudioConf.sounds[e].totalTime){const t=Math.floor(r/this.audio.mixAudioConf.sounds[e].totalTime);this.logger.log("播发过的圈数 playedCycle: ",t),r%=this.audio.mixAudioConf.sounds[e].totalTime,this.audio.mixAudioConf.sounds[e].cycle=this.audio.mixAudioConf.sounds[e].cycle-t}this.audio.mixAudioConf.sounds[e].playOverTime=this.audio.mixAudioConf.sounds[e].totalTime,this.audio.mixAudioConf.sounds[e].cycle>1&&(this.audio.mixAudioConf.sounds[e].playOverTime=this.audio.mixAudioConf.sounds[e].cycle*this.audio.mixAudioConf.sounds[e].totalTime-this.audio.mixAudioConf.sounds[e].playStartTime),r>this.audio.mixAudioConf.sounds[e].totalTime&&(r%=this.audio.mixAudioConf.sounds[e].totalTime),this.audio.mixAudioConf.sounds[e].playStartTime=r,this.logger.log("resumeEffect 回复重置的时间点：",r),this.playEffect({soundId:e,filePath:this.audio.mixAudioConf.sounds[e].filePath,cycle:this.audio.mixAudioConf.sounds[e].cycle},r),this.audio.mixAudioConf.sounds[e].state="PLAYED",this.audio.mixAudioConf.sounds[e].startTime=Date.now(),this.stream.client.apiFrequencyControl({name:"resumeEffect",code:0,param:JSON.stringify(e,null," ")})}async setVolumeOfEffect(e,t){var i;const r={tag:"Stream.setVolumeOfEffect:soundId",value:e,min:1};h.isExistOptions(r).result&&h.checkValidInteger(r);const s={tag:"Stream.setVolumeOfEffect:volume",value:t,min:0,max:100};h.isExistOptions(s).result&&h.checkValidInteger(s),this.logger.log(`setVolumeOfEffect 设置 ${e} 音效文件的音量: ${t}`),this._initSoundIfNotExists(e);let o=null;if(this.audio.webAudio&&this.audio.webAudio.context||(this.logger.log("setVolumeOfEffect: 不支持音效功能"),o="BROWSER_NOT_SUPPORT"),o)return Promise.reject(new m.default({code:g.default.NOT_SUPPORT,message:"setVolumeOfEffect: audio effect is not supported in this browser"}));const n=null===(i=this.audio.mixAudioConf.sounds[e])||void 0===i?void 0:i.gainNode;n?n.gain.value=t/100:this.logger.log("setVolumeOfEffect: no gainNode"),this.audio.mixAudioConf.sounds[e].volume=t,this.stream.client.apiFrequencyControl({name:"setVolumeOfEffect",code:0,param:JSON.stringify({soundId:e,volume:t},null," ")})}async preloadEffect(e,t){const i={tag:"Stream.preloadEffect:filePath",value:t};h.checkExists(i);const r={tag:"Stream.preloadEffect:soundId",value:e};if(h.isExistOptions(r).result&&h.checkValidInteger(r),this.logger.log(`preloadEffect 设置soundId: ${e}, 音效文件的filePath: ${t}`),this._initSoundIfNotExists(e,t),this.audio.audioRoutingEnabled||this.enableAudioRouting(),this.audio.mixAudioConf.audioBuffer[t])this.logger.log("preloadEffect: 已经 load 音效文件");else try{await this.loadAudioBuffer(t),this.stream.client.apiFrequencyControl({name:"preloadEffect",code:0,param:JSON.stringify({soundId:e,filePath:t},null," ")})}catch(e){this.logger.error("preloadEffect 错误: ",e.name,e.message,e),this.stream.client.apiFrequencyControl({name:"preloadEffect",code:-1,param:JSON.stringify({reason:e},null," ")})}}async unloadEffect(e){const t={tag:"Stream.unloadEffect:soundId",value:e,min:1};return h.isExistOptions(t).result&&h.checkValidInteger(t),this.logger.log(`unloadEffect： ${e} 音效文件`),this.audio.mixAudioConf.sounds[e]?"UNSTART"!==this.audio.mixAudioConf.sounds[e].state&&"STOPED"!==this.audio.mixAudioConf.sounds[e].state?(this.logger.log("unloadEffect: 该音效文件已经播放，请使用 stopEffect 方法"),Promise.reject(new m.default({code:g.default.INVALID_OPERATION,message:"unloadEffect: invalid operation"}))):(delete this.audio.mixAudioConf.audioBuffer[this.audio.mixAudioConf.sounds[e].filePath],delete this.audio.mixAudioConf.sounds[e],void this.stream.client.apiFrequencyControl({name:"unloadEffect",code:0,param:JSON.stringify({soundId:e},null," ")})):(this.logger.log("unloadEffect: 没有该音效文件"),Promise.reject(new m.default({code:g.default.NO_FILE,message:"unloadEffect: audio effect file is not found"})))}getEffectsVolume(){this.logger.log("getEffectsVolume");const e=new Array;return Object.values(this.audio.mixAudioConf.sounds).forEach(t=>{e.push({soundId:t.soundId,volume:t.volume})}),this.stream.client.apiFrequencyControl({name:"getEffectsVolume",code:0,param:JSON.stringify(e,null,2)}),e}setEffectsVolume(e){const t={tag:"Stream.setEffectsVolume:volume",value:e,min:0,max:100};h.isExistOptions(t).result&&h.checkValidInteger(t),this.logger.log("setEffectsVolume, 设置音量: "+e),Object.values(this.audio.mixAudioConf.sounds).forEach(t=>{this.setVolumeOfEffect(t.soundId,e)}),this.stream.client.apiFrequencyControl({name:"setEffectsVolume",code:0,param:JSON.stringify({volume:e},null,2)})}async stopAllEffects(){this.logger.log("stopAllEffects"),Object.values(this.audio.mixAudioConf.sounds).forEach(e=>{"PLAYED"!==e.state&&"PAUSED"!==e.state||this.stopEffect(e.soundId)}),this.stream.client.apiFrequencyControl({name:"stopAllEffects",code:0,param:JSON.stringify("stopAllEffects",null,2)})}async pauseAllEffects(){this.logger.log("pauseAllEffects"),Object.values(this.audio.mixAudioConf.sounds).forEach(e=>{"PLAYED"===e.state&&this.pauseEffect(e.soundId)}),this.stream.client.apiFrequencyControl({name:"pauseAllEffects",code:0,param:JSON.stringify("pauseAllEffects",null,2)})}async resumeAllEffects(){this.logger.log("resumeAllEffects"),Object.values(this.audio.mixAudioConf.sounds).forEach(e=>{"PAUSED"===e.state&&this.resumeEffect(e.soundId)}),this.stream.client.apiFrequencyControl({name:"resumeAllEffects",code:0,param:JSON.stringify("resumeAllEffects",null,2)})}getAudioEffectsTotalTime(e){const{soundId:t,filePath:i,cycle:r=1}=e;if(!this.audio.mixAudioConf||"{}"===JSON.stringify(this.audio.mixAudioConf.sounds))return this.logger.log("getAudioEffectsTotalTime: 当前没有音效文件"),Promise.resolve();let s;return this._initSoundIfNotExists(t,i),"PLAYED"===this.audio.mixAudioConf.sounds[t].state&&(s=this.audio.mixAudioConf.sounds[t].totalTime),this.stream.client.apiFrequencyControl({name:"getAudioMixingTotalTime",code:0,param:JSON.stringify({totalTime:s},null," ")}),s}getAudioEffectsPlayedTime(e){const{soundId:t,filePath:i,cycle:r=1}=e;if(!this.audio.mixAudioConf||"{}"===JSON.stringify(this.audio.mixAudioConf.sounds))return this.logger.log("getAudioEffectsTotalTime: 当前没有音效文件"),Promise.resolve();this._initSoundIfNotExists(t,i);let s=Date.now();"PAUSED"==this.audio.mixAudioConf.sounds[t].state&&(this.logger.log("当前是暂停状态"),s=this.audio.mixAudioConf.sounds[t].pauseTime);let o=(s-this.audio.mixAudioConf.sounds[t].startTime)/1e3+this.audio.mixAudioConf.sounds[t].playStartTime;return o>this.audio.mixAudioConf.sounds[t].totalTime&&(o%=this.audio.mixAudioConf.sounds[t].totalTime),this.stream.client.apiFrequencyControl({name:"getAudioMixingPlayedTime",code:0,param:JSON.stringify({playTime:o},null," ")}),{playedTime:o}}loadAudioBuffer(e){return p.ajax({url:e,type:"GET",dataType:"arraybuffer"}).then(t=>(this.logger.log("loadAudioBuffer 加载 audio file 成功"),new Promise((i,r)=>{this.audio.webAudio&&this.audio.webAudio.context?this.audio.webAudio.context.decodeAudioData(t,t=>{this.logger.log("loadAudioBuffer audio file 解码成功"),this.audio.mixAudioConf.audioBuffer[e]=t,i(t)},e=>{this.logger.log("loadRemoteAudioFile 云端音乐解码失败：",e),r(new m.default({code:g.default.DECODE_FAILED,message:"create buffersource failed"}))}):r(new m.default({code:g.default.STATE_ERROR,message:"webAudio lost"}))}))).catch(e=>(this.logger.log("loadRemoteAudioFile 加载云端音乐失败: ",e),Promise.reject(new m.default({code:g.default.STATE_ERROR,message:"load audio failed"}))))}getAudioInputTracks(){var e,t,i,r;let s=[];return"live"===(null===(e=this.audio.audioSource)||void 0===e?void 0:e.readyState)&&s.push(this.audio.audioSource),"live"===(null===(t=this.audio.micTrack)||void 0===t?void 0:t.readyState)&&s.push(this.audio.micTrack),"live"===(null===(i=this.screenAudio.screenAudioTrack)||void 0===i?void 0:i.readyState)&&s.push(this.screenAudio.screenAudioTrack),"live"===(null===(r=this.screenAudio.screenAudioSource)||void 0===r?void 0:r.readyState)&&s.push(this.screenAudio.screenAudioSource),s}enableAudioRouting(){if(this.audio.webAudio&&this.audio.webAudio.destination){this.audio.audioRoutingEnabled=!0;const e=this.audio.webAudio.destination.stream.getAudioTracks()[0];this.logger.log("enableAudioRouting: ",e.label);const t=this.audio.audioStream.getAudioTracks()[0];t&&(e.enabled=t.enabled,t.enabled=!0),f.emptyStreamWith(this.audio.audioStream,e),this.updateAudioSender(e)}else this.logger.log("enableAudioRouting: 已替换为Destination")}disableAudioRouting(){const e=this.getAudioInputTracks();if(e.length){1===e.length?this.logger.log("disableAudioRouting: ",e[0].label):this.logger.warn("disableAudioRouting: 仍然有多于一个输入",...e);const t=this.audio.audioStream.getAudioTracks()[0];f.emptyStreamWith(this.audio.audioStream,e[0]),e[0].enabled=t.enabled,t.enabled=!0,this.updateAudioSender(e[0])}else this.logger.log("disableAudioRouting quiet."),f.emptyStreamWith(this.audio.audioStream,null);this.audio.audioRoutingEnabled=!1}updateAudioSender(e){var t,i,r,s,o,n,a,d,c,l,u,p,h,f,m,g,v;if(this.stream.isRemote)throw new Error("updateAudioSender only for localStream");if(null===(i=null===(t=this.stream.getAdapterRef())||void 0===t?void 0:t._mediasoup)||void 0===i?void 0:i._micProducer)if(null===(o=null===(s=null===(r=this.stream.getAdapterRef())||void 0===r?void 0:r._mediasoup)||void 0===s?void 0:s._micProducer)||void 0===o?void 0:o._rtpSender)this.logger.info("updateAudioSender: 替换当前_micProducer的track",e.label),null===(c=null===(d=null===(a=null===(n=this.stream.getAdapterRef())||void 0===n?void 0:n._mediasoup)||void 0===a?void 0:a._micProducer)||void 0===d?void 0:d._rtpSender)||void 0===c||c.replaceTrack(e);else if(null===(h=null===(p=null===(u=null===(l=this.stream.getAdapterRef())||void 0===l?void 0:l._mediasoup)||void 0===u?void 0:u._sendTransport)||void 0===p?void 0:p.handler)||void 0===h?void 0:h._pc){const t=null===(g=null===(m=null===(f=this.stream.getAdapterRef())||void 0===f?void 0:f._mediasoup)||void 0===m?void 0:m._sendTransport)||void 0===g?void 0:g.handler._pc.getSenders();if(t)for(var y in t){const i=t[y];"audio"===(null===(v=null==i?void 0:i.track)||void 0===v?void 0:v.kind)&&(this.logger.info("updateAudioSender: 替换audioSender",i.track.label),i.replaceTrack(e))}}}destroy(){this.logger.log("清除 meida"),this._reset()}}t.MediaHelper=b},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WebAudio=t.getAudioContext=void 0;const s=i(3),o=i(58),n=i(91),a=r(i(1)),d=r(i(0)),c=o.RtcSupport.checkWebAudio();let l;class u{constructor(e){this.id=e.id,this.label=e.label,this.audioNode=e.audioNode,this.gainNode=e.context.createGain(),this.type=e.type,this.audioNode.connect(this.gainNode)}connect(e){this.gainNode.connect(e)}disconnect(){try{this.audioNode.disconnect(this.gainNode)}catch(e){}this.gainNode.disconnect()}}function p(){return l||(c.WebAudio&&c.MediaStream?(l=new window.AudioContext,l):null)}t.getAudioContext=p;class h extends s.EventEmitter{constructor(e){super();const{logger:t,isAnalyze:i=!0,isRemote:r=!1}=e;this.support=c.WebAudio&&c.MediaStream,this.gain=1,this.logger=t,this.audioInArr=[],this.isAnalyze=i,this.isRemote=r||!1,this.instant=0,this.slow=0,this.clip=0,this.mixAudioConf={state:n.AuidoMixingState.UNSTART,audioSource:null,gainFilter:null,replace:!1,cycle:0,pauseTime:0,startTime:0,totalTime:0,volume:1,playStartTime:0,setPlayStartTime:0,auidoMixingEnd:null},this.context=p(),this.context?(this.destination=this.createDestination(),this.musicDestination=this.createDestination(),this.analyzeDestination=this.createDestination()):(this.destination=null,this.musicDestination=null,this.analyzeDestination=null),this.support&&(this.resetMixConf(),this.init())}createDestination(){if(!this.context)throw new Error("AudioContextRequired");try{return new MediaStreamAudioDestinationNode(this.context)}catch(e){if("TypeError"===e.name)return this.context.createMediaStreamDestination();throw e}}createSource(e){if(!this.context)throw new Error("AudioContextRequired");try{return new MediaStreamAudioSourceNode(this.context,e)}catch(t){if("TypeError"===t.name)return this.context.createMediaStreamSource(e.mediaStream);throw t}}init(){this.isAnalyze&&this.initMonitor(),this.initWebAudio(),this.initAudioIn()}initMonitor(){var e=this;this.context?(this.script=this.context.createScriptProcessor(0,1,1)).onaudioprocess=function(t){var i,r=t.inputBuffer.getChannelData(0),s=0,o=0;for(i=0;i<r.length;++i)s+=Math.abs(r[i]),Math.abs(r[i])>.99&&(o+=1);e.instant=Math.sqrt(s/r.length),e.slow=.95*e.slow+.05*e.instant,e.clip=o/r.length;let n=t.inputBuffer,a=t.outputBuffer;a.copyToChannel&&a.copyToChannel(n.getChannelData(0),0,0)}:e.logger.error("initMonitor:参数不够")}initWebAudio(){this.context&&this.destination?(this.gainFilter=this.context.createGain(),this.gainFilter.gain.value=this.gain):this.logger.error("initMonitor:参数不够")}initAudioIn(){const e=this;if(!e.context||!e.gainFilter||!e.destination)return this.logger.error("initAudioIn:参数不够"),null;for(var t=0;t<e.audioInArr.length;t++){e.audioInArr[t].connect(e.gainFilter)}e.mixAudioConf.state===n.AuidoMixingState.UNSTART&&(e.script&&e.analyzeDestination&&(e.gainFilter.connect(e.script),e.script.connect(e.analyzeDestination)),e.gainFilter.connect(e.destination)),this.logger.log("WebAudio: initAudioIn: 初始化音频 state: ",e.context.state),"running"!==e.context.state&&e.context.resume().then(()=>{this.context&&this.logger.log("WebAudio: addMs: 状态变更成功 state: ",this.context.state)}).catch(e=>{this.logger.log("WebAudio: addMs: 状态变更出错: ",e.name,e.message,e),this.context&&this.context.resume()})}updateTracks(e){for(let t=this.audioInArr.length-1;t>=0;t--){const i=this.audioInArr[t];e.find(e=>e.track&&i&&e.track.id===i.id)||(this.logger.log("updateTracks，删除",i.label,i.id),this.audioInArr.splice(t,1),i.disconnect())}for(let t=e.length-1;t>=0;t--){const i=e[t];if(!this.audioInArr.find(e=>i.track&&i.track.id===e.id)&&i.track)if(this.context){const e=new MediaStream;e.addTrack(i.track);const t={context:this.context,id:i.track.id,label:i.track.label,audioNode:this.createSource({mediaStream:e}),type:i.type},r=new u(t);r.gainNode.gain.value=this.gain,this.audioInArr.push(r)}else this.logger.error("updateTracks：没有audioContext")}this.initAudioIn()}removeTrack(e){for(let t=this.audioInArr.length-1;t>=0;t--){const i=this.audioInArr[t];i.id===e.id&&(this.logger.log("removeTrack，删除track",e.id,e.label),this.audioInArr.splice(t,1),i.disconnect())}}setGain(e,t){for(let i=0;i<this.audioInArr.length;i++){const r=this.audioInArr[i];t&&t!==r.type||(this.logger.log("WebAudio.setGain",t,e,r.type,r.label,r.id),r.gainNode.gain.value=e)}t||(this.gain=e)}getGain(){if(this.gainFilter)return this.gain}getGainMin(){let e=1;for(let t=0;t<this.audioInArr.length;t++){const i=this.audioInArr[t];i.gainNode.gain.value<e&&(e=i.gainNode.gain.value)}return e}stop(){this.gainFilter&&(this.script?this.script.disconnect(0):this.gainFilter.disconnect(0),this.instant=0)}start(){this.gainFilter&&this.destination&&(this.script&&this.analyzeDestination&&(this.gainFilter.connect(this.script),this.script.connect(this.analyzeDestination)),this.gainFilter.connect(this.destination))}resetMixConf(){var e,t;if(null===(e=this.mixAudioConf.audioSource)||void 0===e||e.disconnect(0),null===(t=this.mixAudioConf.gainFilter)||void 0===t||t.disconnect(0),this.mixAudioConf.replace&&(this.logger.log("伴音停止了，恢复mic"),this.gainFilter&&this.destination)){for(var i=0;i<this.audioInArr.length;i++){this.audioInArr[i].gainNode.connect(this.gainFilter)}this.script&&this.analyzeDestination&&(this.gainFilter.connect(this.script),this.script.connect(this.analyzeDestination)),this.gainFilter.connect(this.destination)}this.mixAudioConf={state:n.AuidoMixingState.UNSTART,audioSource:null,gainFilter:null,replace:!1,cycle:0,pauseTime:0,startTime:0,totalTime:0,volume:1,playStartTime:0,setPlayStartTime:0,auidoMixingEnd:null},this.gainFilter&&1===this.gainFilter.gain.value&&this.emit("audioFilePlaybackCompleted")}startMix(e){if(!this.context||!this.destination||!this.gainFilter)return this.logger.error("initMonitor:参数不够"),Promise.reject(new a.default({code:d.default.INVALID_PARAMETER,message:"initMonitor: invalid parameter"}));if(this.logger.log("开始混音: ",JSON.stringify(e)),this.mixAudioConf.audioSource=this.context.createBufferSource(),this.mixAudioConf.gainFilter=this.context.createGain(),this.mixAudioConf.audioSource.buffer=e.buffer,this.mixAudioConf.replace=e.replace,this.mixAudioConf.cycle=e.cycle,this.mixAudioConf.playStartTime=e.playStartTime,this.mixAudioConf.volume=e.volume?e.volume/255:1,this.mixAudioConf.auidoMixingEnd=e.auidoMixingEnd,this.mixAudioConf.audioSource.connect(this.mixAudioConf.gainFilter),this.mixAudioConf.gainFilter.connect(this.gainFilter),this.musicDestination&&this.mixAudioConf.gainFilter.connect(this.musicDestination),e.replace)for(var t=0;t<this.audioInArr.length;t++){const e=this.audioInArr[t];try{e.gainNode.disconnect(this.gainFilter),this.logger.log(`已断开音频：【${e.label}】`)}catch(t){"InvalidAccessError"===t.name?this.logger.log(`音频断开前未连接：【${e.label}】`):this.logger.error(`无法断开音频:【${e.label}】${t.name}`,t.message)}}if(this.mixAudioConf.audioSource.onended=e=>{this.audioEnd(e)},this.mixAudioConf.totalTime=e.buffer.duration,(this.mixAudioConf.playStartTime<0||this.mixAudioConf.playStartTime>=this.mixAudioConf.totalTime)&&(this.mixAudioConf.playStartTime=0),this.logger.log("设置音量:",this.mixAudioConf.volume),this.mixAudioConf.gainFilter.gain.value=this.mixAudioConf.volume,e.loopback&&e.cycle>1){this.mixAudioConf.audioSource.loop=e.loopback;const t=e.cycle*this.mixAudioConf.totalTime-this.mixAudioConf.playStartTime;this.logger.log("循环播放: options.playStartTime: ",this.mixAudioConf.playStartTime),this.logger.log("循环播放: totalTime: ",t),this.mixAudioConf.audioSource.start(0,this.mixAudioConf.playStartTime,t-1)}else e.loopback&&1==e.cycle?(this.mixAudioConf.audioSource.loop=!1,this.mixAudioConf.audioSource.start(0,this.mixAudioConf.playStartTime)):(this.logger.log("无限循环播放 loop: ",e.loopback),this.mixAudioConf.audioSource.loop=e.loopback,this.mixAudioConf.audioSource.start(0,this.mixAudioConf.playStartTime));return this.mixAudioConf.state=n.AuidoMixingState.PLAYED,this.mixAudioConf.startTime=Date.now(),Promise.resolve()}pauseAudioMixing(){if(!this.mixAudioConf.audioSource||!this.mixAudioConf.gainFilter)return void this.logger.error("pauseAudioMixing:参数不够");this.logger.log("暂停混音"),this.mixAudioConf.audioSource.onended=null,this.mixAudioConf.audioSource.disconnect(0),this.mixAudioConf.gainFilter.disconnect(0),this.mixAudioConf.audioSource.stop(),this.mixAudioConf.pauseTime=Date.now(),this.mixAudioConf.state=n.AuidoMixingState.PAUSED;let e=(this.mixAudioConf.pauseTime-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return this.logger.log("已经播放的时间: ",e),e>this.mixAudioConf.totalTime&&(e%=this.mixAudioConf.totalTime),this.logger.log("暂停位置:",e),Promise.resolve()}resumeAudioMixing(e){return this.logger.log("恢复混音"),this.mixAudioConf.pauseTime=0,e.volume=255*this.mixAudioConf.volume,this.startMix(e)}stopAudioMixing(e=!0){return this.mixAudioConf.audioSource&&this.mixAudioConf.gainFilter?(this.logger.log("开始停止混音, isFinished: ",e),this.mixAudioConf.audioSource.onended=null,this.mixAudioConf.audioSource.disconnect(0),this.mixAudioConf.gainFilter.disconnect(0),this.mixAudioConf.audioSource.stop(),this.mixAudioConf.state=n.AuidoMixingState.STOPED,e&&this.resetMixConf(),this.logger.log("混音已停止"),Promise.resolve()):(this.logger.error("stopAudioMixing:参数不够"),Promise.reject(new a.default({code:d.default.INVALID_PARAMETER,message:"stopAudioMixing: invalid parameter"})))}audioEnd(e){if(this.mixAudioConf.state===n.AuidoMixingState.PLAYED){if(!(this.mixAudioConf.audioSource&&this.mixAudioConf.audioSource.loop&&this.mixAudioConf.cycle<=0))return this.logger.log("伴音播放完成: ",this.mixAudioConf),this.mixAudioConf.audioSource&&(this.mixAudioConf.audioSource.onended=null),this.mixAudioConf.auidoMixingEnd&&(this.mixAudioConf.auidoMixingEnd(e),this.mixAudioConf.auidoMixingEnd=null),this.resetMixConf(),Promise.resolve();this.logger.log("无限循环时，伴音播放完成event: ",e)}else this.logger.error("audioEnd:参数不够")}setAudioMixingVolume(e){if(this.mixAudioConf.gainFilter)return this.mixAudioConf.gainFilter.gain.value=e/255,this.mixAudioConf.volume=this.mixAudioConf.gainFilter.gain.value,Promise.resolve();this.logger.error("setAudioMixingVolume:参数不够")}setAudioMixingPlayTime(e){return this.mixAudioConf.state===n.AuidoMixingState.PLAYED&&(this.mixAudioConf.setPlayStartTime=e.playStartTime),e.volume=255*this.mixAudioConf.volume,this.startMix(e)}getAudioMixingPlayedTime(){let e=Date.now();this.mixAudioConf.state==n.AuidoMixingState.PAUSED&&this.mixAudioConf.pauseTime&&(this.logger.log("当前是暂停状态"),e=this.mixAudioConf.pauseTime);let t=(e-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return t>this.mixAudioConf.totalTime&&(t%=this.mixAudioConf.totalTime),{playedTime:t}}getAudioMixingTotalTime(){return{totalTime:this.mixAudioConf.totalTime}}createAudioBufferSource(e){if(!this.context||!this.destination||!this.gainFilter)throw this.logger.error("initMonitor:参数不够"),new a.default({code:d.default.INVALID_PARAMETER,message:"createAudioBufferSource: invalid parameter"});const t=this.context.createBufferSource();t.buffer=e;const i=this.context.createGain();t.connect(i);return{sourceNode:t,gainNode:i}}startAudioEffectMix(e){if(!this.context||!this.destination||!this.gainFilter)return this.logger.error("initMonitor:参数不够"),Promise.reject(new a.default({code:d.default.INVALID_PARAMETER,message:"initMonitor: invalid parameter"}));const{sourceNode:t,gainNode:i,playOverTime:r,playStartTime:s,volume:o,cycle:c}=e;i&&t&&(this.logger.log("startAudioEffectMix: ",JSON.stringify(e)),i.connect(this.gainFilter),this.musicDestination&&i.connect(this.musicDestination),i.gain.value=o/100,c>1?(t.loop=!0,t.start(0,s,r)):(t.loop=!1,t.start(0,s)),this.mixAudioConf.state=n.AuidoMixingState.PLAYED,this.mixAudioConf.startTime=Date.now())}stopAudioEffectMix(e){const{sourceNode:t,gainNode:i,playOverTime:r,playStartTime:s,volume:o,cycle:n}=e;if(!i||!t)return this.logger.error("stopAudioEffectMix: 参数不够"),Promise.reject(new a.default({code:d.default.INVALID_PARAMETER,message:"stopAudioEffectMix: invalid parameter"}));this.logger.log("stopAudioEffectMix: ",JSON.stringify(e)),t.onended=null,t.disconnect(0),i.disconnect(0),t.stop()}destroy(){this.logger.log("AudioContext 清除"),this.instant=0,this.slow=0,this.clip=0,this.gainFilter&&this.gainFilter.disconnect(0),this.script&&this.script.disconnect(0);for(let e=0;e<this.audioInArr.length;e++)this.audioInArr[e]&&this.audioInArr[e].disconnect();this.audioInArr=[]}getVolumeData(){return this.instant.toFixed(2)}}t.WebAudio=h},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AuidoMixingState=void 0,t.AuidoMixingState={UNSTART:"MIX_UNSTART",STARTING:"MIX_STARTING",PLAYED:"MIX_PLAYING",PAUSED:"MIX_PAUSED",STOPED:"MIX_STOPED"}},function(e,t){},function(e,t,i){"use strict";var r=i(161)(!0);i(94)(String,"String",(function(e){this._t=String(e),this._i=0}),(function(){var e,t=this._t,i=this._i;return i>=t.length?{value:void 0,done:!0}:(e=r(t,i),this._i+=e.length,{value:e,done:!1})}))},function(e,t,i){"use strict";var r=i(32),s=i(33),o=i(96),n=i(15),a=i(34),d=i(162),c=i(50),l=i(167),u=i(6)("iterator"),p=!([].keys&&"next"in[].keys()),h=function(){return this};e.exports=function(e,t,i,f,m,g,v){d(i,t,f);var y,_,S,b=function(e){if(!p&&e in A)return A[e];switch(e){case"keys":case"values":return function(){return new i(this,e)}}return function(){return new i(this,e)}},R=t+" Iterator",w="values"==m,T=!1,A=e.prototype,E=A[u]||A["@@iterator"]||m&&A[m],I=E||b(m),O=m?w?b("entries"):I:void 0,C="Array"==t&&A.entries||E;if(C&&(S=l(C.call(new e)))!==Object.prototype&&S.next&&(c(S,R,!0),r||"function"==typeof S[u]||n(S,u,h)),w&&E&&"values"!==E.name&&(T=!0,I=function(){return E.call(this)}),r&&!v||!p&&!T&&A[u]||n(A,u,I),a[t]=I,a[R]=h,m)if(y={values:w?I:b("values"),keys:g?I:b("keys"),entries:O},v)for(_ in y)_ in A||o(A,_,y[_]);else s(s.P+s.F*(p||T),t,y);return y}},function(e,t,i){e.exports=!i(18)&&!i(47)((function(){return 7!=Object.defineProperty(i(64)("div"),"a",{get:function(){return 7}}).a}))},function(e,t,i){e.exports=i(15)},function(e,t,i){var r=i(12),s=i(163),o=i(69),n=i(67)("IE_PROTO"),a=function(){},d=function(){var e,t=i(64)("iframe"),r=o.length;for(t.style.display="none",i(100).appendChild(t),t.src="javascript:",(e=t.contentWindow.document).open(),e.write("<script>document.F=Object<\/script>"),e.close(),d=e.F;r--;)delete d.prototype[o[r]];return d()};e.exports=Object.create||function(e,t){var i;return null!==e?(a.prototype=r(e),i=new a,a.prototype=null,i[n]=e):i=d(),void 0===t?i:s(i,t)}},function(e,t,i){var r=i(19),s=i(28),o=i(165)(!1),n=i(67)("IE_PROTO");e.exports=function(e,t){var i,a=s(e),d=0,c=[];for(i in a)i!=n&&r(a,i)&&c.push(i);for(;t.length>d;)r(a,i=t[d++])&&(~o(c,i)||c.push(i));return c}},function(e,t,i){var r=i(62),s=Math.min;e.exports=function(e){return e>0?s(r(e),9007199254740991):0}},function(e,t,i){var r=i(5).document;e.exports=r&&r.documentElement},function(e,t,i){var r=i(63);e.exports=function(e){return Object(r(e))}},function(e,t,i){i(168);for(var r=i(5),s=i(15),o=i(34),n=i(6)("toStringTag"),a="CSSRuleList,CSSStyleDeclaration,CSSValueList,ClientRectList,DOMRectList,DOMStringList,DOMTokenList,DataTransferItemList,FileList,HTMLAllCollection,HTMLCollection,HTMLFormElement,HTMLSelectElement,MediaList,MimeTypeArray,NamedNodeMap,NodeList,PaintRequestList,Plugin,PluginArray,SVGLengthList,SVGNumberList,SVGPathSegList,SVGPointList,SVGStringList,SVGTransformList,SourceBufferList,StyleSheetList,TextTrackCueList,TextTrackList,TouchList".split(","),d=0;d<a.length;d++){var c=a[d],l=r[c],u=l&&l.prototype;u&&!u[n]&&s(u,n,c),o[c]=o.Array}},function(e,t,i){var r=i(35),s=i(6)("toStringTag"),o="Arguments"==r(function(){return arguments}());e.exports=function(e){var t,i,n;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(i=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),s))?i:o?r(t):"Object"==(n=r(t))&&"function"==typeof t.callee?"Arguments":n}},function(e,t,i){var r=i(12),s=i(46),o=i(6)("species");e.exports=function(e,t){var i,n=r(e).constructor;return void 0===n||null==(i=r(n)[o])?t:s(i)}},function(e,t,i){var r,s,o,n=i(45),a=i(177),d=i(100),c=i(64),l=i(5),u=l.process,p=l.setImmediate,h=l.clearImmediate,f=l.MessageChannel,m=l.Dispatch,g=0,v={},y=function(){var e=+this;if(v.hasOwnProperty(e)){var t=v[e];delete v[e],t()}},_=function(e){y.call(e.data)};p&&h||(p=function(e){for(var t=[],i=1;arguments.length>i;)t.push(arguments[i++]);return v[++g]=function(){a("function"==typeof e?e:Function(e),t)},r(g),g},h=function(e){delete v[e]},"process"==i(35)(u)?r=function(e){u.nextTick(n(y,e,1))}:m&&m.now?r=function(e){m.now(n(y,e,1))}:f?(o=(s=new f).port2,s.port1.onmessage=_,r=n(o.postMessage,o,1)):l.addEventListener&&"function"==typeof postMessage&&!l.importScripts?(r=function(e){l.postMessage(e+"","*")},l.addEventListener("message",_,!1)):r="onreadystatechange"in c("script")?function(e){d.appendChild(c("script")).onreadystatechange=function(){d.removeChild(this),y.call(e)}}:function(e){setTimeout(n(y,e,1),0)}),e.exports={set:p,clear:h}},function(e,t){e.exports=function(e){try{return{e:!1,v:e()}}catch(e){return{e:!0,v:e}}}},function(e,t,i){var r=i(12),s=i(17),o=i(70);e.exports=function(e,t){if(r(e),s(t)&&t.constructor===e)return t;var i=o.f(e);return(0,i.resolve)(t),i.promise}},function(e,t,i){(function(r){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const i="color: "+this.color;t.splice(1,0,i,"color: inherit");let r=0,s=0;t[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(r++,"%c"===e&&(s=r))}),t.splice(s,0,i)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}!e&&void 0!==r&&"env"in r&&(e=r.env.DEBUG);return e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=i(185)(t);const{formatters:s}=e.exports;s.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}).call(this,i(109))},function(e,t){var i,r,s=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}function a(e){if(i===setTimeout)return setTimeout(e,0);if((i===o||!i)&&setTimeout)return i=setTimeout,setTimeout(e,0);try{return i(e,0)}catch(t){try{return i.call(null,e,0)}catch(t){return i.call(this,e,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:o}catch(e){i=o}try{r="function"==typeof clearTimeout?clearTimeout:n}catch(e){r=n}}();var d,c=[],l=!1,u=-1;function p(){l&&d&&(l=!1,d.length?c=d.concat(c):u=-1,c.length&&h())}function h(){if(!l){var e=a(p);l=!0;for(var t=c.length;t;){for(d=c,c=[];++u<t;)d&&d[u].run();u=-1,t=c.length}d=null,l=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===n||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function f(e,t){this.fun=e,this.array=t}function m(){}s.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];c.push(new f(e,t)),1!==c.length||l||a(h)},f.prototype.run=function(){this.fun.apply(null,this.array)},s.title="browser",s.browser=!0,s.env={},s.argv=[],s.version="",s.versions={},s.on=m,s.addListener=m,s.once=m,s.off=m,s.removeListener=m,s.removeAllListeners=m,s.emit=m,s.prependListener=m,s.prependOnceListener=m,s.listeners=function(e){return[]},s.binding=function(e){throw new Error("process.binding is not supported")},s.cwd=function(){return"/"},s.chdir=function(e){throw new Error("process.chdir is not supported")},s.umask=function(){return 0}},function(e,t,i){"use strict";var r=o(i(60)),s=o(i(61));function o(e){return e&&e.__esModule?e:{default:e}}var n=i(111).EventEmitter,a=i(51);e.exports=class extends n{constructor(e){super(),this.setMaxListeners(1/0),this._logger=e||new a("EnhancedEventEmitter")}safeEmit(e){try{for(var t=arguments.length,i=Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];this.emit.apply(this,[e].concat(i))}catch(t){this._logger.error("safeEmit() | event listener threw an error [event:%s]:%o",e,t)}}safeEmitAsPromise(e){for(var t=this,i=arguments.length,o=Array(i>1?i-1:0),n=1;n<i;n++)o[n-1]=arguments[n];return(0,s.default)(r.default.mark((function i(){return r.default.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.abrupt("return",new Promise((function(i,r){t.safeEmit.apply(t,[e].concat(o,[i,r]))})));case 1:case"end":return i.stop()}}),i,t)})))()}}},function(e,t,i){"use strict";var r,s="object"==typeof Reflect?Reflect:null,o=s&&"function"==typeof s.apply?s.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};r=s&&"function"==typeof s.ownKeys?s.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var n=Number.isNaN||function(e){return e!=e};function a(){a.init.call(this)}e.exports=a,e.exports.once=function(e,t){return new Promise((function(i,r){function s(i){e.removeListener(t,o),r(i)}function o(){"function"==typeof e.removeListener&&e.removeListener("error",s),i([].slice.call(arguments))}v(e,t,o,{once:!0}),"error"!==t&&function(e,t,i){"function"==typeof e.on&&v(e,"error",t,i)}(e,s,{once:!0})}))},a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var d=10;function c(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function l(e){return void 0===e._maxListeners?a.defaultMaxListeners:e._maxListeners}function u(e,t,i,r){var s,o,n,a;if(c(i),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),o=e._events),n=o[t]),void 0===n)n=o[t]=i,++e._eventsCount;else if("function"==typeof n?n=o[t]=r?[i,n]:[n,i]:r?n.unshift(i):n.push(i),(s=l(e))>0&&n.length>s&&!n.warned){n.warned=!0;var d=new Error("Possible EventEmitter memory leak detected. "+n.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");d.name="MaxListenersExceededWarning",d.emitter=e,d.type=t,d.count=n.length,a=d,console&&console.warn&&console.warn(a)}return e}function p(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function h(e,t,i){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},s=p.bind(r);return s.listener=i,r.wrapFn=s,s}function f(e,t,i){var r=e._events;if(void 0===r)return[];var s=r[t];return void 0===s?[]:"function"==typeof s?i?[s.listener||s]:[s]:i?function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}(s):g(s,s.length)}function m(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function g(e,t){for(var i=new Array(t),r=0;r<t;++r)i[r]=e[r];return i}function v(e,t,i,r){if("function"==typeof e.on)r.once?e.once(t,i):e.on(t,i);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function s(o){r.once&&e.removeEventListener(t,s),i(o)}))}}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return d},set:function(e){if("number"!=typeof e||e<0||n(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");d=e}}),a.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||n(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},a.prototype.getMaxListeners=function(){return l(this)},a.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var r="error"===e,s=this._events;if(void 0!==s)r=r&&void 0===s.error;else if(!r)return!1;if(r){var n;if(t.length>0&&(n=t[0]),n instanceof Error)throw n;var a=new Error("Unhandled error."+(n?" ("+n.message+")":""));throw a.context=n,a}var d=s[e];if(void 0===d)return!1;if("function"==typeof d)o(d,this,t);else{var c=d.length,l=g(d,c);for(i=0;i<c;++i)o(l[i],this,t)}return!0},a.prototype.addListener=function(e,t){return u(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return u(this,e,t,!0)},a.prototype.once=function(e,t){return c(t),this.on(e,h(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){return c(t),this.prependListener(e,h(this,e,t)),this},a.prototype.removeListener=function(e,t){var i,r,s,o,n;if(c(t),void 0===(r=this._events))return this;if(void 0===(i=r[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(s=-1,o=i.length-1;o>=0;o--)if(i[o]===t||i[o].listener===t){n=i[o].listener,s=o;break}if(s<0)return this;0===s?i.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(i,s),1===i.length&&(r[e]=i[0]),void 0!==r.removeListener&&this.emit("removeListener",e,n||t)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(e){var t,i,r;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0===arguments.length){var s,o=Object.keys(i);for(r=0;r<o.length;++r)"removeListener"!==(s=o[r])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},a.prototype.listeners=function(e){return f(this,e,!0)},a.prototype.rawListeners=function(e){return f(this,e,!1)},a.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):m.call(e,t)},a.prototype.listenerCount=m,a.prototype.eventNames=function(){return this._eventsCount>0?r(this._events):[]}},function(e,t,i){"use strict";var r,s=i(187),o=(r=s)&&r.__esModule?r:{default:r};var n=i(51),a=i(200).generateRandomNumber,d=i(54),c=new n("Message");e.exports=class{static parse(e){var t=void 0,i={};try{t=d.parse(e)}catch(e){return void c.error("parse() | invalid JSONbig: %s",e)}if("object"===(void 0===t?"undefined":(0,o.default)(t))&&!Array.isArray(t)){if(t.request){if(i.request=!0,"string"!=typeof t.method)return void c.error("parse() | missing/invalid method field");if("number"!=typeof t.id)return void c.error("parse() | missing/invalid id field");i.id=t.id,i.method=t.method,i.data=t.data||{}}else if(t.response){if(i.response=!0,"number"!=typeof t.id)return void c.error("parse() | missing/invalid id field");i.id=t.id,t.ok?(i.ok=!0,i.data=t.data||{}):(i.ok=!1,i.errorCode=t.errorCode,i.errorReason=t.errorReason)}else{if(!t.notification)return void c.error("parse() | missing request/response field");if(i.notification=!0,"string"!=typeof t.method)return void c.error("parse() | missing/invalid method field");i.id=t.id,i.method=t.method,i.data=t.data||{}}return i}c.error("parse() | not an object")}static createRequest(e,t){return{request:!0,id:a(),method:e,data:t||{}}}static createSuccessResponse(e,t){return{response:!0,id:e.id,ok:!0,data:t||{}}}static createErrorResponse(e,t,i){return{response:!0,id:e.id,ok:!1,errorCode:t,errorReason:i}}static createNotification(e,t){return{notification:!0,method:e,data:t||{}}}}},function(e,t){t.f=Object.getOwnPropertySymbols},function(e,t,i){var r=i(98),s=i(69).concat("length","prototype");t.f=Object.getOwnPropertyNames||function(e){return r(e,s)}},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.parseScalabilityMode=t.detectDevice=t.Device=t.version=t.types=void 0;const n=i(116);Object.defineProperty(t,"Device",{enumerable:!0,get:function(){return n.Device}}),Object.defineProperty(t,"detectDevice",{enumerable:!0,get:function(){return n.detectDevice}});const a=o(i(215));t.types=a,t.version="__MEDIASOUP_CLIENT_VERSION__";var d=i(218);Object.defineProperty(t,"parseScalabilityMode",{enumerable:!0,get:function(){return d.parse}})},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Device=t.detectDevice=void 0;const n=o(i(117)),a=i(7),d=i(36),c=i(37),l=o(i(20)),u=o(i(38)),p=i(118),h=i(208),f=i(212),m=i(213),g="Device";function v(){if("object"==typeof navigator&&"string"==typeof navigator.userAgent){const e=navigator.userAgent,t=n.getParser(e);t.getEngine();return t.satisfies({chrome:">=72",chromium:">=72"})?"Chrome74":t.satisfies({firefox:">=60"})?"Firefox60":t.satisfies({safari:">=12.0"})&&"undefined"!=typeof RTCRtpTransceiver&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection")||"WeChat"===t.getBrowserName()&&t.getOS()&&"iOS"===t.getOS().name?"Safari12":(a.Logger.warn(g,"this._detectDevice() | browser not supported [name:%s, version:%s], using Chrome72 as default",t.getBrowserName(),t.getBrowserVersion()),"Chrome74")}return a.Logger.warn(g,"this._detectDevice() | unknown device, using Chrome 72 as default"),"Chrome74"}t.detectDevice=v;t.Device=class{constructor({handlerName:e,handlerFactory:t,Handler:i}={}){if(this._loaded=!1,this._observer=new d.EnhancedEventEmitter,a.Logger.debug(g,"constructor()"),i){if(a.Logger.warn(g,"constructor() | Handler option is DEPRECATED, use handlerName or handlerFactory instead"),"string"!=typeof i)throw new TypeError("non string Handler option no longer supported, use handlerFactory instead");e=i}if(e&&t)throw new TypeError("just one of handlerName or handlerInterface can be given");if(t)this._handlerFactory=t;else{if(e)a.Logger.debug(g,"constructor() | handler given: %s",e);else{if(!(e=v()))throw new c.UnsupportedError("device not supported");a.Logger.debug(g,"constructor() | detected handler: %s",e)}switch(e){case"Chrome74":this._handlerFactory=h.Chrome74.createFactory();break;case"Safari12":this._handlerFactory=m.Safari12.createFactory();break;case"Firefox60":this._handlerFactory=f.Firefox60.createFactory();break;default:console.error(`unknown handlerName "${e}, using Chrome 74 as default"`),this._handlerFactory=h.Chrome74.createFactory()}}const r=this._handlerFactory();this._handlerName=r.name,r.close(),this._extendedRtpCapabilities=void 0,this._recvRtpCapabilities=void 0,this._canProduceByKind={audio:!1,video:!1},this._sctpCapabilities=void 0}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new c.InvalidStateError("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new c.InvalidStateError("not loaded");return this._sctpCapabilities}get observer(){return this._observer}async load({routerRtpCapabilities:e}){let t;a.Logger.debug(g,"load() [routerRtpCapabilities:%o]",e),e=l.clone(e,void 0);try{if(this._loaded)throw new c.InvalidStateError("already loaded");u.validateRtpCapabilities(e),t=this._handlerFactory();const i=await t.getNativeRtpCapabilities();a.Logger.debug(g,"load() | got native RTP capabilities:%o",i),u.validateRtpCapabilities(i),this._extendedRtpCapabilities=u.getExtendedRtpCapabilities(i,e),a.Logger.debug(g,"load() | got extended RTP capabilities:%o",this._extendedRtpCapabilities),this._canProduceByKind.audio=u.canSend("audio",this._extendedRtpCapabilities),this._canProduceByKind.video=u.canSend("video",this._extendedRtpCapabilities),this._recvRtpCapabilities=u.getRecvRtpCapabilities(this._extendedRtpCapabilities),u.validateRtpCapabilities(this._recvRtpCapabilities),a.Logger.debug(g,"load() | got receiving RTP capabilities:%o",this._recvRtpCapabilities),this._sctpCapabilities=await t.getNativeSctpCapabilities(),a.Logger.debug(g,"load() | got native SCTP capabilities:%o",this._sctpCapabilities),u.validateSctpCapabilities(this._sctpCapabilities),a.Logger.debug(g,"load() succeeded"),this._loaded=!0,t.close()}catch(e){throw t&&t.close(),e}}canProduce(e){if(!this._loaded)throw new c.InvalidStateError("not loaded");if("audio"!==e&&"video"!==e)throw new TypeError(`invalid kind "${e}"`);return this._canProduceByKind[e]}createSendTransport({id:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:o,iceTransportPolicy:n,additionalSettings:d,proprietaryConstraints:c,appData:l={}}){return a.Logger.debug(g,"createSendTransport()"),this._createTransport({direction:"send",id:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:o,iceTransportPolicy:n,additionalSettings:d,proprietaryConstraints:c,appData:l})}createRecvTransport({id:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:o,iceTransportPolicy:n,additionalSettings:d,proprietaryConstraints:c,appData:l={}}){return a.Logger.debug(g,"createRecvTransport()"),this._createTransport({direction:"recv",id:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:o,iceTransportPolicy:n,additionalSettings:d,proprietaryConstraints:c,appData:l})}_createTransport({direction:e,id:t,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:o,iceServers:n,iceTransportPolicy:a,additionalSettings:d,proprietaryConstraints:l,appData:u={}}){if(!this._loaded)throw new c.InvalidStateError("not loaded");if(u&&"object"!=typeof u)throw new TypeError("if given, appData must be an object");const h=new p.Transport({direction:e,id:t,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:o,iceServers:n,iceTransportPolicy:a,additionalSettings:d,proprietaryConstraints:l,appData:u,handlerFactory:this._handlerFactory,extendedRtpCapabilities:this._extendedRtpCapabilities,canProduceByKind:this._canProduceByKind});return this._observer.safeEmit("newtransport",h),h}}},function(e,t,i){e.exports=function(e){var t={};function i(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(r,s,function(t){return e[t]}.bind(null,s));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=90)}({17:function(e,t,i){"use strict";t.__esModule=!0,t.default=void 0;var r=i(18),s=function(){function e(){}return e.getFirstMatch=function(e,t){var i=t.match(e);return i&&i.length>0&&i[1]||""},e.getSecondMatch=function(e,t){var i=t.match(e);return i&&i.length>1&&i[2]||""},e.matchAndReturnConst=function(e,t,i){if(e.test(t))return i},e.getWindowsVersionName=function(e){switch(e){case"NT":return"NT";case"XP":return"XP";case"NT 5.0":return"2000";case"NT 5.1":return"XP";case"NT 5.2":return"2003";case"NT 6.0":return"Vista";case"NT 6.1":return"7";case"NT 6.2":return"8";case"NT 6.3":return"8.1";case"NT 10.0":return"10";default:return}},e.getMacOSVersionName=function(e){var t=e.split(".").splice(0,2).map((function(e){return parseInt(e,10)||0}));if(t.push(0),10===t[0])switch(t[1]){case 5:return"Leopard";case 6:return"Snow Leopard";case 7:return"Lion";case 8:return"Mountain Lion";case 9:return"Mavericks";case 10:return"Yosemite";case 11:return"El Capitan";case 12:return"Sierra";case 13:return"High Sierra";case 14:return"Mojave";case 15:return"Catalina";default:return}},e.getAndroidVersionName=function(e){var t=e.split(".").splice(0,2).map((function(e){return parseInt(e,10)||0}));if(t.push(0),!(1===t[0]&&t[1]<5))return 1===t[0]&&t[1]<6?"Cupcake":1===t[0]&&t[1]>=6?"Donut":2===t[0]&&t[1]<2?"Eclair":2===t[0]&&2===t[1]?"Froyo":2===t[0]&&t[1]>2?"Gingerbread":3===t[0]?"Honeycomb":4===t[0]&&t[1]<1?"Ice Cream Sandwich":4===t[0]&&t[1]<4?"Jelly Bean":4===t[0]&&t[1]>=4?"KitKat":5===t[0]?"Lollipop":6===t[0]?"Marshmallow":7===t[0]?"Nougat":8===t[0]?"Oreo":9===t[0]?"Pie":void 0},e.getVersionPrecision=function(e){return e.split(".").length},e.compareVersions=function(t,i,r){void 0===r&&(r=!1);var s=e.getVersionPrecision(t),o=e.getVersionPrecision(i),n=Math.max(s,o),a=0,d=e.map([t,i],(function(t){var i=n-e.getVersionPrecision(t),r=t+new Array(i+1).join(".0");return e.map(r.split("."),(function(e){return new Array(20-e.length).join("0")+e})).reverse()}));for(r&&(a=n-Math.min(s,o)),n-=1;n>=a;){if(d[0][n]>d[1][n])return 1;if(d[0][n]===d[1][n]){if(n===a)return 0;n-=1}else if(d[0][n]<d[1][n])return-1}},e.map=function(e,t){var i,r=[];if(Array.prototype.map)return Array.prototype.map.call(e,t);for(i=0;i<e.length;i+=1)r.push(t(e[i]));return r},e.find=function(e,t){var i,r;if(Array.prototype.find)return Array.prototype.find.call(e,t);for(i=0,r=e.length;i<r;i+=1){var s=e[i];if(t(s,i))return s}},e.assign=function(e){for(var t,i,r=e,s=arguments.length,o=new Array(s>1?s-1:0),n=1;n<s;n++)o[n-1]=arguments[n];if(Object.assign)return Object.assign.apply(Object,[e].concat(o));var a=function(){var e=o[t];"object"==typeof e&&null!==e&&Object.keys(e).forEach((function(t){r[t]=e[t]}))};for(t=0,i=o.length;t<i;t+=1)a();return e},e.getBrowserAlias=function(e){return r.BROWSER_ALIASES_MAP[e]},e.getBrowserTypeByAlias=function(e){return r.BROWSER_MAP[e]||""},e}();t.default=s,e.exports=t.default},18:function(e,t,i){"use strict";t.__esModule=!0,t.ENGINE_MAP=t.OS_MAP=t.PLATFORMS_MAP=t.BROWSER_MAP=t.BROWSER_ALIASES_MAP=void 0,t.BROWSER_ALIASES_MAP={"Amazon Silk":"amazon_silk","Android Browser":"android",Bada:"bada",BlackBerry:"blackberry",Chrome:"chrome",Chromium:"chromium",Electron:"electron",Epiphany:"epiphany",Firefox:"firefox",Focus:"focus",Generic:"generic","Google Search":"google_search",Googlebot:"googlebot","Internet Explorer":"ie","K-Meleon":"k_meleon",Maxthon:"maxthon","Microsoft Edge":"edge","MZ Browser":"mz","NAVER Whale Browser":"naver",Opera:"opera","Opera Coast":"opera_coast",PhantomJS:"phantomjs",Puffin:"puffin",QupZilla:"qupzilla",QQ:"qq",QQLite:"qqlite",Safari:"safari",Sailfish:"sailfish","Samsung Internet for Android":"samsung_internet",SeaMonkey:"seamonkey",Sleipnir:"sleipnir",Swing:"swing",Tizen:"tizen","UC Browser":"uc",Vivaldi:"vivaldi","WebOS Browser":"webos",WeChat:"wechat","Yandex Browser":"yandex",Roku:"roku"},t.BROWSER_MAP={amazon_silk:"Amazon Silk",android:"Android Browser",bada:"Bada",blackberry:"BlackBerry",chrome:"Chrome",chromium:"Chromium",electron:"Electron",epiphany:"Epiphany",firefox:"Firefox",focus:"Focus",generic:"Generic",googlebot:"Googlebot",google_search:"Google Search",ie:"Internet Explorer",k_meleon:"K-Meleon",maxthon:"Maxthon",edge:"Microsoft Edge",mz:"MZ Browser",naver:"NAVER Whale Browser",opera:"Opera",opera_coast:"Opera Coast",phantomjs:"PhantomJS",puffin:"Puffin",qupzilla:"QupZilla",qq:"QQ Browser",qqlite:"QQ Browser Lite",safari:"Safari",sailfish:"Sailfish",samsung_internet:"Samsung Internet for Android",seamonkey:"SeaMonkey",sleipnir:"Sleipnir",swing:"Swing",tizen:"Tizen",uc:"UC Browser",vivaldi:"Vivaldi",webos:"WebOS Browser",wechat:"WeChat",yandex:"Yandex Browser"},t.PLATFORMS_MAP={tablet:"tablet",mobile:"mobile",desktop:"desktop",tv:"tv"},t.OS_MAP={WindowsPhone:"Windows Phone",Windows:"Windows",MacOS:"macOS",iOS:"iOS",Android:"Android",WebOS:"WebOS",BlackBerry:"BlackBerry",Bada:"Bada",Tizen:"Tizen",Linux:"Linux",ChromeOS:"Chrome OS",PlayStation4:"PlayStation 4",Roku:"Roku"},t.ENGINE_MAP={EdgeHTML:"EdgeHTML",Blink:"Blink",Trident:"Trident",Presto:"Presto",Gecko:"Gecko",WebKit:"WebKit"}},90:function(e,t,i){"use strict";t.__esModule=!0,t.default=void 0;var r,s=(r=i(91))&&r.__esModule?r:{default:r},o=i(18);function n(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var a=function(){function e(){}var t,i;return e.getParser=function(e,t){if(void 0===t&&(t=!1),"string"!=typeof e)throw new Error("UserAgent should be a string");return new s.default(e,t)},e.parse=function(e){return new s.default(e).getResult()},t=e,(i=[{key:"BROWSER_MAP",get:function(){return o.BROWSER_MAP}},{key:"ENGINE_MAP",get:function(){return o.ENGINE_MAP}},{key:"OS_MAP",get:function(){return o.OS_MAP}},{key:"PLATFORMS_MAP",get:function(){return o.PLATFORMS_MAP}}])&&n(t,i),e}();t.default=a,e.exports=t.default},91:function(e,t,i){"use strict";t.__esModule=!0,t.default=void 0;var r=d(i(92)),s=d(i(93)),o=d(i(94)),n=d(i(95)),a=d(i(17));function d(e){return e&&e.__esModule?e:{default:e}}var c=function(){function e(e,t){if(void 0===t&&(t=!1),null==e||""===e)throw new Error("UserAgent parameter can't be empty");this._ua=e,this.parsedResult={},!0!==t&&this.parse()}var t=e.prototype;return t.getUA=function(){return this._ua},t.test=function(e){return e.test(this._ua)},t.parseBrowser=function(){var e=this;this.parsedResult.browser={};var t=a.default.find(r.default,(function(t){if("function"==typeof t.test)return t.test(e);if(t.test instanceof Array)return t.test.some((function(t){return e.test(t)}));throw new Error("Browser's test function is not valid")}));return t&&(this.parsedResult.browser=t.describe(this.getUA())),this.parsedResult.browser},t.getBrowser=function(){return this.parsedResult.browser?this.parsedResult.browser:this.parseBrowser()},t.getBrowserName=function(e){return e?String(this.getBrowser().name).toLowerCase()||"":this.getBrowser().name||""},t.getBrowserVersion=function(){return this.getBrowser().version},t.getOS=function(){return this.parsedResult.os?this.parsedResult.os:this.parseOS()},t.parseOS=function(){var e=this;this.parsedResult.os={};var t=a.default.find(s.default,(function(t){if("function"==typeof t.test)return t.test(e);if(t.test instanceof Array)return t.test.some((function(t){return e.test(t)}));throw new Error("Browser's test function is not valid")}));return t&&(this.parsedResult.os=t.describe(this.getUA())),this.parsedResult.os},t.getOSName=function(e){var t=this.getOS().name;return e?String(t).toLowerCase()||"":t||""},t.getOSVersion=function(){return this.getOS().version},t.getPlatform=function(){return this.parsedResult.platform?this.parsedResult.platform:this.parsePlatform()},t.getPlatformType=function(e){void 0===e&&(e=!1);var t=this.getPlatform().type;return e?String(t).toLowerCase()||"":t||""},t.parsePlatform=function(){var e=this;this.parsedResult.platform={};var t=a.default.find(o.default,(function(t){if("function"==typeof t.test)return t.test(e);if(t.test instanceof Array)return t.test.some((function(t){return e.test(t)}));throw new Error("Browser's test function is not valid")}));return t&&(this.parsedResult.platform=t.describe(this.getUA())),this.parsedResult.platform},t.getEngine=function(){return this.parsedResult.engine?this.parsedResult.engine:this.parseEngine()},t.getEngineName=function(e){return e?String(this.getEngine().name).toLowerCase()||"":this.getEngine().name||""},t.parseEngine=function(){var e=this;this.parsedResult.engine={};var t=a.default.find(n.default,(function(t){if("function"==typeof t.test)return t.test(e);if(t.test instanceof Array)return t.test.some((function(t){return e.test(t)}));throw new Error("Browser's test function is not valid")}));return t&&(this.parsedResult.engine=t.describe(this.getUA())),this.parsedResult.engine},t.parse=function(){return this.parseBrowser(),this.parseOS(),this.parsePlatform(),this.parseEngine(),this},t.getResult=function(){return a.default.assign({},this.parsedResult)},t.satisfies=function(e){var t=this,i={},r=0,s={},o=0;if(Object.keys(e).forEach((function(t){var n=e[t];"string"==typeof n?(s[t]=n,o+=1):"object"==typeof n&&(i[t]=n,r+=1)})),r>0){var n=Object.keys(i),d=a.default.find(n,(function(e){return t.isOS(e)}));if(d){var c=this.satisfies(i[d]);if(void 0!==c)return c}var l=a.default.find(n,(function(e){return t.isPlatform(e)}));if(l){var u=this.satisfies(i[l]);if(void 0!==u)return u}}if(o>0){var p=Object.keys(s),h=a.default.find(p,(function(e){return t.isBrowser(e,!0)}));if(void 0!==h)return this.compareVersion(s[h])}},t.isBrowser=function(e,t){void 0===t&&(t=!1);var i=this.getBrowserName().toLowerCase(),r=e.toLowerCase(),s=a.default.getBrowserTypeByAlias(r);return t&&s&&(r=s.toLowerCase()),r===i},t.compareVersion=function(e){var t=[0],i=e,r=!1,s=this.getBrowserVersion();if("string"==typeof s)return">"===e[0]||"<"===e[0]?(i=e.substr(1),"="===e[1]?(r=!0,i=e.substr(2)):t=[],">"===e[0]?t.push(1):t.push(-1)):"="===e[0]?i=e.substr(1):"~"===e[0]&&(r=!0,i=e.substr(1)),t.indexOf(a.default.compareVersions(s,i,r))>-1},t.isOS=function(e){return this.getOSName(!0)===String(e).toLowerCase()},t.isPlatform=function(e){return this.getPlatformType(!0)===String(e).toLowerCase()},t.isEngine=function(e){return this.getEngineName(!0)===String(e).toLowerCase()},t.is=function(e,t){return void 0===t&&(t=!1),this.isBrowser(e,t)||this.isOS(e)||this.isPlatform(e)},t.some=function(e){var t=this;return void 0===e&&(e=[]),e.some((function(e){return t.is(e)}))},e}();t.default=c,e.exports=t.default},92:function(e,t,i){"use strict";t.__esModule=!0,t.default=void 0;var r,s=(r=i(17))&&r.__esModule?r:{default:r},o=/version\/(\d+(\.?_?\d+)+)/i,n=[{test:[/googlebot/i],describe:function(e){var t={name:"Googlebot"},i=s.default.getFirstMatch(/googlebot\/(\d+(\.\d+))/i,e)||s.default.getFirstMatch(o,e);return i&&(t.version=i),t}},{test:[/opera/i],describe:function(e){var t={name:"Opera"},i=s.default.getFirstMatch(o,e)||s.default.getFirstMatch(/(?:opera)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/opr\/|opios/i],describe:function(e){var t={name:"Opera"},i=s.default.getFirstMatch(/(?:opr|opios)[\s/](\S+)/i,e)||s.default.getFirstMatch(o,e);return i&&(t.version=i),t}},{test:[/SamsungBrowser/i],describe:function(e){var t={name:"Samsung Internet for Android"},i=s.default.getFirstMatch(o,e)||s.default.getFirstMatch(/(?:SamsungBrowser)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/Whale/i],describe:function(e){var t={name:"NAVER Whale Browser"},i=s.default.getFirstMatch(o,e)||s.default.getFirstMatch(/(?:whale)[\s/](\d+(?:\.\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/MZBrowser/i],describe:function(e){var t={name:"MZ Browser"},i=s.default.getFirstMatch(/(?:MZBrowser)[\s/](\d+(?:\.\d+)+)/i,e)||s.default.getFirstMatch(o,e);return i&&(t.version=i),t}},{test:[/focus/i],describe:function(e){var t={name:"Focus"},i=s.default.getFirstMatch(/(?:focus)[\s/](\d+(?:\.\d+)+)/i,e)||s.default.getFirstMatch(o,e);return i&&(t.version=i),t}},{test:[/swing/i],describe:function(e){var t={name:"Swing"},i=s.default.getFirstMatch(/(?:swing)[\s/](\d+(?:\.\d+)+)/i,e)||s.default.getFirstMatch(o,e);return i&&(t.version=i),t}},{test:[/coast/i],describe:function(e){var t={name:"Opera Coast"},i=s.default.getFirstMatch(o,e)||s.default.getFirstMatch(/(?:coast)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/opt\/\d+(?:.?_?\d+)+/i],describe:function(e){var t={name:"Opera Touch"},i=s.default.getFirstMatch(/(?:opt)[\s/](\d+(\.?_?\d+)+)/i,e)||s.default.getFirstMatch(o,e);return i&&(t.version=i),t}},{test:[/yabrowser/i],describe:function(e){var t={name:"Yandex Browser"},i=s.default.getFirstMatch(/(?:yabrowser)[\s/](\d+(\.?_?\d+)+)/i,e)||s.default.getFirstMatch(o,e);return i&&(t.version=i),t}},{test:[/ucbrowser/i],describe:function(e){var t={name:"UC Browser"},i=s.default.getFirstMatch(o,e)||s.default.getFirstMatch(/(?:ucbrowser)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/Maxthon|mxios/i],describe:function(e){var t={name:"Maxthon"},i=s.default.getFirstMatch(o,e)||s.default.getFirstMatch(/(?:Maxthon|mxios)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/epiphany/i],describe:function(e){var t={name:"Epiphany"},i=s.default.getFirstMatch(o,e)||s.default.getFirstMatch(/(?:epiphany)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/puffin/i],describe:function(e){var t={name:"Puffin"},i=s.default.getFirstMatch(o,e)||s.default.getFirstMatch(/(?:puffin)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/sleipnir/i],describe:function(e){var t={name:"Sleipnir"},i=s.default.getFirstMatch(o,e)||s.default.getFirstMatch(/(?:sleipnir)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/k-meleon/i],describe:function(e){var t={name:"K-Meleon"},i=s.default.getFirstMatch(o,e)||s.default.getFirstMatch(/(?:k-meleon)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/micromessenger/i],describe:function(e){var t={name:"WeChat"},i=s.default.getFirstMatch(/(?:micromessenger)[\s/](\d+(\.?_?\d+)+)/i,e)||s.default.getFirstMatch(o,e);return i&&(t.version=i),t}},{test:[/qqbrowser/i],describe:function(e){var t={name:/qqbrowserlite/i.test(e)?"QQ Browser Lite":"QQ Browser"},i=s.default.getFirstMatch(/(?:qqbrowserlite|qqbrowser)[/](\d+(\.?_?\d+)+)/i,e)||s.default.getFirstMatch(o,e);return i&&(t.version=i),t}},{test:[/msie|trident/i],describe:function(e){var t={name:"Internet Explorer"},i=s.default.getFirstMatch(/(?:msie |rv:)(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/\sedg\//i],describe:function(e){var t={name:"Microsoft Edge"},i=s.default.getFirstMatch(/\sedg\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/edg([ea]|ios)/i],describe:function(e){var t={name:"Microsoft Edge"},i=s.default.getSecondMatch(/edg([ea]|ios)\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/vivaldi/i],describe:function(e){var t={name:"Vivaldi"},i=s.default.getFirstMatch(/vivaldi\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/seamonkey/i],describe:function(e){var t={name:"SeaMonkey"},i=s.default.getFirstMatch(/seamonkey\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/sailfish/i],describe:function(e){var t={name:"Sailfish"},i=s.default.getFirstMatch(/sailfish\s?browser\/(\d+(\.\d+)?)/i,e);return i&&(t.version=i),t}},{test:[/silk/i],describe:function(e){var t={name:"Amazon Silk"},i=s.default.getFirstMatch(/silk\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/phantom/i],describe:function(e){var t={name:"PhantomJS"},i=s.default.getFirstMatch(/phantomjs\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/slimerjs/i],describe:function(e){var t={name:"SlimerJS"},i=s.default.getFirstMatch(/slimerjs\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe:function(e){var t={name:"BlackBerry"},i=s.default.getFirstMatch(o,e)||s.default.getFirstMatch(/blackberry[\d]+\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/(web|hpw)[o0]s/i],describe:function(e){var t={name:"WebOS Browser"},i=s.default.getFirstMatch(o,e)||s.default.getFirstMatch(/w(?:eb)?[o0]sbrowser\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/bada/i],describe:function(e){var t={name:"Bada"},i=s.default.getFirstMatch(/dolfin\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/tizen/i],describe:function(e){var t={name:"Tizen"},i=s.default.getFirstMatch(/(?:tizen\s?)?browser\/(\d+(\.?_?\d+)+)/i,e)||s.default.getFirstMatch(o,e);return i&&(t.version=i),t}},{test:[/qupzilla/i],describe:function(e){var t={name:"QupZilla"},i=s.default.getFirstMatch(/(?:qupzilla)[\s/](\d+(\.?_?\d+)+)/i,e)||s.default.getFirstMatch(o,e);return i&&(t.version=i),t}},{test:[/firefox|iceweasel|fxios/i],describe:function(e){var t={name:"Firefox"},i=s.default.getFirstMatch(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/electron/i],describe:function(e){var t={name:"Electron"},i=s.default.getFirstMatch(/(?:electron)\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/MiuiBrowser/i],describe:function(e){var t={name:"Miui"},i=s.default.getFirstMatch(/(?:MiuiBrowser)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/chromium/i],describe:function(e){var t={name:"Chromium"},i=s.default.getFirstMatch(/(?:chromium)[\s/](\d+(\.?_?\d+)+)/i,e)||s.default.getFirstMatch(o,e);return i&&(t.version=i),t}},{test:[/chrome|crios|crmo/i],describe:function(e){var t={name:"Chrome"},i=s.default.getFirstMatch(/(?:chrome|crios|crmo)\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/GSA/i],describe:function(e){var t={name:"Google Search"},i=s.default.getFirstMatch(/(?:GSA)\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:function(e){var t=!e.test(/like android/i),i=e.test(/android/i);return t&&i},describe:function(e){var t={name:"Android Browser"},i=s.default.getFirstMatch(o,e);return i&&(t.version=i),t}},{test:[/playstation 4/i],describe:function(e){var t={name:"PlayStation 4"},i=s.default.getFirstMatch(o,e);return i&&(t.version=i),t}},{test:[/safari|applewebkit/i],describe:function(e){var t={name:"Safari"},i=s.default.getFirstMatch(o,e);return i&&(t.version=i),t}},{test:[/.*/i],describe:function(e){var t=-1!==e.search("\\(")?/^(.*)\/(.*)[ \t]\((.*)/:/^(.*)\/(.*) /;return{name:s.default.getFirstMatch(t,e),version:s.default.getSecondMatch(t,e)}}}];t.default=n,e.exports=t.default},93:function(e,t,i){"use strict";t.__esModule=!0,t.default=void 0;var r,s=(r=i(17))&&r.__esModule?r:{default:r},o=i(18),n=[{test:[/Roku\/DVP/],describe:function(e){var t=s.default.getFirstMatch(/Roku\/DVP-(\d+\.\d+)/i,e);return{name:o.OS_MAP.Roku,version:t}}},{test:[/windows phone/i],describe:function(e){var t=s.default.getFirstMatch(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i,e);return{name:o.OS_MAP.WindowsPhone,version:t}}},{test:[/windows /i],describe:function(e){var t=s.default.getFirstMatch(/Windows ((NT|XP)( \d\d?.\d)?)/i,e),i=s.default.getWindowsVersionName(t);return{name:o.OS_MAP.Windows,version:t,versionName:i}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe:function(e){var t={name:o.OS_MAP.iOS},i=s.default.getSecondMatch(/(Version\/)(\d[\d.]+)/,e);return i&&(t.version=i),t}},{test:[/macintosh/i],describe:function(e){var t=s.default.getFirstMatch(/mac os x (\d+(\.?_?\d+)+)/i,e).replace(/[_\s]/g,"."),i=s.default.getMacOSVersionName(t),r={name:o.OS_MAP.MacOS,version:t};return i&&(r.versionName=i),r}},{test:[/(ipod|iphone|ipad)/i],describe:function(e){var t=s.default.getFirstMatch(/os (\d+([_\s]\d+)*) like mac os x/i,e).replace(/[_\s]/g,".");return{name:o.OS_MAP.iOS,version:t}}},{test:function(e){var t=!e.test(/like android/i),i=e.test(/android/i);return t&&i},describe:function(e){var t=s.default.getFirstMatch(/android[\s/-](\d+(\.\d+)*)/i,e),i=s.default.getAndroidVersionName(t),r={name:o.OS_MAP.Android,version:t};return i&&(r.versionName=i),r}},{test:[/(web|hpw)[o0]s/i],describe:function(e){var t=s.default.getFirstMatch(/(?:web|hpw)[o0]s\/(\d+(\.\d+)*)/i,e),i={name:o.OS_MAP.WebOS};return t&&t.length&&(i.version=t),i}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe:function(e){var t=s.default.getFirstMatch(/rim\stablet\sos\s(\d+(\.\d+)*)/i,e)||s.default.getFirstMatch(/blackberry\d+\/(\d+([_\s]\d+)*)/i,e)||s.default.getFirstMatch(/\bbb(\d+)/i,e);return{name:o.OS_MAP.BlackBerry,version:t}}},{test:[/bada/i],describe:function(e){var t=s.default.getFirstMatch(/bada\/(\d+(\.\d+)*)/i,e);return{name:o.OS_MAP.Bada,version:t}}},{test:[/tizen/i],describe:function(e){var t=s.default.getFirstMatch(/tizen[/\s](\d+(\.\d+)*)/i,e);return{name:o.OS_MAP.Tizen,version:t}}},{test:[/linux/i],describe:function(){return{name:o.OS_MAP.Linux}}},{test:[/CrOS/],describe:function(){return{name:o.OS_MAP.ChromeOS}}},{test:[/PlayStation 4/],describe:function(e){var t=s.default.getFirstMatch(/PlayStation 4[/\s](\d+(\.\d+)*)/i,e);return{name:o.OS_MAP.PlayStation4,version:t}}}];t.default=n,e.exports=t.default},94:function(e,t,i){"use strict";t.__esModule=!0,t.default=void 0;var r,s=(r=i(17))&&r.__esModule?r:{default:r},o=i(18),n=[{test:[/googlebot/i],describe:function(){return{type:"bot",vendor:"Google"}}},{test:[/huawei/i],describe:function(e){var t=s.default.getFirstMatch(/(can-l01)/i,e)&&"Nova",i={type:o.PLATFORMS_MAP.mobile,vendor:"Huawei"};return t&&(i.model=t),i}},{test:[/nexus\s*(?:7|8|9|10).*/i],describe:function(){return{type:o.PLATFORMS_MAP.tablet,vendor:"Nexus"}}},{test:[/ipad/i],describe:function(){return{type:o.PLATFORMS_MAP.tablet,vendor:"Apple",model:"iPad"}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe:function(){return{type:o.PLATFORMS_MAP.tablet,vendor:"Apple",model:"iPad"}}},{test:[/kftt build/i],describe:function(){return{type:o.PLATFORMS_MAP.tablet,vendor:"Amazon",model:"Kindle Fire HD 7"}}},{test:[/silk/i],describe:function(){return{type:o.PLATFORMS_MAP.tablet,vendor:"Amazon"}}},{test:[/tablet(?! pc)/i],describe:function(){return{type:o.PLATFORMS_MAP.tablet}}},{test:function(e){var t=e.test(/ipod|iphone/i),i=e.test(/like (ipod|iphone)/i);return t&&!i},describe:function(e){var t=s.default.getFirstMatch(/(ipod|iphone)/i,e);return{type:o.PLATFORMS_MAP.mobile,vendor:"Apple",model:t}}},{test:[/nexus\s*[0-6].*/i,/galaxy nexus/i],describe:function(){return{type:o.PLATFORMS_MAP.mobile,vendor:"Nexus"}}},{test:[/[^-]mobi/i],describe:function(){return{type:o.PLATFORMS_MAP.mobile}}},{test:function(e){return"blackberry"===e.getBrowserName(!0)},describe:function(){return{type:o.PLATFORMS_MAP.mobile,vendor:"BlackBerry"}}},{test:function(e){return"bada"===e.getBrowserName(!0)},describe:function(){return{type:o.PLATFORMS_MAP.mobile}}},{test:function(e){return"windows phone"===e.getBrowserName()},describe:function(){return{type:o.PLATFORMS_MAP.mobile,vendor:"Microsoft"}}},{test:function(e){var t=Number(String(e.getOSVersion()).split(".")[0]);return"android"===e.getOSName(!0)&&t>=3},describe:function(){return{type:o.PLATFORMS_MAP.tablet}}},{test:function(e){return"android"===e.getOSName(!0)},describe:function(){return{type:o.PLATFORMS_MAP.mobile}}},{test:function(e){return"macos"===e.getOSName(!0)},describe:function(){return{type:o.PLATFORMS_MAP.desktop,vendor:"Apple"}}},{test:function(e){return"windows"===e.getOSName(!0)},describe:function(){return{type:o.PLATFORMS_MAP.desktop}}},{test:function(e){return"linux"===e.getOSName(!0)},describe:function(){return{type:o.PLATFORMS_MAP.desktop}}},{test:function(e){return"playstation 4"===e.getOSName(!0)},describe:function(){return{type:o.PLATFORMS_MAP.tv}}},{test:function(e){return"roku"===e.getOSName(!0)},describe:function(){return{type:o.PLATFORMS_MAP.tv}}}];t.default=n,e.exports=t.default},95:function(e,t,i){"use strict";t.__esModule=!0,t.default=void 0;var r,s=(r=i(17))&&r.__esModule?r:{default:r},o=i(18),n=[{test:function(e){return"microsoft edge"===e.getBrowserName(!0)},describe:function(e){if(/\sedg\//i.test(e))return{name:o.ENGINE_MAP.Blink};var t=s.default.getFirstMatch(/edge\/(\d+(\.?_?\d+)+)/i,e);return{name:o.ENGINE_MAP.EdgeHTML,version:t}}},{test:[/trident/i],describe:function(e){var t={name:o.ENGINE_MAP.Trident},i=s.default.getFirstMatch(/trident\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:function(e){return e.test(/presto/i)},describe:function(e){var t={name:o.ENGINE_MAP.Presto},i=s.default.getFirstMatch(/presto\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:function(e){var t=e.test(/gecko/i),i=e.test(/like gecko/i);return t&&!i},describe:function(e){var t={name:o.ENGINE_MAP.Gecko},i=s.default.getFirstMatch(/gecko\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/(apple)?webkit\/537\.36/i],describe:function(){return{name:o.ENGINE_MAP.Blink}}},{test:[/(apple)?webkit/i],describe:function(e){var t={name:o.ENGINE_MAP.WebKit},i=s.default.getFirstMatch(/webkit\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}}];t.default=n,e.exports=t.default}})},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Transport=void 0;const a=i(207),d=i(7),c=i(36),l=i(37),u=o(i(20)),p=o(i(38)),h=i(119),f=i(120),m=n(i(1)),g=n(i(0)),v=i(2),y="Transport";class _ extends c.EnhancedEventEmitter{constructor({direction:e,id:t,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:o,iceServers:n,iceTransportPolicy:p,additionalSettings:h,proprietaryConstraints:f,appData:m,handlerFactory:g,extendedRtpCapabilities:v,canProduceByKind:_}){super(),this._closed=!1,this._connectionState="new",this._producers=new Map,this._consumers=new Map,this._probatorConsumerCreated=!1,this._awaitQueue=new a.AwaitQueue({ClosedErrorClass:l.InvalidStateError}),this._observer=new c.EnhancedEventEmitter,d.Logger.debug(y,"constructor() [id:%s, direction:%s]",t,e),this._id=t,this._direction=e,this._extendedRtpCapabilities=v,this._canProduceByKind=_,this._maxSctpMessageSize=o?o.maxMessageSize:null,delete(h=u.clone(h,{})).iceServers,delete h.iceTransportPolicy,delete h.bundlePolicy,delete h.rtcpMuxPolicy,delete h.sdpSemantics,this._handler=g(),this._handler.run({direction:e,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:o,iceServers:n,iceTransportPolicy:p,additionalSettings:h,proprietaryConstraints:f,extendedRtpCapabilities:v,appData:m}),this._appData=m,this._handleHandler()}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get connectionState(){return this._connectionState}get appData(){return this._appData}set appData(e){throw new m.default({code:g.default.APPDATA_ERROR,message:"cannot override appData object"})}get observer(){return this._observer}close(){if(!this._closed){d.Logger.debug(y,"close()"),this._closed=!0,this._awaitQueue.close(),this._handler.close();for(const e of this._producers.values())e.transportClosed();this._producers.clear();for(const e of this._consumers.values())e.transportClosed();this._consumers.clear(),this._observer.safeEmit("close")}}async getStats(){if(this._closed)throw new l.InvalidStateError("closed");return this._handler.getTransportStats()}async restartIce({iceParameters:e}){if(d.Logger.debug(y,"restartIce()"),this._closed)throw new l.InvalidStateError("closed");if(!e)throw new TypeError("missing iceParameters");return this._awaitQueue.push(async()=>this._handler.restartIce(e),"transport.restartIce()")}async updateIceServers({iceServers:e}={}){if(d.Logger.debug(y,"updateIceServers()"),this._closed)throw new l.InvalidStateError("closed");if(!Array.isArray(e))throw new TypeError("missing iceServers");return this._awaitQueue.push(async()=>this._handler.updateIceServers(e),"transport.updateIceServers()")}async produce({track:e,trackLow:t,encodings:i,codecOptions:r,codec:s,stopTracks:o=!0,disableTrackOnPause:n=!0,zeroRtpOnPause:a=!1,appData:c}){if(d.Logger.debug(y,"produce()"),!e)throw new TypeError("missing track");if("send"!==this._direction)throw new l.UnsupportedError("not a sending Transport");if(!this._canProduceByKind[e.kind])throw new l.UnsupportedError("cannot produce "+e.kind);if("ended"===e.readyState)throw new l.InvalidStateError("track ended");if(0===this.listenerCount("produce"))throw new TypeError('no "produce" listener set into this transport');if(c&&"object"!=typeof c)throw new TypeError("if given, appData must be an object");return this._awaitQueue.push(async()=>{let d;if(i&&!Array.isArray(i))throw TypeError("encodings must be an array");i&&0===i.length?d=void 0:i&&(d=i.map(e=>{const t={active:!0};return!1===e.active&&(t.active=!1),"boolean"==typeof e.dtx&&(t.dtx=e.dtx),"string"==typeof e.scalabilityMode&&(t.scalabilityMode=e.scalabilityMode),"number"==typeof e.scaleResolutionDownBy&&(t.scaleResolutionDownBy=e.scaleResolutionDownBy),"number"==typeof e.maxBitrate&&(t.maxBitrate=e.maxBitrate),"number"==typeof e.maxFramerate&&(t.maxFramerate=e.maxFramerate),"boolean"==typeof e.adaptivePtime&&(t.adaptivePtime=e.adaptivePtime),"string"==typeof e.priority&&(t.priority=e.priority),"string"==typeof e.networkPriority&&(t.networkPriority=e.networkPriority),t}));const{localId:l,localIdLow:u,rtpParameters:f,rtpSender:m,rtpSenderLow:g,dtlsParameters:v,offer:y}=await this._handler.send({track:e,trackLow:t,encodings:d,codecOptions:r,appData:c,codec:s});try{p.validateRtpParameters(f);const{id:i}=await this.safeEmitAsPromise("produce",{kind:e.kind,rtpParameters:f,track:e,trackLow:t,appData:c,localDtlsParameters:v,offer:y}),r=new h.Producer({id:i,localId:l,localIdLow:u,rtpSender:m,rtpSenderLow:g,track:e,trackLow:t,rtpParameters:f,stopTracks:o,disableTrackOnPause:n,zeroRtpOnPause:a,appData:c});return this._producers.set(r.id,r),this._handleProducer(r),this._observer.safeEmit("newproducer",r),r}catch(e){throw this._handler.stopSending(l,c.mediaType).catch(()=>{}),e}},"transport.produce()").catch(t=>{if(o)try{if("audio"===e.kind){const t=v.getParameters().tracks.audio.findIndex(t=>e===t);d.Logger.warn(`Stopping AUDIOTRACK#${t} ${e.id}, ${e.label}, ${e.readyState}`)}else{const t=v.getParameters().tracks.video.findIndex(t=>e===t);d.Logger.warn(`Stopping VIDEOTRACK#${t} ${e.id}, ${e.label}, ${e.readyState}`)}e.stop()}catch(e){}throw t})}async fillRemoteRecvSdp({kind:e,appData:t,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:o,sendingRtpParameters:n,codecOptions:a,offer:d,audioProfile:c,codec:l}){await this._handler.fillRemoteRecvSdp({kind:e,appData:t,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:o,sendingRtpParameters:n,codecOptions:a,offer:d,codec:l,audioProfile:c})}async prepareLocalSdp(e,t,i){try{const{dtlsParameters:r,rtpCapabilities:s,offer:o,mid:n,iceUfragReg:a}=await this._handler.prepareLocalSdp(e,i);if(!this._recvRtpCapabilities||!p.canSend("audio",this._recvRtpCapabilities)||!p.canSend("video",this._recvRtpCapabilities)){let e=p.getExtendedRtpCapabilities(s,t);this._recvRtpCapabilities=p.getRecvRtpCapabilities(e),p.validateRtpCapabilities(this._recvRtpCapabilities)}return{dtlsParameters:r,rtpCapabilities:this._recvRtpCapabilities,offer:o,mid:n,iceUfragReg:a}}catch(e){throw e}}async recoverLocalSdp(e,t,i){try{return void await this._handler.recoverTransceiver(e,t,i)}catch(e){throw e}}async consume({id:e,producerId:t,kind:i,rtpParameters:r,appData:s={},offer:o,iceParameters:n,iceCandidates:a,dtlsParameters:c,sctpParameters:h,probeSSrc:m}){if(d.Logger.debug(y,"consume()"),r=u.clone(r,void 0),this._closed)throw new l.InvalidStateError("closed");if("recv"!==this._direction)throw new l.UnsupportedError("not a receiving Transport");if("string"!=typeof e)throw new TypeError("missing id");if("string"!=typeof t)throw new TypeError("missing producerId");if("audio"!==i&&"video"!==i)throw new TypeError(`invalid kind '${i}'`);if(s&&"object"!=typeof s)throw new TypeError("if given, appData must be an object");return this._awaitQueue.push(async()=>{p.canReceive(r,this._extendedRtpCapabilities);const{localId:d,rtpReceiver:l,track:u}=await this._handler.receive({iceParameters:n,iceCandidates:a,dtlsParameters:c,sctpParameters:h,trackId:e,kind:i,rtpParameters:r,offer:o,probeSSrc:m,remoteUid:s.remoteUid,extendedRtpCapabilities:this._extendedRtpCapabilities}),g=new f.Consumer({id:e,localId:d,producerId:t,rtpReceiver:l,track:u,rtpParameters:r,appData:s});return this._consumers.set(g.id,g),this._handleConsumer(g),this._observer.safeEmit("newconsumer",g),g},"transport.consume()")}_handleHandler(){const e=this._handler;e.on("@connect",({dtlsParameters:e},t,i)=>{this._closed?i(new l.InvalidStateError("closed")):this.safeEmit("connect",{dtlsParameters:e},t,i)}),e.on("@connectionstatechange",e=>{e!==this._connectionState&&(d.Logger.debug(y,"connection state changed to %s",e),this._connectionState=e,this._closed||this.safeEmit("connectionstatechange",e))})}_handleProducer(e){e.on("@close",()=>{this._closed||(d.Logger.warn(y,"producer 关闭: ",e.localId),this._awaitQueue.push(async()=>this._handler.stopSending(e.localId,e.appData.mediaType)).catch(e=>d.Logger.warn(y,"producer.close() failed:%o",e)))}),e.on("@replacetrack",(t,i,r)=>{this._awaitQueue.push(async()=>this._handler.replaceTrack(e.localId,t),"producer @replacetrack event").then(i).catch(r)}),e.on("@setmaxspatiallayer",(t,i,r)=>{this._awaitQueue.push(async()=>this._handler.setMaxSpatialLayer(e.localId,t),"producer @setmaxspatiallayer event").then(i).catch(r)}),e.on("@setrtpencodingparameters",(t,i,r)=>{this._awaitQueue.push(async()=>this._handler.setRtpEncodingParameters(e.localId,t),"producer @setrtpencodingparameters event").then(i).catch(r)}),e.on("@getstats",(t,i)=>{if(this._closed)return i(new l.InvalidStateError("closed"));this._handler.getSenderStats(e.localId).then(t).catch(i)})}_handleConsumer(e){e.on("@close",()=>{this._consumers.delete(e.id),this._closed||this._awaitQueue.push(async()=>this._handler.stopReceiving(e.localId),"consumer @close event").catch(()=>{})}),e.on("@getstats",(t,i)=>{if(this._closed)return i(new l.InvalidStateError("closed"));this._handler.getReceiverStats(e.localId).then(t).catch(i)})}}t.Transport=_},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Producer=void 0;const s=i(7),o=i(36),n=i(37),a=r(i(1)),d=r(i(0)),c=i(2),l="Producer";class u extends o.EnhancedEventEmitter{constructor({id:e,localId:t,localIdLow:i,rtpSender:r,rtpSenderLow:n,track:a,trackLow:d,rtpParameters:c,stopTracks:u,disableTrackOnPause:p,zeroRtpOnPause:h,appData:f}){super(),this._closed=!1,this._observer=new o.EnhancedEventEmitter,s.Logger.debug(l,"constructor()",t),this._id=e,this._localId=t,this._localIdLow=i,this._rtpSender=r,this._rtpSenderLow=n,this._track=a,this._trackLow=d,this._kind=a.kind,this._rtpParameters=c,this._paused=!!p&&!a.enabled,this._maxSpatialLayer=void 0,this._stopTracks=u,this._disableTrackOnPause=p,this._zeroRtpOnPause=h,this._appData=f,this._onTrackEnded=this._onTrackEnded.bind(this),this._handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(e){throw new a.default({code:d.default.APPDATA_ERROR,message:"cannot override appData object"})}get observer(){return this._observer}close(){this._closed||(s.Logger.debug(l,"close()"),this._closed=!0,this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(s.Logger.debug(l,"transportClosed()"),this._closed=!0,this._destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new n.InvalidStateError("closed");return this.safeEmitAsPromise("@getstats")}pause(){s.Logger.debug(l,"pause()"),this._closed?s.Logger.error(l,"pause() | Producer closed"):(this._paused=!0,this._disableTrackOnPause&&(this._track&&(this._track.enabled=!1),this._trackLow&&(this._trackLow.enabled=!1)),this._zeroRtpOnPause&&this.safeEmitAsPromise("@replacetrack",null).catch(()=>{}),this._observer.safeEmit("pause"))}resume(){s.Logger.debug(l,"resume()"),this._closed?s.Logger.error(l,"resume() | Producer closed"):(this._paused=!1,this._disableTrackOnPause&&(this._track&&(this._track.enabled=!0),this._trackLow&&(this._trackLow.enabled=!0)),this._zeroRtpOnPause&&this.safeEmitAsPromise("@replacetrack",this._track).catch(()=>{}),this._observer.safeEmit("resume"))}async replaceTrack({track:e}){if(s.Logger.debug(l,"replaceTrack()"),this._closed){if(e&&this._stopTracks)try{if("audio"===e.kind){const t=c.getParameters().tracks.audio.findIndex(t=>e===t);s.Logger.warn(`Stopping AUDIOTRACK#${t} ${e.id}, ${e.label}, ${e.readyState}`)}else{const t=c.getParameters().tracks.video.findIndex(t=>e===t);s.Logger.warn(`Stopping VIDEOTRACK#${t} ${e.id}, ${e.label}, ${e.readyState}`)}e.stop()}catch(e){}throw new n.InvalidStateError("closed")}if(e&&"ended"===e.readyState)throw new n.InvalidStateError("track ended");e!==this._track?(this._zeroRtpOnPause&&this._paused||await this.safeEmitAsPromise("@replacetrack",e),this._destroyTrack(),this._track=e,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this._handleTrack()):s.Logger.debug(l,"replaceTrack() | same track, ignored")}async setMaxSpatialLayer(e){if(this._closed)throw new n.InvalidStateError("closed");if("video"!==this._kind)throw new n.UnsupportedError("not a video Producer");if("number"!=typeof e)throw new TypeError("invalid spatialLayer");e!==this._maxSpatialLayer&&(await this.safeEmitAsPromise("@setmaxspatiallayer",e),this._maxSpatialLayer=e)}async setRtpEncodingParameters(e){if(this._closed)throw new n.InvalidStateError("closed");if("object"!=typeof e)throw new TypeError("invalid params");await this.safeEmitAsPromise("@setrtpencodingparameters",e)}_onTrackEnded(){s.Logger.debug(l,'track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}_handleTrack(){this._track&&this._track.addEventListener("ended",this._onTrackEnded)}_destroyTrack(){this._track&&s.Logger.warn(l,"don not stop sender track")}}t.Producer=u},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Consumer=void 0;const s=i(7),o=i(36),n=i(37),a=r(i(1)),d=r(i(0)),c="Consumer";class l extends o.EnhancedEventEmitter{constructor({id:e,localId:t,producerId:i,rtpReceiver:r,track:n,rtpParameters:a,appData:d}){super(),this._closed=!1,this._observer=new o.EnhancedEventEmitter,s.Logger.debug(c,"constructor()"),this._id=e,this._localId=t,this._producerId=i,this._rtpReceiver=r,this._track=n,this._rtpParameters=a,this._paused=!n.enabled,this._appData=d,this._onTrackEnded=this._onTrackEnded.bind(this),this._handleTrack()}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(e){throw new a.default({code:d.default.APPDATA_ERROR,message:"cannot override appData object"})}get observer(){return this._observer}close(){this._closed||(s.Logger.debug(c,"close()"),this._closed=!0,this._destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(s.Logger.debug(c,"transportClosed()"),this._closed=!0,this._destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new n.InvalidStateError("closed");return this.safeEmitAsPromise("@getstats")}pause(){s.Logger.debug(c,"pause()"),this._closed?s.Logger.error(c,"pause() | Consumer closed"):(this._paused=!0,this._track.enabled=!1,this._observer.safeEmit("pause"))}resume(){s.Logger.debug(c,"resume()"),this._closed?s.Logger.error(c,"resume() | Consumer closed"):(this._paused=!1,this._track.enabled=!0,this._observer.safeEmit("resume"))}_onTrackEnded(){s.Logger.debug(c,'track "ended" event, %o, %s',this.id,this.kind),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}_handleTrack(){this._track.addEventListener("ended",this._onTrackEnded)}_destroyTrack(){s.Logger.warn(c,"don not stop receiver track")}}t.Consumer=l},function(e,t){var i=e.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(i).forEach((function(e){i[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DataReport=void 0;const r=i(53),s=i(55),o=i(22),n=i(13);let a="https://statistic.live.126.net/statics/report/common/form";t.DataReport=class{constructor(e){this.configs=e||{};const t=e.adapterRef;e.sdkRef;this.adapterRef=t;let i=t.instance,r=t.channelInfo||{},{sessionConfig:o={}}=r;this.cid=r.cid||r.channelId||0,this.uid=r.uid||0;let n=this.adapterRef.state.startSessionTime||Date.now();const a=i._params&&i._params.appkey;this.time=r.clientNtpTime-r.T4,this.common={name:"common",ver:"2.0",sdk_type:"nrtc2",session_id:s(this.cid+":"+this.uid+":"+n),app_key:a},this.eventKeys=[],this.eventMap={},this.api=[],this.heartbeat=null}addEvent(e,t){return-1==this.eventKeys.indexOf(e)&&this.eventKeys.push(e),t.time?t.time=t.time+this.time:(this.adapterRef.logger.warn(`addEvent:事件${e}没有time属性。使用当前时间戳`),t.time=Date.now()),this.eventMap[e]=t,this}updateCommon(e){return Object.assign(this.common,e),this}setHeartbeat(e){this.heartbeat=e;const t=Object.keys(this.adapterRef.apiEvent),i=Object.keys(this.adapterRef.apiEvents),r=t.concat(i.filter(e=>!t.includes(e)));let s=[];for(let e in r){const t=r[e];this.adapterRef.apiEvents[t]&&this.adapterRef.apiEvents[t].length?(s=s.concat(this.adapterRef.apiEvents[t]),this.adapterRef.apiEvents[t]=[]):this.adapterRef.apiEvent[t]&&this.adapterRef.apiEvent[t].length&&(s=s.concat(this.adapterRef.apiEvent[t]),this.adapterRef.apiEvent[t]=[])}return this.api=this.api.concat(s),this}setNetworkChange(e){return this.addEvent("networkChange",e),this}setLogin(e){var t,i,r;e.sdk_ver=e.sdk_ver||o.SDK_VERSION,e.platform=e.platform||"Web",e.app_key=e.app_key||this.common.app_key,e.meeting_mode=e.meeting_mode||1,e.model=e.model,e.build=o.BUILD,e.supported_codec_send=null===(t=this.adapterRef.mediaCapability.supportedCodecSend)||void 0===t?void 0:t.join(","),e.supported_codec_recv=null===(i=this.adapterRef.mediaCapability.supportedCodecRecv)||void 0===i?void 0:i.join(","),e.preferred_codec_send=null===(r=this.adapterRef.mediaCapability.preferredCodecSend.video)||void 0===r?void 0:r.join(","),e.extra_info=JSON.stringify({userAgent:n.USER_AGENT}),this.addEvent("login",e)}setRelogin(e){this.addEvent("relogin",e)}setLogout(e){this.addEvent("logout",e)}deviceAbnormal(e){this.addEvent("deviceAbnormal",e)}setDisconnect(e){this.addEvent("disconnect",e)}setRecvFirstFrame(e){this.addEvent("recvFirstFrame",e)}setSendFirstPackage(e){this.addEvent("firstPacketSent",e)}setRecvFirstPackage(e){this.addEvent("recvFirstPackage",e)}setFunction(e){this.addEvent("function",e)}reset(){this.eventKeys=[],this.api=[],this.heartbeat=null}send(e){let t={common:this.common};if(e||(e=this.eventKeys),this.heartbeat&&(t.heartbeat=this.heartbeat,this.api.length&&(this.api.forEach(e=>{e.uid||(e.uid=this.adapterRef.channelInfo&&this.adapterRef.channelInfo.uid),e.cid||(e.cid=this.adapterRef.channelInfo&&this.adapterRef.channelInfo.cid)}),t.event={apiEvent:this.api},this.api=[])),e){if(e.length){let i=0,r={};for(let t=e.length-1;t>=0;t--){const s=e[t];this.eventMap[s]&&(i++,r[s]=this.eventMap[s],delete this.eventMap[s],e.splice(t,1))}i&&(t.event=r)}}else if(!this.heartbeat)return this;return this.adapterRef.instance._params.neRtcServerAddresses.statisticsServer&&(a=this.adapterRef.instance._params.neRtcServerAddresses.statisticsServer),r.ajax({type:"post",url:a,data:t,header:{sdktype:this.common.sdk_type,appkey:this.common.app_key,platform:"web",sdkver:o.SDK_VERSION}}).then(t=>{e===this.eventKeys&&this.reset()}).catch(e=>{this.adapterRef.logger.log("dataReport, send error: ",e.name,e.message,e),this.reset()}),this}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.randomId=t.generateUUID=void 0;t.generateUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))};t.randomId=function(){return"xxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}},function(e,t,i){"use strict";var r=e.exports=i(228);r.build="light",r.load=function(e,t,i){return"function"==typeof t?(i=t,t=new r.Root):t||(t=new r.Root),t.load(e,i)},r.loadSync=function(e,t){return t||(t=new r.Root),t.loadSync(e)},r.encoder=i(129),r.decoder=i(130),r.verifier=i(131),r.converter=i(132),r.ReflectionObject=i(29),r.Namespace=i(40),r.Root=i(84),r.Enum=i(8),r.Type=i(79),r.Field=i(21),r.OneOf=i(41),r.MapField=i(80),r.Service=i(81),r.Method=i(82),r.Message=i(83),r.wrappers=i(133),r.types=i(30),r.util=i(4),r.ReflectionObject._configure(r.Root),r.Namespace._configure(r.Type,r.Service,r.Enum),r.Root._configure(r.Type),r.Field._configure(r.Type)},function(e,t,i){"use strict";e.exports=function(e,t){var i=new Array(arguments.length-1),r=0,s=2,o=!0;for(;s<arguments.length;)i[r++]=arguments[s++];return new Promise((function(s,n){i[r]=function(e){if(o)if(o=!1,e)n(e);else{for(var t=new Array(arguments.length-1),i=0;i<t.length;)t[i++]=arguments[i];s.apply(null,t)}};try{e.apply(t||null,i)}catch(e){o&&(o=!1,n(e))}}))}},function(module,exports,__webpack_require__){"use strict";function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(e){}return null}module.exports=inquire},function(e,t,i){"use strict";t.Service=i(237)},function(e,t,i){"use strict";e.exports={}},function(e,t,i){"use strict";e.exports=function(e){for(var t,i=o.codegen(["m","w"],e.name+"$encode")("if(!w)")("w=Writer.create()"),a=e.fieldsArray.slice().sort(o.compareFieldsById),d=0;d<a.length;++d){var c=a[d].resolve(),l=e._fieldsArray.indexOf(c),u=c.resolvedType instanceof r?"int32":c.type,p=s.basic[u];t="m"+o.safeProp(c.name),c.map?(i("if(%s!=null&&Object.hasOwnProperty.call(m,%j)){",t,c.name)("for(var ks=Object.keys(%s),i=0;i<ks.length;++i){",t)("w.uint32(%i).fork().uint32(%i).%s(ks[i])",(c.id<<3|2)>>>0,8|s.mapKey[c.keyType],c.keyType),void 0===p?i("types[%i].encode(%s[ks[i]],w.uint32(18).fork()).ldelim().ldelim()",l,t):i(".uint32(%i).%s(%s[ks[i]]).ldelim()",16|p,u,t),i("}")("}")):c.repeated?(i("if(%s!=null&&%s.length){",t,t),c.packed&&void 0!==s.packed[u]?i("w.uint32(%i).fork()",(c.id<<3|2)>>>0)("for(var i=0;i<%s.length;++i)",t)("w.%s(%s[i])",u,t)("w.ldelim()"):(i("for(var i=0;i<%s.length;++i)",t),void 0===p?n(i,c,l,t+"[i]"):i("w.uint32(%i).%s(%s[i])",(c.id<<3|p)>>>0,u,t)),i("}")):(c.optional&&i("if(%s!=null&&Object.hasOwnProperty.call(m,%j))",t,c.name),void 0===p?n(i,c,l,t):i("w.uint32(%i).%s(%s)",(c.id<<3|p)>>>0,u,t))}return i("return w")};var r=i(8),s=i(30),o=i(4);function n(e,t,i,r){return t.resolvedType.group?e("types[%i].encode(%s,w.uint32(%i)).uint32(%i)",i,r,(t.id<<3|3)>>>0,(t.id<<3|4)>>>0):e("types[%i].encode(%s,w.uint32(%i).fork()).ldelim()",i,r,(t.id<<3|2)>>>0)}},function(e,t,i){"use strict";e.exports=function(e){var t=o.codegen(["r","l"],e.name+"$decode")("if(!(r instanceof Reader))")("r=Reader.create(r)")("var c=l===undefined?r.len:r.pos+l,m=new this.ctor"+(e.fieldsArray.filter((function(e){return e.map})).length?",k,value":""))("while(r.pos<c){")("var t=r.uint32()");e.group&&t("if((t&7)===4)")("break");t("switch(t>>>3){");for(var i=0;i<e.fieldsArray.length;++i){var a=e._fieldsArray[i].resolve(),d=a.resolvedType instanceof r?"int32":a.type,c="m"+o.safeProp(a.name);t("case %i:",a.id),a.map?(t("if(%s===util.emptyObject)",c)("%s={}",c)("var c2 = r.uint32()+r.pos"),void 0!==s.defaults[a.keyType]?t("k=%j",s.defaults[a.keyType]):t("k=null"),void 0!==s.defaults[d]?t("value=%j",s.defaults[d]):t("value=null"),t("while(r.pos<c2){")("var tag2=r.uint32()")("switch(tag2>>>3){")("case 1: k=r.%s(); break",a.keyType)("case 2:"),void 0===s.basic[d]?t("value=types[%i].decode(r,r.uint32())",i):t("value=r.%s()",d),t("break")("default:")("r.skipType(tag2&7)")("break")("}")("}"),void 0!==s.long[a.keyType]?t('%s[typeof k==="object"?util.longToHash(k):k]=value',c):t("%s[k]=value",c)):a.repeated?(t("if(!(%s&&%s.length))",c,c)("%s=[]",c),void 0!==s.packed[d]&&t("if((t&7)===2){")("var c2=r.uint32()+r.pos")("while(r.pos<c2)")("%s.push(r.%s())",c,d)("}else"),void 0===s.basic[d]?t(a.resolvedType.group?"%s.push(types[%i].decode(r))":"%s.push(types[%i].decode(r,r.uint32()))",c,i):t("%s.push(r.%s())",c,d)):void 0===s.basic[d]?t(a.resolvedType.group?"%s=types[%i].decode(r)":"%s=types[%i].decode(r,r.uint32())",c,i):t("%s=r.%s()",c,d),t("break")}for(t("default:")("r.skipType(t&7)")("break")("}")("}"),i=0;i<e._fieldsArray.length;++i){var l=e._fieldsArray[i];l.required&&t("if(!m.hasOwnProperty(%j))",l.name)("throw util.ProtocolError(%j,{instance:m})",n(l))}return t("return m")};var r=i(8),s=i(30),o=i(4);function n(e){return"missing required '"+e.name+"'"}},function(e,t,i){"use strict";e.exports=function(e){var t=s.codegen(["m"],e.name+"$verify")('if(typeof m!=="object"||m===null)')("return%j","object expected"),i=e.oneofsArray,r={};i.length&&t("var p={}");for(var d=0;d<e.fieldsArray.length;++d){var c=e._fieldsArray[d].resolve(),l="m"+s.safeProp(c.name);if(c.optional&&t("if(%s!=null&&m.hasOwnProperty(%j)){",l,c.name),c.map)t("if(!util.isObject(%s))",l)("return%j",o(c,"object"))("var k=Object.keys(%s)",l)("for(var i=0;i<k.length;++i){"),a(t,c,"k[i]"),n(t,c,d,l+"[k[i]]")("}");else if(c.repeated)t("if(!Array.isArray(%s))",l)("return%j",o(c,"array"))("for(var i=0;i<%s.length;++i){",l),n(t,c,d,l+"[i]")("}");else{if(c.partOf){var u=s.safeProp(c.partOf.name);1===r[c.partOf.name]&&t("if(p%s===1)",u)("return%j",c.partOf.name+": multiple values"),r[c.partOf.name]=1,t("p%s=1",u)}n(t,c,d,l)}c.optional&&t("}")}return t("return null")};var r=i(8),s=i(4);function o(e,t){return e.name+": "+t+(e.repeated&&"array"!==t?"[]":e.map&&"object"!==t?"{k:"+e.keyType+"}":"")+" expected"}function n(e,t,i,s){if(t.resolvedType)if(t.resolvedType instanceof r){e("switch(%s){",s)("default:")("return%j",o(t,"enum value"));for(var n=Object.keys(t.resolvedType.values),a=0;a<n.length;++a)e("case %i:",t.resolvedType.values[n[a]]);e("break")("}")}else e("{")("var e=types[%i].verify(%s);",i,s)("if(e)")("return%j+e",t.name+".")("}");else switch(t.type){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":e("if(!util.isInteger(%s))",s)("return%j",o(t,"integer"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":e("if(!util.isInteger(%s)&&!(%s&&util.isInteger(%s.low)&&util.isInteger(%s.high)))",s,s,s,s)("return%j",o(t,"integer|Long"));break;case"float":case"double":e('if(typeof %s!=="number")',s)("return%j",o(t,"number"));break;case"bool":e('if(typeof %s!=="boolean")',s)("return%j",o(t,"boolean"));break;case"string":e("if(!util.isString(%s))",s)("return%j",o(t,"string"));break;case"bytes":e('if(!(%s&&typeof %s.length==="number"||util.isString(%s)))',s,s,s)("return%j",o(t,"buffer"))}return e}function a(e,t,i){switch(t.keyType){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":e("if(!util.key32Re.test(%s))",i)("return%j",o(t,"integer key"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":e("if(!util.key64Re.test(%s))",i)("return%j",o(t,"integer|Long key"));break;case"bool":e("if(!util.key2Re.test(%s))",i)("return%j",o(t,"boolean key"))}return e}},function(e,t,i){"use strict";var r=t,s=i(8),o=i(4);function n(e,t,i,r){if(t.resolvedType)if(t.resolvedType instanceof s){e("switch(d%s){",r);for(var o=t.resolvedType.values,n=Object.keys(o),a=0;a<n.length;++a)t.repeated&&o[n[a]]===t.typeDefault&&e("default:"),e("case%j:",n[a])("case %i:",o[n[a]])("m%s=%j",r,o[n[a]])("break");e("}")}else e('if(typeof d%s!=="object")',r)("throw TypeError(%j)",t.fullName+": object expected")("m%s=types[%i].fromObject(d%s)",r,i,r);else{var d=!1;switch(t.type){case"double":case"float":e("m%s=Number(d%s)",r,r);break;case"uint32":case"fixed32":e("m%s=d%s>>>0",r,r);break;case"int32":case"sint32":case"sfixed32":e("m%s=d%s|0",r,r);break;case"uint64":d=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":e("if(util.Long)")("(m%s=util.Long.fromValue(d%s)).unsigned=%j",r,r,d)('else if(typeof d%s==="string")',r)("m%s=parseInt(d%s,10)",r,r)('else if(typeof d%s==="number")',r)("m%s=d%s",r,r)('else if(typeof d%s==="object")',r)("m%s=new util.LongBits(d%s.low>>>0,d%s.high>>>0).toNumber(%s)",r,r,r,d?"true":"");break;case"bytes":e('if(typeof d%s==="string")',r)("util.base64.decode(d%s,m%s=util.newBuffer(util.base64.length(d%s)),0)",r,r,r)("else if(d%s.length)",r)("m%s=d%s",r,r);break;case"string":e("m%s=String(d%s)",r,r);break;case"bool":e("m%s=Boolean(d%s)",r,r)}}return e}function a(e,t,i,r){if(t.resolvedType)t.resolvedType instanceof s?e("d%s=o.enums===String?types[%i].values[m%s]:m%s",r,i,r,r):e("d%s=types[%i].toObject(m%s,o)",r,i,r);else{var o=!1;switch(t.type){case"double":case"float":e("d%s=o.json&&!isFinite(m%s)?String(m%s):m%s",r,r,r,r);break;case"uint64":o=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":e('if(typeof m%s==="number")',r)("d%s=o.longs===String?String(m%s):m%s",r,r,r)("else")("d%s=o.longs===String?util.Long.prototype.toString.call(m%s):o.longs===Number?new util.LongBits(m%s.low>>>0,m%s.high>>>0).toNumber(%s):m%s",r,r,r,r,o?"true":"",r);break;case"bytes":e("d%s=o.bytes===String?util.base64.encode(m%s,0,m%s.length):o.bytes===Array?Array.prototype.slice.call(m%s):m%s",r,r,r,r,r);break;default:e("d%s=m%s",r,r)}}return e}r.fromObject=function(e){var t=e.fieldsArray,i=o.codegen(["d"],e.name+"$fromObject")("if(d instanceof this.ctor)")("return d");if(!t.length)return i("return new this.ctor");i("var m=new this.ctor");for(var r=0;r<t.length;++r){var a=t[r].resolve(),d=o.safeProp(a.name);a.map?(i("if(d%s){",d)('if(typeof d%s!=="object")',d)("throw TypeError(%j)",a.fullName+": object expected")("m%s={}",d)("for(var ks=Object.keys(d%s),i=0;i<ks.length;++i){",d),n(i,a,r,d+"[ks[i]]")("}")("}")):a.repeated?(i("if(d%s){",d)("if(!Array.isArray(d%s))",d)("throw TypeError(%j)",a.fullName+": array expected")("m%s=[]",d)("for(var i=0;i<d%s.length;++i){",d),n(i,a,r,d+"[i]")("}")("}")):(a.resolvedType instanceof s||i("if(d%s!=null){",d),n(i,a,r,d),a.resolvedType instanceof s||i("}"))}return i("return m")},r.toObject=function(e){var t=e.fieldsArray.slice().sort(o.compareFieldsById);if(!t.length)return o.codegen()("return {}");for(var i=o.codegen(["m","o"],e.name+"$toObject")("if(!o)")("o={}")("var d={}"),r=[],n=[],d=[],c=0;c<t.length;++c)t[c].partOf||(t[c].resolve().repeated?r:t[c].map?n:d).push(t[c]);if(r.length){for(i("if(o.arrays||o.defaults){"),c=0;c<r.length;++c)i("d%s=[]",o.safeProp(r[c].name));i("}")}if(n.length){for(i("if(o.objects||o.defaults){"),c=0;c<n.length;++c)i("d%s={}",o.safeProp(n[c].name));i("}")}if(d.length){for(i("if(o.defaults){"),c=0;c<d.length;++c){var l=d[c],u=o.safeProp(l.name);if(l.resolvedType instanceof s)i("d%s=o.enums===String?%j:%j",u,l.resolvedType.valuesById[l.typeDefault],l.typeDefault);else if(l.long)i("if(util.Long){")("var n=new util.Long(%i,%i,%j)",l.typeDefault.low,l.typeDefault.high,l.typeDefault.unsigned)("d%s=o.longs===String?n.toString():o.longs===Number?n.toNumber():n",u)("}else")("d%s=o.longs===String?%j:%i",u,l.typeDefault.toString(),l.typeDefault.toNumber());else if(l.bytes){var p="["+Array.prototype.slice.call(l.typeDefault).join(",")+"]";i("if(o.bytes===String)d%s=%j",u,String.fromCharCode.apply(String,l.typeDefault))("else{")("d%s=%s",u,p)("if(o.bytes!==Array)d%s=util.newBuffer(d%s)",u,u)("}")}else i("d%s=%j",u,l.typeDefault)}i("}")}var h=!1;for(c=0;c<t.length;++c){l=t[c];var f=e._fieldsArray.indexOf(l);u=o.safeProp(l.name);l.map?(h||(h=!0,i("var ks2")),i("if(m%s&&(ks2=Object.keys(m%s)).length){",u,u)("d%s={}",u)("for(var j=0;j<ks2.length;++j){"),a(i,l,f,u+"[ks2[j]]")("}")):l.repeated?(i("if(m%s&&m%s.length){",u,u)("d%s=[]",u)("for(var j=0;j<m%s.length;++j){",u),a(i,l,f,u+"[j]")("}")):(i("if(m%s!=null&&m.hasOwnProperty(%j)){",u,l.name),a(i,l,f,u),l.partOf&&i("if(o.oneofs)")("d%s=%j",o.safeProp(l.partOf.name),l.name)),i("}")}return i("return d")}},function(e,t,i){"use strict";var r=t,s=i(83);r[".google.protobuf.Any"]={fromObject:function(e){if(e&&e["@type"]){var t=e["@type"].substring(e["@type"].lastIndexOf("/")+1),i=this.lookup(t);if(i){var r="."===e["@type"].charAt(0)?e["@type"].substr(1):e["@type"];return-1===r.indexOf("/")&&(r="/"+r),this.create({type_url:r,value:i.encode(i.fromObject(e)).finish()})}}return this.fromObject(e)},toObject:function(e,t){var i="",r="";if(t&&t.json&&e.type_url&&e.value){r=e.type_url.substring(e.type_url.lastIndexOf("/")+1),i=e.type_url.substring(0,e.type_url.lastIndexOf("/")+1);var o=this.lookup(r);o&&(e=o.decode(e.value))}if(!(e instanceof this.ctor)&&e instanceof s){var n=e.$type.toObject(e,t);return""===i&&(i="type.googleapis.com/"),r=i+("."===e.$type.fullName[0]?e.$type.fullName.substr(1):e.$type.fullName),n["@type"]=r,n}return this.toObject(e,t)}}},function(e,t,i){"use strict";e.exports=h;var r=/[\s{}=;:[\],'"()<>]/g,s=/(?:"([^"\\]*(?:\\.[^"\\]*)*)")/g,o=/(?:'([^'\\]*(?:\\.[^'\\]*)*)')/g,n=/^ *[*/]+ */,a=/^\s*\*?\/*/,d=/\n/g,c=/\s/,l=/\\(.?)/g,u={0:"\0",r:"\r",n:"\n",t:"\t"};function p(e){return e.replace(l,(function(e,t){switch(t){case"\\":case"":return t;default:return u[t]||""}}))}function h(e,t){e=e.toString();var i=0,l=e.length,u=1,h=null,f=null,m=0,g=!1,v=!1,y=[],_=null;function S(e){return Error("illegal "+e+" (line "+u+")")}function b(t){return e.charAt(t)}function R(i,r,s){h=e.charAt(i++),m=u,g=!1,v=s;var o,c=i-(t?2:3);do{if(--c<0||"\n"===(o=e.charAt(c))){g=!0;break}}while(" "===o||"\t"===o);for(var l=e.substring(i,r).split(d),p=0;p<l.length;++p)l[p]=l[p].replace(t?a:n,"").trim();f=l.join("\n").trim()}function w(t){var i=T(t),r=e.substring(t,i);return/^\s*\/{1,2}/.test(r)}function T(e){for(var t=e;t<l&&"\n"!==b(t);)t++;return t}function A(){if(y.length>0)return y.shift();if(_)return function(){var t="'"===_?o:s;t.lastIndex=i-1;var r=t.exec(e);if(!r)throw S("string");return i=t.lastIndex,E(_),_=null,p(r[1])}();var n,a,d,h,f,m=0===i;do{if(i===l)return null;for(n=!1;c.test(d=b(i));)if("\n"===d&&(m=!0,++u),++i===l)return null;if("/"===b(i)){if(++i===l)throw S("comment");if("/"===b(i))if(t){if(h=i,f=!1,w(i)){f=!0;do{if((i=T(i))===l)break;i++}while(w(i))}else i=Math.min(l,T(i)+1);f&&R(h,i,m),u++,n=!0}else{for(f="/"===b(h=i+1);"\n"!==b(++i);)if(i===l)return null;++i,f&&R(h,i-1,m),++u,n=!0}else{if("*"!==(d=b(i)))return"/";h=i+1,f=t||"*"===b(h);do{if("\n"===d&&++u,++i===l)throw S("comment");a=d,d=b(i)}while("*"!==a||"/"!==d);++i,f&&R(h,i-2,m),n=!0}}}while(n);var g=i;if(r.lastIndex=0,!r.test(b(g++)))for(;g<l&&!r.test(b(g));)++g;var v=e.substring(i,i=g);return'"'!==v&&"'"!==v||(_=v),v}function E(e){y.push(e)}function I(){if(!y.length){var e=A();if(null===e)return null;E(e)}return y[0]}return Object.defineProperty({next:A,peek:I,push:E,skip:function(e,t){var i=I();if(i===e)return A(),!0;if(!t)throw S("token '"+i+"', '"+e+"' expected");return!1},cmnt:function(e){var i=null;return void 0===e?m===u-1&&(t||"*"===h||g)&&(i=v?f:null):(m<e&&I(),m!==e||g||!t&&"/"!==h||(i=v?null:f)),i}},"line",{get:function(){return u}})}h.unescape=p},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(136),o=i(252),n=i(26),a=i(253),d=i(88),c=i(22),l=i(42),u=i(254),p=i(255),h=i(23),f=i(14),m=i(115),g=r(i(24)),v=r(i(1)),y=r(i(0)),_=i(2),S=i(58);let b;const R={Logger:{DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4,setLogLevel(e){g.default.setLogLevel(e)},enableLogUpload(){g.default.enableLogUpload()},disableLogUpload(){g.default.disableLogUpload()}},createClient(e){h.checkExists({tag:"createClient:ClientOptions",value:e}),h.checkExists({tag:"createClient:ClientOptions.appkey",value:e.appkey});const t=new s.Client(Object.assign(e,{apiList:[],ref:R}));return _.getParameters().clients.push(t),b||(b=t),t},createStream(e){if(h.checkExists({tag:"createStream:options",value:e}),e.screenAudio&&!e.screen)throw new v.default({code:y.default.INVALID_OPERATION,message:"createStream:screenAudio要与screen一起开启"});if(!e.client&&b&&b.adapterRef.logger.warn("createStream: 未传入client参数。使用默认Client。"),b||e.client){const t=new o.LocalStream(Object.assign(e,{isRemote:!1,client:e.client||b}));return _.getParameters().localStreams.push(t),t}return a.clientNotYetUninitialized},Device:n.Device,getDevices:(e=!1)=>n.Device.getDevices({audioinput:!0,audiooutput:!0,videoinput:!0,requestPerm:e}),getCameras:(e=!1)=>n.Device.getCameras(e),getMicrophones:(e=!1)=>n.Device.getMicrophones(e),getSpeakers:(e=!1)=>n.Device.getSpeakers(e),checkSystemRequirements(){let e=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,t=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,i=window.WebSocket,r=S.isBrowserSupported();return!!(e&&t&&i&&r)},getSupportedCodec:async()=>await f.getSupportedCodecs(),getHandler:()=>m.detectDevice(),getParameters:_.getParameters,destroy(e){let t=e||b;t&&t.destroy(),e||(b=null)},PlatformTypeMap:d.PlatformTypeMap,CHAT_VIDEO_FRAME_RATE_NORMAL:l.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_NORMAL,CHAT_VIDEO_FRAME_RATE_5:l.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_5,CHAT_VIDEO_FRAME_RATE_10:l.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_10,CHAT_VIDEO_FRAME_RATE_15:l.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_15,CHAT_VIDEO_FRAME_RATE_20:l.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_20,CHAT_VIDEO_FRAME_RATE_25:l.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_25,VIDEO_QUALITY_180p:l.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_180p,VIDEO_QUALITY_480p:l.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p,VIDEO_QUALITY_720p:l.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_720p,VIDEO_QUALITY_1080p:l.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p,LIVE_STREAM_AUDIO_CODEC_PROFILE:u.LIVE_STREAM_AUDIO_CODEC_PROFILE,LIVE_STREAM_AUDIO_SAMPLE_RATE:u.LIVE_STREAM_AUDIO_SAMPLE_RATE,VIDEO_FRAME_RATE:l.VIDEO_FRAME_RATE,VIDEO_QUALITY:l.NERTC_VIDEO_QUALITY,NETWORK_STATUS:p.NETWORK_STATUS,STREAM_TYPE:l.STREAM_TYPE,VERSION:c.SDK_VERSION,BUILD:c.BUILD,ENV:c.ENV};e.exports=R,window.WebRTC2=R},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Client=void 0;const s=i(137),o=i(23),n=i(59),a=r(i(1)),d=r(i(0)),c=i(22),l=i(42),u=i(26),p=i(250),h=i(251),f=i(90),m=i(2),g=i(57);i(11);class v extends s.Base{constructor(e){super(e),this.destroyed=!1,this.onJoinFinish=null,this.spatialManager=null,this.operationQueue=new p.OperationQueue(this.logger),this.handlePageUnload=e=>{"join"!==this.adapterRef.channelStatus&&"connectioning"!==this.adapterRef.channelStatus||(this.logger.warn(`收到 ${null==e?void 0:e.type} 事件，当前状态：${this.adapterRef.channelStatus}，即将离开房间`),this.leave())},this.handleOnOnlineOffline=e=>{var t,i,r,s,o;"online"===(null==e?void 0:e.type)?"CONNECTING"===this.adapterRef.connectState.curState?(this.logger.warn("侦测到网络恢复，恢复重连过程"),this.resumeReconnection()):this.logger.warn("侦测到网络恢复"):"offline"===(null==e?void 0:e.type)&&("CONNECTED"===this.adapterRef.connectState.curState?(this.logger.warn("侦测到网络断开，主动断开连接"),this.pauseReconnection(),null===(i=null===(t=this.adapterRef._mediasoup)||void 0===t?void 0:t._sendTransport)||void 0===i||i.close(),null===(s=null===(r=this.adapterRef._mediasoup)||void 0===r?void 0:r._recvTransport)||void 0===s||s.close(),this.adapterRef.channelStatus="connectioning",null===(o=this.adapterRef._signalling)||void 0===o||o._reconnection()):this.logger.warn("侦测到网络断开"))},m.getParameters().leaveOnUnload&&(window.addEventListener("pagehide",this.handlePageUnload),window.addEventListener("beforeunload",this.handlePageUnload)),m.getParameters().trustOnOnline&&(window.addEventListener("online",this.handleOnOnlineOffline),window.addEventListener("offline",this.handleOnOnlineOffline)),this._roleInfo={userRole:0,audienceList:{}},this._init(e),this.logger.info(`NERTC ${c.SDK_VERSION} ${c.BUILD}: 客户端创建成功。`)}safeEmit(e,...t){try{this.emit(e,...t)}catch(t){this.logger.error(`Error on event ${e}: ${t.name} ${t.message}`,t.stack)}}_init(e){this.initWebSocket();const{appkey:t="",token:i}=e;if(!t)throw this.logger.error("Client: init error: 请传入appkey"),new a.default({code:d.default.INVALID_PARAMETER,message:"请传入appkey"});this._params.appkey=t,this._params.token=i,this._roleInfo={userRole:0,audienceList:{}},u.Device.deviceInited||u.Device.startDeviceChangeDetection(),u.Device.on("recording-device-changed",e=>{this.destroyed||this.safeEmit("recording-device-changed",e)}),u.Device.on("camera-changed",e=>{this.destroyed||this.safeEmit("camera-changed",e)}),u.Device.on("playout-device-changed",e=>{this.destroyed||this.safeEmit("playout-device-changed",e)});const r=()=>{this.onJoinFinish?(this.onJoinFinish(),this.onJoinFinish=null):this.logger.debug("孤立的join完成回调")};this.on("pairing-join-success",r),this.on("pairing-join-error",r)}getUid(){return this.adapterRef.channelInfo&&this.adapterRef.channelInfo.uid}getChannelInfo(){return this.adapterRef.channelInfo||{}}startProxyServer(e){if(this.adapterRef.logger.log("startProxyServer, type: ",e),"join"===this.adapterRef.channelStatus||"connectioning"===this.adapterRef.channelStatus)return this.adapterRef.logger.error("startProxyServer: 请在加入房间前调用"),"INVALID_OPERATION";this.adapterRef.proxyServer.enable=!0,e&&(this.adapterRef.proxyServer.type=e)}stopProxyServer(){this.adapterRef.logger.log("stopProxyServer"),this.adapterRef.proxyServer&&(this.adapterRef.proxyServer.enable=!1)}setLocalMediaPriority(e){if(this.logger.log("setLocalMediaPriority, options: ",JSON.stringify(e)),"join"===this.adapterRef.channelStatus||"connectioning"===this.adapterRef.channelStatus)return this.logger.error("setLocalMediaPriority: 请在加入房间前调用"),"INVALID_OPERATION";const{priority:t=100,preemtiveMode:i=!1}=e;if("number"!=typeof t||isNaN(t))throw new a.default({code:d.default.INVALID_PARAMETER,message:"setLocalMediaPriority: priority is not Number"});this.adapterRef.userPriority=e}async join(e){if(this.logger.log("加入频道, options: ",JSON.stringify(e,null," ")),!e.channelName)throw new a.default({code:d.default.INVALID_PARAMETER,message:"请填写房间名称"});if(e.joinChannelRecordConfig&&(o.checkValidBoolean({tag:"joinOptions.joinChannelRecordConfig.recordAudio should be boolean",value:e.joinChannelRecordConfig.recordAudio}),o.checkValidBoolean({tag:"joinOptions.joinChannelRecordConfig.recordVideo should be boolean",value:e.joinChannelRecordConfig.recordVideo})),"string"==typeof e.uid)this.logger.log("uid是string类型"),this.adapterRef.channelInfo.uidType="string";else{if("number"!=typeof e.uid)return this.logger.error("uid参数格式非法"),Promise.reject(new a.default({code:d.default.INVALID_PARAMETER,message:"uid is invalid"}));if(this.logger.log("uid是number类型"),this.adapterRef.channelInfo.uidType="number",e.uid>Number.MAX_SAFE_INTEGER)throw new a.default({code:d.default.INVALID_PARAMETER,message:"uid is exceeds the scope of Number"})}if(this.onJoinFinish=await this.operationQueue.enqueue({caller:this,method:"join",options:e}),this.emit("pairing-join-start"),this.adapterRef._statsReport||this.initWebSocket(),"join"===this.adapterRef.channelStatus||"connectioning"===this.adapterRef.channelStatus)return this.emit("pairing-join-error"),Promise.reject(new a.default({code:d.default.REPEAT_JOIN,message:"repeatedly join"}));if(this.adapterRef.connectState.curState="CONNECTING",this.adapterRef.connectState.prevState="DISCONNECTED",this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),e.spatial&&this.initSpatialManager(e.spatial),e.token&&(this._params.token=e.token),this._params.JoinChannelRequestParam4WebRTC2={startJoinTime:Date.now(),appkey:this._params.appkey,userRole:this._roleInfo.userRole,channelName:e.channelName,wssArr:e.wssArr,uid:e.uid,token:this._params.token,joinChannelLiveConfig:e.joinChannelLiveConfig||{liveEnable:!1},joinChannelRecordConfig:e.joinChannelRecordConfig||{recordAudio:!1,recordVideo:!1,recordType:0,isHostSpeaker:!1}},e.neRtcServerAddresses&&(this._params.neRtcServerAddresses={channelServer:e.neRtcServerAddresses.channelServer||"",statisticsServer:e.neRtcServerAddresses.statisticsServer||"",roomServer:e.neRtcServerAddresses.roomServer||"",webSocketProxyServer:e.neRtcServerAddresses.webSocketProxyServer||"",mediaProxyServer:e.neRtcServerAddresses.mediaProxyServer||""}),this.setStartSessionTime(),this.initMode(),!this.adapterRef.mediaCapability.supportedCodecRecv||!this.adapterRef.mediaCapability.supportedCodecSend)try{await this.adapterRef.mediaCapability.detect()}catch(e){this.logger.error("Failed to detect mediaCapability",e.name,e.message)}if(!this.adapterRef._meetings)throw this.emit("pairing-join-error"),new a.default({code:d.default.NO_MEETINGS,message:"meetings error"});try{const e=await this.adapterRef._meetings.joinChannel(this._params.JoinChannelRequestParam4WebRTC2);return this.emit("pairing-join-success"),e}catch(e){throw this.emit("pairing-join-error"),e}}async leave(){const e=await this.operationQueue.enqueue({caller:this,method:"leave",options:null});this.logger.log("离开频道"),"join"!==this.adapterRef.channelStatus&&"connectioning"!==this.adapterRef.channelStatus&&this.logger.log(" 状态: ",this.adapterRef.channelStatus),this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTING",this.adapterRef.connectState.reconnecting=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.setEndSessionTime(),this.adapterRef._meetings?this.adapterRef._meetings.leaveChannel().then(e):e()}async leaveRts(){this.logger.log("离开频道"),"join"!==this.adapterRef.channelStatus&&"connectioning"!==this.adapterRef.channelStatus&&this.logger.log(" 状态: ",this.adapterRef.channelStatus),this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTING",this.adapterRef.connectState.reconnecting=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.setEndSessionTime(),this.adapterRef._meetings&&this.adapterRef._meetings.leaveChannel()}async publish(e){o.checkExists({tag:"client.publish:stream",value:e}),await this.doPublish(e)}async doPublish(e){const t=await this.operationQueue.enqueue({caller:this,method:"publish",options:e});let i="";e&&(e.audio||e.video||e.screen||e.screenAudio)?1===this._roleInfo.userRole?(this.logger.error("publish：观众禁止Publish，请先使用setClientRole设为主播"),i="INVALID_OPERATION"):"CONNECTING"===this.adapterRef.connectState.curState?(this.logger.error("publish: 当前正在连接，将在连接成功后发布媒体流"),i="PUBLISH_ON_CONNECTING",this.bindLocalStream(e)):"CONNECTED"!==this.adapterRef.connectState.curState&&(this.logger.error("publish: 当前不在频道中，可能是没有加入频道或者是网络波动导致暂时断开连接"),i="INVALID_OPERATION"):e&&m.getParameters().allowEmptyMedia?this.logger.log("publish: 当前模式允许发布没有媒体流的localStream"):(this.logger.error("publish: 传入的 stream 格式非法，没有媒体数据"),i="INVALID_LOCAL_STREAM");const r=JSON.stringify({videoProfile:e.videoProfile,audio:e.audio,screenAudio:e.screenAudio,audioProfile:e.audioProfile,cameraId:e.cameraId,microphoneId:e.microphoneId,pubStatus:e.pubStatus,renderMode:e.renderMode,screen:e.screen,screenProfile:e.screenProfile,reason:i},null," ");if(i)return this.apiFrequencyControl({name:"publish",code:-1,param:r}),"INVALID_OPERATION"===i?(t(),Promise.reject(new a.default({code:d.default.INVALID_OPERATION,message:"invalid operation"}))):"INVALID_LOCAL_STREAM"===i?(t(),Promise.reject(new a.default({code:d.default.NO_LOCALSTREAM,message:"no localStream"}))):void t();try{if(!this.adapterRef._mediasoup)throw t(),new a.default({code:d.default.NO_MEDIASERVER,message:"media server error 4"});this.bindLocalStream(e),await this.adapterRef._mediasoup.createProduce(e,"all"),t(),this.apiFrequencyControl({name:"publish",code:0,param:r})}catch(e){this.logger.error("API调用失败：Client:publish",e.name,e.message,e.stack,...arguments),t(),this.apiFrequencyControl({name:"publish",code:-1,param:r})}}async unpublish(e){o.checkExists({tag:"client.unpublish:stream",value:e});const t=await this.operationQueue.enqueue({caller:this,method:"unpublish",options:null});let i="";"CONNECTING"===this.adapterRef.connectState.curState?(this.logger.error("unpublish: 当前正在连接，连接成功后将不再发送媒体流"),i="UNPUBLISH_ON_CONNECTING",this.adapterRef.localStream=null):"CONNECTED"!==this.adapterRef.connectState.curState&&(this.logger.error("unpublish: 当前不在频道中，可能是没有加入频道或者是网络波动导致暂时断开连接"),i="INVALID_OPERATION");const r=JSON.stringify({videoProfile:e&&e.videoProfile,audio:e&&e.audio,audioProfile:e&&e.audioProfile,cameraId:e&&e.cameraId,microphoneId:e&&e.microphoneId,pubStatus:e&&e.pubStatus,renderMode:e&&e.renderMode,screen:e&&e.screen,screenProfile:e&&e.screenProfile,reason:i},null," ");if(i)return this.apiFrequencyControl({name:"unpublish",code:-1,param:r}),"INVALID_OPERATION"===i?(t(),Promise.reject(new a.default({code:d.default.INVALID_OPERATION,message:"invalid operation"}))):"INVALID_LOCAL_STREAM"===i?(t(),Promise.reject(new a.default({code:d.default.NO_LOCALSTREAM,message:"no localStream"}))):void t();this.logger.log("开始取消发布本地流");try{if(!this.adapterRef._mediasoup)throw new a.default({code:d.default.NO_MEDIASERVER,message:"media server error 5"});await this.adapterRef._mediasoup.destroyProduce("audio"),await this.adapterRef._mediasoup.destroyProduce("video"),await this.adapterRef._mediasoup.destroyProduce("screen"),this.adapterRef.localStream=null,this.apiFrequencyControl({name:"unpublish",code:0,param:JSON.stringify({videoProfile:e&&e.videoProfile,audio:e&&e.audio,audioProfile:e&&e.audioProfile,cameraId:e&&e.cameraId,microphoneId:e&&e.microphoneId,pubStatus:e&&e.pubStatus,renderMode:e&&e.renderMode,screen:e&&e.screen,screenProfile:e&&e.screenProfile},null," ")}),t()}catch(i){this.logger.error("API调用失败：Client:unpublish",i,...arguments),t(),this.apiFrequencyControl({name:"unpublish",code:-1,param:JSON.stringify({reason:i,videoProfile:e&&e.videoProfile,audio:e&&e.audio,audioProfile:e&&e.audioProfile,cameraId:e&&e.cameraId,microphoneId:e&&e.microphoneId,pubStatus:e&&e.pubStatus,renderMode:e&&e.renderMode,screen:e&&e.screen,screenProfile:e&&e.screenProfile},null," ")})}}getSubStatus(e,t){let i={status:"unsubscribed",subscribable:!1};if("all"===t){const t=[this.getSubStatus(e,"audio"),this.getSubStatus(e,"video"),this.getSubStatus(e,"screen")];t.find(e=>"unsubscribing"===e.status)?i.status="unsubscribing":t.find(e=>"subscribing"===e.status)&&(i.status="subscribing"),t.find(e=>"subscribed"===e.status)&&(i.status="subscribed"),"subscribed"!==i.status&&"unsubscribed"!==i.status||t.find(e=>e.subscribable)&&(i.subscribable=!0)}else"start"===e.pubStatus[t].stopconsumerStatus?i.status="unsubscribing":"start"===e.pubStatus[t].consumerStatus?i.status="subscribing":e.pubStatus[t].consumerId?i.status="subscribed":"unsubscribed"===i.status&&e.pubStatus[t].producerId&&e.subConf[t]&&(i.subscribable=!0);return i}async subscribe(e){if(!this.spatialManager)return o.checkExists({tag:"client.subscribe:stream",value:e}),this.logger.log(`subscribe() [订阅远端: ${e.stringStreamID}]`),this.doSubscribe(e);this.logger.warn("subscribe() 已开启空间音频，跳过用户订阅步骤")}async doSubscribe(e){const t=e.getId();if(!t)throw new a.default({code:d.default.INVALID_PARAMETER,message:"No uid"});if(!this.adapterRef._mediasoup)throw new a.default({code:d.default.NO_MEDIASERVER,message:"media server error 6"});try{if(e.subConf.audio)e.pubStatus.audio.audio&&!e.pubStatus.audio.consumerId&&"start"!==e.pubStatus.audio.consumerStatus&&(this.logger.log(`subscribe() [开始订阅 ${e.getId()} 音频流]`),e.pubStatus.audio.consumerStatus="start",await this.adapterRef._mediasoup.createConsumer(t,"audio","audio",e.pubStatus.audio.producerId),e.pubStatus.audio.consumerStatus="end",this.logger.log(`subscribe() [订阅 ${e.getId()} 音频流完成]`));else if(e.pubStatus.audio.consumerId&&"start"!==e.pubStatus.audio.stopconsumerStatus){if(this.logger.log("开始取消订阅音频流"),e.pubStatus.audio.stopconsumerStatus="start",!this.adapterRef._mediasoup)throw new a.default({code:d.default.NO_MEDIASERVER,message:"media server error 7"});await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.audio.consumerId,e,"audio"),this.adapterRef.instance.removeSsrc(e.getId(),"audio"),e.pubStatus.audio.consumerId="",e.stop("audio"),e.pubStatus.audio.stopconsumerStatus="end",e.subStatus.audio=!1;const t=e.getId();if(t){delete this.adapterRef.remoteAudioStats[t];const e=this.adapterRef._statsReport&&this.adapterRef._statsReport.formativeStatsReport&&this.adapterRef._statsReport.formativeStatsReport.firstData.recvFirstData[t];e&&(e.recvFirstAudioFrame=!1,e.recvFirstAudioPackage=!1)}this.logger.log("取消订阅音频流完成")}if(e.subConf.video)if(e.pubStatus.video.video&&!e.pubStatus.video.consumerId)if(this.logger.log("应该订阅视频 stream.pubStatus.video.consumerStatus: ",e.pubStatus.video.consumerStatus),"start"!==e.pubStatus.video.consumerStatus){let i;this.logger.log(`subscribe() [开始订阅 ${e.getId()} 视频流]`),e.pubStatus.video.consumerStatus="start",i=e.subConf.highOrLow.video===l.STREAM_TYPE.LOW?0:1,await this.adapterRef._mediasoup.createConsumer(t,"video","video",e.pubStatus.video.producerId,i),e.pubStatus.video.consumerStatus="end",this.logger.log(`subscribe() [订阅 ${e.getId()} 视频流完成]`)}else this.logger.log("stream.pubStatus.video.consumerStatus: ",JSON.stringify(e.pubStatus.video.consumerStatus));else this.logger.log("stream.pubStatus.video: ",JSON.stringify(e.pubStatus.video));else if(e.pubStatus.video.consumerId&&"start"!==e.pubStatus.video.stopconsumerStatus){if(this.logger.log("开始取消订阅视频流"),e.pubStatus.video.stopconsumerStatus="start",!this.adapterRef._mediasoup)throw new a.default({code:d.default.NO_MEDIASERVER,message:"media server error 8"});await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.video.consumerId,e,"video"),this.adapterRef.instance.removeSsrc(e.getId(),"video"),e.pubStatus.video.consumerId="",e.stop("video"),e.pubStatus.video.stopconsumerStatus="end",e.subStatus.video=!1;const t=e.getId();if(t){delete this.adapterRef.remoteVideoStats[t];const e=this.adapterRef._statsReport&&this.adapterRef._statsReport.formativeStatsReport&&this.adapterRef._statsReport.formativeStatsReport.firstData.recvFirstData[t];e&&(e.recvFirstVideoFrame=!1,e.recvFirstVideoPackage=!1,e.videoTotalPlayDuration=0)}this.logger.log("取消订阅视频流完成")}if(e.subConf.screen){if(e.pubStatus.screen.screen&&!e.pubStatus.screen.consumerId&&"start"!==e.pubStatus.screen.consumerStatus){let i;this.logger.log(`subscribe() [开始订阅 ${e.getId()} 辅流]`),e.pubStatus.screen.consumerStatus="start",i=e.subConf.highOrLow.screen===l.STREAM_TYPE.LOW?0:1,await this.adapterRef._mediasoup.createConsumer(t,"video","screenShare",e.pubStatus.screen.producerId,i),e.pubStatus.screen.consumerStatus="end",this.logger.log(`subscribe() [订阅 ${e.getId()} 辅流完成]`)}}else if(e.pubStatus.screen.consumerId&&"start"!==e.pubStatus.screen.stopconsumerStatus){if(this.logger.log("开始取消订阅辅流"),e.pubStatus.screen.stopconsumerStatus="start",!this.adapterRef._mediasoup)throw new a.default({code:d.default.NO_MEDIASERVER,message:"media server error 9"});await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.screen.consumerId,e,"screen"),this.adapterRef.instance.removeSsrc(e.getId(),"screen"),e.pubStatus.screen.consumerId="",e.stop("screen"),e.pubStatus.screen.stopconsumerStatus="end",e.subStatus.screen=!1;const t=e.getId();if(t){delete this.adapterRef.remoteScreenStats[t];const e=this.adapterRef._statsReport&&this.adapterRef._statsReport.formativeStatsReport&&this.adapterRef._statsReport.formativeStatsReport.firstData.recvFirstData[t];e&&(e.recvFirstScreenFrame=!1,e.recvFirstScreenPackage=!1,e.screenTotalPlayDuration=0)}this.logger.log("取消订阅辅助流完成")}this.apiFrequencyControl({name:"subscribe",code:0,param:JSON.stringify({reason:"",audio:e.audio,subStatus:e.subStatus,subConf:e.subConf,pubStatus:e.pubStatus,renderMode:e.renderMode,screen:e.screen},null," ")})}catch(t){if("resetConsumeRequestStatus"===t)return void this.logger.warn("API调用被打断：Client:subscribe",t);this.logger.error("API调用失败：Client:subscribe",t,t.name,t.message,...arguments),this.apiFrequencyControl({name:"subscribe",code:-1,param:JSON.stringify({reason:t,audio:e.audio,subStatus:e.subStatus,subConf:e.subConf,pubStatus:e.pubStatus,renderMode:e.renderMode,screen:e.screen},null," ")})}}async unsubscribe(e){return o.checkExists({tag:"client.unsubscribe:stream",value:e}),this.doUnsubscribe(e)}async doUnsubscribe(e){this.logger.log("取消订阅远端音视频流: ",e);try{if(e.pubStatus.audio.consumerId&&"start"!==e.pubStatus.audio.stopconsumerStatus){if(this.logger.log("开始取消订阅音频流"),e.pubStatus.audio.stopconsumerStatus="start",!this.adapterRef._mediasoup)throw new a.default({code:d.default.NO_MEDIASERVER,message:"media server error 10"});await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.audio.consumerId,e,"audio"),this.adapterRef.instance.removeSsrc(e.getId(),"audio"),e.pubStatus.audio.consumerId="",e.stop("audio"),e.pubStatus.audio.stopconsumerStatus="end",e.subStatus.audio=!1;const t=e.getId();if(t){delete this.adapterRef.remoteAudioStats[t];const e=this.adapterRef._statsReport&&this.adapterRef._statsReport.formativeStatsReport&&this.adapterRef._statsReport.formativeStatsReport.firstData.recvFirstData[t];e&&(e.recvFirstAudioFrame=!1,e.recvFirstAudioPackage=!1)}this.logger.log("取消订阅音频流完成")}if(e.pubStatus.video.consumerId&&"start"!==e.pubStatus.video.stopconsumerStatus){if(this.logger.log("开始取消订阅视频流"),e.pubStatus.video.stopconsumerStatus="start",!this.adapterRef._mediasoup)throw new a.default({code:d.default.NO_MEDIASERVER,message:"media server error 11"});await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.video.consumerId,e,"video"),this.adapterRef.instance.removeSsrc(e.getId(),"video"),e.pubStatus.video.consumerId="",e.stop("video"),e.pubStatus.video.stopconsumerStatus="end",e.subStatus.video=!1;const t=e.getId();if(t){delete this.adapterRef.remoteVideoStats[t];const e=this.adapterRef._statsReport&&this.adapterRef._statsReport.formativeStatsReport&&this.adapterRef._statsReport.formativeStatsReport.firstData.recvFirstData[t];e&&(e.recvFirstVideoFrame=!1,e.recvFirstVideoPackage=!1,e.videoTotalPlayDuration=0)}this.logger.log("取消订阅视频流完成")}if(e.pubStatus.screen.consumerId&&"start"!==e.pubStatus.screen.stopconsumerStatus){if(this.logger.log("开始取消订阅辅流"),e.pubStatus.screen.stopconsumerStatus="start",!this.adapterRef._mediasoup)throw new a.default({code:d.default.NO_MEDIASERVER,message:"media server error 12"});await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.screen.consumerId,e,"screen"),this.adapterRef.instance.removeSsrc(e.getId(),"screen"),e.pubStatus.screen.consumerId="",e.stop("screen"),e.pubStatus.screen.stopconsumerStatus="end",e.subStatus.screen=!1;const t=e.getId();if(t){delete this.adapterRef.remoteScreenStats[t];const e=this.adapterRef._statsReport&&this.adapterRef._statsReport.formativeStatsReport&&this.adapterRef._statsReport.formativeStatsReport.firstData.recvFirstData[t];e&&(e.recvFirstScreenFrame=!1,e.recvFirstScreenPackage=!1,e.screenTotalPlayDuration=0)}this.logger.log("取消订阅辅助流完成")}this.apiFrequencyControl({name:"unsubscribe",code:0,param:JSON.stringify({reason:"",audio:e.audio,subStatus:e.subStatus,subConf:e.subConf,pubStatus:e.pubStatus,renderMode:e.renderMode,screen:e.screen},null," ")})}catch(t){this.logger.error("API调用失败：Client:unsubscribe",t.name,t.message,t,...arguments),this.apiFrequencyControl({name:"unsubscribe",code:-1,param:JSON.stringify({reason:t,audio:e.audio,subStatus:e.subStatus,subConf:e.subConf,pubStatus:e.pubStatus,renderMode:e.renderMode,screen:e.screen},null," ")})}}async setRemoteVideoStreamType(e,t){this.logger.log(`uid ${e.getId()} 订阅成员的${t?"小":"大"}流`,t);try{if(!this.adapterRef._mediasoup)throw new a.default({code:d.default.NO_MEDIASERVER,message:"media server error 13"});if(!e.getId())throw new a.default({code:d.default.INVALID_PARAMETER,message:"No stream Id"});await this.adapterRef._mediasoup.setConsumerPreferredLayer(e,t?0:1,"video"),e.subConf.highOrLow.video=t,this.apiFrequencyControl({name:"setRemoteVideoStreamType",param:JSON.stringify({highOrLow:t,uid:e.stringStreamID},null," ")})}catch(i){this.logger.error("API调用失败：Client:setRemoteVideoStreamType",i.name,i.message,i,...arguments),this.apiFrequencyControl({name:"setRemoteVideoStreamType",code:-1,param:JSON.stringify({reason:i,highOrLow:t,uid:e.stringStreamID},null," ")})}}async setRemoteStreamType(e,t,i){this.logger.log(`setRemoteStreamType: 订阅${e.getId()}成员的${t?"小":"大"}流`,i,t);try{if(!this.adapterRef._mediasoup)throw new a.default({code:d.default.NO_MEDIASERVER,message:"media server error 27"});if(!e.getId())throw new a.default({code:d.default.INVALID_PARAMETER,message:"No stream Id"});await this.adapterRef._mediasoup.setConsumerPreferredLayer(e,t?0:1,i),e.subConf.highOrLow[i]=t,this.apiFrequencyControl({name:"setRemoteStreamType",param:JSON.stringify({highOrLow:t,uid:e.stringStreamID},null," ")})}catch(i){this.logger.error("API调用失败：Client:setRemoteStreamType",i,...arguments),this.apiFrequencyControl({name:"setRemoteVideoStreamType",code:-1,param:JSON.stringify({reason:i,highOrLow:t,uid:e.stringStreamID},null," ")})}}enableAudioVolumeIndicator(){this.logger.log("开启双流模式")}enableDualStream(e={video:!0,screen:!1}){this.adapterRef.channelInfo.videoLow=e.video,this.adapterRef.channelInfo.screenLow=e.screen,this.logger.log("开启双流模式")}disableDualStream(){this.logger.log("关闭双流模式"),this.adapterRef.channelInfo.videoLow=!1,this.adapterRef.channelInfo.screenLow=!1}async setClientRole(e){let t,i;if("host"===e||"broadcaster"===e?t=0:"audience"===e?t=1:(this.logger.error("setClientRole: 无法识别的角色："+e),i="INVALID_OPERATION",t=-1),!i){const r=this.adapterRef.channelInfo&&this.adapterRef.channelInfo.uid||"";if(t===this._roleInfo.userRole)this.logger.warn(`setClientRole: 用户${r}的角色已经是${e}了`);else switch(this.adapterRef.connectState.curState){case"CONNECTED":if(1===t&&this.adapterRef.localStream&&this.isPublished(this.adapterRef.localStream)&&(this.logger.info(`setClientRole：主播 ${r}将设为观众，自动Unpublish中`),await this.unpublish(this.adapterRef.localStream)),!this.adapterRef._mediasoup)throw new a.default({code:d.default.NO_MEDIASERVER,message:"media server error 14"});await this.adapterRef._mediasoup.updateUserRole(t),this._roleInfo.userRole!==t&&(this._roleInfo.userRole=t,this.logger.info(`setClientRole：本地用户${r} 设置角色为 ${e}`),this.safeEmit("client-role-changed",{role:e}));break;case"DISCONNECTED":this._roleInfo.userRole!==t&&(this._roleInfo.userRole=t,this.logger.info(`setClientRole：本地用户${r}设置角色为 ${e}`),this.safeEmit("client-role-changed",{role:e}));break;default:this.logger.error(`setClientRole: 本地用户${r}当前不在频道中，可能是网络波动导致暂时断开连接`),i="USER_NOT_IN_CHANNEL"}}const r={reason:i,role:t};if(this.apiFrequencyControl({name:"setClientRole",code:i?-1:0,param:JSON.stringify(r,null," ")}),i){if("INVALID_OPERATION"===i)return Promise.reject(new a.default({code:d.default.INVALID_OPERATION,message:"invalid operation"}));if("USER_NOT_IN_CHANNEL"===i)return Promise.reject(new a.default({code:d.default.NO_LOCALSTREAM,message:"user not in channel"}))}}bindLocalStream(e){this.adapterRef.localStream=e,e.client=this;const t=this.getUid();e.streamID!==t&&(this.logger.warn("localStream更换streamID",e.streamID,"=>",t),e.streamID=t,e.stringStreamID=t.toString())}getConnectionState(){return this.apiFrequencyControl({name:"getConnectionState",code:0,param:JSON.stringify({},null," ")}),this.adapterRef.connectState.curState}getSystemStats(){return navigator.getBattery?new Promise((e,t)=>{navigator.getBattery().then((function(t){e(100*t.level)}))}):Promise.reject(new a.default({code:d.default.NOT_SUPPORTED_YET,message:"navigator.getBattery is not support in your browser",url:"https://developer.mozilla.org/en-US/docs/Web/API/Navigator/getBattery"}))}getSessionStats(){return new Promise((e,t)=>{this.adapterRef.sessionStats.Duration=(Date.now()-this.adapterRef.state.startSessionTime)/1e3,this.adapterRef.sessionStats.UserCount=Object.keys(this.adapterRef.memberMap).length+1,e(this.adapterRef.sessionStats)})}getTransportStats(){return new Promise((e,t)=>{e(this.adapterRef.transportStats)})}getLocalAudioStats(){return new Promise((e,t)=>{e(this.adapterRef.localAudioStats)})}getLocalVideoStats(e){let t=[];return e&&"video"!==e||(t=t.concat(this.adapterRef.localVideoStats)),e&&"screen"!==e||(t=t.concat(this.adapterRef.localScreenStats)),Promise.resolve(t)}getRemoteAudioStats(){return new Promise((e,t)=>{e(this.adapterRef.remoteAudioStats)})}getRemoteVideoStats(e){let t={};return e&&"screen"!==e||(t=Object.assign(t,this.adapterRef.remoteScreenStats)),e&&"video"!==e||(t=Object.assign(t,this.adapterRef.remoteVideoStats)),Promise.resolve(t)}setChannelProfile(e){let t;if(this.logger.log("设置房间模型, options: ",JSON.stringify(e,null," ")),"DISCONNECTED"!==this.adapterRef.connectState.curState)this.logger.warn("已经在频道中"),t="INVALID_OPERATION";else{const t=e.mode||"rtc";this.adapterRef.localStream&&("live"===t?this.adapterRef.localStream.audioProfile="music_standard":"rtc"===t&&(this.adapterRef.localStream.audioProfile="speech_low_quality")),this._params.mode=t}const i={reason:t,channelProfile:"live"===e.mode?1:0};if(this.apiFrequencyControl({name:"setChannelProfile",code:t?-1:0,param:JSON.stringify(i,null," ")}),t)throw new a.default({code:d.default.INVALID_OPERATION,message:"invalid operation"})}addTasks(e){if(1===this._roleInfo.userRole)return this.logger.error("addTasks: 观众不允许进行直播推流操作"),Promise.reject(new a.default({code:d.default.INVALID_OPERATION,message:"audience is not allowed to operate task"}));if(this.logger.log("增加互动直播推流任务, options: ",JSON.stringify(e)),!this.adapterRef._meetings)throw new a.default({code:d.default.NO_MEETINGS,message:"meetings error"});return this.adapterRef._meetings.addTasks(e)}deleteTasks(e){if(1===this._roleInfo.userRole)return this.logger.error("deleteTasks: 观众不允许进行直播推流操作"),Promise.reject(new a.default({code:d.default.INVALID_OPERATION,message:"audience is not allowed to operate task"}));if(this.logger.log("删除互动直播推流任务, options: ",e),!this.adapterRef._meetings)throw new a.default({code:d.default.NO_MEETINGS,message:"meetings error"});return this.adapterRef._meetings.deleteTasks(e)}updateTasks(e){if(1===this._roleInfo.userRole)return this.logger.error("updateTasks: 观众不允许进行直播推流操作"),Promise.reject(new a.default({code:d.default.INVALID_OPERATION,message:"audience is not allowed to operate task"}));if(this.logger.log("更新互动直播推流任务, options: ",e),!this.adapterRef._meetings)throw new a.default({code:d.default.NO_MEETINGS,message:"meetings error"});return this.adapterRef._meetings.updateTasks(e)}setEncryptionMode(e){o.checkValidInteger({tag:"Valid encryptionModes are: "+Object.keys(n.EncryptionModes).join(","),value:n.encryptionModeToInt(e)}),this.logger.log("设置加密模式：",e),this.adapterRef.encryption.setEncryptionMode(e);const t={enable:"none"!==e,mode:n.encryptionModeToInt(e)};this.apiFrequencyControl({name:"enableEncryption",code:0,param:JSON.stringify(t,null," ")})}setEncryptionSecret(e){switch(this.adapterRef.encryption.encryptionMode){case"none":throw new a.default({code:d.default.INVALID_OPERATION,message:"Client.setEncryptionSecret: please set encryptionMode first"});case"sm4-128-ecb":o.checkValidString({tag:"client.setEncryptionSecret:encryptionSecret",value:e,min:1,max:128})}this.logger.log("设置加密密钥"),this.adapterRef.encryption.setEncryptionSecret(e)}async pauseReconnection(){this.logger.log("pauseReconnection：下一次重连行为会被暂停，直到调用resumeReconnection()方法");const e=await new Promise(e=>{this.adapterRef._signalling&&this.adapterRef._signalling.reconnectionControl.pausers.push(e)});return this.logger.log("pauseReconnection：重连已被暂停："+JSON.stringify(e)),e}async resumeReconnection(){if(this.adapterRef._signalling){this.adapterRef._signalling.reconnectionControl.blocker?(this.logger.log("resumeReconnection：即将恢复重连过程"),this.adapterRef._signalling.reconnectionControl.blocker(),this.adapterRef._signalling.reconnectionControl.pausers.forEach(e=>e({reason:"reconnection-resume"})),this.adapterRef._signalling.reconnectionControl.pausers=[]):this.adapterRef._signalling.reconnectionControl.pausers.length?(this.logger.log("resumeReconnection：取消之前的 pauseReconnection 操作。"),this.adapterRef._signalling.reconnectionControl.pausers.forEach(e=>e({reason:"cancelled"})),this.adapterRef._signalling.reconnectionControl.pausers=[]):this.logger.warn("resumeReconnection：未发现pauseReconnection操作");const e=await new Promise(e=>{var t;null===(t=this.adapterRef._signalling)||void 0===t||t.reconnectionControl.resumers.push(e)});return this.logger.log("resumeReconnection：恢复重连成功"+JSON.stringify(e)),e}}refreshRemoteEvents(){for(let e in this.adapterRef.remoteStreamMap){const t=this.adapterRef.remoteStreamMap[e];this.logger.warn("refreshRemoteEvents peer-online",e),this.safeEmit("peer-online",{uid:e});["audio","video","screen"].forEach(i=>{t.pubStatus[i].producerId&&(this.logger.warn("refreshRemoteEvents stream-added",e,i),this.safeEmit("stream-added",{stream:t,mediaType:i}),t.muteStatus[i].send&&(this.logger.warn("refreshRemoteEvents mute-"+i,e,i),this.safeEmit("mute-"+i,{uid:t.getId()})))})}}initSpatialManager(e){if(!this.spatialManager){const t=f.getAudioContext();if(!t)return void this.logger.error("当前环境不支持WebAudio");this.spatialManager=new h.SpatialManager({client:this,options:e,context:t})}this.spatialManager.init(),this.spatialManager.play()}syncUserList(){return this.adapterRef.memberMap}enableBeautyEffect(){window.setEffect=!0,this.logger.log("开启美颜组件")}destroyBeautyEffect(){window.setEffect=!1,g.destroyBeauty(),this.logger.log("销毁美颜组件")}destroy(){this.logger&&this.logger.warn("清除 Client 实例中"),this._reset(),this.destroyed=!0,this.logger&&this.logger.warn("已清除 Client 实例")}}t.Client=v},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Base=void 0;const a=i(3),d=i(138),c=i(144),l=i(205),u=i(220),p=i(122),h=i(31),f=i(248),m=i(14),g=i(59),v=n(i(1)),y=n(i(0)),_=i(2),S=o(i(24));let b=0;class R extends a.EventEmitter{constructor(e){super(),this.transportRebuildCnt=0,this._params={appkey:"",mode:"rtc"},this.clientId=b++,this.adapterRef={channelInfo:{sessionConfig:{}},apiEvent:{},apiEvents:{},requestId:{},instance:this,report:!0},!0===e.debug?S.default.setLogLevel(S.loglevels.DEBUG):!1===e.debug&&_.getParameters().logLevel<=S.loglevels.WARNING&&S.default.setLogLevel(S.loglevels.WARNING),this.logger=new h.Logger({tagGen:()=>{let e="client"+(this.clientId||"");const t=this.getUid();return t&&(e+="#"+t),"CONNECTED"!==this.adapterRef.connectState.curState&&(e+=" "+this.adapterRef.connectState.curState),this.destroyed&&(e+=" DESTROYED"),e}}),this.adapterRef.logger=this.logger,this._reset(),this.adapterRef.encryption=new g.Encryption(this.adapterRef),window.debugG2=!!e.debug,this.adapterRef.testConf={},this.sdkRef=e.ref,void 0===e.report?this.adapterRef.report=!0:this.adapterRef.report=e.report}_reset(){this.sdkRef=null,this.adapterRef={channelInfo:{sessionConfig:{}},userPriority:{priority:100,preemtiveMode:!1},proxyServer:{enable:!1,type:3},apiEvent:{},apiEvents:{},requestId:{},instance:this,logger:this.logger,_enableRts:!1},this.adapterRef.mediaCapability=new f.MediaCapability(this.adapterRef),this.adapterRef.encryption=new g.Encryption(this.adapterRef),this._resetState(),this._destroyModule()}_getSupportedCodecs(){return m.getSupportedCodecs(...arguments)}initMode(){this.adapterRef._meetings||(this.adapterRef._meetings=new d.Meeting({sdkRef:this.sdkRef,adapterRef:this.adapterRef})),this.adapterRef._signalling||(this.adapterRef._signalling=new c.Signalling({adapterRef:this.adapterRef,logger:this.logger})),this.adapterRef._mediasoup||(this.adapterRef._mediasoup=new l.Mediasoup({adapterRef:this.adapterRef,logger:this.logger}))}initWebSocket(){this.adapterRef._statsReport||(this.adapterRef._statsReport=new u.StatsReport({sdkRef:this.sdkRef,adapterRef:this.adapterRef}),this.adapterRef._statsReport.start(),this.adapterRef._statsReport.startHeartbeat())}_destroyModule(){this.adapterRef._meetings&&(this.adapterRef._meetings.destroy(),this.adapterRef._meetings=null),this.adapterRef._signalling&&(this.adapterRef._signalling.destroy(),this.adapterRef._signalling=null),this.adapterRef._rtsTransport&&(this.adapterRef._rtsTransport.destroy(),this.adapterRef._rtsTransport=null),this.adapterRef._mediasoup&&(this.adapterRef._mediasoup.destroy(),this.adapterRef._mediasoup=null),this.adapterRef._statsReport&&(this.adapterRef._statsReport.destroy(),this.adapterRef._statsReport=null)}_resetState(){this._params.neRtcServerAddresses={},this.adapterRef.channelStatus="init",this.adapterRef.connectState={prevState:"DISCONNECTED",curState:"DISCONNECTED",reconnecting:!1},this.adapterRef.networkQuality={},this.adapterRef.localStream=null,this.adapterRef.memberMap={},this.adapterRef.remoteStreamMap={},this.adapterRef.netStatusList=[],this.adapterRef.netStatusTimer&&(clearInterval(this.adapterRef.netStatusTimer),this.adapterRef.netStatusTimer=null),this.adapterRef.uid2SscrList={},this.adapterRef.state={lastDeviceStatus:{audio:{type:null,device:null},video:{type:null,device:null}},audioDeviceHasOpened:!1,videoDeviceHasOpened:!1,chromeScreenShareOpened:!1,startSessionTime:0,endSessionTime:0,startPubVideoTime:0,startPubScreenTime:0},Object.assign(this.adapterRef,{transportStats:{NetworkType:"unknown",OutgoingAvailableBandwidth:0,txRtt:0,rxRtt:0},sessionStats:{Duration:0,RecvBitrate:0,RecvBytes:0,SendBitrate:0,SendBytes:0,UserCount:0},localAudioStats:[],localVideoStats:[],localScreenStats:[],remoteAudioStats:{},remoteVideoStats:{},remoteScreenStats:{}})}setSessionConfig(e={}){this.adapterRef.channelInfo||(this.adapterRef.channelInfo={}),this.adapterRef.channelInfo.sessionConfig||(this.adapterRef.channelInfo.sessionConfig={}),this.adapterRef.channelInfo.sessionConfig=Object.assign(this.adapterRef.channelInfo.sessionConfig,e)}resetChannel(){this.adapterRef.networkQuality={},this.adapterRef.netStatusList=[];for(let e in this.adapterRef.remoteStreamMap){const t=this.adapterRef.remoteStreamMap[e];t.active=!1,t.stop(),t.clearRemotePubStatus()}this.adapterRef.memberMap={},this.adapterRef.uid2SscrList={},this.adapterRef._mediasoup&&this.adapterRef._mediasoup.destroy()}async startSession(e=0){0===e?this.logger.log("开始音视频会话"):this.logger.log(`开始音视频会话：第${e}次`);let{wssArr:t,cid:i}=this.adapterRef.channelInfo;if(!t||0===t.length)throw this.logger.error("没有找到服务器地址: "+JSON.stringify(this.adapterRef.channelInfo)),this.adapterRef.channelStatus="leave",new v.default({code:y.default.NO_SERVER_ADDRESS,message:"no server address"});if(!i)throw this.logger.error("服务器没有分配cid"),this.adapterRef.channelStatus="leave",new v.default({code:y.default.INVALID_PARAMETER,message:"no cid"});if(this.logger.log(`开始连接服务器: ${this.adapterRef.channelInfo.wssArrIndex}, url:`,t),this.adapterRef.channelInfo.wssArrIndex>=t.length)throw this.logger.error("所有的服务器地址都连接失败"),this.adapterRef.channelInfo.wssArrIndex=0,this.adapterRef.channelStatus="leave",new v.default({code:y.default.SOCKET_ERROR,message:"socket error"});let r=t[this.adapterRef.channelInfo.wssArrIndex];if(!this.adapterRef._signalling)throw new v.default({code:y.default.NO_SIGNALLING,message:"signalling error"});try{await this.adapterRef._signalling.init(r)}catch(t){if(this.logger.warn("startSession error: ",t),"timeout"===t)return this.adapterRef.channelInfo.wssArrIndex++,void await this.startSession(e+1);throw this.adapterRef.channelStatus="leave",t}const s=t[this.adapterRef.channelInfo.wssArrIndex];if(t.splice(this.adapterRef.channelInfo.wssArrIndex,1),t.unshift(s),this.adapterRef.channelInfo.wssArrIndex=0,!this.adapterRef._statsReport)throw new v.default({code:y.default.NO_STATS,message:"no stats"});this.adapterRef._statsReport.statsStart()}stopSession(){this.logger.log("开始清除音视频会话"),this._destroyModule();const e=_.getParameters().localStreams.filter(e=>e.client===this&&!e.destroyed);e.length&&(_.getParameters().keepLocalstreamOnLeave?this.logger.log("当前模式下离开频道不会销毁localStream"):(this.logger.log(`即将销毁${e.length}个localStream`),e.forEach(e=>{e.destroy()}))),Object.values(this.adapterRef.remoteStreamMap).forEach(e=>{e.destroy()}),this.adapterRef.remoteStreamMap={},this.adapterRef.memberMap={},this.adapterRef.uid2SscrList={},this._resetState()}async clearMember(e){var t;this.logger.log(e+"离开房间");const i=this.adapterRef.remoteStreamMap[e];if(i){const r=["audio","video","screen"];for(let e of r)i.pubStatus[e].producerId&&this.adapterRef.instance.safeEmit("stream-removed",{stream:i,mediaType:e,reason:"onPeerLeave"});delete this.adapterRef.remoteStreamMap[e],delete this.adapterRef.memberMap[e],delete this.adapterRef.remoteAudioStats[e],delete this.adapterRef.remoteVideoStats[e],delete this.adapterRef.remoteScreenStats[e];for(let e of r)i.pubStatus[e].consumerId&&await(null===(t=this.adapterRef._mediasoup)||void 0===t?void 0:t.destroyConsumer(i.pubStatus[e].consumerId,i,e));i.active=!1,i.destroy();const s=this.adapterRef._statsReport&&this.adapterRef._statsReport.formativeStatsReport&&this.adapterRef._statsReport.formativeStatsReport.firstData.recvFirstData;s&&s[e]&&delete s[e]}this.adapterRef.netStatusList=this.adapterRef.netStatusList.filter((t,i,r)=>t.uid!==e),this.logger.log(e+" 离开房间 通知用户"),this.adapterRef._enableRts?this.adapterRef.instance.emit("rts-peer-leave",{uid:e}):this.adapterRef.instance.safeEmit("peer-leave",{uid:e})}setStartSessionTime(){this.adapterRef.state.startSessionTime=Date.now()}setEndSessionTime(){if(!this.adapterRef.state.startSessionTime)return void this.logger.log("AbstractAdapter: setEndSessionTime: startSessionTime为空");this.adapterRef.state.endSessionTime=Date.now();const e=this.adapterRef.state.endSessionTime-this.adapterRef.state.startSessionTime;this.emit("sessionDuration",e),this.adapterRef.state.startSessionTime=0,this.adapterRef.state.endSessionTime=0}async reBuildRecvTransport(){if(this.transportRebuildCnt++,this.transportRebuildCnt>=_.getParameters().maxTransportRebuildCnt)return void this.logger.error("reBuildRecvTransport 达到最大重连次数："+this.transportRebuildCnt);if(this.logger.warn("下行通道异常，重新建立 #"+this.transportRebuildCnt),!this.adapterRef._mediasoup)throw new v.default({code:y.default.NO_MEDIASERVER,message:"media server error 3"});this.emit("pairing-reBuildRecvTransport-start"),this.adapterRef._mediasoup.init(),this.logger.log("下行通道异常, remoteStreamMap",this.adapterRef.remoteStreamMap),this.logger.log("this._eventQueue: ",this.adapterRef._mediasoup._eventQueue);let e=!1;for(const t in this.adapterRef.remoteStreamMap){const i=this.adapterRef.remoteStreamMap[t];if(i){i.pubStatus.audio.consumerStatus="init",i.pubStatus.video.consumerStatus="init",i.pubStatus.screen.consumerStatus="init",i.pubStatus.audio.consumerId="",i.pubStatus.video.consumerId="",i.pubStatus.screen.consumerId="",this.logger.log("重连逻辑订阅 start：",i.stringStreamID);try{await this.doSubscribe(i)}catch(t){this.logger.error("重连逻辑订阅 error: ",t,t.name,t.message),e=!0,this.emit("pairing-reBuildRecvTransport-error");break}this.logger.log("重连逻辑订阅 over: ",i.stringStreamID)}}e||this.emit("pairing-reBuildRecvTransport-success")}async rtsRequestKeyFrame(e){this.logger.log("请求关键帧: ",e.pubStatus.video.consumerId),this.adapterRef._signalling&&await this.adapterRef._signalling.rtsRequestKeyFrame(e.pubStatus.video.consumerId)}apiFrequencyControl(e){const{name:t,code:i,param:r}=e;if(!t)return;this.adapterRef.apiEvent[t]||(this.adapterRef.apiEvent[t]=[],this.adapterRef.apiEvents[t]=[],this.adapterRef.requestId[t]=0);let s=this.adapterRef.channelInfo.clientNtpTime-this.adapterRef.channelInfo.T4;if(s>0||(s=0),this.adapterRef.apiEvent[t].length<10)this.adapterRef.apiEvent[t].push({cid:this.adapterRef.channelInfo&&this.adapterRef.channelInfo.cid,uid:this.adapterRef.channelInfo&&this.adapterRef.channelInfo.uid,code:i,name:t,time:Date.now()+s,param:r,request_id:this.adapterRef.requestId[t]++});else{if(!this.adapterRef.apiEvent||!this.adapterRef.apiEvent[t]||!this.adapterRef.apiEvent[t].length)throw new v.default({code:y.default.NOT_FOUND,message:"No apiEvent Named "+t});if(!this.adapterRef.apiEvent[t][0].time)throw new v.default({code:y.default.NOT_FOUND,message:"Invalid time for "});Date.now()-this.adapterRef.apiEvent[t][0].time<1e4?this.adapterRef.requestId[t]++:(this.adapterRef.apiEvents[t]=this.adapterRef.apiEvents[t].concat(this.adapterRef.apiEvent[t]),this.adapterRef.apiEvent[t]=[])}}apiEventReport(e,t){if(!this.adapterRef.report)return;if(!e)return;let i=new p.DataReport({adapterRef:this.adapterRef,sdkRef:this.sdkRef});i[e](Object.assign({uid:""+this.adapterRef.channelInfo.uid,cid:""+this.adapterRef.channelInfo.cid,time:Date.now()},t)),i.send()}getUidAndKindBySsrc(e){var t,i;const r=["audio","video","screen"],s=["high","low"];for(let o of r)for(let r of s)if((null===(i=null===(t=this.adapterRef._mediasoup)||void 0===t?void 0:t.senderEncodingParameter[o][r])||void 0===i?void 0:i.ssrc)===e)return{uid:0,kind:o,streamType:r};for(let t in this.adapterRef.uid2SscrList){if(this.adapterRef.uid2SscrList[t].audio.ssrc==e)return{uid:t,kind:"audio",streamType:"high"};if(this.adapterRef.uid2SscrList[t].video&&this.adapterRef.uid2SscrList[t].video.ssrc==e)return{uid:t,kind:"video",streamType:"high"};if(this.adapterRef.uid2SscrList[t].screen&&this.adapterRef.uid2SscrList[t].screen.ssrc==e)return{uid:t,kind:"screen",streamType:"high"}}return{uid:0,kind:"",streamType:"high"}}getSsrcByUidAndKind(e,t){return this.adapterRef.uid2SscrList[e]&&this.adapterRef.uid2SscrList[e][t]}addSsrc(e,t,i){this.adapterRef.uid2SscrList[e]||(this.adapterRef.uid2SscrList[e]={audio:{ssrc:0},video:{ssrc:0},screen:{ssrc:0}}),this.adapterRef.uid2SscrList[e][t]?this.adapterRef.uid2SscrList[e][t].ssrc=i:this.adapterRef.uid2SscrList[e][t]={ssrc:i}}removeSsrc(e,t){this.adapterRef.uid2SscrList[e]&&(t?this.adapterRef.uid2SscrList[e][t]&&(this.adapterRef.uid2SscrList[e][t].ssrc=0):delete this.adapterRef.uid2SscrList[e])}isPublished(e){return e&&this.adapterRef.localStream===e&&(e.audio&&e.pubStatus.audio.audio||e.video&&e.pubStatus.video.video||e.screen&&e.pubStatus.screen.screen)}getPeer(e){return this.adapterRef._mediasoup?"send"==e?this.adapterRef._mediasoup._sendTransport&&this.adapterRef._mediasoup._sendTransport.handler._pc:"recv"==e?this.adapterRef._mediasoup._recvTransport&&this.adapterRef._mediasoup._recvTransport.handler._pc:null:null}destroy(){this.logger.log("base: destroy!"),this._reset()}}t.Base=R},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Meeting=void 0;const s=i(3),o=i(53),n=i(22),a=i(55),d=r(i(11)),c=r(i(1)),l=r(i(0));class u extends s.EventEmitter{constructor(e){super(),this.info={turn:!0,relay:!1,forward:!1,secure:!0},this._reset(),this.adapterRef=e.adapterRef,this.sdkRef=e.sdkRef,this.logger=e.adapterRef.logger.getChild(()=>{var t,i,r;let s="meeting";return this.info.secure||(s+=" INSECURE"),this.info.forward&&(s+=" FORWARD"),this.info.turn||(s+=" NOTURN"),(null===(r=null===(i=null===(t=e.adapterRef.instance)||void 0===t?void 0:t._params)||void 0===i?void 0:i.neRtcServerAddresses)||void 0===r?void 0:r.channelServer)&&(s+=" PRIVATE"),e.adapterRef._meetings!==this&&(s+=" DETACHED"),s})}_reset(){}async getCloudProxyInfo(e){const{appkey:t,channelName:i,uid:r,token:s=""}=e;this.adapterRef.logger.log("getCloudProxyInfoUrl: ",n.getCloudProxyInfoUrl);let c=n.getCloudProxyInfoUrl;this.adapterRef.instance._params.neRtcServerAddresses.cloudProxyServer&&(c=this.adapterRef.instance._params.neRtcServerAddresses.cloudProxyServer,this.adapterRef.logger.log("私有化配置的 cloudProxyServer: ",c));let l=r;"string"===this.adapterRef.channelInfo.uidType&&(l=new d.default(l));let u=Date.parse(new Date)/1e3;try{const e=await o.ajax({url:c,type:"POST",data:{uid:l,appkey:t,channelName:i,secureType:s?"1":"2",osType:"4",version:n.SDK_VERSION+".0"||!1,curtime:""+u,checksum:a(t+"."+r+"."+u),proxy:"1",needIPV6:"0"}});if(this.adapterRef.logger.log("获取到云代理服务相关信息:",JSON.stringify(e)),this.adapterRef.instance.apiFrequencyControl({name:"setCloudProxyInfo",code:200===e.code?0:-1,param:JSON.stringify({channelName:i,uid:r,appkey:t,token:s,result:e.code},null,2)}),200!==e.code)return this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnecting=!1,this.adapterRef.instance.emit("connection-state-change",this.adapterRef.connectState),Promise.reject(`code: ${e.code}, reason: ${e.desc}`);{this.adapterRef.channelStatus="join";const{wsProxyArray:t,mediaProxyArray:i,mediaProxyToken:r,cname:s,curTime:o,uid:n}=e;this.adapterRef.instance._params.neRtcServerAddresses.webSocketProxyServer?(this.adapterRef.logger.warn("获取到云代理私有化 webSocketProxyServer:",this.adapterRef.instance._params.neRtcServerAddresses.webSocketProxyServer),this.adapterRef.proxyServer.wsProxyArray=[this.adapterRef.instance._params.neRtcServerAddresses.webSocketProxyServer]):this.adapterRef.proxyServer.wsProxyArray=t,this.adapterRef.instance._params.neRtcServerAddresses.mediaProxyServer?(this.adapterRef.logger.warn("获取到云代理私有化 mediaProxyServer:",this.adapterRef.instance._params.neRtcServerAddresses.mediaProxyServer),this.adapterRef.proxyServer.mediaProxyArray=[this.adapterRef.instance._params.neRtcServerAddresses.mediaProxyServer],this.adapterRef.proxyServer.mediaProxyToken="netease",this.adapterRef.proxyServer.credential="netease"):(this.adapterRef.proxyServer.mediaProxyArray=i,this.adapterRef.proxyServer.mediaProxyToken=r,this.adapterRef.proxyServer.credential=n+"/"+o)}}catch(e){return this.adapterRef.logger.log("获取到云代理服务相关信息失败:",e.name,e.message,e),this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnecting=!1,this.adapterRef.instance.emit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.apiFrequencyControl({name:"setCloudProxyInfo",code:-1,param:JSON.stringify({channelName:i,uid:r,appkey:t,token:s,result:-1,msg:e.message},null,2)}),Promise.reject("code: -1, reason: "+e.message)}}async joinChannel(e){try{this.adapterRef.proxyServer.enable&&await this.getCloudProxyInfo(e)}catch(e){return Promise.reject(e)}const{appkey:t,channelName:i,uid:r,wssArr:s=null,sessionMode:c="meeting",joinChannelRecordConfig:l,joinChannelLiveConfig:u,token:p=""}=e;let h=Date.now(),f=+new Date;this.logger.log("getChannelInfoUrl: ",n.getChannelInfoUrl);let m=n.getChannelInfoUrl;this.adapterRef.instance._params.neRtcServerAddresses.channelServer&&(m=this.adapterRef.instance._params.neRtcServerAddresses.channelServer,this.logger.log("私有化配置的 getChannelInfoUrl: ",m));let g=r;"string"===this.adapterRef.channelInfo.uidType&&(g=new d.default(g)),Object.assign(this.adapterRef.channelInfo,{uid:r,sessionMode:c,appkey:t});try{const d=await o.ajax({url:m,type:"POST",contentType:"application/x-www-form-urlencoded",header:{"X-Forwarded-For":this.adapterRef.testConf.ForwardedAddr||""},data:{uid:g,appkey:t,channelName:i,secureType:p?"1":"2",osType:"4",mode:2,netType:"0",version:n.SDK_VERSION+".0"||!1,curtime:f,checksum:p||a(t+"."+r+"."+f),webrtc:1,nrtcg2:1,t1:h}});let v=!("0"==r||"0"!=r&&!Boolean(r));if(this.info.secure=!!p,this.info.forward=!!this.adapterRef.testConf.ForwardedAddr,this.logger.log("获取到房间信息:",JSON.stringify(d)),200===d.code){this.adapterRef.channelStatus="join";const{ips:o,time:n}=d;o&&o.uid||this.logger.error("加入频道时服务端未返回uid");const a=d.config&&d.config.quality_level_limit||16;this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.startWssTime=Date.now();let p=o.webrtcarray&&o.webrtcarray.length&&o.webrtcarray[0];if(p&&this.adapterRef.proxyServer.wsProxyArray){const e=o.turnaddrs&&o.turnaddrs.length&&o.turnaddrs[0][0];let t=e.split(":").length>1?e.split(":")[1]:"",i=p.split("/").length>1?p.split("/")[1]:"";this.adapterRef.instance._params.neRtcServerAddresses.webSocketProxyServer&&(t=i.split(":")[1]),i&&t?this.adapterRef.proxyServer.wsProxyArray=this.adapterRef.proxyServer.wsProxyArray.map(e=>e+"/"+i.split(":")[0]+":"+t):this.adapterRef.logger.error(`云代理无法获取到server地址, serverurl: ${i}, port: ${t}`)}Object.assign(this.adapterRef.channelInfo,{cid:+d.cid,token:d.token,turnToken:o.token,channelName:i,wssArr:s||this.adapterRef.proxyServer.wsProxyArray||o.webrtcarray||[],relayaddrs:this.adapterRef.proxyServer.mediaProxyArray||o.relayaddrs||null,relaytoken:this.adapterRef.proxyServer.mediaProxyToken||o.relaytoken||null,wssArrIndex:0,maxVideoQuality:a,netDetect:!1},{uid:v?r:o.uid,sessionMode:c,appkey:t}),e.uid=e.uid?e.uid:this.adapterRef.channelInfo.uid,this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.token=d.token,this.adapterRef.channelInfo.T4=Date.now();let h=this.adapterRef.channelInfo.T4-n.t1-(n.t3-n.t2);return this.adapterRef.channelInfo.clientNtpTime=n.t3+Math.round(h/2),this.adapterRef.instance.setSessionConfig(Object.assign({maxVideoQuality:a},u,l)),this.info.relay=o.relayaddrs&&o.relayaddrs.length>0,this.info.turn=o.turnaddrs&&o.turnaddrs.length>0,this.logger.log("开始建立会话"),this.adapterRef.instance.startSession()}return this.logger.error("无法加入房间"),this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnecting=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.apiEventReport("setLogin",{a_record:l.recordAudio,v_record:l.recordVideo,record_type:l.recordType,host_speaker:l.isHostSpeaker,result:d.code,serverIp:d.ips&&d.ips.turnaddrs&&d.ips.turnaddrs.length&&d.ips.turnaddrs[0]}),Promise.reject(`code: ${d.code}, reason: ${d.desc}`)}catch(e){throw this.logger.log("获取到房间失败:",e.name,e.message,e),this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnecting=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.apiEventReport("setLogin",{a_record:l.recordAudio,v_record:l.recordVideo,record_type:l.recordType,host_speaker:l.isHostSpeaker,result:-2,serverIp:""}),e}}leaveChannel(){if(this.adapterRef.instance.apiEventReport("setLogout",{reason:this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason||0}),!this.adapterRef._signalling)throw new c.default({code:l.default.NO_SIGNALLING,message:"No _signalling"});return this.adapterRef._signalling.doSendLogout().then(()=>(this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnecting=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.stopSession()))}async addTasks(e){const{rtmpTasks:t=[]}=e;if(!this.adapterRef.channelInfo.cid)return this.adapterRef.instance.apiFrequencyControl({name:"addTasks",code:-1,param:JSON.stringify({error:"请先加入房间",version:1,taskId:t.length?t[0].taskId:""},null,"")}),this.logger.error("请先加入房间"),Promise.reject(new c.default({code:l.default.INVALID_OPERATION,message:"invalid operation"}));if(!t||!Array.isArray(t)||!t.length)return this.logger.error("添加推流任务失败: 参数格式错误，rtmpTasks为空，或者该数组长度为空"),Promise.reject(new c.default({code:l.default.INVALID_PARAMETER,message:"invalid parameter"}));let i=n.roomsTaskUrl;this.logger.log("roomsTaskUrl: ",n.roomsTaskUrl),this.adapterRef.instance._params.neRtcServerAddresses.roomServer&&(i=this.adapterRef.instance._params.neRtcServerAddresses.roomServer,this.logger.log("私有化配置的 roomsTaskUrl: ",i)),i=`${i}${this.adapterRef.channelInfo.cid}/tasks`;let r=this.adapterRef.channelInfo.uid;"string"===this.adapterRef.channelInfo.uidType&&(r=new d.default(r));for(let e=0;e<t.length;e++){t[e].hostUid=r,t[e].version=1,this.logger.log("rtmpTask: ",JSON.stringify(t[e]));const s=t[e].layout;s.users.forEach(e=>{"string"==typeof e.uid&&(e.uid=new d.default(e.uid))});try{const r=await o.ajax({url:i,type:"POST",contentType:"application/json;charset=utf-8",header:{Token:this.adapterRef.channelInfo.turnToken},data:{version:1,taskId:t[e].taskId,streamUrl:t[e].streamUrl,record:t[e].record,hostUid:t[e].hostUid,layout:s,config:t[e].config,extraInfo:t[e].extraInfo}});if(200!==r.code)return this.logger.error("添加推流任务失败: ",r),this.adapterRef.instance.apiFrequencyControl({name:"addTasks",code:r.code,param:JSON.stringify({version:1,taskId:t[e].taskId,streamUrl:t[e].streamUrl,record:t[e].record,hostUid:parseInt(t[e].hostUid),layout:t[e].layout,config:t[e].config},null," ")}),Promise.reject(new c.default({code:l.default.ADD_TASK_FAILED,message:"add task failed"}));this.logger.log("添加推流任务完成"),this.adapterRef.instance.apiFrequencyControl({name:"addTasks",code:0,param:JSON.stringify({version:1,taskId:t[e].taskId,streamUrl:t[e].streamUrl,record:t[e].record,hostUid:t[e].hostUid,layout:t[e].layout,config:t[e].config},null," ")})}catch(i){return this.logger.error("addTasks: ",i.name,i.message,i),this.adapterRef.instance.apiFrequencyControl({name:"addTasks",code:-1,param:JSON.stringify({error:"code error",version:1,taskId:t[e].taskId,streamUrl:t[e].streamUrl,record:t[e].record,hostUid:parseInt(t[e].hostUid),layout:t[e].layout,config:t[e].config},null," ")}),Promise.reject(new c.default({code:l.default.ADD_TASK_FAILED,message:"add task failed"}))}}}async deleteTasks(e){const{taskIds:t=[]}=e;if(!this.adapterRef.channelInfo.cid)return this.adapterRef.instance.apiFrequencyControl({name:"deleteTasks",code:-1,param:JSON.stringify({error:"请先加入房间",version:1,taskId:t.length?t[0]:""},null," ")}),this.logger.error("请先加入房间"),Promise.reject(new c.default({code:l.default.INVALID_OPERATION,message:"please join room first"}));if(!t||!Array.isArray(t)||!t.length)return this.logger.error("删除推流任务失败: 参数格式错误，taskIds为空，或者该数组长度为空"),Promise.reject(new c.default({code:l.default.INVALID_PARAMETER,message:"invalid parameter"}));let i=n.roomsTaskUrl;this.logger.log("roomsTaskUrl: ",n.roomsTaskUrl),this.adapterRef.instance._params.neRtcServerAddresses.roomServer&&(i=this.adapterRef.instance._params.neRtcServerAddresses.roomServer,this.logger.log("私有化配置的 roomsTaskUrl: ",i)),i=`${i}${this.adapterRef.channelInfo.cid}/tasks/delete`;for(let e=0;e<t.length;e++){this.logger.log("deleteTasks: ",t[e]);try{const r=await o.ajax({url:i,type:"POST",contentType:"application/json;charset=utf-8",header:{Token:this.adapterRef.channelInfo.turnToken},data:{taskId:t[e]}});return 200===r.code?(this.logger.log("删除推流任务完成"),this.adapterRef.instance.apiFrequencyControl({name:"deleteTasks",code:0,param:JSON.stringify({taskId:t[e]},null," ")}),Promise.resolve()):(this.logger.log("删除推流任务请求失败:",JSON.stringify(r)),this.adapterRef.instance.apiFrequencyControl({name:"deleteTasks",code:r.code,param:JSON.stringify({taskId:t[e]},null," ")}),Promise.reject(new c.default({code:l.default.DELETE_TASK_FAILED,message:"delete task failed"})))}catch(i){return this.logger.error("deleteTasks发生错误: ",i.name,i.message,i),this.adapterRef.instance.apiFrequencyControl({name:"deleteTasks",code:-1,param:JSON.stringify({error:"code error",taskId:t[e]},null," ")}),Promise.reject(new c.default({code:l.default.DELETE_TASK_FAILED,message:"delete task failed"}))}}}async updateTasks(e){const{rtmpTasks:t=[]}=e;if(!this.adapterRef.channelInfo.cid)return this.adapterRef.instance.apiFrequencyControl({name:"updateTasks",code:-1,param:JSON.stringify({error:"请先加入房间",version:1,taskId:t.length?t[0].taskId:""},null," ")}),this.logger.error("请先加入房间"),Promise.reject(new c.default({code:l.default.INVALID_OPERATION,message:"please join room first"}));if(!t||!Array.isArray(t)||!t.length)return this.logger.error("更新推流任务失败: 参数格式错误，rtmpTasks为空，或者该数组长度为空"),Promise.reject(new c.default({code:l.default.INVALID_PARAMETER,message:"invalid parameter"}));let i=n.roomsTaskUrl;this.logger.log("roomsTaskUrl: ",n.roomsTaskUrl),this.adapterRef.instance._params.neRtcServerAddresses.roomServer&&(i=this.adapterRef.instance._params.neRtcServerAddresses.roomServer,this.logger.log("私有化配置的 roomsTaskUrl: ",i)),i=`${i}${this.adapterRef.channelInfo.cid}/task/update`;let r=this.adapterRef.channelInfo.uid;"string"===this.adapterRef.channelInfo.uidType&&(r=new d.default(r));for(let e=0;e<t.length;e++){const s=t[e].layout;s.users.forEach(e=>{"string"==typeof e.uid&&(e.uid=new d.default(e.uid))});try{const n=await o.ajax({url:i,type:"POST",contentType:"application/json;charset=utf-8",header:{Token:this.adapterRef.channelInfo.turnToken},data:{version:1,taskId:t[e].taskId,streamUrl:t[e].streamUrl,record:t[e].record,hostUid:r,layout:s,config:t[e].config}});return 200===n.code?(this.logger.log("更新推流任务完成"),this.adapterRef.instance.apiFrequencyControl({name:"updateTasks",code:0,param:JSON.stringify({version:1,taskId:t[e].taskId,streamUrl:t[e].streamUrl,record:t[e].record,hostUid:parseInt(t[e].hostUid),layout:t[e].layout,config:t[e].config},null," ")}),Promise.resolve()):(this.logger.log("更新推流任务失败：",JSON.stringify(n)),this.adapterRef.instance.apiFrequencyControl({name:"updateTasks",code:n.code,param:JSON.stringify({version:1,taskId:t[e].taskId,streamUrl:t[e].streamUrl,record:t[e].record,hostUid:parseInt(t[e].hostUid),layout:t[e].layout,config:t[e].config},null," ")}),Promise.reject(new c.default({code:l.default.UPDATE_TASKS_FAILED,message:"update task failed"})))}catch(i){return this.logger.error("updateTasks 发生错误: ",i.name,i.message,i),this.adapterRef.instance.apiFrequencyControl({name:"updateTasks",code:-1,param:JSON.stringify({error:"code error",version:1,taskId:t[e].taskId,streamUrl:t[e].streamUrl,record:t[e].record,hostUid:parseInt(t[e].hostUid),layout:t[e].layout,config:t[e].config},null," ")}),Promise.reject(new c.default({code:l.default.UPDATE_TASKS_FAILED,message:"update task failed"}))}}}destroy(){this.logger.log("清除 meeting"),this._reset()}}t.Meeting=u},function(e,t,i){var r=i(11),s=e.exports;!function(){"use strict";var e,t,i,o=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,n={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};function a(e){return o.lastIndex=0,o.test(e)?'"'+e.replace(o,(function(e){var t=n[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)}))+'"':'"'+e+'"'}"function"!=typeof s.stringify&&(s.stringify=function(s,o,n){var d;if(e="",t="","number"==typeof n)for(d=0;d<n;d+=1)t+=" ";else"string"==typeof n&&(t=n);if(i=o,o&&"function"!=typeof o&&("object"!=typeof o||"number"!=typeof o.length))throw new Error("JSON.stringify");return function s(o,n){var d,c,l,u,p,h=e,f=n[o],m=null!=f&&(f instanceof r||r.isBigNumber(f));switch(f&&"object"==typeof f&&"function"==typeof f.toJSON&&(f=f.toJSON(o)),"function"==typeof i&&(f=i.call(n,o,f)),typeof f){case"string":return m?f:a(f);case"number":return isFinite(f)?String(f):"null";case"boolean":case"null":case"bigint":return String(f);case"object":if(!f)return"null";if(e+=t,p=[],"[object Array]"===Object.prototype.toString.apply(f)){for(u=f.length,d=0;d<u;d+=1)p[d]=s(d,f)||"null";return l=0===p.length?"[]":e?"[\n"+e+p.join(",\n"+e)+"\n"+h+"]":"["+p.join(",")+"]",e=h,l}if(i&&"object"==typeof i)for(u=i.length,d=0;d<u;d+=1)"string"==typeof i[d]&&(l=s(c=i[d],f))&&p.push(a(c)+(e?": ":":")+l);else Object.keys(f).forEach((function(t){var i=s(t,f);i&&p.push(a(t)+(e?": ":":")+i)}));return l=0===p.length?"{}":e?"{\n"+e+p.join(",\n"+e)+"\n"+h+"}":"{"+p.join(",")+"}",e=h,l}}("",{"":s})})}()},function(e,t,i){var r=null;const s=/(?:_|\\u005[Ff])(?:_|\\u005[Ff])(?:p|\\u0070)(?:r|\\u0072)(?:o|\\u006[Ff])(?:t|\\u0074)(?:o|\\u006[Ff])(?:_|\\u005[Ff])(?:_|\\u005[Ff])/,o=/(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)/;e.exports=function(e){"use strict";var t={strict:!1,storeAsString:!1,alwaysParseAsBig:!1,useNativeBigInt:!1,protoAction:"error",constructorAction:"error"};if(null!=e){if(!0===e.strict&&(t.strict=!0),!0===e.storeAsString&&(t.storeAsString=!0),t.alwaysParseAsBig=!0===e.alwaysParseAsBig&&e.alwaysParseAsBig,t.useNativeBigInt=!0===e.useNativeBigInt&&e.useNativeBigInt,void 0!==e.constructorAction){if("error"!==e.constructorAction&&"ignore"!==e.constructorAction&&"preserve"!==e.constructorAction)throw new Error('Incorrect value for constructorAction option, must be "error", "ignore" or undefined but passed '+e.constructorAction);t.constructorAction=e.constructorAction}if(void 0!==e.protoAction){if("error"!==e.protoAction&&"ignore"!==e.protoAction&&"preserve"!==e.protoAction)throw new Error('Incorrect value for protoAction option, must be "error", "ignore" or undefined but passed '+e.protoAction);t.protoAction=e.protoAction}}var n,a,d,c,l={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"},u=function(e){throw{name:"SyntaxError",message:e,at:n,text:d}},p=function(e){return e&&e!==a&&u("Expected '"+e+"' instead of '"+a+"'"),a=d.charAt(n),n+=1,a},h=function(){var e,s="";for("-"===a&&(s="-",p("-"));a>="0"&&a<="9";)s+=a,p();if("."===a)for(s+=".";p()&&a>="0"&&a<="9";)s+=a;if("e"===a||"E"===a)for(s+=a,p(),"-"!==a&&"+"!==a||(s+=a,p());a>="0"&&a<="9";)s+=a,p();if(e=+s,isFinite(e))return null==r&&(r=i(11)),s.length>15?t.storeAsString?s:t.useNativeBigInt?BigInt(s):new r(s):t.alwaysParseAsBig?t.useNativeBigInt?BigInt(e):new r(e):e;u("Bad number")},f=function(){var e,t,i,r="";if('"'===a)for(var s=n;p();){if('"'===a)return n-1>s&&(r+=d.substring(s,n-1)),p(),r;if("\\"===a){if(n-1>s&&(r+=d.substring(s,n-1)),p(),"u"===a){for(i=0,t=0;t<4&&(e=parseInt(p(),16),isFinite(e));t+=1)i=16*i+e;r+=String.fromCharCode(i)}else{if("string"!=typeof l[a])break;r+=l[a]}s=n}}u("Bad string")},m=function(){for(;a&&a<=" ";)p()};return c=function(){switch(m(),a){case"{":return function(){var e,i=Object.create(null);if("{"===a){if(p("{"),m(),"}"===a)return p("}"),i;for(;a;){if(e=f(),m(),p(":"),!0===t.strict&&Object.hasOwnProperty.call(i,e)&&u('Duplicate key "'+e+'"'),!0===s.test(e)?"error"===t.protoAction?u("Object contains forbidden prototype property"):"ignore"===t.protoAction?c():i[e]=c():!0===o.test(e)?"error"===t.constructorAction?u("Object contains forbidden constructor property"):"ignore"===t.constructorAction?c():i[e]=c():i[e]=c(),m(),"}"===a)return p("}"),i;p(","),m()}}u("Bad object")}();case"[":return function(){var e=[];if("["===a){if(p("["),m(),"]"===a)return p("]"),e;for(;a;){if(e.push(c()),m(),"]"===a)return p("]"),e;p(","),m()}}u("Bad array")}();case'"':return f();case"-":return h();default:return a>="0"&&a<="9"?h():function(){switch(a){case"t":return p("t"),p("r"),p("u"),p("e"),!0;case"f":return p("f"),p("a"),p("l"),p("s"),p("e"),!1;case"n":return p("n"),p("u"),p("l"),p("l"),null}u("Unexpected '"+a+"'")}()}},function(e,t){var i;return d=e+"",n=0,a=" ",i=c(),m(),a&&u("Syntax error"),"function"==typeof t?function e(i,r){var s,o=i[r];return o&&"object"==typeof o&&Object.keys(o).forEach((function(t){void 0!==(s=e(o,t))?o[t]=s:delete o[t]})),t.call(i,r,o)}({"":i},""):i}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Config=t.ENV=void 0;t.Config={checkSumUrl:"https://nrtc.netease.im/demo/getChecksum.action",createChannelUrl:"https://nrtc.netease.im/nrtc/createChannel.action",getChannelInfoUrl:"https://nrtc.netease.im/nrtc/getChannelInfos.action",roomsTaskUrl:"https://roomserver.netease.im/v2/sdk/rooms/",getCloudProxyInfoUrl:"https://ap-prd-jd.netease.im/v1/g2/getCloudProxyInfo"};t.ENV="production"},function(e,t){var i,r;i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r={rotl:function(e,t){return e<<t|e>>>32-t},rotr:function(e,t){return e<<32-t|e>>>t},endian:function(e){if(e.constructor==Number)return 16711935&r.rotl(e,8)|4278255360&r.rotl(e,24);for(var t=0;t<e.length;t++)e[t]=r.endian(e[t]);return e},randomBytes:function(e){for(var t=[];e>0;e--)t.push(Math.floor(256*Math.random()));return t},bytesToWords:function(e){for(var t=[],i=0,r=0;i<e.length;i++,r+=8)t[r>>>5]|=e[i]<<24-r%32;return t},wordsToBytes:function(e){for(var t=[],i=0;i<32*e.length;i+=8)t.push(e[i>>>5]>>>24-i%32&255);return t},bytesToHex:function(e){for(var t=[],i=0;i<e.length;i++)t.push((e[i]>>>4).toString(16)),t.push((15&e[i]).toString(16));return t.join("")},hexToBytes:function(e){for(var t=[],i=0;i<e.length;i+=2)t.push(parseInt(e.substr(i,2),16));return t},bytesToBase64:function(e){for(var t=[],r=0;r<e.length;r+=3)for(var s=e[r]<<16|e[r+1]<<8|e[r+2],o=0;o<4;o++)8*r+6*o<=8*e.length?t.push(i.charAt(s>>>6*(3-o)&63)):t.push("=");return t.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/gi,"");for(var t=[],r=0,s=0;r<e.length;s=++r%4)0!=s&&t.push((i.indexOf(e.charAt(r-1))&Math.pow(2,-2*s+8)-1)<<2*s|i.indexOf(e.charAt(r))>>>6-2*s);return t}},e.exports=r},function(e,t){function i(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}
/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */
e.exports=function(e){return null!=e&&(i(e)||function(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&i(e.slice(0,0))}(e)||!!e._isBuffer)}},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Signalling=void 0;const a=i(3),d=i(145),c=i(27),l=n(i(11)),u=i(22),p=i(44),h=i(59),f=i(152),m=i(153),g=n(i(1)),v=n(i(0)),y=i(25),_=o(i(13)),S=i(2),b=i(155);class R extends a.EventEmitter{constructor(e){super(),this._reconnectionTimer=null,this._protoo=null,this._times=0,this._url=null,this._reconnectionTimeout=3e4,this._resolve=null,this._reject=null,this.consumers={},this.keepAliveTimer=null,this.reconnectionControl={blocker:null,pausers:[],resumers:[]},this.logger=e.logger.getChild(()=>{var t;let i="signal";return this._protoo?(this._protoo.id&&(i+="#"+this._protoo.id+"_"+(null===(t=this._protoo._transport)||void 0===t?void 0:t.wsid)),this._protoo.connected||(i+="!connected")):i+=" PROTOO_UNINIT",e.adapterRef._signalling!==this&&(i+=" DETACHED"),i}),this._reset(),this.adapterRef=e.adapterRef,_.IS_EDG?this.browserDevice="Edge-"+y.platform.version:this.browserDevice=y.platform.name+"-"+y.platform.version}getTimeOut(e){const t=this._times;let i;return i="join"===e?S.getParameters().joinFirstTimeout+2e3*Math.max(t-1,0):S.getParameters().reconnectionFirstTimeout+2e3*Math.max(t-1,0),i}async _reset(){this._reconnectionTimer&&clearTimeout(this._reconnectionTimer),this._reconnectionTimer=null,this._times=0,this._destroyProtoo(),this._reconnectionTimeout=3e4,this._resolve=null,this._reject=null}init(e,t=!1,i=!1){return this._reconnectionTimer?Promise.resolve():new Promise((r,s)=>{t||(this._resolve=r),t||(this._reject=s),this._init(e),this._reconnectionTimer=setTimeout(()=>{this._reconnectionTimer=null,i?(this.adapterRef.instance.emit("pairing-websocket-reconnection-error"),this._reconnection()):this._connection()},this.getTimeOut(i?"reconnection":"join"))})}async _connection(){this.logger.log("Signalling _connection, times:",this._times),this._destroyProtoo(),this._times<S.getParameters().joinMaxRetry?(++this._times,this.logger.warn(`Signalling加入频道: 第 ${this.adapterRef.channelInfo.wssArrIndex+1}/${this.adapterRef.channelInfo.wssArr.length} 台服务器，第 ${this._times}/${S.getParameters().joinMaxRetry} 次尝试。服务器地址：${this.adapterRef.channelInfo._protooUrl}。等待时间：${this.getTimeOut("join")} 毫秒`),this.init(this.adapterRef.channelInfo._protooUrl,!0)):(this.logger.warn("Signalling 3次重连结束"),this._times=0,this._reject&&this._reject("timeout"))}async _reconnection(){if(this.logger.log("Signalling _reconnection, times:",this._times),!this._reconnectionTimer){this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="CONNECTING",this.adapterRef.connectState.reconnecting=!0,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.emit("pairing-websocket-reconnection-start"),this._destroyProtoo(),"CONNECTED"===this.adapterRef.connectState.prevState&&(this.adapterRef.netStatusList.forEach(e=>{e.uplinkNetworkQuality=0,e.downlinkNetworkQuality=0}),this.adapterRef.instance.safeEmit("network-quality",this.adapterRef.netStatusList)),this.reconnectionControl.pausers.length&&(this.logger.log("重连过程暂停"),this.reconnectionControl.pausers.forEach(e=>e({reason:"reconnection-start"})),this.reconnectionControl.pausers=[],await new Promise(e=>{this.reconnectionControl.blocker=e}));for(let e in this.adapterRef.remoteStreamMap){const t=this.adapterRef.remoteStreamMap[e];t._play&&(this.logger.warn("Destroy Remote Player",e),t._play.destroy())}if(this._times<S.getParameters().reconnectionMaxRetry)++this._times,this.logger.warn(`Signalling断线重连: 第 ${this.adapterRef.channelInfo.wssArrIndex+1}/${this.adapterRef.channelInfo.wssArr.length} 台服务器，第 ${this._times}/${S.getParameters().reconnectionMaxRetry} 次尝试。服务器地址：${this.adapterRef.channelInfo._protooUrl}。等待时间：${this.getTimeOut("reconnection")} 毫秒`),this.init(this.adapterRef.channelInfo._protooUrl,!0,!0);else{if(this.logger.warn(`Signalling  url: ${this.adapterRef.channelInfo._protooUrl}, 当前服务器地址重连结束, 尝试下一个服务器地址`),++this.adapterRef.channelInfo.wssArrIndex>=this.adapterRef.channelInfo.wssArr.length)return this.adapterRef.instance.emit("pairing-websocket-reconnection-skip"),this.logger.error("所有的服务器地址都连接失败, 主动离开房间"),this.adapterRef.channelInfo.wssArrIndex=0,this.adapterRef.instance.leave(),void this.adapterRef.instance.emit("error","SOCKET_ERROR");const e=this.adapterRef.channelInfo.wssArr[this.adapterRef.channelInfo.wssArrIndex];this._times=1,this.logger.warn(`Signalling 开始连接第 ${this.adapterRef.channelInfo.wssArrIndex+1}/${this.adapterRef.channelInfo.wssArr.length} 台服务器：${e}`),this.init(e,!0,!0)}}}_init(e){-1===e.indexOf("?")&&(e+="?"),this.logger.log("Signalling: init url=",e),this.adapterRef.channelInfo._protooUrl=e,this._url=`${-1===e.indexOf("://")?"wss://":""}${e}&cid=${this.adapterRef.channelInfo.cid}&uid=${this.adapterRef.channelInfo.uid}`,this.logger.log("连接的url: ",this._url);const t=new b.WebSocketTransport(this._url,{retry:{retries:0,factor:2,minTimeout:1e3,maxTimeout:2e3,forever:!1,maxRetryTime:2e3}});this._protoo=new b.Peer(t),this._bindEvent()}_bindEvent(){if(!this._protoo)throw new g.default({code:v.default.NOT_FOUND,message:"No this._protoo 1"});this._protoo.on("open",this.join.bind(this)),this._protoo.on("failed",this._handleFailed.bind(this)),this._protoo.on("notification",this._handleMessage.bind(this)),this._protoo.on("close",this._handleClose.bind(this)),this._protoo.on("disconnected",this._handleDisconnected.bind(this,this._protoo))}_destroyProtoo(){var e;if(this._protoo){this.logger.debug(`信令通道#${this._protoo.id}_${null===(e=this._protoo._transport)||void 0===e?void 0:e.wsid} 被主动关闭。`),this._protoo.removeAllListeners();try{this._protoo&&this._protoo.close()}catch(e){}this._protoo=null}}async _handleMessage(e){var t,i;switch(e.method){case"OnPeerJoin":{const{requestId:t,externData:i}=e.data;this.logger.log("收到OnPeerJoin成员加入消息 uid =",i.uid);let r=i.uid;"string"===this.adapterRef.channelInfo.uidType&&(r=new l.default(r),r=r.toString());let s=this.adapterRef.remoteStreamMap[r];s||(s=new d.RemoteStream({uid:r,audio:!1,video:!1,screen:!1,client:this.adapterRef.instance,platformType:i.platformType}),this.adapterRef.remoteStreamMap[r]=s,this.adapterRef.memberMap[r]=r),this.adapterRef.instance._roleInfo.audienceList[r]=!1,this.adapterRef.instance.safeEmit("peer-online",{uid:r});break}case"OnPeerLeave":{const{requestId:t,externData:i}=e.data;this.logger.log("OnPeerLeave externData =",i),i.userList&&i.userList.forEach(e=>{var t;let i=e.uid;"string"===this.adapterRef.channelInfo.uidType&&(i=new l.default(i),i=i.toString()),null===(t=this.adapterRef._mediasoup)||void 0===t||t.removeUselessConsumeRequest({uid:i}),this.adapterRef.instance.clearMember(i),this.adapterRef.instance.removeSsrc(i),delete this.adapterRef.instance._roleInfo.audienceList[i]});break}case"OnNewProducer":{const{requestId:r,externData:s}=e.data;this.logger.log("收到OnNewProducer发布消息 externData =",JSON.stringify(s.producerInfo));let o,{uid:n,producerId:a,mediaType:c,mute:u,simulcastEnable:p}=s.producerInfo;switch("string"===this.adapterRef.channelInfo.uidType&&(n=new l.default(n),n=n.toString()),c){case"video":o="video";break;case"screenShare":o="screen";break;case"audio":o="audio";break;default:throw new g.default({code:v.default.UNKNOWN_TYPE,message:"Unrecognized mediaType "+c})}let h=this.adapterRef.remoteStreamMap[n];h||(h=new d.RemoteStream({uid:n,audio:"audio"===o,video:"video"===o,screen:"screen"===o,client:this.adapterRef.instance,platformType:s.platformType}),this.adapterRef.remoteStreamMap[n]=h,this.adapterRef.memberMap[n]=n),h.pubStatus[o].consumerId?null===(t=this.adapterRef._mediasoup)||void 0===t||t.destroyConsumer(h.pubStatus[o].consumerId,h,o):null===(i=this.adapterRef._mediasoup)||void 0===i||i.removeUselessConsumeRequest({producerId:h.pubStatus[o].producerId}),h[o]=!0,h.pubStatus[o][o]=!0,h.pubStatus[o].producerId=a,h.pubStatus[o].mute=u,h.pubStatus[o].simulcastEnable=p,h.pubStatus[o].consumerId="",this.adapterRef._enableRts&&this.adapterRef._rtsTransport?this.adapterRef.instance.emit("rts-stream-added",{stream:h,kind:c}):this.adapterRef.instance.safeEmit("stream-added",{stream:h,mediaType:o}),u&&this.adapterRef.instance.safeEmit("mute-"+o,{uid:n});break}case"OnProducerClose":{const{requestId:t,code:i,errMsg:r,externData:s}=e.data;let{uid:o,producerId:n,mediaType:a,cid:d}=s;"string"===this.adapterRef.channelInfo.uidType&&(o=new l.default(o),o=o.toString());let c,u=this.adapterRef.remoteStreamMap[o];if(!u)return void this.logger.warn(`收到OnProducerClose消息，但是当前没有该Producer： code = ${i}, errMsg = ${r}, uid = ${o}, mediaType = ${a}, producerId: ${n}`);switch(this.logger.log(`收到OnProducerClose消息 code = ${i}, errMsg = ${r}, uid = ${o}, mediaType = ${a}, producerId: ${n}`),a){case"video":c="video";break;case"screenShare":c="screen";break;case"audio":c="audio";break;default:throw new g.default({code:v.default.UNKNOWN_TYPE,message:"Unrecognized mediaType "+a})}if(u.pubStatus[c].producerId!==n)return void this.logger.log("该 producerId 已经无效，不处理");if(!this.adapterRef._mediasoup)throw new g.default({code:v.default.NO_MEDIASERVER,message:"media server error 22"});this.adapterRef._mediasoup.removeUselessConsumeRequest({producerId:n}),u.pubStatus[c].consumerId&&(this.adapterRef._mediasoup.destroyConsumer(u.pubStatus[c].consumerId,u,c),u.pubStatus[c].consumerId=""),this.adapterRef.instance.removeSsrc(o,c),u.subStatus[c]=!1,u.pubStatus[c][c]=!1,u[c]=!1,u.pubStatus[c].consumerId="",u.pubStatus[c].producerId="";const h=this.adapterRef._statsReport&&this.adapterRef._statsReport.formativeStatsReport&&this.adapterRef._statsReport.formativeStatsReport.firstData.recvFirstData[o];"audio"===c?(u.mediaHelper.audio.micTrack=null,p.emptyStreamWith(u.mediaHelper.audio.audioStream,null),delete this.adapterRef.remoteAudioStats[o],h&&(h.recvFirstAudioFrame=!1,h.recvFirstAudioPackage=!1)):"video"===c?(u.mediaHelper.video.cameraTrack=null,p.emptyStreamWith(u.mediaHelper.video.videoStream,null),delete this.adapterRef.remoteVideoStats[o],h&&(h.recvFirstVideoFrame=!1,h.recvFirstVideoPackage=!1,h.videoTotalPlayDuration=0)):"screen"===c&&(u.mediaHelper.screen.screenVideoTrack=null,p.emptyStreamWith(u.mediaHelper.screen.screenVideoStream,null),delete this.adapterRef.remoteScreenStats[o],h&&(h.recvFirstScreenFrame=!1,h.recvFirstScreenPackage=!1,h.screenTotalPlayDuration=0)),this.adapterRef._enableRts?this.adapterRef.instance.emit("rts-stream-removed",{stream:u}):this.adapterRef.instance.safeEmit("stream-removed",{stream:u,mediaType:c});break}case"OnConsumerClose":{const{requestId:t,code:i,errMsg:r,consumerId:s,producerId:o}=e.data;this.logger.log(`chence OnConsumerClose code = ${i} errMsg = ${r} producerId = ${o}`);const n=this.consumers[s];if(!n)break;n.close();break}case"consumerPaused":{const{consumerId:t}=e.data;if(!this.consumers[t])break;break}case"consumerResumed":case"consumerScore":break;case"OnTransportClose":{const{requestId:t,code:i,errMsg:r,transportId:s}=e.data;if(this.logger.warn(`chence OnTransportClose: code = ${i}, errMsg = ${r}, transportId = ${s}`),!this.adapterRef._mediasoup)throw new g.default({code:v.default.NO_MEDIASERVER,message:"media server error 23"});this.adapterRef._mediasoup._sendTransport&&(this.adapterRef._mediasoup._micProducer||this.adapterRef._mediasoup._webcamProducer)?(this.logger.warn("服务器媒体进程crash，上行媒体和下行媒体同时重连"),this.adapterRef.channelStatus="connectioning",this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"OnTransportClose"}),this._reconnection()):this.logger.warn("服务器发送了错误信息");break}case"OnConsumerClose":{const{requestId:t,code:i,errMsg:r,consumerId:s,producerId:o}=e.data;if(this.logger.warn(`chence OnConsumerClose: code = ${i}, errMsg = ${r} consumerId = ${s}, producerId = ${o}`),!this.adapterRef._mediasoup)throw new g.default({code:v.default.NO_MEDIASERVER,message:"media server error 24"});this.adapterRef._mediasoup._recvTransport?(this.logger.warn("下行媒体同时重连"),this.adapterRef.channelStatus="connectioning",this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"OnConsumerClose"}),this._reconnection()):this.logger.warn("服务器发送了错误信息");break}case"OnSignalRestart":{const{requestId:t,code:i,errMsg:r}=e.data;if(this.logger.warn(`chence OnSignalRestart code = ${i} errMsg = ${r}`),this.logger.warn("服务器信令进程crash，重连"),this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"OnSignalRestart"}),!this._protoo)throw new g.default({code:v.default.NOT_FOUND,message:"No this._protoo 2"});if(this._protoo.connected){this.logger.log("OnSignalRestart即将在3秒后执行重连");const e=this._protoo;setTimeout(()=>{var t,i,r,s;e!==this._protoo?this.logger.log(`OnSignalRestart取消重连: 连接已被覆盖 ${e.id}_${null===(t=e._transport)||void 0===t?void 0:t.wsid}=>${null===(i=this._protoo)||void 0===i?void 0:i.id}_${null===(s=null===(r=this._protoo)||void 0===r?void 0:r._transport)||void 0===s?void 0:s.wsid}`):"join"===this.adapterRef.channelStatus?(this.logger.log("OnSignalRestart执行重连"),this.adapterRef.channelStatus="connectioning",this.adapterRef.instance.emit("pairing-websocket-reconnection-start"),this.join()):this.logger.log("OnSignalRestart取消重连。channelStatus：",this.adapterRef.channelStatus)},3e3)}else this._reconnection();break}case"activeSpeaker":break;case"OnKickOff":{let{msg:t,reason:i}=e.data.externData;this._handleKickedNotify(i);break}case"OnUserData":{let{type:t,data:i}=e.data.externData;if("StreamStatus"===t)this._handleStreamStatusNotify(i);else if("NetStatus"===t)this._handleNetStatusNotify(i);else if("Mute"===t)this.logger.log("mute变更: ",JSON.stringify(i,null,"")),this._handleMuteNotify(i);else if("UserRole"===t)this.logger.log("UserRole变更: ",JSON.stringify(i,null,"")),this._handleUserRoleNotify(e.data.externData);else if("RtmpTaskStatus"===t)this.logger.log("RtmpTaskStatus变更: ",JSON.stringify(i,null,"")),this.adapterRef.instance.safeEmit("rtmp-state",i);else if("MediaCapability"===t){if(this.logger.warn("MediaCapability房间能力变更: ",JSON.stringify(i,null,"")),this.adapterRef.mediaCapability.parseRoom(i),this.adapterRef.instance.safeEmit("mediaCapabilityChange"),this.adapterRef._mediasoup&&this.adapterRef.mediaCapability.room.videoCodecType&&this.adapterRef.localStream){const e=this.adapterRef.mediaCapability.getCodecSend("video",this.adapterRef._mediasoup._sendTransport.handler._sendingRtpParametersByKind.video),t=this.adapterRef.mediaCapability.getCodecSend("screen",this.adapterRef._mediasoup._sendTransport.handler._sendingRtpParametersByKind.video),i=this.adapterRef._mediasoup._webcamProducerCodec&&this.adapterRef._mediasoup._webcamProducerCodec!==e.codecName;i&&this.logger.warn("将视频的Codec切走：",this.adapterRef._mediasoup._webcamProducerCodec,"=>",e.codecName);const r=this.adapterRef._mediasoup._screenProducerCodec&&this.adapterRef._mediasoup._screenProducerCodec!==e.codecName;r&&this.logger.error("将辅流的Codec切走：",this.adapterRef._mediasoup._screenProducerCodec,"=>",t.codecName),i||r?this._protoo&&this._protoo._transport&&this._protoo._transport._ws&&this._protoo._transport._ws.close():this.logger.log("Codec保持不动。video:",this.adapterRef._mediasoup._webcamProducerCodec,", screen:",this.adapterRef._mediasoup._screenProducerCodec)}}else if("Ability"===t)this._handleAbility(e.data.externData.data);else if("ChangeRight"===t){if(1===i.audioRight?window.isAudioBanned=!0:2===i.audioRight&&(window.isAudioBanned=!1),1===i.videoRight?window.isVideoBanned=!0:2===i.videoRight&&(window.isVideoBanned=!1),window.isAudioBanned&&window.isVideoBanned&&this.adapterRef.instance.apiEventReport("setFunction",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!0,isVideoBanned:!0}),!window.isAudioBanned&&window.isVideoBanned&&this.adapterRef.instance.apiEventReport("setFunction",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!1,isVideoBanned:!0}),window.isAudioBanned&&!window.isVideoBanned&&this.adapterRef.instance.apiEventReport("setFunction",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!0,isVideoBanned:!1}),window.isAudioBanned||window.isVideoBanned||this.adapterRef.instance.apiEventReport("setFunction",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!1,isVideoBanned:!1}),window.isAudioBanned){if(!this.adapterRef.localStream)return;let e=this.adapterRef.localStream.audio,t=this.adapterRef.localStream.screenAudio;e&&this.adapterRef.localStream.close({type:"audio"}),t&&this.adapterRef.localStream.close({type:"screenAudio"}),this.adapterRef.localStream.stopAllEffects();let i=this.adapterRef.localStream.mediaHelper.audio;i.webAudio&&i.webAudio.context&&i.webAudio.mixAudioConf&&i.webAudio.mixAudioConf.audioSource&&this.adapterRef.localStream.stopAudioMixing()}if(!this.adapterRef.localStream)return;if(window.isVideoBanned){let e=this.adapterRef.localStream.video,t=this.adapterRef.localStream.screen;e&&this.adapterRef.localStream.close({type:"video"}),t&&this.adapterRef.localStream.close({type:"screen"})}}else this.logger.error(`收到OnUserData通知消息 type = ${t}, data: `,i)}}}_handleFailed(){this.logger.log("Signalling:_handleFailed")}_handleClose(){}_handleDisconnected(e){var t,i,r,s;this.logger.log("Signalling:_handleDisconnected"),this.logger.log("Signalling:_handleClose"),!this._reconnectionTimer||"connectioning"!==this.adapterRef.channelStatus&&"join"!==this.adapterRef.channelStatus?(this.logger.warn(`信令通道#${e.id}_${null===(s=e._transport)||void 0===s?void 0:s.wsid} 收到关闭信号，即将开始重连过程。`),this.adapterRef.channelStatus="connectioning",this._reconnection()):e.closed?this.logger.warn(`信令通道#${e.id}_${null===(t=e._transport)||void 0===t?void 0:t.wsid} 在建立过程中被关闭。当前正在重连中，等待下次重连过程。`):this.logger.warn(`信令通道#${e.id}_${null===(i=e._transport)||void 0===i?void 0:i.wsid} 在建立过程中被关闭。信令通道会自动重试。连接地址：${null===(r=e._transport)||void 0===r?void 0:r._url}`),this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"2"})}async join(){let e;e=!!this.adapterRef.encryption.encryptionSecret&&("none"!==this.adapterRef.encryption.encryptionMode&&"encoded-transform-sm4-128-ecb"!==this.adapterRef.encryption.encryptionMode);const t={method:"Join",requestId:""+Math.ceil(1e9*Math.random()),externData:{userName:""+this.adapterRef.channelInfo.uid,token:this.adapterRef.channelInfo.token,cname:""+this.adapterRef.channelInfo.channelName,subType:"select",role:"part",version:"2.0",sessionMode:"meeting",engineVersion:u.ENGINE_VERSION,userRole:this.adapterRef.instance._roleInfo.userRole,userType:3,platformType:16,rtmp:{support:this.adapterRef.channelInfo.sessionConfig.liveEnable},record:{host:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,supportVideo:this.adapterRef.channelInfo.sessionConfig.recordVideo,supportAuido:this.adapterRef.channelInfo.sessionConfig.recordAudio,recordType:this.adapterRef.channelInfo.sessionConfig.recordType-0},mediaCapabilitySet:this.adapterRef.mediaCapability.stringify(),browser:{name:c.RtcSystem.browser.ua,version:""+c.RtcSystem.browser.version},gmEnable:e,gmMode:h.encryptionModeToInt(this.adapterRef.encryption.encryptionMode),gmKey:this.adapterRef.encryption.encryptionSecret,userPriority:this.adapterRef.userPriority}};if(this.logger.log("Signalling: 向edge的WebSocket连接已打开，开始放送Join请求 -> ",JSON.stringify(t,null,"")),!this._protoo)throw new g.default({code:v.default.NOT_FOUND,message:"No this._protoo 3"});this._protoo.clear();try{let e,i=this._protoo;try{e=await this._protoo.request("Join",{requestId:t.requestId,externData:t.externData})}catch(e){if(i!==this._protoo)return void this.logger.warn(`过期的信令通道消息：【${e.name}】`,e.message);throw e}if(this.logger.log("Signalling:加入房间 ack ->  ",JSON.stringify(e,(e,t)=>"edgeRtpCapabilities"===e?null:t)),200!=e.code){const t=e.externData?e.externData.errMsg:e.errMsg;return this.logger.error("Signalling: 加入房间失败, reason = ",e.code,t),this._times&&(this.adapterRef.instance.emit("pairing-websocket-reconnection-error"),this.logger.error(`重连失败，重置重连次数: ${this._times} => 0`),this._times=0),void this._joinFailed(e.code,t)}if(this._times&&(this.logger.log(`重置重连次数: ${this._times} => 0`),this._times=0),1===e.externData.audioRight?window.isAudioBanned=!0:window.isAudioBanned=!1,1===e.externData.videoRight?window.isVideoBanned=!0:window.isVideoBanned=!1,window.isAudioBanned&&window.isVideoBanned&&this.adapterRef.instance.apiEventReport("setFunction",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!0,isVideoBanned:!0}),!window.isAudioBanned&&window.isVideoBanned&&this.adapterRef.instance.apiEventReport("setFunction",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!1,isVideoBanned:!0}),window.isAudioBanned&&!window.isVideoBanned&&this.adapterRef.instance.apiEventReport("setFunction",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!0,isVideoBanned:!1}),window.isAudioBanned||window.isVideoBanned||this.adapterRef.instance.apiEventReport("setFunction",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!1,isVideoBanned:!1}),this._reconnectionTimer&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=null),this.logger.log("Signalling:加入房间成功"),this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="CONNECTED",this.adapterRef.connectState.reconnecting=!1,"connectioning"===this.adapterRef.channelStatus){if(this.logger.log("重连成功，清除之前的媒体的通道"),this.adapterRef.channelStatus="join",this.adapterRef.instance.apiEventReport("setRelogin",{a_record:this.adapterRef.channelInfo.sessionConfig.recordAudio,v_record:this.adapterRef.channelInfo.sessionConfig.recordVideo,record_type:this.adapterRef.channelInfo.sessionConfig.recordType,host_speaker:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,result:0,reason:1,server_ip:this.adapterRef.channelInfo._protooUrl}),this.adapterRef.instance.resetChannel(),!this.adapterRef._mediasoup)throw new g.default({code:v.default.NO_MEDIASERVER,message:"media server error 25"});this.adapterRef._mediasoup._edgeRtpCapabilities=e.edgeRtpCapabilities,this.adapterRef.mediaCapability.parseRoom(e.externData.roomCapability),this.adapterRef.instance.emit("mediaCapabilityChange"),await this.adapterRef._mediasoup.init(),this.adapterRef.localStream?this.adapterRef.localStream.audio||this.adapterRef.localStream.video||this.adapterRef.localStream.screen||this.adapterRef.localStream.screenAudio||S.getParameters().allowEmptyMedia?(this.logger.log(`重连成功，重新publish本端流:audio ${this.adapterRef.localStream.hasAudio()} video ${this.adapterRef.localStream.hasVideo()} screen ${this.adapterRef.localStream.hasScreen()}`),this.adapterRef.instance.doPublish(this.adapterRef.localStream)):this.logger.log("重连成功，当前没有媒体流，无需发布"):this.logger.log("重连成功，当前在未发布状态，无需发布")}else{const t=this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2,i=Date.now();if(this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.joinedSuccessedTime=i,this.adapterRef.instance.apiEventReport("setLogin",{a_record:this.adapterRef.channelInfo.sessionConfig.recordAudio,v_record:this.adapterRef.channelInfo.sessionConfig.recordVideo,record_type:this.adapterRef.channelInfo.sessionConfig.recordType,host_speaker:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,result:0,server_ip:this.adapterRef.channelInfo._protooUrl,signal_time_elapsed:t.startWssTime-t.startJoinTime,time_elapsed:i-t.startJoinTime,model:this.browserDevice}),!this.adapterRef._mediasoup)throw new g.default({code:v.default.NO_MEDIASERVER,message:"media server error 26"});this.adapterRef._mediasoup._edgeRtpCapabilities=e.edgeRtpCapabilities,this.adapterRef.mediaCapability.parseRoom(e.externData.roomCapability),this.adapterRef.instance.emit("mediaCapabilityChange"),await this.adapterRef._mediasoup.init()}if(this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef._enableRts&&(await this.createRTSTransport(),this.adapterRef.instance.emit("connected")),this.logger.log("加入房间成功, 查看房间其他人的发布信息: ",JSON.stringify(e.externData.userList)),void 0!==e.externData&&e.externData.userList&&e.externData.userList.length){let t=this;for(const i of e.externData.userList){let e=i.uid;"string"===this.adapterRef.channelInfo.uidType&&(e=new l.default(e),e=e.toString());let r=this.adapterRef.remoteStreamMap[e];if(r?r.active=!0:(r=new d.RemoteStream({uid:e,audio:!1,video:!1,screen:!1,client:this.adapterRef.instance,platformType:i.platformType}),this.adapterRef.remoteStreamMap[e]=r,this.adapterRef.memberMap[e]=""+e,this.adapterRef.instance.safeEmit("peer-online",{uid:e})),i.producerInfoList)for(const e of i.producerInfoList){const{mediaType:i,producerId:s,mute:o,simulcastEnable:n}=e;let a;switch(i){case"video":a="video";break;case"screenShare":a="screen";break;case"audio":a="audio";break;default:throw new g.default({code:v.default.UNKNOWN_TYPE,message:"Unrecognized mediaType "+i})}r[a]=!0,r.pubStatus[a][a]=!0,r.pubStatus[a].producerId=s,r.pubStatus[a].mute=o,r.muteStatus[a].send=o,r.pubStatus[a].simulcastEnable=n,setTimeout(()=>{t.logger.log("通知房间成员发布信息: ",JSON.stringify(r.pubStatus)),t.adapterRef._enableRts&&t.adapterRef._rtsTransport?t.adapterRef.instance.emit("rts-stream-added",{stream:r,kind:a}):(r.pubStatus.audio.audio||r.pubStatus.video.video||r.pubStatus.screen.screen)&&t.adapterRef.instance.safeEmit("stream-added",{stream:r,mediaType:a}),o&&t.adapterRef.instance.safeEmit("mute-"+a,{uid:r.getId()})},0)}}for(let e in this.adapterRef.remoteStreamMap){this.adapterRef.remoteStreamMap[e].active||(this.logger.warn("重连期间远端流停止发布："+e),delete this.adapterRef.remoteStreamMap[e])}}this._resolve?(this.logger.log("加入房间成功, 反馈通知"),this._resolve(e),this._resolve=null,this._reject=null):(this.adapterRef.instance.emit("pairing-websocket-reconnection-success"),this.reconnectionControl.resumers.length&&(this.reconnectionControl.resumers.forEach(e=>e({reason:"reconnection-success"})),this.reconnectionControl.resumers=[])),this.doSendKeepAliveTask()}catch(e){this.logger.error("join() 登录失败, "+e.name+": "+e.message),this._joinFailed(-1,"LOGIN_ERROR")}}_joinFailed(e,t){this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnecting=!1,this.adapterRef.channelStatus="init",this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),4009===e&&this.adapterRef.instance.safeEmit("crypt-error",{cryptType:this.adapterRef.encryption.encryptionMode});const i=Date.now(),r=this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2;if(this.adapterRef.instance.apiEventReport("setLogin",{a_record:this.adapterRef.channelInfo.sessionConfig.recordAudio,v_record:this.adapterRef.channelInfo.sessionConfig.recordVideo,record_type:this.adapterRef.channelInfo.sessionConfig.recordType,host_speaker:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,result:e,server_ip:this.adapterRef.channelInfo._protooUrl,signal_time_elapsed:r.startWssTime-r.startJoinTime,time_elapsed:i-r.startJoinTime,model:this.browserDevice}),this._reject)this.logger.error("加入房间失败, 反馈通知"),this._reject(t),this._resolve=null,this._reject=null,this.keepAliveTimer&&(clearInterval(this.keepAliveTimer),this.keepAliveTimer=null),this.adapterRef.channelStatus="leave",this.adapterRef.instance.stopSession();else{switch(t){case"room not found":this.logger.error("网络重连时，加入房间失败，主动离开。重连失败原因：",t,"，这通常是因为房间内其他人都已离开，房间关闭引起的");break;default:this.logger.error("网络重连时，加入房间失败，主动离开。重连失败原因：",t)}this.logger.error("网络重连时，加入房间失败，主动离开。重连失败原因：",t),this.adapterRef.instance.emit("error","RELOGIN_ERROR"),this.adapterRef.instance.leave()}}doSendKeepAliveTask(){this.keepAliveTimer&&(clearInterval(this.keepAliveTimer),this.keepAliveTimer=null),this.keepAliveTimer=setInterval(()=>{this.doSendKeepAlive()},6e3)}async doSendKeepAlive(){var e,t;if(!(null===(e=this._protoo)||void 0===e?void 0:e.connected))return;const i=`#${this._protoo.id}_${null===(t=this._protoo._transport)||void 0===t?void 0:t.wsid}`;try{await this._protoo.request("Heartbeat")}catch(e){this.logger.error("信令包保活失败",i,e.name,e.message),this.keepAliveTimer&&(clearInterval(this.keepAliveTimer),this.keepAliveTimer=null)}}async createRTSTransport(){if(this.logger.log("createRTSTransport()"),!this._protoo)throw new g.default({code:v.default.NOT_FOUND,message:"createRTSTransport: _protoo is null"});if(!this._url)throw new g.default({code:v.default.NOT_FOUND,message:"createRTSTransport: _url is null"});try{const e=await this._protoo.request("CreateWsTrasnport");this.logger.warn("CreateWsTrasnport response: ",JSON.stringify(e,null,""));const{code:t,errMsg:i,transportId:r,wsPort:s="6666"}=e;200==t?(this.adapterRef._rtsTransport&&(this.logger.log("CreateWsTrasnport: 需要更新"),this.adapterRef._rtsTransport.destroy()),this.logger.log("CreateWsTrasnport: 开始创建"),this.adapterRef._rtsTransport=new f.RTSTransport({url:this._url.replace(/:\d+/,":"+s)+"&transportId="+r,transportId:r,port:s,adapterRef:this.adapterRef})):this.logger.error(`createWsTrasnport failed, code: ${t}, reason: ${i}`)}catch(e){throw this.logger.error("createRTSTransport failed:",e.name,e.message),e}}async rtsRequestKeyFrame(e){if(this.logger.log("rtsRequestKeyFrame(): ",e),!this._protoo)throw new g.default({code:v.default.NOT_FOUND,message:"rtsRequestKeyFrame: no _proto"});if(!e)throw new g.default({code:v.default.NOT_FOUND,message:"rtsRequestKeyFrame: no consumerId"});try{const t=await this._protoo.request("RequestKeyFrame",{consumerId:e});this.logger.warn("rtsRequestKeyFrame response: ",t);let{code:i,errMsg:r}=t;200==i?this.logger.log("RTS 关键帧请求完成"):this.logger.error(`RTS 关键帧请求失败, code: ${i}, reason: ${r}`)}catch(e){throw this.logger.error("rtsRequestKeyFrame failed:",e),e}}async doSendLogout(){if(this.logger.log("doSendLogout begin"),this.keepAliveTimer&&(clearInterval(this.keepAliveTimer),this.keepAliveTimer=null),!this._protoo||!this._protoo.connected)return;let e={requestId:""+Math.ceil(1e9*Math.random()),externData:{reason:0}};this._protoo.notify("Leave",e),this.logger.log("doSendLogout success")}_handleStreamStatusNotify(e){}_handleNetStatusNotify(e){const t=e.netStatusList;let i=m.parseBase64(t).toString(),r=[],s=i.substr(2,2)+i.substr(0,2);s=parseInt(s,16),i=i.substr(4);for(let e=0;e<s;e++){let e=i.substr(0,16);e=o(e);const t=i.substr(16,2),s=i.substr(18,2);let a=0,d=null;if("00"!=i.substr(20,2)){const e=i.substr(22,2);a=parseInt(e,16),d=i.substr(24,a),a++}const c={uid:"string"===this.adapterRef.channelInfo.uidType?n(e):parseInt(e,16),downlinkNetworkQuality:parseInt(t,16),uplinkNetworkQuality:parseInt(s,16),receiveTs:Date.now()};r.push(c),i=i.substr(22+a)}function o(e){let t=[];for(var i=e.length;i>=1;i-=2)t.push(e[i-2],e[i-1]);return t.join("")}function n(e){const t=e.length;let i,r=new Array(t),s=new l.default(0);for(let s=0;s<t;s++)i=e.charCodeAt(s),48<=i&&i<58?i-=48:i=(223&i)-65+10,r[s]=i;for(let e=0;e<r.length;e++){const t=r[e];s=d(a(s,16),t)}return s.toString()}function a(e,t){if(0==e.toNumber())return e;const i=e.multipliedBy(t);return l.default("7e+500").times(t),e.multipliedBy("-a",16),i}function d(e,t){return t=e.plus(t),l.default(.7).plus(e).plus(t),e.plus("0.1",8),t}let c=!0,u=[];r=r.filter(e=>0!=e.uid),this.adapterRef.netStatusList.map(e=>{c=!0,r.map(t=>{e.uid!=t.uid&&0!=t.uid||(c=!1)}),c&&u.push(e)});let p=u.concat(r);p=p.filter(e=>this.adapterRef.memberMap[e.uid]||e.uid==this.adapterRef.channelInfo.uid),this.adapterRef.netStatusList=p,this.adapterRef.instance.safeEmit("network-quality",this.adapterRef.netStatusList)}_handleMuteNotify(e){const t=e.producerId,i=e.mute;Object.values(this.adapterRef.remoteStreamMap).forEach(e=>{["audio","video","screen"].forEach(r=>{e.pubStatus[r].producerId===t&&(e.muteStatus[r].send=i,i?this.adapterRef.instance.safeEmit("mute-"+r,{uid:e.getId()}):this.adapterRef.instance.safeEmit("unmute-"+r,{uid:e.getId()}))})})}_handleUserRoleNotify(e){let t=e.uid;"string"===this.adapterRef.channelInfo.uidType&&(t=new l.default(t),t=t.toString());const i=e.data&&e.data.userRole;if(this.logger.warn(`用户${t}角色变为${i?"观众":"主播"}`),t&&1===i&&(this.adapterRef.instance.clearMember(t),this.adapterRef.instance.removeSsrc(t),this.adapterRef.instance._roleInfo.audienceList[t]=!0),t&&0===i){this.adapterRef.instance.safeEmit("peer-online",{uid:t});let i=this.adapterRef.remoteStreamMap[t];i||(i=new d.RemoteStream({uid:t,audio:!1,video:!1,screen:!1,client:this.adapterRef.instance,platformType:e.platformType}),this.adapterRef.remoteStreamMap[t]=i,this.adapterRef.memberMap[t]=t),this.adapterRef.instance._roleInfo.audienceList[t]=!1}}_handleAbility(e){this.adapterRef.instance.emit("warning",{code:e.code,msg:e.msg})}_handleKickedNotify(e,t=this.adapterRef.channelInfo.uid){"string"===this.adapterRef.channelInfo.uidType&&(t=(t=new l.default(t)).toString()),1==e?(this.logger.warn("房间被关闭"),this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=30207,this.adapterRef.instance.leave(),this.adapterRef.instance.safeEmit("channel-closed",{})):2==e&&(this.logger.warn(t+"被提出房间"),t.toString()==this.adapterRef.channelInfo.uid.toString()&&(this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=30206,this.adapterRef.instance.leave()),this.adapterRef.instance.safeEmit("client-banned",{uid:t}))}destroy(){this.logger.log("清除 Signalling"),this._destroyProtoo(),this._reset()}}t.Signalling=R},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RemoteStream=void 0;const s=i(3),o=i(42),n=i(86),a=i(87),d=i(88),c=i(89),l=i(23),u=r(i(1)),p=r(i(0)),h=r(i(11));let f=0;class m extends s.EventEmitter{constructor(e){if(super(),this.platformType=d.PlatformType.unknown,this.pubStatus={audio:{audio:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},video:{video:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},screen:{screen:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1}},this.subStatus={audio:!1,video:!1,screen:!1},this.muteStatus={audio:{send:!1,recv:!1},video:{send:!1,recv:!1},screen:{send:!1,recv:!1}},this.isRemote=!0,this.active=!0,this.spatialPosition={x:0,y:0},this.remoteStreamId=f++,this.streamID=e.uid,this.stringStreamID=this.streamID.toString(),this.platformType=e.platformType,this.logger=e.client.adapterRef.logger.getChild(()=>{let t="remote#"+this.stringStreamID;return d.PlatformTypeMap[this.platformType]&&(t+=" "+d.PlatformTypeMap[this.platformType]),t+=this.remoteStreamId,this.pubStatus.audio.consumerId?t+="M":this.pubStatus.audio.producerId&&(t+="m"),this.pubStatus.video.consumerId?t+="C":this.pubStatus.video.producerId&&(t+="c"),this.pubStatus.screen.consumerId?t+="S":this.pubStatus.screen.producerId&&(t+="s"),e.client.adapterRef.remoteStreamMap[this.streamID]!==this&&(t+=" DETACHED"),t}),"string"==typeof e.uid||h.default.isBigNumber(e.uid))this.logger.log("uid是string类型"),e.client.adapterRef.channelInfo.uidType="string";else{if("number"!=typeof e.uid)throw this.logger.error("uid参数格式非法"),new u.default({code:p.default.INVALID_PARAMETER,message:"uid is invalid"});if(this.logger.log("uid是number类型"),e.client.adapterRef.channelInfo.uidType="number",e.uid>Number.MAX_SAFE_INTEGER)throw new u.default({code:p.default.INVALID_PARAMETER,message:"uid is exceeds the scope of Number"})}this.videoView=null,this.screenView=null,this.renderMode={remote:{video:{},screen:{}}},this.consumerId=null,this.producerId=null,this.audioPlay_=!1,this.videoPlay_=!1,this.screenPlay_=!1,this.subConf={audio:!0,video:!0,screen:!0,highOrLow:{video:o.STREAM_TYPE.HIGH,screen:o.STREAM_TYPE.HIGH}},this.renderMode={remote:{video:{},screen:{}}},this._reset(),this.streamID=e.uid,this.stringStreamID=this.streamID.toString(),this.audio=e.audio,this.video=e.video||!1,this.screen=e.screen||!1,this.client=e.client,this.mediaHelper=new c.MediaHelper({stream:this}),this._play=new n.Play({stream:this}),this._record=new a.Record({logger:this.logger,stream:this}),this.logger.log("创建远端Stream: ",JSON.stringify({streamID:this.stringStreamID,audio:e.audio,video:e.video})),this.client.apiFrequencyControl({name:"createStream",code:0,param:JSON.stringify({audio:this.audio,video:this.video,screen:this.screen},null," ")})}_reset(){this.audio=!1,this.video=!1,this.screen=!1,this.videoView=null,this.screenView=null,this.renderMode={remote:{video:{},screen:{}}},this.consumerId=null,this.producerId=null,this.pubStatus={audio:{audio:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},video:{video:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},screen:{screen:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1}},this.subConf={audio:!0,video:!0,screen:!0,highOrLow:{video:o.STREAM_TYPE.HIGH,screen:o.STREAM_TYPE.HIGH}},this.subStatus={audio:!1,video:!1,screen:!1},this.muteStatus={audio:{send:!1,recv:!1},video:{send:!1,recv:!1},screen:{send:!1,recv:!1}},this.renderMode={remote:{video:{},screen:{}}},this.mediaHelper&&this.mediaHelper.destroy(),this._play&&this._play.destroy(),this._play=null,this._record&&this._record.destroy(),this._record=null}get Play(){return this._play}get Record(){return this._record}getId(){return"string"===this.client.adapterRef.channelInfo.uidType?this.stringStreamID:this.streamID}async getStats(){let e=this.client.adapterRef&&this.client.adapterRef._mediasoup&&this.client.adapterRef._mediasoup._recvTransport&&this.client.adapterRef._mediasoup._recvTransport._handler._pc;if(this.logger.log("获取音视频连接数据, uid: "+this.stringStreamID),e){const t={accessDelay:"0",audioReceiveBytes:"0",audioReceivePackets:"0",audioReceivePacketsLost:"0",endToEndDelay:"0",videoReceiveBytes:"0",videoReceiveDecodeFrameRate:"0",videoReceiveFrameRate:"0",videoReceivePackets:"0",videoReceivePacketsLost:"0",videoReceiveResolutionHeight:"0",videoReceiveResolutionWidth:"0"};try{(await e.getStats()).forEach(e=>{"inbound-rtp"===e.type?"video"===e.mediaType?(t.videoReceiveBytes=e.bytesReceived.toString(),t.videoReceivePackets=e.packetsReceived.toString(),t.videoReceivePacketsLost=e.packetsLost.toString(),t.videoReceiveFrameRate=e.framesPerSecond.toString(),t.videoReceiveDecodeFrameRate=e.framesPerSecond.toString()):"audio"===e.mediaType&&(t.audioReceiveBytes=e.bytesReceived.toString(),t.audioReceivePackets=e.packetsReceived.toString(),t.audioReceivePacketsLost=e.packetsLost.toString()):"candidate-pair"===e.type?("number"==typeof e.currentRoundTripTime&&(t.accessDelay=(1e3*e.currentRoundTripTime).toString()),"number"==typeof e.totalRoundTripTime&&(t.endToEndDelay=Math.round(100*e.totalRoundTripTime).toString())):"track"===e.type&&void 0!==e.frameWidth&&(t.videoReceiveResolutionWidth=e.frameWidth.toString(),t.videoReceiveResolutionHeight=e.frameHeight.toString())})}catch(e){this.logger.error("failed to get remoteStats",e.name,e.message)}return t}}setSubscribeConfig(e){if(this.logger.log("设置订阅规则：",JSON.stringify(e)),"number"==typeof e.highOrLow&&(this.subConf.highOrLow.video=e.highOrLow,this.subConf.highOrLow.screen=e.highOrLow),"boolean"==typeof e.audio&&(this.subConf.audio=e.audio),"boolean"==typeof e.video?this.subConf.video=e.video:"high"===e.video?(this.subConf.video=!0,this.subConf.highOrLow.video=o.STREAM_TYPE.HIGH):"low"===e.video&&(this.subConf.video=!0,this.subConf.highOrLow.video=o.STREAM_TYPE.LOW),"boolean"==typeof e.screen?this.subConf.screen=e.screen:"high"===e.screen?(this.subConf.screen=!0,this.subConf.highOrLow.screen=o.STREAM_TYPE.HIGH):"low"===e.screen&&(this.subConf.screen=!0,this.subConf.highOrLow.screen=o.STREAM_TYPE.LOW),this.pubStatus.audio.audio&&this.subConf.audio?(this.subConf.audio=!0,this.audio=!0):this.subConf.audio=!1,this.pubStatus.video.video&&this.subConf.video?(this.subConf.video=!0,this.video=!0):this.subConf.video=!1,this.pubStatus.screen.screen&&this.subConf.screen?(this.subConf.screen=!0,this.screen=!0):this.subConf.screen=!1,this.logger.log("订阅规则：",JSON.stringify(this.subConf)),this.client.apiFrequencyControl({name:"setSubscribeConfig",code:0,param:JSON.stringify(e,null," ")}),this.pubStatus.screen.screen){const e={uid:"string"===this.client.adapterRef.channelInfo.uidType?this.stringStreamID:this.streamID,subscribe:this.subConf.screen};this.client.apiFrequencyControl({name:"subscribeRemoteSubStreamVideo",code:0,param:JSON.stringify(e,null," ")})}}getAudioStream(){return this.client.apiFrequencyControl({name:"setExternalAudioRender",code:0,param:JSON.stringify({},null," ")}),this.mediaHelper.audio.audioStream}getAudioTrack(){return this.mediaHelper.audio.audioStream.getAudioTracks()[0]||null}getVideoTrack(){return this.mediaHelper.video.videoStream.getVideoTracks()[0]||null}async play(e,t={}){if(l.isExistOptions({tag:"Stream.playOptions.audio",value:t.audio}).result||(t.audio=!0),l.isExistOptions({tag:"Stream.playOptions.video",value:t.video}).result||(t.video=!0),l.isExistOptions({tag:"Stream.playOptions.screen",value:t.screen}).result||(t.screen=!0),this.logger.log(`uid ${this.stringStreamID} Stream.play::`,JSON.stringify(t)),t.audio&&this._play&&this.mediaHelper.audio.audioStream.getTracks().length)if(this.client.spatialManager)this.logger.log("启用了空间音频，跳过本地音频播放。");else{this.logger.log(`uid ${this.stringStreamID} 开始播放远端音频`);try{await this._play.playAudioStream(this.mediaHelper.audio.audioStream,t.muted),this.audioPlay_=!0}catch(e){this.audioPlay_=!1,this.client.emit("notAllowedError",e),this.client.emit("NotAllowedError",e)}}let i;if(i="string"==typeof e?document.getElementById(e):e||null,i){if(t.video&&(this.videoView=i,this._play&&this.mediaHelper.video.videoStream.getVideoTracks().length)){this.logger.log(`uid ${this.stringStreamID} 开始启动视频播放 主流 远端`);try{await this._play.playVideoStream(this.mediaHelper.video.videoStream,i),"width"in this.renderMode.remote.video&&this._play.setVideoRender(this.renderMode.remote.video),this.videoPlay_=!0}catch(e){this.videoPlay_=!1,this.client.emit("notAllowedError",e),this.client.emit("NotAllowedError",e)}}if(t.screen&&(this.screenView=i,this._play&&this.mediaHelper&&this.mediaHelper.screen.screenVideoStream.getVideoTracks().length)){this.logger.log(`uid ${this.stringStreamID} 开始启动视频播放 辅流 远端`);try{await this._play.playScreenStream(this.mediaHelper.screen.screenVideoStream,i),"width"in this.renderMode.remote.screen&&this._play.setScreenRender(this.renderMode.remote.screen),this.screenPlay_=!1}catch(e){this.screenPlay_=!1,this.client.emit("notAllowedError",e),this.client.emit("NotAllowedError",e)}}}this.client.apiFrequencyControl({name:"play",code:0,param:JSON.stringify({playOptions:t,audio:this.audio,video:this.video,screen:this.screen,renderMode:this.renderMode},null," ")})}async resume(){this._play&&(await this._play.resume(),this._play.audioDom&&!this._play.audioDom.paused&&(this.audioPlay_=!0),this._play.videoDom&&!this._play.videoDom.paused&&(this.videoPlay_=!0),this._play.screenDom&&!this._play.screenDom.paused&&(this.screenPlay_=!0))}setRemoteRenderMode(e,t){e&&e.width-0&&e.height-0||(this.logger.warn("setRemoteRenderMode 参数错误"),this.client.apiFrequencyControl({name:"setRemoteRenderMode",code:-1,param:JSON.stringify(e,null," ")})),this.client&&this._play&&(this.logger.log(`uid ${this.stringStreamID} 设置远端视频播放窗口大小: `,t||"video+screen",JSON.stringify(e)),t&&"video"!==t||(this._play&&this._play.setVideoRender(e),this.renderMode.remote.video=e),t&&"screen"!==t||(this.renderMode.remote.screen=e,this._play&&this._play.setScreenRender(e)),this.client.apiFrequencyControl({name:"setRemoteRenderMode",code:0,param:JSON.stringify(e,null," ")}))}stop(e){this.logger.log(`uid ${this.stringStreamID} Stream.stop: 停止播放 ${e||"音视频流"}`),this._play&&("audio"===e?(this._play.stopPlayAudioStream(),this.audioPlay_=!1):"video"===e?(this._play.stopPlayVideoStream(),this.videoPlay_=!1):"screen"===e?(this._play.stopPlayScreenStream(),this.screenPlay_=!1):(this._play.audioDom&&(this._play.stopPlayAudioStream(),this.audioPlay_=!1),this._play.videoDom&&(this._play.stopPlayVideoStream(),this.videoPlay_=!1),this._play.screenDom&&(this._play.stopPlayScreenStream(),this.screenPlay_=!1)),this.client.apiFrequencyControl({name:"stop",code:0,param:JSON.stringify({audio:this.audio,video:this.video,screen:this.screen,renderMode:this.renderMode},null," ")}))}async isPlaying(e){let t=!1;if(this._play)if("audio"===e)t=await this._play.isPlayAudioStream();else if("video"===e)t=await this._play.isPlayVideoStream();else{if("screen"!==e)return this.logger.warn("isPlaying: unknown type"),Promise.reject(new u.default({code:p.default.UNKNOWN_TYPE,message:"unknown type"}));t=await this._play.isPlayScreenStream()}else;return this.logger.log(`检查${this.stringStreamID}的${e}播放状态: ${t}`),t}async unmuteAudio(){this.logger.log("启用音频轨道: ",this.stringStreamID);try{if(!this._play)throw new u.default({code:p.default.NO_PLAY,message:"no play"});this.muteStatus.audio.recv=!0,this.mediaHelper.audio.audioStream.getAudioTracks().length&&(this.mediaHelper.audio.audioStream.getAudioTracks()[0].enabled=!0),this._play.playAudioStream(this.mediaHelper.audio.audioStream,!1),this.client.apiFrequencyControl({name:"unmuteAudio",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("API调用失败：Stream:unmuteAudio",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteAudio",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}async muteAudio(){this.logger.log("禁用音频轨道: ",this.stringStreamID);try{if(!this._play)throw new u.default({code:p.default.NO_PLAY,message:"no play"});this.muteStatus.audio.recv=!0,this.mediaHelper.audio.audioStream.getAudioTracks().length&&(this.mediaHelper.audio.audioStream.getAudioTracks()[0].enabled=!1),this._play.stopPlayAudioStream(),this.client.apiFrequencyControl({name:"muteAudio",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("API调用失败：Stream:muteAudio",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteAudio",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}hasAudio(){return this.mediaHelper.audio.audioStream.getAudioTracks().length>0}setAudioVolume(e=100){let t=null;if(Number.isInteger(e)?e<0?e=0:e>100?e=255:e*=2.55:(this.logger.log("volume 为 0 - 100 的整数"),t="INVALID_ARGUMENTS"),this.logger.log(`调节${this.stringStreamID}的音量大小: ${e}`),this.audio){if(!this._play)throw new u.default({code:p.default.NO_PLAY,message:"no play"});this._play.setPlayVolume(e)}else this.logger.log("没有音频流，请检查是否有发布过音频"),t="INVALID_OPERATION";if(t)return this.client.apiFrequencyControl({name:"setAudioVolume",code:-1,param:JSON.stringify({volume:e,reason:t},null," ")}),t;this.client.apiFrequencyControl({name:"setAudioVolume",code:0,param:JSON.stringify({volume:e},null," ")})}async setAudioOutput(e,t){if(this._play){try{await this._play.setAudioOutput(e)}catch(e){throw t&&setTimeout(()=>{t(e)},0),this.logger.error("设置输出设备失败",e.name,e.message),e}t&&setTimeout(t,0)}}async unmuteVideo(){this.logger.log(`启用 ${this.stringStreamID} 的视频轨道`);try{if(!this._play)throw new u.default({code:p.default.NO_PLAY,message:"no play"});if(!this.videoView)throw new u.default({code:p.default.NO_MEDIAHELPER,message:"no this.view"});this.muteStatus.video.recv=!1,this.mediaHelper&&this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!0),this.client.apiFrequencyControl({name:"unmuteVideo",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("API调用失败：Stream:unmuteVideo",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteVideo",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}async muteVideo(){this.logger.log(`禁用 ${this.stringStreamID} 的视频轨道`);try{if(!this._play)throw new u.default({code:p.default.NO_PLAY,message:"no play"});this.muteStatus.video.recv=!0,this.mediaHelper&&this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!1),this.client.apiFrequencyControl({name:"muteVideo",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("API调用失败：Stream:muteVideo",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteVideo",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}async unmuteScreen(){this.logger.log(`启用 ${this.stringStreamID} 的视频轨道`);try{if(!this._play)throw new u.default({code:p.default.NO_PLAY,message:"no play"});if(!this.screenView)throw new u.default({code:p.default.NO_MEDIAHELPER,message:"no this.screenView"});this.muteStatus.screen.recv=!1,this.mediaHelper&&this.mediaHelper.screen.screenVideoTrack&&(this.mediaHelper.screen.screenVideoTrack.enabled=!0),this.client.apiFrequencyControl({name:"unmuteScreen",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("API调用失败：Stream:unmuteScreen",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteScreen",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}async muteScreen(){this.logger.log(`禁用 ${this.stringStreamID} 的视频轨道`);try{if(!this._play)throw new u.default({code:p.default.NO_PLAY,message:"no play"});this.mediaHelper&&this.mediaHelper.screen.screenVideoTrack&&(this.mediaHelper.screen.screenVideoTrack.enabled=!1),this.muteStatus.screen.recv=!0,this.client.apiFrequencyControl({name:"muteScreen",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("API调用失败：Stream:muteScreen",e,...arguments),this.client.apiFrequencyControl({name:"muteScreen",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}hasVideo(){this.logger.log("获取视频 flag"),this.mediaHelper.video.videoStream.getVideoTracks().length}hasScreen(){this.mediaHelper.screen.screenVideoStream.getVideoTracks().length}async takeSnapshot(e){if(!this.video&&!this.screen)return this.logger.log("没有视频流，请检查是否有 订阅 过视频"),this.client.apiFrequencyControl({name:"takeSnapshot",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:"没有视频流，请检查是否有 订阅 过视频"},null," ")}),"INVALID_OPERATION";if(!this._play)throw new u.default({code:p.default.NO_PLAY,message:"no play"});await this._play.takeSnapshot(e,this.streamID),this.client.apiFrequencyControl({name:"takeSnapshot",code:0,param:JSON.stringify(e,null," ")})}async startMediaRecording(e){const t=[];if(!this.mediaHelper)throw new u.default({code:p.default.NO_MEDIAHELPER,message:"no media helper"});switch(e.type){case"screen":t.push(this.mediaHelper.screen.screenVideoStream),t.push(this.mediaHelper.audio.audioStream);break;case"camera":case"video":t.push(this.mediaHelper.video.videoStream),t.push(this.mediaHelper.audio.audioStream);break;case"audio":t.push(this.mediaHelper.audio.audioStream)}if(0!==t.length){if(!this._record||!this.streamID||!t)throw new u.default({code:p.default.INVALID_PARAMETER,message:"startMediaRecording: invalid parameter"});return this._record&&this._record.start({uid:"string"===this.client.adapterRef.channelInfo.uidType?this.stringStreamID:this.streamID,type:e.type,reset:e.reset,stream:t})}this.logger.log("没有没发现要录制的媒体流")}stopMediaRecording(e){if(!this._record)throw new u.default({code:p.default.NO_RECORD,message:"no record"});return this._record.stop({})}playMediaRecording(e){if(!this._record)throw new u.default({code:p.default.NO_RECORD,message:"no record"});return this._record.play(e.view)}listMediaRecording(){let e=[];if(!this._record)throw new u.default({code:p.default.NO_RECORD,message:"no record"});const t=this._record.getRecordStatus();return"init"!==t.status&&e.push(t),e}cleanMediaRecording(e){if(!this._record)throw new u.default({code:p.default.NO_RECORD,message:"no record"});return this._record.clean()}downloadMediaRecording(e){if(!this._record)throw new u.default({code:p.default.NO_RECORD,message:"no record"});return this._record.download()}clearRemotePubStatus(){let e=["audio","video","screen"];for(let t of e)this[t]=!1,this.pubStatus[t][t]=!1,this.pubStatus[t].producerId="",this.pubStatus[t].consumerId="",this.pubStatus[t].consumerStatus="init",this.pubStatus[t].stopconsumerStatus="init"}setCanvasWatermarkConfigs(e){if(this._play&&this._play._watermarkControl){let t=null;if(e.mediaType&&"video"!==e.mediaType?"screen"===e.mediaType&&this._play._watermarkControlScreen&&(t=this._play._watermarkControlScreen):this._play._watermarkControl&&(t=this._play._watermarkControl),!t)return void this.logger.error("setCanvasWatermarkConfigs：播放器未初始化",e.mediaType);const i={TEXT:10,TIMESTAMP:1,IMAGE:4};if(e.textWatermarks&&e.textWatermarks.length>i.TEXT)throw this.logger.error(`目前的文字水印数量：${e.textWatermarks.length}。允许的数量：${i.TEXT}`),new u.default({code:p.default.INVALID_PARAMETER,message:"watermark exceeds limit"});if(e.imageWatermarks&&e.imageWatermarks.length>i.IMAGE)throw this.logger.error(`目前的图片水印数量：${e.imageWatermarks.length}。允许的数量：${i.IMAGE}`),new u.default({code:p.default.INVALID_PARAMETER,message:"watermark exceeds limit"});t.checkWatermarkParams(e),t.updateWatermarks(e),this.client.apiFrequencyControl({name:"setCanvasWatermarkConfigs",code:0,param:JSON.stringify(e,null,2)})}else this.logger.error("setCanvasWatermarkConfigs：播放器未初始化")}getMuteStatus(e){return"audio"===e?{send:this.muteStatus.audio.send,recv:this.muteStatus.audio.recv,muted:this.muteStatus.audio.send||this.muteStatus.audio.recv}:"video"===e?{send:this.muteStatus.video.send,recv:this.muteStatus.video.recv,muted:this.muteStatus.video.send||this.muteStatus.video.recv}:{send:this.muteStatus.screen.send,recv:this.muteStatus.screen.recv,muted:this.muteStatus.screen.send||this.muteStatus.screen.recv}}getAdapterRef(){return this.client.adapterRef.remoteStreamMap[this.streamID]===this?this.client.adapterRef:null}destroy(){this.client&&(this.client.apiFrequencyControl({name:"destroy",code:0,param:JSON.stringify({audio:this.audio,video:this.video,screen:this.screen},null," ")}),this.logger.log(`uid ${this.stringStreamID} 销毁 Stream 实例`),this.stop(),this._reset())}}t.RemoteStream=m},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createWatermarkControl=t.WatermarkControl=void 0;const s=i(3),o=r(i(147)),n=i(23),a=function(e){if(0===e)return"rgba(0,0,0,0)";let t,i,r,s;return r=e%256,i=(e=Math.floor(e/256))%256,t=(e=Math.floor(e/256))%256,s=(e=Math.floor(e/256))>0?(e%256/256).toFixed(2):1,`rgba(${t}, ${i}, ${r}, ${s})`};class d extends s.EventEmitter{constructor(e){super(),this.logger=e,this.settings={defaultStyle:{background:"rgba(128,128,128, 0.5)",overflow:"hidden","white-space":"break-spaces",position:"absolute",wordBreak:"break-all",color:"white",fontSize:"10pt"}},this.watermarks=[],this.div=null}checkWatermarkParams(e){e.textWatermarks&&e.textWatermarks.forEach(e=>{const t={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.fontSize",value:e.fontSize,min:1};n.isExistOptions(t).result&&n.checkValidInteger(t);const i={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.fontColor",value:e.fontColor,min:0};n.isExistOptions(i).result&&n.checkValidInteger(i);const r={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.wmWidth",value:e.wmWidth,min:0};n.isExistOptions(r).result&&n.checkValidInteger(r);const s={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.wmHeight",value:e.wmHeight,min:0};n.isExistOptions(s).result&&n.checkValidInteger(s);const o={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.offsetX",value:e.offsetX};n.isExistOptions(o).result&&n.checkValidInteger(o);const a={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.offsetY",value:e.offsetY};n.isExistOptions(a).result&&n.checkValidInteger(a)}),e.timestampWatermarks&&[e.timestampWatermarks].forEach(e=>{const t={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.fontSize",value:e.fontSize,min:1};n.isExistOptions(t).result&&n.checkValidInteger(t);const i={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.fontColor",value:e.fontColor,min:0};n.isExistOptions(i).result&&n.checkValidInteger(i);const r={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.wmWidth",value:e.wmWidth,min:0};n.isExistOptions(r).result&&n.checkValidInteger(r);const s={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.wmHeight",value:e.wmHeight,min:0};n.isExistOptions(s).result&&n.checkValidInteger(s);const o={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.offsetX",value:e.offsetX};n.isExistOptions(o).result&&n.checkValidInteger(o);const a={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.offsetY",value:e.offsetY};n.isExistOptions(a).result&&n.checkValidInteger(a)}),e.imageWatermarks&&e.imageWatermarks.forEach(e=>{const t={tag:"Stream.setCanvasWatermarkConfigs.imageWatermarks.wmWidth",value:e.wmWidth,min:0};n.isExistOptions(t).result&&n.checkValidInteger(t);const i={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.wmHeight",value:e.wmHeight,min:0};n.isExistOptions(i).result&&n.checkValidInteger(i);const r={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.offsetX",value:e.offsetX};n.isExistOptions(r).result&&n.checkValidInteger(r);const s={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.offsetY",value:e.offsetY};n.isExistOptions(s).result&&n.checkValidInteger(s);const o={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.imageUrls",value:e.imageUrls};n.checkExists(o);const a={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.imageUrls.length",value:e.imageUrls.length,min:1};n.checkValidInteger(a);const d={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.fps",value:e.fps,min:0};n.isExistOptions(d).result&&n.checkValidFloat(d)})}updateWatermarks(e){this.clear(),this.watermarks=[];const t={text:0,timestamp:0,image:0};e.imageWatermarks&&e.imageWatermarks.forEach(e=>{const t=Object.assign({},this.settings.defaultStyle,{background:"none"});let i;"number"==typeof e.offsetX?t.left=e.offsetX+"px":e.offsetX&&"string"==typeof e.offsetX&&(t.left=e.offsetX),"number"==typeof e.offsetY?t.top=e.offsetY+"px":e.offsetY&&"string"==typeof e.offsetY&&(t.top=e.offsetY),0!==e.wmWidth&&0!==e.wmHeight||(delete e.wmWidth,delete e.wmHeight),e.wmWidth&&("number"==typeof e.wmWidth?t.width=e.wmWidth+"px":"string"==typeof e.wmWidth&&(t.width=e.wmWidth)),e.wmHeight&&("number"==typeof e.wmHeight?t.height=e.wmHeight+"px":"string"==typeof e.wmHeight&&(t.height=e.wmHeight)),"number"==typeof e.wmHeight?t.height=e.wmHeight+"px":e.wmHeight&&"string"==typeof e.wmHeight&&(t.height=e.wmHeight),i=e.fps?{type:"image",content:"",imageUrls:e.imageUrls,loop:!(!1===e.loop),loopIndex:0,interval:1e3/(e.fps||1),elem:null,style:t}:{type:"image",content:"",imageUrls:[e.imageUrls[e.imageUrls.length-1]],loop:!1,loopIndex:0,interval:0,elem:null,style:t},this.watermarks.push(i)}),e.textWatermarks&&e.textWatermarks.forEach(e=>{let i=e.content||"";t.text++;const r=Object.assign({},this.settings.defaultStyle);"number"==typeof e.fontColor?r.color=a(e.fontColor):e.fontColor&&"string"==typeof e.fontColor&&(r.color=e.fontColor),"number"==typeof e.fontSize?r.fontSize=e.fontSize+"pt":e.fontSize&&"string"==typeof e.fontSize&&(r.fontSize=e.fontSize),"number"==typeof e.offsetX?r.left=e.offsetX+"px":e.offsetX&&"string"==typeof e.offsetX&&(r.left=e.offsetX),"number"==typeof e.offsetY?r.top=e.offsetY+"px":e.offsetY&&"string"==typeof e.offsetY&&(r.top=e.offsetY),!e.wmWidth&&!e.wmHeight||0===e.wmWidth||0===e.wmHeight?r.background="":"number"==typeof e.wmColor?r.background=a(e.wmColor):e.wmColor&&"string"==typeof e.wmColor&&(r.background=e.wmColor),e.wmWidth,"number"==typeof e.wmWidth?e.wmWidth>0&&(r.width=e.wmWidth+"px"):"string"==typeof e.wmWidth&&(r.width=e.wmWidth),e.wmHeight&&("number"==typeof e.wmHeight?(e.wmHeight>0&&(r.wmHeight=e.wmWidth+"px"),r.height=e.wmHeight+"px"):"string"==typeof e.wmHeight&&(r.height=e.wmHeight));const s={type:"text",content:i,loop:!1,elem:null,loopIndex:0,style:r};this.watermarks.push(s)}),e.timestampWatermarks&&[e.timestampWatermarks].forEach(e=>{t.timestamp++;const i=Object.assign({},this.settings.defaultStyle);"number"==typeof e.fontColor?i.color=a(e.fontColor):e.fontColor&&"string"==typeof e.fontColor&&(i.color=e.fontColor),"number"==typeof e.fontSize?i.fontSize=e.fontSize+"pt":e.fontSize&&"string"==typeof e.fontSize&&(i.fontSize=e.fontSize),"number"==typeof e.offsetX?i.left=e.offsetX+"px":e.offsetX&&"string"==typeof e.offsetX&&(i.left=e.offsetX),"number"==typeof e.offsetY?i.top=e.offsetY+"px":e.offsetY&&"string"==typeof e.offsetY&&(i.top=e.offsetY),!e.wmWidth&&!e.wmHeight||0===e.wmWidth||0===e.wmHeight?i.background="":"number"==typeof e.wmColor?i.background=a(e.wmColor):e.wmColor&&"string"==typeof e.wmColor&&(i.background=e.wmColor),e.wmWidth&&("number"==typeof e.wmWidth?i.width=e.wmWidth+"px":"string"==typeof e.wmWidth&&(i.width=e.wmWidth)),e.wmHeight&&("number"==typeof e.wmHeight?i.height=e.wmHeight+"px":"string"==typeof e.wmHeight&&(i.height=e.wmHeight));const r={type:"timestamp",content:"yyyy-mm-dd HH:MM:ss",loop:!1,loopIndex:0,elem:null,style:i};this.watermarks.push(r)}),this.div&&this.start(this.div)}start(e){this.clear(),this.div=e,this.watermarks.forEach(t=>{let i;switch(t.type){case"text":i=document.createElement("pre"),i.className="nim-watermark nim-watermark-text",i.innerText=t.content||"",Object.assign(i.style,t.style);break;case"timestamp":i=document.createElement("pre"),i.className="nim-watermark nim-watermark-timestamp",i.innerText="",Object.assign(i.style,t.style);break;case"image":!t.imageUrls&&t.content&&(t.imageUrls=[t.content]),i=document.createElement("div"),i.className="nim-watermark nim-watermark-image-container",t.imgElems=[],t.imageUrls&&t.imageUrls.length&&t.imageUrls.forEach((e,r)=>{const s=document.createElement("img");s.className="nim-watermark nim-watermark-image nim-watermark-image-"+r,s.src=e,s.style.width="100%",t.style.height&&(s.style.height="100%"),s.style.overflow="hidden",t.imgElems&&t.imgElems.push(s),i.appendChild(s),r>0&&(s.style.display="none")}),t.loopIndex=-1;const e=()=>{if(!t.interval&&t.imgElems&&t.loopIndex>=0)t.imgElems[t.loopIndex].style.display="";else{if(t.imgElems&&t.imgElems[t.loopIndex]&&(t.imgElems[t.loopIndex].style.display="none"),t.loopIndex++,t.imgElems&&t.loopIndex>=t.imgElems.length){if(!t.loop)return void(t.loopTimer&&clearInterval(t.loopTimer));t.loopIndex=0}t.imgElems&&(t.imgElems[t.loopIndex].style.display="")}};e(),t.interval&&(t.loopTimer=setInterval(e,t.interval)),Object.assign(i.style,t.style)}t.elem=i,e.appendChild(t.elem)})}clear(){this.div&&this.watermarks.forEach(e=>{e.elem&&(e.elem.remove(),e.elem=null),e.loopTimer&&clearTimeout(e.loopTimer)})}}t.WatermarkControl=d;const c=new class{constructor(){this.controls=[],this.timer=setInterval(()=>{this.updateTimestamps()},1e3)}updateTimestamps(){this.controls.forEach(e=>{e.watermarks.filter(e=>"timestamp"===e.type).forEach(e=>{e.elem&&(e.elem.innerText=o.default(new Date,e.content||"yyyy-mm-dd HH:MM:ss"))})})}};t.createWatermarkControl=function(e){const t=new d(e);return c.controls.push(t),t}},function(e,t,i){var r;!function(s){"use strict";var o,n,a,d=(o=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZWN]|'[^']*'|'[^']*'/g,n=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,a=/[^-+\dA-Z]/g,function(e,t,i,r){if(1!==arguments.length||"string"!==p(e)||/\d/.test(e)||(t=e,e=void 0),(e=e||new Date)instanceof Date||(e=new Date(e)),isNaN(e))throw TypeError("Invalid date");var s=(t=String(d.masks[t]||t||d.masks.default)).slice(0,4);"UTC:"!==s&&"GMT:"!==s||(t=t.slice(4),i=!0,"GMT:"===s&&(r=!0));var h=i?"getUTC":"get",f=e[h+"Date"](),m=e[h+"Day"](),g=e[h+"Month"](),v=e[h+"FullYear"](),y=e[h+"Hours"](),_=e[h+"Minutes"](),S=e[h+"Seconds"](),b=e[h+"Milliseconds"](),R=i?0:e.getTimezoneOffset(),w=l(e),T=u(e),A={d:f,dd:c(f),ddd:d.i18n.dayNames[m],dddd:d.i18n.dayNames[m+7],m:g+1,mm:c(g+1),mmm:d.i18n.monthNames[g],mmmm:d.i18n.monthNames[g+12],yy:String(v).slice(2),yyyy:v,h:y%12||12,hh:c(y%12||12),H:y,HH:c(y),M:_,MM:c(_),s:S,ss:c(S),l:c(b,3),L:c(Math.round(b/10)),t:y<12?"a":"p",tt:y<12?"am":"pm",T:y<12?"A":"P",TT:y<12?"AM":"PM",Z:r?"GMT":i?"UTC":(String(e).match(n)||[""]).pop().replace(a,""),o:(R>0?"-":"+")+c(100*Math.floor(Math.abs(R)/60)+Math.abs(R)%60,4),S:["th","st","nd","rd"][f%10>3?0:(f%100-f%10!=10)*f%10],W:w,N:T};return t.replace(o,(function(e){return e in A?A[e]:e.slice(1,e.length-1)}))});function c(e,t){for(e=String(e),t=t||2;e.length<t;)e="0"+e;return e}function l(e){var t=new Date(e.getFullYear(),e.getMonth(),e.getDate());t.setDate(t.getDate()-(t.getDay()+6)%7+3);var i=new Date(t.getFullYear(),0,4);i.setDate(i.getDate()-(i.getDay()+6)%7+3);var r=t.getTimezoneOffset()-i.getTimezoneOffset();t.setHours(t.getHours()-r);var s=(t-i)/6048e5;return 1+Math.floor(s)}function u(e){var t=e.getDay();return 0===t&&(t=7),t}function p(e){return null===e?"null":void 0===e?"undefined":"object"!=typeof e?typeof e:Array.isArray(e)?"array":{}.toString.call(e).slice(8,-1).toLowerCase()}d.masks={default:"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:sso",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'",expiresHeaderFormat:"ddd, dd mmm yyyy HH:MM:ss Z"},d.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]},void 0===(r=function(){return d}.call(t,i,t,e))||(e.exports=r)}()},function(e,t,i){var r,s;!function(o,n){"use strict";void 0===(s="function"==typeof(r=function(){var e=function(){},t="undefined"!=typeof window&&void 0!==window.navigator&&/Trident\/|MSIE /.test(window.navigator.userAgent),i=["trace","debug","info","warn","error"];function r(e,t){var i=e[t];if("function"==typeof i.bind)return i.bind(e);try{return Function.prototype.bind.call(i,e)}catch(t){return function(){return Function.prototype.apply.apply(i,[e,arguments])}}}function s(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function o(i){return"debug"===i&&(i="log"),"undefined"!=typeof console&&("trace"===i&&t?s:void 0!==console[i]?r(console,i):void 0!==console.log?r(console,"log"):e)}function n(t,r){for(var s=0;s<i.length;s++){var o=i[s];this[o]=s<t?e:this.methodFactory(o,t,r)}this.log=this.debug}function a(e,t,i){return function(){"undefined"!=typeof console&&(n.call(this,t,i),this[e].apply(this,arguments))}}function d(e,t,i){return o(e)||a.apply(this,arguments)}function c(e,t,r){var s,o=this,a="loglevel";function c(){var e;if("undefined"!=typeof window&&a){try{e=window.localStorage[a]}catch(e){}if(void 0===e)try{var t=window.document.cookie,i=t.indexOf(encodeURIComponent(a)+"=");-1!==i&&(e=/^([^;]+)/.exec(t.slice(i))[1])}catch(e){}return void 0===o.levels[e]&&(e=void 0),e}}"string"==typeof e?a+=":"+e:"symbol"==typeof e&&(a=void 0),o.name=e,o.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},o.methodFactory=r||d,o.getLevel=function(){return s},o.setLevel=function(t,r){if("string"==typeof t&&void 0!==o.levels[t.toUpperCase()]&&(t=o.levels[t.toUpperCase()]),!("number"==typeof t&&t>=0&&t<=o.levels.SILENT))throw"log.setLevel() called with invalid level: "+t;if(s=t,!1!==r&&function(e){var t=(i[e]||"silent").toUpperCase();if("undefined"!=typeof window&&a){try{return void(window.localStorage[a]=t)}catch(e){}try{window.document.cookie=encodeURIComponent(a)+"="+t+";"}catch(e){}}}(t),n.call(o,t,e),"undefined"==typeof console&&t<o.levels.SILENT)return"No console available for logging"},o.setDefaultLevel=function(e){c()||o.setLevel(e,!1)},o.enableAll=function(e){o.setLevel(o.levels.TRACE,e)},o.disableAll=function(e){o.setLevel(o.levels.SILENT,e)};var l=c();null==l&&(l=null==t?"WARN":t),o.setLevel(l,!1)}var l=new c,u={};l.getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=u[e];return t||(t=u[e]=new c(e,l.getLevel(),l.methodFactory)),t};var p="undefined"!=typeof window?window.log:void 0;return l.noConflict=function(){return"undefined"!=typeof window&&window.log===l&&(window.log=p),l},l.getLoggers=function(){return u},l.default=l,l})?r.call(t,i,t,e):r)||(e.exports=s)}()},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.logHelper=void 0;t.logHelper=class{constructor(e){if(e.maxLogsLines&&"number"==typeof e.maxLogsLines&&!isNaN(e.maxLogsLines)?this.maxLogsLines=e.maxLogsLines:this.maxLogsLines=5e3,e.logFilename&&(e.logFilename=e.logFilename+".txt"),this.useTimestamps=e.useTimestamps||!1,this.useLocalStorage=e.useLocalStorage||!1,this.autoTrim=!0,this.maxLines=e.maxLogsLines||5e3,this.tailNumLines=100,this.logFilename=e.logFilename||"nimWebRtcLog.txt",this.maxDepth=5,this.depth=0,this.parentSizes=[0],this.currentResult="",this.startTime=new Date,this.output="",this.useLocalStorage){var t=window.localStorage.getItem("nimWebRtcLog");if(t){var i=JSON.parse(t);this.output=i.log;var r=new Date(i.startTime),s=new Date(i.lastLog);this.output+="\n---- Session end: "+i.lastLog+" ----\n",this.output+=this.formatSessionDuration(r.getTime(),s.getTime()),this.output+="\n\n"}}this.output+="---- Session started: "+this.startTime+" ----\n\n"}getLog(){var e=new Date;if(this.useLocalStorage){var t=window.localStorage.getItem("nimWebRtcLog");if(t){var i=JSON.parse(t);this.startTime=new Date(i.startTime),this.output=i.log,e=new Date(i.lastLog)}}return this.output+"\n---- Log retrieved: "+e+" ----\n"+this.formatSessionDuration(this.startTime.getTime(),e.getTime())}tail(e){e=e||this.tailNumLines;return this.trimLog(this.getLog(),e)}search(e){for(var t=this.output.split("\n"),i=new RegExp(e),r=[],s=0;s<t.length;s++){var o="["+s+"] ";t[s].match(i)&&r.push(o+t[s])}var n=r.join("\n");return 0==n.length&&(n='Nothing found for "'+e+'".'),n}getSlice(e,t){return this.output.split("\n").slice(e,e+t).join("\n")}downloadLog(){var e=this.getLog(),t=new Blob([e],{type:"data:text/plain;charset=utf-8"}),i=document.createElement("a");i.href=window.URL.createObjectURL(t),i.target="_blank",i.download=this.logFilename,document.body.appendChild(i),i.click(),document.body.removeChild(i),window.URL.revokeObjectURL(i.href)}clear(){var e=new Date;if(this.output="---- Log cleared: "+e+" ----\n",this.useLocalStorage){var t={startTime:this.startTime,log:this.output,lastLog:e},i=JSON.stringify(t);window.localStorage.setItem("nimWebRtcLog",i)}}log(e){var t=this.determineType(e);if(null!=t){var i=this.formatType(t,e);if(this.useTimestamps){var r=new Date;this.output+=this.formatTimestamp(r)}if(this.output+=i+"\n",this.autoTrim&&(this.output=this.trimLog(this.output,this.maxLines)),this.useLocalStorage){var s=new Date,o={startTime:this.startTime,log:this.output,lastLog:s},n=JSON.stringify(o);window.localStorage.setItem("nimWebRtcLog",n)}}this.depth=0,this.parentSizes=[0],this.currentResult=""}determineType(e){if(null!=e){var t,i=typeof e;if("object"==i)t=null==e.length?"function"==typeof e.getTime?"Date":"function"==typeof e.test?"RegExp":"Object":"Array";else t=i;return t}return"null"}formatType(e,t){if(this.maxDepth&&this.depth>=this.maxDepth)return"... (max-depth reached)";switch(e){case"Object":this.currentResult+="{\n",this.depth++,this.parentSizes.push(this.objectSize(t));var i=0;for(var r in t){this.currentResult+=this.indentsForDepth(this.depth),this.currentResult+=r+": ";var s=this.determineType(t[r]);(o=this.formatType(s,t[r]))?("function"!==s&&(this.currentResult+=o),i!=this.parentSizes[this.depth]-1&&(this.currentResult+=","),this.currentResult+="\n"):(i!=this.parentSizes[this.depth]-1&&(this.currentResult+=","),this.currentResult+="\n"),i++}if(this.depth--,this.parentSizes.pop(),this.currentResult+=this.indentsForDepth(this.depth),this.currentResult+="}",0==this.depth)return this.currentResult;break;case"Array":this.currentResult+="[",this.depth++,this.parentSizes.push(t.length);for(i=0;i<t.length;i++){var o;"Object"!=(s=this.determineType(t[i]))&&"Array"!=s||(this.currentResult+="\n"+this.indentsForDepth(this.depth)),(o=this.formatType(s,t[i]))?(this.currentResult+=o,i!=this.parentSizes[this.depth]-1&&(this.currentResult+=", "),"Array"==s&&(this.currentResult+="\n")):(i!=this.parentSizes[this.depth]-1&&(this.currentResult+=", "),("Object"!=s||i==this.parentSizes[this.depth]-1)&&(this.currentResult+="\n"))}if(this.depth--,this.parentSizes.pop(),this.currentResult+="]",0==this.depth)return this.currentResult;break;case"function":var n=(t+="").split("\n");for(i=0;i<n.length;i++)n[i].match(/\}/)&&this.depth--,this.currentResult+=this.indentsForDepth(this.depth),n[i].match(/\{/)&&this.depth++,this.currentResult+=n[i]+"\n";return this.currentResult;case"RegExp":return"/"+t.source+"/";case"Date":case"string":return this.depth>0||0==t.length?'"'+t+'"':t;case"boolean":return t?"true":"false";case"number":return t+""}}indentsForDepth(e){for(var t="",i=0;i<e;i++)t+="\t";return t}trimLog(e,t){var i=e.split("\n");return i.length>t&&(i=i.slice(i.length-t)),i.join("\n")}lines(){return this.output.split("\n").length}formatSessionDuration(e,t){var i=t-e,r=Math.floor(i/1e3/60/60),s=("0"+r).slice(-2);i-=1e3*r*60*60;var o=Math.floor(i/1e3/60),n=("0"+o).slice(-2);i-=1e3*o*60;var a=Math.floor(i/1e3);return i-=1e3*a,"---- Session duration: "+s+":"+n+":"+("0"+a).slice(-2)+" ----"}formatTimestamp(e){var t=e.getFullYear(),i=e.getDate();return"["+t+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+i+" "+Number(e.getHours())+":"+("0"+e.getMinutes()).slice(-2)+":"+("0"+e.getSeconds()).slice(-2)+"]: "}objectSize(e){var t,i=0;for(t in e)e.hasOwnProperty&&e.hasOwnProperty(t)&&i++;return i}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.shimCanvas=t.canShimCanvas=void 0;const r=i(2),s=i(27);t.canShimCanvas=function(){let e=!1;if("never"===r.getParameters().shimCanvas)e=!1;else if("always"===r.getParameters().shimCanvas)e=!0;else if("ios151"===r.getParameters().shimCanvas)return!!(s.RtcSystem.ios()&&navigator.userAgent.indexOf(" OS 15_1")>-1);return e},t.shimCanvas=function(e){const t=document.createElement("canvas"),i=document.createElement("video");let r=e.getSettings().frameRate||15;const s=t.getContext("2d"),o=new MediaStream([e]);if(i.srcObject=o,i.setAttribute("playsinline","playsinline"),i.setAttribute("muted","muted"),i.setAttribute("autoplay","autoplay"),i.className="nertc-ios-shim",i.style.display="none",i.onresize=()=>{i.videoWidth&&i.videoHeight&&(t.width=i.videoWidth,t.height=i.videoHeight)},s){const o=t.captureStream(r).getVideoTracks()[0];Object.defineProperty(o,"enabled",{get:()=>e.enabled,set(t){console.warn("Delegate cameraTrack enabled",t),e.enabled=t}});const n=setInterval(()=>{i.paused?(console.log("play"),i.play()):"ended"===o.readyState?("live"===e.readyState&&(console.warn("canvasTrack已停止，回收videoTrack中"),e.stop()),clearInterval(n),document.body.removeChild(i)):s.drawImage(i,0,0)},1e3/r);return document.body.appendChild(i),o}throw new Error("Ctx not supported")}},function(e,t,i){"use strict";t.__esModule=!0,t.uint8ArrayToHex=t.uint8ArrayToString=t.stringToUint8Array=t.stringToByte=t.sm4_setkey_dec=t.sm4_setkey_enc=t.sm4_crypt_ecb=t.SM4Ctx=void 0;var r=function(){this.mode=1,this.sk=[],this.isPadding=!0};function s(e,t){return(255&e[t])<<24|(255&e[t+1])<<16|(255&e[t+2])<<8|255&e[t+3]}function o(e,t,i){t[i]=255&e>>24,t[i+1]=255&e>>16,t[i+2]=255&e>>8,t[i+3]=255&e}function n(e,t,i){return void 0===i&&(i=32),e<<(t%=i)|e>>>i-t}t.SM4Ctx=r;var a=[214,144,233,254,204,225,61,183,22,182,20,194,40,251,44,5,43,103,154,118,42,190,4,195,170,68,19,38,73,134,6,153,156,66,80,244,145,239,152,122,51,84,11,67,237,207,172,98,228,179,28,169,201,8,232,149,128,223,148,250,117,143,63,166,71,7,167,252,243,115,23,186,131,89,60,25,230,133,79,168,104,107,129,178,113,100,218,139,248,235,15,75,112,86,157,53,30,36,14,94,99,88,209,162,37,34,124,59,1,33,120,135,212,0,70,87,159,211,39,82,76,54,2,231,160,196,200,158,234,191,138,210,64,199,56,181,163,247,242,206,249,97,21,161,224,174,93,164,155,52,26,85,173,147,50,48,245,140,177,227,29,246,226,46,130,102,202,96,192,41,35,171,13,83,78,111,213,219,55,69,222,253,142,47,3,255,106,114,109,108,91,81,141,27,175,146,187,221,188,127,17,217,92,65,31,16,90,216,10,193,49,136,165,205,123,189,45,116,208,18,184,229,180,176,137,105,151,74,12,150,119,126,101,185,241,9,197,110,198,132,24,240,125,236,58,220,77,32,121,238,95,62,215,203,57,72],d=[462357,472066609,943670861,1415275113,1886879365,2358483617,2830087869,3301692121,3773296373,4228057617,404694573,876298825,1347903077,1819507329,2291111581,2762715833,3234320085,3705924337,4177462797,337322537,808926789,1280531041,1752135293,2223739545,2695343797,3166948049,3638552301,4110090761,269950501,741554753,1213159005,1684763257],c=[2746333894,1453994832,1736282519,2993693404];function l(e){return a[255&e]}function u(e,t,i,r,a){return e^(d=t^i^r^a,u=new Uint8Array(4),p=new Uint8Array(4),o(d,u,0),p[0]=l(u[0]),p[1]=l(u[1]),p[2]=l(u[2]),p[3]=l(u[3]),(c=s(p,0))^n(c,2)^n(c,10)^n(c,18)^n(c,24));var d,c,u,p}function p(e,t){var i,r,a,u,p=new Array(4),h=new Array(36),f=0;for(p[0]=s(t,0),p[1]=s(t,4),p[2]=s(t,8),p[3]=s(t,12),h[0]=p[0]^c[0],h[1]=p[1]^c[1],h[2]=p[2]^c[2],h[3]=p[3]^c[3];f<32;f++)h[f+4]=h[f]^(i=h[f+1]^h[f+2]^h[f+3]^d[f],r=void 0,a=void 0,u=void 0,a=new Uint8Array(4),u=new Uint8Array(4),o(i,a,0),u[0]=l(a[0]),u[1]=l(a[1]),u[2]=l(a[2]),u[3]=l(a[3]),(r=s(u,0))^n(r,13)^n(r,23)),e[f]=h[f+4]}function h(e,t,i){var r=0,n=new Array(36);for(n[0]=s(t,0),n[1]=s(t,4),n[2]=s(t,8),n[3]=s(t,12);r<32;)n[r+4]=u(n[r],n[r+1],n[r+2],n[r+3],e[r]),r++;o(n[35],i,0),o(n[34],i,4),o(n[33],i,8),o(n[32],i,12)}function f(e,t){var i;if(1==t){var r=16-e.length%16;(i=new Uint8Array(e.length+r)).set(e),i.fill(r,e.length)}else i=e.subarray(0,e.length-e[e.length-1]);return i}t.sm4_setkey_enc=function(e,t){e.mode=1,p(e.sk,t)},t.sm4_setkey_dec=function(e,t){null==e&&Error("ctx is null!"),null!=t&&16==t.length||Error("key error!"),e.mode=0,p(e.sk,t),e.sk=e.sk.reverse()},t.sm4_crypt_ecb=function(e,t,i){i||(i={}),i.shiftStart||(i.shiftStart=0),e.isPadding&&1==e.mode&&(t=f(t,1));var r,s,o=t.length;1==e.mode?(r=0,s=i.shiftStart):(r=i.shiftStart,s=0);for(var n=new Uint8Array(o+s-r),a=0;a<o-r;a+=16){var d=new Uint8Array(t.buffer,a+r,16),c=new Uint8Array(n.buffer,a+s,16);h(e.sk,d,c)}return e.isPadding&&0==e.mode&&(n=f(n,0)),n},t.stringToByte=function(e){var t,i,r=new Array;t=e.length;for(var s=0;s<t;s++)(i=e.charCodeAt(s))>=65536&&i<=1114111?(r.push(i>>18&7|240),r.push(i>>12&63|128),r.push(i>>6&63|128),r.push(63&i|128)):i>=2048&&i<=65535?(r.push(i>>12&15|224),r.push(i>>6&63|128),r.push(63&i|128)):i>=128&&i<=2047?(r.push(i>>6&31|192),r.push(63&i|128)):r.push(255&i);return r},t.stringToUint8Array=function(e){for(var t=new Uint8Array(e.length),i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t},t.uint8ArrayToString=function(e){for(var t="",i=0;i<e.length;i++)t+=String.fromCharCode(e[i]);return t},t.uint8ArrayToHex=function(e){for(var t="",i=0;i<e.length;i++)t+=e[i].toString(16).padStart(2,"0");return t}},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RTSTransport=void 0;const s=i(3),o=r(i(1)),n=r(i(0));class a extends s.EventEmitter{constructor(e){super(),this._reset(),this.adapterRef=e.adapterRef,this._url=e.url,this._port=e.port,this._transportId=e.transportId,this._ws=null,this.initSocket()}get transportId(){return this._transportId}_reset(){this._url="",this._port=0,this._ws=null}initSocket(){if(this.adapterRef.logger.log("RTSTransport建立连接, url: ",this._url),!this._url)throw new o.default({code:n.default.NOT_FOUND,message:"RTSTransport: No _url"});this._ws=new WebSocket(this._url,["protoo"]),this._ws.binaryType="arraybuffer";const e=this._ws;e.onopen=this._onOpen.bind(this),e.onmessage=this._onMessage.bind(this),e.onclose=this._onClose.bind(this),e.onerror=this._onError.bind(this)}_onOpen(e){this.adapterRef.logger.log("RTSTransport:_onOpen"),this.emit("open",e)}_onMessage(e){this.adapterRef.instance.emit("rts-stream-data",e)}_onClose(e){this.adapterRef.logger.log("RTSTransport:onClose <- ",e),this.emit("close",e)}_onError(e){this.adapterRef.logger.log("RTSTransport:onError <- ",e),this.emit("error",e)}send(e){this._ws&&this._ws.readyState===WebSocket.OPEN?this._ws.send(JSON.stringify(e)):this.adapterRef.logger.log("RTSTransport:send: 当前不能发送，等待ws连接成功之后发送")}_close(){this.adapterRef.logger.log("RTSTransport:close"),this._ws&&(this._ws.onclose=null,this._ws.onerror=null,this._ws.onopen=null,this._ws.onmessage=null,this._ws.close(),this._ws=null)}destroy(){this.adapterRef.logger.log("WSTransport:destroy"),this._close(),this._url=null}}t.RTSTransport=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseBase64=void 0;const r=i(154);let s;t.parseBase64=function(e){var t=e.length,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(!s){s=[];for(var o=0;o<i.length;o++)s[i.charCodeAt(o)]=o}var n=i.charAt(64);if(n){var a=e.indexOf(n);-1!==a&&(t=a)}return function(e,t,i){for(var s=[],o=0,n=0;n<t;n++)if(n%4){var a=i[e.charCodeAt(n-1)]<<n%4*2,d=i[e.charCodeAt(n)]>>>6-n%4*2,c=a|d;s[o>>>2]|=c<<24-o%4*8,o++}return new r.WordArray(s,o)}(e,t,s)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WordArray=t.Hex=void 0,t.Hex={stringify(e){for(var t=e.words,i=e.sigBytes,r=[],s=0;s<i;s++){var o=t[s>>>2]>>>24-s%4*8&255;r.push((o>>>4).toString(16)),r.push((15&o).toString(16))}return r.join("")}};t.WordArray=class{constructor(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length}toString(e){return(e||t.Hex).stringify(this)}concat(e){var t=this.words,i=e.words,r=this.sigBytes,s=e.sigBytes;if(this.clamp(),r%4)for(var o=0;o<s;o++){var n=i[o>>>2]>>>24-o%4*8&255;t[r+o>>>2]|=n<<24-(r+o)%4*8}else for(var a=0;a<s;a+=4)t[r+a>>>2]=i[a>>>2];return this.sigBytes+=s,this}clamp(){var e=this.words,t=this.sigBytes;e[t>>>2]&=4294967295<<32-t%4*8,e.length=Math.ceil(t/4)}}},function(e,t,i){"use strict";var r=i(156),s=i(201);t.Peer=r,t.WebSocketTransport=s},function(e,t,i){"use strict";var r=o(i(60)),s=o(i(61));function o(e){return e&&e.__esModule?e:{default:e}}var n=i(51),a=i(110),d=i(112),c=new n("Peer"),l=0;e.exports=class extends a{constructor(e){super(c),c.debug("constructor()"),this._closed=!1,this.id=l++,this._transport=e,this._connected=!1,this._data={createTs:Date.now()},this._sents=new Map,this._notificationId=0,this._handleTransport()}get closed(){return this._closed}get connected(){return this._connected}get data(){return this._data}set data(e){throw new Error("cannot override data object")}close(){if(!this._closed){c.debug("close()"),this._closed=!0,this._connected=!1,this._notificationId=0,this._transport.close(),this._transport=null;var e=!0,t=!1,i=void 0;try{for(var r,s=this._sents.values()[Symbol.iterator]();!(e=(r=s.next()).done);e=!0){r.value.close()}}catch(e){t=!0,i=e}finally{try{!e&&s.return&&s.return()}finally{if(t)throw i}}this._sents.clear()}}clear(){var e=!0,t=!1,i=void 0;try{for(var r,s=this._sents.values()[Symbol.iterator]();!(e=(r=s.next()).done);e=!0){r.value.close()}}catch(e){t=!0,i=e}finally{try{!e&&s.return&&s.return()}finally{if(t)throw i}}this._sents.clear()}request(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return(0,s.default)(r.default.mark((function s(){var o;return r.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return o=d.createRequest(e,i),"Heartbeat"!=e&&t._logger.debug("request() [method:%s, id:%s]",e,o.id),r.next=4,t._transport.send(o);case 4:return r.abrupt("return",new Promise((function(e,i){var r=15e3*(15+.1*t._sents.size),s={id:o.id,method:o.method,startTs:Date.now(),resolve:function(i){t._sents.delete(o.id)&&(t._closed||(clearTimeout(s.timer),e(i)))},reject:function(e){t._sents.delete(o.id)&&(clearTimeout(s.timer),i(e))},timer:setTimeout((function(){t._sents.delete(o.id)&&i(new Error("request timeout"))}),r),close:function(){clearTimeout(s.timer);var e=new Error;e.name="peer closed",s.method&&(e.message="向edge的 "+s.method+" 请求被取消：连接 #"+t.id+" 已被关闭。连接建立时间："+(t._data.openTs-t._data.createTs)+"ms, 请求时间："+(Date.now()-s.startTs)+"ms"),i(e)}};t._sents.set(o.id,s)})));case 5:case"end":return r.stop()}}),s,t)})))()}notify(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return(0,s.default)(r.default.mark((function s(){var o;return r.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return o=d.createNotification(e,i),t._logger.debug("notify() [method:%s]",e),r.next=4,t._transport.send(o);case 4:case"end":return r.stop()}}),s,t)})))()}_handleTransport(){var e=this;if(this._transport.closed)return this._closed=!0,void setTimeout((function(){e._closed||(e._connected=!1,e.safeEmit("close"))}));this._transport.on("open",(function(){e._closed||(c.debug('emit "open"'),e._connected=!0,e._data.openTs=Date.now(),e.safeEmit("open"))})),this._transport.on("disconnected",(function(){e._closed||(c.debug('emit "disconnected"'),e._connected=!1,e.safeEmit("disconnected"))})),this._transport.on("failed",(function(t){e._closed||(c.debug('emit "failed" [currentAttempt:%s]',t),e._connected=!1,e.safeEmit("failed",t))})),this._transport.on("close",(function(){e._closed||(e._closed=!0,c.debug('emit "close"'),e._connected=!1,e.safeEmit("close"))})),this._transport.on("message",(function(t){t.request?e._handleRequest(t):t.response?e._handleResponse(t):t.notification&&e._handleNotification(t)}))}_handleRequest(e){var t=this;try{this.emit("request",e,(function(i){var r=d.createSuccessResponse(e,i);t._transport.send(r).catch((function(){}))}),(function(i,r){i instanceof Error?(i=500,r=String(i)):"number"==typeof i&&r instanceof Error&&(r=String(r));var s=d.createErrorResponse(e,i,r);t._transport.send(s).catch((function(){}))}))}catch(t){var i=d.createErrorResponse(e,500,String(t));this._transport.send(i).catch((function(){}))}}_handleResponse(e){var t=this._sents.get(e.id);if(t)if(e.ok)t.resolve(e.data);else{var i=new Error(e.errorReason);i.code=e.errorCode,t.reject(i)}else c.error("received response does not match any sent request",e.id,e)}_handleNotification(e){if(this._handleNotification>e.id)c.warn("忽略重复的通知消息: ",JSON.stringify(e,null," "));else{this._notificationId=e.id;var t=d.createSuccessResponse(e,{});this._transport.send(t).catch((function(){})),this.safeEmit("notification",e)}}}},function(e,t,i){var r=function(){return this}()||Function("return this")(),s=r.regeneratorRuntime&&Object.getOwnPropertyNames(r).indexOf("regeneratorRuntime")>=0,o=s&&r.regeneratorRuntime;if(r.regeneratorRuntime=void 0,e.exports=i(158),s)r.regeneratorRuntime=o;else try{delete r.regeneratorRuntime}catch(e){r.regeneratorRuntime=void 0}},function(e,t){!function(t){"use strict";var i=Object.prototype,r=i.hasOwnProperty,s="function"==typeof Symbol?Symbol:{},o=s.iterator||"@@iterator",n=s.asyncIterator||"@@asyncIterator",a=s.toStringTag||"@@toStringTag",d="object"==typeof e,c=t.regeneratorRuntime;if(c)d&&(e.exports=c);else{(c=t.regeneratorRuntime=d?e.exports:{}).wrap=m;var l={},u={};u[o]=function(){return this};var p=Object.getPrototypeOf,h=p&&p(p(E([])));h&&h!==i&&r.call(h,o)&&(u=h);var f=_.prototype=v.prototype=Object.create(u);y.prototype=f.constructor=_,_.constructor=y,_[a]=y.displayName="GeneratorFunction",c.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},c.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,_):(e.__proto__=_,a in e||(e[a]="GeneratorFunction")),e.prototype=Object.create(f),e},c.awrap=function(e){return{__await:e}},S(b.prototype),b.prototype[n]=function(){return this},c.AsyncIterator=b,c.async=function(e,t,i,r){var s=new b(m(e,t,i,r));return c.isGeneratorFunction(t)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},S(f),f[a]="Generator",f[o]=function(){return this},f.toString=function(){return"[object Generator]"},c.keys=function(e){var t=[];for(var i in e)t.push(i);return t.reverse(),function i(){for(;t.length;){var r=t.pop();if(r in e)return i.value=r,i.done=!1,i}return i.done=!0,i}},c.values=E,A.prototype={constructor:A,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(T),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function i(i,r){return n.type="throw",n.arg=e,t.next=i,r&&(t.method="next",t.arg=void 0),!!r}for(var s=this.tryEntries.length-1;s>=0;--s){var o=this.tryEntries[s],n=o.completion;if("root"===o.tryLoc)return i("end");if(o.tryLoc<=this.prev){var a=r.call(o,"catchLoc"),d=r.call(o,"finallyLoc");if(a&&d){if(this.prev<o.catchLoc)return i(o.catchLoc,!0);if(this.prev<o.finallyLoc)return i(o.finallyLoc)}else if(a){if(this.prev<o.catchLoc)return i(o.catchLoc,!0)}else{if(!d)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return i(o.finallyLoc)}}}},abrupt:function(e,t){for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i];if(s.tryLoc<=this.prev&&r.call(s,"finallyLoc")&&this.prev<s.finallyLoc){var o=s;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var n=o?o.completion:{};return n.type=e,n.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(n)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),T(i),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var r=i.completion;if("throw"===r.type){var s=r.arg;T(i)}return s}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,i){return this.delegate={iterator:E(e),resultName:t,nextLoc:i},"next"===this.method&&(this.arg=void 0),l}}}function m(e,t,i,r){var s=t&&t.prototype instanceof v?t:v,o=Object.create(s.prototype),n=new A(r||[]);return o._invoke=function(e,t,i){var r="suspendedStart";return function(s,o){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===s)throw o;return I()}for(i.method=s,i.arg=o;;){var n=i.delegate;if(n){var a=R(n,i);if(a){if(a===l)continue;return a}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===r)throw r="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);r="executing";var d=g(e,t,i);if("normal"===d.type){if(r=i.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:i.done}}"throw"===d.type&&(r="completed",i.method="throw",i.arg=d.arg)}}}(e,i,n),o}function g(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}function v(){}function y(){}function _(){}function S(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)}}))}function b(e){var t;this._invoke=function(i,s){function o(){return new Promise((function(t,o){!function t(i,s,o,n){var a=g(e[i],e,s);if("throw"!==a.type){var d=a.arg,c=d.value;return c&&"object"==typeof c&&r.call(c,"__await")?Promise.resolve(c.__await).then((function(e){t("next",e,o,n)}),(function(e){t("throw",e,o,n)})):Promise.resolve(c).then((function(e){d.value=e,o(d)}),n)}n(a.arg)}(i,s,t,o)}))}return t=t?t.then(o,o):o()}}function R(e,t){var i=e.iterator[t.method];if(void 0===i){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,R(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var r=g(i,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,l;var s=r.arg;return s?s.done?(t[e.resultName]=s.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function w(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function T(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(w,this),this.reset(!0)}function E(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,s=function t(){for(;++i<e.length;)if(r.call(e,i))return t.value=e[i],t.done=!1,t;return t.value=void 0,t.done=!0,t};return s.next=s}}return{next:I}}function I(){return{value:void 0,done:!0}}}(function(){return this}()||Function("return this")())},function(e,t,i){e.exports={default:i(160),__esModule:!0}},function(e,t,i){i(92),i(93),i(102),i(171),i(183),i(184),e.exports=i(9).Promise},function(e,t,i){var r=i(62),s=i(63);e.exports=function(e){return function(t,i){var o,n,a=String(s(t)),d=r(i),c=a.length;return d<0||d>=c?e?"":void 0:(o=a.charCodeAt(d))<55296||o>56319||d+1===c||(n=a.charCodeAt(d+1))<56320||n>57343?e?a.charAt(d):o:e?a.slice(d,d+2):n-56320+(o-55296<<10)+65536}}},function(e,t,i){"use strict";var r=i(97),s=i(48),o=i(50),n={};i(15)(n,i(6)("iterator"),(function(){return this})),e.exports=function(e,t,i){e.prototype=r(n,{next:s(1,i)}),o(e,t+" Iterator")}},function(e,t,i){var r=i(16),s=i(12),o=i(66);e.exports=i(18)?Object.defineProperties:function(e,t){s(e);for(var i,n=o(t),a=n.length,d=0;a>d;)r.f(e,i=n[d++],t[i]);return e}},function(e,t,i){var r=i(35);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==r(e)?e.split(""):Object(e)}},function(e,t,i){var r=i(28),s=i(99),o=i(166);e.exports=function(e){return function(t,i,n){var a,d=r(t),c=s(d.length),l=o(n,c);if(e&&i!=i){for(;c>l;)if((a=d[l++])!=a)return!0}else for(;c>l;l++)if((e||l in d)&&d[l]===i)return e||l||0;return!e&&-1}}},function(e,t,i){var r=i(62),s=Math.max,o=Math.min;e.exports=function(e,t){return(e=r(e))<0?s(e+t,0):o(e,t)}},function(e,t,i){var r=i(19),s=i(101),o=i(67)("IE_PROTO"),n=Object.prototype;e.exports=Object.getPrototypeOf||function(e){return e=s(e),r(e,o)?e[o]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?n:null}},function(e,t,i){"use strict";var r=i(169),s=i(170),o=i(34),n=i(28);e.exports=i(94)(Array,"Array",(function(e,t){this._t=n(e),this._i=0,this._k=t}),(function(){var e=this._t,t=this._k,i=this._i++;return!e||i>=e.length?(this._t=void 0,s(1)):s(0,"keys"==t?i:"values"==t?e[i]:[i,e[i]])}),"values"),o.Arguments=o.Array,r("keys"),r("values"),r("entries")},function(e,t){e.exports=function(){}},function(e,t){e.exports=function(e,t){return{value:t,done:!!e}}},function(e,t,i){"use strict";var r,s,o,n,a=i(32),d=i(5),c=i(45),l=i(103),u=i(33),p=i(17),h=i(46),f=i(172),m=i(173),g=i(104),v=i(105).set,y=i(178)(),_=i(70),S=i(106),b=i(179),R=i(107),w=d.TypeError,T=d.process,A=T&&T.versions,E=A&&A.v8||"",I=d.Promise,O="process"==l(T),C=function(){},P=s=_.f,k=!!function(){try{var e=I.resolve(1),t=(e.constructor={})[i(6)("species")]=function(e){e(C,C)};return(O||"function"==typeof PromiseRejectionEvent)&&e.then(C)instanceof t&&0!==E.indexOf("6.6")&&-1===b.indexOf("Chrome/66")}catch(e){}}(),x=function(e){var t;return!(!p(e)||"function"!=typeof(t=e.then))&&t},D=function(e,t){if(!e._n){e._n=!0;var i=e._c;y((function(){for(var r=e._v,s=1==e._s,o=0,n=function(t){var i,o,n,a=s?t.ok:t.fail,d=t.resolve,c=t.reject,l=t.domain;try{a?(s||(2==e._h&&L(e),e._h=1),!0===a?i=r:(l&&l.enter(),i=a(r),l&&(l.exit(),n=!0)),i===t.promise?c(w("Promise-chain cycle")):(o=x(i))?o.call(i,d,c):d(i)):c(r)}catch(e){l&&!n&&l.exit(),c(e)}};i.length>o;)n(i[o++]);e._c=[],e._n=!1,t&&!e._h&&N(e)}))}},N=function(e){v.call(d,(function(){var t,i,r,s=e._v,o=M(e);if(o&&(t=S((function(){O?T.emit("unhandledRejection",s,e):(i=d.onunhandledrejection)?i({promise:e,reason:s}):(r=d.console)&&r.error&&r.error("Unhandled promise rejection",s)})),e._h=O||M(e)?2:1),e._a=void 0,o&&t.e)throw t.v}))},M=function(e){return 1!==e._h&&0===(e._a||e._c).length},L=function(e){v.call(d,(function(){var t;O?T.emit("rejectionHandled",e):(t=d.onrejectionhandled)&&t({promise:e,reason:e._v})}))},F=function(e){var t=this;t._d||(t._d=!0,(t=t._w||t)._v=e,t._s=2,t._a||(t._a=t._c.slice()),D(t,!0))},j=function(e){var t,i=this;if(!i._d){i._d=!0,i=i._w||i;try{if(i===e)throw w("Promise can't be resolved itself");(t=x(e))?y((function(){var r={_w:i,_d:!1};try{t.call(e,c(j,r,1),c(F,r,1))}catch(e){F.call(r,e)}})):(i._v=e,i._s=1,D(i,!1))}catch(e){F.call({_w:i,_d:!1},e)}}};k||(I=function(e){f(this,I,"Promise","_h"),h(e),r.call(this);try{e(c(j,this,1),c(F,this,1))}catch(e){F.call(this,e)}},(r=function(e){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1}).prototype=i(180)(I.prototype,{then:function(e,t){var i=P(g(this,I));return i.ok="function"!=typeof e||e,i.fail="function"==typeof t&&t,i.domain=O?T.domain:void 0,this._c.push(i),this._a&&this._a.push(i),this._s&&D(this,!1),i.promise},catch:function(e){return this.then(void 0,e)}}),o=function(){var e=new r;this.promise=e,this.resolve=c(j,e,1),this.reject=c(F,e,1)},_.f=P=function(e){return e===I||e===n?new o(e):s(e)}),u(u.G+u.W+u.F*!k,{Promise:I}),i(50)(I,"Promise"),i(181)("Promise"),n=i(9).Promise,u(u.S+u.F*!k,"Promise",{reject:function(e){var t=P(this);return(0,t.reject)(e),t.promise}}),u(u.S+u.F*(a||!k),"Promise",{resolve:function(e){return R(a&&this===n?I:this,e)}}),u(u.S+u.F*!(k&&i(182)((function(e){I.all(e).catch(C)}))),"Promise",{all:function(e){var t=this,i=P(t),r=i.resolve,s=i.reject,o=S((function(){var i=[],o=0,n=1;m(e,!1,(function(e){var a=o++,d=!1;i.push(void 0),n++,t.resolve(e).then((function(e){d||(d=!0,i[a]=e,--n||r(i))}),s)})),--n||r(i)}));return o.e&&s(o.v),i.promise},race:function(e){var t=this,i=P(t),r=i.reject,s=S((function(){m(e,!1,(function(e){t.resolve(e).then(i.resolve,r)}))}));return s.e&&r(s.v),i.promise}})},function(e,t){e.exports=function(e,t,i,r){if(!(e instanceof t)||void 0!==r&&r in e)throw TypeError(i+": incorrect invocation!");return e}},function(e,t,i){var r=i(45),s=i(174),o=i(175),n=i(12),a=i(99),d=i(176),c={},l={};(t=e.exports=function(e,t,i,u,p){var h,f,m,g,v=p?function(){return e}:d(e),y=r(i,u,t?2:1),_=0;if("function"!=typeof v)throw TypeError(e+" is not iterable!");if(o(v)){for(h=a(e.length);h>_;_++)if((g=t?y(n(f=e[_])[0],f[1]):y(e[_]))===c||g===l)return g}else for(m=v.call(e);!(f=m.next()).done;)if((g=s(m,y,f.value,t))===c||g===l)return g}).BREAK=c,t.RETURN=l},function(e,t,i){var r=i(12);e.exports=function(e,t,i,s){try{return s?t(r(i)[0],i[1]):t(i)}catch(t){var o=e.return;throw void 0!==o&&r(o.call(e)),t}}},function(e,t,i){var r=i(34),s=i(6)("iterator"),o=Array.prototype;e.exports=function(e){return void 0!==e&&(r.Array===e||o[s]===e)}},function(e,t,i){var r=i(103),s=i(6)("iterator"),o=i(34);e.exports=i(9).getIteratorMethod=function(e){if(null!=e)return e[s]||e["@@iterator"]||o[r(e)]}},function(e,t){e.exports=function(e,t,i){var r=void 0===i;switch(t.length){case 0:return r?e():e.call(i);case 1:return r?e(t[0]):e.call(i,t[0]);case 2:return r?e(t[0],t[1]):e.call(i,t[0],t[1]);case 3:return r?e(t[0],t[1],t[2]):e.call(i,t[0],t[1],t[2]);case 4:return r?e(t[0],t[1],t[2],t[3]):e.call(i,t[0],t[1],t[2],t[3])}return e.apply(i,t)}},function(e,t,i){var r=i(5),s=i(105).set,o=r.MutationObserver||r.WebKitMutationObserver,n=r.process,a=r.Promise,d="process"==i(35)(n);e.exports=function(){var e,t,i,c=function(){var r,s;for(d&&(r=n.domain)&&r.exit();e;){s=e.fn,e=e.next;try{s()}catch(r){throw e?i():t=void 0,r}}t=void 0,r&&r.enter()};if(d)i=function(){n.nextTick(c)};else if(!o||r.navigator&&r.navigator.standalone)if(a&&a.resolve){var l=a.resolve(void 0);i=function(){l.then(c)}}else i=function(){s.call(r,c)};else{var u=!0,p=document.createTextNode("");new o(c).observe(p,{characterData:!0}),i=function(){p.data=u=!u}}return function(r){var s={fn:r,next:void 0};t&&(t.next=s),e||(e=s,i()),t=s}}},function(e,t,i){var r=i(5).navigator;e.exports=r&&r.userAgent||""},function(e,t,i){var r=i(15);e.exports=function(e,t,i){for(var s in t)i&&e[s]?e[s]=t[s]:r(e,s,t[s]);return e}},function(e,t,i){"use strict";var r=i(5),s=i(9),o=i(16),n=i(18),a=i(6)("species");e.exports=function(e){var t="function"==typeof s[e]?s[e]:r[e];n&&t&&!t[a]&&o.f(t,a,{configurable:!0,get:function(){return this}})}},function(e,t,i){var r=i(6)("iterator"),s=!1;try{var o=[7][r]();o.return=function(){s=!0},Array.from(o,(function(){throw 2}))}catch(e){}e.exports=function(e,t){if(!t&&!s)return!1;var i=!1;try{var o=[7],n=o[r]();n.next=function(){return{done:i=!0}},o[r]=function(){return n},e(o)}catch(e){}return i}},function(e,t,i){"use strict";var r=i(33),s=i(9),o=i(5),n=i(104),a=i(107);r(r.P+r.R,"Promise",{finally:function(e){var t=n(this,s.Promise||o.Promise),i="function"==typeof e;return this.then(i?function(i){return a(t,e()).then((function(){return i}))}:e,i?function(i){return a(t,e()).then((function(){throw i}))}:e)}})},function(e,t,i){"use strict";var r=i(33),s=i(70),o=i(106);r(r.S,"Promise",{try:function(e){var t=s.f(this),i=o(e);return(i.e?t.reject:t.resolve)(i.v),t.promise}})},function(e,t,i){e.exports=function(e){function t(e){let i,s=null;function o(...e){if(!o.enabled)return;const r=o,s=Number(new Date),n=s-(i||s);r.diff=n,r.prev=i,r.curr=s,i=s,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let a=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(i,s)=>{if("%%"===i)return"%";a++;const o=t.formatters[s];if("function"==typeof o){const t=e[a];i=o.call(r,t),e.splice(a,1),a--}return i}),t.formatArgs.call(r,e);(r.log||t.log).apply(r,e)}return o.namespace=e,o.useColors=t.useColors(),o.color=t.selectColor(e),o.extend=r,o.destroy=t.destroy,Object.defineProperty(o,"enabled",{enumerable:!0,configurable:!1,get:()=>null===s?t.enabled(e):s,set:e=>{s=e}}),"function"==typeof t.init&&t.init(o),o}function r(e,i){const r=t(this.namespace+(void 0===i?":":i)+e);return r.log=this.log,r}function s(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},t.disable=function(){const e=[...t.names.map(s),...t.skips.map(s).map(e=>"-"+e)].join(",");return t.enable(""),e},t.enable=function(e){let i;t.save(e),t.names=[],t.skips=[];const r=("string"==typeof e?e:"").split(/[\s,]+/),s=r.length;for(i=0;i<s;i++)r[i]&&("-"===(e=r[i].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let i,r;for(i=0,r=t.skips.length;i<r;i++)if(t.skips[i].test(e))return!1;for(i=0,r=t.names.length;i<r;i++)if(t.names[i].test(e))return!0;return!1},t.humanize=i(186),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach(i=>{t[i]=e[i]}),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let i=0;for(let t=0;t<e.length;t++)i=(i<<5)-i+e.charCodeAt(t),i|=0;return t.colors[Math.abs(i)%t.colors.length]},t.enable(t.load()),t}},function(e,t){var i=1e3,r=6e4,s=60*r,o=24*s;function n(e,t,i,r){var s=t>=1.5*i;return Math.round(e/i)+" "+r+(s?"s":"")}e.exports=function(e,t){t=t||{};var a=typeof e;if("string"===a&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!t)return;var n=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*n;case"weeks":case"week":case"w":return 6048e5*n;case"days":case"day":case"d":return n*o;case"hours":case"hour":case"hrs":case"hr":case"h":return n*s;case"minutes":case"minute":case"mins":case"min":case"m":return n*r;case"seconds":case"second":case"secs":case"sec":case"s":return n*i;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return}}(e);if("number"===a&&isFinite(e))return t.long?function(e){var t=Math.abs(e);if(t>=o)return n(e,t,o,"day");if(t>=s)return n(e,t,s,"hour");if(t>=r)return n(e,t,r,"minute");if(t>=i)return n(e,t,i,"second");return e+" ms"}(e):function(e){var t=Math.abs(e);if(t>=o)return Math.round(e/o)+"d";if(t>=s)return Math.round(e/s)+"h";if(t>=r)return Math.round(e/r)+"m";if(t>=i)return Math.round(e/i)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},function(e,t,i){"use strict";t.__esModule=!0;var r=n(i(188)),s=n(i(190)),o="function"==typeof s.default&&"symbol"==typeof r.default?function(e){return typeof e}:function(e){return e&&"function"==typeof s.default&&e.constructor===s.default&&e!==s.default.prototype?"symbol":typeof e};function n(e){return e&&e.__esModule?e:{default:e}}t.default="function"==typeof s.default&&"symbol"===o(r.default)?function(e){return void 0===e?"undefined":o(e)}:function(e){return e&&"function"==typeof s.default&&e.constructor===s.default&&e!==s.default.prototype?"symbol":void 0===e?"undefined":o(e)}},function(e,t,i){e.exports={default:i(189),__esModule:!0}},function(e,t,i){i(93),i(102),e.exports=i(71).f("iterator")},function(e,t,i){e.exports={default:i(191),__esModule:!0}},function(e,t,i){i(192),i(92),i(198),i(199),e.exports=i(9).Symbol},function(e,t,i){"use strict";var r=i(5),s=i(19),o=i(18),n=i(33),a=i(96),d=i(193).KEY,c=i(47),l=i(68),u=i(50),p=i(49),h=i(6),f=i(71),m=i(72),g=i(194),v=i(195),y=i(12),_=i(17),S=i(101),b=i(28),R=i(65),w=i(48),T=i(97),A=i(196),E=i(197),I=i(113),O=i(16),C=i(66),P=E.f,k=O.f,x=A.f,D=r.Symbol,N=r.JSON,M=N&&N.stringify,L=h("_hidden"),F=h("toPrimitive"),j={}.propertyIsEnumerable,V=l("symbol-registry"),U=l("symbols"),B=l("op-symbols"),$=Object.prototype,H="function"==typeof D&&!!I.f,W=r.QObject,q=!W||!W.prototype||!W.prototype.findChild,G=o&&c((function(){return 7!=T(k({},"a",{get:function(){return k(this,"a",{value:7}).a}})).a}))?function(e,t,i){var r=P($,t);r&&delete $[t],k(e,t,i),r&&e!==$&&k($,t,r)}:k,J=function(e){var t=U[e]=T(D.prototype);return t._k=e,t},z=H&&"symbol"==typeof D.iterator?function(e){return"symbol"==typeof e}:function(e){return e instanceof D},Q=function(e,t,i){return e===$&&Q(B,t,i),y(e),t=R(t,!0),y(i),s(U,t)?(i.enumerable?(s(e,L)&&e[L][t]&&(e[L][t]=!1),i=T(i,{enumerable:w(0,!1)})):(s(e,L)||k(e,L,w(1,{})),e[L][t]=!0),G(e,t,i)):k(e,t,i)},Y=function(e,t){y(e);for(var i,r=g(t=b(t)),s=0,o=r.length;o>s;)Q(e,i=r[s++],t[i]);return e},K=function(e){var t=j.call(this,e=R(e,!0));return!(this===$&&s(U,e)&&!s(B,e))&&(!(t||!s(this,e)||!s(U,e)||s(this,L)&&this[L][e])||t)},X=function(e,t){if(e=b(e),t=R(t,!0),e!==$||!s(U,t)||s(B,t)){var i=P(e,t);return!i||!s(U,t)||s(e,L)&&e[L][t]||(i.enumerable=!0),i}},Z=function(e){for(var t,i=x(b(e)),r=[],o=0;i.length>o;)s(U,t=i[o++])||t==L||t==d||r.push(t);return r},ee=function(e){for(var t,i=e===$,r=x(i?B:b(e)),o=[],n=0;r.length>n;)!s(U,t=r[n++])||i&&!s($,t)||o.push(U[t]);return o};H||(a((D=function(){if(this instanceof D)throw TypeError("Symbol is not a constructor!");var e=p(arguments.length>0?arguments[0]:void 0),t=function(i){this===$&&t.call(B,i),s(this,L)&&s(this[L],e)&&(this[L][e]=!1),G(this,e,w(1,i))};return o&&q&&G($,e,{configurable:!0,set:t}),J(e)}).prototype,"toString",(function(){return this._k})),E.f=X,O.f=Q,i(114).f=A.f=Z,i(73).f=K,I.f=ee,o&&!i(32)&&a($,"propertyIsEnumerable",K,!0),f.f=function(e){return J(h(e))}),n(n.G+n.W+n.F*!H,{Symbol:D});for(var te="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),ie=0;te.length>ie;)h(te[ie++]);for(var re=C(h.store),se=0;re.length>se;)m(re[se++]);n(n.S+n.F*!H,"Symbol",{for:function(e){return s(V,e+="")?V[e]:V[e]=D(e)},keyFor:function(e){if(!z(e))throw TypeError(e+" is not a symbol!");for(var t in V)if(V[t]===e)return t},useSetter:function(){q=!0},useSimple:function(){q=!1}}),n(n.S+n.F*!H,"Object",{create:function(e,t){return void 0===t?T(e):Y(T(e),t)},defineProperty:Q,defineProperties:Y,getOwnPropertyDescriptor:X,getOwnPropertyNames:Z,getOwnPropertySymbols:ee});var oe=c((function(){I.f(1)}));n(n.S+n.F*oe,"Object",{getOwnPropertySymbols:function(e){return I.f(S(e))}}),N&&n(n.S+n.F*(!H||c((function(){var e=D();return"[null]"!=M([e])||"{}"!=M({a:e})||"{}"!=M(Object(e))}))),"JSON",{stringify:function(e){for(var t,i,r=[e],s=1;arguments.length>s;)r.push(arguments[s++]);if(i=t=r[1],(_(t)||void 0!==e)&&!z(e))return v(t)||(t=function(e,t){if("function"==typeof i&&(t=i.call(this,e,t)),!z(t))return t}),r[1]=t,M.apply(N,r)}}),D.prototype[F]||i(15)(D.prototype,F,D.prototype.valueOf),u(D,"Symbol"),u(Math,"Math",!0),u(r.JSON,"JSON",!0)},function(e,t,i){var r=i(49)("meta"),s=i(17),o=i(19),n=i(16).f,a=0,d=Object.isExtensible||function(){return!0},c=!i(47)((function(){return d(Object.preventExtensions({}))})),l=function(e){n(e,r,{value:{i:"O"+ ++a,w:{}}})},u=e.exports={KEY:r,NEED:!1,fastKey:function(e,t){if(!s(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!o(e,r)){if(!d(e))return"F";if(!t)return"E";l(e)}return e[r].i},getWeak:function(e,t){if(!o(e,r)){if(!d(e))return!0;if(!t)return!1;l(e)}return e[r].w},onFreeze:function(e){return c&&u.NEED&&d(e)&&!o(e,r)&&l(e),e}}},function(e,t,i){var r=i(66),s=i(113),o=i(73);e.exports=function(e){var t=r(e),i=s.f;if(i)for(var n,a=i(e),d=o.f,c=0;a.length>c;)d.call(e,n=a[c++])&&t.push(n);return t}},function(e,t,i){var r=i(35);e.exports=Array.isArray||function(e){return"Array"==r(e)}},function(e,t,i){var r=i(28),s=i(114).f,o={}.toString,n="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];e.exports.f=function(e){return n&&"[object Window]"==o.call(e)?function(e){try{return s(e)}catch(e){return n.slice()}}(e):s(r(e))}},function(e,t,i){var r=i(73),s=i(48),o=i(28),n=i(65),a=i(19),d=i(95),c=Object.getOwnPropertyDescriptor;t.f=i(18)?c:function(e,t){if(e=o(e),t=n(t,!0),d)try{return c(e,t)}catch(e){}if(a(e,t))return s(!r.f.call(e,t),e[t])}},function(e,t,i){i(72)("asyncIterator")},function(e,t,i){i(72)("observable")},function(e,t,i){"use strict";t.generateRandomNumber=function(){return Math.round(1e7*Math.random())}},function(e,t,i){"use strict";var r=o(i(60)),s=o(i(61));function o(e){return e&&e.__esModule?e:{default:e}}var n=i(202),a=i(51),d=i(110),c=i(112),l=i(54),u={retries:10,factor:2,minTimeout:1e3,maxTimeout:8e3},p=new a("WebSocketTransport"),h=0;e.exports=class extends d{constructor(e,t){super(p),p.debug("constructor() [url:%s, options:%o]",e,t),this._closed=!1,this._url=e,this._options=t||{},this._ws=null,this.wsid=0,this.skipReconnection=!1,this._runWebSocket()}get closed(){return this._closed}close(){if(!this._closed){p.debug("close()"),this._closed=!0,this.safeEmit("close");try{this._ws.onopen=null,this._ws.onclose=null,this._ws.onerror=null,this._ws.onmessage=null,this._ws.close()}catch(e){p.error("close() | error closing the WebSocket: %o",e)}}}send(e){var t=this;return(0,s.default)(r.default.mark((function i(){return r.default.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(!t._closed){i.next=2;break}throw new Error("transport closed");case 2:i.prev=2,t._ws.send(l.stringify(e)),i.next=10;break;case 6:throw i.prev=6,i.t0=i.catch(2),p.warn("send() failed:",i.t0.name,i.t0.message),i.t0;case 10:case"end":return i.stop()}}),i,t,[[2,6]])})))()}_runWebSocket(){var e=this,t=n.operation(this._options.retry||u),i=!1;t.attempt((function(r){e._closed?t.stop():(p.debug("_runWebSocket() [currentAttempt:%s]",r),e._ws=new WebSocket(e._url,["protoo"]),h++,e.wsid=h,e._ws.onopen=function(){e._closed||(i=!0,e.safeEmit("open"))},e._ws.onclose=function(s){if(!e._closed)if(p.warn('WebSocket "close" event [wasClean:%s, code:%s, reason:"%s"]',s.wasClean,s.code,s.reason),i){if(t.stop(),e.safeEmit("disconnected"),e._closed||e.skipReconnection)return;e._runWebSocket()}else e.safeEmit("failed",r),e._closed||t.retry(!0)||(e._closed=!0,e.safeEmit("close"))},e._ws.onerror=function(){e._closed||p.error('WebSocket "error" event')},e._ws.onmessage=function(t){if(!e._closed){var i=c.parse(t.data);i&&(0!==e.listenerCount("message")?e.safeEmit("message",i):p.error('no listeners for WebSocket "message" event, ignoring received message'))}})}))}}},function(e,t,i){e.exports=i(203)},function(e,t,i){var r=i(204);t.operation=function(e){var i=t.timeouts(e);return new r(i,{forever:e&&e.forever,unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var i in e)t[i]=e[i];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],s=0;s<t.retries;s++)r.push(this.createTimeout(s,t));return e&&e.forever&&!r.length&&r.push(this.createTimeout(s,t)),r.sort((function(e,t){return e-t})),r},t.createTimeout=function(e,t){var i=t.randomize?Math.random()+1:1,r=Math.round(i*t.minTimeout*Math.pow(t.factor,e));return r=Math.min(r,t.maxTimeout)},t.wrap=function(e,i,r){if(i instanceof Array&&(r=i,i=null),!r)for(var s in r=[],e)"function"==typeof e[s]&&r.push(s);for(var o=0;o<r.length;o++){var n=r[o],a=e[n];e[n]=function(r){var s=t.operation(i),o=Array.prototype.slice.call(arguments,1),n=o.pop();o.push((function(e){s.retry(e)||(e&&(arguments[0]=s.mainError()),n.apply(this,arguments))})),s.attempt((function(){r.apply(e,o)}))}.bind(e,a),e[n].options=i}}},function(e,t){function i(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=i,i.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts},i.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timeouts=[],this._cachedTimeouts=null},i.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var i=this._timeouts.shift();if(void 0===i){if(!this._cachedTimeouts)return!1;this._errors.splice(this._errors.length-1,this._errors.length),this._timeouts=this._cachedTimeouts.slice(0),i=this._timeouts.shift()}var r=this,s=setTimeout((function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout((function(){r._operationTimeoutCb(r._attempts)}),r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)}),i);return this._options.unref&&s.unref(),!0},i.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var i=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){i._operationTimeoutCb()}),i._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},i.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},i.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},i.prototype.start=i.prototype.try,i.prototype.errors=function(){return this._errors},i.prototype.attempts=function(){return this._attempts},i.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,i=0,r=0;r<this._errors.length;r++){var s=this._errors[r],o=s.message,n=(e[o]||0)+1;e[o]=n,n>=i&&(t=s,i=n)}return t}},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Mediasoup=void 0;const a=i(3),d=o(i(115)),c=i(219),l=n(i(11)),u=n(i(1)),p=n(i(0)),h=i(2),f=i(27);class m extends a.EventEmitter{constructor(e){super(),this._consumers={},this._timeout=3e4,this._edgeRtpCapabilities=null,this._mediasoupDevice=null,this._sendTransportIceParameters=null,this._recvTransportIceParameters=null,this._micProducer=null,this._micProducerId=null,this._webcamProducer=null,this._webcamProducerId=null,this._screenProducer=null,this._screenProducerId=null,this._webcamProducerCodec=null,this._screenProducerCodec=null,this._sendTransport=null,this._recvTransport=null,this._sendTransportTimeoutTimer=null,this._recvTransportTimeoutTimer=null,this._eventQueue=[],this._protoo=null,this.senderEncodingParameter={ssrcList:[],audio:{high:null,low:null},video:{high:null,low:null},screen:{high:null,low:null}},this.unsupportedProducers={},this.adapterRef=e.adapterRef,this.logger=e.logger,this.loggerSend=e.logger.getChild(()=>{var e;let t="MediaSend";if(this._sendTransport)if(null===(e=this._sendTransport._handler)||void 0===e?void 0:e._pc){const e=this._sendTransport._handler._pc;e.connectionState&&"connected"!==e.connectionState&&(t+=" "+e.connectionState),"stable"!==e.signalingState&&(t+=" "+e.signalingState)}else t+=" NOTRANSPORT";else t+=" UNINIT";return this.adapterRef._mediasoup!==this&&(t+=" DETACHED"),t}),this.loggerRecv=e.logger.getChild(()=>{var e;let t="MediaRecv";if(this._recvTransport)if(null===(e=this._recvTransport._handler)||void 0===e?void 0:e._pc){const e=this._recvTransport._handler._pc;e.connectionState&&"connected"!==e.connectionState&&(t+=" "+e.connectionState),"stable"!==e.signalingState&&(t+=" "+e.signalingState)}else t+=" NOTRANSPORT";else t+=" UNINIT";return this.adapterRef._mediasoup!==this&&(t+=" DETACHED"),t}),this._reset()}get consumers(){return this._consumers}_reset(){this._timeout=3e4,this._edgeRtpCapabilities=null,this._mediasoupDevice=null,this._sendTransportIceParameters=null,this._recvTransportIceParameters=null,this._micProducer=null,this._micProducerId=null,this._webcamProducer=null,this._webcamProducerId=null,this._screenProducer=null,this._screenProducerId=null,this._consumers={},this._sendTransportTimeoutTimer&&clearTimeout(this._sendTransportTimeoutTimer),this._sendTransportTimeoutTimer=null,this._recvTransportTimeoutTimer&&clearTimeout(this._recvTransportTimeoutTimer),this._recvTransportTimeoutTimer=null,this._sendTransport&&this._sendTransport.close(),this._sendTransport=null,this._recvTransport&&this._recvTransport.close(),this._recvTransport=null,this.resetConsumeRequestStatus()}async init(){if(this.logger.log("初始化 devices、transport"),this.adapterRef._enableRts)return;this._mediasoupDevice||(this._mediasoupDevice=new d.Device,this._mediasoupDevice&&await this._mediasoupDevice.load({routerRtpCapabilities:this._edgeRtpCapabilities}));let e=[],t="all";if(this.adapterRef.channelInfo.relaytoken&&this.adapterRef.channelInfo.relayaddrs&&(this.adapterRef.channelInfo.relayaddrs.forEach(t=>{e.push({urls:"turn:"+t,credential:this.adapterRef.proxyServer.credential||this.adapterRef.channelInfo.uid+"/"+this.adapterRef.channelInfo.cid,username:this.adapterRef.channelInfo.relaytoken})}),"firefox"!==f.RtcSystem.browser.ua&&(t="relay")),this.adapterRef.testConf.turnAddr&&(e.length=0,e.push({urls:this.adapterRef.testConf.turnAddr,credential:this.adapterRef.channelInfo.uid+"/"+this.adapterRef.channelInfo.cid,username:this.adapterRef.testConf.relaytoken||"123456"}),t="relay"),!this._sendTransport&&this._mediasoupDevice&&(this._sendTransport=this._mediasoupDevice.createSendTransport({id:this.adapterRef.channelInfo.uid,iceParameters:void 0,iceCandidates:void 0,dtlsParameters:void 0,sctpParameters:void 0,iceServers:e,iceTransportPolicy:t,proprietaryConstraints:{optional:[{googDscp:!0},{googIPv6:!1}]},appData:{cid:this.adapterRef.channelInfo.cid,uid:this.adapterRef.channelInfo.uid,encodedInsertableStreams:this.adapterRef.encryption.encodedInsertableStreams}}),this.senderEncodingParameter={ssrcList:[],audio:{high:null,low:null},video:{high:null,low:null},screen:{high:null,low:null}},this._sendTransport.on("connectionstatechange",this._sendTransportConnectionstatechange.bind(this,this._sendTransport))),!this._recvTransport){const i=this._mediasoupDevice.createRecvTransport({id:this.adapterRef.channelInfo.uid,iceParameters:void 0,iceCandidates:void 0,dtlsParameters:void 0,sctpParameters:void 0,iceServers:e,iceTransportPolicy:t,proprietaryConstraints:{optional:[{googDscp:!0}]},appData:{cid:this.adapterRef.channelInfo.cid,uid:this.adapterRef.channelInfo.uid,encodedInsertableStreams:this.adapterRef.encryption.encodedInsertableStreams}});this._recvTransport=i,i.on("connectionstatechange",this._recvTransportConnectionstatechange.bind(this,i))}this.emit("transportReady")}async _sendTransportConnectionstatechange(e,t){if(this._sendTransport===e)if(this.loggerSend.log("send connection state changed to "+t),this.emit("upstream-state-change",{connectionState:t}),"failed"===t)try{if(this._sendTransport){this._sendTransportTimeoutTimer||(this._sendTransportTimeoutTimer=setTimeout(()=>{this._sendTransportConnectTimeout()},this._timeout));let e=null;if(this._protoo&&this._protoo.connected){if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw new u.default({code:p.default.NOT_FOUND,message:"No _protoo 1"});e=await this.adapterRef._signalling._protoo.request("restartIce",{transportId:this._sendTransport.id})}else e=this._sendTransportIceParameters;await this._sendTransport.restartIce({iceParameters:e})}}catch(e){this.loggerSend.error("restartIce() | failed:",e,name,e.message)}else"connected"===t&&this._sendTransportTimeoutTimer&&(clearTimeout(this._sendTransportTimeoutTimer),this._sendTransportTimeoutTimer=null);else this.loggerSend.error("_sendTransportConnectionstatechange：出现了_sendTransport绑定不一致的状况。")}async _recvTransportConnectionstatechange(e,t){if(this._recvTransport===e)if(this.loggerRecv.log("recv connection state changed to "+t),this.emit("downstream-state-change",{connectionState:t}),"failed"===t)try{if(this._recvTransport){this._recvTransportTimeoutTimer||(this._recvTransportTimeoutTimer=setTimeout(()=>{this._recvTransportConnectTimeout()},this._timeout));let e=null;e=this._protoo&&this._protoo.connected?await this._protoo.request("restartIce",{transportId:this._recvTransport.id}):this._recvTransportIceParameters,await this._recvTransport.restartIce({iceParameters:e})}}catch(e){this.loggerRecv.error("restartIce() | failed:",e.name,e.message)}else"connected"===t&&this._recvTransportTimeoutTimer&&(clearTimeout(this._recvTransportTimeoutTimer),this._recvTransportTimeoutTimer=null);else this.loggerRecv.error("_recvTransportConnectionstatechange：出现了_recvTransport绑定不一致的状况。")}async _sendTransportConnectTimeout(){this.loggerSend.warn("媒体上行传输通道连接失败"),this.adapterRef._signalling&&("CONNECTED"===this.adapterRef.connectState.curState?(this.loggerSend.error("媒体上行传输通道连接失败，尝试整体重连"),this.adapterRef.channelStatus="connectioning",this.adapterRef._signalling._reconnection()):(this.loggerSend.error("媒体上行传输通道建立失败，抛错错误"),this.adapterRef.instance.emit("error","SOCKET_ERROR")))}async _recvTransportConnectTimeout(){this.loggerRecv.warn("媒体下行传输通道建立失败"),this.adapterRef._signalling&&("CONNECTED"===this.adapterRef.connectState.curState?(this.loggerRecv.error("媒体下行传输通道连接失败，尝试整体重连"),this.adapterRef.channelStatus="connectioning",this.adapterRef._signalling._reconnection()):(this.loggerRecv.error("媒体下行传输通道建立失败，抛错错误"),this.adapterRef.instance.emit("error","SOCKET_ERROR")))}async createProduce(e,t){var i,r;if(this.loggerSend.log("发布音视频: ",e.getId(),t),!this._sendTransport)throw new u.default({code:p.default.NOT_FOUND,message:"No send trasnport 1"});if(0===this._sendTransport.listenerCount("produce")&&this._sendTransport.on("produce",async({kind:e,rtpParameters:t,appData:i,localDtlsParameters:r,offer:s},o,n)=>{if(this.loggerSend.log(`produce 反馈 [kind= ${e}, appData= ${JSON.stringify(i)}]`),!this._sendTransport)throw new u.default({code:p.default.NOT_FOUND,message:"No send trasnport 2"});const a="screenShare"==i.mediaType?"screen":i.mediaType;let d=!1;("video"===a&&this.adapterRef.channelInfo.videoLow||"screen"===a&&this.adapterRef.channelInfo.screenLow)&&(d=!0);const c=s.sdp.match(/a=ice-ufrag:([0-9a-zA-Z#=+-_\/\\\\]+)/);try{let n=Object.assign({requestId:""+Math.ceil(1e9*Math.random()),kind:e,rtpParameters:t,iceUfrag:c.length?c[1]:`${this.adapterRef.channelInfo.cid}#${this.adapterRef.channelInfo.uid}#send`,externData:{producerInfo:{mediaType:i.mediaType,subStream:"screenShare"===i.mediaType,simulcastEnable:d,spatialLayerCount:d?2:1,mute:!1}}},i),l=this.senderEncodingParameter[a].high,f=this.senderEncodingParameter[a].low,m=s.sdp.indexOf(i.deviceId),g=s.sdp.indexOf(i.deviceIdLow);if(!l){if(t.encodings&&(l=t.encodings[0],l&&this.senderEncodingParameter.ssrcList.indexOf(l.ssrc)>-1&&(l=null),t.encodings[1]&&(f=t.encodings[1],f&&this.senderEncodingParameter.ssrcList.indexOf(f.ssrc)>-1&&(l=null))),!l&&i.deviceId&&m>-1){const e=s.sdp.substring(m).match(/a=ssrc-group:FID (\d+) (\d+)/);if(e&&(l={ssrc:parseInt(e[1]),rtx:{ssrc:parseInt(e[2])}}),l&&this.senderEncodingParameter.ssrcList.indexOf(l.ssrc)>-1&&(l=null),!f&&i.deviceIdLow&&g>-1){const e=s.sdp.substring(g).match(/a=ssrc-group:FID (\d+) (\d+)/);e&&(f={ssrc:parseInt(e[1]),rtx:{ssrc:parseInt(e[2])}}),f&&this.senderEncodingParameter.ssrcList.indexOf(f.ssrc)>-1&&(f=null)}}l||(this.loggerSend.log("使用sdp中第一个ssrc"),l={ssrc:parseInt(s.sdp.match(/a=ssrc:(\d+)/)[1]),dtx:!1}),this.senderEncodingParameter[a].high=l,this.senderEncodingParameter.ssrcList.push(l.ssrc),f?(this.senderEncodingParameter[a].low=f,this.senderEncodingParameter.ssrcList.push(f.ssrc)):this.senderEncodingParameter[a].low=null}if(t.encodings=[this.senderEncodingParameter[a].high],this.senderEncodingParameter[a].low&&t.encodings.unshift(this.senderEncodingParameter[a].low),"video"!==i.mediaType&&"screenShare"!==i.mediaType||(n.mediaProfile=[],f&&n.mediaProfile.push({ssrc:f.ssrc,res:"160*160",fps:"1",spatialLayer:0,maxBitrate:100}),n.mediaProfile.push({ssrc:l.ssrc,res:"640*480",fps:"15",spatialLayer:n.mediaProfile.length,maxBitrate:1e3})),void 0===r?n.transportId=this._sendTransport.id:n.dtlsParameters=r,!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw new u.default({code:p.default.NOT_FOUND,message:"No _protoo 2"});const{transportId:v,iceParameters:y,iceCandidates:_,dtlsParameters:S,producerId:b}=await this.adapterRef._signalling._protoo.request("Produce",n);void 0!==v&&(this._sendTransport._id=v),this.loggerSend.log(`produce请求反馈结果, kind: ${e}, producerId:`,b);let R={codecParam:null,codecName:null};if("audio"===i.mediaType?this._micProducerId=b:"video"===i.mediaType?(this._webcamProducerId=b,R=this.adapterRef.mediaCapability.getCodecSend("video",this._sendTransport.handler._sendingRtpParametersByKind.video),this._webcamProducerCodec=R.codecName):"screenShare"===i.mediaType&&(this._screenProducerId=b,R=this.adapterRef.mediaCapability.getCodecSend("screen",this._sendTransport.handler._sendingRtpParametersByKind.video),this._screenProducerCodec=R.codecName),y&&(this._sendTransportIceParameters=y),!this.adapterRef.localStream)throw new u.default({code:p.default.NO_LOCALSTREAM,message:"localStream not found"});let w=[];"audio"===i.mediaType?w.push(Object.assign({},h.getParameters().codecOptions.audio)):"video"===i.mediaType?(t.encodings.length>=2&&w.push(Object.assign({},h.getParameters().codecOptions.video.low)),w.push(Object.assign({},h.getParameters().codecOptions.video.high))):"screenShare"===i.mediaType&&(t.encodings.length>=2&&w.push(Object.assign({},h.getParameters().codecOptions.screen.low)),w.push(Object.assign({},h.getParameters().codecOptions.screen.high))),this.logger.log(`codecOptions for producer ${i.mediaType}: ${JSON.stringify(w)}`),await this._sendTransport.fillRemoteRecvSdp({kind:e,appData:i,iceParameters:y,iceCandidates:_,dtlsParameters:S,sctpParameters:void 0,sendingRtpParameters:t,codecOptions:w,offer:s,codec:R.codecParam,audioProfile:this.adapterRef.localStream.audioProfile}),"video"!==a&&"screen"!==a||(this.adapterRef.localStream.applyEncoderConfig(a,"high"),t.encodings.length>=2&&this.adapterRef.localStream.applyEncoderConfig(a,"low")),o({id:b})}catch(e){n(e)}}),"audio"===t||"all"===t)if(this._micProducer)this.loggerSend.log("音频已经publish，跳过");else{const t=e.mediaHelper.audio.audioStream.getAudioTracks()[0];t&&(this.loggerSend.log("发布 audioTrack: ",t.id,t.label),e.pubStatus.audio.audio=!0,this._micProducer=await this._sendTransport.produce({track:t,trackLow:null,codecOptions:{opusStereo:!0,opusDtx:!0},appData:{deviceId:t.id,deviceIdLow:null,mediaType:"audio"}}),this.watchProducerState(this._micProducer,"_micProducer"))}if("video"===t||"all"===t)if(this._webcamProducer)this.loggerSend.log("视频已经publish，跳过");else if(e.mediaHelper.video.videoStream.getVideoTracks().length){this.adapterRef.channelInfo.videoLow?e.mediaHelper.video.videoTrackLow&&"ended"!==e.mediaHelper.video.videoTrackLow.readyState||await e.mediaHelper.createTrackLow("video"):("live"===(null===(i=e.mediaHelper.video.videoTrackLow)||void 0===i?void 0:i.readyState)&&e.mediaHelper.video.videoTrackLow.stop(),e.mediaHelper.video.videoTrackLow=null,this.senderEncodingParameter.video.low=null);const t=e.mediaHelper.video.videoStream.getVideoTracks()[0];this.loggerSend.log("发布 videoTrack: ",t.id,t.label),e.pubStatus.video.video=!0;const r=this.adapterRef.mediaCapability.getCodecSend("video",this._sendTransport.handler._sendingRtpParametersByKind.video);if(this._webcamProducer=await this._sendTransport.produce({track:t,trackLow:e.mediaHelper.video.videoTrackLow,codec:r.codecParam,codecOptions:{videoGoogleStartBitrate:1e3},appData:{deviceId:t.id,deviceIdLow:e.mediaHelper.video.videoTrackLow?e.mediaHelper.video.videoTrackLow.id:null,mediaType:"video"}}),this.watchProducerState(this._webcamProducer,"_webcamProducer"),this.adapterRef.encryption.encodedInsertableStreams&&this._webcamProducer.rtpSender&&!this._webcamProducer.rtpSender.senderStreams){this.loggerSend.log("发送端开始解密",this.adapterRef.encryption.encryptionMode);const e=this._webcamProducer.rtpSender.createEncodedStreams(),t=new TransformStream({transform:this.adapterRef.encryption.encodeFunctionH264.bind(this.adapterRef.encryption)});e.readable.pipeThrough(t).pipeTo(e.writable),this._webcamProducer.rtpSender.senderStreams=e}this.adapterRef.state.startPubVideoTime||(this.adapterRef.state.startPubVideoTime=Date.now())}if("screen"===t||"all"===t)if(this._screenProducer)this.loggerSend.log("屏幕共享已经publish，跳过");else if(e.mediaHelper.screen.screenVideoStream.getVideoTracks().length){this.adapterRef.channelInfo.screenLow?e.mediaHelper.screen.screenVideoTrackLow&&"ended"!==e.mediaHelper.screen.screenVideoTrackLow.readyState||await e.mediaHelper.createTrackLow("screen"):("live"===(null===(r=e.mediaHelper.screen.screenVideoTrackLow)||void 0===r?void 0:r.readyState)&&e.mediaHelper.screen.screenVideoTrackLow.stop(),e.mediaHelper.screen.screenVideoTrackLow=null,this.senderEncodingParameter.screen.low=null);const t=e.mediaHelper.screen.screenVideoStream.getVideoTracks()[0];this.loggerSend.log("发布 screenTrack: ",t.id,t.label),e.pubStatus.screen.screen=!0;const i=this.adapterRef.mediaCapability.getCodecSend("screen",this._sendTransport.handler._sendingRtpParametersByKind.video);this._screenProducer=await this._sendTransport.produce({track:t,trackLow:e.mediaHelper.screen.screenVideoTrackLow,codec:i.codecParam,codecOptions:{videoGoogleStartBitrate:1e3},appData:{deviceId:t.id,deviceIdLow:e.mediaHelper.screen.screenVideoTrackLow?e.mediaHelper.screen.screenVideoTrackLow.id:null,mediaType:"screenShare"}}),this.watchProducerState(this._screenProducer,"_screenProducer"),this.adapterRef.state.startPubScreenTime||(this.adapterRef.state.startPubScreenTime=Date.now())}}watchProducerState(e,t){var i;if(null===(i=e.rtpSender)||void 0===i?void 0:i.transport){const i=e.rtpSender.transport;switch(i.state){case"failed":this.logger.error(`Producer state ${t} ${i.state}`);break;case"connected":case"new":case"connecting":default:this.logger.log(`Producer state ${t} ${i.state}`),e.rtpSender.transport.addEventListener("statechange",()=>{switch(i.state){case"failed":this.logger.error(`Producer state changed: ${t} ${i.state}`);break;case"connected":case"new":case"connecting":this.logger.log(`Producer state changed: ${t} ${i.state}`)}})}}else this.logger.log("Producer state: transport is null")}async destroyProduce(e){var t;let i=null,r=null;if("audio"===e){if(i=this._micProducer,r=this._micProducerId,this._micProducer=this._micProducerId=null,!this.adapterRef.localStream)throw new u.default({code:p.default.NO_LOCALSTREAM,message:"localStream not found"});this.adapterRef.localStream.pubStatus.audio.audio=!1}else if("video"===e){if(i=this._webcamProducer,r=this._webcamProducerId,this._webcamProducer=this._webcamProducerId=null,!this.adapterRef.localStream)throw new u.default({code:p.default.NO_LOCALSTREAM,message:"localStream not found"});this.adapterRef.localStream.pubStatus.video.video=!1}else if("screen"===e){if(i=this._screenProducer,r=this._screenProducerId,this._screenProducer=this._screenProducerId=null,!this.adapterRef.localStream)throw new u.default({code:p.default.NO_LOCALSTREAM,message:"localStream not found"});this.adapterRef.localStream.pubStatus.screen.screen=!1}try{if(this.loggerSend.log(`停止发布 destroyProduce ${e} producerId=`,r),!i)return;i.close(),(null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)?this.adapterRef._signalling._protoo.request("CloseProducer",{requestId:""+Math.ceil(1e9*Math.random()),producerId:r}).catch(e=>{this.logger.error("destroyProduce Failed:",e.name,e.stack,e)}):this.logger.warn("destroyProduce：当前信令中断，不发信令包",e,r)}catch(e){this.loggerSend.error("_destroyProducer() | failed:",e.name,e.message)}}async createConsumer(e,t,i,r,s=0){return this.adapterRef.instance.emit("pairing-createConsumer-start"),new Promise((o,n)=>{this._eventQueue.push({uid:e,kind:t,id:r,mediaType:i,preferredSpatialLayer:s,resolve:o,reject:n}),this._eventQueue.length>1||(this.adapterRef._enableRts?this._createConsumerRts(this._eventQueue[0]):this._createConsumer(this._eventQueue[0]))})}async setConsumerPreferredLayer(e,t,i){if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw new u.default({code:p.default.NOT_FOUND,message:"No _protoo"});this.loggerSend.log("setConsumerPreferredLayer() [切换大小流]layer：",t,1===t?"大流":"小流",i);return await this.adapterRef._signalling._protoo.request("SetConsumerPreferredLayer",{requestId:""+Math.ceil(1e9*Math.random()),uid:e.streamID,producerId:e.pubStatus[i].producerId,consumerId:e.pubStatus[i].consumerId,spatialLayer:t})}async resetConsumeRequestStatus(){const e=this._eventQueue;this._eventQueue=[];for(let t=0;t<e.length;t++){const i=e[t];this.loggerRecv.log(`resetConsumeRequestStatus：uid ${i.uid}, uid ${i.uid}, kind ${i.kind}, id ${i.id}`),i.reject("resetConsumeRequestStatus")}}removeUselessConsumeRequest(e){const{producerId:t,uid:i}=e;if(t&&i){this.loggerRecv.log(`removeUselessConsumeRequest：producerId ${t}, uid ${i}`);for(let e=0;e<this._eventQueue.length;e++){const r=this._eventQueue[e];this.loggerRecv.log(`removeUselessConsumeRequest：uid ${r.uid}, uid ${r.uid}, kind ${r.kind}, id ${r.id}`),r.id!==t&&r.uid!==i||(this._eventQueue.splice(e,1),e++)}}}checkConsumerList(e){return this._eventQueue.shift(),e.resolve(null),this.loggerRecv.log("查看事件队列, _eventQueue: ",this._eventQueue.length),this._eventQueue.forEach(e=>{this.loggerRecv.log(`consumerList, uid: ${e.uid}, kind: ${e.kind}, mediaType: ${e.mediaType}, id: ${e.id}`)}),this._eventQueue.length>0&&(this.adapterRef._enableRts?this._createConsumerRts(this._eventQueue[0]):this._createConsumer(this._eventQueue[0])),"checkConsumerList"}async _createConsumer(e){const{uid:t,kind:i,mediaType:r,id:s,preferredSpatialLayer:o=0}=e,n="screenShare"===r?"screen":r;if(this.loggerRecv.log(`开始订阅 ${t} 的 ${n} 媒体: ${s} 大小流: `,o),!s)return this.adapterRef.instance.emit("pairing-createConsumer-error"),this.checkConsumerList(e);if(this.unsupportedProducers[s])return this.loggerRecv.warn("_createConsumer: 跳过不支持的Producer",s,JSON.stringify(this.unsupportedProducers[s])),this.checkConsumerList(e);const a=this.adapterRef.remoteStreamMap[t];if(!a||!a.pubStatus[n][n]||!a.pubStatus[n].producerId)return this.adapterRef.instance.emit("pairing-createConsumer-error"),this.checkConsumerList(e);if(a.pubStatus[n].consumerId){this.loggerRecv.log("已经订阅过");let t=!0;if(a.Play&&(t=await a.Play.isPlayStreamError(n)),t)return this.loggerRecv.log("当前播放正常，直接返回"),this.adapterRef.instance.emit("pairing-createConsumer-skip"),this.checkConsumerList(e);if("start"!==a.pubStatus[n].stopconsumerStatus){this.loggerRecv.log("先停止之前的订阅");try{if(a.pubStatus[n].stopconsumerStatus="start",!this.adapterRef._mediasoup)throw new u.default({code:p.default.NO_MEDIASERVER,message:"media server error 21"});await this.destroyConsumer(a.pubStatus.audio.consumerId,null,null),this.adapterRef.instance.removeSsrc(a.getId(),n),a.pubStatus[n].consumerId="",a.stop(n),a.pubStatus[n].stopconsumerStatus="end"}catch(e){this.loggerRecv.error("停止之前的订阅出现错误: ",e.name,e.message)}}}let d=null;if("audio"===n&&(d={opusStereo:1}),this._mediasoupDevice&&this._mediasoupDevice.loaded||(this.loggerRecv.error("createConsumer：Waiting for Transport Ready"),await c.waitForEvent(this,"transportReady",3e3)),!this._recvTransport)throw this.adapterRef.instance.emit("pairing-createConsumer-error"),e.resolve(null),new u.default({code:p.default.NOT_FOUND,message:"No receive transport"});this.loggerRecv.log(`prepareLocalSdp [kind: ${i}, mediaTypeShort: ${n}, uid: ${t}]`),this._recvTransport.id===this.adapterRef.channelInfo.uid&&(this.loggerRecv.log("transporth还没有协商，需要dtls消息"),this._recvTransport._handler._transportReady=!1);const h=await this._recvTransport.prepareLocalSdp(i,this._edgeRtpCapabilities,t);this.adapterRef&&"DISCONNECTING"!=this.adapterRef.connectState.curState&&"DISCONNECTED"!=this.adapterRef.connectState.curState||this.checkConsumerList(e),this.loggerRecv.log("获取本地sdp，mid =",h.mid);let{rtpCapabilities:f,offer:m,iceUfragReg:g}=h,v=h.mid;const y=h.dtlsParameters;v="number"==typeof v&&v<0?void 0:""+v;let _=t;"string"===this.adapterRef.channelInfo.uidType&&(_=new l.default(_));let S={requestId:""+Math.ceil(1e9*Math.random()),kind:i,rtpCapabilities:f,uid:_,producerId:s,preferredSpatialLayer:o,mid:v,pause:!1,iceUfrag:`${this.adapterRef.channelInfo.cid}#${this.adapterRef.channelInfo.uid}#recv`};if(this.adapterRef.instance.apiEventReport("setFunction",{name:"set_video_sub",oper:"1",value:JSON.stringify(o)}),void 0===y?S.transportId=this._recvTransport.id:S.dtlsParameters=y,this.loggerRecv.log(`发送consume请求, uid: ${t}, kind: ${i}, mediaTypeShort: ${n}, producerId: ${S.producerId}, transportId: ${S.transportId}, requestId: ${S.requestId}`),!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw e.resolve(null),new u.default({code:p.default.NOT_FOUND,message:"No _protoo 4"});const b=await this.adapterRef._signalling._protoo.request("Consume",S);if(s!=a.pubStatus[n].producerId)return this.loggerRecv.warn(`收到consumeRes后Producer已经更新。触发重建下行。uid: ${a.streamID} mediaType: ${n} ProducerId: ${s} => ${a.pubStatus[n].producerId} ，Consume结果忽略：`,b),this.resetConsumeRequestStatus(),this._recvTransport&&await this.closeTransport(this._recvTransport),this._recvTransport=null,this.adapterRef.instance.reBuildRecvTransport(),this.checkConsumerList(e);let{transportId:R,iceParameters:w,iceCandidates:T,dtlsParameters:A,probeSSrc:E,rtpParameters:I,producerId:O,consumerId:C,code:P,errMsg:k}=b;if(200!==P)return this.loggerRecv.error(`consume请求失败，将Producer拉入黑名单:  uid: ${t}, mediaType: ${n}, producerId ${S.producerId} code: ${P}, errMsg: ${k}`,b),this.unsupportedProducers[S.producerId]={producerId:b.producerId,code:P,uid:t,mediaType:n,errMsg:k},this.checkConsumerList(e);if(this.loggerRecv.log(`consume反馈结果: code: ${P} uid: ${t}, mid: ${I&&I.mid}, kind: ${i}, producerId: ${O}, consumerId: ${C}, transportId: ${R}, requestId: ${b.requestId}, errMsg: ${k}`),!this._recvTransport)return this.loggerRecv.error("transport undefined，直接返回"),this.checkConsumerList(e);try{const r=b.uid;if(200!==P||!this.adapterRef.remoteStreamMap[t])return this.loggerRecv.warn("remoteStream.pubStatus: ",a.pubStatus),r&&t!=r&&(this.loggerRecv.log("peerId: ",r),this.loggerRecv.log("id 不匹配不处理")),a[n]&&a.pubStatus[n][n]&&a.pubStatus[n].producerId||this.loggerRecv.log(`${t} 的 ${n} 的媒体已经停止发布了，直接返回`),await this._recvTransport.recoverLocalSdp(t,v,i),this.loggerRecv.log("发送请求的 producerId: ",s),this.loggerRecv.log("当前的 producerId：",a.pubStatus[n].producerId),a.pubStatus[n].producerId&&s!=a.pubStatus[n].producerId?(this.loggerRecv.log("此前的订阅已经失效，重新订阅"),this.adapterRef.instance.doSubscribe(a).then(()=>{this.adapterRef.instance.emit("pairing-createConsumer-success")}).catch(()=>{this.adapterRef.instance.emit("pairing-createConsumer-error")})):this.adapterRef.instance.emit("pairing-createConsumer-skip"),this.checkConsumerList(e);I&&I.encodings&&I.encodings.length&&I.encodings[0].ssrc&&this.adapterRef.instance.addSsrc(t,n,I.encodings[0].ssrc),void 0!==R&&(this._recvTransport._id=R),void 0!==E&&(this._probeSSrc=E),w&&(this._recvTransportIceParameters=w);let o={};null!=I.mid&&(I.mid=I.mid+"");const c=await this._recvTransport.consume({id:C,producerId:O,kind:i,rtpParameters:I,codecOptions:d,appData:Object.assign(Object.assign({},o),{peerId:r,remoteUid:t}),offer:m,iceParameters:w,iceCandidates:T,dtlsParameters:A,sctpParameters:void 0,probeSSrc:this._probeSSrc});if(this.adapterRef.encryption.encodedInsertableStreams&&"video"===n&&!c.rtpReceiver.receiverStreams){this.loggerRecv.log("接收端开始解密",this.adapterRef.encryption.encryptionMode);const e=c.rtpReceiver.createEncodedStreams(),t=new TransformStream({transform:this.adapterRef.encryption.decodeFunctionH264.bind(this.adapterRef.encryption)});e.readable.pipeThrough(t).pipeTo(e.writable),c.rtpReceiver.receiverStreams=e}if(this._consumers[c.id]=c,c.on("transportclose",()=>{this._consumers&&delete this._consumers[c.id]}),this.loggerRecv.log("订阅consume完成 peerId =",r),a&&a.pubStatus[n].producerId){if(a.subStatus[n]=!0,a.pubStatus[n][n]=!0,a.pubStatus[n].consumerId=C,a.pubStatus[n].producerId=O,a.getMuteStatus(n).muted){this.loggerRecv.log(`远端流处于mute状态：uid ${a.getId()}, ${n}, ${JSON.stringify(a.getMuteStatus(n))}`);const e=a.getMuteStatus(n);e.send&&this.loggerRecv.log(`远端流把自己mute了：uid ${a.getId()}, ${n}, ${JSON.stringify(e)}`),e.recv&&(this.loggerRecv.log(`本端把远端流mute了：uid ${a.getId()}, ${n}, ${JSON.stringify(e)}`),c.track.enabled=!1)}if(!a.mediaHelper)throw new u.default({code:p.default.NO_MEDIAHELPER,message:"No remoteStream.mediaHelper"});a.mediaHelper.updateStream(n,c.track),this.adapterRef.instance.emit("pairing-createConsumer-success"),this.adapterRef.instance.safeEmit("stream-subscribed",{stream:a,mediaType:n})}else this.adapterRef.instance.emit("pairing-createConsumer-error"),this.loggerRecv.log("该次consume状态错误： ",JSON.stringify(a.pubStatus,null,""));return this.checkConsumerList(e)}catch(r){return this.adapterRef&&this.loggerRecv.error(`订阅 ${t} 的 ${i} 媒体失败, error name: ${r.name}, error.message: ${r.message}`),"peer closed"===r.name?(this.loggerRecv.log("订阅 ${uid} 的 ${kind} 媒体失败，信令通道已经销毁，忽略改成请求"),this.checkConsumerList(e)):(this.loggerRecv.error(`订阅 ${t} 的 ${i} 媒体失败，做容错处理: 重新建立下行连接`),this.resetConsumeRequestStatus(),this._recvTransport&&await this.closeTransport(this._recvTransport),this._recvTransport=null,this.adapterRef.instance.reBuildRecvTransport(),this.checkConsumerList(e))}}async _createConsumerRts(e){const{uid:t,kind:i,id:r,mediaType:s,preferredSpatialLayer:o=0}=e,n="screenShare"===s?"screen":s;if(this.loggerRecv.log(`开始订阅 ${t} 的 ${n} 媒体: ${r} 大小流: ${o}`),!this.adapterRef._rtsTransport)throw new u.default({code:p.default.NOT_FOUND,message:"_createConsumerRts: _rtsTransport is null"});if(!(this.adapterRef._signalling&&this.adapterRef._signalling._protoo&&this.adapterRef._signalling._protoo.request))throw new u.default({code:p.default.NOT_FOUND,message:"_createConsumerRts: _protoo is null"});if("audio"!==n&&"video"!==n&&"screen"!==n)throw new u.default({code:p.default.UNKNOWN_TYPE,message:"_createConsumerRts: mediaType type error"});if(!r)return this.adapterRef.instance.emit("pairing-createConsumer-error"),this.checkConsumerList(e);let a=this.adapterRef.remoteStreamMap[t];if(!a||!a.pubStatus[n][n]||!a.pubStatus[n].producerId)return this.adapterRef.instance.emit("pairing-createConsumer-error"),this.checkConsumerList(e);if(a.pubStatus[n].consumerId)return this.loggerRecv.log("已经订阅过，返回"),this.adapterRef.instance.emit("pairing-createConsumer-skip"),this.checkConsumerList(e);const d={requestId:""+Math.ceil(1e9*Math.random()),transportId:this.adapterRef._rtsTransport.transportId,uid:t,producerId:r,preferredSpatialLayer:o,pause:!1,rtsCapabilities:{codecs:[{kind:n,codec:"video"==n||"screen"==n?"h264":"opus",payloadType:"video"==n||"screen"==n?2:1}]}};if(this.adapterRef.instance.apiEventReport("setFunction",{name:"set_video_sub",oper:"1",value:JSON.stringify(o)}),this.loggerRecv.log("发送consume请求 =",JSON.stringify(d)),!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw e.resolve(null),new u.default({code:p.default.NOT_FOUND,message:"No _protoo 5"});const c=await this.adapterRef._signalling._protoo.request("WsConsume",d);this.loggerRecv.log("consume反馈结果 =",JSON.stringify(c));let{transportId:l,rtpParameters:h,producerId:f,consumerId:m,code:g,errMsg:v}=c;try{const r=c.uid;return 200===g&&this.adapterRef.remoteStreamMap[t]?(this._consumers[m]={producerId:f,close:function(){return Promise.resolve()}},this.loggerRecv.log("订阅consume完成 peerId =",r),a=this.adapterRef.remoteStreamMap[t],a&&a.pubStatus[n].producerId?(a.subStatus[n]=!0,a.pubStatus[n][n]=!0,a.pubStatus[n].consumerId=m,a.pubStatus[n].producerId=f,this.adapterRef.instance.emit("pairing-createConsumer-success")):(this.loggerRecv.log("该次consume状态错误： ",JSON.stringify(a.pubStatus,null,"")),this.adapterRef.instance.emit("pairing-createConsumer-error")),this.checkConsumerList(e)):(this.loggerRecv.error(`订阅 ${t} 的 ${i} 媒体失败, errcode: ${g}, reason: ${v} ，做容错处理: 重新建立下行连接`),this._eventQueue.length=0,void(this._recvTransport=null))}catch(e){return this.adapterRef&&this.loggerRecv.error('"newConsumer" request failed:',e.name,e.message,e),this.loggerRecv.error(`订阅 ${t} 的 ${n} 媒体失败，做容错处理: 重新建立下行连接`),this.adapterRef.instance.reBuildRecvTransport()}}async destroyConsumer(e,t,i){var r,s;if(e)try{const o=this._consumers[e];if(!o)return void this.loggerRecv.log("跳过停止订阅 destroyConsumer consumerId=",e,null==t?void 0:t.streamID);this.loggerRecv.log("停止订阅 destroyConsumer consumerId=",e,null==t?void 0:t.streamID),delete this._consumers[e];try{await(null===(s=null===(r=this.adapterRef._signalling)||void 0===r?void 0:r._protoo)||void 0===s?void 0:s.request("CloseConsumer",{requestId:""+Math.ceil(1e9*Math.random()),consumerId:e,producerId:o.producerId})),await o.close(),t&&i&&this.adapterRef.instance.safeEmit("stream-unsubscribed",{stream:t,mediaType:i})}catch(e){this.logger.error("CloseConsumer失败",e.name,e.message,e)}}catch(e){this.loggerRecv.error("destroyConsumer() | failed:",e.name,e.message,e.stack)}}async closeTransport(e){if(e&&e.id)try{if(this.logger.log(`closeTransport() [停止通道 transportId= ${e.id}]`),!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw new u.default({code:p.default.NOT_FOUND,message:"No _protoo 7"});const t=await this.adapterRef._signalling._protoo.request("CloseTransport",{requestId:""+Math.ceil(1e9*Math.random()),transportId:e.id});this.logger.log(`closeTransport() [停止通道反馈结果 result=${JSON.stringify(t,null," ")}]`),e.close()}catch(e){this.logger.error("closeTransport() | failed:",e.name,e.message,e)}}async muteAudio(){if(this.loggerSend.log("mute音频"),!this._micProducer)throw new u.default({code:p.default.NOT_FOUND,message:"No _micProducer"});this._micProducer.pause();try{if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw new u.default({code:p.default.NOT_FOUND,message:"No _protoo 8"});let e=this.adapterRef.channelInfo.uid;"string"===this.adapterRef.channelInfo.uidType&&(e=new l.default(e)),await this.adapterRef._signalling._protoo.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:e,data:{producerId:this._micProducer.id,mute:!0}}})}catch(e){this.loggerSend.error("muteMic() | failed:",e.name,e.message,e)}}async unmuteAudio(){if(this.loggerSend.log("resume音频"),!this._micProducer)throw new u.default({code:p.default.NOT_FOUND,message:"No _micProducer"});this._micProducer.resume();try{if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw new u.default({code:p.default.NOT_FOUND,message:"No _protoo 9"});let e=this.adapterRef.channelInfo.uid;"string"===this.adapterRef.channelInfo.uidType&&(e=new l.default(e)),await this.adapterRef._signalling._protoo.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:e,data:{producerId:this._micProducer.id,mute:!1}}})}catch(e){return this.loggerSend.error("muteMic() | failed: ",e.name,e.message,e),Promise.reject(e)}}async muteVideo(){if(this.loggerSend.log("mute视频"),!this._webcamProducer)throw new u.default({code:p.default.NOT_FOUND,message:"No _webcamProducer"});this._webcamProducer.pause();try{if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw new u.default({code:p.default.NOT_FOUND,message:"No _protoo 10"});let e=this.adapterRef.channelInfo.uid;"string"===this.adapterRef.channelInfo.uidType&&(e=new l.default(e)),await this.adapterRef._signalling._protoo.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:e,data:{producerId:this._webcamProducer.id,mute:!0}}})}catch(e){this.loggerSend.error("muteMic() | failed:",e.name,e.message,e)}}async unmuteVideo(){if(this.loggerSend.log("resume视频"),!this._webcamProducer)throw new u.default({code:p.default.NOT_FOUND,message:"No _webcamProducer"});this._webcamProducer.resume();try{if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw new u.default({code:p.default.NOT_FOUND,message:"No _protoo 11"});let e=this.adapterRef.channelInfo.uid;"string"===this.adapterRef.channelInfo.uidType&&(e=new l.default(e)),await this.adapterRef._signalling._protoo.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:e,data:{producerId:this._webcamProducer.id,mute:!1}}})}catch(e){this.loggerSend.error("muteMic() | failed:",e.name,e.message,e)}}async muteScreen(){if(this.loggerSend.log("mute视频"),!this._screenProducer)throw new u.default({code:p.default.NOT_FOUND,message:"No _screenProducer 1"});this._screenProducer.pause();try{if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw new u.default({code:p.default.NOT_FOUND,message:"No _protoo 12"});let e=this.adapterRef.channelInfo.uid;"string"===this.adapterRef.channelInfo.uidType&&(e=new l.default(e)),await this.adapterRef._signalling._protoo.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:e,data:{producerId:this._screenProducer.id,mute:!0}}})}catch(e){this.loggerSend.error("muteScreen() | failed: ",e.name,e.message,e)}}async unmuteScreen(){if(this.loggerSend.log("resume视频"),!this._screenProducer)throw new u.default({code:p.default.NOT_FOUND,message:"No _screenProducer 2"});this._screenProducer.resume();try{if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw new u.default({code:p.default.NOT_FOUND,message:"No _protoo 13"});let e=this.adapterRef.channelInfo.uid;"string"===this.adapterRef.channelInfo.uidType&&(e=new l.default(e)),await this.adapterRef._signalling._protoo.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:e,data:{producerId:this._screenProducer.id,mute:!1}}})}catch(e){this.loggerSend.error("muteMic() | failed:",e.name,e.message,e)}}async updateUserRole(e){this.loggerSend.log("updateUserRole:更新用户角色为"+e);try{if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw new u.default({code:p.default.NOT_FOUND,message:"No _protoo 14"});let t=this.adapterRef.channelInfo.uid;"string"===this.adapterRef.channelInfo.uidType&&(t=new l.default(t)),await this.adapterRef._signalling._protoo.request("SendUserData",{externData:{type:"UserRole",cid:this.adapterRef.channelInfo.cid,uid:t,data:{userRole:e}}})}catch(e){throw this.loggerSend.error("updateUserRole failed:",e.name,e.message,e),e}}destroy(){this.logger.log("清除 meidasoup"),this._reset()}}t.Mediasoup=m},function(e,t,i){const r=i(108)("h264-profile-level-id");r.log=console.info.bind(console);t.ProfileConstrainedBaseline=1,t.ProfileBaseline=2,t.ProfileMain=3,t.ProfileConstrainedHigh=4,t.ProfileHigh=5;t.Level1_b=0,t.Level1=10,t.Level1_1=11,t.Level1_2=12,t.Level1_3=13,t.Level2=20,t.Level2_1=21,t.Level2_2=22,t.Level3=30,t.Level3_1=31,t.Level3_2=32,t.Level4=40,t.Level4_1=41,t.Level4_2=42,t.Level5=50,t.Level5_1=51,t.Level5_2=52;class s{constructor(e,t){this.profile=e,this.level=t}}t.ProfileLevelId=s;const o=new s(1,31);class n{constructor(e){this._mask=~c("x",e),this._maskedValue=c("1",e)}isMatch(e){return this._maskedValue===(e&this._mask)}}class a{constructor(e,t,i){this.profile_idc=e,this.profile_iop=t,this.profile=i}}const d=[new a(66,new n("x1xx0000"),1),new a(77,new n("1xxx0000"),1),new a(88,new n("11xx0000"),1),new a(66,new n("x0xx0000"),2),new a(88,new n("10xx0000"),2),new a(77,new n("0x0x0000"),3),new a(100,new n("00000000"),5),new a(100,new n("00001100"),4)];function c(e,t){return(t[0]===e)<<7|(t[1]===e)<<6|(t[2]===e)<<5|(t[3]===e)<<4|(t[4]===e)<<3|(t[5]===e)<<2|(t[6]===e)<<1|(t[7]===e)<<0}function l(e={}){const t=e["level-asymmetry-allowed"];return 1===t||"1"===t}t.parseProfileLevelId=function(e){if("string"!=typeof e||6!==e.length)return null;const t=parseInt(e,16);if(0===t)return null;const i=255&t,o=t>>8&255,n=t>>16&255;let a;switch(i){case 11:a=0!=(16&o)?0:11;break;case 10:case 12:case 13:case 20:case 21:case 22:case 30:case 31:case 32:case 40:case 41:case 42:case 50:case 51:case 52:a=i;break;default:return r("parseProfileLevelId() | unrecognized level_idc:%s",i),null}for(const e of d)if(n===e.profile_idc&&e.profile_iop.isMatch(o))return new s(e.profile,a);return r("parseProfileLevelId() | unrecognized profile_idc/profile_iop combination"),null},t.profileLevelIdToString=function(e){if(0==e.level)switch(e.profile){case 1:return"42f00b";case 2:return"42100b";case 3:return"4d100b";default:return r("profileLevelIdToString() | Level 1_b not is allowed for profile:%s",e.profile),null}let t;switch(e.profile){case 1:t="42e0";break;case 2:t="4200";break;case 3:t="4d00";break;case 4:t="640c";break;case 5:t="6400";break;default:return r("profileLevelIdToString() | unrecognized profile:%s",e.profile),null}let i=e.level.toString(16);return 1===i.length&&(i="0"+i),`${t}${i}`},t.parseSdpProfileLevelId=function(e={}){const i=e["profile-level-id"];return i?t.parseProfileLevelId(i):o},t.isSameProfile=function(e={},i={}){const r=t.parseSdpProfileLevelId(e),s=t.parseSdpProfileLevelId(i);return Boolean(r&&s&&r.profile===s.profile)},t.generateProfileLevelIdForAnswer=function(e={},i={}){if(!e["profile-level-id"]&&!i["profile-level-id"])return r("generateProfileLevelIdForAnswer() | no profile-level-id in local and remote params"),null;const o=t.parseSdpProfileLevelId(e),n=t.parseSdpProfileLevelId(i);if(!o)throw new TypeError("invalid local_profile_level_id");if(!n)throw new TypeError("invalid remote_profile_level_id");if(o.profile!==n.profile)throw new TypeError("H264 Profile mismatch");const a=l(e)&&l(i),d=o.level,c=n.level,u=function(e,t){return 0===e?10!==t&&0!==t:0===t?10!==e:e<t}(p=d,h=c)?p:h;var p,h;const f=a?d:u;return r("generateProfileLevelIdForAnswer() | result: [profile:%s, level:%s]",o.profile,f),t.profileLevelIdToString(new s(o.profile,f))}},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(s,o){function n(e){try{d(r.next(e))}catch(e){o(e)}}function a(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,a)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});t.AwaitQueue=class{constructor({ClosedErrorClass:e=Error,StoppedErrorClass:t=Error}={ClosedErrorClass:Error,StoppedErrorClass:Error}){this.closed=!1,this.pendingTasks=[],this.ClosedErrorClass=Error,this.StoppedErrorClass=Error,this.ClosedErrorClass=e,this.StoppedErrorClass=t}get size(){return this.pendingTasks.length}close(){if(!this.closed){this.closed=!0;for(const e of this.pendingTasks)e.stopped=!0,e.reject(new this.ClosedErrorClass("AwaitQueue closed"));this.pendingTasks.length=0}}push(e,t){return r(this,void 0,void 0,(function*(){if(this.closed)throw new this.ClosedErrorClass("AwaitQueue closed");if("function"!=typeof e)throw new TypeError("given task is not a function");if(!e.name&&t)try{Object.defineProperty(e,"name",{value:t})}catch(e){}return new Promise((i,r)=>{const s={task:e,name:t,resolve:i,reject:r,stopped:!1,enqueuedAt:new Date,executedAt:void 0};this.pendingTasks.push(s),1===this.pendingTasks.length&&this.next()})}))}stop(){if(!this.closed){for(const e of this.pendingTasks)e.stopped=!0,e.reject(new this.StoppedErrorClass("AwaitQueue stopped"));this.pendingTasks.length=0}}dump(){const e=new Date;return this.pendingTasks.map(t=>({task:t.task,name:t.name,enqueuedTime:t.executedAt?t.executedAt.getTime()-t.enqueuedAt.getTime():e.getTime()-t.enqueuedAt.getTime(),executingTime:t.executedAt?e.getTime()-t.executedAt.getTime():0}))}next(){return r(this,void 0,void 0,(function*(){const e=this.pendingTasks[0];e&&(yield this.executeTask(e),this.pendingTasks.shift(),this.next())}))}executeTask(e){return r(this,void 0,void 0,(function*(){if(!e.stopped){e.executedAt=new Date;try{const t=yield e.task();if(e.stopped)return;e.resolve(t)}catch(t){if(e.stopped)return;e.reject(t)}}}))}}},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Chrome74=void 0;const a=o(i(39)),d=i(7),c=o(i(20)),l=o(i(38)),u=o(i(74)),p=o(i(75)),h=i(52),f=i(76),m=i(14),g=n(i(1)),v=n(i(0)),y="Chrome74",_={OS:1024,MIS:1024};class S extends h.HandlerInterface{constructor(){super(),this._sendingRemoteRtpParametersByKind={},this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._transportReady=!1,this._appData={}}static createFactory(){return()=>new S}get name(){return"Chrome74"}close(){if(d.Logger.debug(y,"close()"),this._pc)try{this._pc.onconnectionstatechange=null,this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){d.Logger.debug(y,"getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();t.sdp=t.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack");try{e.close()}catch(e){}const i=a.parse(t.sdp);return u.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return d.Logger.debug(y,"getNativeSctpCapabilities()"),{numStreams:_}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:o,iceTransportPolicy:n,additionalSettings:a,proprietaryConstraints:c,extendedRtpCapabilities:u,appData:p}){d.Logger.debug(y,"run()",p),this._appData=p,this._direction=e,this._sendingRtpParametersByKind={audio:l.getSendingRtpParameters("audio",u),video:l.getSendingRtpParameters("video",u)},this._sendingRemoteRtpParametersByKind={audio:l.getSendingRemoteRtpParameters("audio",u),video:l.getSendingRemoteRtpParameters("video",u)},d.Logger.debug(y,"iceServers: %o",o);const h={iceServers:o||[],iceTransportPolicy:n||"all",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"};p.encodedInsertableStreams&&(h.encodedInsertableStreams=!0),this._pc=new RTCPeerConnection(h,c),this._pc.onconnectionstatechange=()=>{switch(this._pc.connectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}},this._pc.onicecandidate=e=>{},this._pc.onicecandidateerror=e=>{console.error("地址收集失败: ",e)}}async updateIceServers(e){d.Logger.debug(y,"updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(d.Logger.debug(y,"restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if(this._direction){const e=await this._pc.createOffer({iceRestart:!0});e.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(e.sdp=e.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#${this._direction}`));let t=a.parse(e.sdp);t.media.forEach(e=>{"audio"===e.type&&"send"===this._direction&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)))}),e.sdp=a.write(t),d.Logger.debug(y,"restartIce() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(e);const i={type:"answer",sdp:this._remoteSdp.getSdp()};d.Logger.debug(y,"restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};d.Logger.debug(y,"restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();d.Logger.debug(y,"restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,trackLow:t,encodings:i,codecOptions:r,codec:s,appData:o}){this._assertSendDirection(),d.Logger.debug(y,"send() [kind:%s, track.id:%s]",e.kind,e.id,i,o),i&&i.length>1&&i.forEach((e,t)=>{e.rid="r"+t});const n=c.clone(this._sendingRtpParametersByKind[e.kind],{});n.codecs=m.reduceCodecs(n.codecs,s);let l={},h={};const f=new MediaStream;"audio"===o.mediaType&&this._pc.audioSender?(d.Logger.debug(y,"audioSender更新track: ",this._pc.audioSender.track,"=>",e),this._pc.audioSender.replaceTrack(e)):"video"===o.mediaType&&this._pc.videoSender?(d.Logger.debug(y,"videoSender更新track: ",this._pc.videoSender.track,"=>",e),this._pc.videoSender.replaceTrack(e),this._pc.videoSenderLow&&t&&(d.Logger.debug(y,"videoSenderLow更新track: ",this._pc.videoSenderLow),this._pc.videoSenderLow.replaceTrack(t))):"screenShare"===o.mediaType&&this._pc.screenSender?(d.Logger.debug(y,"screenSender更新track: ",this._pc.screenSender.track,"=>",e),this._pc.screenSender.replaceTrack(e),this._pc.screenSenderLow&&t&&(d.Logger.debug(y,"screenSenderLow更新track: ",this._pc.screenSenderLow),this._pc.screenSenderLow.replaceTrack(t))):(f.addTrack(e),l=this._pc.addTransceiver(e,{direction:"sendonly",streams:[f],sendEncodings:i}),t&&(h=this._pc.addTransceiver(t,{direction:"sendonly",streams:[this._sendStream],sendEncodings:i})),"audio"!==o.mediaType||this._pc.audioSender?"video"!==o.mediaType||this._pc.videoSender?"screenShare"!==o.mediaType||this._pc.screenSender||(this._pc.screenSender=l.sender,this._pc.screenSenderLow=h.sender):(this._pc.videoSender=l.sender,this._pc.videoSenderLow=h.sender):this._pc.audioSender=l.sender),d.Logger.debug(y,"send() | [transceivers:%d]",this._pc.getTransceivers().length);let _=await this._pc.createOffer();_.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(_.sdp=_.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#send`));let S,b,R=a.parse(_.sdp),w=void 0;const T=R.media.filter(i=>{const r=this._mapMidTransceiver.get(""+i.mid);return i.type===e.kind&&(!(r&&r.sender&&r.sender.track)||(r.sender.track.id===e.id?(S=i,!1):!t||r.sender.track.id!==t.id||(b=i,!1)))});if(S||(S=T.pop()),t&&!b&&(b=T.pop()),!S)throw new g.default({code:v.default.NOT_FOUND,message:"offerMediaObject with track id not found: "+e.id});this._transportReady||(w=await this._setupTransport({localDtlsRole:"server",localSdpObject:R}));let A=S.mid;if("number"==typeof A&&(A=""+A),!A)throw new g.default({code:v.default.NOT_FOUND,message:"No localId"});let E=null;if(b&&(E=""+b.mid),n.mid=A,d.Logger.debug(y,"要检查M行: ",S),n.rtcp.cname=u.getCname({offerMediaObject:S}),i)if(1===i.length){let e=p.getRtpEncodings({offerMediaObject:S});Object.assign(e[0],i[0]),n.encodings=e}else n.encodings=i;else n.encodings=[],b&&(n.encodings=n.encodings.concat(p.getRtpEncodings({offerMediaObject:b}))),n.encodings=n.encodings.concat(p.getRtpEncodings({offerMediaObject:S}));return n.encodings.length>1&&("video/vp8"===n.codecs[0].mimeType.toLowerCase()||"video/h264"===n.codecs[0].mimeType.toLowerCase())&&R.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)))}),_.sdp=a.write(R),this._mapMidTransceiver.set(A,l),E&&this._mapMidTransceiver.set(E,h),{localId:A,localIdLow:E,rtpParameters:n,rtpSender:l.sender,rtpSenderLow:h.sender||null,dtlsParameters:w,offer:_}}async fillRemoteRecvSdp({kind:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,sendingRtpParameters:o,codecOptions:n,offer:l,audioProfile:u,codec:p}){d.Logger.debug(y,"fillRemoteRecvSdp() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(l),this._remoteSdp||(this._remoteSdp=new f.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s}),this._remoteSdp.updateDtlsRole("client"));const h=c.clone(this._sendingRemoteRtpParametersByKind[e]);h.codecs=m.reduceCodecs(h.codecs,p);let g=a.parse(this._pc.localDescription.sdp);const v=this._remoteSdp.getNextMediaSectionIdx();let _=g.media[v.idx],S=null;o.encodings&&o.encodings.length>1&&(S=g.media[v.idx+1]),this._remoteSdp.send({offerMediaObjectArr:[_,S],reuseMid:v.reuseMid,offerRtpParameters:o,answerRtpParameters:h,codecOptions:n,extmapAllowMixed:!0});const b={type:"answer",sdp:this._remoteSdp.getSdp()};if(d.Logger.debug(y,"audioProfile设置为: ",u),u){let e=null;switch(u){case"speech_low_quality":e="maxplaybackrate=16000;sprop-maxcapturerate=16000;maxaveragebitrate=32000";break;case"speech_standard":e="maxplaybackrate=32000;sprop-maxcapturerate=32000;maxaveragebitrate=36000";break;case"music_standard":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;";break;case"standard_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=56000";break;case"high_quality":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=128000";break;case"high_quality_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=192000"}b.sdp.indexOf("a=fmtp:111")&&(b.sdp=b.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;useinbandfec=1;"+e)),b.sdp=b.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=maxptime:60")}d.Logger.debug(y,"fillRemoteRecvSdp() | calling pc.setRemoteDescription() [answer]: ",b.sdp),await this._pc.setRemoteDescription(b)}async stopSending(e,t){var i,r;this._assertSendDirection(),d.Logger.debug(y,"stopSending() [localId:%s]",e);const s=this._mapMidTransceiver.get(e);if(!s)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});"audio"===t?this._pc.audioSender.replaceTrack(null):"video"===t?(this._pc.videoSender.replaceTrack(null),this._pc.videoSenderLow&&(null===(i=this._pc.videoSenderLow.track)||void 0===i||i.stop(),this._pc.videoSenderLow.replaceTrack(null))):"screenShare"===t?(this._pc.screenSender.replaceTrack(null),this._pc.screenSenderLow&&(null===(r=this._pc.screenSenderLow.track)||void 0===r||r.stop(),this._pc.screenSenderLow.replaceTrack(null))):s.sender.replaceTrack(null);const o=await this._pc.createOffer();o.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(o.sdp=o.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#send`));let n=a.parse(o.sdp);n.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)))}),o.sdp=a.write(n),d.Logger.debug(y,"stopSending() | calling pc.setLocalDescription()");try{await this._pc.setLocalDescription(o)}catch(e){d.Logger.debug(y,"setLocalDescription error = %o",e)}const c={type:"answer",sdp:this._remoteSdp.getSdp()};d.Logger.debug(y,"stopSending() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setRemoteDescription(c)}async replaceTrack(e,t){this._assertSendDirection(),t?d.Logger.debug(y,"replaceTrack() [localId:%s, track.id:%s]",e,t.id):d.Logger.debug(y,"replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this._assertSendDirection(),d.Logger.debug(y,"setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});const r=i.sender.getParameters();r.encodings.forEach((e,i)=>{e.active=i<=t}),await i.sender.setParameters(r)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),d.Logger.debug(y,"setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});const r=i.sender.getParameters();r.encodings.forEach((e,i)=>{r.encodings[i]=Object.assign(Object.assign({},e),t)}),await i.sender.setParameters(r)}async getSenderStats(e){this._assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});return t.sender.getStats()}async recoverTransceiver(e,t,i){d.Logger.debug(y,"recoverTransceiver() [kind:%s, remoteUid:%s, mid: %s]",i,e,t);const r=this._mapMidTransceiver.get(t);r?r.isUseless=!0:d.Logger.debug(y,"recoverTransceiver() transceiver undefined")}async prepareLocalSdp(e,t){d.Logger.debug(y,"prepareLocalSdp() [kind:%s, remoteUid:%s]",e,t);let i=-1;for(const t of this._mapMidTransceiver.keys()){const r=this._mapMidTransceiver.get(t);if(!r)continue;const s=r.receiver&&r.receiver.track&&r.receiver.track.kind||e;if(d.Logger.debug(y,"prepareLocalSdp() transceiver M行信息 [mid: %s, mediaType: %s, isUseless: %s]",r.mid||t,s,r.isUseless),r.isUseless&&s===e){i=t-0,r.isUseless=!1;break}}let r=this._pc.localDescription,s=null;-1===i&&(d.Logger.debug(y,"prepareLocalSdp() 添加一个M行"),s=this._pc.addTransceiver(e,{direction:"recvonly"}),r=await this._pc.createOffer(),r.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(r.sdp=r.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#recv`),r.sdp=r.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack")),d.Logger.debug(y,"prepareLocalSdp() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(r));const o=a.parse(r.sdp);let n=void 0;this._transportReady||(n=await this._setupTransport({localDtlsRole:"server",localSdpObject:o}));const c=u.extractRtpCapabilities({sdpObject:o});return-1===i&&(i=o.media.length-1,this._mapMidTransceiver.set(""+i,s)),{dtlsParameters:n,rtpCapabilities:c,offer:r,mid:i,iceUfragReg:""}}async receive({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,trackId:s,kind:o,rtpParameters:n,offer:c,probeSSrc:l=-1,remoteUid:u,extendedRtpCapabilities:p}){this._assertRecvDirection(),d.Logger.debug(y,"receive() [trackId: %s, kind: %s, remoteUid: %s]",s,o,u),this._remoteSdp||(this._remoteSdp=new f.RemoteSdp({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r}),this._remoteSdp.updateDtlsRole("client"));const h=n.mid;if(d.Logger.debug(y,"处理对端的M行 mid: ",h),!h)throw new g.default({code:v.default.NOT_FOUND,message:"No localId"});const m=this._pc.getTransceivers().length,_=this._remoteSdp._mediaSections.length+1;if(d.Logger.debug(y,`offerMediaSessionLength: ${m}，answerMediaSessionLength: ${_}`),m<_);else if(m>_){d.Logger.debug(y,"mediaSession 不匹配, 兼容处理");const e=[];a.parse(c.sdp).media.forEach(t=>{let i=!1;this._remoteSdp._mediaSections.forEach(e=>{t.mid!=e.mid||(i=!0)}),i||e.push({mid:t.mid,kind:t.type})}),d.Logger.debug(y,"receive() 检索出来了缺失的media Session: ",e),e.forEach(e=>{this._remoteSdp.receive({mid:""+e.mid,kind:e.kind,offerRtpParameters:{codecs:p.codecs.filter(t=>t.kind==e.kind),encodings:[{ssrc:0}],headerExtensions:[],rtcp:{},mid:""+e.mid}}),this._remoteSdp.disableMediaSection(""+e.mid)})}c.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(c.sdp=c.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#recv`),c.sdp=c.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack")),this._remoteSdp.receive({mid:h,kind:o,offerRtpParameters:n,streamId:n.rtcp.cname,trackId:s,reuseMid:null});const S={type:"answer",sdp:this._remoteSdp.getSdp()};d.Logger.debug(y,"receive() | calling pc.setRemoteDescription() [answer]: ",S.sdp),"stable"===this._pc.signalingState&&(await this._pc.setLocalDescription(c),d.Logger.debug(y,"receive() | calling pc.setLocalDescription()")),await this._pc.setRemoteDescription(S);const b=this._pc.getTransceivers().find(e=>e.mid===h);if(!b)throw new g.default({code:v.default.NOT_FOUND,message:"new RTCRtpTransceiver not found"});return this._mapMidTransceiver.set(h,b),{localId:h,track:b.receiver.track,rtpReceiver:b.receiver}}async stopReceiving(e){this._assertRecvDirection(),d.Logger.debug(y,"stopReceiving() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t||!t.mid)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});t.receiver&&t.receiver.track&&t.receiver.track&&"audio"===t.receiver.track.kind||(t.isUseless=!0),this._remoteSdp.disableMediaSection(t.mid);const i=this._pc.localDescription;i.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(i.sdp=i.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#recv`)),d.Logger.debug(y,"stopReceiving() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(i);const r={type:"answer",sdp:this._remoteSdp.getSdp()};d.Logger.debug(y,"stopReceiving() | calling pc.setRemoteDescription() [answer:%s]",r.sdp),await this._pc.setRemoteDescription(r)}async getReceiverStats(e){this._assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});return t.receiver.getStats()}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=a.parse(this._pc.localDescription.sdp));const i=u.extractDtlsParameters({sdpObject:t});return i.role=e,this._transportReady=!0,i}_assertSendDirection(){if("send"!==this._direction)throw new g.default({code:v.default.INVALID_OPERATION,message:'method can just be called for handlers with "send" direction'})}_assertRecvDirection(){if("recv"!==this._direction)throw new g.default({code:v.default.INVALID_OPERATION,message:'method can just be called for handlers with "recv" direction'})}}t.Chrome74=S},function(e,t,i){var r=function(e){return String(Number(e))===e?Number(e):e},s=function(e,t,i){var s=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:s&&!t[e.name]&&(t[e.name]={});var o=e.push?{}:s?t[e.name]:t;!function(e,t,i,s){if(s&&!i)t[s]=r(e[1]);else for(var o=0;o<i.length;o+=1)null!=e[o+1]&&(t[i[o]]=r(e[o+1]))}(i.match(e.reg),o,e.names,e.name),e.push&&t[e.push].push(o)},o=i(121),n=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(e){var t={},i=[],r=t;return e.split(/(\r\n|\r|\n)/).filter(n).forEach((function(e){var t=e[0],n=e.slice(2);"m"===t&&(i.push({rtp:[],fmtp:[]}),r=i[i.length-1]);for(var a=0;a<(o[t]||[]).length;a+=1){var d=o[t][a];if(d.reg.test(n))return s(d,r,n)}})),t.media=i,t};var a=function(e,t){var i=t.split(/=(.+)/,2);return 2===i.length?e[i[0]]=r(i[1]):1===i.length&&t.length>1&&(e[i[0]]=void 0),e};t.parseParams=function(e){return e.split(/;\s?/).reduce(a,{})},t.parseFmtpConfig=t.parseParams,t.parsePayloads=function(e){return e.toString().split(" ").map(Number)},t.parseRemoteCandidates=function(e){for(var t=[],i=e.split(" ").map(r),s=0;s<i.length;s+=3)t.push({component:i[s],ip:i[s+1],port:i[s+2]});return t},t.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(a,{})}))},t.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var t,i=!1;return"~"!==e[0]?t=r(e):(t=r(e.substring(1,e.length)),i=!0),{scid:t,paused:i}}))}))}},function(e,t,i){var r=i(121),s=/%[sdv%]/g,o=function(e){var t=1,i=arguments,r=i.length;return e.replace(s,(function(e){if(t>=r)return e;var s=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(s);case"%d":return Number(s);case"%v":return""}}))},n=function(e,t,i){var r=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var s=0;s<t.names.length;s+=1){var n=t.names[s];t.name?r.push(i[t.name][n]):r.push(i[t.names[s]])}else r.push(i[t.name]);return o.apply(null,r)},a=["v","o","s","i","u","e","p","c","b","t","r","z","a"],d=["i","c","b","a"];e.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var i=t.outerOrder||a,s=t.innerOrder||d,o=[];return i.forEach((function(t){r[t].forEach((function(i){i.name in e&&null!=e[i.name]?o.push(n(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){o.push(n(t,i,e))}))}))})),e.media.forEach((function(e){o.push(n("m",r.m[0],e)),s.forEach((function(t){r[t].forEach((function(i){i.name in e&&null!=e[i.name]?o.push(n(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){o.push(n(t,i,e))}))}))}))})),o.join("\r\n")+"\r\n"}},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.OfferMediaSection=t.AnswerMediaSection=t.MediaSection=void 0;const n=o(i(20));class a{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,planB:r=!1}){if(this._mediaObject={},this._planB=r,e&&this.setIceParameters(e),t){this._mediaObject.candidates=[];for(const e of t){const t={component:1};t.foundation=e.foundation,t.ip=e.ip,t.port=e.port,t.priority=e.priority,t.transport=e.protocol,t.type=e.type,e.tcpType&&(t.tcptype=e.tcpType),this._mediaObject.candidates.push(t)}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination"}i&&this.setDtlsRole(i.role)}get mid(){return String(this._mediaObject.mid)}get closed(){return 0===this._mediaObject.port}getObject(){return this._mediaObject}setIceParameters(e){this._mediaObject.iceUfrag=e.usernameFragment,this._mediaObject.icePwd=e.password}disable(){delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids}close(){this._mediaObject.direction="inactive",this._mediaObject.port=0,delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed}}t.MediaSection=a;t.AnswerMediaSection=class extends a{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,plainRtpParameters:s,planB:o=!1,offerMediaObject:a,offerRtpParameters:c,answerRtpParameters:l,codecOptions:u,extmapAllowMixed:p=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:i,planB:o}),this._mediaObject.mid=String(a.mid),this._mediaObject.type=a.type,this._mediaObject.protocol=a.protocol,s?(this._mediaObject.connection={ip:s.ip,version:s.ipVersion},this._mediaObject.port=s.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),a.type){case"audio":case"video":this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(const e of l.codecs){const t={payload:e.payloadType,codec:d(e),rate:e.clockRate};e.channels>1&&(t.encoding=e.channels),this._mediaObject.rtp.push(t);const i=n.clone(e.parameters,{});if(u){const{opusStereo:t,opusFec:r,opusDtx:s,opusMaxPlaybackRate:o,opusPtime:n,videoGoogleStartBitrate:a,videoGoogleMaxBitrate:d,videoGoogleMinBitrate:l}=u,p=c.codecs.find(t=>t.payloadType===e.payloadType);switch(e.mimeType.toLowerCase()){case"audio/opus":void 0!==t&&(p.parameters["sprop-stereo"]=t?1:0,i.stereo=t?1:0),void 0!==r&&(p.parameters.useinbandfec=r?1:0,i.useinbandfec=r?1:0),void 0!==s&&(p.parameters.usedtx=s?1:0,i.usedtx=s?1:0),void 0!==o&&(i.maxplaybackrate=o),void 0!==n&&(p.parameters.ptime=n,i.ptime=n);break;case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":void 0!==a&&(i["x-google-start-bitrate"]=a),void 0!==d&&(i["x-google-max-bitrate"]=d),void 0!==l&&(i["x-google-min-bitrate"]=l)}}const r={payload:e.payloadType,config:""};for(const e of Object.keys(i))r.config&&(r.config+=";"),r.config+=`${e}=${i[e]}`;r.config&&this._mediaObject.fmtp.push(r);for(const t of e.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:e.payloadType,type:t.type,subtype:t.parameter})}this._mediaObject.payloads=l.codecs.map(e=>e.payloadType).join(" "),this._mediaObject.ext=[];for(const e of l.headerExtensions){(a.ext||[]).some(t=>t.uri===e.uri)&&this._mediaObject.ext.push({uri:e.uri,value:e.id})}if(p&&"extmap-allow-mixed"===a.extmapAllowMixed&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),a.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:a.simulcast.list1},this._mediaObject.rids=[];for(const e of a.rids||[])"send"===e.direction&&this._mediaObject.rids.push({id:e.id,direction:"recv"})}else if(a.simulcast_03){this._mediaObject.simulcast_03={value:a.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(const e of a.rids||[])"send"===e.direction&&this._mediaObject.rids.push({id:e.id,direction:"recv"})}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize",this._planB&&"video"===this._mediaObject.type&&(this._mediaObject.xGoogleFlag="conference");break;case"application":"number"==typeof a.sctpPort?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=r.port,this._mediaObject.maxMessageSize=r.maxMessageSize):a.sctpmap&&(this._mediaObject.payloads=r.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:r.port,maxMessageSize:r.maxMessageSize})}}setDtlsRole(e){switch(e){case"client":this._mediaObject.setup="active";break;case"server":this._mediaObject.setup="passive";break;case"auto":this._mediaObject.setup="actpass"}}};function d(e){const t=new RegExp("^(audio|video)/(.+)","i").exec(e.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");return t[2]}t.OfferMediaSection=class extends a{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,plainRtpParameters:s,planB:o=!1,mid:n,kind:a,offerRtpParameters:c,streamId:l,trackId:u,oldDataChannelSpec:p=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:i,planB:o}),this._mediaObject.mid=String(n),this._mediaObject.type=a,s?(this._mediaObject.connection={ip:s.ip,version:s.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=s.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.protocol=r?"UDP/DTLS/SCTP":"UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),a){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._planB||(this._mediaObject.msid=`${l||"-"} ${u}`);for(const e of c.codecs){const t={payload:e.payloadType||e.localPayloadType||125,codec:d(e),rate:e.clockRate};e.channels>1&&(t.encoding=e.channels),this._mediaObject.rtp.push(t);const i={payload:e.payloadType||e.localPayloadType||125,config:""},r=e.parameters||e.localParameters||{};for(const e of Object.keys(r))i.config&&(i.config+=";"),i.config+=`${e}=${r[e]}`;i.config&&this._mediaObject.fmtp.push(i);for(const t of e.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:e.payloadType,type:t.type,subtype:t.parameter})}this._mediaObject.payloads=c.codecs.map(e=>e.payloadType||e.localPayloadType||125).join(" "),this._mediaObject.ext=[];for(const e of c.headerExtensions)this._mediaObject.ext.push({uri:e.uri,value:e.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";const e=c.encodings[0],t=e.ssrc,i=e.rtx&&e.rtx.ssrc?e.rtx.ssrc:void 0;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],c.rtcp.cname&&this._mediaObject.ssrcs.push({id:t,attribute:"cname",value:c.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:t,attribute:"msid",value:`${l||"-"} ${u}`}),i&&(c.rtcp.cname&&this._mediaObject.ssrcs.push({id:i,attribute:"cname",value:c.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:i,attribute:"msid",value:`${l||"-"} ${u}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${t} ${i}`}));break}case"application":p?(this._mediaObject.payloads=r.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:r.port,maxMessageSize:r.maxMessageSize}):(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=r.port,this._mediaObject.maxMessageSize=r.maxMessageSize)}}setDtlsRole(e){switch(e){case"client":this._mediaObject.setup="active";break;case"server":this._mediaObject.setup="passive";break;case"auto":this._mediaObject.setup="actpass"}}planBReceive({offerRtpParameters:e,streamId:t,trackId:i}){const r=e.encodings[0],s=r.ssrc,o=r.rtx&&r.rtx.ssrc?r.rtx.ssrc:void 0;e.rtcp.cname&&this._mediaObject.ssrcs.push({id:s,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:s,attribute:"msid",value:`${t||"-"} ${i}`}),o&&(e.rtcp.cname&&this._mediaObject.ssrcs.push({id:o,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:o,attribute:"msid",value:`${t||"-"} ${i}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${s} ${o}`}))}planBStopReceiving({offerRtpParameters:e}){const t=e.encodings[0],i=t.ssrc,r=t.rtx&&t.rtx.ssrc?t.rtx.ssrc:void 0;this._mediaObject.ssrcs=this._mediaObject.ssrcs.filter(e=>e.id!==i&&e.id!==r),r&&(this._mediaObject.ssrcGroups=this._mediaObject.ssrcGroups.filter(e=>e.ssrcs!==`${i} ${r}`))}}},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Firefox60=void 0;const a=o(i(39)),d=i(7),c=o(i(20)),l=o(i(38)),u=o(i(74)),p=o(i(75)),h=i(52),f=i(76),m=i(14),g=n(i(1)),v=n(i(0)),y="Firefox60",_={OS:1024,MIS:1024};class S extends h.HandlerInterface{constructor(){super(),this._sendingRemoteRtpParametersByKind={},this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._transportReady=!1,this._appData={}}static createFactory(){return()=>new S}get name(){return"Firefox60"}close(){if(d.Logger.debug(y,"close()"),this._pc)try{this._pc.onconnectionstatechange=null,this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){d.Logger.debug(y,"getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();t.sdp=t.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack");try{e.close()}catch(e){}const i=a.parse(t.sdp);return u.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return d.Logger.debug(y,"getNativeSctpCapabilities()"),{numStreams:_}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:o,iceTransportPolicy:n,additionalSettings:a,proprietaryConstraints:c,extendedRtpCapabilities:u,appData:p}){d.Logger.debug(y,"run()",p),this._appData=p,this._direction=e,this._sendingRtpParametersByKind={audio:l.getSendingRtpParameters("audio",u),video:l.getSendingRtpParameters("video",u)},this._sendingRemoteRtpParametersByKind={audio:l.getSendingRemoteRtpParameters("audio",u),video:l.getSendingRemoteRtpParameters("video",u)},d.Logger.debug(y,"iceServers: %o",o);const h={iceServers:o||[],iceTransportPolicy:n||"all",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"};p.encodedInsertableStreams&&(h.encodedInsertableStreams=!0),this._pc=new RTCPeerConnection(h,c),this._pc.onconnectionstatechange=()=>{switch(this._pc.connectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}},this._pc.onicecandidate=e=>{},this._pc.onicecandidateerror=e=>{console.error("地址收集失败: ",e)}}async updateIceServers(e){d.Logger.debug(y,"updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(d.Logger.debug(y,"restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if(this._direction){const e=await this._pc.createOffer({iceRestart:!0});e.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(e.sdp=e.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#${this._direction}`));let t=a.parse(e.sdp);t.media.forEach(e=>{"audio"===e.type&&"send"===this._direction&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)))}),e.sdp=a.write(t),d.Logger.debug(y,"restartIce() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(e);const i={type:"answer",sdp:this._remoteSdp.getSdp()};d.Logger.debug(y,"restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};d.Logger.debug(y,"restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();d.Logger.debug(y,"restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,trackLow:t,encodings:i,codecOptions:r,codec:s,appData:o}){this._assertSendDirection(),d.Logger.debug(y,"send() [kind:%s, track.id:%s]",e.kind,e.id,i,o),i&&i.length>1&&i.forEach((e,t)=>{e.rid="r"+t});const n=c.clone(this._sendingRtpParametersByKind[e.kind],{});n.codecs=m.reduceCodecs(n.codecs,s);let l={},h={};const f=new MediaStream;"audio"===o.mediaType&&this._pc.audioSender?(d.Logger.debug(y,"audioSender更新track: ",this._pc.audioSender),this._pc.audioSender.replaceTrack(e)):"video"===o.mediaType&&this._pc.videoSender?(d.Logger.debug(y,"videoSender更新track: ",this._pc.videoSender),this._pc.videoSender.replaceTrack(e),this._pc.videoSenderLow&&t&&(d.Logger.debug(y,"videoSenderLow更新track: ",this._pc.videoSenderLow),this._pc.videoSenderLow.replaceTrack(t))):"screenShare"===o.mediaType&&this._pc.screenSender?(d.Logger.debug(y,"screenSender更新track: ",this._pc.screenSender),this._pc.screenSender.replaceTrack(e),this._pc.screenSenderLow&&t&&(d.Logger.debug(y,"screenSenderLow更新track: ",this._pc.screenSenderLow),this._pc.screenSenderLow.replaceTrack(t))):(f.addTrack(e),l=this._pc.addTransceiver(e,{direction:"sendonly",streams:[f],sendEncodings:i}),t&&(h=this._pc.addTransceiver(t,{direction:"sendonly",streams:[this._sendStream],sendEncodings:i})),"audio"!==o.mediaType||this._pc.audioSender?"video"!==o.mediaType||this._pc.videoSender?"screenShare"!==o.mediaType||this._pc.screenSender||(this._pc.screenSender=l.sender,this._pc.screenSenderLow=h.sender):(this._pc.videoSender=l.sender,this._pc.videoSenderLow=h.sender):this._pc.audioSender=l.sender),d.Logger.debug(y,"send() | [transceivers:%d]",this._pc.getTransceivers().length);let _=await this._pc.createOffer();_.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(_.sdp=_.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#send`));let S,b,R=a.parse(_.sdp),w=void 0;const T=R.media.filter(i=>{const r=this._mapMidTransceiver.get(""+i.mid);return i.type===e.kind&&(!(r&&r.sender&&r.sender.track)||(r.sender.track.id===e.id?(S=i,!1):!t||r.sender.track.id!==t.id||(b=i,!1)))});if(S||(S=T.pop()),t&&!b&&(b=T.pop()),!S)throw new g.default({code:v.default.NOT_FOUND,message:"offerMediaObject with track id not found: "+e.id});this._transportReady||(w=await this._setupTransport({localDtlsRole:"server",localSdpObject:R}));let A=S.mid;if("number"==typeof A&&(A=""+A),!A)throw new g.default({code:v.default.NOT_FOUND,message:"No localId"});let E=null;if(b&&(E=""+b.mid),n.mid=A,d.Logger.debug(y,"要检查M行: ",S),n.rtcp.cname=u.getCname({offerMediaObject:S}),i)if(1===i.length){let e=p.getRtpEncodings({offerMediaObject:S});Object.assign(e[0],i[0]),n.encodings=e}else n.encodings=i;else n.encodings=[],b&&(n.encodings=n.encodings.concat(p.getRtpEncodings({offerMediaObject:b}))),n.encodings=n.encodings.concat(p.getRtpEncodings({offerMediaObject:S}));return n.encodings.length>1&&("video/vp8"===n.codecs[0].mimeType.toLowerCase()||"video/h264"===n.codecs[0].mimeType.toLowerCase())&&R.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)))}),_.sdp=a.write(R),this._mapMidTransceiver.set(A,l),E&&this._mapMidTransceiver.set(E,h),{localId:A,localIdLow:E,rtpParameters:n,rtpSender:l.sender,rtpSenderLow:h.sender||null,dtlsParameters:w,offer:_}}async fillRemoteRecvSdp({kind:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,sendingRtpParameters:o,codecOptions:n,offer:l,audioProfile:u,codec:p}){d.Logger.debug(y,"fillRemoteRecvSdp() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(l),this._remoteSdp||(this._remoteSdp=new f.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s}),this._remoteSdp.updateDtlsRole("client"));const h=c.clone(this._sendingRemoteRtpParametersByKind[e]);h.codecs=m.reduceCodecs(h.codecs,p);let g=a.parse(this._pc.localDescription.sdp);const v=this._remoteSdp.getNextMediaSectionIdx();let _=g.media[v.idx],S=null;o.encodings&&o.encodings.length>1&&(S=g.media[v.idx+1]),this._remoteSdp.send({offerMediaObjectArr:[_,S],reuseMid:v.reuseMid,offerRtpParameters:o,answerRtpParameters:h,codecOptions:n,extmapAllowMixed:!0});const b={type:"answer",sdp:this._remoteSdp.getSdp()};if(d.Logger.debug(y,"audioProfile设置为: ",u),u){let e=null;switch(u){case"speech_low_quality":e="maxplaybackrate=16000;sprop-maxcapturerate=16000;maxaveragebitrate=32000";break;case"speech_standard":e="maxplaybackrate=32000;sprop-maxcapturerate=32000;maxaveragebitrate=36000";break;case"music_standard":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;";break;case"standard_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=56000";break;case"high_quality":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=128000";break;case"high_quality_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=192000"}b.sdp.indexOf("a=fmtp:111")&&(b.sdp=b.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;useinbandfec=1;"+e)),b.sdp=b.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=maxptime:60")}d.Logger.debug(y,"fillRemoteRecvSdp() | calling pc.setRemoteDescription() [answer]: ",b.sdp),await this._pc.setRemoteDescription(b)}async stopSending(e,t){var i,r;this._assertSendDirection(),d.Logger.debug(y,"stopSending() [localId:%s]",e);const s=this._mapMidTransceiver.get(e);if(!s)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});"audio"===t?this._pc.audioSender.replaceTrack(null):"video"===t?(this._pc.videoSender.replaceTrack(null),this._pc.videoSenderLow&&(null===(i=this._pc.videoSenderLow.track)||void 0===i||i.stop(),this._pc.videoSenderLow.replaceTrack(null))):"screenShare"===t?(this._pc.screenSender.replaceTrack(null),this._pc.screenSenderLow&&(null===(r=this._pc.screenSenderLow.track)||void 0===r||r.stop(),this._pc.screenSenderLow.replaceTrack(null))):s.sender.replaceTrack(null);const o=await this._pc.createOffer();o.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(o.sdp=o.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#send`));let n=a.parse(o.sdp);n.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)))}),o.sdp=a.write(n),d.Logger.debug(y,"stopSending() | calling pc.setLocalDescription()");try{await this._pc.setLocalDescription(o)}catch(e){d.Logger.debug(y,"setLocalDescription error = %o",e)}const c={type:"answer",sdp:this._remoteSdp.getSdp()};d.Logger.debug(y,"stopSending() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setRemoteDescription(c)}async replaceTrack(e,t){this._assertSendDirection(),t?d.Logger.debug(y,"replaceTrack() [localId:%s, track.id:%s]",e,t.id):d.Logger.debug(y,"replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this._assertSendDirection(),d.Logger.debug(y,"setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});const r=i.sender.getParameters();r.encodings.forEach((e,i)=>{e.active=i<=t}),await i.sender.setParameters(r)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),d.Logger.debug(y,"setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});const r=i.sender.getParameters();r.encodings.forEach((e,i)=>{r.encodings[i]=Object.assign(Object.assign({},e),t)}),await i.sender.setParameters(r)}async getSenderStats(e){this._assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});return t.sender.getStats()}async recoverTransceiver(e,t,i){d.Logger.debug(y,"recoverTransceiver() [kind:%s, remoteUid:%s, mid: %s]",i,e,t);const r=this._mapMidTransceiver.get(t);r?r.isUseless=!0:d.Logger.debug(y,"recoverTransceiver() transceiver undefined")}async prepareLocalSdp(e,t){d.Logger.debug(y,"prepareLocalSdp() [kind:%s, remoteUid:%s]",e,t);let i=-1;for(const t of this._mapMidTransceiver.keys()){const r=this._mapMidTransceiver.get(t);if(!r)continue;const s=r.receiver&&r.receiver.track&&r.receiver.track.kind||e;if(d.Logger.debug(y,"prepareLocalSdp() transceiver M行信息 [mid: %s, mediaType: %s, isUseless: %s]",r.mid||t,s,r.isUseless),r.isUseless&&s===e){i=t-0,r.isUseless=!1;break}}let r=this._pc.localDescription,s=null;-1===i&&(d.Logger.debug(y,"prepareLocalSdp() 添加一个M行"),s=this._pc.addTransceiver(e,{direction:"recvonly"}),r=await this._pc.createOffer(),r.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(r.sdp=r.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#recv`),r.sdp=r.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack")),d.Logger.debug(y,"prepareLocalSdp() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(r));const o=a.parse(r.sdp);let n=void 0;this._transportReady||(n=await this._setupTransport({localDtlsRole:"server",localSdpObject:o}));const c=u.extractRtpCapabilities({sdpObject:o});return-1===i&&(i=o.media.length-1,this._mapMidTransceiver.set(""+i,s)),{dtlsParameters:n,rtpCapabilities:c,offer:r,mid:i,iceUfragReg:""}}async receive({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,trackId:s,kind:o,rtpParameters:n,offer:c,probeSSrc:l=-1,remoteUid:u,extendedRtpCapabilities:p}){this._assertRecvDirection(),d.Logger.debug(y,"receive() [trackId: %s, kind: %s, remoteUid: %s]",s,o,u),this._remoteSdp||(this._remoteSdp=new f.RemoteSdp({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r}),this._remoteSdp.updateDtlsRole("client"));const h=n.mid;if(d.Logger.debug(y,"处理对端的M行 mid: ",h),!h)throw new g.default({code:v.default.NOT_FOUND,message:"No localId"});const m=this._pc.getTransceivers().length,_=this._remoteSdp._mediaSections.length+1;if(d.Logger.debug(y,`offerMediaSessionLength: ${m}，answerMediaSessionLength: ${_}`),m<_);else if(m>_){d.Logger.debug(y,"mediaSession 不匹配, 兼容处理");const e=[];a.parse(c.sdp).media.forEach(t=>{let i=!1;this._remoteSdp._mediaSections.forEach(e=>{t.mid!=e.mid||(i=!0)}),i||e.push({mid:t.mid,kind:t.type})}),d.Logger.debug(y,"receive() 检索出来了缺失的media Session: ",e),e.forEach(e=>{this._remoteSdp.receive({mid:""+e.mid,kind:e.kind,offerRtpParameters:{codecs:p.codecs.filter(t=>t.kind==e.kind),encodings:[{ssrc:0}],headerExtensions:[],rtcp:{},mid:""+e.mid}}),this._remoteSdp.disableMediaSection(""+e.mid)})}c.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(c.sdp=c.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#recv`),c.sdp=c.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack")),this._remoteSdp.receive({mid:h,kind:o,offerRtpParameters:n,streamId:n.rtcp.cname,trackId:s,reuseMid:null});const S={type:"answer",sdp:this._remoteSdp.getSdp()};if(d.Logger.debug(y,"receive() | calling pc.setRemoteDescription() [answer]: ",S.sdp),"stable"===this._pc.signalingState){await this._pc.createOffer();await this._pc.setLocalDescription(c),d.Logger.debug(y,"receive() | calling pc.setLocalDescription()")}await this._pc.setRemoteDescription(S);const b=this._pc.getTransceivers().find(e=>e.mid===h);if(!b)throw new g.default({code:v.default.NOT_FOUND,message:"new RTCRtpTransceiver not found"});return this._mapMidTransceiver.set(h,b),{localId:h,track:b.receiver.track,rtpReceiver:b.receiver}}async stopReceiving(e){this._assertRecvDirection(),d.Logger.debug(y,"stopReceiving() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t||!t.mid)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});t.receiver&&t.receiver.track&&t.receiver.track&&"audio"===t.receiver.track.kind||(t.isUseless=!0),this._remoteSdp.disableMediaSection(t.mid);const i=this._pc.localDescription;i.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(i.sdp=i.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#recv`)),d.Logger.debug(y,"stopReceiving() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(i);const r={type:"answer",sdp:this._remoteSdp.getSdp()};d.Logger.debug(y,"stopReceiving() | calling pc.setRemoteDescription() [answer:%s]",r.sdp),await this._pc.setRemoteDescription(r)}async getReceiverStats(e){this._assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});return t.receiver.getStats()}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=a.parse(this._pc.localDescription.sdp));const i=u.extractDtlsParameters({sdpObject:t});return i.role=e,this._transportReady=!0,i}_assertSendDirection(){if("send"!==this._direction)throw new g.default({code:v.default.INVALID_OPERATION,message:'method can just be called for handlers with "send" direction'})}_assertRecvDirection(){if("recv"!==this._direction)throw new g.default({code:v.default.INVALID_OPERATION,message:'method can just be called for handlers with "recv" direction'})}}t.Firefox60=S},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Safari12=void 0;const a=o(i(39)),d=i(7),c=o(i(20)),l=o(i(38)),u=o(i(74)),p=o(i(75)),h=i(52),f=i(76),m=i(14),g=n(i(1)),v=n(i(0)),y=i(214),_="Safari12",S={OS:1024,MIS:1024};class b extends h.HandlerInterface{constructor(){super(),this._sendingRemoteRtpParametersByKind={},this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._transportReady=!1,this._appData={}}static createFactory(){return()=>new b}get name(){return"Safari12"}close(){if(d.Logger.debug(_,"close()"),this._pc)try{this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){d.Logger.debug(_,"getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();t.sdp=t.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack");try{e.close()}catch(e){}const i=a.parse(t.sdp);return u.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return d.Logger.debug(_,"getNativeSctpCapabilities()"),{numStreams:S}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:o,iceTransportPolicy:n,additionalSettings:a,proprietaryConstraints:c,extendedRtpCapabilities:u,appData:p}){d.Logger.debug(_,"run()"),this._direction=e,this._appData=p,this._sendingRtpParametersByKind={audio:l.getSendingRtpParameters("audio",u),video:l.getSendingRtpParameters("video",u)},this._sendingRemoteRtpParametersByKind={audio:l.getSendingRemoteRtpParameters("audio",u),video:l.getSendingRemoteRtpParameters("video",u)},this._pc=new RTCPeerConnection(Object.assign({iceServers:o||[],iceTransportPolicy:n||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"},a),c),this._pc.onconnectionstatechange=()=>{switch(this._pc.connectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}}}async updateIceServers(e){d.Logger.debug(_,"updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(d.Logger.debug(_,"restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if(this._direction){const e=await this._pc.createOffer({iceRestart:!0});e.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(e.sdp=e.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#${this._direction}`));let t=a.parse(e.sdp);t.media.forEach(e=>{"audio"===e.type&&"send"===this._direction&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)))}),e.sdp=a.write(t),d.Logger.debug(_,"restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const i={type:"answer",sdp:this._remoteSdp.getSdp()};d.Logger.debug(_,"restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};d.Logger.debug(_,"restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();d.Logger.debug(_,"restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,trackLow:t,encodings:i,codecOptions:r,codec:s,appData:o}){this._assertSendDirection(),d.Logger.debug(_,"send() [kind:%s, track.id:%s]",e.kind,e.id,i,o);const n=c.clone(this._sendingRtpParametersByKind[e.kind],{});n.codecs=m.reduceCodecs(n.codecs,s);let l={},h={};const f=new MediaStream;"audio"===o.mediaType&&this._pc.audioSender?(d.Logger.warn(_,"audioSender更新track: ",this._pc.audioSender.track,"=>",e),this._pc.audioSender.replaceTrack(e)):"video"===o.mediaType&&this._pc.videoSender?(d.Logger.warn(_,"videoSender更新track: ",this._pc.videoSender.track,"=>",e),this._pc.videoSender.replaceTrack(e),this._pc.videoSenderLow&&t&&(d.Logger.debug(_,"videoSenderLow更新track: ",this._pc.videoSenderLow),this._pc.videoSenderLow.replaceTrack(t))):"screenShare"===o.mediaType&&this._pc.screenSender?(d.Logger.warn(_,"screenSender更新track: ",this._pc.screenSender.track,"=>",e),this._pc.screenSender.replaceTrack(e),this._pc.screenSenderLow&&t&&(d.Logger.debug(_,"screenSenderLow更新track: ",this._pc.screenSenderLow),this._pc.screenSenderLow.replaceTrack(t))):(f.addTrack(e),l=this._pc.addTransceiver(e,{direction:"sendonly",streams:[f],sendEncodings:i}),t&&(h=this._pc.addTransceiver(t,{direction:"sendonly",streams:[this._sendStream],sendEncodings:i})),"audio"!==o.mediaType||this._pc.audioSender?"video"!==o.mediaType||this._pc.videoSender?"screenShare"!==o.mediaType||this._pc.screenSender||(this._pc.screenSender=l.sender,this._pc.screenSenderLow=h.sender):(this._pc.videoSender=l.sender,this._pc.videoSenderLow=h.sender):this._pc.audioSender=l.sender),"audio"!==o.mediaType||this._pc.audioSender?"video"!==o.mediaType||this._pc.videoSender?"screenShare"!==o.mediaType||this._pc.screenSender||(this._pc.screenSender=l.sender):this._pc.videoSender=l.sender:this._pc.audioSender=l.sender,d.Logger.debug(_,"send() | [transceivers:%d]",this._pc.getTransceivers().length);let y=await this._pc.createOffer();y.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(y.sdp=y.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#send`));let S,b,R=a.parse(y.sdp),w=void 0;const T=R.media.filter(i=>{const r=this._mapMidTransceiver.get(""+i.mid);return i.type===e.kind&&(!(r&&r.sender&&r.sender.track)||(r.sender.track.id===e.id?(S=i,!1):!t||r.sender.track.id!==t.id||(b=i,!1)))});if(S||(S=T.pop()),t&&!b&&(b=T.pop()),!S)throw new g.default({code:v.default.NOT_FOUND,message:"offerMediaObject with track id not found: "+e.id});this._transportReady||(w=await this._setupTransport({localDtlsRole:"server",localSdpObject:R}));let A=S.mid;if("number"==typeof A&&(A=""+A),!A)throw new g.default({code:v.default.NOT_FOUND,message:"No localId"});let E=null;if(b&&(E=""+b.mid),n.mid=A,d.Logger.debug(_,"要检查M行: ",S),n.rtcp.cname=u.getCname({offerMediaObject:S}),i)if(1===i.length){let e=p.getRtpEncodings({offerMediaObject:S});Object.assign(e[0],i[0]),n.encodings=e}else n.encodings=i;else n.encodings=[],b&&(n.encodings=n.encodings.concat(p.getRtpEncodings({offerMediaObject:b}))),n.encodings=n.encodings.concat(p.getRtpEncodings({offerMediaObject:S}));return n.encodings.length>1&&("video/vp8"===n.codecs[0].mimeType.toLowerCase()||"video/h264"===n.codecs[0].mimeType.toLowerCase())&&R.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)))}),y.sdp=a.write(R),this._mapMidTransceiver.set(A,l),E&&this._mapMidTransceiver.set(E,h),{localId:A,localIdLow:E,rtpParameters:n,rtpSender:l.sender,rtpSenderLow:h.sender||null,dtlsParameters:w,offer:y}}async fillRemoteRecvSdp({kind:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,sendingRtpParameters:o,codecOptions:n,offer:l,audioProfile:u,codec:p}){let h=a.parse(l.sdp);h.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)))}),l.sdp=a.write(h),d.Logger.debug(_,"fillRemoteRecvSdp() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(l),this._remoteSdp||(this._remoteSdp=new f.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s}),this._remoteSdp.updateDtlsRole("client"));const g=c.clone(this._sendingRemoteRtpParametersByKind[e]);g.codecs=m.reduceCodecs(g.codecs,p);let v=a.parse(this._pc.localDescription.sdp);const S=this._remoteSdp.getNextMediaSectionIdx();let b=v.media[S.idx],R=null;o.encodings&&o.encodings.length>1&&(R=v.media[S.idx+1]),this._remoteSdp.send({offerMediaObjectArr:[b,R],reuseMid:S.reuseMid,offerRtpParameters:o,answerRtpParameters:g,codecOptions:n,extmapAllowMixed:!0});const w={type:"answer",sdp:this._remoteSdp.getSdp()};if(d.Logger.debug(_,"audioProfile设置为: ",u),u){let e=null;switch(u){case"speech_low_quality":e="maxplaybackrate=16000;sprop-maxcapturerate=16000;maxaveragebitrate=32000";break;case"speech_standard":e="maxplaybackrate=32000;sprop-maxcapturerate=32000;maxaveragebitrate=36000";break;case"music_standard":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;";break;case"standard_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=56000";break;case"high_quality":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=128000";break;case"high_quality_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=192000"}w.sdp.indexOf("a=fmtp:111")&&(w.sdp=w.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;useinbandfec=1;"+e)),w.sdp=w.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=maxptime:60")}y.canShimVideoOrientation(l,w)&&y.shimVideoOrientation(l,w),d.Logger.debug(_,"fillRemoteRecvSdp() | calling pc.setRemoteDescription() [answer:%o]",w.sdp),await this._pc.setRemoteDescription(w)}async stopSending(e,t){var i,r;this._assertSendDirection(),d.Logger.debug(_,"stopSending() [localId:%s]",e);const s=this._mapMidTransceiver.get(e);if(!s)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});"audio"===t?(this._pc.audioSender.replaceTrack(null),d.Logger.debug(_,"删除发送的audio track: ",this._pc.audioSender)):"video"===t?(this._pc.videoSenderLow&&(null===(i=this._pc.videoSenderLow.track)||void 0===i||i.stop(),this._pc.videoSenderLow.replaceTrack(null)),this._pc.videoSender.replaceTrack(null),d.Logger.debug(_,"删除发送的video track: ",this._pc.videoSender)):"screenShare"===t?(this._pc.screenSender.replaceTrack(null),this._pc.screenSenderLow&&(null===(r=this._pc.screenSenderLow.track)||void 0===r||r.stop(),this._pc.screenSenderLow.replaceTrack(null)),d.Logger.debug(_,"删除发送的screen track: ",this._pc.screenSender)):s.sender.replaceTrack(null);const o=await this._pc.createOffer();o.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(o.sdp=o.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#send`));let n=a.parse(o.sdp);n.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)))}),o.sdp=a.write(n),d.Logger.debug(_,"stopSending() | calling pc.setLocalDescription() [offer:%o]",o.sdp),await this._pc.setLocalDescription(o);const c={type:"answer",sdp:this._remoteSdp.getSdp()};d.Logger.debug(_,"stopSending() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setRemoteDescription(c)}async replaceTrack(e,t){this._assertSendDirection(),t?d.Logger.debug(_,"replaceTrack() [localId:%s, track.id:%s]",e,t.id):d.Logger.debug(_,"replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this._assertSendDirection(),d.Logger.debug(_,"setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});const r=i.sender.getParameters();r.encodings.forEach((e,i)=>{e.active=i<=t}),await i.sender.setParameters(r)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),d.Logger.debug(_,"setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});const r=i.sender.getParameters();r.encodings.forEach((e,i)=>{r.encodings[i]=Object.assign(Object.assign({},e),t)}),await i.sender.setParameters(r)}async getSenderStats(e){this._assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});return t.sender.getStats()}async recoverTransceiver(e,t,i){d.Logger.debug(_,"recoverTransceiver() [kind:%s, remoteUid:%s, mid: %s]",i,e,t);const r=this._mapMidTransceiver.get(t);r?r.isUseless=!0:d.Logger.debug(_,"recoverTransceiver() transceiver undefined")}async prepareLocalSdp(e,t){d.Logger.debug(_,"prepareLocalSdp() [kind:%s, remoteUid:%s]",e,t);let i=-1;for(const t of this._mapMidTransceiver.keys()){const r=this._mapMidTransceiver.get(t);if(!r)continue;const s=r.receiver&&r.receiver.track&&r.receiver.track.kind||e;if(d.Logger.debug(_,"prepareLocalSdp() transceiver M行信息 [mid: %s, mediaType: %s, isUseless: %s]",r.mid||t,s,r.isUseless),r.isUseless&&s===e){i=t-0,r.isUseless=!1;break}}let r=this._pc.localDescription,s=null;-1===i&&(d.Logger.debug(_,"prepareLocalSdp() 添加一个M行"),s=this._pc.addTransceiver(e,{direction:"recvonly"}),r=await this._pc.createOffer(),r.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(r.sdp=r.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#recv`),r.sdp=r.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack")),d.Logger.debug(_,"prepareLocalSdp() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(r));const o=a.parse(r.sdp);let n=void 0;this._transportReady||(n=await this._setupTransport({localDtlsRole:"server",localSdpObject:o}));const c=u.extractRtpCapabilities({sdpObject:o});return-1===i&&(i=o.media.length-1,this._mapMidTransceiver.set(""+i,s)),{dtlsParameters:n,rtpCapabilities:c,offer:r,mid:i,iceUfragReg:""}}async receive({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,trackId:s,kind:o,rtpParameters:n,offer:c,probeSSrc:l=-1,remoteUid:u,extendedRtpCapabilities:p}){if(this._assertRecvDirection(),!n.mid)throw new g.default({code:v.default.NOT_FOUND,message:"No rtpParameters.mid"});d.Logger.debug(_,"receive() [trackId: %s, kind: %s, remoteUid: %s]",s,o,u),this._remoteSdp||(this._remoteSdp=new f.RemoteSdp({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r}),this._remoteSdp.updateDtlsRole("client"));const h=n.mid;d.Logger.debug(_,"处理对端的M行 mid: ",h);const m=this._pc.getTransceivers().length,y=this._remoteSdp._mediaSections.length+1;if(d.Logger.debug(_,`offerMediaSessionLength: ${m}，answerMediaSessionLength: ${y}`),m<y);else if(m>y){d.Logger.debug(_,"mediaSession 不匹配, 兼容处理");const e=[];a.parse(c.sdp).media.forEach(t=>{let i=!1;this._remoteSdp._mediaSections.forEach(e=>{t.mid!=e.mid||(i=!0)}),i||e.push({mid:t.mid,kind:t.type})}),d.Logger.debug(_,"receive() 检索出来了缺失的media Session: ",e),e.forEach(e=>{this._remoteSdp.receive({mid:""+e.mid,kind:e.kind,offerRtpParameters:{codecs:p.codecs.filter(t=>t.kind==e.kind),encodings:[{ssrc:0}],headerExtensions:[],rtcp:{},mid:""+e.mid}}),this._remoteSdp.disableMediaSection(""+e.mid)})}c.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(c.sdp=c.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#recv`),c.sdp=c.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack")),this._remoteSdp.receive({mid:n.mid,kind:o,offerRtpParameters:n,streamId:n.rtcp.cname,trackId:s});const S={type:"answer",sdp:this._remoteSdp.getSdp()};d.Logger.debug(_,"receive() | calling pc.setRemoteDescription() [answer]: ",S.sdp),"stable"===this._pc.signalingState&&(await this._pc.setLocalDescription(c),d.Logger.debug(_,"receive() | calling pc.setLocalDescription()")),await this._pc.setRemoteDescription(S);const b=this._pc.getTransceivers().find(e=>e.mid===h);if(!b)throw new g.default({code:v.default.NOT_FOUND,message:"new RTCRtpTransceiver not found"});return this._mapMidTransceiver.set(h,b),{localId:h,track:b.receiver.track,rtpReceiver:b.receiver}}async stopReceiving(e){this._assertRecvDirection(),d.Logger.debug(_,"stopReceiving() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t||!t.mid)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});d.Logger.debug(_,"transceiver: ",t),t.receiver&&t.receiver.track&&t.receiver.track&&"audio"===t.receiver.track.kind||(t.isUseless=!0),this._remoteSdp.disableMediaSection(t.mid);const i=this._pc.localDescription;i.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(i.sdp=i.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#recv`)),d.Logger.debug(_,"stopReceiving() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(i);const r={type:"answer",sdp:this._remoteSdp.getSdp()};d.Logger.debug(_,"stopReceiving() | calling pc.setRemoteDescription() [answer:%o]",r.sdp),await this._pc.setRemoteDescription(r)}async getReceiverStats(e){this._assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new g.default({code:v.default.NOT_FOUND,message:"associated RTCRtpTransceiver not found"});return t.receiver.getStats()}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=a.parse(this._pc.localDescription.sdp));const i=u.extractDtlsParameters({sdpObject:t});return i.role=e,this._transportReady=!0,i}_assertSendDirection(){if("send"!==this._direction)throw new g.default({code:v.default.INVALID_OPERATION,message:'method can just be called for handlers with "send" direction'})}_assertRecvDirection(){if("recv"!==this._direction)throw new g.default({code:v.default.INVALID_OPERATION,message:'method can just be called for handlers with "recv" direction'})}}t.Safari12=b},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.shimVideoOrientation=t.canShimVideoOrientation=void 0;const r=i(27),s=i(2),o="a=extmap:4 ";t.canShimVideoOrientation=function(e,t){var i,n,a;if("never"===s.getParameters().shimVideoOrientation)return!1;if("ios151"===s.getParameters().shimVideoOrientation){if(!r.RtcSystem.ios())return!1;if("safari"===(null===(i=r.RtcSystem.browser)||void 0===i?void 0:i.ua)){if(parseFloat(null===(n=r.RtcSystem.browser)||void 0===n?void 0:n.UIVersion)<15.1)return!1}else{if("weixin"!==(null===(a=r.RtcSystem.browser)||void 0===a?void 0:a.ua))return!1;if(!navigator.userAgent.match(/OS 15_[1-9]/))return!1}}if(-1===t.sdp.indexOf("H264")||-1===t.sdp.indexOf("m=video"))return!1;const d=e.sdp.match(/\r\n(.*3gpp\:video-orientation.*)\r\n/);return!!(d&&e.sdp.indexOf(o)>-1&&-1===t.sdp.indexOf(d[1]))},t.shimVideoOrientation=function(e,t){var i;if(-1===t.sdp.indexOf("H264")||-1===t.sdp.indexOf("m=video"))return;const s=e.sdp.match(/\r\n(.*3gpp\:video-orientation.*)\r\n/);if(s&&e.sdp.indexOf(o)>-1&&-1===t.sdp.indexOf(s[1])){const e=s[1];console.log(`shimVideoOrientation for ${r.RtcSystem.browser.ua} ${null===(i=r.RtcSystem.browser)||void 0===i?void 0:i.UIVersion} ${e}`),t.sdp=t.sdp.split(o).join(e+"\r\n"+o)}else console.error("Failed to shimVideoOrientation",s,e.sdp.indexOf(o),s&&t.sdp.indexOf(s[1]))}},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||r(t,e,i)};Object.defineProperty(t,"__esModule",{value:!0}),s(i(116),t),s(i(118),t),s(i(119),t),s(i(120),t),s(i(216),t),s(i(217),t),s(i(52),t),s(i(37),t)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parse=void 0;const r=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");t.parse=function(e){const t=r.exec(e||"");return t?{spatialLayers:Number(t[1]),temporalLayers:Number(t[2])}:{spatialLayers:1,temporalLayers:1}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.waitForEvent=void 0,t.waitForEvent=async function(e,t,i){return new Promise((r,s)=>{let o;const n=e=>{o&&clearTimeout(o),r(e)};i&&(o=setTimeout(()=>{e.removeListener(t,n),s(`timed out after ${i}ms:${t}`)},i)),e.once(t,n)})}},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.StatsReport=void 0;const a=i(3),d=i(221),c=i(222),l=n(i(223)),u=n(i(224)),p=o(i(13)),h=i(22),f=i(123),m=n(i(245)),g=i(246),v=f.generateUUID(),y=(new Date).getTime();class _ extends a.EventEmitter{constructor(e){super(),this._reset(),this.heartbeat_=-1,this.wsTransport_=null,this.sdkRef=e.sdkRef,this.adapterRef=e.adapterRef,this.prevStats_={},this.appKey=this.adapterRef.instance._params.appkey||this.adapterRef.channelInfo&&this.adapterRef.channelInfo.appKey||"",this.isStartGetStats=!1,this.stats=new d.GetStats({adapterRef:this.adapterRef,interval:1e3}),this.stats.on("stats",(e,t)=>{this.formativeStatsReport&&this.formativeStatsReport.update(e,t)}),this.formativeStatsReport=new c.FormativeStatsReport({adapterRef:this.adapterRef,sdkRef:this.sdkRef,appkey:this.appKey})}_reset(){this.stats&&this.stats.destroy(),this.stats=null,this.formativeStatsReport&&this.formativeStatsReport.destroy(),this.formativeStatsReport=null,this.stopHeartbeat()}stop(){this.stats&&this.stats.stop(),this.formativeStatsReport&&this.formativeStatsReport.stop()}statsStart(){this.formativeStatsReport&&(this.isStartGetStats=!0,this.formativeStatsReport.start())}start(){let e=g(`0${y}${h.SDK_VERSION}webwebrtc${v}40f5a1a1871e46089e1e5139a779dd77`),t=`wss://statistic.live.126.net/lps-websocket/websocket/collect?deviceId=${v}&isTest=0&sdkVer=${h.SDK_VERSION}&sdktype=webrtc&timestamp=${y}&platform=web&checkSum=${e}`;this.wsTransport_=window.wsTransport=new u.default({url:t,adapterRef:this.adapterRef}),this.wsTransport_.init()}startHeartbeat(){if(-1===this.heartbeat_){const e=2e3;this.adapterRef.logger.log("startHeartbeat..."),this.heartbeat_=l.default.setInterval(this.doHeartbeat.bind(this),e)}}stopHeartbeat(){-1!==this.heartbeat_&&(l.default.clearInterval(this.heartbeat_),this.heartbeat_=-1)}async doHeartbeat(){var e;try{if(this.isStartGetStats){let t=await(null===(e=this.stats)||void 0===e?void 0:e.getAllStats()),i=this.calculateReport(t);this.wsTransport_.sendPB(i)}}catch(e){this.adapterRef.logger.error("getStats失败：",e)}}calculateReport(e){if(p.IS_CHROME||p.IS_EDG){let a=e.local.audio_ssrc?e.local.audio_ssrc:[],d=e.local.video_ssrc?e.local.video_ssrc:[],c=e.local.screen_ssrc?e.local.screen_ssrc:[],l=e.remote.audio_ssrc?e.remote.audio_ssrc:[],u=e.remote.video_ssrc?e.remote.video_ssrc:[],p=e.remote.screen_ssrc?e.remote.screen_ssrc:[];if(!m.default(this.prevStats_))var t=this.prevStats_.local.audio_ssrc?this.prevStats_.local.audio_ssrc:[],i=this.prevStats_.local.video_ssrc?this.prevStats_.local.video_ssrc:[],r=this.prevStats_.local.screen_ssrc?this.prevStats_.local.screen_ssrc:[],s=this.prevStats_.remote.audio_ssrc?this.prevStats_.remote.audio_ssrc:[],o=this.prevStats_.remote.video_ssrc?this.prevStats_.remote.video_ssrc:[],n=this.prevStats_.remote.screen_ssrc?this.prevStats_.remote.screen_ssrc:[];if(m.default(this.prevStats_)||a.length!==t.length||d.length!==i.length||c.length!==r.length||l.length!==s.length||u.length!==o.length||p.length!==n.length){this.prevStats_=e,Object.keys(this.prevStats_.local).length&&(this.prevStats_.local.audio_ssrc&&(this.prevStats_.local.audio_ssrc[0].bytesSentPerSecond=this.prevStats_.local.audio_ssrc[0].bytesSent),this.prevStats_.local.video_ssrc&&(this.prevStats_.local.video_ssrc[0].bytesSentPerSecond=this.prevStats_.local.video_ssrc[0].bytesSent),this.prevStats_.local.video_ssrc&&(this.prevStats_.local.video_ssrc[0].framesEncodedPerSecond=this.prevStats_.local.video_ssrc[0].framesEncoded),this.prevStats_.local.screen_ssrc&&(this.prevStats_.local.screen_ssrc[0].bytesSentPerSecond=this.prevStats_.local.screen_ssrc[0].bytesSent),this.prevStats_.local.screen_ssrc&&(this.prevStats_.local.screen_ssrc[0].framesEncodedPerSecond=this.prevStats_.local.screen_ssrc[0].framesEncoded));for(let e in this.prevStats_.remote)if(e.indexOf("ssrc")>-1)for(let t=0;t<this.prevStats_.remote[e].length;t++)this.prevStats_.remote[e][t].bytesReceivedPerSecond=this.prevStats_.remote[e][t].bytesReceived,this.prevStats_.remote[e][t].packetsLostPerSecond=this.prevStats_.remote[e][t].packetsLost,"video"===this.prevStats_.remote[e][t].mediaType&&(this.prevStats_.remote[e][t].framesDecodedPerSecond=Math.round(this.prevStats_.remote[e][t].framesDecoded))}else{let t=e.local,i=this.prevStats_.local,r=e.remote,s=this.prevStats_.remote;Object.keys(t).length&&(t.audio_ssrc&&(t.audio_ssrc[0].bytesSentPerSecond=(t.audio_ssrc[0].bytesSent-0-i.audio_ssrc[0].bytesSent)/2),t.video_ssrc&&(t.video_ssrc[0].bytesSentPerSecond=(t.video_ssrc[0].bytesSent-0-i.video_ssrc[0].bytesSent)/2),t.video_ssrc&&(t.video_ssrc[0].framesEncodedPerSecond=(t.video_ssrc[0].framesEncoded-0-i.video_ssrc[0].framesEncoded)/2),t.screen_ssrc&&(t.screen_ssrc[0].bytesSentPerSecond=(t.screen_ssrc[0].bytesSent-0-i.screen_ssrc[0].bytesSent)/2),t.screen_ssrc&&(t.screen_ssrc[0].framesEncodedPerSecond=(t.screen_ssrc[0].framesEncoded-0-i.screen_ssrc[0].framesEncoded)/2));for(let e in r)if(e.indexOf("ssrc")>-1)for(let t=0;t<r[e].length;t++)r[e][t].bytesReceivedPerSecond=(r[e][t].bytesReceived-0-s[e][t].bytesReceived)/2,r[e][t].packetsLostPerSecond=(r[e][t].packetsLost-0-s[e][t].packetsLost)/2,"video"===this.prevStats_.remote[e][t].mediaType&&(r[e][t].framesDecodedPerSecond=Math.round((r[e][t].framesDecoded-0-s[e][t].framesDecoded)/2))}}else if(p.IS_SAFARI){let t=e.local.audio_outbound_rtp?e.local.audio_outbound_rtp:[],i=e.local.video_outbound_rtp?e.local.video_outbound_rtp:[],r=e.local.video_track?e.local.video_track:[],s=e.remote.audio_inbound_rtp?e.remote.audio_inbound_rtp:[],o=e.remote.video_inbound_rtp?e.remote.video_inbound_rtp:[],n=e.remote.video_track?e.remote.video_track:[];if(!m.default(this.prevStats_))var a=this.prevStats_.local.audio_outbound_rtp?this.prevStats_.local.audio_outbound_rtp:[],d=this.prevStats_.local.video_outbound_rtp?this.prevStats_.local.video_outbound_rtp:[],c=this.prevStats_.local.video_track?this.prevStats_.local.video_track:[],l=this.prevStats_.remote.audio_inbound_rtp?this.prevStats_.remote.audio_inbound_rtp:[],u=this.prevStats_.remote.video_inbound_rtp?this.prevStats_.remote.video_inbound_rtp:[],h=this.prevStats_.remote.video_track?this.prevStats_.remote.video_track:[];if(m.default(this.prevStats_)||t.length!==a.length||i.length!==d.length||r.length!==c.length||s.length!==l.length||o.length!==u.length||n.length!==h.length){this.prevStats_=e,Object.keys(this.prevStats_.local).length&&(this.prevStats_.local.audio_outbound_rtp&&(this.prevStats_.local.audio_outbound_rtp[0].bytesSentPerSecond=this.prevStats_.local.audio_outbound_rtp[0].bytesSent),this.prevStats_.local.video_outbound_rtp&&(this.prevStats_.local.video_outbound_rtp[0].bytesSentPerSecond=this.prevStats_.local.video_outbound_rtp[0].bytesSent),this.prevStats_.local.video_outbound_rtp&&(this.prevStats_.local.video_outbound_rtp[0].framesEncodedPerSecond=this.prevStats_.local.video_outbound_rtp[0].framesEncoded),this.prevStats_.local.video_track&&(this.prevStats_.local.video_track[0].framesSentPerSecond=this.prevStats_.local.video_track[0].framesSent));for(let e in this.prevStats_.remote)if(e.indexOf("inbound_rtp")>-1)for(let t=0;t<this.prevStats_.remote[e].length;t++)this.prevStats_.remote[e][t].bytesReceivedPerSecond=this.prevStats_.remote[e][t].bytesReceived,this.prevStats_.remote[e][t].packetsLostPerSecond=this.prevStats_.remote[e][t].packetsLost,"video"===this.prevStats_.remote[e][t].mediaType&&(this.prevStats_.remote[e][t].framesDecodedPerSecond=Math.round(this.prevStats_.remote[e][t].framesDecoded))}else{let t=e.local,i=this.prevStats_.local,r=e.remote,s=this.prevStats_.remote;Object.keys(t).length&&(t.audio_outbound_rtp&&(t.audio_outbound_rtp[0].bytesSentPerSecond=(t.audio_outbound_rtp[0].bytesSent-0-i.audio_outbound_rtp[0].bytesSent)/2),t.video_outbound_rtp&&(t.video_outbound_rtp[0].bytesSentPerSecond=(t.video_outbound_rtp[0].bytesSent-0-i.video_outbound_rtp[0].bytesSent)/2),t.video_outbound_rtp&&(t.video_outbound_rtp[0].framesEncodedPerSecond=(t.video_outbound_rtp[0].framesEncoded-0-i.video_outbound_rtp[0].framesEncoded)/2),t.video_track&&(t.video_track[0].framesSentPerSecond=Math.round((t.video_track[0].framesSent-0-i.video_track[0].framesSent)/2)));for(let e in r)if(e.indexOf("inbound_rtp")>-1)for(let t=0;t<r[e].length;t++)r[e][t].bytesReceivedPerSecond=(r[e][t].bytesReceived-0-s[e][t].bytesReceived)/2,r[e][t].packetsLostPerSecond=(r[e][t].packetsLost-0-s[e][t].packetsLost)/2,"video"===this.prevStats_.remote[e][t].mediaType&&(r[e][t].framesDecodedPerSecond=Math.round((r[e][t].framesDecoded-0-s[e][t].framesDecoded)/2))}}else if(p.IS_FIREFOX){let a=e.local.audio_outbound_rtp?e.local.audio_outbound_rtp:[],d=e.local.video_outbound_rtp?e.local.video_outbound_rtp:[],c=e.local.screen_outbound_rtp?e.local.screen_outbound_rtp:[],l=e.remote.audio_inbound_rtp?e.remote.audio_inbound_rtp:[],u=e.remote.video_inbound_rtp?e.remote.video_inbound_rtp:[],p=e.remote.screen_inbound_rtp?e.remote.screen_inbound_rtp:[];if(!m.default(this.prevStats_))t=this.prevStats_.local.audio_outbound_rtp?this.prevStats_.local.audio_outbound_rtp:[],i=this.prevStats_.local.video_outbound_rtp?this.prevStats_.local.video_outbound_rtp:[],r=this.prevStats_.local.screen_outbound_rtp?this.prevStats_.local.screen_outbound_rtp:[],s=this.prevStats_.remote.audio_inbound_rtp?this.prevStats_.remote.audio_inbound_rtp:[],o=this.prevStats_.remote.video_inbound_rtp?this.prevStats_.remote.video_inbound_rtp:[],n=this.prevStats_.remote.screen_inbound_rtp?this.prevStats_.remote.screen_inbound_rtp:[];if(m.default(this.prevStats_)||a.length!==t.length||d.length!==i.length||c.length!==r.length||l.length!==s.length||u.length!==o.length||p.length!==n.length){this.prevStats_=e,Object.keys(this.prevStats_.local).length&&(this.prevStats_.local.audio_outbound_rtp&&(this.prevStats_.local.audio_outbound_rtp[0].bytesSentPerSecond=this.prevStats_.local.audio_outbound_rtp[0].bytesSent),this.prevStats_.local.audio_outbound_rtp&&(this.prevStats_.local.audio_outbound_rtp[0].packetsSentPerSecond=this.prevStats_.local.audio_outbound_rtp[0].packetsSent),this.prevStats_.local.video_outbound_rtp&&(this.prevStats_.local.video_outbound_rtp[0].bytesSentPerSecond=this.prevStats_.local.video_outbound_rtp[0].bytesSent),this.prevStats_.local.video_outbound_rtp&&(this.prevStats_.local.video_outbound_rtp[0].framesEncodedPerSecond=this.prevStats_.local.video_outbound_rtp[0].framesEncoded),this.prevStats_.local.video_outbound_rtp&&(this.prevStats_.local.video_outbound_rtp[0].packetsSentPerSecond=this.prevStats_.local.video_outbound_rtp[0].packetsSent),this.prevStats_.local.screen_outbound_rtp&&(this.prevStats_.local.screen_outbound_rtp[0].bytesSentPerSecond=this.prevStats_.local.screen_outbound_rtp[0].bytesSent),this.prevStats_.local.screen_outbound_rtp&&(this.prevStats_.local.screen_outbound_rtp[0].framesEncodedPerSecond=this.prevStats_.local.screen_outbound_rtp[0].framesEncoded),this.prevStats_.local.screen_outbound_rtp&&(this.prevStats_.local.screen_outbound_rtp[0].packetsSentPerSecond=this.prevStats_.local.screen_outbound_rtp[0].packetsSent));for(let e in this.prevStats_.remote)if(e.indexOf("_inbound_rtp")>-1)for(let t=0;t<this.prevStats_.remote[e].length;t++)this.prevStats_.remote[e][t].bytesReceivedPerSecond=this.prevStats_.remote[e][t].bytesReceived,this.prevStats_.remote[e][t].packetsLostPerSecond=this.prevStats_.remote[e][t].packetsLost,this.prevStats_.remote[e][t].packetsReceivedPerSecond=this.prevStats_.remote[e][t].packetsReceived,this.prevStats_.remote[e][t].recvPacketLoss=this.prevStats_.remote[e][t].packetsLost/this.prevStats_.remote[e][t].packetsReceived,"video"!==this.prevStats_.remote[e][t].mediaType&&"screen"!==this.prevStats_.remote[e][t].mediaType||(this.prevStats_.remote[e][t].framesDecodedPerSecond=Math.round(this.prevStats_.remote[e][t].framesDecoded))}else{let t=e.local,i=this.prevStats_.local,r=e.remote,s=this.prevStats_.remote;Object.keys(t).length&&(t.audio_outbound_rtp&&(t.audio_outbound_rtp[0].bytesSentPerSecond=(t.audio_outbound_rtp[0].bytesSent-0-i.audio_outbound_rtp[0].bytesSent)/2),t.audio_outbound_rtp&&(t.audio_outbound_rtp[0].packetsSentPerSecond=(t.audio_outbound_rtp[0].packetsSent-0-i.audio_outbound_rtp[0].packetsSent)/2),t.video_outbound_rtp&&(t.video_outbound_rtp[0].bytesSentPerSecond=(t.video_outbound_rtp[0].bytesSent-0-i.video_outbound_rtp[0].bytesSent)/2),t.video_outbound_rtp&&(t.video_outbound_rtp[0].framesEncodedPerSecond=(t.video_outbound_rtp[0].framesEncoded-0-i.video_outbound_rtp[0].framesEncoded)/2),t.video_outbound_rtp&&(t.video_outbound_rtp[0].packetsSentPerSecond=(t.video_outbound_rtp[0].packetsSent-0-i.video_outbound_rtp[0].packetsSent)/2),t.screen_outbound_rtp&&(t.screen_outbound_rtp[0].bytesSentPerSecond=(t.screen_outbound_rtp[0].bytesSent-0-i.screen_outbound_rtp[0].bytesSent)/2),t.screen_outbound_rtp&&(t.screen_outbound_rtp[0].framesEncodedPerSecond=(t.screen_outbound_rtp[0].framesEncoded-0-i.screen_outbound_rtp[0].framesEncoded)/2),t.screen_outbound_rtp&&(t.screen_outbound_rtp[0].packetsSentPerSecond=(t.screen_outbound_rtp[0].packetsSent-0-i.screen_outbound_rtp[0].packetsSent)/2));for(let e in r)if(e.indexOf("_inbound_rtp")>-1)for(let t=0;t<r[e].length;t++)r[e][t].bytesReceivedPerSecond=(r[e][t].bytesReceived-0-s[e][t].bytesReceived)/2,r[e][t].packetsLostPerSecond=(r[e][t].packetsLost-0-s[e][t].packetsLost)/2,r[e][t].packetsReceivedPerSecond=(r[e][t].packetsReceived-0-s[e][t].packetsReceived)/2,r[e][t].recvPacketLoss=r[e][t].packetsLost/r[e][t].packetsReceived-0-s[e][t].packetsLost/s[e][t].packetsReceived?(r[e][t].packetsLost/r[e][t].packetsReceived-0-s[e][t].packetsLost/s[e][t].packetsReceived)/2:0,"video"!==this.prevStats_.remote[e][t].mediaType&&"screen"!==this.prevStats_.remote[e][t].mediaType||(r[e][t].framesDecodedPerSecond=Math.round((r[e][t].framesDecoded-0-s[e][t].framesDecoded)/2))}}return this.prevStats_=e,this.prevStats_}destroy(){this.stop(),this._reset(),this.wsTransport_&&this.wsTransport_.close()}}t.StatsReport=_},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.GetStats=void 0;const n=i(3),a=o(i(117)),d=i(25),c=o(i(13));class l extends n.EventEmitter{constructor(e){super(),this.adapterRef=e.adapterRef,this.interval=e.interval||1e3,this.times=0,this.browser="chrome",this.KeyTransform={K:{googAvailableSendBandwidth:1,googTargetEncBitrate:1,googActualEncBitrate:1,googRetransmitBitrate:1,googTransmitBitrate:1},T:{}},this._reset()}_reset(){this.times=0,this.browser="chrome";const e=navigator.userAgent,t=a.getParser(e);t.satisfies({chrome:">=72",chromium:">=72"})?this.browser="chrome":t.satisfies({safari:">=12.0"})?this.browser="safari":t.satisfies({firefox:">60"})?this.browser="firefox":"WeChat"===t.getBrowser().name&&"iOS"===t.getOS().name||"QQ Browser"===t.getBrowser().name&&"iOS"===t.getOS().name?this.browser="safari":"QQ Browser"===t.getBrowser().name&&"Android"===t.getOS().name&&(this.browser="chrome"),this.KeyTransform={K:{googAvailableSendBandwidth:1,googTargetEncBitrate:1,googActualEncBitrate:1,googRetransmitBitrate:1,googTransmitBitrate:1},T:{}}}async getAllStats(){let e=this.adapterRef&&this.adapterRef._mediasoup&&this.adapterRef._mediasoup._sendTransport&&this.adapterRef._mediasoup._sendTransport._handler._pc,t=this.adapterRef&&this.adapterRef._mediasoup&&this.adapterRef._mediasoup._recvTransport&&this.adapterRef._mediasoup._recvTransport._handler._pc;if(!e&&!t)return;let i={local:e?await this.getLocalStats(e):null,remote:t?await this.getRemoteStats(t):null};return this.times=(this.times||0)+1,this.emit("stats",i,this.times),this.reviseData(i,this.browser)}reviseData(e,t){var i,r,s;let o=new Map,n=new Map;if("chrome"===t){let t=new Map([["candidate-pair",[]],["local-candidate",[]],["media-source",[]],["outbound-rtp",[]],["remote-candidate",[]],["remote-inbound-rtp",[]],["ssrc",[]],["VideoBwe",[]],["track",[]],["transport",[]]]),i=new Map([["candidate-pair",[]],["inbound-rtp",[]],["local-candidate",[]],["remote-candidate",[]],["ssrc",[]],["track",[]],["transport",[]]]),r=e.local,s=e.remote;for(let e in r)if(t.has(r[e].type))if(e.indexOf("ssrc")>-1){let t;e.indexOf("audio")>0||e.indexOf("video")>0?t=r[e].mediaType+"_ssrc":e.indexOf("screen")>0&&(t="screen_ssrc",r[e].mediaType="screen"),o.has(t)||o.set(t,[]),o.get(t).push(r[e])}else o.set(r[e].type,[]),o.get(r[e].type).push(r[e]);let a=Object.create(null);for(let[e,t]of o)a[e]=t;e.local=a;for(let e in s)if(i.has(s[e].type))if("ssrc"===s[e].type){let t;e.indexOf("audio")>0||e.indexOf("video")>0?t=`${s[e].mediaType}_${s[e].type}`:e.indexOf("screen")>0&&(t="screen_"+s[e].type,s[e].mediaType="screen"),n.has(t)||n.set(t,[]),n.get(t).push(s[e])}else{let t=s[e].type;n.has(t)||n.set(t,[]),n.get(t).push(s[e])}let d=Object.create(null);for(let[e,t]of n)d[e]=t;e.remote=d}else if("safari"===t){let t=e.local,i=e.remote,r=new Map([["outbound-rtp",[]],["track",[]]]);for(let e in t)if(r.has(t[e].type)){let i=`${t[e].mediaType}_${t[e].type}`;o.has(i)||o.set(i,[]),o.get(i).push(t[e])}let s=Object.create(null);for(let[e,t]of o)s[e]=t;e.local=s;let a=new Map([["inbound-rtp",[]],["track",[]]]);for(let e in i)if(a.has(i[e].type)){let t=`${i[e].mediaType}_${i[e].type}`;n.has(t)||n.set(t,[]),n.get(t).push(i[e])}let d=Object.create(null);for(let[e,t]of n)d[e]=t;e.remote=d}else if("firefox"===t){let t=e.local,i=e.remote,r=new Map([["candidate-pair",[]],["local-candidate",[]],["outbound-rtp",[]],["remote-candidate",[]]]);for(let e in t)if(r.has(t[e].type)){let i;i=e.indexOf("-outbound-rtp")>-1?`${t[e].mediaType}_${t[e].type}`:""+t[e].type,o.has(i)||o.set(i,[]),o.get(i).push(t[e])}let s=Object.create(null);for(let[e,t]of o)s[e]=t;e.local=s;let a=new Map([["candidate-pair",[]],["inbound-rtp",[]],["local-candidate",[]],["remote-candidate",[]]]);for(let e in i)if(a.has(i[e].type)){let t;t=e.indexOf("-inbound-rtp")>-1?`${i[e].mediaType}_${i[e].type}`:""+i[e].type,n.has(t)||n.set(t,[]),n.get(t).push(i[e])}let d=Object.create(null);for(let[e,t]of n)d[e]=t;e.remote=d}let a={"candidate-pair":"candidate_pair","local-candidate":"local_candidate","media-source":"media_source","outbound-rtp":"outbound_rtp","remote-candidate":"remote_candidate","remote-inbound-rtp":"remote_inbound_rtp",VideoBwe:"video_bwe","inbound-rtp":"inbound_rtp","audio_outbound-rtp":"audio_outbound_rtp","video_outbound-rtp":"video_outbound_rtp","audio_inbound-rtp":"audio_inbound_rtp","video_inbound-rtp":"video_inbound_rtp","screen_outbound-rtp":"screen_outbound_rtp","screen_inbound-rtp":"screen_inbound_rtp"};for(let t in e.local){let i=a[t];i&&(e.local[i]=e.local[t],delete e.local[t])}for(let t in e.remote){let i=a[t];i&&(e.remote[i]=e.remote[t],delete e.remote[t])}return e.timestamp=(new Date).getTime(),e.appkey=null===(i=this.adapterRef)||void 0===i?void 0:i.channelInfo.appkey,e.cid=null===(r=this.adapterRef)||void 0===r?void 0:r.channelInfo.cid,e.uid=null===(s=this.adapterRef)||void 0===s?void 0:s.channelInfo.uid,c.IS_EDG?e.browser="Edge-"+d.platform.version:e.browser=d.platform.name+"-"+d.platform.version,e.platform=d.platform.os.family,e}async getLocalStats(e){return!e||/(failed|closed|new)/gi.test(e.iceConnectionState)?{}:await this[this.browser](e,"send")}async getRemoteStats(e){return!e||/(failed|closed|new)/gi.test(e.iceConnectionState)?{}:await this[this.browser](e,"recv")}async chrome(e,t){const i=await(()=>new Promise((i,r)=>{e.getStats(r=>{let s={};r.result().forEach((function(e){const t={};e.names().forEach((function(i){t[i]=e.stat(i)})),t.id=e.id,t.type=e.type,t.timestamp=e.timestamp,s[t.id]=t})),e.lastStats=e.lastStats||{},s=this.formatChromeNonStandardStats(e,s,t),i(s)})}))(),r=await(async()=>{if(!e.getTransceivers)return{};let i={};const r=e.getTransceivers();for(let e=0;e<r.length;e++){let s=null;const o=r[e];"sendonly"===o.direction?o.sender&&o.sender.getStats&&(s=await o.sender.getStats(),s=this.formatChromeStandardizedStats(s,t,0),Object.assign(i,s)):"recvonly"===o.direction&&o.receiver&&o.receiver.getStats&&(s=await o.receiver.getStats(),s=this.formatChromeStandardizedStats(s,t,0),Object.assign(i,s))}return i})();return Object.assign(i,r)}formatChromeNonStandardStats(e,t,i){const r={};return Object.values(t).forEach(t=>{if("recv"===i&&!/^ssrc_/i.test(t.id))return r;if("send"===i&&!/^(bweforvideo|Conn-0-1-0|ssrc_)/i.test(t.id))return r;"bweforvideo"===t.id&&(t=this.formatData(t));const s=("send"===i?/ssrc_(\d+)_send/i:/ssrc_(\d+)_recv/i).exec(t.id),o=t.id;if(r[o]=t,!s||!s[1])return r;const n=s[1];if(!this.adapterRef)return void console.error("getStats行为没有client关联");const a=this.adapterRef.instance.getUidAndKindBySsrc(parseInt(n));let d,c=a.uid;if(d=a.kind?a.kind:"screen"===t.googContentType?"screen":t.mediaType,!c&&"recv"===i)return r;t.id=this.stringifyItemId("ssrc",i,"recv"===i?""+c:"0",d,a.streamType),t.localuid=this.adapterRef.channelInfo.uid,t.remoteuid=c,-1==(t=this.computeData(e,t)).googInterframeDelayMax&&(t.googInterframeDelayMax=0),r[t.id]=t,delete r[o]}),r}stringifyItemId(e,t,i,r,s){var o,n,a;let d;return d="send"===t?"high"===s?`${e}_${null===(o=this.adapterRef)||void 0===o?void 0:o.channelInfo.uid}_send_0_${r}`:`${e}_${null===(n=this.adapterRef)||void 0===n?void 0:n.channelInfo.uid}_send_0_${r}_${s}`:`${e}_${null===(a=this.adapterRef)||void 0===a?void 0:a.channelInfo.uid}_${t}_${i}_${r}`,d}parseItemId(e){const t=e.match(/([a-zA-Z\-])+_\d+_send_0_([a-zA-Z]+)/),i=e.match(/([a-zA-Z\-])+_\d+_send_0_([a-zA-Z]+)_([a-zA-Z]+)/),r=e.match(/([a-zA-Z\-])+_\d+_recv_(\d+)_([a-zA-Z]+)/);let s;return s=t?{type:t[1],direction:"send",remoteUid:"0",mediaType:t[2],streamType:"high"}:i?{type:i[1],direction:"send",remoteUid:"0",mediaType:i[2],streamType:i[3]}:r?{type:r[1],direction:"recv",remoteUid:r[2],mediaType:r[3]}:null,s}formatChromeStandardizedStats(e,t,i){let r={};if(e.forEach(e=>{"inbound-rtp"==e.type&&this.adapterRef&&this.adapterRef.instance&&(i=this.adapterRef.instance.getUidAndKindBySsrc(e.ssrc).uid)}),i||!(t.indexOf("recv")>-1))return e.forEach(e=>{"local-candidate"!=e.type&&"remote-candidate"!=e.type&&"track"!=e.type&&"outbound-rtp"!=e.type&&"remote-inbound-rtp"!=e.type&&"candidate-pair"!=e.type&&"media-source"!=e.type&&"inbound-rtp"!=e.type&&"transport"!=e.type||(r[`${e.type}_${this.adapterRef&&this.adapterRef.channelInfo.uid}_${t}_${i}`]=e)}),r}async safari(e,t){const i=await(async()=>{const i=await e.getStats();e.lastStats=e.lastStats||{};return this.formatSafariNonStandardStats(e,i,t)})(),r=await(async()=>{if(!e.getTransceivers)return{};let i={};const r=e.getTransceivers();for(let e=0;e<r.length;e++){let s=null;const o=r[e];"sendonly"===o.direction?o.sender&&o.sender.getStats&&(s=await o.sender.getStats(),s&&(s=this.formatSafariStandardizedStats(s,t)||{},Object.assign(i,s))):"recvonly"===o.direction&&o.receiver&&o.receiver.getStats&&(s=await o.receiver.getStats(),s&&(s=this.formatSafariStandardizedStats(s,t)||{},Object.assign(i,s)))}return i})();return Object.assign(i,r)}formatSafariNonStandardStats(e,t,i){let r={},s=new Map;return t.forEach(e=>{if("outbound-rtp"==e.type||"inbound-rtp"==e.type){const t=this.adapterRef?this.adapterRef.instance.getUidAndKindBySsrc(e.ssrc).uid:0;return s.set(e.trackId,{uid:t.toString(),ssrc:e.ssrc}),void(e.remoteuid=t.toString())}}),t.forEach(t=>{"track"==t.type?(t.ssrc=s.get(t.id.toString()).ssrc,t.remoteuid=t.uid=s.get(t.id.toString()).uid,t.framesSent||t.framesReceived?(t=this.computeData(e,t),r[`_video_${t.type}_${this.adapterRef&&this.adapterRef.channelInfo.uid}_${i}_${t.uid}`]=t,t.mediaType="video"):(r[`_audio_${t.type}_${this.adapterRef&&this.adapterRef.channelInfo.uid}_${i}_${t.uid}`]=t,t.mediaType="audio")):"outbound-rtp"!=t.type&&"inbound-rtp"!=t.type||(t=this.computeData(e,t),r[`${t.mediaType}_${t.type}_${this.adapterRef&&this.adapterRef.channelInfo.uid}_${i}_${t.uid}`]=t)}),r}formatSafariStandardizedStats(e,t){let i,r={};return e.forEach(e=>{"inbound-rtp"==e.type&&(i=this.adapterRef?this.adapterRef.instance.getUidAndKindBySsrc(e.ssrc).uid:i)}),e.forEach(e=>{"local-candidate"!=e.type&&"remote-candidate"!=e.type&&"track"!=e.type&&"outbound-rtp"!=e.type&&"remote-inbound-rtp"!=e.type&&"candidate-pair"!=e.type&&"media-source"!=e.type&&"inbound-rtp"!=e.type&&"transport"!=e.type||(r[`${e.type}_${this.adapterRef&&this.adapterRef.channelInfo.uid}_${t}_${i}`]=e)}),r}async firefox(e,t){const i=await(async()=>{let t=await e.getStats(),i={};return t.forEach(e=>{i[e.type]=e}),i})(),r=await(async()=>{if(!e.getTransceivers)return{};let i={};const r=e.getTransceivers();for(let e=0;e<r.length;e++){let s=null;const o=r[e];"sendonly"===o.direction?o.sender&&o.sender.getStats&&(s=await o.sender.getStats(),s=this.formatFirefoxStandardizedStats(s,t,0,o.mid),Object.assign(i,s)):"recvonly"===o.direction&&o.receiver&&o.receiver.getStats&&(s=await o.receiver.getStats(),s=this.formatFirefoxStandardizedStats(s,t,0),Object.assign(i,s))}return i})();return Object.assign(i,r)}formatFirefoxStandardizedStats(e,t,i,r){let s={};return e.forEach(e=>{if("inbound-rtp"==e.type&&this.adapterRef&&this.adapterRef.instance){const t=this.adapterRef.instance.getUidAndKindBySsrc(e.ssrc);e.remoteuid=t.uid,i=t.uid,"video"===e.kind&&(e.mediaType=t.kind?t.kind:"screen")}}),e.forEach(e=>{"outbound-rtp"==e.type&&"2"==r&&(e.mediaType="screen")}),e.forEach(e=>{"local-candidate"==e.type||"remote-candidate"==e.type||"remote-inbound-rtp"==e.type||"candidate-pair"==e.type?s[`${e.type}_${this.adapterRef&&this.adapterRef.channelInfo.uid}_${t}_${i}`]=e:"outbound-rtp"!=e.type&&"inbound-rtp"!=e.type||(s[`${e.mediaType}-${e.type}_${this.adapterRef&&this.adapterRef.channelInfo.uid}_${t}_${i}`]=e)}),s}formatData(e){return Object.keys(e).map(t=>{this.KeyTransform.K[t]&&(e[t]=(e[t]/1024).toFixed(2)),this.KeyTransform.T[t]&&(e[t]=(e[t]/1024/1024).toFixed(2))}),e}computeData(e,t){const i={pc:e,ssrcKey:t.ssrc,currentItem:t};return t.bytesSent&&(t.bitsSentPerSecond=this.getLastStats(Object.assign({},i,{firstKey:"bytesSent"}))),t.packetsSent&&(t.packetsSentPerSecond=this.getLastStats(Object.assign({},i,{firstKey:"packetsSent"}))),t.bytesReceived&&(t.bitsReceivedPerSecond=this.getLastStats(Object.assign({},i,{firstKey:"bytesReceived"}))),t.packetsReceived&&(t.packetsReceivedPerSecond=this.getLastStats(Object.assign({},i,{firstKey:"packetsReceived"}))),t.packetsSent&&t.packetsLost&&(t.sendPacketLoss=this.getLastStats(Object.assign({},i,{firstKey:"packetsSent",secondKey:"packetsLost"}))),t.packetsReceived&&t.packetsLost&&(t.recvPacketLoss=this.getLastStats(Object.assign({},i,{firstKey:"packetsReceived",secondKey:"packetsLost"}))),t.framesSent&&(t.frameRateSent=this.getLastStats(Object.assign({},i,{firstKey:"framesSent"}))),t}getLastStats(e={}){const{pc:t,ssrcKey:i,firstKey:r,secondKey:s=null,currentItem:o}=e;let n=0,a=0;if(t.lastStats[i]&&t.lastStats[i][r]){if(!(o[r]-t.lastStats[i][r]>0))return n;n=(o[r]-t.lastStats[i][r])/2,s&&(a=(o[s]-t.lastStats[i][s])/2)}else t.lastStats[i]||(t.lastStats[i]={}),n=o[r],s&&(a=o[s]);return n=/bytes/gi.test(r)?Math.round(8*n/1e3):s?r.indexOf("send")>-1?Math.floor(a/n*1e4)/100:a/(a+a)*1e4/100:n,t.lastStats[i][r]=o[r],s&&(t.lastStats[i][s]=o[s]),n}stop(){this._reset()}destroy(){this._reset()}}t.GetStats=l},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FormativeStatsReport=void 0;const a=i(122),d=i(25),c=n(i(1)),l=n(i(0)),u=o(i(13));t.FormativeStatsReport=class{constructor(e){this._reset(),this.adapterRef=e.adapterRef,this.webrtcStats=[],this.publicIP="",this._audioLevel=[],this.infos={interval:0},this.infos2={},this.paramSecond={upAudioCache:{},upVideoCache:{},upScreenCache:{},downAudioCache:{},downVideoCache:{},downScreenCache:{}},this.firstData={recvFirstData:{},sendFirstAudioPackage:!1,sendFirstVideoPackage:!1,sendFirstScreenPackage:!1},this.network="",this.LocalAudioEnable=!1,this.localVideoEnable=!1,this.localScreenEnable=!1,this.init(this.adapterRef.channelInfo.appkey),this.resetStatus()}_reset(){this._audioLevel=[],this.infos={interval:0}}init(e){return this.infos={ver:2,device:-1,isp:-1,platform:p.convertPlatform(d.platform.os.family)+"-"+d.platform.os.version+"- webrtc",browser:d.platform.name+"-"+d.platform.version,sdk_ver:"3.6.0",appkey:e,interval:60,samples:30,time:Date.now(),qos_algorithm:-1,fec_algorithm:-1,qos_scene:-1,qos_strategy:-1},this.infos}resetStatus(){this.infos=Object.assign(this.infos,{uid:null,cid:null,push_url:null,turn_ip:null,proxy_ip:null,meeting:!1,live:!1}),this.firstData={recvFirstData:{},sendFirstAudioPackage:!1,sendFirstVideoPackage:!1,sendFirstScreenPackage:!1},this._audioLevel&&(this._audioLevel.length=0),this.clearInfoData()}initInfoData(e){let t={uid:e,cid:this.adapterRef.channelInfo.cid||0,push_url:"",turn_ip:this.adapterRef&&this.adapterRef.channelInfo.wssArr&&this.adapterRef.channelInfo.wssArr[0]||"",proxy_ip:this.adapterRef&&this.adapterRef.channelInfo.wssArr&&this.adapterRef.channelInfo.wssArr[0]||"",meeting:!0,live:this.adapterRef.channelInfo&&this.adapterRef.channelInfo.sessionConfig.liveEnable||!1,p2p:!1,isp:-1,net:-1,connect_state:200,signalling_time:(this.adapterRef.channelInfo&&this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.startWssTime||0)-(this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.startJoinTime||0),connect_time:(this.adapterRef.channelInfo&&this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.joinedSuccessedTime||0)-(this.adapterRef.channelInfo&&this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.startWssTime||0)};this.infos=Object.assign(this.infos,t)}clearInfoData(){this.infos2={rx2:[],tx2:[{v_fps:[],v_res:[],v_plis:[],v_rtt:[],v_simulcast:[],v_bw_kbps:[],v_tar_kbps:[],v_rel_kbps:[],v_tx_kbps:[],v_retx_kbps:[],v_delay:[],s_fps:[],s_res:[],s_plis:[],s_rtt:[],s_simulcast:[],s_bw_kbps:[],s_tar_kbps:[],s_rel_kbps:[],s_tx_kbps:[],s_retx_kbps:[],s_delay:[],a_cap_volume:[],a_rtt:[]}],sys:{cpu_total:[],cpu_idle:[],mem_total:[],mem_workingSet:[],mem_load:[]}}}start(){this.infos.appkey=this.adapterRef.channelInfo.appkey,this.infos.cid=this.adapterRef.channelInfo.cid,this.infos.uid=this.adapterRef.channelInfo.uid,this.clearSecond(),this.initInfoData(this.infos.uid)}stop(){this.send(),this.resetStatus()}clearSecond(){this.paramSecond={upAudioCache:{},upVideoCache:{},upScreenCache:{},downAudioCache:{},downVideoCache:{},downScreenCache:{}}}getPacketLossRate(e,t,i=!1){if(!e||!t)return 0;let r=parseInt(e.packetsLost)||0,s=parseInt(t.packetsLost)||0;if(s<=r)return 0;let o=i?e.packetsSent:e.packetsReceived,n=i?t.packetsSent:t.packetsReceived,a=parseInt(o||"")||0,d=parseInt(n||"")||0;return d<=a?0:i?parseFloat(((s-r)/(d-a)*100).toFixed(1)):parseFloat(((s-r)/(s-r+(d-a))*100).toFixed(1))}update(e,t){e=Object.assign({},e.local,e.remote);let i=[],r=[],s=[],o=[],n=[],a=[];2==this.webrtcStats.length&&this.webrtcStats.shift(),this.webrtcStats.push(e);let d={send:{uid:0,audio:{prevLost:0,nextLost:0,prevPacket:0,nextPacket:0,rtt:0,jitter:0},video:{prevLost:0,nextLost:0,prevPacket:0,nextPacket:0,rtt:0,jitter:0},screen:{prevLost:0,nextLost:0,prevPacket:0,nextPacket:0,rtt:0,jitter:0}},recv:{uid:0,audio:{prevLost:0,nextLost:0,prevPacket:0,nextPacket:0,rtt:0,jitter:0},video:{prevLost:0,nextLost:0,prevPacket:0,nextPacket:0,rtt:0,jitter:0},screen:{prevLost:0,nextLost:0,prevPacket:0,nextPacket:0,rtt:0,jitter:0}}},c=0,l=0;this._audioLevel&&(this._audioLevel.length=0);for(let t in e){let p;if(p=u.IS_SAFARI?t.split("_")[5]||"":t.split("_")[3]||"","0"===p&&(p=t.split("_")[1]||""),-1!==t.indexOf("_send_")&&-1!==t.indexOf("_audio"))!this.firstData.sendFirstAudioPackage&&e[t].packetsSent>0&&(this.firstData.sendFirstAudioPackage=!0,this.adapterRef.instance.apiEventReport("setSendFirstPackage",{media_type:0})),this.paramSecond.upAudioCache[p]&&(d.send.audio.prevLost=this.paramSecond.upAudioCache[p].packetsLost,d.send.audio.prevPacket=this.paramSecond.upAudioCache[p].packetsSent,e[t].alr=this.getPacketLossRate(this.paramSecond.upAudioCache[p],e[t],!0),this.dispatchExceptionEventSendAudio(this.paramSecond.upAudioCache[p],e[t],p)),l+=parseInt(e[t].bytesSent),this.paramSecond.upAudioCache[p]=e[t],d.send.uid=this.adapterRef.channelInfo.uid,d.send.audio.nextLost=e[t].packetsLost,d.send.audio.nextPacket=e[t].packetsSent,d.send.audio.rtt=d.recv.audio.rtt=e[t].googRtt,d.send.audio.jitter=d.recv.audio.jitter=e[t].googJitterReceived||0,i.push(e[t]);else if(-1!==t.indexOf("_send_")&&-1!==t.indexOf("_video")){!this.firstData.sendFirstVideoPackage&&e[t].packetsSent>0&&(this.firstData.sendFirstVideoPackage=!0,this.adapterRef.instance.apiEventReport("setSendFirstPackage",{media_type:1})),this.paramSecond.upVideoCache[p]&&(d.send.video.prevLost=this.paramSecond.upVideoCache[p].packetsLost,d.send.video.prevPacket=this.paramSecond.upVideoCache[p].packetsSent,e[t].vlr=this.getPacketLossRate(this.paramSecond.upVideoCache[p],e[t],!0),this.dispatchExceptionEventSendVideo(this.paramSecond.upVideoCache[p],e[t],p));let i=this.getLocalVideoFreezeStats(e[t],p);e[t].freezeTime=i.freezeTime,e[t].totalFreezeTime=i.totalFreezeTime,e[t]=Object.assign({},e.bweforvideo,e[t]),l+=parseInt(e[t].bytesSent),this.paramSecond.upVideoCache[p]=e[t],d.send.uid=this.adapterRef.channelInfo.uid,d.send.video.nextLost=e[t].packetsLost,d.send.video.nextPacket=e[t].packetsSent,d.send.video.rtt=d.recv.video.rtt=e[t].googRtt,d.send.video.jitter=d.recv.video.jitter=e[t].googJitterReceived||0,r.push(e[t])}else if(-1!==t.indexOf("_send_")&&-1!==t.indexOf("_screen")){!this.firstData.sendFirstScreenPackage&&e[t].packetsSent>0&&(this.firstData.sendFirstScreenPackage=!0,this.adapterRef.instance.apiEventReport("setSendFirstPackage",{media_type:2})),this.paramSecond.upScreenCache[p]&&(d.send.screen.prevLost=this.paramSecond.upScreenCache[p].packetsLost,d.send.screen.prevPacket=this.paramSecond.upScreenCache[p].packetsSent,e[t].vlr=this.getPacketLossRate(this.paramSecond.upScreenCache[p],e[t],!0));let i=this.getLocalScreenFreezeStats(e[t],p);e[t].freezeTime=i.freezeTime,e[t].totalFreezeTime=i.totalFreezeTime,Object.assign(e[t],e.bweforvideo),l+=parseInt(e[t].bytesSent),this.paramSecond.upScreenCache[p]=e[t],d.send.uid=this.adapterRef.channelInfo.uid,d.send.screen.nextLost=e[t].packetsLost,d.send.screen.nextPacket=e[t].packetsSent,d.send.screen.rtt=d.recv.screen.rtt=e[t].googRtt,d.send.screen.jitter=d.recv.screen.jitter=e[t].googJitterReceived||0,s.push(e[t])}else if(-1!==t.indexOf("_recv_")&&-1!==t.indexOf("_audio")){this.firstData.recvFirstData[p]||(this.firstData.recvFirstData[p]={recvFirstAudioFrame:!1,recvFirstVideoFrame:!1,recvFirstScreenFrame:!1,recvFirstAudioPackage:!1,recvFirstVideoPackage:!1,recvFirstScreenPackage:!1,videoTotalPlayDuration:0,screenTotalPlayDuration:0}),!this.firstData.recvFirstData[p].recvFirstAudioFrame&&parseInt(e[t].googDecodingNormal)>0&&(this.firstData.recvFirstData[p].recvFirstAudioFrame=!0,this.adapterRef.instance.apiEventReport("setRecvFirstFrame",{media_type:0,pull_uid:p})),!this.firstData.recvFirstData[p].recvFirstAudioPackage&&parseInt(e[t].packetsReceived)>0&&(this.firstData.recvFirstData[p].recvFirstAudioPackage=!0,this.adapterRef.instance.apiEventReport("setRecvFirstPackage",{media_type:0,pull_uid:p})),this.paramSecond.downAudioCache[p]&&(d.recv.audio.prevLost=this.paramSecond.downAudioCache[p].packetsLost,d.recv.audio.prevPacket=this.paramSecond.downAudioCache[p].packetsReceived,e[t].alr=this.getPacketLossRate(this.paramSecond.downAudioCache[p],e[t]));let i=this.getRemoteAudioFreezeStats(this.paramSecond.downAudioCache[p],e[t],p);e[t].freezeTime=i.freezeTime,e[t].totalFreezeTime=i.totalFreezeTime,c+=parseInt(e[t].bytesReceived),this.dispatchExceptionEventRecvAudio(this.paramSecond.downAudioCache[p],e[t],p),this.paramSecond.downAudioCache[p]=e[t],d.recv.uid=+p,d.recv.audio.nextLost=e[t].packetsLost,d.recv.audio.nextPacket=e[t].packetsReceived,o.push(e[t]);let r=0;e[t].audioOutputLevel>=0?r=e[t].audioOutputLevel:e[t].audioLevel>=0&&(r=Math.floor(32768*e[t].audioLevel)),this._audioLevel.push({uid:p,level:+r||0})}else if(-1!==t.indexOf("_recv_")&&-1!==t.indexOf("_video")){this.firstData.recvFirstData[p]||(this.firstData.recvFirstData[p]={recvFirstAudioFrame:!1,recvFirstVideoFrame:!1,recvFirstScreenFrame:!1,recvFirstAudioPackage:!1,recvFirstVideoPackage:!1,recvFirstScreenPackage:!1,videoTotalPlayDuration:0,screenTotalPlayDuration:0}),!this.firstData.recvFirstData[p].recvFirstVideoFrame&&e[t].framesDecoded>0?(this.firstData.recvFirstData[p].recvFirstVideoFrame=!0,this.adapterRef.instance.apiEventReport("setRecvFirstFrame",{media_type:1,pull_uid:p})):e[t].framesDecoded>0&&this.firstData.recvFirstData[p].videoTotalPlayDuration++,!this.firstData.recvFirstData[p].recvFirstVideoPackage&&e[t].packetsReceived>0&&(this.firstData.recvFirstData[p].recvFirstVideoPackage=!0,this.adapterRef.instance.apiEventReport("setRecvFirstPackage",{media_type:1,pull_uid:p})),this.paramSecond.downVideoCache[p]&&(d.recv.video.prevLost=this.paramSecond.downVideoCache[p].packetsLost,d.recv.video.prevPacket=this.paramSecond.downVideoCache[p].packetsReceived,e[t].vlr=this.getPacketLossRate(this.paramSecond.downVideoCache[p],e[t]));let i=this.getRemoteVideoFreezeStats(this.paramSecond.downVideoCache[p],e[t],p);e[t].freezeTime=i.freezeTime,e[t].totalFreezeTime=i.totalFreezeTime,this.dispatchExceptionEventRecvVideo(this.paramSecond.downVideoCache[p],e[t],p),c+=parseInt(e[t].bytesReceived),this.paramSecond.downVideoCache[p]=e[t],d.recv.uid=+p,d.recv.video.nextLost=e[t].packetsLost,d.recv.video.nextPacket=e[t].packetsReceived,n.push(e[t])}else if(-1!==t.indexOf("_recv_")&&-1!==t.indexOf("_screen")){this.firstData.recvFirstData[p]||(this.firstData.recvFirstData[p]={recvFirstAudioFrame:!1,recvFirstVideoFrame:!1,recvFirstScreenFrame:!1,recvFirstAudioPackage:!1,recvFirstVideoPackage:!1,recvFirstScreenPackage:!1,videoTotalPlayDuration:0,screenTotalPlayDuration:0}),!this.firstData.recvFirstData[p].recvFirstScreenFrame&&e[t].framesDecoded>0?(this.firstData.recvFirstData[p].recvFirstScreenFrame=!0,this.adapterRef.instance.apiEventReport("setRecvFirstFrame",{media_type:2,pull_uid:p})):e[t].framesDecoded>0&&this.firstData.recvFirstData[p].screenTotalPlayDuration++,!this.firstData.recvFirstData[p].recvFirstScreenPackage&&e[t].packetsReceived>0&&(this.firstData.recvFirstData[p].recvFirstScreenPackage=!0,this.adapterRef.instance.apiEventReport("setRecvFirstPackage",{media_type:2,pull_uid:p})),this.paramSecond.downScreenCache[p]&&(d.recv.screen.prevLost=this.paramSecond.downScreenCache[p].packetsLost,d.recv.screen.prevPacket=this.paramSecond.downScreenCache[p].packetsReceived,e[t].vlr=this.getPacketLossRate(this.paramSecond.downScreenCache[p],e[t]));let i=this.getRemoteScreenFreezeStats(this.paramSecond.downScreenCache[p],e[t],p);e[t].freezeTime=i.freezeTime,e[t].totalFreezeTime=i.totalFreezeTime,this.dispatchExceptionEventRecvScreen(this.paramSecond.downScreenCache[p],e[t],p),c+=parseInt(e[t].bytesReceived),this.paramSecond.downScreenCache[p]=e[t],d.recv.uid=+p,d.recv.screen.nextLost=e[t].packetsLost,d.recv.screen.nextPacket=e[t].packetsReceived,a.push(e[t])}else if(-1!==t.indexOf("Conn-")){this.publicIP=e[t]&&e[t].googLocalAddress.match(/([0-9\.]+)/)[1];let i="0"==e[t].googRtt?"1":e[t].googRtt;this.adapterRef.transportStats.txRtt=i,this.adapterRef.transportStats.rxRtt=i}else if(-1!==t.indexOf("local-candidate"))e[t].networkType&&(this.adapterRef.transportStats.NetworkType=e[t].networkType);else if(-1!==t.indexOf("candidate-pair")&&-1!==t.indexOf("send")){t.split("_")[1]==this.adapterRef.channelInfo.uid&&(this.adapterRef.transportStats.OutgoingAvailableBandwidth=e[t].availableOutgoingBitrate/1e3)}else this.network=e[t]&&e[t].network}if(this.adapterRef.sessionStats.RecvBytes=c,this.adapterRef.sessionStats.SendBytes=l,1!==t&&(this._audioLevel.sort(p.compare("level")),this._audioLevel.length>0&&this._audioLevel[0].level>0&&this.adapterRef.instance.safeEmit("active-speaker",this._audioLevel[0]),t%2==0)){this.adapterRef.instance.safeEmit("volume-indicator",this._audioLevel),this.updateTxMediaInfo(i,r,s),this.updateRxMediaInfo(o,n,a),(this.infos2.tx2&&this.infos2.tx2[0].v_res.length)===this.infos.interval/2&&this.send()}}updateOnce(){this.initInfoData(),this.send()}updateRxMediaInfo(e,t,i){let r={uid:[],a_p_volume:[],a_d_nor:[],a_d_plc:[],a_d_plccng:[],a_stuck:[],a_bps:[],a_p_lost_r:[],a_delay:[],a_acc_r:[]},s={v_res:[],v_fps:[],v_plis:[],v_stuck:[],v_bw_kbps:[],v_bps:[],v_p_lost_r:[],v_dec_ms:[],v_delay:[]},o={v_res:[],v_fps:[],v_plis:[],v_stuck:[],v_bw_kbps:[],v_bps:[],v_p_lost_r:[],v_dec_ms:[],v_delay:[]},n=0;e.map(e=>{let t="0";e.id&&(t=e.id.split("_")[3]),this.adapterRef.remoteAudioStats[t]&&(this.adapterRef.remoteAudioStats[t]={TotalFreezeTime:0});const i=this.adapterRef.remoteStreamMap[t];this.adapterRef.remoteAudioStats[t]={CodecType:"Opus",End2EndDelay:(parseInt(e.googCurrentDelayMs)||0)+(parseInt(e.googJitterBufferMs)||0),MuteState:i&&(i.muteStatus.audio.send||i.muteStatus.audio.recv),PacketLossRate:e.alr||0,RecvBitrate:e.bitsReceivedPerSecond||0,RecvLevel:parseInt(e.audioOutputLevel)||+e.audioLevel||0,TotalFreezeTime:e.totalFreezeTime||0,TotalPlayDuration:parseInt(e.totalSamplesDuration)||0,TransportDelay:parseInt(e.googCurrentDelayMs)||0},n+=e.bitsReceivedPerSecond,r.uid.push(t),r.a_p_volume.push(+(e.audioOutputLevel||e.audioLevel)||0),r.a_d_nor.push(parseInt(e.googDecodingNormal)||0),r.a_d_plc.push(parseInt(e.googDecodingPLC)||0),r.a_d_plccng.push(parseInt(e.googDecodingPLCCNG)||0),r.a_stuck.push(e.freezeTime||0),r.a_bps.push(e.bitsReceivedPerSecond||0),r.a_p_lost_r.push(e.alr||0),r.a_delay.push(parseInt(e.googJitterBufferMs)||0),r.a_acc_r.push(0)}),t.map(e=>{let t="0";e.id&&(t=e.id.split("_")[3]);const i=this.adapterRef.remoteStreamMap[t];this.adapterRef.remoteVideoStats[t]&&(this.adapterRef.remoteVideoStats[t]={TotalFreezeTime:0});const r=i&&i.Play&&i.Play.videoDom;this.adapterRef.remoteVideoStats[t]={LayerType:1,CodecName:e.googCodecName,End2EndDelay:(parseInt(e.googCurrentDelayMs)||0)+(parseInt(e.googJitterBufferMs)||0)+(parseInt(e.googRenderDelayMs)||0),MuteState:i&&(i.muteStatus.video.send||i.muteStatus.video.recv),PacketLossRate:e.vlr||0,RecvBitrate:e.bitsReceivedPerSecond||0,RecvResolutionHeight:parseInt(e.googFrameHeightReceived)||0,RecvResolutionWidth:parseInt(e.googFrameWidthReceived)||0,RenderFrameRate:parseInt(e.googFrameRateOutput)||0,RenderResolutionHeight:r?r.videoHeight:0,RenderResolutionWidth:r?r.videoWidth:0,TotalFreezeTime:e.totalFreezeTime||0,TotalPlayDuration:this.firstData.recvFirstData[t]&&this.firstData.recvFirstData[t].videoTotalPlayDuration||(r&&r.played&&r.played.length?r.played.end(0):0),TransportDelay:parseInt(e.googCurrentDelayMs)||0},n+=e.bitsReceivedPerSecond,s.v_res.push((e.googFrameWidthReceived||0)+"x"+(e.googFrameHeightReceived||0)),s.v_fps.push(parseInt(e.googFrameRateOutput)),s.v_plis.push(parseInt(e.googPlisSent)),s.v_stuck.push(e.freezeTime||0),s.v_bw_kbps.push(0),s.v_bps.push(e.bitsReceivedPerSecond||0),s.v_p_lost_r.push(e.vlr||0),s.v_dec_ms.push(parseInt(e.googDecodeMs)||0),s.v_delay.push(parseInt(e.googJitterBufferMs))}),i.map(e=>{let t=0;e.id&&(t=+e.id.split("_")[3]);const i=this.adapterRef.remoteStreamMap[t];this.adapterRef.remoteScreenStats[t]&&(this.adapterRef.remoteScreenStats[t]={TotalFreezeTime:0});const r=i&&i.Play&&i.Play.screenDom;this.adapterRef.remoteScreenStats[t]={LayerType:2,CodecName:e.googCodecName,End2EndDelay:(parseInt(e.googCurrentDelayMs)||0)+(parseInt(e.googJitterBufferMs)||0)+(parseInt(e.googRenderDelayMs)||0),MuteState:i&&(i.muteStatus.screen.send||i.muteStatus.screen.recv),PacketLossRate:e.vlr||0,RecvBitrate:e.bitsReceivedPerSecond||0,RecvResolutionHeight:parseInt(e.googFrameHeightReceived)||0,RecvResolutionWidth:parseInt(e.googFrameWidthReceived)||0,RenderFrameRate:parseInt(e.googFrameRateOutput)||0,RenderResolutionHeight:r?r.videoHeight:0,RenderResolutionWidth:r?r.videoWidth:0,TotalFreezeTime:e.totalFreezeTime||0,TotalPlayDuration:this.firstData.recvFirstData[t]&&this.firstData.recvFirstData[t].screenTotalPlayDuration||(r&&r.played&&r.played.length?r.played.end(0):0),TransportDelay:parseInt(e.googCurrentDelayMs)||0},n+=e.bitsReceivedPerSecond,o.v_res.push((e.googFrameWidthReceived||0)+"x"+(e.googFrameHeightReceived||0)),o.v_fps.push(parseInt(e.googFrameRateOutput)),o.v_plis.push(parseInt(e.googPlisSent)),o.v_stuck.push(e.freezeTime||0),o.v_bw_kbps.push(0),o.v_bps.push(e.bitsReceivedPerSecond||0),o.v_p_lost_r.push(e.vlr||0),o.v_dec_ms.push(parseInt(e.googDecodeMs)||0),o.v_delay.push(parseInt(e.googJitterBufferMs))}),this.adapterRef.sessionStats.RecvBitrate=n,this.infos2.rx2.push({uid:r.uid,a_p_volume:r.a_p_volume,a_d_nor:r.a_d_nor,a_d_plc:r.a_d_plc,a_d_plccng:r.a_d_plccng,a_stuck:r.a_stuck,a_bps:r.a_bps,a_p_lost_r:r.a_p_lost_r,a_delay:r.a_delay,a_acc_r:r.a_acc_r,v_res:s.v_res,v_fps:s.v_fps,v_plis:s.v_plis,v_stuck:s.v_stuck,v_bw_kbps:s.v_bw_kbps,v_bps:s.v_bps,v_p_lost_r:s.v_p_lost_r,v_dec_ms:s.v_dec_ms,v_delay:s.v_delay,s_res:o.v_res,s_fps:o.v_fps,s_plis:o.v_plis,s_stuck:o.v_stuck,s_bw_kbps:o.v_bw_kbps,s_bps:o.v_bps,s_p_lost_r:o.v_p_lost_r,s_dec_ms:o.v_dec_ms,s_delay:o.v_delay})}getLocalMediaStats(e,t,i){let r={a_lost:e[0]&&e[0].alr||0,v_lost:t[0]&&t[0].vlr||0,s_lost:i[0]&&i[0].vlr||0,rtt:parseInt(t[0]&&t[0].googRtt)||0,rtt_mdev:-1,set_v_fps:parseInt(this.adapterRef.channelInfo.sessionConfig.frameRate)||0,v_cap_fps:parseInt(t[0]&&t[0].googFrameRateInput)||0,s_cap_fps:parseInt(i[0]&&i[0].googFrameRateInput)||0,qos_v_fps:parseInt(t[0]&&t[0].googFrameRateInput)||0,qos_s_fps:parseInt(i[0]&&i[0].googFrameRateInput)||0,v_fps:parseInt(t[0]&&t[0].googFrameRateSent)||0,s_fps:parseInt(i[0]&&i[0].googFrameRateSent)||0,set_v_quality:this.adapterRef.channelInfo.sessionConfig.videoQuality,real_v_res:(t[0]&&t[0].googFrameWidthSent||0)+"x"+(t[0]&&t[0].googFrameHeightSent||0),real_s_res:(i[0]&&i[0].googFrameWidthSent||0)+"x"+(i[0]&&i[0].googFrameHeightSent||0),real_v_kbps:parseFloat(t[0]&&t[0].googActualEncBitrate)||0,real_s_kbps:parseFloat(i[0]&&i[0].googActualEncBitrate)||0,real_v_kbps_n:parseFloat(t[0]&&t[0].googTransmitBitrate)||0,real_s_kbps_n:parseFloat(i[0]&&i[0].googTransmitBitrate)||0,real_a_kbps:-1,real_a_kbps_n:e[0]?e[0].bitsSentPerSecond:0,set_v_kbps:-1,qos_v_kbps:-1,a_volume:parseInt(e[0]&&e[0].audioInputLevel)||0,a_cap_volume:this.adapterRef.localStream&&Math.round(32768*parseFloat(this.adapterRef.localStream.getAudioLevel()))||0,a_codec:e[0]&&e[0].googCodecName||"opus",a_stream_ended:this.LocalAudioEnable||!1,a_ssrc:e[0]&&e[0].ssrc||"",v_codec:t[0]&&t[0].googCodecName||"h264",s_codec:i[0]&&i[0].googCodecName||"h264",v_stream_ended:this.localVideoEnable||!1,s_stream_ended:this.localScreenEnable||!1,v_ssrc:t[0]&&t[0].ssrc||"",s_ssrc:i[0]&&i[0].ssrc||""},s=48;if(this.adapterRef.localStream&&"speech_low_quality"==this.adapterRef.localStream.audioProfile?s=16:this.adapterRef.localStream&&"speech_standard"==this.adapterRef.localStream.audioProfile&&(s=32),this.adapterRef.sessionStats.SendBitrate=r.real_v_kbps_n+r.real_a_kbps_n,!this.adapterRef.localStream)throw new c.default({code:l.default.NO_LOCALSTREAM,message:"No localStream"});return this.adapterRef.localAudioStats[0]={CodecType:"Opus",MuteState:this.adapterRef.localStream.muteStatus.audio.send,RecordingLevel:r.a_volume,SamplingRate:s,SendBitrate:r.real_a_kbps_n,SendLevel:r.a_volume},this.adapterRef.localVideoStats[0]={LayerType:1,CodecName:t[0]&&t[0].googCodecName,CaptureFrameRate:r.v_cap_fps,CaptureResolutionHeight:parseInt(t[0]&&t[0].googFrameHeightInput)||0,CaptureResolutionWidth:parseInt(t[0]&&t[0].googFrameWidthInput)||0,EncodeDelay:parseInt(t[0]&&t[0].googAvgEncodeMs)||0,MuteState:this.adapterRef.localStream.muteStatus.video.send,SendBitrate:r.real_v_kbps_n,SendFrameRate:r.v_fps,SendResolutionHeight:parseInt(t[0]&&t[0].googFrameHeightSent)||0,SendResolutionWidth:parseInt(t[0]&&t[0].googFrameWidthSent)||0,TargetSendBitrate:parseInt(t[0]&&t[0].googTargetEncBitrate)||0,TotalDuration:this.adapterRef.state.startPubVideoTime?(Date.now()-this.adapterRef.state.startPubVideoTime)/1e3:0,TotalFreezeTime:t[0]?t[0].totalFreezeTime:0},this.adapterRef.localScreenStats[0]={LayerType:2,CodecName:i[0]&&i[0].googCodecName,CaptureFrameRate:r.s_cap_fps,CaptureResolutionHeight:parseInt(i[0]&&i[0].googFrameHeightInput)||0,CaptureResolutionWidth:parseInt(i[0]&&i[0].googFrameWidthInput)||0,EncodeDelay:parseInt(i[0]&&i[0].googAvgEncodeMs)||0,MuteState:this.adapterRef.localStream.muteStatus.screen.send,SendBitrate:r.real_s_kbps_n,SendFrameRate:r.s_fps,SendResolutionHeight:parseInt(i[0]&&i[0].googFrameHeightSent)||0,SendResolutionWidth:parseInt(i[0]&&i[0].googFrameWidthSent)||0,TargetSendBitrate:parseInt(i[0]&&i[0].googTargetEncBitrate)||0,TotalDuration:this.adapterRef.state.startPubScreenTime?(Date.now()-this.adapterRef.state.startPubScreenTime)/1e3:0,TotalFreezeTime:i[0]?i[0].totalFreezeTime:0},this.infos2.tx2[0].v_res.push(r.real_v_res),this.infos2.tx2[0].v_fps.push(r.v_fps),this.infos2.tx2[0].v_plis.push(t[0]&&t[0].googPlisReceived),this.infos2.tx2[0].v_rtt.push(r.rtt),this.infos2.tx2[0].v_simulcast.push(0),this.infos2.tx2[0].v_bw_kbps.push(t[0]&&t[0].googAvailableSendBandwidth),this.infos2.tx2[0].v_tar_kbps.push(t[0]&&t[0].googTargetEncBitrate),this.infos2.tx2[0].v_rel_kbps.push(t[0]&&t[0].googActualEncBitrate),this.infos2.tx2[0].v_tx_kbps.push(t[0]&&t[0].googTransmitBitrate),this.infos2.tx2[0].v_retx_kbps.push(t[0]&&t[0].googRetransmitBitrate),this.infos2.tx2[0].v_delay.push(0),this.infos2.tx2[0].s_res.push(r.real_s_res),this.infos2.tx2[0].s_fps.push(r.s_fps),this.infos2.tx2[0].s_plis.push(i[0]&&i[0].googPlisReceived),this.infos2.tx2[0].s_rtt.push(r.rtt),this.infos2.tx2[0].s_simulcast.push(0),this.infos2.tx2[0].s_bw_kbps.push(i[0]&&i[0].googAvailableSendBandwidth),this.infos2.tx2[0].s_tar_kbps.push(i[0]&&i[0].googTargetEncBitrate),this.infos2.tx2[0].s_rel_kbps.push(i[0]&&i[0].googActualEncBitrate),this.infos2.tx2[0].s_tx_kbps.push(i[0]&&i[0].googTransmitBitrate),this.infos2.tx2[0].s_retx_kbps.push(i[0]&&i[0].googRetransmitBitrate),this.infos2.tx2[0].s_delay.push(0),this.infos2.tx2[0].a_cap_volume.push(r.a_cap_volume),this.infos2.tx2[0].a_rtt.push(e[0]&&e[0].googRtt),r}updateTxMediaInfo(e,t,i){if(!this.adapterRef.localStream)return;this.getLocalMediaStats(e,t,i);let r=((navigator.connection||{}).type||"unknown").toString().toLowerCase();this.infos.net=p.convertNetwork(this.network||r)}dispatchExceptionEventSendAudio(e,t,i){var r,s;if(!e||!t)return;const o=null===(r=this.adapterRef.localStream)||void 0===r?void 0:r.muteStatus.audio.send,n=null===(s=this.adapterRef.localStream)||void 0===s?void 0:s.pubStatus.audio.audio;if(!0===o||!1===n)return;0===parseInt(t.audioInputLevel)&&this.adapterRef.instance.emit("exception",{msg:"AUDIO_INPUT_LEVEL_TOO_LOW",code:2001,uid:i}),0===parseInt(t.bytesSent)-parseInt(e.bytesSent)&&this.adapterRef.instance.emit("exception",{msg:"SEND_AUDIO_BITRATE_TOO_LOW",code:2003,uid:i})}dispatchExceptionEventSendVideo(e,t,i){var r,s;if(!e||!t)return;const o=null===(r=this.adapterRef.localStream)||void 0===r?void 0:r.muteStatus.video.send,n=null===(s=this.adapterRef.localStream)||void 0===s?void 0:s.pubStatus.video.video;if(!0===o||!1===n)return;parseInt(t.googFrameRateInput)>5&&parseInt(t.googFrameRateSent)<=1&&this.adapterRef.instance.emit("exception",{msg:"FRAMERATE_SENT_TOO_LOW",code:1002,uid:i}),0===parseInt(t.bytesSent)-parseInt(e.bytesSent)&&this.adapterRef.instance.emit("exception",{msg:"FRAMERATE_VIDEO_BITRATE_TOO_LOW",code:1003,uid:i})}dispatchExceptionEventRecvAudio(e,t,i){if(!e||!t)return;const r=this.adapterRef.remoteStreamMap[i],s=r&&(r.muteStatus.audio.send||r.muteStatus.audio.recv);if(r&&s)return;let o=parseInt(t.bytesReceived)-parseInt(e.bytesReceived),n=parseInt(t.googDecodingNormal)-parseInt(e.googDecodingNormal);if(o>0&&0===n&&this.adapterRef.instance.emit("exception",{msg:"RECV_AUDIO_DECODE_FAILED",code:2005,uid:i}),o>0&&n>0&&0==+(t.audioOutputLevel||t.audioLevel)){const e=r&&r.Play&&r.Play.audioDom&&r.Play.audioDom.volume;e&&e>0&&this.adapterRef.instance.emit("exception",{msg:"AUDIO_OUTPUT_LEVEL_TOO_LOW",code:2002,uid:i})}}dispatchExceptionEventRecvVideo(e,t,i){if(!e||!t)return;const r=this.adapterRef.remoteStreamMap[i],s=r&&(r.muteStatus.video.send||r.muteStatus.video.recv);if(r&&s)return;parseInt(t.bytesReceived)-parseInt(e.bytesReceived)>0&&0===parseInt(t.googFrameRateDecoded)&&this.adapterRef.instance.emit("exception",{msg:"RECV_VIDEO_DECODE_FAILED",code:1005,uid:i})}dispatchExceptionEventRecvScreen(e,t,i){if(!e||!t)return;const r=this.adapterRef.remoteStreamMap[i],s=r&&(r.muteStatus.screen.send||r.muteStatus.screen.recv);if(r&&s)return;parseInt(t.bytesReceived)-parseInt(e.bytesReceived)>0&&0===parseInt(t.googFrameRateDecoded)&&this.adapterRef.instance.emit("exception",{msg:"RECV_SCREEN_DECODE_FAILED",code:1005,uid:i})}getRemoteAudioFreezeStats(e,t,i){let r=0;if(!e||!t)return{totalFreezeTime:r,freezeTime:0};let s=parseInt(e.googDecodingPLC)+parseInt(e.googDecodingCNG)+parseInt(e.googDecodingPLCCNG),o=parseInt(e.googDecodingCTN),n=parseInt(t.googDecodingPLC)+parseInt(t.googDecodingCNG)+parseInt(t.googDecodingPLCCNG),a=parseInt(t.googDecodingCTN);return a<=s?{totalFreezeTime:r,freezeTime:0}:(n-s)/(a-o)<.2?{totalFreezeTime:0,freezeTime:0}:(this.adapterRef.remoteAudioStats&&this.adapterRef.remoteAudioStats[i]&&(r=this.adapterRef.remoteAudioStats[i].TotalFreezeTime||0),r++,{totalFreezeTime:r,freezeTime:2})}getLocalVideoFreezeStats(e,t){let i=0;if(!e)return{totalFreezeTime:i,freezeTime:0};let r=parseInt(e.googFrameRateInput),s=parseInt(e.googFrameRateSent);return r>5&&s<3?(this.adapterRef.localVideoStats&&this.adapterRef.localVideoStats[0]&&(i=this.adapterRef.localVideoStats[0].TotalFreezeTime||0),i++,{totalFreezeTime:i,freezeTime:2}):{totalFreezeTime:i,freezeTime:0}}getLocalScreenFreezeStats(e,t){let i=0;if(!e)return{totalFreezeTime:i,freezeTime:0};let r=parseInt(e.googFrameRateInput),s=parseInt(e.googFrameRateSent);return r>5&&s<3?(this.adapterRef.localScreenStats&&this.adapterRef.localScreenStats[0]&&(i=this.adapterRef.localScreenStats[0].TotalFreezeTime||0),i++,{totalFreezeTime:i,freezeTime:2}):{totalFreezeTime:i,freezeTime:0}}getRemoteVideoFreezeStats(e,t,i){let r=0;if(!t)return{totalFreezeTime:r,freezeTime:0};let s=parseInt(t.googFrameRateReceived),o=parseInt(t.googFrameRateDecoded);return s>5&&s<10&&o<3||s>10&&s<20&&o<4||s>20&&o<5?(this.adapterRef.remoteVideoStats&&this.adapterRef.remoteVideoStats[i]&&(r=this.adapterRef.remoteVideoStats[i].TotalFreezeTime||0),r++,{totalFreezeTime:r,freezeTime:2}):{totalFreezeTime:r,freezeTime:0}}getRemoteScreenFreezeStats(e,t,i){let r=0;if(!t)return{totalFreezeTime:r,freezeTime:0};let s=parseInt(t.googFrameRateReceived),o=parseInt(t.googFrameRateDecoded);return s>5&&s<10&&o<3||s>10&&s<20&&o<4||s>20&&o<5?(this.adapterRef.remoteScreenStats&&this.adapterRef.remoteScreenStats[i]&&(r=this.adapterRef.remoteScreenStats[i].TotalFreezeTime||0),r++,{totalFreezeTime:r,freezeTime:2}):{totalFreezeTime:r,freezeTime:0}}send(){if(!this.adapterRef.report)return;if(!this.infos.uid||!this.infos.cid)return;let e=new a.DataReport({adapterRef:this.adapterRef});e.setHeartbeat({name:"setHeartbeat",uid:""+this.adapterRef.channelInfo.uid,cid:""+this.adapterRef.channelInfo.cid}),e.send(),this.clearInfoData()}destroy(){this.resetStatus(),this._reset()}};let p={convertNetwork:e=>({wlan:"wifi",lan:"ethernet"}[e]||"unknown"),convertPlatform(e){let t;return t=/Windows/i.test(e)?"Win":e,t=/OS X/i.test(t)?"Mac":t,t},compare:e=>function(t,i){var r=t[e],s=i[e];return 0===s||s?0===r||r?s-r:1:-1}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=i(123);const s=new class{constructor(){this.intervalMap_=new Map}setInterval(e,t,i=!0){const s=r.generateUUID();let o=Date.now(),n=o;this.intervalMap_.set(s,{rafId:null,timeoutId:null,onVisibilityChange:null});const a=()=>{if(i&&document.hidden){e();const i=setTimeout(a,t);this.setTimeoutId(s,i),o=Date.now(),n=o}else{n=Date.now(),n-o>=t&&(o=n,e());const i=requestAnimationFrame(a);this.setRafId(s,i)}},d=requestAnimationFrame(a);if(this.setRafId(s,d),i){const e=()=>{if(document.hidden){const e=Date.now()-o;if(e>=t)a();else{const i=setTimeout(a,t-e);this.setTimeoutId(s,i)}}};document.addEventListener("visibilitychange",e),this.setOnVisibilityChange(s,e)}return s}clearInterval(e){if(this.intervalMap_.has(e)){const{rafId:t,timeoutId:i,onVisibilityChange:r}=this.intervalMap_.get(e);cancelAnimationFrame(t),clearTimeout(i),document.removeEventListener("visibilitychange",r),this.intervalMap_.delete(e)}}setTimeoutId(e,t){if(this.intervalMap_.has(e)){const i=this.intervalMap_.get(e);i.timeoutId&&clearTimeout(i.timeoutId),i.timeoutId=t}}setRafId(e,t){if(this.intervalMap_.has(e)){const i=this.intervalMap_.get(e);i.rafId&&cancelAnimationFrame(i.rafId),i.rafId=t}}setOnVisibilityChange(e,t){if(this.intervalMap_.has(e)){this.intervalMap_.get(e).onVisibilityChange=t}}};t.default=s},function(e,t,i){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const n=i(3),a=i(225),d=o(i(226)),c=i(243);let l=new Uint8Array(1);l[0]=10;const u=l;t.default=class{constructor(e){this.lastLogTime=0,this.cachedLogs=[],this.textEncoder=new TextEncoder,this.url_=e.url,this.socket_=null,this.isConnected_=!1,this.isConnecting_=!1,this.pingPongTimeoutId_=-1,this.pingTimeoutId_=-1,this.reconnectionTimer_=-1,this.reconnectionCount_=0,this.emitter_=new n.EventEmitter,this.adapterRef=e.adapterRef,this.logger=this.adapterRef.logger.getChild(()=>"wsTransport")}init(){this.logger.log("connect to url: "+this.url_),this.socket_=new WebSocket(this.url_),this.bindSocket(this.socket_)}bindSocket(e){e.onopen=this.onopen.bind(this),e.onclose=this.onclose.bind(this),e.onerror=this.onerror.bind(this),e.onmessage=this.onmessage.bind(this)}unbindSocket(e){e.onopen=()=>{},e.onclose=()=>{},e.onerror=()=>{},e.onmessage=()=>{}}onopen(e){if(this.isConnected_)return;this.isConnected_=!0,this.isConnecting_=!1;const t=e.target.url;this.logger.log(`websocket[${t}] is connected`),this.startPingPong()}onclose(e){const t=e.target.url,i=e.target===this.socket_;this.logger.log(`websocket[${t} InUse: ${i}] is closed with code: ${e.code}`),this.socket_&&e.target===this.socket_&&(this.isConnected_=!1,e.wasClean&&1e3===e.code?this.close():(this.logger.warn(`onclose code:${e.code} reason:${e.reason}`),this.socket_.onclose=()=>{},this.socket_.close(4001),this.socket_=null,this.reconnect()))}onerror(e){const t=e.target.url;this.logger.warn(`websocket[${t}] error observed`),this.isConnected_?e.target===this.socket_&&(this.isConnected_=!1,this.socket_=null,this.reconnect()):this.reconnect(),this.isConnecting_=!1,this.isConnected_=!1}onmessage(e){if(this.isConnected_&&e&&e.data){11===JSON.parse(e.data).action&&this.emit(11,e),this.clearReconnectionTimer()}}isConnected(){return this.isConnected_}sendPB(e){var t;if(this.isConnected_){const i=this.createPBMessage(e);1===(null===(t=this.socket_)||void 0===t?void 0:t.readyState)&&this.socket_.send(i)}}sendPing(e){var t;this.isConnected_&&1===(null===(t=this.socket_)||void 0===t?void 0:t.readyState)&&this.socket_.send(e)}sendLog(e){var t,i;const r=Math.max(this.lastLogTime+1,Date.now());if(this.lastLogTime=r,this.cachedLogs.push({time:r,data:e}),this.cachedLogs.length>50&&this.cachedLogs.shift(),this.isConnected_&&1===(null===(t=this.socket_)||void 0===t?void 0:t.readyState)&&(null===(i=this.adapterRef.channelInfo)||void 0===i?void 0:i.cid)){const e=this.cachedLogs;this.cachedLogs=[];for(let t of e){const e=Object.assign({uid:this.adapterRef.channelInfo.uid,cid:this.adapterRef.channelInfo.cid},t);try{const t=this.textEncoder.encode(JSON.stringify(e));let i=[5,1,1,1,2,0,0,0],r=Uint8Array.from(i.concat(Array.from(t)));this.socket_.send(r)}catch(e){}}}}createPBMessage(e){let t=d.Root.fromJSON(c).lookupType("WebrtcStats"),i=t.create(e),r=t.encode(i).finish();return Uint8Array.from([4,1,1,1,1,0,0,0].concat(Array.from(r)))}async startPingPong(){try{if(-1!==this.pingPongTimeoutId_)return;await this.ping(),this.pingPongTimeoutId_=setTimeout(()=>{this.pingPongTimeoutId_=-1,this.startPingPong()},1e4)}catch(e){this.logger.log("ping-pong failed, start reconnection"),this.clearSocket(),this.reconnect()}}stopPingPong(){this.logger.log("stop ping pong"),clearTimeout(this.pingTimeoutId_),clearTimeout(this.pingPongTimeoutId_),this.pingTimeoutId_=-1,this.pingPongTimeoutId_=-1}ping(){return new Promise((e,t)=>{if(-1!==this.pingTimeoutId_)return e();this.sendPing(u),this.once(11,()=>{clearTimeout(this.pingTimeoutId_),this.pingTimeoutId_=-1,e()}),this.pingTimeoutId_=setTimeout(()=>{this.pingTimeoutId_=-1,t()},1e4)})}reconnect(){if(this.isConnecting_||-1!==this.reconnectionTimer_)return void this.logger.log("websocket is reconnecting");this.isConnecting_=!0,this.reconnectionCount_++,this.socket_=new WebSocket(this.url_),this.bindSocket(this.socket_);const e=a.getReconnectionTimeout(this.reconnectionCount_);this.reconnectionTimer_=setTimeout(()=>{this.isConnecting_=!1,this.clearReconnectionTimer(),this.socket_&&this.unbindSocket(this.socket_),this.socket_=null,this.reconnect()},e)}clearReconnectionTimer(){-1!==this.reconnectionTimer_&&(clearTimeout(this.reconnectionTimer_),this.reconnectionTimer_=-1)}once(e,t,i){this.emitter_.once(e,t,i)}emit(e,t,i){this.emitter_.emit(e,t,i)}clearSocket(){this.socket_&&this.unbindSocket(this.socket_),this.isConnected_=!1,this.isConnecting_=!1,this.socket_=null}close(){var e;this.logger.log("close websocket"),this.clearReconnectionTimer(),this.stopPingPong(),null===(e=this.socket_)||void 0===e||e.close(),this.clearSocket()}}},function(e,t,i){"use strict";function r(e,t=1,i=1){return e<=1?i:r(e-1,i,t+i)}Object.defineProperty(t,"__esModule",{value:!0}),t.getReconnectionTimeout=t.fibonacci=void 0,t.fibonacci=r,t.getReconnectionTimeout=function(e){const t=Math.round(e/2)+1;return t>6?13e3:1e3*r(t)}},function(e,t,i){"use strict";e.exports=i(227)},function(e,t,i){"use strict";var r=e.exports=i(124);r.build="full",r.tokenize=i(134),r.parse=i(241),r.common=i(242),r.Root._configure(r.Type,r.parse,r.common)},function(e,t,i){"use strict";var r=t;function s(){r.util._configure(),r.Writer._configure(r.BufferWriter),r.Reader._configure(r.BufferReader)}r.build="minimal",r.Writer=i(77),r.BufferWriter=i(235),r.Reader=i(78),r.BufferReader=i(236),r.util=i(10),r.rpc=i(127),r.roots=i(128),r.configure=s,s()},function(e,t,i){"use strict";var r=t;r.length=function(e){var t=e.length;if(!t)return 0;for(var i=0;--t%4>1&&"="===e.charAt(t);)++i;return Math.ceil(3*e.length)/4-i};for(var s=new Array(64),o=new Array(123),n=0;n<64;)o[s[n]=n<26?n+65:n<52?n+71:n<62?n-4:n-59|43]=n++;r.encode=function(e,t,i){for(var r,o=null,n=[],a=0,d=0;t<i;){var c=e[t++];switch(d){case 0:n[a++]=s[c>>2],r=(3&c)<<4,d=1;break;case 1:n[a++]=s[r|c>>4],r=(15&c)<<2,d=2;break;case 2:n[a++]=s[r|c>>6],n[a++]=s[63&c],d=0}a>8191&&((o||(o=[])).push(String.fromCharCode.apply(String,n)),a=0)}return d&&(n[a++]=s[r],n[a++]=61,1===d&&(n[a++]=61)),o?(a&&o.push(String.fromCharCode.apply(String,n.slice(0,a))),o.join("")):String.fromCharCode.apply(String,n.slice(0,a))};r.decode=function(e,t,i){for(var r,s=i,n=0,a=0;a<e.length;){var d=e.charCodeAt(a++);if(61===d&&n>1)break;if(void 0===(d=o[d]))throw Error("invalid encoding");switch(n){case 0:r=d,n=1;break;case 1:t[i++]=r<<2|(48&d)>>4,r=d,n=2;break;case 2:t[i++]=(15&r)<<4|(60&d)>>2,r=d,n=3;break;case 3:t[i++]=(3&r)<<6|d,n=0}}if(1===n)throw Error("invalid encoding");return i-s},r.test=function(e){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(e)}},function(e,t,i){"use strict";function r(){this._listeners={}}e.exports=r,r.prototype.on=function(e,t,i){return(this._listeners[e]||(this._listeners[e]=[])).push({fn:t,ctx:i||this}),this},r.prototype.off=function(e,t){if(void 0===e)this._listeners={};else if(void 0===t)this._listeners[e]=[];else for(var i=this._listeners[e],r=0;r<i.length;)i[r].fn===t?i.splice(r,1):++r;return this},r.prototype.emit=function(e){var t=this._listeners[e];if(t){for(var i=[],r=1;r<arguments.length;)i.push(arguments[r++]);for(r=0;r<t.length;)t[r].fn.apply(t[r++].ctx,i)}return this}},function(e,t,i){"use strict";function r(e){return"undefined"!=typeof Float32Array?function(){var t=new Float32Array([-0]),i=new Uint8Array(t.buffer),r=128===i[3];function s(e,r,s){t[0]=e,r[s]=i[0],r[s+1]=i[1],r[s+2]=i[2],r[s+3]=i[3]}function o(e,r,s){t[0]=e,r[s]=i[3],r[s+1]=i[2],r[s+2]=i[1],r[s+3]=i[0]}function n(e,r){return i[0]=e[r],i[1]=e[r+1],i[2]=e[r+2],i[3]=e[r+3],t[0]}function a(e,r){return i[3]=e[r],i[2]=e[r+1],i[1]=e[r+2],i[0]=e[r+3],t[0]}e.writeFloatLE=r?s:o,e.writeFloatBE=r?o:s,e.readFloatLE=r?n:a,e.readFloatBE=r?a:n}():function(){function t(e,t,i,r){var s=t<0?1:0;if(s&&(t=-t),0===t)e(1/t>0?0:2147483648,i,r);else if(isNaN(t))e(2143289344,i,r);else if(t>34028234663852886e22)e((s<<31|2139095040)>>>0,i,r);else if(t<11754943508222875e-54)e((s<<31|Math.round(t/1401298464324817e-60))>>>0,i,r);else{var o=Math.floor(Math.log(t)/Math.LN2);e((s<<31|o+127<<23|8388607&Math.round(t*Math.pow(2,-o)*8388608))>>>0,i,r)}}function i(e,t,i){var r=e(t,i),s=2*(r>>31)+1,o=r>>>23&255,n=8388607&r;return 255===o?n?NaN:s*(1/0):0===o?1401298464324817e-60*s*n:s*Math.pow(2,o-150)*(n+8388608)}e.writeFloatLE=t.bind(null,s),e.writeFloatBE=t.bind(null,o),e.readFloatLE=i.bind(null,n),e.readFloatBE=i.bind(null,a)}(),"undefined"!=typeof Float64Array?function(){var t=new Float64Array([-0]),i=new Uint8Array(t.buffer),r=128===i[7];function s(e,r,s){t[0]=e,r[s]=i[0],r[s+1]=i[1],r[s+2]=i[2],r[s+3]=i[3],r[s+4]=i[4],r[s+5]=i[5],r[s+6]=i[6],r[s+7]=i[7]}function o(e,r,s){t[0]=e,r[s]=i[7],r[s+1]=i[6],r[s+2]=i[5],r[s+3]=i[4],r[s+4]=i[3],r[s+5]=i[2],r[s+6]=i[1],r[s+7]=i[0]}function n(e,r){return i[0]=e[r],i[1]=e[r+1],i[2]=e[r+2],i[3]=e[r+3],i[4]=e[r+4],i[5]=e[r+5],i[6]=e[r+6],i[7]=e[r+7],t[0]}function a(e,r){return i[7]=e[r],i[6]=e[r+1],i[5]=e[r+2],i[4]=e[r+3],i[3]=e[r+4],i[2]=e[r+5],i[1]=e[r+6],i[0]=e[r+7],t[0]}e.writeDoubleLE=r?s:o,e.writeDoubleBE=r?o:s,e.readDoubleLE=r?n:a,e.readDoubleBE=r?a:n}():function(){function t(e,t,i,r,s,o){var n=r<0?1:0;if(n&&(r=-r),0===r)e(0,s,o+t),e(1/r>0?0:2147483648,s,o+i);else if(isNaN(r))e(0,s,o+t),e(2146959360,s,o+i);else if(r>17976931348623157e292)e(0,s,o+t),e((n<<31|2146435072)>>>0,s,o+i);else{var a;if(r<22250738585072014e-324)e((a=r/5e-324)>>>0,s,o+t),e((n<<31|a/4294967296)>>>0,s,o+i);else{var d=Math.floor(Math.log(r)/Math.LN2);1024===d&&(d=1023),e(4503599627370496*(a=r*Math.pow(2,-d))>>>0,s,o+t),e((n<<31|d+1023<<20|1048576*a&1048575)>>>0,s,o+i)}}}function i(e,t,i,r,s){var o=e(r,s+t),n=e(r,s+i),a=2*(n>>31)+1,d=n>>>20&2047,c=4294967296*(1048575&n)+o;return 2047===d?c?NaN:a*(1/0):0===d?5e-324*a*c:a*Math.pow(2,d-1075)*(c+4503599627370496)}e.writeDoubleLE=t.bind(null,s,0,4),e.writeDoubleBE=t.bind(null,o,4,0),e.readDoubleLE=i.bind(null,n,0,4),e.readDoubleBE=i.bind(null,a,4,0)}(),e}function s(e,t,i){t[i]=255&e,t[i+1]=e>>>8&255,t[i+2]=e>>>16&255,t[i+3]=e>>>24}function o(e,t,i){t[i]=e>>>24,t[i+1]=e>>>16&255,t[i+2]=e>>>8&255,t[i+3]=255&e}function n(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0}function a(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}e.exports=r(r)},function(e,t,i){"use strict";var r=t;r.length=function(e){for(var t=0,i=0,r=0;r<e.length;++r)(i=e.charCodeAt(r))<128?t+=1:i<2048?t+=2:55296==(64512&i)&&56320==(64512&e.charCodeAt(r+1))?(++r,t+=4):t+=3;return t},r.read=function(e,t,i){if(i-t<1)return"";for(var r,s=null,o=[],n=0;t<i;)(r=e[t++])<128?o[n++]=r:r>191&&r<224?o[n++]=(31&r)<<6|63&e[t++]:r>239&&r<365?(r=((7&r)<<18|(63&e[t++])<<12|(63&e[t++])<<6|63&e[t++])-65536,o[n++]=55296+(r>>10),o[n++]=56320+(1023&r)):o[n++]=(15&r)<<12|(63&e[t++])<<6|63&e[t++],n>8191&&((s||(s=[])).push(String.fromCharCode.apply(String,o)),n=0);return s?(n&&s.push(String.fromCharCode.apply(String,o.slice(0,n))),s.join("")):String.fromCharCode.apply(String,o.slice(0,n))},r.write=function(e,t,i){for(var r,s,o=i,n=0;n<e.length;++n)(r=e.charCodeAt(n))<128?t[i++]=r:r<2048?(t[i++]=r>>6|192,t[i++]=63&r|128):55296==(64512&r)&&56320==(64512&(s=e.charCodeAt(n+1)))?(r=65536+((1023&r)<<10)+(1023&s),++n,t[i++]=r>>18|240,t[i++]=r>>12&63|128,t[i++]=r>>6&63|128,t[i++]=63&r|128):(t[i++]=r>>12|224,t[i++]=r>>6&63|128,t[i++]=63&r|128);return i-o}},function(e,t,i){"use strict";e.exports=function(e,t,i){var r=i||8192,s=r>>>1,o=null,n=r;return function(i){if(i<1||i>s)return e(i);n+i>r&&(o=e(r),n=0);var a=t.call(o,n,n+=i);return 7&n&&(n=1+(7|n)),a}}},function(e,t,i){"use strict";e.exports=s;var r=i(10);function s(e,t){this.lo=e>>>0,this.hi=t>>>0}var o=s.zero=new s(0,0);o.toNumber=function(){return 0},o.zzEncode=o.zzDecode=function(){return this},o.length=function(){return 1};var n=s.zeroHash="\0\0\0\0\0\0\0\0";s.fromNumber=function(e){if(0===e)return o;var t=e<0;t&&(e=-e);var i=e>>>0,r=(e-i)/4294967296>>>0;return t&&(r=~r>>>0,i=~i>>>0,++i>4294967295&&(i=0,++r>4294967295&&(r=0))),new s(i,r)},s.from=function(e){if("number"==typeof e)return s.fromNumber(e);if(r.isString(e)){if(!r.Long)return s.fromNumber(parseInt(e,10));e=r.Long.fromString(e)}return e.low||e.high?new s(e.low>>>0,e.high>>>0):o},s.prototype.toNumber=function(e){if(!e&&this.hi>>>31){var t=1+~this.lo>>>0,i=~this.hi>>>0;return t||(i=i+1>>>0),-(t+4294967296*i)}return this.lo+4294967296*this.hi},s.prototype.toLong=function(e){return r.Long?new r.Long(0|this.lo,0|this.hi,Boolean(e)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(e)}};var a=String.prototype.charCodeAt;s.fromHash=function(e){return e===n?o:new s((a.call(e,0)|a.call(e,1)<<8|a.call(e,2)<<16|a.call(e,3)<<24)>>>0,(a.call(e,4)|a.call(e,5)<<8|a.call(e,6)<<16|a.call(e,7)<<24)>>>0)},s.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},s.prototype.zzEncode=function(){var e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this},s.prototype.zzDecode=function(){var e=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this},s.prototype.length=function(){var e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,i=this.hi>>>24;return 0===i?0===t?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:i<128?9:10}},function(e,t,i){"use strict";e.exports=o;var r=i(77);(o.prototype=Object.create(r.prototype)).constructor=o;var s=i(10);function o(){r.call(this)}function n(e,t,i){e.length<40?s.utf8.write(e,t,i):t.utf8Write?t.utf8Write(e,i):t.write(e,i)}o._configure=function(){o.alloc=s._Buffer_allocUnsafe,o.writeBytesBuffer=s.Buffer&&s.Buffer.prototype instanceof Uint8Array&&"set"===s.Buffer.prototype.set.name?function(e,t,i){t.set(e,i)}:function(e,t,i){if(e.copy)e.copy(t,i,0,e.length);else for(var r=0;r<e.length;)t[i++]=e[r++]}},o.prototype.bytes=function(e){s.isString(e)&&(e=s._Buffer_from(e,"base64"));var t=e.length>>>0;return this.uint32(t),t&&this._push(o.writeBytesBuffer,t,e),this},o.prototype.string=function(e){var t=s.Buffer.byteLength(e);return this.uint32(t),t&&this._push(n,t,e),this},o._configure()},function(e,t,i){"use strict";e.exports=o;var r=i(78);(o.prototype=Object.create(r.prototype)).constructor=o;var s=i(10);function o(e){r.call(this,e)}o._configure=function(){s.Buffer&&(o.prototype._slice=s.Buffer.prototype.slice)},o.prototype.string=function(){var e=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+e,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+e,this.len))},o._configure()},function(e,t,i){"use strict";e.exports=s;var r=i(10);function s(e,t,i){if("function"!=typeof e)throw TypeError("rpcImpl must be a function");r.EventEmitter.call(this),this.rpcImpl=e,this.requestDelimited=Boolean(t),this.responseDelimited=Boolean(i)}(s.prototype=Object.create(r.EventEmitter.prototype)).constructor=s,s.prototype.rpcCall=function e(t,i,s,o,n){if(!o)throw TypeError("request must be specified");var a=this;if(!n)return r.asPromise(e,a,t,i,s,o);if(a.rpcImpl)try{return a.rpcImpl(t,i[a.requestDelimited?"encodeDelimited":"encode"](o).finish(),(function(e,i){if(e)return a.emit("error",e,t),n(e);if(null!==i){if(!(i instanceof s))try{i=s[a.responseDelimited?"decodeDelimited":"decode"](i)}catch(e){return a.emit("error",e,t),n(e)}return a.emit("data",i,t),n(null,i)}a.end(!0)}))}catch(e){return a.emit("error",e,t),void setTimeout((function(){n(e)}),0)}else setTimeout((function(){n(Error("already ended"))}),0)},s.prototype.end=function(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},function(e,t,i){"use strict";function r(e,t){"string"==typeof e&&(t=e,e=void 0);var i=[];function s(e){if("string"!=typeof e){var t=o();if(r.verbose&&console.log("codegen: "+t),t="return "+t,e){for(var n=Object.keys(e),a=new Array(n.length+1),d=new Array(n.length),c=0;c<n.length;)a[c]=n[c],d[c]=e[n[c++]];return a[c]=t,Function.apply(null,a).apply(null,d)}return Function(t)()}for(var l=new Array(arguments.length-1),u=0;u<l.length;)l[u]=arguments[++u];if(u=0,e=e.replace(/%([%dfijs])/g,(function(e,t){var i=l[u++];switch(t){case"d":case"f":return String(Number(i));case"i":return String(Math.floor(i));case"j":return JSON.stringify(i);case"s":return String(i)}return"%"})),u!==l.length)throw Error("parameter count mismatch");return i.push(e),s}function o(r){return"function "+(r||t||"")+"("+(e&&e.join(",")||"")+"){\n  "+i.join("\n  ")+"\n}"}return s.toString=o,s}e.exports=r,r.verbose=!1},function(e,t,i){"use strict";e.exports=o;var r=i(125),s=i(126)("fs");function o(e,t,i){return"function"==typeof t?(i=t,t={}):t||(t={}),i?!t.xhr&&s&&s.readFile?s.readFile(e,(function(r,s){return r&&"undefined"!=typeof XMLHttpRequest?o.xhr(e,t,i):r?i(r):i(null,t.binary?s:s.toString("utf8"))})):o.xhr(e,t,i):r(o,this,e,t)}o.xhr=function(e,t,i){var r=new XMLHttpRequest;r.onreadystatechange=function(){if(4===r.readyState){if(0!==r.status&&200!==r.status)return i(Error("status "+r.status));if(t.binary){var e=r.response;if(!e){e=[];for(var s=0;s<r.responseText.length;++s)e.push(255&r.responseText.charCodeAt(s))}return i(null,"undefined"!=typeof Uint8Array?new Uint8Array(e):e)}return i(null,r.responseText)}},t.binary&&("overrideMimeType"in r&&r.overrideMimeType("text/plain; charset=x-user-defined"),r.responseType="arraybuffer"),r.open("GET",e),r.send()}},function(e,t,i){"use strict";var r=t,s=r.isAbsolute=function(e){return/^(?:\/|\w+:)/.test(e)},o=r.normalize=function(e){var t=(e=e.replace(/\\/g,"/").replace(/\/{2,}/g,"/")).split("/"),i=s(e),r="";i&&(r=t.shift()+"/");for(var o=0;o<t.length;)".."===t[o]?o>0&&".."!==t[o-1]?t.splice(--o,2):i?t.splice(o,1):++o:"."===t[o]?t.splice(o,1):++o;return r+t.join("/")};r.resolve=function(e,t,i){return i||(t=o(t)),s(t)?t:(i||(e=o(e)),(e=e.replace(/(?:\/|^)[^/]+$/,"")).length?o(e+"/"+t):t)}},function(e,t,i){"use strict";e.exports=T,T.filename=null,T.defaults={keepCase:!1};var r=i(134),s=i(84),o=i(79),n=i(21),a=i(80),d=i(41),c=i(8),l=i(81),u=i(82),p=i(30),h=i(4),f=/^[1-9][0-9]*$/,m=/^-?[1-9][0-9]*$/,g=/^0[x][0-9a-fA-F]+$/,v=/^-?0[x][0-9a-fA-F]+$/,y=/^0[0-7]+$/,_=/^-?0[0-7]+$/,S=/^(?![eE])[0-9]*(?:\.[0-9]*)?(?:[eE][+-]?[0-9]+)?$/,b=/^[a-zA-Z_][a-zA-Z_0-9]*$/,R=/^(?:\.?[a-zA-Z_][a-zA-Z_0-9]*)(?:\.[a-zA-Z_][a-zA-Z_0-9]*)*$/,w=/^(?:\.[a-zA-Z_][a-zA-Z_0-9]*)+$/;function T(e,t,i){t instanceof s||(i=t,t=new s),i||(i=T.defaults);var A,E,I,O,C,P=i.preferTrailingComment||!1,k=r(e,i.alternateCommentMode||!1),x=k.next,D=k.push,N=k.peek,M=k.skip,L=k.cmnt,F=!0,j=!1,V=t,U=i.keepCase?function(e){return e}:h.camelCase;function B(e,t,i){var r=T.filename;return i||(T.filename=null),Error("illegal "+(t||"token")+" '"+e+"' ("+(r?r+", ":"")+"line "+k.line+")")}function $(){var e,t=[];do{if('"'!==(e=x())&&"'"!==e)throw B(e);t.push(x()),M(e),e=N()}while('"'===e||"'"===e);return t.join("")}function H(e){var t=x();switch(t){case"'":case'"':return D(t),$();case"true":case"TRUE":return!0;case"false":case"FALSE":return!1}try{return function(e,t){var i=1;"-"===e.charAt(0)&&(i=-1,e=e.substring(1));switch(e){case"inf":case"INF":case"Inf":return i*(1/0);case"nan":case"NAN":case"Nan":case"NaN":return NaN;case"0":return 0}if(f.test(e))return i*parseInt(e,10);if(g.test(e))return i*parseInt(e,16);if(y.test(e))return i*parseInt(e,8);if(S.test(e))return i*parseFloat(e);throw B(e,"number",t)}(t,!0)}catch(i){if(e&&R.test(t))return t;throw B(t,"value")}}function W(e,t){var i,r;do{!t||'"'!==(i=N())&&"'"!==i?e.push([r=q(x()),M("to",!0)?q(x()):r]):e.push($())}while(M(",",!0));M(";")}function q(e,t){switch(e){case"max":case"MAX":case"Max":return 536870911;case"0":return 0}if(!t&&"-"===e.charAt(0))throw B(e,"id");if(m.test(e))return parseInt(e,10);if(v.test(e))return parseInt(e,16);if(_.test(e))return parseInt(e,8);throw B(e,"id")}function G(){if(void 0!==A)throw B("package");if(A=x(),!R.test(A))throw B(A,"name");V=V.define(A),M(";")}function J(){var e,t=N();switch(t){case"weak":e=I||(I=[]),x();break;case"public":x();default:e=E||(E=[])}t=$(),M(";"),e.push(t)}function z(){if(M("="),O=$(),!(j="proto3"===O)&&"proto2"!==O)throw B(O,"syntax");M(";")}function Q(e,t){switch(t){case"option":return X(e,t),M(";"),!0;case"message":return function(e,t){if(!b.test(t=x()))throw B(t,"type name");var i=new o(t);Y(i,(function(e){if(!Q(i,e))switch(e){case"map":!function(e){M("<");var t=x();if(void 0===p.mapKey[t])throw B(t,"type");M(",");var i=x();if(!R.test(i))throw B(i,"type");M(">");var r=x();if(!b.test(r))throw B(r,"name");M("=");var s=new a(U(r),q(x()),t,i);Y(s,(function(e){if("option"!==e)throw B(e);X(s,e),M(";")}),(function(){te(s)})),e.add(s)}(i);break;case"required":case"repeated":K(i,e);break;case"optional":K(i,j?"proto3_optional":"optional");break;case"oneof":!function(e,t){if(!b.test(t=x()))throw B(t,"name");var i=new d(U(t));Y(i,(function(e){"option"===e?(X(i,e),M(";")):(D(e),K(i,"optional"))})),e.add(i)}(i,e);break;case"extensions":W(i.extensions||(i.extensions=[]));break;case"reserved":W(i.reserved||(i.reserved=[]),!0);break;default:if(!j||!R.test(e))throw B(e);D(e),K(i,"optional")}})),e.add(i)}(e,t),!0;case"enum":return function(e,t){if(!b.test(t=x()))throw B(t,"name");var i=new c(t);Y(i,(function(e){switch(e){case"option":X(i,e),M(";");break;case"reserved":W(i.reserved||(i.reserved=[]),!0);break;default:!function(e,t){if(!b.test(t))throw B(t,"name");M("=");var i=q(x(),!0),r={};Y(r,(function(e){if("option"!==e)throw B(e);X(r,e),M(";")}),(function(){te(r)})),e.add(t,i,r.comment)}(i,e)}})),e.add(i)}(e,t),!0;case"service":return function(e,t){if(!b.test(t=x()))throw B(t,"service name");var i=new l(t);Y(i,(function(e){if(!Q(i,e)){if("rpc"!==e)throw B(e);!function(e,t){var i=L(),r=t;if(!b.test(t=x()))throw B(t,"name");var s,o,n,a,d=t;M("("),M("stream",!0)&&(o=!0);if(!R.test(t=x()))throw B(t);s=t,M(")"),M("returns"),M("("),M("stream",!0)&&(a=!0);if(!R.test(t=x()))throw B(t);n=t,M(")");var c=new u(d,r,s,n,o,a);c.comment=i,Y(c,(function(e){if("option"!==e)throw B(e);X(c,e),M(";")})),e.add(c)}(i,e)}})),e.add(i)}(e,t),!0;case"extend":return function(e,t){if(!R.test(t=x()))throw B(t,"reference");var i=t;Y(null,(function(t){switch(t){case"required":case"repeated":K(e,t,i);break;case"optional":K(e,j?"proto3_optional":"optional",i);break;default:if(!j||!R.test(t))throw B(t);D(t),K(e,"optional",i)}}))}(e,t),!0}return!1}function Y(e,t,i){var r=k.line;if(e&&("string"!=typeof e.comment&&(e.comment=L()),e.filename=T.filename),M("{",!0)){for(var s;"}"!==(s=x());)t(s);M(";",!0)}else i&&i(),M(";"),e&&("string"!=typeof e.comment||P)&&(e.comment=L(r)||e.comment)}function K(e,t,i){var r=x();if("group"!==r){if(!R.test(r))throw B(r,"type");var s=x();if(!b.test(s))throw B(s,"name");s=U(s),M("=");var a=new n(s,q(x()),r,t,i);if(Y(a,(function(e){if("option"!==e)throw B(e);X(a,e),M(";")}),(function(){te(a)})),"proto3_optional"===t){var c=new d("_"+s);a.setOption("proto3_optional",!0),c.add(a),e.add(c)}else e.add(a);j||!a.repeated||void 0===p.packed[r]&&void 0!==p.basic[r]||a.setOption("packed",!1,!0)}else!function(e,t){var i=x();if(!b.test(i))throw B(i,"name");var r=h.lcFirst(i);i===r&&(i=h.ucFirst(i));M("=");var s=q(x()),a=new o(i);a.group=!0;var d=new n(r,s,i,t);d.filename=T.filename,Y(a,(function(e){switch(e){case"option":X(a,e),M(";");break;case"required":case"repeated":K(a,e);break;case"optional":K(a,j?"proto3_optional":"optional");break;default:throw B(e)}})),e.add(a).add(d)}(e,t)}function X(e,t){var i=M("(",!0);if(!R.test(t=x()))throw B(t,"name");var r,s=t,o=s;i&&(M(")"),o=s="("+s+")",t=N(),w.test(t)&&(r=t.substr(1),s+=t,x())),M("="),function(e,t,i,r){e.setParsedOption&&e.setParsedOption(t,i,r)}(e,o,Z(e,s),r)}function Z(e,t){if(M("{",!0)){for(var i={};!M("}",!0);){if(!b.test(C=x()))throw B(C,"name");var r,s=C;"{"===N()?r=Z(e,t+"."+C):(M(":"),"{"===N()?r=Z(e,t+"."+C):(r=H(!0),ee(e,t+"."+C,r)));var o=i[s];o&&(r=[].concat(o).concat(r)),i[s]=r,M(",",!0)}return i}var n=H(!0);return ee(e,t,n),n}function ee(e,t,i){e.setOption&&e.setOption(t,i)}function te(e){if(M("[",!0)){do{X(e,"option")}while(M(",",!0));M("]")}return e}for(;null!==(C=x());)switch(C){case"package":if(!F)throw B(C);G();break;case"import":if(!F)throw B(C);J();break;case"syntax":if(!F)throw B(C);z();break;case"option":X(V,C),M(";");break;default:if(Q(V,C)){F=!1;continue}throw B(C)}return T.filename=null,{package:A,imports:E,weakImports:I,syntax:O,root:t}}},function(e,t,i){"use strict";e.exports=o;var r,s=/\/|\./;function o(e,t){s.test(e)||(e="google/protobuf/"+e+".proto",t={nested:{google:{nested:{protobuf:{nested:t}}}}}),o[e]=t}o("any",{Any:{fields:{type_url:{type:"string",id:1},value:{type:"bytes",id:2}}}}),o("duration",{Duration:r={fields:{seconds:{type:"int64",id:1},nanos:{type:"int32",id:2}}}}),o("timestamp",{Timestamp:r}),o("empty",{Empty:{fields:{}}}),o("struct",{Struct:{fields:{fields:{keyType:"string",type:"Value",id:1}}},Value:{oneofs:{kind:{oneof:["nullValue","numberValue","stringValue","boolValue","structValue","listValue"]}},fields:{nullValue:{type:"NullValue",id:1},numberValue:{type:"double",id:2},stringValue:{type:"string",id:3},boolValue:{type:"bool",id:4},structValue:{type:"Struct",id:5},listValue:{type:"ListValue",id:6}}},NullValue:{values:{NULL_VALUE:0}},ListValue:{fields:{values:{rule:"repeated",type:"Value",id:1}}}}),o("wrappers",{DoubleValue:{fields:{value:{type:"double",id:1}}},FloatValue:{fields:{value:{type:"float",id:1}}},Int64Value:{fields:{value:{type:"int64",id:1}}},UInt64Value:{fields:{value:{type:"uint64",id:1}}},Int32Value:{fields:{value:{type:"int32",id:1}}},UInt32Value:{fields:{value:{type:"uint32",id:1}}},BoolValue:{fields:{value:{type:"bool",id:1}}},StringValue:{fields:{value:{type:"string",id:1}}},BytesValue:{fields:{value:{type:"bytes",id:1}}}}),o("field_mask",{FieldMask:{fields:{paths:{rule:"repeated",type:"string",id:1}}}}),o.get=function(e){return o[e]||null}},function(e,t,i){"use strict";var r=i(244),s=(r.roots.default||(r.roots.default=new r.Root)).addJSON({WebrtcStats:{fields:{local:{type:"local_obj",id:1},remote:{type:"remote_obj",id:2},timestamp:{type:"int64",id:3},appkey:{type:"string",id:4},cid:{type:"int64",id:5},uid:{type:"int64",id:6},browser:{type:"string",id:7},platform:{type:"string",id:8}},nested:{local_obj:{fields:{video_bwe:{rule:"repeated",type:"video_bwe_obj",id:1},audio_ssrc:{rule:"repeated",type:"audio_ssrc_obj",id:2},video_ssrc:{rule:"repeated",type:"video_ssrc_obj",id:3},media_source:{rule:"repeated",type:"media_source_obj",id:4},candidate_pair:{rule:"repeated",type:"candidate_pair_obj",id:5},local_candidate:{rule:"repeated",type:"local_candidate_obj",id:6},remote_candidate:{rule:"repeated",type:"remote_candidate_obj",id:7},track:{rule:"repeated",type:"track_obj",id:8},outbound_rtp:{rule:"repeated",type:"outbound_rtp_obj",id:9},remote_inbound_rtp:{rule:"repeated",type:"remote_inbound_rtp_obj",id:10},transport:{rule:"repeated",type:"transport_obj",id:11},audio_track:{rule:"repeated",type:"audio_track_obj",id:12},video_track:{rule:"repeated",type:"video_track_obj",id:13},audio_outbound_rtp:{rule:"repeated",type:"audio_outbound_rtp_obj",id:14},video_outbound_rtp:{rule:"repeated",type:"video_outbound_rtp_obj",id:15},screen_ssrc:{rule:"repeated",type:"screen_ssrc_obj",id:16},screen_outbound_rtp:{rule:"repeated",type:"screen_outbound_rtp_obj",id:17}},nested:{video_bwe_obj:{fields:{googActualEncBitrate:{type:"string",id:1},googAvailableSendBandwidth:{type:"string",id:2},googRetransmitBitrate:{type:"string",id:3},googAvailableReceiveBandwidth:{type:"string",id:4},googTargetEncBitrate:{type:"string",id:5},googBucketDelay:{type:"string",id:6},googTransmitBitrate:{type:"string",id:7},id:{type:"string",id:8},type:{type:"string",id:9},timestamp:{type:"string",id:10}}},audio_ssrc_obj:{fields:{audioInputLevel:{type:"string",id:1},packetsLost:{type:"string",id:2},googRtt:{type:"string",id:3},totalSamplesDuration:{type:"string",id:4},googEchoCancellationReturnLossEnhancement:{type:"string",id:5},googTrackId:{type:"string",id:6},totalAudioEnergy:{type:"string",id:7},transportId:{type:"string",id:8},mediaType:{type:"string",id:9},googEchoCancellationReturnLoss:{type:"string",id:10},googCodecName:{type:"string",id:11},ssrc:{type:"string",id:12},googJitterReceived:{type:"string",id:13},googTypingNoiseState:{type:"string",id:14},packetsSent:{type:"string",id:15},bytesSent:{type:"string",id:16},id:{type:"string",id:17},type:{type:"string",id:18},timestamp:{type:"string",id:19},localuid:{type:"int64",id:20},remoteuid:{type:"int64",id:21},bitsSentPerSecond:{type:"int64",id:22},packetsSentPerSecond:{type:"int64",id:23},sendPacketLoss:{type:"int64",id:24},bytesSentPerSecond:{type:"int64",id:25},alr:{type:"int64",id:26}}},video_ssrc_obj:{fields:{googContentType:{type:"string",id:1},googFrameWidthInput:{type:"string",id:2},googFrameWidthSent:{type:"string",id:3},packetsLost:{type:"string",id:4},googRtt:{type:"string",id:5},googHasEnteredLowResolution:{type:"string",id:6},googEncodeUsagePercent:{type:"string",id:7},googCpuLimitedResolution:{type:"string",id:8},googNacksReceived:{type:"string",id:9},googBandwidthLimitedResolution:{type:"string",id:10},googFrameHeightInput:{type:"string",id:11},googAvgEncodeMs:{type:"string",id:12},googTrackId:{type:"string",id:13},googFrameRateInput:{type:"string",id:14},framesEncoded:{type:"string",id:15},codecImplementationName:{type:"string",id:16},transportId:{type:"string",id:17},mediaType:{type:"string",id:18},googFrameHeightSent:{type:"string",id:19},googFrameRateSent:{type:"string",id:20},googCodecName:{type:"string",id:21},hugeFramesSent:{type:"string",id:22},qpSum:{type:"string",id:23},googPlisReceived:{type:"string",id:24},googAdaptationChanges:{type:"string",id:25},ssrc:{type:"string",id:26},googFirsReceived:{type:"string",id:27},packetsSent:{type:"string",id:28},bytesSent:{type:"string",id:29},id:{type:"string",id:30},type:{type:"string",id:31},timestamp:{type:"string",id:32},localuid:{type:"int64",id:33},remoteuid:{type:"int64",id:34},bitsSentPerSecond:{type:"int64",id:35},packetsSentPerSecond:{type:"int64",id:36},sendPacketLoss:{type:"int64",id:37},freezeTime:{type:"int64",id:38},totalFreezeTime:{type:"int64",id:39},bytesSentPerSecond:{type:"int64",id:40},framesEncodedPerSecond:{type:"int64",id:41},googActualEncBitrate:{type:"string",id:42},googAvailableSendBandwidth:{type:"string",id:43},googRetransmitBitrate:{type:"string",id:44},googAvailableReceiveBandwidth:{type:"string",id:45},googTargetEncBitrate:{type:"string",id:46},googBucketDelay:{type:"string",id:47},googTransmitBitrate:{type:"string",id:48},vlr:{type:"int64",id:49}}},screen_ssrc_obj:{fields:{googContentType:{type:"string",id:1},googFrameWidthInput:{type:"string",id:2},googFrameWidthSent:{type:"string",id:3},packetsLost:{type:"string",id:4},googRtt:{type:"string",id:5},googHasEnteredLowResolution:{type:"string",id:6},googEncodeUsagePercent:{type:"string",id:7},googCpuLimitedResolution:{type:"string",id:8},googNacksReceived:{type:"string",id:9},googBandwidthLimitedResolution:{type:"string",id:10},googFrameHeightInput:{type:"string",id:11},googAvgEncodeMs:{type:"string",id:12},googTrackId:{type:"string",id:13},googFrameRateInput:{type:"string",id:14},framesEncoded:{type:"string",id:15},codecImplementationName:{type:"string",id:16},transportId:{type:"string",id:17},mediaType:{type:"string",id:18},googFrameHeightSent:{type:"string",id:19},googFrameRateSent:{type:"string",id:20},googCodecName:{type:"string",id:21},hugeFramesSent:{type:"string",id:22},qpSum:{type:"string",id:23},googPlisReceived:{type:"string",id:24},googAdaptationChanges:{type:"string",id:25},ssrc:{type:"string",id:26},googFirsReceived:{type:"string",id:27},packetsSent:{type:"string",id:28},bytesSent:{type:"string",id:29},id:{type:"string",id:30},type:{type:"string",id:31},timestamp:{type:"string",id:32},localuid:{type:"int64",id:33},remoteuid:{type:"int64",id:34},bitsSentPerSecond:{type:"int64",id:35},packetsSentPerSecond:{type:"int64",id:36},sendPacketLoss:{type:"int64",id:37},freezeTime:{type:"int64",id:38},totalFreezeTime:{type:"int64",id:39},bytesSentPerSecond:{type:"int64",id:40},framesEncodedPerSecond:{type:"int64",id:41},googActualEncBitrate:{type:"string",id:42},googAvailableSendBandwidth:{type:"string",id:43},googRetransmitBitrate:{type:"string",id:44},googAvailableReceiveBandwidth:{type:"string",id:45},googTargetEncBitrate:{type:"string",id:46},googBucketDelay:{type:"string",id:47},googTransmitBitrate:{type:"string",id:48},vlr:{type:"int64",id:49}}},media_source_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"double",id:2},type:{type:"string",id:3},trackIdentifier:{type:"string",id:4},kind:{type:"string",id:5},width:{type:"int64",id:6},height:{type:"int64",id:7},framesPerSecond:{type:"int64",id:8},frames:{type:"int64",id:9}}},candidate_pair_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"double",id:2},type:{type:"string",id:3},transportId:{type:"string",id:4},localCandidateId:{type:"string",id:5},remoteCandidateId:{type:"string",id:6},state:{type:"string",id:7},priority:{type:"int64",id:8},nominated:{type:"bool",id:9},writable:{type:"bool",id:10},bytesSent:{type:"int64",id:11},bytesReceived:{type:"int64",id:12},totalRoundTripTime:{type:"double",id:13},currentRoundTripTime:{type:"double",id:14},availableOutgoingBitrate:{type:"int64",id:15},requestsReceived:{type:"int64",id:16},requestsSent:{type:"int64",id:17},responsesReceived:{type:"int64",id:18},responsesSent:{type:"int64",id:19},consentRequestsSent:{type:"int64",id:20},lastPacketReceivedTimestamp:{type:"int64",id:21},lastPacketSentTimestamp:{type:"int64",id:22},readable:{type:"bool",id:23},selected:{type:"bool",id:24}}},local_candidate_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"double",id:2},type:{type:"string",id:3},transportId:{type:"string",id:4},isRemote:{type:"bool",id:5},networkType:{type:"string",id:6},ip:{type:"string",id:7},port:{type:"int64",id:8},protocol:{type:"string",id:9},candidateType:{type:"string",id:10},priority:{type:"int64",id:11},deleted:{type:"bool",id:12},address:{type:"string",id:13}}},remote_candidate_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"double",id:2},type:{type:"string",id:3},transportId:{type:"string",id:4},isRemote:{type:"bool",id:5},ip:{type:"string",id:6},port:{type:"int64",id:7},protocol:{type:"string",id:8},candidateType:{type:"string",id:9},priority:{type:"int64",id:10},deleted:{type:"bool",id:11},address:{type:"string",id:12}}},track_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"double",id:2},type:{type:"string",id:3},trackIdentifier:{type:"string",id:4},mediaSourceId:{type:"string",id:5},remoteSource:{type:"bool",id:6},ended:{type:"bool",id:7},detached:{type:"bool",id:8},kind:{type:"string",id:9},frameWidth:{type:"int64",id:10},frameHeight:{type:"int64",id:11},framesSent:{type:"int64",id:12},hugeFramesSent:{type:"int64",id:13}}},outbound_rtp_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"double",id:2},type:{type:"string",id:3},ssrc:{type:"int64",id:4},isRemote:{type:"bool",id:5},mediaType:{type:"string",id:6},kind:{type:"string",id:7},trackId:{type:"string",id:8},transportId:{type:"string",id:9},codecId:{type:"string",id:10},firCount:{type:"int64",id:11},pliCount:{type:"int64",id:12},nackCount:{type:"int64",id:13},qpSum:{type:"int64",id:14},mediaSourceId:{type:"string",id:15},remoteId:{type:"string",id:16},packetsSent:{type:"int64",id:17},retransmittedPacketsSent:{type:"int64",id:18},bytesSent:{type:"int64",id:19},headerBytesSent:{type:"int64",id:20},retransmittedBytesSent:{type:"int64",id:21},framesEncoded:{type:"int64",id:22},keyFramesEncoded:{type:"int64",id:23},totalEncodeTime:{type:"double",id:24},totalEncodedBytesTarget:{type:"int64",id:25},frameWidth:{type:"int64",id:26},frameHeight:{type:"int64",id:27},framesPerSecond:{type:"int64",id:28},framesSent:{type:"int64",id:29},hugeFramesSent:{type:"int64",id:30},totalPacketSendDelay:{type:"double",id:31},qualityLimitationReason:{type:"string",id:32},qualityLimitationResolutionChanges:{type:"int64",id:33},encoderImplementation:{type:"string",id:34},contentType:{type:"string",id:35},bitrateMean:{type:"double",id:36},bitrateStdDev:{type:"double",id:37},droppedFrames:{type:"int64",id:38},framerateMean:{type:"double",id:39},framerateStdDev:{type:"double",id:40},quality_limitation_durations:{rule:"repeated",type:"quality_limitation_durations_obj",id:41}},nested:{quality_limitation_durations_obj:{fields:{other:{type:"int64",id:1},cpu:{type:"int64",id:2},bandwidth:{type:"int64",id:3},none:{type:"int64",id:4}}}}},remote_inbound_rtp_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"double",id:2},type:{type:"string",id:3},ssrc:{type:"int64",id:4},kind:{type:"string",id:5},transportId:{type:"string",id:6},codecId:{type:"string",id:7},packetsLost:{type:"int64",id:8},jitter:{type:"double",id:9},localId:{type:"string",id:10},roundTripTime:{type:"double",id:11},fractionLost:{type:"double",id:12},totalRoundTripTime:{type:"double",id:13},roundTripTimeMeasurements:{type:"double",id:14}}},transport_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"double",id:2},type:{type:"string",id:3},bytesSent:{type:"int64",id:4},packetsSent:{type:"int64",id:5},bytesReceived:{type:"int64",id:6},packetsReceived:{type:"int64",id:7},dtlsState:{type:"string",id:8},selectedCandidatePairId:{type:"string",id:9},localCertificateId:{type:"string",id:10},remoteCertificateId:{type:"string",id:11},tlsVersion:{type:"string",id:12},dtlsCipher:{type:"string",id:13},srtpCipher:{type:"string",id:14},selectedCandidatePairChanges:{type:"int64",id:15}}},audio_track_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"int64",id:2},type:{type:"string",id:3},detached:{type:"bool",id:4},ended:{type:"bool",id:5},remoteSource:{type:"bool",id:6},trackIdentifier:{type:"string",id:7},mediaType:{type:"string",id:8},ssrc:{type:"int64",id:9},uid:{type:"string",id:10}}},video_track_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"int64",id:2},type:{type:"string",id:3},detached:{type:"bool",id:4},ended:{type:"bool",id:5},frameHeight:{type:"int64",id:6},frameWidth:{type:"int64",id:7},framesSent:{type:"int64",id:8},remoteSource:{type:"bool",id:9},trackIdentifier:{type:"string",id:10},ssrc:{type:"int64",id:11},frameRateSent:{type:"int64",id:12},mediaType:{type:"string",id:13},framesSentPerSecond:{type:"int64",id:14},uid:{type:"string",id:15}}},audio_outbound_rtp_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"int64",id:2},type:{type:"string",id:3},codecId:{type:"string",id:4},kind:{type:"string",id:5},mediaType:{type:"string",id:6},ssrc:{type:"int64",id:7},transportId:{type:"string",id:8},bytesSent:{type:"int64",id:9},packetsSent:{type:"int64",id:10},headerBytesSent:{type:"int64",id:11},mediaSourceId:{type:"string",id:12},remoteId:{type:"string",id:13},retransmittedBytesSent:{type:"int64",id:14},retransmittedPacketsSent:{type:"int64",id:15},trackId:{type:"string",id:16},bitsSentPerSecond:{type:"int64",id:17},packetsSentPerSecond:{type:"int64",id:18},bytesSentPerSecond:{type:"int64",id:19},nackCount:{type:"int64",id:20},isRemote:{type:"bool",id:21},qpSum:{type:"int64",id:22},uid:{type:"string",id:23}}},video_outbound_rtp_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"int64",id:2},type:{type:"string",id:3},codecId:{type:"string",id:4},kind:{type:"string",id:5},mediaType:{type:"string",id:6},ssrc:{type:"int64",id:7},transportId:{type:"string",id:8},bytesSent:{type:"int64",id:9},packetsSent:{type:"int64",id:10},firCount:{type:"int64",id:11},frameHeight:{type:"int64",id:12},frameWidth:{type:"int64",id:13},framesEncoded:{type:"int64",id:14},framesPerSecond:{type:"int64",id:15},framesSent:{type:"int64",id:16},headerBytesSent:{type:"int64",id:17},hugeFramesSent:{type:"int64",id:18},keyFramesEncoded:{type:"int64",id:19},mediaSourceId:{type:"string",id:20},nackCount:{type:"int64",id:21},pliCount:{type:"int64",id:22},qpSum:{type:"int64",id:23},qualityLimitationResolutionChanges:{type:"int64",id:24},remoteId:{type:"string",id:25},retransmittedBytesSent:{type:"int64",id:26},retransmittedPacketsSent:{type:"int64",id:27},totalEncodeTime:{type:"double",id:28},totalEncodedBytesTarget:{type:"int64",id:29},totalPacketSendDelay:{type:"double",id:30},trackId:{type:"string",id:31},bitsSentPerSecond:{type:"int64",id:32},packetsSentPerSecond:{type:"int64",id:33},frameRateSent:{type:"int64",id:34},bytesSentPerSecond:{type:"int64",id:35},framesEncodedPerSecond:{type:"int64",id:36},bitrateMean:{type:"int64",id:37},bitrateStdDev:{type:"int64",id:38},droppedFrames:{type:"int64",id:39},framerateMean:{type:"int64",id:40},framerateStdDev:{type:"int64",id:41},isRemote:{type:"bool",id:42},uid:{type:"string",id:43}}},screen_outbound_rtp_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"int64",id:2},type:{type:"string",id:3},kind:{type:"string",id:4},mediaType:{type:"string",id:5},ssrc:{type:"int64",id:6},bytesSent:{type:"int64",id:7},packetsSent:{type:"int64",id:8},bitrateMean:{type:"double",id:9},bitrateStdDev:{type:"double",id:10},droppedFrames:{type:"int64",id:11},firCount:{type:"int64",id:12},framerateMean:{type:"int64",id:13},framerateStdDev:{type:"int64",id:14},framesEncoded:{type:"int64",id:15},nackCount:{type:"int64",id:16},pliCount:{type:"int64",id:17},bytesSentPerSecond:{type:"int64",id:18},framesEncodedPerSecond:{type:"int64",id:19},packetsSentPerSecond:{type:"int64",id:20},remoteId:{type:"string",id:21}}}}},remote_obj:{fields:{video_ssrc:{rule:"repeated",type:"video_ssrc_obj",id:1},audio_ssrc:{rule:"repeated",type:"audio_ssrc_obj",id:2},candidate_pair:{rule:"repeated",type:"candidate_pair_obj",id:3},remote_candidate:{rule:"repeated",type:"remote_candidate_obj",id:4},local_candidate:{rule:"repeated",type:"local_candidate_obj",id:5},inbound_rtp:{rule:"repeated",type:"inbound_rtp_obj",id:6},track:{rule:"repeated",type:"track_obj",id:7},transport:{rule:"repeated",type:"transport_obj",id:8},audio_inbound_rtp:{rule:"repeated",type:"audio_inbound_rtp_obj",id:9},video_inbound_rtp:{rule:"repeated",type:"video_inbound_rtp_obj",id:10},audio_track:{rule:"repeated",type:"audio_track_obj",id:11},video_track:{rule:"repeated",type:"video_track_obj",id:12},screen_ssrc:{rule:"repeated",type:"screen_ssrc_obj",id:13},screen_inbound_rtp:{rule:"repeated",type:"screen_inbound_rtp_obj",id:14}},nested:{video_ssrc_obj:{fields:{googContentType:{type:"string",id:1},googCaptureStartNtpTimeMs:{type:"string",id:2},googTargetDelayMs:{type:"string",id:3},packetsLost:{type:"string",id:4},googDecodeMs:{type:"string",id:5},googFrameHeightReceived:{type:"string",id:6},googFrameRateOutput:{type:"string",id:7},packetsReceived:{type:"string",id:8},ssrc:{type:"string",id:9},googRenderDelayMs:{type:"string",id:10},googMaxDecodeMs:{type:"string",id:11},googTrackId:{type:"string",id:12},googFrameWidthReceived:{type:"string",id:13},codecImplementationName:{type:"string",id:14},transportId:{type:"string",id:15},mediaType:{type:"string",id:16},googInterframeDelayMax:{type:"string",id:17},googCodecName:{type:"string",id:18},googFrameRateReceived:{type:"string",id:19},framesDecoded:{type:"string",id:20},googNacksSent:{type:"string",id:21},googFirsSent:{type:"string",id:22},bytesReceived:{type:"string",id:23},googFirstFrameReceivedToDecodedMs:{type:"string",id:24},googCurrentDelayMs:{type:"string",id:25},googMinPlayoutDelayMs:{type:"string",id:26},googFrameRateDecoded:{type:"string",id:27},googJitterBufferMs:{type:"string",id:28},googPlisSent:{type:"string",id:29},id:{type:"string",id:30},type:{type:"string",id:31},timestamp:{type:"string",id:32},localuid:{type:"int64",id:33},remoteuid:{type:"string",id:34},bitsReceivedPerSecond:{type:"int64",id:35},packetsReceivedPerSecond:{type:"int64",id:36},recvPacketLoss:{type:"int64",id:37},freezeTime:{type:"int64",id:38},totalFreezeTime:{type:"int64",id:39},bytesReceivedPerSecond:{type:"int64",id:40},framesDecodedPerSecond:{type:"int64",id:41},packetsLostRate:{type:"double",id:42}}},audio_ssrc_obj:{fields:{googDecodingCTN:{type:"string",id:1},packetsLost:{type:"string",id:2},googSecondaryDecodedRate:{type:"string",id:3},googDecodingPLC:{type:"string",id:4},packetsReceived:{type:"string",id:5},googJitterReceived:{type:"string",id:6},googDecodingCNG:{type:"string",id:7},ssrc:{type:"string",id:8},googPreferredJitterBufferMs:{type:"string",id:9},googSpeechExpandRate:{type:"string",id:10},totalSamplesDuration:{type:"string",id:11},totalAudioEnergy:{type:"string",id:12},transportId:{type:"string",id:13},mediaType:{type:"string",id:14},googDecodingPLCCNG:{type:"string",id:15},googCodecName:{type:"string",id:16},googSecondaryDiscardedRate:{type:"string",id:17},googDecodingNormal:{type:"string",id:18},googTrackId:{type:"string",id:19},audioOutputLevel:{type:"string",id:20},googAccelerateRate:{type:"string",id:21},bytesReceived:{type:"string",id:22},googCurrentDelayMs:{type:"string",id:23},googDecodingCTSG:{type:"string",id:24},googExpandRate:{type:"string",id:25},googPreemptiveExpandRate:{type:"string",id:26},googJitterBufferMs:{type:"string",id:27},googDecodingMuted:{type:"string",id:28},id:{type:"string",id:29},type:{type:"string",id:30},timestamp:{type:"string",id:31},localuid:{type:"int64",id:32},remoteuid:{type:"string",id:33},bitsReceivedPerSecond:{type:"int64",id:34},packetsReceivedPerSecond:{type:"int64",id:35},recvPacketLoss:{type:"int64",id:36},freezeTime:{type:"int64",id:37},totalFreezeTime:{type:"int64",id:38},bytesReceivedPerSecond:{type:"int64",id:39},packetsLostRate:{type:"double",id:40},packetsLostPerSecond:{type:"double",id:41},alr:{type:"double",id:42}}},candidate_pair_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"double",id:2},type:{type:"string",id:3},transportId:{type:"string",id:4},localCandidateId:{type:"string",id:5},remoteCandidateId:{type:"string",id:6},state:{type:"string",id:7},priority:{type:"int64",id:8},nominated:{type:"bool",id:9},writable:{type:"bool",id:10},bytesSent:{type:"int64",id:11},bytesReceived:{type:"int64",id:12},totalRoundTripTime:{type:"double",id:13},currentRoundTripTime:{type:"double",id:14},availableOutgoingBitrate:{type:"int64",id:15},requestsReceived:{type:"int64",id:16},requestsSent:{type:"int64",id:17},responsesReceived:{type:"int64",id:18},responsesSent:{type:"int64",id:19},consentRequestsSent:{type:"int64",id:20},lastPacketReceivedTimestamp:{type:"int64",id:21},lastPacketSentTimestamp:{type:"int64",id:22},readable:{type:"bool",id:23},selected:{type:"bool",id:24}}},remote_candidate_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"double",id:2},type:{type:"string",id:3},transportId:{type:"string",id:4},isRemote:{type:"bool",id:5},ip:{type:"string",id:6},port:{type:"int64",id:7},protocol:{type:"string",id:8},candidateType:{type:"string",id:9},priority:{type:"int64",id:10},deleted:{type:"bool",id:11},address:{type:"string",id:12}}},local_candidate_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"double",id:2},type:{type:"string",id:3},transportId:{type:"string",id:4},isRemote:{type:"bool",id:5},networkType:{type:"string",id:6},ip:{type:"string",id:7},port:{type:"int64",id:8},protocol:{type:"string",id:9},candidateType:{type:"string",id:10},priority:{type:"int64",id:11},deleted:{type:"bool",id:12},address:{type:"string",id:13}}},inbound_rtp_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"double",id:2},type:{type:"string",id:3},ssrc:{type:"int64",id:4},isRemote:{type:"bool",id:5},mediaType:{type:"string",id:6},kind:{type:"string",id:7},trackId:{type:"string",id:8},transportId:{type:"string",id:9},codecId:{type:"string",id:10},packetsReceived:{type:"int64",id:11},fecPacketsReceived:{type:"int64",id:12},fecPacketsDiscarded:{type:"int64",id:13},bytesReceived:{type:"int64",id:14},headerBytesReceived:{type:"int64",id:15},packetsLost:{type:"int64",id:16},lastPacketReceivedTimestamp:{type:"double",id:17},jitter:{type:"double",id:18},jitterBufferDelay:{type:"double",id:19},jitterBufferEmittedCount:{type:"int64",id:20},totalSamplesReceived:{type:"int64",id:21},concealedSamples:{type:"int64",id:22},silentConcealedSamples:{type:"int64",id:23},concealmentEvents:{type:"int64",id:24},insertedSamplesForDeceleration:{type:"int64",id:25},removedSamplesForAcceleration:{type:"int64",id:26},audioLevel:{type:"double",id:27},totalAudioEnergy:{type:"double",id:28},totalSamplesDuration:{type:"double",id:29},estimatedPlayoutTimestamp:{type:"int64",id:30},decoderImplementation:{type:"string",id:31},discardedPackets:{type:"int64",id:32},bitrateMean:{type:"int64",id:33},bitrateStdDev:{type:"int64",id:34},framerateMean:{type:"int64",id:35},framerateStdDev:{type:"int64",id:36}}},track_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"double",id:2},type:{type:"string",id:3},trackIdentifier:{type:"string",id:4},remoteSource:{type:"bool",id:5},ended:{type:"bool",id:6},detached:{type:"bool",id:7},kind:{type:"string",id:8},jitterBufferDelay:{type:"double",id:9},jitterBufferEmittedCount:{type:"int64",id:10},audioLevel:{type:"double",id:11},totalAudioEnergy:{type:"double",id:12},totalSamplesReceived:{type:"int64",id:13},totalSamplesDuration:{type:"double",id:14},concealedSamples:{type:"int64",id:15},silentConcealedSamples:{type:"int64",id:16},concealmentEvents:{type:"int64",id:17},insertedSamplesForDeceleration:{type:"int64",id:18},removedSamplesForAcceleration:{type:"int64",id:19},frameWidth:{type:"int64",id:20},frameHeight:{type:"int64",id:21},framesReceived:{type:"int64",id:22},framesDecoded:{type:"int64",id:23},framesDropped:{type:"int64",id:24}}},transport_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"double",id:2},type:{type:"string",id:3},bytesSent:{type:"int64",id:4},packetsSent:{type:"int64",id:5},bytesReceived:{type:"int64",id:6},packetsReceived:{type:"int64",id:7},dtlsState:{type:"string",id:8},selectedCandidatePairId:{type:"string",id:9},localCertificateId:{type:"string",id:10},remoteCertificateId:{type:"string",id:11},tlsVersion:{type:"string",id:12},dtlsCipher:{type:"string",id:13},srtpCipher:{type:"string",id:14},selectedCandidatePairChanges:{type:"int64",id:15}}},audio_inbound_rtp_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"int64",id:2},type:{type:"string",id:3},codecId:{type:"string",id:4},kind:{type:"string",id:5},mediaType:{type:"string",id:6},ssrc:{type:"int64",id:7},transportId:{type:"string",id:8},jitter:{type:"double",id:9},packetsLost:{type:"int64",id:10},packetsReceived:{type:"int64",id:11},audioLevel:{type:"int64",id:12},bytesReceived:{type:"int64",id:13},concealedSamples:{type:"int64",id:14},concealmentEvents:{type:"int64",id:15},estimatedPlayoutTimestamp:{type:"int64",id:16},fecPacketsDiscarded:{type:"int64",id:17},fecPacketsReceived:{type:"int64",id:18},headerBytesReceived:{type:"int64",id:19},insertedSamplesForDeceleration:{type:"int64",id:20},jitterBufferDelay:{type:"double",id:21},jitterBufferEmittedCount:{type:"int64",id:22},lastPacketReceivedTimestamp:{type:"double",id:23},removedSamplesForAcceleration:{type:"int64",id:24},silentConcealedSamples:{type:"int64",id:25},totalAudioEnergy:{type:"double",id:26},totalSamplesDuration:{type:"double",id:27},totalSamplesReceived:{type:"int64",id:28},trackId:{type:"string",id:29},bitsReceivedPerSecond:{type:"int64",id:30},packetsReceivedPerSecond:{type:"int64",id:31},uid:{type:"string",id:32},bytesReceivedPerSecond:{type:"int64",id:33},packetsLostRate:{type:"double",id:34},recvPacketLoss:{type:"int64",id:35},remoteuid:{type:"string",id:36},isRemote:{type:"bool",id:37},packetsLostPerSecond:{type:"int64",id:38},qpSum:{type:"int64",id:39}}},video_inbound_rtp_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"int64",id:2},type:{type:"string",id:3},codecId:{type:"string",id:4},kind:{type:"string",id:5},mediaType:{type:"string",id:6},ssrc:{type:"int64",id:7},transportId:{type:"string",id:8},packetsLost:{type:"int64",id:9},packetsReceived:{type:"int64",id:10},bytesReceived:{type:"int64",id:11},estimatedPlayoutTimestamp:{type:"int64",id:12},firCount:{type:"int64",id:13},frameHeight:{type:"int64",id:14},frameWidth:{type:"int64",id:15},framesDecoded:{type:"int64",id:16},framesPerSecond:{type:"int64",id:17},framesReceived:{type:"int64",id:18},headerBytesReceived:{type:"int64",id:19},keyFramesDecoded:{type:"int64",id:20},lastPacketReceivedTimestamp:{type:"int64",id:21},nackCount:{type:"int64",id:22},pliCount:{type:"int64",id:23},totalDecodeTime:{type:"double",id:24},totalInterFrameDelay:{type:"double",id:25},totalSquaredInterFrameDelay:{type:"double",id:26},trackId:{type:"string",id:27},bitsReceivedPerSecond:{type:"int64",id:28},packetsReceivedPerSecond:{type:"int64",id:29},uid:{type:"string",id:30},bytesReceivedPerSecond:{type:"int64",id:31},packetsLostRate:{type:"double",id:32},framesDecodedPerSecond:{type:"double",id:33},recvPacketLoss:{type:"int64",id:34},remoteuid:{type:"string",id:35},isRemote:{type:"bool",id:36},qpSum:{type:"int64",id:37}}},screen_inbound_rtp_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"int64",id:2},type:{type:"string",id:3},kind:{type:"string",id:4},mediaType:{type:"string",id:5},ssrc:{type:"int64",id:6},discardedPackets:{type:"int64",id:7},jitter:{type:"double",id:8},packetsLost:{type:"int64",id:9},packetsReceived:{type:"int64",id:10},bitrateMean:{type:"double",id:11},bitrateStdDev:{type:"double",id:12},bytesReceived:{type:"int64",id:13},firCount:{type:"int64",id:14},framerateMean:{type:"double",id:15},framerateStdDev:{type:"double",id:16},framesDecoded:{type:"int64",id:17},nackCount:{type:"int64",id:18},pliCount:{type:"int64",id:19},remoteId:{type:"string",id:20},targetUid:{type:"string",id:21},bytesReceivedPerSecond:{type:"int64",id:22},packetsLostPerSecond:{type:"int64",id:23},framesDecodedPerSecond:{type:"int64",id:24},recvPacketLoss:{type:"int64",id:25},packetsReceivedPerSecond:{type:"int64",id:26},remoteuid:{type:"string",id:27}}},audio_track_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"int64",id:2},type:{type:"string",id:3},audioLevel:{type:"double",id:4},detached:{type:"bool",id:5},ended:{type:"bool",id:6},jitterBufferFlushes:{type:"int64",id:7},remoteSource:{type:"bool",id:8},trackIdentifier:{type:"string",id:9},mediaType:{type:"string",id:10},ssrc:{type:"int64",id:11},uid:{type:"string",id:12}}},video_track_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"int64",id:2},type:{type:"string",id:3},detached:{type:"bool",id:4},ended:{type:"bool",id:5},frameHeight:{type:"int64",id:6},frameWidth:{type:"int64",id:7},framesDecoded:{type:"int64",id:8},framesDropped:{type:"int64",id:9},framesReceived:{type:"int64",id:10},freezeCount:{type:"int64",id:11},pauseCount:{type:"int64",id:12},remoteSource:{type:"bool",id:13},sumOfSquaredFramesDuration:{type:"double",id:14},totalFramesDuration:{type:"double",id:15},totalFreezesDuration:{type:"double",id:16},totalPausesDuration:{type:"int64",id:17},trackIdentifier:{type:"string",id:18},ssrc:{type:"int64",id:19},mediaType:{type:"string",id:20},uid:{type:"string",id:21}}},screen_ssrc_obj:{fields:{googContentType:{type:"string",id:1},googCaptureStartNtpTimeMs:{type:"string",id:2},googTargetDelayMs:{type:"string",id:3},packetsLost:{type:"string",id:4},googDecodeMs:{type:"string",id:5},googFrameHeightReceived:{type:"string",id:6},googFrameRateOutput:{type:"string",id:7},packetsReceived:{type:"string",id:8},ssrc:{type:"string",id:9},googRenderDelayMs:{type:"string",id:10},googMaxDecodeMs:{type:"string",id:11},googTrackId:{type:"string",id:12},googFrameWidthReceived:{type:"string",id:13},codecImplementationName:{type:"string",id:14},transportId:{type:"string",id:15},mediaType:{type:"string",id:16},googInterframeDelayMax:{type:"string",id:17},googCodecName:{type:"string",id:18},googFrameRateReceived:{type:"string",id:19},framesDecoded:{type:"string",id:20},googNacksSent:{type:"string",id:21},googFirsSent:{type:"string",id:22},bytesReceived:{type:"string",id:23},googFirstFrameReceivedToDecodedMs:{type:"string",id:24},googCurrentDelayMs:{type:"string",id:25},googMinPlayoutDelayMs:{type:"string",id:26},googFrameRateDecoded:{type:"string",id:27},googJitterBufferMs:{type:"string",id:28},googPlisSent:{type:"string",id:29},id:{type:"string",id:30},type:{type:"string",id:31},timestamp:{type:"string",id:32},localuid:{type:"int64",id:33},remoteuid:{type:"string",id:34},bitsReceivedPerSecond:{type:"int64",id:35},packetsReceivedPerSecond:{type:"int64",id:36},recvPacketLoss:{type:"int64",id:37},freezeTime:{type:"int64",id:38},totalFreezeTime:{type:"int64",id:39},bytesReceivedPerSecond:{type:"int64",id:40},framesDecodedPerSecond:{type:"int64",id:41},packetsLostRate:{type:"double",id:42},packetsLostPerSecond:{type:"double",id:43},vlr:{type:"int64",id:44}}}}}}}});e.exports=s},function(e,t,i){"use strict";e.exports=i(124)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=Object.prototype.hasOwnProperty;Object.prototype.toString;t.default=function(e){if(null==e)return!0;if("boolean"==typeof e)return!1;if("number"==typeof e)return 0===e;if("string"==typeof e)return 0===e.length;if("function"==typeof e)return 0===e.length;if(Array.isArray(e))return 0===e.length;if(e instanceof Error)return""===e.message;if(function(e){if(!e||"object"!=typeof e||"[object Object]"!=Object.prototype.toString.call(e))return!1;var t=Object.getPrototypeOf(e);if(null===t)return!0;var i=Object.prototype.hasOwnProperty.call(t,"constructor")&&t.constructor;return"function"==typeof i&&i instanceof i&&Function.prototype.toString.call(i)===Function.prototype.toString.call(Object)}(e))switch(Object.prototype.toString.call(e)){case"[object File]":case"[object Map]":case"[object Set]":return 0===e.size;case"[object Object]":for(var t in e)if(r.call(e,t))return!1;return!0}return!1}},function(module,exports,__webpack_require__){(function(process,global){var __WEBPACK_AMD_DEFINE_RESULT__;
/*
 * [js-sha1]{@link https://github.com/emn178/js-sha1}
 *
 * @version 0.6.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2017
 * @license MIT
 */!function(){"use strict";var root="object"==typeof window?window:{},NODE_JS=!root.JS_SHA1_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node;NODE_JS&&(root=global);var COMMON_JS=!root.JS_SHA1_NO_COMMON_JS&&"object"==typeof module&&module.exports,AMD=__webpack_require__(247),HEX_CHARS="0123456789abcdef".split(""),EXTRA=[-2147483648,8388608,32768,128],SHIFT=[24,16,8,0],OUTPUT_TYPES=["hex","array","digest","arrayBuffer"],blocks=[],createOutputMethod=function(e){return function(t){return new Sha1(!0).update(t)[e]()}},createMethod=function(){var e=createOutputMethod("hex");NODE_JS&&(e=nodeWrap(e)),e.create=function(){return new Sha1},e.update=function(t){return e.create().update(t)};for(var t=0;t<OUTPUT_TYPES.length;++t){var i=OUTPUT_TYPES[t];e[i]=createOutputMethod(i)}return e},nodeWrap=function(method){var crypto=eval("require('crypto')"),Buffer=eval("require('buffer').Buffer"),nodeMethod=function(e){if("string"==typeof e)return crypto.createHash("sha1").update(e,"utf8").digest("hex");if(e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(void 0===e.length)return method(e);return crypto.createHash("sha1").update(new Buffer(e)).digest("hex")};return nodeMethod};function Sha1(e){e?(blocks[0]=blocks[16]=blocks[1]=blocks[2]=blocks[3]=blocks[4]=blocks[5]=blocks[6]=blocks[7]=blocks[8]=blocks[9]=blocks[10]=blocks[11]=blocks[12]=blocks[13]=blocks[14]=blocks[15]=0,this.blocks=blocks):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Sha1.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===root.ArrayBuffer&&(e=new Uint8Array(e));for(var i,r,s=0,o=e.length||0,n=this.blocks;s<o;){if(this.hashed&&(this.hashed=!1,n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),t)for(r=this.start;s<o&&r<64;++s)n[r>>2]|=e[s]<<SHIFT[3&r++];else for(r=this.start;s<o&&r<64;++s)(i=e.charCodeAt(s))<128?n[r>>2]|=i<<SHIFT[3&r++]:i<2048?(n[r>>2]|=(192|i>>6)<<SHIFT[3&r++],n[r>>2]|=(128|63&i)<<SHIFT[3&r++]):i<55296||i>=57344?(n[r>>2]|=(224|i>>12)<<SHIFT[3&r++],n[r>>2]|=(128|i>>6&63)<<SHIFT[3&r++],n[r>>2]|=(128|63&i)<<SHIFT[3&r++]):(i=65536+((1023&i)<<10|1023&e.charCodeAt(++s)),n[r>>2]|=(240|i>>18)<<SHIFT[3&r++],n[r>>2]|=(128|i>>12&63)<<SHIFT[3&r++],n[r>>2]|=(128|i>>6&63)<<SHIFT[3&r++],n[r>>2]|=(128|63&i)<<SHIFT[3&r++]);this.lastByteIndex=r,this.bytes+=r-this.start,r>=64?(this.block=n[16],this.start=r-64,this.hash(),this.hashed=!0):this.start=r}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},Sha1.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=EXTRA[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},Sha1.prototype.hash=function(){var e,t,i=this.h0,r=this.h1,s=this.h2,o=this.h3,n=this.h4,a=this.blocks;for(e=16;e<80;++e)t=a[e-3]^a[e-8]^a[e-14]^a[e-16],a[e]=t<<1|t>>>31;for(e=0;e<20;e+=5)i=(t=(r=(t=(s=(t=(o=(t=(n=(t=i<<5|i>>>27)+(r&s|~r&o)+n+1518500249+a[e]<<0)<<5|n>>>27)+(i&(r=r<<30|r>>>2)|~i&s)+o+1518500249+a[e+1]<<0)<<5|o>>>27)+(n&(i=i<<30|i>>>2)|~n&r)+s+1518500249+a[e+2]<<0)<<5|s>>>27)+(o&(n=n<<30|n>>>2)|~o&i)+r+1518500249+a[e+3]<<0)<<5|r>>>27)+(s&(o=o<<30|o>>>2)|~s&n)+i+1518500249+a[e+4]<<0,s=s<<30|s>>>2;for(;e<40;e+=5)i=(t=(r=(t=(s=(t=(o=(t=(n=(t=i<<5|i>>>27)+(r^s^o)+n+1859775393+a[e]<<0)<<5|n>>>27)+(i^(r=r<<30|r>>>2)^s)+o+1859775393+a[e+1]<<0)<<5|o>>>27)+(n^(i=i<<30|i>>>2)^r)+s+1859775393+a[e+2]<<0)<<5|s>>>27)+(o^(n=n<<30|n>>>2)^i)+r+1859775393+a[e+3]<<0)<<5|r>>>27)+(s^(o=o<<30|o>>>2)^n)+i+1859775393+a[e+4]<<0,s=s<<30|s>>>2;for(;e<60;e+=5)i=(t=(r=(t=(s=(t=(o=(t=(n=(t=i<<5|i>>>27)+(r&s|r&o|s&o)+n-1894007588+a[e]<<0)<<5|n>>>27)+(i&(r=r<<30|r>>>2)|i&s|r&s)+o-1894007588+a[e+1]<<0)<<5|o>>>27)+(n&(i=i<<30|i>>>2)|n&r|i&r)+s-1894007588+a[e+2]<<0)<<5|s>>>27)+(o&(n=n<<30|n>>>2)|o&i|n&i)+r-1894007588+a[e+3]<<0)<<5|r>>>27)+(s&(o=o<<30|o>>>2)|s&n|o&n)+i-1894007588+a[e+4]<<0,s=s<<30|s>>>2;for(;e<80;e+=5)i=(t=(r=(t=(s=(t=(o=(t=(n=(t=i<<5|i>>>27)+(r^s^o)+n-899497514+a[e]<<0)<<5|n>>>27)+(i^(r=r<<30|r>>>2)^s)+o-899497514+a[e+1]<<0)<<5|o>>>27)+(n^(i=i<<30|i>>>2)^r)+s-899497514+a[e+2]<<0)<<5|s>>>27)+(o^(n=n<<30|n>>>2)^i)+r-899497514+a[e+3]<<0)<<5|r>>>27)+(s^(o=o<<30|o>>>2)^n)+i-899497514+a[e+4]<<0,s=s<<30|s>>>2;this.h0=this.h0+i<<0,this.h1=this.h1+r<<0,this.h2=this.h2+s<<0,this.h3=this.h3+o<<0,this.h4=this.h4+n<<0},Sha1.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,i=this.h2,r=this.h3,s=this.h4;return HEX_CHARS[e>>28&15]+HEX_CHARS[e>>24&15]+HEX_CHARS[e>>20&15]+HEX_CHARS[e>>16&15]+HEX_CHARS[e>>12&15]+HEX_CHARS[e>>8&15]+HEX_CHARS[e>>4&15]+HEX_CHARS[15&e]+HEX_CHARS[t>>28&15]+HEX_CHARS[t>>24&15]+HEX_CHARS[t>>20&15]+HEX_CHARS[t>>16&15]+HEX_CHARS[t>>12&15]+HEX_CHARS[t>>8&15]+HEX_CHARS[t>>4&15]+HEX_CHARS[15&t]+HEX_CHARS[i>>28&15]+HEX_CHARS[i>>24&15]+HEX_CHARS[i>>20&15]+HEX_CHARS[i>>16&15]+HEX_CHARS[i>>12&15]+HEX_CHARS[i>>8&15]+HEX_CHARS[i>>4&15]+HEX_CHARS[15&i]+HEX_CHARS[r>>28&15]+HEX_CHARS[r>>24&15]+HEX_CHARS[r>>20&15]+HEX_CHARS[r>>16&15]+HEX_CHARS[r>>12&15]+HEX_CHARS[r>>8&15]+HEX_CHARS[r>>4&15]+HEX_CHARS[15&r]+HEX_CHARS[s>>28&15]+HEX_CHARS[s>>24&15]+HEX_CHARS[s>>20&15]+HEX_CHARS[s>>16&15]+HEX_CHARS[s>>12&15]+HEX_CHARS[s>>8&15]+HEX_CHARS[s>>4&15]+HEX_CHARS[15&s]},Sha1.prototype.toString=Sha1.prototype.hex,Sha1.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,i=this.h2,r=this.h3,s=this.h4;return[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,i>>24&255,i>>16&255,i>>8&255,255&i,r>>24&255,r>>16&255,r>>8&255,255&r,s>>24&255,s>>16&255,s>>8&255,255&s]},Sha1.prototype.array=Sha1.prototype.digest,Sha1.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};var exports=createMethod();COMMON_JS?module.exports=exports:(root.sha1=exports,AMD&&(__WEBPACK_AMD_DEFINE_RESULT__=function(){return exports}.call(exports,__webpack_require__,exports,module),void 0===__WEBPACK_AMD_DEFINE_RESULT__||(module.exports=__WEBPACK_AMD_DEFINE_RESULT__)))}()}).call(this,__webpack_require__(109),__webpack_require__(56))},function(e,t){(function(t){e.exports=t}).call(this,{})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MediaCapability=void 0;const r=i(249),s=i(14),o=i(2);t.MediaCapability=class{constructor(e){this.logger=e.logger.getChild(()=>{let t="codec"+this.room.videoCodecType.join(",");return this.supportedCodecSend&&2===this.supportedCodecSend.length&&this.supportedCodecRecv&&2===this.supportedCodecRecv.length||(t+=`/${this.supportedCodecSend}/${this.supportedCodecRecv}`),e.mediaCapability!==this&&(t+=" DETACHED"),t}),this.supportedCodecRecv=null,this.supportedCodecSend=null,this.preferredCodecSend={video:["H264","VP8"],screen:["H264","VP8"]},this.room={videoCodecType:[]}}async detect(){const e=Date.now();let t=await s.getSupportedCodecs("recv")||{video:[],audio:["OPUS"]},i=await s.getSupportedCodecs("send")||{video:[],audio:["OPUS"]};if(o.getParameters().h264Wait){if(-1===t.video.indexOf("H264"))for(this.logger.warn(`当前浏览器不支持H264解码。这可能会触发频道内编码协商。最多等待 ${o.getParameters().h264Wait} 毫秒以避免编码器尚未加载。`);Date.now()-e<o.getParameters().h264Wait;){if(t=await s.getSupportedCodecs("recv")||{video:[],audio:["OPUS"]},-1!==t.video.indexOf("H264")){this.logger.log(`H264解码器加载完成！用时 ${Date.now()-e} 毫秒`);break}await new Promise(e=>{setTimeout(e,100)})}-1===t.video.indexOf("H264")&&this.logger.warn("H264解码器加载失败！")}this.supportedCodecRecv=t.video,this.supportedCodecSend=i.video,this.logger.log("detect supportedCodecRecv",JSON.stringify(this.supportedCodecRecv),"supportedCodecSend",JSON.stringify(this.supportedCodecSend),"Preferred codec:",JSON.stringify(this.preferredCodecSend))}getCodecCapability(){if(this.supportedCodecRecv&&this.supportedCodecSend){const e=[];for(let t of s.VideoCodecList)this.supportedCodecRecv.indexOf(t)>-1&&this.supportedCodecSend.indexOf(t)>-1&&e.push(t);return e}return this.logger.error("getCodecCapability: call detect first"),[]}stringify(){let e={256:[]};for(let t of this.getCodecCapability())r.VideoCodecStr2Int[t]>-1?e[256].push(r.VideoCodecStr2Int[t]):this.logger.error("MediaCapability:Unknown VideoCodecStr2Int",t);0===e[256].length&&this.logger.warn("MediaCapability:No Local Suitable codec available");return JSON.stringify(e)}getCodecSend(e,t){let i={codecName:null},r={codecName:null};for(let s=0;s<this.preferredCodecSend[e].length;s++){const o=this.preferredCodecSend[e][s];if(t.codecs||!t.codecs.length)for(let e=0;e<t.codecs.length;e++){const s=t.codecs[e];s.mimeType&&s.mimeType.toLowerCase().indexOf(o.toLowerCase())>-1&&(this.room.videoCodecType.indexOf(o)>-1?i.codecName||(i={codecParam:s,codecName:o}):r.codecName||(r={codecParam:s,codecName:o}))}}return i.codecName?(this.logger.log("MediaCapability：发送的Codec为:",i.codecName,JSON.stringify(i.codecParam)),i):(this.logger.warn("MediaCapability：未找到合适的发送Codec。发送的Codec使用:",r.codecName,r.codecParam),r)}parseRoom(e){if(!e.mediaCapabilitySet)return;const t=JSON.parse(e.mediaCapabilitySet);if(t[256]){const i=this.room.videoCodecType;this.room.videoCodecType=[];for(const i of t[256]){let t=r.VideoCodecInt2Str[i];t?this.room.videoCodecType.push(t):this.logger.error("Unknown Video Codec Type",i,e)}i.length?this.logger.log("Room videoCodecType发生变更。new:",this.room.videoCodecType,"old:",i):this.logger.log("Room videoCodecType:",JSON.stringify(this.room.videoCodecType))}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VideoCodecInt2Str=t.VideoCodecStr2Int=t.SignalChannelMode=void 0,function(e){e[e.CHANNEL_MODE_P2P=1]="CHANNEL_MODE_P2P",e[e.CHANNEL_MODE_MEETING=2]="CHANNEL_MODE_MEETING",e[e.CHANNEL_MODE_1V1=3]="CHANNEL_MODE_1V1"}(t.SignalChannelMode||(t.SignalChannelMode={}));t.VideoCodecStr2Int={H264:0,H265:1,VP8:2,NEVC:3};t.VideoCodecInt2Str={0:"H264",1:"H265",2:"VP8",3:"NEVC"}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OperationQueue=void 0;const r=i(43);t.OperationQueue=class{constructor(e){this.cnt=0,this.current=null,this.history=null,this.queue=[],this.logger=e.getChild(()=>{let e="oper";return this.current?e+=` ${this.current.args.method}#${this.current.id}`:this.history&&(e+=` ${this.history.args.method}#${this.history.id} FINISHED`),this.queue.forEach(t=>{e+=`|${t.args.method}#${t.id}`}),e}),setInterval(()=>{if(this.current&&Date.now()-this.current.enqueueTs>5e3){if(this.queue.length){const e=this.queue[0];this.logger.error(`当前操作已执行了${Date.now()-this.current.enqueueTs}ms，放开锁限制：${this.current.args.method}#${this.current.id}。即将进行下一个操作：${e.args.method}#${e.id}`)}else this.logger.log(`当前操作已执行了${Date.now()-this.current.enqueueTs}ms，放开锁限制：${this.current.args.method}#${this.current.id}`);this.current.status="timeout",this.history=this.current,this.current=null,this.fire("timer")}},5e3)}enqueue(e){return new Promise((t,i)=>{this.queue.push({id:++this.cnt,enqueueTs:Date.now(),args:e,resolve:t,reject:i,status:"pending"}),this.current?this.logger.log(`操作等位中，目前有其他操作。前面还有${this.queue.length}位：${e.method}#${this.cnt}。参数：`,e.options):this.fire("instant")})}fire(e){if(!this.current){const t=this.queue.shift();t&&(this.history=this.current,this.current=t,this.current.status="live","instant"===e?this.logger.log(`开始执行操作：${t.args.method}。参数：`,r.makePrintable(t.args.options,4)):this.logger.log(`开始执行队列中的操作：${t.args.method}#${t.id}，等待时间：${Date.now()-t.enqueueTs}ms。参数：`,t.args.options),t.startTs=Date.now(),t.resolve(()=>{this.current===t?(this.current.status="finished",this.history=this.current,this.current=null,this.logger.log(`执行操作结束：${t.args.method}。花费 ${t.startTs?Date.now()-t.startTs:null}ms`),this.fire("functionEnd")):"timeout"===t.status?this.logger.log(`执行操作结束：${t.args.method}。花费 ${t.startTs?Date.now()-t.startTs:null}ms。该操作超时，但未阻塞执行队列。`):this.logger.error(`操作收到多次返回：${t.args.method}#${t.id}。花费 ${t.startTs?Date.now()-t.startTs:null}ms`)}))}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SpatialManager=void 0;const r=i(26);t.SpatialManager=class{constructor(e){this.elem=document.createElement("audio"),this.fakeElem=document.createElement("audio"),this.data={},this.context=e.context,this.client=e.client,this.options=e.options,this.logger=e.client.adapterRef.logger.getChild(()=>"spatial");try{this.destination=new MediaStreamAudioDestinationNode(this.context)}catch(e){if("TypeError"!==e.name)throw e;this.destination=this.context.createMediaStreamDestination()}this.elem.setAttribute("playsinline","playsinline"),this.elem.setAttribute("autoplay","autoplay"),this.elem.className="nertc-panner-manager",this.elem.srcObject=this.destination.stream,this.fakeElem.muted=!0,this.fakeElem.volume=0,this.fakeElem.autoplay=!0,this.fakeElem.controls=!0}getUserData(e){const t=""+e;""+parseInt(t)!==t&&this.logger.warn("getUserData:异常的uid：",e);let i=this.data[t];return i||(i={position:{x:0,y:0}},this.data[t]=i),i}shouldSubscribe(e){const t=this.getUserData(e);return Math.abs(t.position.x)<=64&&Math.abs(t.position.y)<=64}async updatePosition(e,t){const i=this.getUserData(e),r=this.client.adapterRef.remoteStreamMap[e];if(r){const s=this.client.getSubStatus(r,"all");if(this.shouldSubscribe(e))if(s.subscribable)this.logger.log(`[remote#${e} status:${s.status}]界内，【即将订阅】: (${i.position.x}, ${i.position.y}) => (${t.x}, ${t.y})`),i.position.x=t.x,i.position.y=t.y,await this.client.doSubscribe(r),this.updatePosition(e,i.position);else{if(i.position.x===t.x&&i.position.y===t.y)return;this.logger.log(`[remote#${e} status:${s.status}]界内，即将更新remoteStream位置: (${i.position.x}, ${i.position.y}) => (${t.x}, ${t.y})`),i.position.x=t.x,i.position.y=t.y,i.audioNodes&&(i.audioNodes.pannerNode.positionX.value=t.x,i.audioNodes.pannerNode.positionY.value=t.y)}else if("subscribed"===s.status)this.logger.log(`[remote#${e} status:${s.status}]界外，【即将取消订阅】:  (${i.position.x}, ${i.position.y}) => (${t.x}, ${t.y})`),i.position.x=t.x,i.position.y=t.y,await this.client.doUnsubscribe(r),this.updatePosition(e,i.position);else{if(i.position.x===t.x&&i.position.y===t.y)return;this.logger.log(`[remote#${e} status:${s.status}]界外，即将更新remoteStream位置:  (${i.position.x}, ${i.position.y}) => (${t.x}, ${t.y})`),i.position.x=t.x,i.position.y=t.y,i.audioNodes&&(i.audioNodes.pannerNode.positionX.value=t.x,i.audioNodes.pannerNode.positionY.value=t.y)}}else this.logger.log(`updatePosition: 更新未到的stream: ${e} ( ${t.x}, ${t.y})`),i.position.x=t.x,i.position.y=t.y}init(){this.client.on("stream-added",e=>{const t=this.getUserData(e.stream.getId());e.stream.setSubscribeConfig(this.options.subConfig),this.updatePosition(e.stream.getId(),t.position)}),this.client.on("stream-unsubscribed",e=>{const t=this.getUserData(e.stream.getId());this.updatePosition(e.stream.getId(),t.position)}),this.client.on("stream-subscribed",async e=>{this.logger.log("Subscribed to",e.stream.streamID,e.mediaType);const t=this.getUserData(e.stream.getId());"audio"===e.mediaType&&(t.audioNodes&&(t.audioNodes.pannerNode.disconnect(),t.audioNodes.source.disconnect(),t.audioNodes.gainNode.disconnect()),t.audioNodes={source:this.context.createMediaStreamSource(e.stream.mediaHelper.audio.audioStream),gainNode:this.context.createGain(),pannerNode:new PannerNode(this.context,{panningModel:"HRTF",distanceModel:"linear",rolloffFactor:1,coneInnerAngle:360,positionX:t.position.x,positionY:t.position.y,positionZ:0,maxDistance:100})},t.audioNodes.source.connect(t.audioNodes.gainNode),t.audioNodes.gainNode.connect(t.audioNodes.pannerNode),t.audioNodes.pannerNode.connect(this.destination),this.fakeElem.srcObject=e.stream.mediaHelper.audio.audioStream,this.fakeElem.play().catch(e=>{r.Device.onUserGestureNeeded&&(r.Device.onUserGestureNeeded(e),r.Device.once("user-gesture-fired",()=>{this.fakeElem.play()}))}),this.logger.log("Connected",e.stream.getId,e.stream.mediaHelper.audio.audioStream.getAudioTracks()[0])),this.updatePosition(e.stream.getId(),t.position)})}play(){this.elem.controls=!0,"suspended"===this.context.state&&r.Device.onUserGestureNeeded&&(r.Device.onUserGestureNeeded(new Error("恢复AudioContext")),r.Device.once("user-gesture-fired",()=>{this.context.resume()})),this.elem.play().catch(e=>{r.Device.onUserGestureNeeded&&(r.Device.onUserGestureNeeded(e),r.Device.once("user-gesture-fired",()=>{this.elem.play()}))})}}},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LocalStream=void 0;const s=i(3),o=i(42),n=i(86),a=i(87),d=i(89),c=i(23),l=i(57),u=r(i(1)),p=r(i(0)),h=r(i(11)),f=i(58),m=i(44),g=i(2);let v=0;class y extends s.EventEmitter{constructor(e){if(super(),this.videoProfile={frameRate:o.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_NORMAL,resolution:o.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p},this.screenProfile={frameRate:o.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_5,resolution:o.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p},this.state="UNINIT",this.videoView=null,this.screenView=null,this.renderMode={local:{video:{},screen:{}}},this.inSwitchDevice={audio:!1,video:!1},this.pubStatus={audio:{audio:!1},video:{video:!1},screen:{screen:!1}},this.muteStatus={audio:{send:!1},video:{send:!1},screen:{send:!1}},this.isRemote=!1,this.audioPlay_=!1,this.videoPlay_=!1,this.screenPlay_=!1,this.active=!0,this.destroyed=!1,this.localStreamId=v++,this.logger=e.client.adapterRef.logger.getChild(()=>{let e=this.localStreamId?"local"+this.localStreamId:"localStream";if(this.mediaHelper){let t="";this.mediaHelper.audio.micTrack&&(t+="m"),this.mediaHelper.video.cameraTrack&&(t+="c"),this.mediaHelper.screen.screenVideoTrack&&(t+="s"),this.mediaHelper.screenAudio.screenAudioTrack&&(t+="t"),t&&(e+=" "+t)}return"INITED"!==this.state&&(e+=" "+this.state),"INITED"===this.state&&this.client&&this.client.adapterRef.localStream!==this&&(e+=" DETACHED"),this.destroyed&&(e+=" DESTROYED"),e}),e.uid)if("string"==typeof e.uid||h.default.isBigNumber(e.uid))this.logger.log("uid是string类型"),e.client.adapterRef.channelInfo.uidType="string";else{if("number"!=typeof e.uid)throw this.logger.error("uid参数格式非法"),new u.default({code:p.default.INVALID_PARAMETER,message:"uid is invalid"});if(this.logger.log("uid是number类型"),e.client.adapterRef.channelInfo.uidType="number",e.uid>Number.MAX_SAFE_INTEGER)throw new u.default({code:p.default.INVALID_PARAMETER,message:"uid is exceeds the scope of Number"})}else e.uid="local_"+this.localStreamId;this._reset(),this.streamID=e.uid,this.stringStreamID=this.streamID.toString(),this.audio=e.audio,this.audioProcessing=e.audioProcessing||null,this.microphoneId=e.microphoneId||"",this.cameraId=e.cameraId||"",this.video=e.video||!1,this.screen=e.screen||!1,this.screenAudio=e.screenAudio||!1,this.sourceId=e.sourceId||"",this.facingMode=e.facingMode||"",this.client=e.client,this.audioSource=e.audioSource||null,this.videoSource=e.videoSource||null,this.screenAudioSource=e.screenAudioSource||null,this.screenVideoSource=e.screenVideoSource||null,this.mediaHelper=new d.MediaHelper({stream:this}),this._play=new n.Play({stream:this}),this._record=new a.Record({logger:this.logger,stream:this}),this.client._params&&"live"===this.client._params.mode?this.audioProfile="music_standard":this.audioProfile="speech_low_quality",this.logger.log("创建 本地 Stream: ",JSON.stringify({streamID:this.stringStreamID,audio:e.audio,video:e.video})),this.client.apiFrequencyControl({name:"createStream",code:0,param:JSON.stringify({videoProfile:this.videoProfile,audio:this.audio,audioProfile:this.audioProfile,video:this.video,cameraId:this.cameraId,microphoneId:this.microphoneId,screen:this.screen,screenProfile:this.screenProfile},null," ")})}getAdapterRef(){return this.client.adapterRef.localStream===this?this.client.adapterRef:null}_reset(){this.streamID="",this.stringStreamID="",this.state="UNINIT",this.videoProfile={frameRate:o.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_NORMAL,resolution:o.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p},this.audioProfile="speech_low_quality",this.screenProfile={frameRate:o.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_5,resolution:o.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p},this.audio=!1,this.microphoneId="",this.video=!1,this.cameraId="",this.screen=!1,this.screenAudio=!1,this.sourceId="",this.facingMode="",this.videoView=null,this.screenView=null,this.renderMode={local:{video:{},screen:{}}},this.inSwitchDevice={audio:!1,video:!1},this.pubStatus={audio:{audio:!1},video:{video:!1},screen:{screen:!1}},this.muteStatus={audio:{send:!1},video:{send:!1},screen:{send:!1}},this.renderMode={local:{video:{},screen:{}}},this.mediaHelper&&this.mediaHelper.destroy(),this._play&&this._play.destroy(),this._play=null,this._record&&this._record.destroy(),this._record=null}get Play(){return this._play}get Record(){return this._record}getId(){return"string"===this.client.adapterRef.channelInfo.uidType?this.stringStreamID:this.streamID}async getStats(){var e,t,i;let r=null===(i=null===(t=null===(e=this.getAdapterRef())||void 0===e?void 0:e._mediasoup)||void 0===t?void 0:t._sendTransport)||void 0===i?void 0:i._handler._pc;if(this.logger.log("获取音视频连接数据, uid: "+this.stringStreamID),r){const e={accessDelay:"0",audioSendBytes:"0",audioSendPackets:"0",audioSendPacketsLost:"0",videoSendBytes:"0",videoSendFrameRate:"0",videoSendPackets:"0",videoSendPacketsLost:"0",videoSendResolutionHeight:"0",videoSendResolutionWidth:"0"};try{(await r.getStats()).forEach(t=>{"outbound-rtp"===t.type?"video"===t.mediaType?(e.videoSendBytes=t.bytesSent.toString(),e.videoSendPackets=t.packetsSent.toString(),e.videoSendFrameRate=t.framesPerSecond.toString()):"audio"===t.mediaType&&(e.audioSendBytes=t.bytesSent.toString(),e.audioSendPackets=t.packetsSent.toString()):"candidate-pair"===t.type?"number"==typeof t.currentRoundTripTime&&(e.accessDelay=(1e3*t.currentRoundTripTime).toString()):"track"===t.type?void 0!==t.frameWidth&&(e.videoSendResolutionWidth=t.frameWidth.toString(),e.videoSendResolutionHeight=t.frameHeight.toString()):"remote-inbound-rtp"===t.type&&("audio"===t.kind?e.audioSendPacketsLost=t.packetsLost.toString():"video"===t.kind&&(e.videoSendPacketsLost=t.packetsLost.toString()))})}catch(e){this.logger.error("failed to get localStats",e.name,e.message)}return e}}getAudioStream(){return this.mediaHelper?(this.client.apiFrequencyControl({name:"setExternalAudioRender",code:0,param:JSON.stringify({},null," ")}),this.mediaHelper.audio.audioStream):null}async init(){f.isHttpProtocol()&&this.logger.warn("The current protocol is HTTP");const e=await this.client.operationQueue.enqueue({caller:this,method:"init",options:null});let t=null;if(this.state="INITING",this.logger.log("初始化音视频流对象"),this.client.adapterRef.channelInfo.sessionConfig.maxVideoQuality=o.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p,this.videoProfile&&(this.client.adapterRef.channelInfo.sessionConfig.videoQuality=this.videoProfile.resolution,this.client.adapterRef.channelInfo.sessionConfig.videoFrameRate=this.videoProfile.frameRate),!window.isAudioBanned||!window.isVideoBanned){if(window.isAudioBanned){const e="服务器禁止发送音频流";this.logger.error(e),this.client.apiFrequencyControl({name:"open",code:-1,param:JSON.stringify({reason:e},null," ")}),this.audio=!1,this.screenAudio=!1}if(window.isVideoBanned){const e="服务器禁止发送视频流";this.logger.error(e),this.client.apiFrequencyControl({name:"open",code:-1,param:JSON.stringify({reason:e},null," ")}),this.video=!1,this.screen=!1}this.client.apiFrequencyControl({name:"init",code:0,param:JSON.stringify({videoProfile:this.videoProfile,audio:this.audio,audioProfile:this.audioProfile,audioProcessing:this.audioProcessing,video:this.video,cameraId:this.cameraId,microphoneId:this.microphoneId,screen:this.screen,sourceId:this.sourceId,screenProfile:this.screenProfile},null," ")});try{this.audio&&await this.mediaHelper.getStream({audio:this.audio,audioDeviceId:this.microphoneId,audioSource:this.audioSource})}catch(e){this.logger.log("打开mic失败: ",e.name,e.message),t=e,this.audio=!1,e.message&&e.message.indexOf("ermission")>-1&&e.message.indexOf("denied")>-1?this.client.safeEmit("accessDenied","audio"):e.message&&e.message.indexOf("not found")>-1?this.client.safeEmit("notFound","audio"):this.client.safeEmit("deviceError","audio"),this.emit("device-error",{type:"audio",error:e})}try{this.video&&await this.mediaHelper.getStream({video:this.video,videoSource:this.videoSource,videoDeviceId:this.cameraId,facingMode:this.facingMode})}catch(e){this.logger.log("打开camera失败: ",e.name,e.message),t=e,this.video=!1,e.message&&e.message.indexOf("ermission")>-1&&e.message.indexOf("denied")>-1?this.client.safeEmit("accessDenied","video"):e.message&&e.message.indexOf("not found")>-1?this.client.safeEmit("notFound","video"):e.message&&e.message.indexOf("not start video source")>-1?this.client.safeEmit("beOccupied","video"):this.client.safeEmit("deviceError","video"),this.emit("device-error",{type:"video",error:e})}try{if(this.screen){const e={sourceId:this.sourceId,screen:this.screen,screenVideoSource:this.screenVideoSource,screenAudio:this.screenAudio,screenAudioSource:this.screenAudioSource};await this.mediaHelper.getStream(e)}}catch(e){this.logger.log("打开屏幕共享失败: ",e.name,e.message),t=e,this.screen=!0,e.message&&e.message.indexOf("ermission")>-1&&e.message.indexOf("denied")>-1?this.client.safeEmit("accessDenied","screen"):e.message&&e.message.indexOf("not found")>-1?this.client.safeEmit("notFound","screen"):e.message&&e.message.indexOf("not start video source")>-1?this.client.safeEmit("beOccupied","screen"):this.client.safeEmit("deviceError","screen"),this.emit("device-error",{type:"screen",error:e})}if(this.audio||this.video||this.screen)this.state="INITED";else{if(t)throw this.state="UNINIT",this.logger.error("localStream.init失败:",t.name,t.message,t),e(),t;if(!g.getParameters().allowEmptyMedia)throw this.state="UNINIT",this.logger.error("localStream不允许初始化时无任何音视频"),e(),new u.default({code:p.default.NO_MEDIA,messsage:"localStream不允许初始化时无任何音视频"});this.logger.log("当前模式下localStream允许初始化时无任何音视频"),this.state="INITED"}e()}}getAudioTrack(){return this.mediaHelper.getAudioInputTracks()[0]||null}getVideoTrack(){if(this.mediaHelper)return this.mediaHelper.video.cameraTrack||this.mediaHelper.screen.screenVideoTrack||this.mediaHelper.video.videoSource}async play(e,t={}){c.isExistOptions({tag:"Stream.playOptions.audio",value:t.audio}).result||(t.audio=!1),t.audio&&!t.audioType&&(t.audioType="mixing"),c.isExistOptions({tag:"Stream.playOptions.video",value:t.video}).result||(t.video=!0),c.isExistOptions({tag:"Stream.playOptions.screen",value:t.screen}).result||(t.screen=!0),this.logger.log(`uid ${this.stringStreamID} Stream.play::`,JSON.stringify(t)),t.audio&&this._play&&this.mediaHelper.getAudioInputTracks().length>0&&(this.logger.log(`uid ${this.stringStreamID} 开始播放本地音频: `,t.audioType),"voice"===t.audioType?(this._play.playAudioStream(this.mediaHelper.audio.micStream,t.muted),this.audioPlay_=!0):"music"===t.audioType?(this._play.playAudioStream(this.mediaHelper.audio.musicStream,t.muted),this.audioPlay_=!0):"mixing"===t.audioType&&(this._play.playAudioStream(this.mediaHelper.audio.audioStream,t.muted),this.audioPlay_=!0));let i=null;if("string"==typeof e?i=document.getElementById(e):e&&(i=e),i){if(t.video&&(this.videoView=i,this._play&&this.mediaHelper.video.videoStream.getVideoTracks().length)){this.logger.log(`uid ${this.stringStreamID} 开始启动视频播放 主流 本地`);try{await this._play.playVideoStream(this.mediaHelper.video.videoStream,i),"width"in this.renderMode.local.video&&this._play.setVideoRender(this.renderMode.local.video),this.videoPlay_=!0}catch(e){this.videoPlay_=!1,this.client.emit("notAllowedError",e),this.client.emit("NotAllowedError",e)}}if(t.screen&&(this.screenView=i,this._play&&this.mediaHelper.screen.screenVideoStream.getVideoTracks().length)){this.logger.log(`uid ${this.stringStreamID} 开始启动视频播放 辅流 本地`);try{await this._play.playScreenStream(this.mediaHelper.screen.screenVideoStream,i),"width"in this.renderMode.local.screen&&this._play.setScreenRender(this.renderMode.local.screen),this.screenPlay_=!1}catch(e){this.screenPlay_=!1,this.client.emit("notAllowedError",e),this.client.emit("NotAllowedError",e)}}}if(t.audio){let e;e=window.isAudioBanned?{enable:!1}:{enable:!0},this.client.apiFrequencyControl({name:"enableEarback",code:e.enable?0:1,param:JSON.stringify(e,null," ")})}this.client.apiFrequencyControl({name:"play",code:0,param:JSON.stringify({playOptions:t,audio:this.audio,video:this.video,screen:this.screen,renderMode:this.renderMode},null," ")})}async resume(){this._play&&(await this._play.resume(),this._play.audioDom&&!this._play.audioDom.paused&&(this.audioPlay_=!0),this._play.videoDom&&!this._play.videoDom.paused&&(this.videoPlay_=!0),this._play.screenDom&&!this._play.screenDom.paused&&(this.screenPlay_=!0))}setLocalRenderMode(e,t){if(!(e&&e.width-0&&e.height-0))return this.logger.warn("setLocalRenderMode 参数错误"),this.client.apiFrequencyControl({name:"setLocalRenderMode",code:-1,param:JSON.stringify(e,null," ")}),"INVALID_ARGUMENTS";this.logger.log(`uid ${this.stringStreamID} 设置本地视频播放窗口大小: `,t||"video+screen",JSON.stringify(e)),t&&"video"!==t||(this._play&&this._play.setVideoRender(e),this.renderMode.local.video=e),t&&"screen"!==t||(this.renderMode.local.screen=e,this._play&&this._play.setScreenRender(e)),this.client.apiFrequencyControl({name:"setLocalRenderMode",code:0,param:JSON.stringify(e,null," ")})}stop(e){this.logger.log(`uid ${this.stringStreamID} Stream.stop: 停止播放 ${e||"音视频流"}`),this._play&&("audio"===e?(this._play.stopPlayAudioStream(),this.audioPlay_=!1):"video"===e?(this._play.stopPlayVideoStream(),this.videoPlay_=!1):"screen"===e?(this._play.stopPlayScreenStream(),this.screenPlay_=!1):(this._play.audioDom&&(this._play.stopPlayAudioStream(),this.audioPlay_=!1),this._play.videoDom&&(this._play.stopPlayVideoStream(),this.videoPlay_=!1),this._play.screenDom&&(this._play.stopPlayScreenStream(),this.screenPlay_=!1)),this.client.apiFrequencyControl({name:"stop",code:0,param:JSON.stringify({audio:this.audio,video:this.video,screen:this.screen,renderMode:this.renderMode},null," ")}))}async isPlaying(e){let t=!1;if(this._play)if("audio"===e)t=await this._play.isPlayAudioStream();else if("video"===e)t=await this._play.isPlayVideoStream();else{if("screen"!==e)return this.logger.warn("isPlaying: unknown type"),Promise.reject(new u.default({code:p.default.UNKNOWN_TYPE,message:"unknown type"}));t=await this._play.isPlayScreenStream()}else;return this.logger.log(`检查${this.stringStreamID}的${e}播放状态: ${t}`),t}async open(e){var t,i,r,s;let{type:o,deviceId:n,sourceId:a,facingMode:d,screenAudio:c,audioSource:l,videoSource:h,screenAudioSource:f,screenVideoSource:m}=e;const g=await this.client.operationQueue.enqueue({caller:this,method:"open",options:e});if(1===this.client._roleInfo.userRole){const e="观众不允许打开设备";return this.logger.error(e),this.client.apiFrequencyControl({name:"open",code:-1,param:JSON.stringify({reason:e,type:o},null," ")}),g(),Promise.reject(new u.default({code:p.default.INVALID_OPERATION,message:"audience is not allowed to open"}))}if(window.isAudioBanned){const t="服务器禁止发送音频流";this.logger.error(t),this.client.apiFrequencyControl({name:"open",code:-1,param:JSON.stringify({reason:t,type:o},null," ")}),e.screenAudio=!1}if(window.isVideoBanned){const e="服务器禁止发送视频流";this.logger.error(e),this.client.apiFrequencyControl({name:"open",code:-1,param:JSON.stringify({reason:e,type:o},null," ")})}try{switch(o){case"audio":if(window.isAudioBanned)return Promise.reject(new u.default({code:p.default.MEDIA_OPEN_BANNED_BY_SERVER,message:"audio is banned by server"}));if(this.logger.log("open(): 开启 "+(l?l.label:"mic设备")),this.mediaHelper.audio.micTrack||this.mediaHelper.audio.audioSource)return this.logger.warn("请先关闭麦克风"),this.client.apiFrequencyControl({name:"open",code:-1,param:JSON.stringify({reason:"请先关闭麦克风",type:o},null," ")}),g(),Promise.reject(new u.default({code:p.default.INVALID_OPERATION,message:"please close mic first"}));if(this.audio=!0,this.mediaHelper){const e={audio:!0,audioDeviceId:n,audioSource:l};await this.mediaHelper.getStream(e),n&&(this.microphoneId=n),this.getAdapterRef()?"CONNECTED"!==this.client.adapterRef.connectState.curState?this.logger.log("Stream.open:client不在频道中，无需发布。",e):(this.logger.log("Stream.open:开始发布",e),await(null===(t=this.client.adapterRef._mediasoup)||void 0===t?void 0:t.createProduce(this,"audio"))):this.logger.log("Stream.open:localStream未发布，无需发布",o,e)}break;case"screenAudio":if(window.isAudioBanned)return Promise.reject(new u.default({code:p.default.MEDIA_OPEN_BANNED_BY_SERVER,message:"audio is banned by server"}));if(!f)return void this.logger.error("open(): 不允许单独开启屏幕共享音频功能。");if(this.logger.log("open(): 开启自定义屏幕共享音频 "+f.label),this.mediaHelper.screenAudio.screenAudioTrack||this.mediaHelper.screenAudio.screenAudioSource)return this.logger.error("请先关闭屏幕共享音频"),this.client.apiFrequencyControl({name:"open",code:-1,param:JSON.stringify({reason:"请先关闭屏幕共享音频",type:o},null," ")}),g(),Promise.reject(new u.default({code:p.default.INVALID_OPERATION,message:"please close screenAudio first"}));if(this.screenAudio=!0,this.mediaHelper){const e={screenAudio:!0,screenAudioSource:f};await this.mediaHelper.getStream(e),this.getAdapterRef()?"CONNECTED"!==this.client.adapterRef.connectState.curState?this.logger.log("Stream.open:client不在频道中，无需发布。",e):(this.logger.log("Stream.open:开始发布",e),await(null===(i=this.client.adapterRef._mediasoup)||void 0===i?void 0:i.createProduce(this,"audio"))):this.logger.log("Stream.open:localStream未发布，无需发布",o,e)}break;case"video":case"screen":if(window.isVideoBanned)return Promise.reject(new u.default({code:p.default.MEDIA_OPEN_BANNED_BY_SERVER,message:"video is banned by server"}));if(this.logger.log(`开启${"video"===o?"camera":"screen"}设备`),this[o])return"video"===o?(this.logger.warn("请先关闭摄像头"),this.client.apiFrequencyControl({name:"open",code:-1,param:JSON.stringify({reason:"请先关闭摄像头",type:o},null," ")}),g(),Promise.reject(new u.default({code:p.default.INVALID_OPERATION,message:"please close video first"}))):(this.logger.warn("请先关闭屏幕共享"),this.client.apiFrequencyControl({name:"open",code:-1,param:JSON.stringify({reason:"请先关闭屏幕共享",type:o},null," ")}),g(),Promise.reject(new u.default({code:p.default.INVALID_OPERATION,message:"please close screen-sharing first"})));if(e.screenAudio&&(this.mediaHelper.screenAudio.screenAudioTrack||this.mediaHelper.screenAudio.screenAudioSource))return this.logger.warn("请先关闭屏幕共享音频"),this.client.apiFrequencyControl({name:"open",code:-1,param:JSON.stringify({reason:"请先关闭屏幕共享音频",type:o},null," ")}),g(),Promise.reject(new u.default({code:p.default.INVALID_OPERATION,message:"please close screenAudio first"}));this[o]=!0;const c={videoDeviceId:n,sourceId:a,videoSource:h,screenAudioSource:f,screenVideoSource:m,facingMode:d};c[o]=!0,"screen"===o&&e.screenAudio&&(c.screenAudio=!0,this.screenAudio=!0),await this.mediaHelper.getStream(c),n&&"video"===o&&(this.cameraId=n),this.getAdapterRef()?"CONNECTED"!==this.client.adapterRef.connectState.curState?this.logger.log("Stream.open:client不在频道中，无需发布。",c):(this.logger.log("Stream.open:开始发布",c),await(null===(r=this.client.adapterRef._mediasoup)||void 0===r?void 0:r.createProduce(this,o)),e.screenAudio&&await(null===(s=this.client.adapterRef._mediasoup)||void 0===s?void 0:s.createProduce(this,"audio"))):this.logger.log("Stream.open:localStream未发布，无需发布",o,c);break;default:this.logger.error("非法参数")}g(),this.client.apiFrequencyControl({name:"open",code:0,param:JSON.stringify({type:o},null," ")})}catch(t){return["audio","video","screen"].indexOf(o)>-1&&(this[o]=!1,"screen"===o&&e.screenAudio&&(this.screenAudio=!1)),this.logger.log(o+" 开启失败: ",t.name,t.message),this.client.apiFrequencyControl({name:"open",code:-1,param:JSON.stringify({reason:t.message,type:o},null," ")}),t.message&&t.message.indexOf("ermission")>-1&&t.message.indexOf("denied")>-1?(this.client.safeEmit("accessDenied",o),g(),Promise.reject(new u.default({code:p.default.NOT_ALLOWED,message:t.message}))):(g(),Promise.reject(t))}}async switchScreenStream(e){var t,i;let r=null,s=!1,o=null,n="";if("video"===(null===(t=e.screenVideoSource)||void 0===t?void 0:t.kind))r=e.screenVideoSource,s=!0;else{r=(await this.mediaHelper.getScreenSource({screen:this.screen})).getVideoTracks()[0]}r?(o=await this.replaceTrack({mediaType:"screen",track:r,external:s}),o?(this.client.adapterRef.logger.log(`switchScreenStream: 已从 ${o.external?"自定义辅流":"屏幕共享"} 切换到 ${s?"自定义辅流":"屏幕共享"}`),o.external||o.oldTrack.stop(),null===(i=o.oldTrackLow)||void 0===i||i.stop()):(n="当前没有screen流",this.client.adapterRef.logger.error(`switchScreenStream: 无法切换到${s?"自定义辅流":"屏幕共享"}: ${n}`))):(n="无法获得新的screenVideoTrack",this.client.adapterRef.logger.error("switchScreenStream: ",n)),this.client.adapterRef.instance.apiEventReport("setFunction",{name:"switch_to_custom_screen",oper:"1",value:n||"success"}),this.client.apiFrequencyControl({name:"switchScreenStream",code:n?-1:0,param:JSON.stringify({external:s,reason:n},null," ")})}async close(e){var t,i,r,s;e||(e={type:"all"});const o=await this.client.operationQueue.enqueue({caller:this,method:"close",options:e});let n=e.type,a=null;switch(n){case"audio":if(this.logger.log("关闭mic设备"),!this.audio){this.logger.log("没有开启过麦克风"),a="NOT_OPEN_MIC_YET";break}this.audio=!1,this.mediaHelper.stopStream("audio"),this.getAdapterRef()?this.mediaHelper.getAudioInputTracks().length>0?this.logger.log("Stream.close:关闭音频，保留发布：",n):(this.logger.log("Stream.close:停止发布音频"),await(null===(t=this.client.adapterRef._mediasoup)||void 0===t?void 0:t.destroyProduce("audio"))):this.logger.log("Stream.close:未发布音频，无需停止发布");break;case"screenAudio":if(this.logger.log("关闭屏幕共享音频"),!this.screenAudio){this.logger.log("没有开启过屏幕共享音频"),a="NOT_OPEN_SCREENAUDIO_YET";break}this.screenAudio=!1,this.mediaHelper.stopStream("screenAudio"),this.getAdapterRef()?this.mediaHelper.getAudioInputTracks().length>0?this.logger.log("Stream.close:关闭音频，保留发布：",n):(this.logger.log("Stream.close:停止发布音频"),await(null===(i=this.client.adapterRef._mediasoup)||void 0===i?void 0:i.destroyProduce("audio"))):this.logger.log("Stream.close:未发布音频，无需停止发布");break;case"video":if(this.logger.log("关闭camera设备"),!this.video){this.logger.log("没有开启过摄像头"),a="NOT_OPEN_CAMERA_YET";break}if(this.video=!1,this.mediaHelper.stopStream("video"),!this._play)throw o(),new u.default({code:p.default.NO_PLAY,message:"no play"});this._play.stopPlayVideoStream(),this.getAdapterRef()?(this.logger.log("Stream.close:停止发布视频"),await(null===(r=this.client.adapterRef._mediasoup)||void 0===r?void 0:r.destroyProduce("video"))):this.logger.log("Stream.close:未发布视频，无需停止发布");break;case"screen":if(this.logger.log("关闭屏幕共享"),!this.screen){this.logger.log("没有开启过屏幕共享"),a="NOT_OPEN_SCREEN_YET";break}if(this.screen=!1,this.mediaHelper.stopStream("screen"),!this._play)throw new u.default({code:p.default.NO_PLAY,message:"no play"});this._play.stopPlayScreenStream(),this.getAdapterRef()?(this.logger.log("Stream.close:停止发布辅流"),await(null===(s=this.client.adapterRef._mediasoup)||void 0===s?void 0:s.destroyProduce("screen"))):this.logger.log("Stream.close:未发布辅流，无需停止发布");break;case"all":this.logger.log(`Stream.close:关闭所有设备：audio ${this.audio}, video ${this.video}, screen ${this.screen}, screenAudio ${this.screenAudio}`),this.audio&&await this.close({type:"audio"}),this.video&&await this.close({type:"video"}),this.screen&&await this.close({type:"screen"}),this.screenAudio&&await this.close({type:"screenAudio"}),this.logger.log(`Stream.close:关闭所有设备成功：audio ${this.audio}, video ${this.video}, screen ${this.screen}, screenAudio ${this.screenAudio}`);break;default:this.logger.log("不能识别type"),a="INVALID_ARGUMENTS"}return a?(this.client.apiFrequencyControl({name:"close",code:-1,param:JSON.stringify({reason:a,audio:this.audio,video:this.video,screen:this.screen},null," ")}),"NOT_OPEN_MIC_YET"===a?(o(),Promise.reject(new u.default({code:p.default.INVALID_OPERATION,message:"mic is not open"}))):"NOT_OPEN_CAMERA_YET"===a?(o(),Promise.reject(new u.default({code:p.default.INVALID_OPERATION,message:"camera is not open"}))):"NOT_OPEN_SCREEN_YET"===a?(o(),Promise.reject(new u.default({code:p.default.INVALID_OPERATION,message:"screen-sharing is not open"}))):(o(),Promise.reject(new u.default({code:p.default.INVALID_OPERATION,message:a})))):(o(),void this.client.apiFrequencyControl({name:"close",code:0,param:JSON.stringify({reason:a,audio:this.audio,video:this.video,screen:this.screen,screenAudio:this.screenAudio},null," ")}))}async unmuteAudio(){var e,t;this.logger.log("启用音频轨道: ",this.stringStreamID);try{this.getAdapterRef()&&await(null===(e=this.client.adapterRef._mediasoup)||void 0===e?void 0:e.unmuteAudio());const i=this.mediaHelper.audio.audioStream.getAudioTracks();i&&i.length&&i.forEach(e=>{e.enabled=!0}),this.mediaHelper.getAudioInputTracks().forEach(e=>{e.enabled=!0}),(null===(t=this.mediaHelper.audio.webAudio)||void 0===t?void 0:t.gainFilter)&&(this.mediaHelper.audio.webAudio.gainFilter.gain.value=1),this.muteStatus.audio.send=!1,this.client.apiFrequencyControl({name:"unmuteAudio",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("API调用失败：Stream:unmuteAudio",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteAudio",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}async muteAudio(){var e,t;this.logger.log("禁用音频轨道: ",this.stringStreamID);try{this.getAdapterRef()&&await(null===(e=this.client.adapterRef._mediasoup)||void 0===e?void 0:e.muteAudio());const i=this.mediaHelper.audio.audioStream.getAudioTracks();i&&i.length&&i.forEach(e=>{e.enabled=!1}),this.mediaHelper.getAudioInputTracks().forEach(e=>{e.enabled=!1}),(null===(t=this.mediaHelper.audio.webAudio)||void 0===t?void 0:t.gainFilter)&&(this.mediaHelper.audio.webAudio.gainFilter.gain.value=0),this.muteStatus.audio.send=!0,this.client.apiFrequencyControl({name:"muteAudio",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("API调用失败：Stream:muteAudio",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteAudio",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}hasAudio(){return this.mediaHelper.getAudioInputTracks().length>0}getAudioLevel(){return this.mediaHelper.getGain()}setAudioProfile(e){this.logger.log("设置音频属性: ",e),this.audioProfile=e,this.client.apiFrequencyControl({name:"setAudioProfile",code:0,param:JSON.stringify({profile:e},null,"")})}setAudioVolume(e=100){let t=null;if(Number.isInteger(e)?e<0?e=0:e>100?e=255:e*=2.55:(this.logger.log("volume 为 0 - 100 的整数"),t="INVALID_ARGUMENTS"),this.logger.log(`调节${this.stringStreamID}的音量大小: ${e}`),this.audio){if(!this._play)throw new u.default({code:p.default.NO_PLAY,message:"no play"});this._play.setPlayVolume(e)}else this.logger.log("没有音频流，请检查是否有发布过音频"),t="INVALID_OPERATION";if(t)return this.client.apiFrequencyControl({name:"setAudioVolume",code:-1,param:JSON.stringify({volume:e,reason:t},null," ")}),t;this.client.apiFrequencyControl({name:"setAudioVolume",code:0,param:JSON.stringify({volume:e},null," ")})}setCaptureVolume(e,t){let i=null;if(Number.isInteger(e)?e<0?e=0:e>100&&(e=100):(this.logger.log("volume 为 0 - 100 的整数"),i="INVALID_ARGUMENTS"),this.logger.log(`调节${this.stringStreamID}的音量大小: ${e}`),this.mediaHelper.audio.audioRoutingEnabled||this.mediaHelper.enableAudioRouting(),this.mediaHelper.setGain(e/100,t),i)return this.client.apiFrequencyControl({name:"setCaptureVolume",code:-1,param:JSON.stringify({volume:e,audioType:t,reason:i},null," ")}),i;this.client.apiFrequencyControl({name:"setCaptureVolume",code:0,param:JSON.stringify({audioType:t,volume:e},null," ")})}async setAudioOutput(e,t){if(this._play){try{await this._play.setAudioOutput(e)}catch(e){throw t&&setTimeout(()=>{t(e)},0),this.logger.error("设置输出设备失败",e.name,e.message),e}t&&setTimeout(t,0)}}async switchDevice(e,t){this.logger.log(`切换媒体输入设备: ${e}, deviceId: ${t}`);let i={};if(this.inSwitchDevice[e])return this.logger.error("switchDevice：正在切换中，重复",e),Promise.reject(new u.default({code:p.default.INVALID_OPERATION,message:"switching "+e}));if(this.inSwitchDevice[e]=!0,"audio"===e){if(window.isAudioBanned)return Promise.reject(new u.default({code:p.default.MEDIA_OPEN_BANNED_BY_SERVER,message:"audio is banned by server"}));const r=this.mediaHelper.audio.micTrack;if("live"===(null==r?void 0:r.readyState)&&(null==r?void 0:r.getSettings().deviceId)===t)return this.logger.log("切换相同的麦克风设备，不处理"),this.inSwitchDevice[e]=!1,Promise.resolve();if(!this.hasAudio())return this.logger.log("当前没有开启音频输入设备，无法切换"),this.inSwitchDevice[e]=!1,Promise.reject(new u.default({code:p.default.INVALID_OPERATION,message:"no audio input device"}));if(this.audioSource)return this.logger.log("自定义音频输入不支持，无法切换"),this.inSwitchDevice[e]=!1,Promise.reject(new u.default({code:p.default.INVALID_OPERATION,message:"cannot switch user-defined audio input"}));this.mediaHelper.audio.micConstraint&&this.mediaHelper.audio.micConstraint.audio?this.mediaHelper.audio.micConstraint.audio.deviceId={exact:t}:this.mediaHelper.audio.micConstraint?(this.mediaHelper.audio.micConstraint.audio={},this.mediaHelper.audio.micConstraint.audio.deviceId={exact:t}):this.mediaHelper.audio.micConstraint={audio:{deviceId:{exact:t}}},i=this.mediaHelper.audio.micConstraint,this.microphoneId=t}else{if("video"!==e)return this.logger.error("switchDevice: unknown type "+e),Promise.reject(new u.default({code:p.default.INVALID_OPERATION,message:"switchDevice: unknown type "+e}));{if(window.isVideoBanned)return Promise.reject(new u.default({code:p.default.MEDIA_OPEN_BANNED_BY_SERVER,message:"video is banned by server"}));const r=this.mediaHelper.video.cameraTrack;if("live"===(null==r?void 0:r.readyState)&&(null==r?void 0:r.getSettings().deviceId)===t)return this.logger.log("切换相同的摄像头设备，不处理"),this.inSwitchDevice[e]=!1,Promise.resolve();if(!this.hasVideo())return this.logger.log("当前没有开启视频输入设备，无法切换"),this.inSwitchDevice[e]=!1,this.client.apiFrequencyControl({name:"switchCamera",code:-1,param:JSON.stringify({reason:"INVALID_OPERATION"},null," ")}),Promise.reject(new u.default({code:p.default.INVALID_OPERATION,message:"no video input device"}));if(this.videoSource)return this.logger.log("自定义视频输入不支持，无法切换"),this.inSwitchDevice[e]=!1,this.client.apiFrequencyControl({name:"switchCamera",code:-1,param:JSON.stringify({reason:"INVALID_OPERATION"},null," ")}),Promise.reject(new u.default({code:p.default.INVALID_OPERATION,message:"cannot switch user-defined video input"}));this.mediaHelper.video.cameraConstraint&&this.mediaHelper.video.cameraConstraint.video&&(this.mediaHelper.video.cameraConstraint.video.deviceId={exact:t},i=this.mediaHelper.video.cameraConstraint),this.cameraId=t}}try{await this.mediaHelper.getSecondStream(i),this.inSwitchDevice[e]=!1,"video"===e&&this.client.apiFrequencyControl({name:"switchCamera",code:0,param:JSON.stringify({},null," ")})}catch(t){return this.logger.error("API调用失败：Stream:switchDevice",t.name,t.message,t),this.inSwitchDevice[e]=!1,"video"===e&&this.client.apiFrequencyControl({name:"switchCamera",code:-1,param:JSON.stringify({reason:t.message||t.name},null," ")}),Promise.reject(t)}}async unmuteVideo(){var e;this.logger.log(`启用 ${this.stringStreamID} 的视频轨道`);try{this.getAdapterRef()&&(null===(e=this.client.adapterRef._mediasoup)||void 0===e||e.unmuteVideo()),this.mediaHelper.video.videoSource&&(this.mediaHelper.video.videoSource.enabled=!0),this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!0),this.muteStatus.video.send=!1,this.client.apiFrequencyControl({name:"unmuteVideo",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("API调用失败：Stream:unmuteVideo",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteVideo",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}async muteVideo(){var e;this.logger.log(`禁用 ${this.stringStreamID} 的视频轨道`);try{this.getAdapterRef()&&await(null===(e=this.client.adapterRef._mediasoup)||void 0===e?void 0:e.muteVideo()),this.mediaHelper.video.videoSource&&(this.mediaHelper.video.videoSource.enabled=!1),this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!1),this.muteStatus.video.send=!0,this.client.apiFrequencyControl({name:"muteVideo",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("API调用失败：Stream:muteVideo",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteVideo",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}async unmuteScreen(){var e;this.logger.log(`启用 ${this.stringStreamID} 的视频轨道`);try{this.getAdapterRef()&&(null===(e=this.client.adapterRef._mediasoup)||void 0===e||e.unmuteScreen()),this.mediaHelper.screen.screenVideoTrack&&(this.mediaHelper.screen.screenVideoTrack.enabled=!0),this.mediaHelper.screen.screenVideoSource&&(this.mediaHelper.screen.screenVideoSource.enabled=!0),this.muteStatus.screen.send=!1,this.client.apiFrequencyControl({name:"unmuteScreen",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("API调用失败：Stream:unmuteScreen",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteScreen",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}async muteScreen(){var e;this.logger.log(`禁用 ${this.stringStreamID} 的辅流轨道`);try{this.getAdapterRef()&&await(null===(e=this.client.adapterRef._mediasoup)||void 0===e?void 0:e.muteScreen()),this.mediaHelper.screen.screenVideoSource&&(this.mediaHelper.screen.screenVideoSource.enabled=!1),this.mediaHelper.screen.screenVideoTrack&&(this.mediaHelper.screen.screenVideoTrack.enabled=!1),this.muteStatus.screen.send=!0,this.client.apiFrequencyControl({name:"muteScreen",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("API调用失败：Stream:muteScreen",e,...arguments),this.client.apiFrequencyControl({name:"muteScreen",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}hasVideo(){return this.logger.log("获取视频 flag"),this.mediaHelper.video.videoStream.getVideoTracks().length>0}setVideoProfile(e){Object.assign(this.videoProfile,e),this.mediaHelper.video.captureConfig.high=this.mediaHelper.convert(this.videoProfile),this.mediaHelper.video.encoderConfig.high.maxBitrate=this.getVideoBW(),this.logger.log(`setVideoProfile ${JSON.stringify(e)} 视频采集参数 ${JSON.stringify(this.mediaHelper.video.captureConfig.high)} 编码参数 ${JSON.stringify(this.mediaHelper.video.encoderConfig.high)}`),this.client.adapterRef.channelInfo.sessionConfig.maxVideoQuality=o.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p,this.client.adapterRef.channelInfo.sessionConfig.videoQuality=this.videoProfile.resolution,this.client.adapterRef.channelInfo.sessionConfig.videoFrameRate=this.videoProfile.frameRate,this.client.apiFrequencyControl({name:"setVideoProfile",code:0,param:JSON.stringify(e,null," ")})}setVideoEncoderConfiguration(e){if(e.mediaType=e.mediaType||"video",e.streamType=e.streamType||"high",this.logger.log("自定义视频编码配置",e),this.mediaHelper[e.mediaType].encoderConfig[e.streamType])if(e.maxBitrate){const t=1e3*e.maxBitrate;this.logger.log(`设置maxBitrate ${e.mediaType} ${e.streamType} ${this.mediaHelper[e.mediaType].encoderConfig[e.streamType].maxBitrate} => ${t}`),this.mediaHelper[e.mediaType].encoderConfig[e.streamType].maxBitrate=t}else this.logger.error("未设定maxBitrate。保留目前的值：",e.mediaType,e.streamType,this.mediaHelper[e.mediaType].encoderConfig[e.streamType].maxBitrate);else this.logger.error("无法识别的媒体类型：",e.mediaType,e.streamType);this.getSender(e.mediaType,e.streamType)&&this.applyEncoderConfig(e.mediaType,e.streamType)}async replaceTrack(e){let t,i,r=!1;if("screen"===e.mediaType?(this.mediaHelper.screen.screenVideoTrack?(t=this.mediaHelper.screen.screenVideoTrack,this.mediaHelper.screen.screenVideoTrack=null):this.mediaHelper.screen.screenVideoSource&&(r=!0,t=this.mediaHelper.screen.screenVideoSource,this.mediaHelper.screen.screenVideoSource=null),t&&(e.external?this.mediaHelper.screen.screenVideoSource=e.track:this.mediaHelper.screen.screenVideoTrack=e.track,m.emptyStreamWith(this.mediaHelper.screen.screenVideoStream,e.track),i=this.mediaHelper.screen.screenVideoTrackLow,this.mediaHelper.screen.screenVideoTrackLow=null)):"video"===e.mediaType&&(this.mediaHelper.video.cameraTrack?(t=this.mediaHelper.video.cameraTrack,this.mediaHelper.video.cameraTrack=null):this.mediaHelper.video.videoSource&&(r=!0,t=this.mediaHelper.video.videoSource,this.mediaHelper.video.videoSource=null),t&&(e.external?this.mediaHelper.video.cameraTrack=e.track:this.mediaHelper.video.videoSource=e.track,m.emptyStreamWith(this.mediaHelper.video.videoStream,e.track),i=this.mediaHelper.video.videoTrackLow,this.mediaHelper.video.videoTrackLow=null)),!t)return this.logger.error(`replaceTrack ${e.mediaType} 当前没有可替换的流`),null;this.logger.log(`replaceTrack ${e.mediaType} dual:${!!i}【external: ${r} ${t.label}】=>【external: ${e.external} ${e.track.label}】`),m.watchTrack(e.track),this.mediaHelper.listenToTrackEnded(e.track);const s=this.getSender(e.mediaType,"high"),o=this.getSender(e.mediaType,"low");if(s&&(s.replaceTrack(e.track),this.logger.log(`replaceTrack ${e.mediaType} 成功替换上行`)),o&&i){const t=await this.mediaHelper.createTrackLow(e.mediaType);t&&(o.replaceTrack(t),this.logger.log(`replaceTrack ${e.mediaType} 成功替换上行小流`))}return{oldTrack:t,oldTrackLow:i,external:r}}setBeautyEffectOptions(){this.logger.log("设置美颜效果选项")}hasScreen(){return this.mediaHelper.screen.screenVideoStream.getVideoTracks().length>0}setScreenProfile(e){Object.assign(this.screenProfile,e),this.mediaHelper.screen.captureConfig.high=this.mediaHelper.convert(this.screenProfile),this.mediaHelper.screen.encoderConfig.high.maxBitrate=this.getScreenBW(),this.logger.log(`setScreenProfile ${JSON.stringify(e)} 屏幕共享采集参数 ${JSON.stringify(this.mediaHelper.screen.captureConfig.high)} 编码参数 ${JSON.stringify(this.mediaHelper.screen.encoderConfig.high)}`),this.client.adapterRef.channelInfo.sessionConfig.screenQuality=e,this.client.apiFrequencyControl({name:"setScreenProfile",code:0,param:JSON.stringify(e,null,2)})}getSender(e,t){var i,r,s;const o=null===(s=null===(r=null===(i=this.getAdapterRef())||void 0===i?void 0:i._mediasoup)||void 0===r?void 0:r._sendTransport)||void 0===s?void 0:s.handler._pc;let n=null;return o&&("audio"===e&&(n="high"===t?o.audioSender:null),"video"===e?n="high"===t?o.videoSender:o.videoSenderLow:"screen"===e&&(n="high"===t?o.screenSender:o.screenSenderLow)),n||null}applyEncoderConfig(e,t){let i=this.mediaHelper[e].encoderConfig[t].maxBitrate;if(!i)return;let r=this.getSender(e,t);if(!r)return void this.logger.error("localStream.applyEncoderConfig: cannot find sender for ",e,t);const s=r.getParameters();let o=void 0;s.encodings&&s.encodings.length?(o=s.encodings[0].maxBitrate,s.encodings[0].maxBitrate=i):s.encodings=[{maxBitrate:i}],r.setParameters(s).then(()=>{this.logger.log(`最大编码码率：${e} ${t} ${o?o+"=>":""}${i}`)}).catch(r=>{this.logger.error(`应用最大编码码率失败：${e} ${t} ${i}`,s,r.name,r.message,r)})}getVideoBW(){if(!this.videoProfile)throw new u.default({code:p.default.NOT_FOUND,message:"no this.videoProfile"});return this.videoProfile.resolution==o.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_180p?3e5:this.videoProfile.resolution==o.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p?8e5:this.videoProfile.resolution==o.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_720p?12e5:this.videoProfile.resolution==o.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p?15e5:0}getScreenBW(){if(!this.screenProfile)throw new u.default({code:p.default.NOT_FOUND,message:"no this.screenProfile"});return this.screenProfile.resolution==o.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_180p?3e5:this.screenProfile.resolution==o.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p?8e5:this.screenProfile.resolution==o.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_720p?12e5:this.screenProfile.resolution==o.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p?15e5:0}async takeSnapshot(e){if(!this.video&&!this.screen)return this.logger.log("没有视频流，请检查是否有 发布 过视频"),this.client.apiFrequencyControl({name:"takeSnapshot",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:"没有视频流，请检查是否有 发布 过视频"},null," ")}),"INVALID_OPERATION";if(!this._play)throw new u.default({code:p.default.NO_PLAY,message:"no play"});await this._play.takeSnapshot(e,this.streamID),this.client.apiFrequencyControl({name:"takeSnapshot",code:0,param:JSON.stringify(e,null," ")})}async startMediaRecording(e){const t=[];switch(e.type){case"screen":t.push(this.mediaHelper.screen.screenVideoStream),t.push(this.mediaHelper.audio.audioStream);break;case"camera":case"video":t.push(this.mediaHelper.video.videoStream),t.push(this.mediaHelper.audio.audioStream);break;case"audio":if(t.push(this.mediaHelper.audio.audioStream),this.client.adapterRef.remoteStreamMap)for(var i in this.client.adapterRef.remoteStreamMap){const e=this.client.adapterRef.remoteStreamMap[i];t.push(e.mediaHelper.audio.audioStream)}}if(0!==t.length){if(!this._record||!this.streamID||!t)throw new u.default({code:p.default.INVALID_PARAMETER,message:"startMediaRecording: invalid parameter"});return this._record&&this._record.start({uid:"string"===this.client.adapterRef.channelInfo.uidType?this.stringStreamID:this.streamID,type:e.type,reset:e.reset,stream:t})}this.logger.log("没有没发现要录制的媒体流")}stopMediaRecording(e){if(!this._record)throw new u.default({code:p.default.NO_RECORD,message:"no record"});return this._record.stop({})}playMediaRecording(e){if(!this._record)throw new u.default({code:p.default.NO_RECORD,message:"no record"});return this._record.play(e.view)}listMediaRecording(){let e=[];if(!this._record)throw new u.default({code:p.default.NO_RECORD,message:"no record"});const t=this._record.getRecordStatus();return"init"!==t.status&&e.push(t),e}cleanMediaRecording(e){if(!this._record)throw new u.default({code:p.default.NO_RECORD,message:"no record"});return this._record.clean()}downloadMediaRecording(e){if(!this._record)throw new u.default({code:p.default.NO_RECORD,message:"no record"});return this._record.download()}startAudioMixing(e){return window.isAudioBanned?Promise.reject(new u.default({code:p.default.MEDIA_OPEN_BANNED_BY_SERVER,message:"audio is banned by server"})):(this.logger.log("开始伴音"),this.mediaHelper.startAudioMixing(e))}stopAudioMixing(){return this.logger.log("停止伴音"),this.mediaHelper.stopAudioMixing()}pauseAudioMixing(){return this.logger.log("暂停伴音"),this.mediaHelper.pauseAudioMixing()}resumeAudioMixing(){return this.logger.log("恢复伴音"),this.mediaHelper.resumeAudioMixing()}adjustAudioMixingVolume(e){return this.logger.log("调节伴音音量:",e),this.mediaHelper.setAudioMixingVolume(e)}getAudioMixingDuration(){return this.logger.log("获取伴音总时长"),this.mediaHelper.getAudioMixingTotalTime()}getAudioMixingCurrentPosition(){return this.mediaHelper.getAudioMixingPlayedTime()}setAudioMixingPosition(e){return this.logger.log("设置伴音音频文件的播放位置:",e),this.mediaHelper.setAudioMixingPlayTime(e)}async playEffect(e){return window.isAudioBanned?Promise.reject(new u.default({code:p.default.MEDIA_OPEN_BANNED_BY_SERVER,message:"audio is banned by server"})):(this.logger.log("开始播放音效: ",JSON.stringify(e,null," ")),this.mediaHelper.playEffect(e))}async stopEffect(e){return this.logger.log("停止播放音效: ",e),this.mediaHelper.stopEffect(e)}async pauseEffect(e){return this.logger.log("暂停播放音效：",e),this.mediaHelper.pauseEffect(e)}async resumeEffect(e){return this.logger.log("恢复播放音效文件: ",e),this.mediaHelper.resumeEffect(e)}async setVolumeOfEffect(e,t){return this.logger.log(`调节 ${e} 音效文件音量为: ${t}`),this.mediaHelper.setVolumeOfEffect(e,t)}async preloadEffect(e,t){return this.logger.log(`预加载 ${e} 音效文件地址: ${t}`),this.mediaHelper.preloadEffect(e,t)}async unloadEffect(e){return this.logger.log("释放指定音效文件 "+e),this.mediaHelper.unloadEffect(e)}getEffectsVolume(){return this.logger.log("获取所有音效文件播放音量"),this.mediaHelper.getEffectsVolume()}setEffectsVolume(e){return this.logger.log("设置所有音效文件播放音量:",e),this.mediaHelper.setEffectsVolume(e)}async stopAllEffects(){return this.logger.log("停止播放所有音效文件"),this.mediaHelper.stopAllEffects()}async pauseAllEffects(){return this.logger.log("暂停播放所有音效文件"),this.mediaHelper.pauseAllEffects()}async resumeAllEffects(){return this.logger.log("恢复播放所有音效文件"),this.mediaHelper.resumeAllEffects()}getAudioEffectsDuration(e){return this.logger.log("获取音效总时长"),this.mediaHelper.getAudioEffectsTotalTime(e)}getAudioEffectsCurrentPosition(e){return this.mediaHelper.getAudioEffectsPlayedTime(e)}setCanvasWatermarkConfigs(e){if(this._play&&this._play._watermarkControl){let t=null;if(e.mediaType&&"video"!==e.mediaType?"screen"===e.mediaType&&this._play._watermarkControlScreen&&(t=this._play._watermarkControlScreen):this._play._watermarkControl&&(t=this._play._watermarkControl),!t)return void this.logger.error("setCanvasWatermarkConfigs：播放器未初始化",e.mediaType);const i={TEXT:10,TIMESTAMP:1,IMAGE:4};if(e.textWatermarks&&e.textWatermarks.length>i.TEXT)throw this.logger.error(`目前的文字水印数量：${e.textWatermarks.length}。允许的数量：${i.TEXT}`),new u.default({code:p.default.INVALID_PARAMETER,message:"watermark exceeds limit"});if(e.imageWatermarks&&e.imageWatermarks.length>i.IMAGE)throw this.logger.error(`目前的图片水印数量：${e.imageWatermarks.length}。允许的数量：${i.IMAGE}`),new u.default({code:p.default.INVALID_PARAMETER,message:"watermark exceeds limit"});t.checkWatermarkParams(e),t.updateWatermarks(e),this.client.apiFrequencyControl({name:"setCanvasWatermarkConfigs",code:0,param:JSON.stringify(e,null,2)})}else this.logger.error("setCanvasWatermarkConfigs：播放器未初始化")}getMuteStatus(e){return"audio"===e?{muted:this.muteStatus.audio.send}:"video"===e?{muted:this.muteStatus.video.send}:{muted:this.muteStatus.screen.send}}setBeautyEffect(e){l.startBeauty(e)}destroy(){this.client&&(this.client.apiFrequencyControl({name:"destroy",code:0,param:JSON.stringify({videoProfile:this.videoProfile,audio:this.audio,audioProcessing:this.audioProcessing,audioProfile:this.audioProfile,video:this.video,cameraId:this.cameraId,microphoneId:this.microphoneId,screen:this.screen,screenProfile:this.screenProfile},null," ")}),this.logger.log(`uid ${this.stringStreamID} 销毁 Stream 实例`),this.stop(),this._reset(),this.destroyed=!0)}}t.LocalStream=y},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.serverError=t.clientNotYetPublished=t.STREAM_HAS_NO_MEDIA_ATTRIBUTES=t.clientNotYetUninitialized=t.invalidArguments=t.ok=void 0,t.ok={name:"OK",code:200,desc:"success"},t.invalidArguments={name:"invalid arguments",code:1,desc:"请检查参数的有效性"},t.clientNotYetUninitialized={name:"client not yet uninitialized",code:2,desc:"请先调用createClient创建Client"},t.STREAM_HAS_NO_MEDIA_ATTRIBUTES={name:"STREAM_HAS_NO_MEDIA_ATTRIBUTES",code:10,desc:"stream不合法，没有audio、video或者screen属性"},t.clientNotYetPublished={name:"client not yet published",code:11,desc:"请先publish"},t.serverError={name:"server error code",code:414,desc:""}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LIVE_STREAM_AUDIO_CODEC_PROFILE=t.LIVE_STREAM_AUDIO_SAMPLE_RATE=void 0,t.LIVE_STREAM_AUDIO_SAMPLE_RATE={SAMPLE_RATE_32000:32e3,SAMPLE_RATE_44100:44100,SAMPLE_RATE_48000:48e3},t.LIVE_STREAM_AUDIO_CODEC_PROFILE={LC_AAC:0,HE_AAC:1}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NETWORK_STATUS=void 0,t.NETWORK_STATUS={0:"UNKNOWN",1:"EXCELLENT",2:"GOOD",3:"POOR",4:"BAD",5:"VERYBAD",6:"DOWN"}}])}));